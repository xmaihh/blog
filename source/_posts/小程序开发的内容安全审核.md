---
title: 小程序开发的内容安全审核
date: 2019-10-20 11:34:38
categories: 微信小程序
tags: [微信小程序]
toc: true
description: うつむいてはいけない。 いつも頭を高く あげていなさい。 世の中を 真っ正面から見つめなさい。
---

最近做一个带图片和文字发布的微信小程序，当时心里犯嘀咕，没有自我审查估摸着上不了。果不其然微信小程序提交代码审核的时候，审核不通过，提示如下:为避免您的小程序被滥用，请你完善内容审核机制，如调用小程序内容安全API，或使用其他技术、人工审核手段，过滤色情、违法等有害信息，保障发布内容的安全。
得，去到后台一看，审核员测试了一个词` xxx `给显示出来了，直接导致小程序不通过。
![](https://i.loli.net/2019/11/22/W9agLfOjtbvFyoM.png)

好在提示给了解决方案，因此这里做一下记录。

# 调用小程序内容安全API

- [校验一张图片是否含有违法违规内容](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.imgSecCheck.html)
- [异步校验图片/音频是否含有违法违规内容](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.mediaCheckAsync.html)
- [检查一段文本是否含有违法违规内容](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html)

还挺全，我主要用到了图片和文字审查，所以对`security.imgSecCheck`和`security.msgSecCheck`的使用做记录。

<img src="https://i.loli.net/2019/11/22/UvmjLFTXAphqdlD.png" style="zoom:50%;" />

#  开通云开发
在微信开发者工具打开你的小程序工程，点击“云开发”菜单进去，之前没开的按照提示填写云开发环境名称就好。

![](https://i.loli.net/2019/11/22/wLgMkAFEbOeIVPH.png)

# 创建云函数
在你小程序工程的`app.js`同级目录下创建一个文件夹`functions`来存放云函数

![](https://i.loli.net/2019/11/22/35T7Gke9bxDOacA.png)

并在`project.config.json`中配置`"cloudfunctionRoot": "functions/",`

```json
{
  "description": "项目配置文件",
  "cloudfunctionRoot": "functions/",
  "packOptions": {
    "ignore": []
  }, ...
.......
```

![](https://i.loli.net/2019/11/22/th5suyaJXiNWeK8.png)

编译一下，可以看到`functions`文件夹有变化后面加上了你之前创建的环境名。右键`functions`文件夹唤出菜单新建`Node.js`云函数

![](https://i.loli.net/2019/11/22/aytDq2p1cdun4xj.png)

我这里创建了一个名称叫`ContentCheck`的云函数，调用`security.imgSecCheck`和`security.msgSecCheck`需要声明权限，需要配置一个`config.json`文件，如果目录文件中没有`config.json`，需要自己建一个。

![](https://i.loli.net/2019/11/22/xmzKXBnf69LhR5V.png)

**config.json**的配置如下:

```json
{
    "permissions": {
        "openapi": [
            "security.msgSecCheck",
            "security.imgSecCheck"
        ]
    }
}
```

**ContentCheck**云函数的目录结构如下:

```js
├─checkContent
│      config.json   	 //云调用的权限配置
│      index.js   	    //云服务器node 入口文件
│      package.json   	// NPM包依赖
│ ...
```

编辑`ContentCheck`云函数目录下的`index.js`文件

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async(event, context) => {
  try {
    let msgR = false;
    let imageR = false;
    //  检查文本内容是否违规
    if (event.msg) {
      msgR = await cloud.openapi.security.msgSecCheck({
        content: event.msg
      })
    }
    //  检查图像内容是否违规
    if (event.img) {
      imageR = await cloud.openapi.security.imgSecCheck({
        media: {
          header: {
            'Content-Type': 'application/octet-stream'
          },
          contentType: 'image/png',
          value: Buffer.from(event.img)
        }
      })
    }
    return {
      msgR,
      imageR
    };
  } catch (e) {
    return e
  }
}
```
编辑完云函数之后，右键`ContentCheck`唤起菜单选择 上传并部署：云端安装依赖
![](https://i.loli.net/2019/11/22/Ho3zqjR9NIuPp5y.png)

**注意**
使用微信小程序云函数开发本地需要实现安装好Node.js环境，并配置好环境变量，之前新电脑没装Node.js环境导致上传的云函数老是调用失败，解决办法是安装好Node.js就好了。
验证Node.js是否安装`npm -v`和`node -version`

![](https://i.loli.net/2019/11/22/JN8oOtmIZSE3zMV.png)

# 调用云函数

在`app.js`初始化云环境，参数`env`可以在云开发的设置中可以看到当前的环境ID
```js
//app.js
App({
  onLaunch: function () {
    wx.cloud.init({
      env: "manjaro-7l50h",
      traceUser: true
    })
    ...
  },
})
```

![](https://i.loli.net/2019/11/22/nxMyfWwH4eO6oD7.png)

1. 检查文字是否违规

   ```js
      //  调用ContentCheck云函数检查文字是否违规
      wx.cloud.callFunction({
        name: 'ContentCheck',
        data: {
          msg: _this.data.msg,
        },
        success(res) {
          console.log(res.result)
          if (res.result.msgR.errCode == 87014) {
            wx.showToast({
              title: '文字违规',
            })
          }
        }
      })
   
   // 文字违规打印的console.log(res.result)
   {
   	msgR: {
   		errCode: 87014,
   		errMsg: "openapi.security.msgSecCheck:fail risky content hint: [cSp9ka06218622]"
   	},
   	imageR: false
   }
   // 文字正常打印的console.log(res.result)
   {
   	msgR: {
   		errCode: 0,
   		errMsg: "openapi.security.msgSecCheck:ok"
   	},
   	imageR: false
   }
   ```
   
2. 检查图片是否违规

   ```js
//  调用ContentCheck云函数检查图片是否违规
   wx.cloud.callFunction({
     name: 'ContentCheck',
     data: {
       img: _this.data.img
     },
     success(res) {
       console.log(res.result)
       if(res.result.imageR.errCode == 87014){
         wx.showToast({
           title: '图片违规',
         })
       }
     }
   })
   
   // 图片违规打印的console.log(res.result)
   {
   	msgR: false,
   	imageR: {
   		errCode: 87014,
   		errMsg: "openapi.security.imgSecCheck:fail risky content hint: [LGrV.a05623955]"
   	}
   }
   // 图片正常打印的console.log(res.result)
   {
   	msgR: false,
   	imageR: {
   		errCode: 0,
   		errMsg: "openapi.security.imgSecCheck:ok"
   	}
   }
   ```

[完整例子 contentSecCheck](https://github.com/xmaihh/Gamecode/tree/master/contentSecCheck)

# Reference

[微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.imgSecCheck.html)
[小程序评论回复和发帖功能实战](https://segmentfault.com/a/1190000019955207)

