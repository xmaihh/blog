<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hexo博客启用 WebSub</title>
      <link href="/blog/2024/10/17/hexo-bo-ke-qi-yong-websub/"/>
      <url>/blog/2024/10/17/hexo-bo-ke-qi-yong-websub/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pubsubhubbub.appspot.com/">WebSub（前身为 PubSubHubbub）</a>是一种能够实时通知内容更新的协议。它基于发布者&#x2F;订阅者模式，即发布者发布内容更新，订阅者接收这些更新。</p><ul><li><p>发布者 &#x3D; 博客网站</p></li><li><p>订阅者 &#x3D; 使用 Feed 解析器的读者</p></li><li><p>中转 &#x3D; WebSub</p></li></ul><p>WebSub 的主要目的是提供实时的变化通知，改善了客户端以任意时间间隔定期轮询 feed 服务器的典型情况。这样，WebSub 就能提供 HTTP 推送通知，而不需要客户端花费资源来轮询变化。</p><p>使用 WebSub 的好处：</p><ul><li>使用 RSS 阅读器的读者能够更快收到新文章</li><li>减少 feed 解析器向网页服务器发送的请求数量，节省带宽。 不使用 WebSub 的话，feed 解析器为了保持及时更新，会不断地（e.g. 每半小时）向网页服务器请求下载一次 Feed XML 文件，以此对比变化。让服务器压力增大</li><li>或许能加快 Google 录取博客新文章到索引的速度</li></ul><p>我使用<a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a>插件来生成 RSS 订阅源,详细配置选项请参考<a href="https://github.com/hexojs/hexo-generator-feed#options">官方文档</a></p><h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><p>修改根目录下的<code>_config.yml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">hub:</span> <span class="string">https://pubsubhubbub.appspot.com</span></span><br></pre></td></tr></table></figure><p><code>hexo g</code> 生成博客，我的 <code>atom.xml</code> 文件中多了一行代码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://pubsubhubbub.appspot.com/&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;hub&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>本地运行看到的效果。</p><p><img src="https://s2.loli.net/2024/10/17/quDQjkJ5FKdt3sy.png"></p><h1 id="设置WebHook"><a href="#设置WebHook" class="headerlink" title="设置WebHook"></a>设置WebHook</h1><p>在GitHub Pages仓库，<code>Settings</code> -&gt; <code>Webhooks</code> -&gt; <code>Add webhook</code></p><p><img src="https://s2.loli.net/2024/10/17/Q3ulWUCEwAKY6ZM.png"></p><ul><li><p><strong>Payload URL</strong> 填入格式：<a href="https://pubsubhubbub.appspot.com/publish?hub.mode=publish&hub.url=%E5%8D%9A%E5%AE%A2">https://pubsubhubbub.appspot.com/publish?hub.mode=publish&amp;hub.url=博客</a> RSS URL</p><p>e.g. <a href="https://pubsubhubbub.appspot.com/publish?hub.mode=publish&hub.url=https://xmaihh.github.io/blog/atom.xml">https://pubsubhubbub.appspot.com/publish?hub.mode=publish&amp;hub.url=https://xmaihh.github.io/blog/atom.xml</a></p></li><li><p><strong>Content type</strong> 选 <code>application/x-www-form-urlencoded</code></p></li><li><p><strong>触发 Webhook</strong> 的方式：<code>Page builds</code>，这样每次站点更新后就会触发 Webhook。</p></li></ul><p>保存设置后，手动激活 webhook 进行测试，得到结果 <code>204</code> 意味设置成功。</p><p><img src="https://s2.loli.net/2024/10/17/163wyG75mTuHbYB.png"></p><h1 id="验证WebSub是否设置成功"><a href="#验证WebSub是否设置成功" class="headerlink" title="验证WebSub是否设置成功"></a>验证WebSub是否设置成功</h1><p>使用谷歌提供的 <a href="https://pubsubhubbub.appspot.com/publish">PubSubHubbub 工具</a> ，查看WebSub是否设置成功。</p><p>填入博客 RSS URL，然后 Get Info。</p><p><img src="https://s2.loli.net/2024/10/17/MVxfiuLDbeTv5sA.png"></p><p>查看上次更新时间Last successful fetch，已经支持实时推送了。</p><p><img src="https://s2.loli.net/2024/10/17/1NgoOHBFIki8zaL.png"></p><h1 id="Refence"><a href="#Refence" class="headerlink" title="Refence"></a>Refence</h1><p><a href="https://blog.haysc.tech/hexo-feed-setup/">提升 RSS 体验：Hexo 博客 Feed 指北</a></p><p><a href="https://sekibetu.com/rss01.html">给 Hexo 博客加上 PubSubHubbub 协议实现 RSS 实时推送</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让Follow认证我的Hexo博客订阅源</title>
      <link href="/blog/2024/10/16/rang-follow-ren-zheng-wo-de-hexo-bo-ke-ding-yue-yuan/"/>
      <url>/blog/2024/10/16/rang-follow-ren-zheng-wo-de-hexo-bo-ke-ding-yue-yuan/</url>
      
        <content type="html"><![CDATA[<p>首先在Follow添加订阅源 :<a href="https://xmaihh.github.io/blog/atom.xml">https://xmaihh.github.io/blog/atom.xml</a></p><p><img src="https://s2.loli.net/2024/10/16/rL8P9aulcNBZ7dA.png"></p><p>添加订阅源之后，在Follow上获得需要认证的代码</p><p><img src="https://s2.loli.net/2024/10/16/dB8fIVkPwWLpA71.png"></p><p><img src="https://s2.loli.net/2024/10/16/dKyHLBUxYewf69t.png"></p><p>我使用<a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a>插件来生成 RSS订阅源,详细配置选项请参考<a href="https://github.com/hexojs/hexo-generator-feed#options">官方文档</a></p><p>修改根目录下的<code>_config.yml</code>:</p><p><img src="https://s2.loli.net/2024/10/16/SOHYc3mEtP6xWJ9.png"></p><p>原理是：修改自定义模板，使用该模板文件将用于生成 feed xml 文件。</p><p>所以将Follow认证的代码插入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">follow_challenge</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feedId</span>&gt;</span>69266541190951936<span class="tag">&lt;/<span class="name">feedId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userId</span>&gt;</span>68553932502853632<span class="tag">&lt;/<span class="name">userId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">follow_challenge</span>&gt;</span> </span><br></pre></td></tr></table></figure><p><code>_custom_atom.xml</code>完整内容如下:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">feed</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/Atom&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">follow_challenge</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feedId</span>&gt;</span>69266541190951936<span class="tag">&lt;/<span class="name">feedId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userId</span>&gt;</span>68553932502853632<span class="tag">&lt;/<span class="name">userId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">follow_challenge</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123; config.title &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  &#123;% if icon %&#125;<span class="tag">&lt;<span class="name">icon</span>&gt;</span>&#123;&#123; icon &#125;&#125;<span class="tag">&lt;/<span class="name">icon</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">  &#123;% if config.subtitle %&#125;<span class="tag">&lt;<span class="name">subtitle</span>&gt;</span>&#123;&#123; config.subtitle &#125;&#125;<span class="tag">&lt;/<span class="name">subtitle</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; feed_url | uriencode &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;self&quot;</span>/&gt;</span></span><br><span class="line">  &#123;% if config.feed.hub %&#125;<span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; config.feed.hub | uriencode &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;hub&quot;</span>/&gt;</span>&#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url | uriencode &#125;&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">updated</span>&gt;</span>&#123;% if posts.first().updated %&#125;&#123;&#123; posts.first().updated.toISOString() &#125;&#125;&#123;% else %&#125;&#123;&#123; posts.first().date.toISOString() &#125;&#125;&#123;% endif %&#125;<span class="tag">&lt;/<span class="name">updated</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>&#123;&#123; url | uriencode &#125;&#125;<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  &#123;% if config.author %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>&#123;&#123; config.author &#125;&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    &#123;% if config.email %&#125;<span class="tag">&lt;<span class="name">email</span>&gt;</span>&#123;&#123; config.email &#125;&#125;<span class="tag">&lt;/<span class="name">email</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">generator</span> <span class="attr">uri</span>=<span class="string">&quot;https://hexo.io/&quot;</span>&gt;</span>Hexo<span class="tag">&lt;/<span class="name">generator</span>&gt;</span></span><br><span class="line">  &#123;% for post in posts.toArray() %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123; post.title &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; post.permalink | uriencode &#125;&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>&#123;&#123; post.permalink | uriencode &#125;&#125;<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">published</span>&gt;</span>&#123;&#123; post.date.toISOString() &#125;&#125;<span class="tag">&lt;/<span class="name">published</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updated</span>&gt;</span>&#123;% if post.updated %&#125;&#123;&#123; post.updated.toISOString() &#125;&#125;&#123;% else %&#125;&#123;&#123; post.date.toISOString() &#125;&#125;&#123;% endif %&#125;<span class="tag">&lt;/<span class="name">updated</span>&gt;</span></span><br><span class="line">    &#123;% if config.feed.content and post.content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">content</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&lt;![CDATA[&#123;&#123; post.content | noControlChars | safe &#125;&#125;]]&gt;<span class="tag">&lt;/<span class="name">content</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% if post.description %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; post.description &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">    &#123;% elif post.intro %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; post.intro &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">    &#123;% elif post.excerpt %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; post.excerpt &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">    &#123;% elif post.content %&#125;</span><br><span class="line">      &#123;% set short_content = post.content.substring(0, config.feed.content_limit) %&#125;</span><br><span class="line">      &#123;% if config.feed.content_limit_delim %&#125;</span><br><span class="line">        &#123;% set delim_pos = short_content.lastIndexOf(config.feed.content_limit_delim) %&#125;</span><br><span class="line">        &#123;% if delim_pos &gt; -1 %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; short_content.substring(0, delim_pos) &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; short_content &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">      &#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span> <span class="attr">type</span>=<span class="string">&quot;html&quot;</span>&gt;</span>&#123;&#123; short_content &#125;&#125;<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% if post.image %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; post.image | formatUrl &#125;&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image&quot;</span>/&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% for category in post.categories.toArray() %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">term</span>=<span class="string">&quot;&#123;&#123; category.name &#125;&#125;&quot;</span> <span class="attr">scheme</span>=<span class="string">&quot;&#123;&#123; category.permalink &#125;&#125;&quot;</span>/&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &#123;% for tag in post.tags.toArray() %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">term</span>=<span class="string">&quot;&#123;&#123; tag.name &#125;&#125;&quot;</span> <span class="attr">scheme</span>=<span class="string">&quot;&#123;&#123; tag.permalink &#125;&#125;&quot;</span>/&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">feed</span>&gt;</span></span><br></pre></td></tr></table></figure><p>完成后，本地运行看看效果。</p><p><img src="https://s2.loli.net/2024/10/16/cOm5lZyUB3iXxd4.png"></p><p>确认添加上Follow的认证代码后，<code>hexo d</code>部署完成后回到Follow点击<code>认证</code>即可。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://sekibetu.com/followis.html">三分钟，让Follow认证我的Hexo博客订阅源</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Portainer重置admin登录密码</title>
      <link href="/blog/2024/09/10/portainer-chong-zhi-admin-deng-lu-mi-ma/"/>
      <url>/blog/2024/09/10/portainer-chong-zhi-admin-deng-lu-mi-ma/</url>
      
        <content type="html"><![CDATA[<p> 参考Portainer官网解决方法：<a href="https://docs.portainer.io/advanced/reset-admin">https://docs.portainer.io/advanced/reset-admin</a></p><h1 id="停止Portainer容器"><a href="#停止Portainer容器" class="headerlink" title="停止Portainer容器"></a>停止Portainer容器</h1><p>先用<code>docker ps -a</code>查看所有容器，找到Portainer对应信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop <span class="string">&quot;id-portainer-container&quot;</span></span><br></pre></td></tr></table></figure><h1 id="找到Portainer容器的data目录挂载位置"><a href="#找到Portainer容器的data目录挂载位置" class="headerlink" title="找到Portainer容器的data目录挂载位置"></a>找到Portainer容器的data目录挂载位置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect <span class="string">&quot;id-portainer-container&quot;</span></span><br></pre></td></tr></table></figure><p>挂载位置在这一行:<code>&quot;Source&quot;: &quot;/var/lib/docker/volumes/portainer_data/_data&quot;</code></p><h1 id="执行重置密码"><a href="#执行重置密码" class="headerlink" title="执行重置密码"></a>执行重置密码</h1><p>这里用到了一个镜像 <a href="https://github.com/portainer/helper-reset-password">portainer&#x2F;helper-reset-password</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/helper-reset-password</span><br><span class="line">docker run --<span class="built_in">rm</span> -v /var/lib/docker/volumes/portainer_data/_data:/data portainer/helper-reset-password</span><br></pre></td></tr></table></figure><blockquote><p><code>/var/lib/docker/volumes/portainer_data/_data</code>这里要替换成你在上一个步骤找到的挂载位置。</p></blockquote><p>命令执行成功输出如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2024/09/10 00:13:58 Password successfully updated for user: admin</span><br><span class="line">2024/09/10 00:13:58 Use the following password to login: &amp;_4#\3^5V8vLTd)E&quot;NWiJBs26G*9HPl1</span><br></pre></td></tr></table></figure><p>现在admin登录的密码就为：<code>&amp;_4#\3^5V8vLTd)E&quot;NWiJBs26G*9HPl1</code></p><h1 id="启动Portainer容器"><a href="#启动Portainer容器" class="headerlink" title="启动Portainer容器"></a>启动Portainer容器</h1><p>尝试使用新密码登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start <span class="string">&quot;id-portainer-container&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>华硕路由器修改Hosts</title>
      <link href="/blog/2024/08/02/hua-shuo-lu-you-qi-xiu-gai-hosts/"/>
      <url>/blog/2024/08/02/hua-shuo-lu-you-qi-xiu-gai-hosts/</url>
      
        <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2024/08/02/k8pg76arGJNqnXP.png" alt="ASUS"></p><p>前提条件：</p><ul><li>启用 SSH</li><li>SSH 用户名密码和登陆路由器后台的帐号密码一致</li></ul><p>打开华硕的 <code>SSH</code> 功能，具体路径是路由管理页面的 <code>高级设置 -&gt; 系统管理 -&gt; 系统设置 -&gt; 服务 -&gt; 启用SSH</code>。</p><p>通过 <code>SSH</code> 连接路由器后，修改 <code>/etc/hosts</code> 文件即可实现修改 <code>hosts</code> 功能。</p><p>但是会发现修改后的 <code>hosts</code> 仅对路由器生效，但是对下端设备均不生效，此时键入以下命令即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall -SIGHUP dnsmasq</span><br></pre></td></tr></table></figure><p><strong>路由器重启后以上对 <code>hosts</code> 文件的修改都会丢失，文件会恢复成固件默认的值。</strong></p><p>要达到重启不失效的目地，在 <code>/jffs/</code> 目录下创建一个名为 <code>dnsmasq.conf.add</code> 的文件，内容为 <code>addn-hosts=/jffs/configs/hosts</code> 并且保存。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /jffs/dnsmasq.conf.add</span><br></pre></td></tr></table></figure><p>进入该目录下的 <code>configs</code> 文件夹（<code>/jffs/configs</code>），创建一个名为 <code>hosts</code> 的文件，并且在该文件中设置自定义域名解析，并且保存。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.125.1 router.asus.com</span><br></pre></td></tr></table></figure><p>重启 DNS 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service restart_dnsmasq</span><br></pre></td></tr></table></figure><p>自定义解析生效<br>至此，在此路由器下的全部设备在访问相关域名时会首先使用路由器中 Hosts 文件中的自定义设置。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.irain.in/archives/ASUS_router_edit_Hosts.html">华硕路由器修改Hosts以达到局域网内自定义解析</a><br><a href="https://www.cnblogs.com/xiangliudev/p/16885325.html">华硕路由器修改hosts</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Openwrt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter使用intl_generator在Windows下报错Cannot open file, path = &#39;l10n-arb/intl_*.arb&#39; (OS Error: 文件名、目录名或卷标语法不正确</title>
      <link href="/blog/2024/07/30/flutter-shi-yong-intl-generator-zai-windows-xia-bao-cuo-cannot-open-file-path-l10n-arb-intl-arb-os-error-wen-jian-ming-mu-lu-ming-huo-juan-biao-yu-fa-bu-zheng-que/"/>
      <url>/blog/2024/07/30/flutter-shi-yong-intl-generator-zai-windows-xia-bao-cuo-cannot-open-file-path-l10n-arb-intl-arb-os-error-wen-jian-ming-mu-lu-ming-huo-juan-biao-yu-fa-bu-zheng-que/</url>
      
        <content type="html"><![CDATA[<p>使用intl_generator 包从代码中提取要国际化的字符串到单独的arb文件和根据arb文件生成对应语言的dart代码</p><p>详细教程：<a href="https://book.flutterchina.club/chapter13/intl.html">https://book.flutterchina.club/chapter13/intl.html</a></p><p>在Windows的PowerShell环境下执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dart run intl_generator:generate_from_arb --output-dir=lib/l10n --no-use-deferred-loading lib/l10n/localization_intl.dart l10n-arb/intl_*.arb</span><br></pre></td></tr></table></figure><p>报错信息：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">File</span><span class="params">System</span>Exception: Cannot <span class="literal">open</span> <span class="keyword">file</span>, path = <span class="string">&#x27;l10n-arb/intl_*.arb&#x27;</span> (OS Error: 文件名、目录名或卷标语法不正确。</span><br><span class="line">, errno = <span class="number">123</span>)</span><br></pre></td></tr></table></figure><p>原因：</p><p>在 PowerShell 中，通配符的处理方式与在其他命令行环境中有所不同。Windows下不会识别*通配符，上面写的<code>intl_*.arb</code>，导致错误。</p><p>解决办法：</p><p>请用<code>git bash</code>执行以上命令。</p><p>或者使用 Get-ChildItem 或 Get-Item 来处理Windows下的文件通配符。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ChildItem</span> l10n<span class="literal">-arb</span> <span class="literal">-Filter</span> intl_*.arb | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    dart run intl_generator:generate_from_arb <span class="literal">--output-dir</span>=lib/l10n <span class="literal">--no-use-deferred-loading</span> lib/l10n/localization_intl.dart <span class="variable">$_</span>.FullName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://github.com/dart-lang/i18n/issues/496">intl_translation:generate_from_arb with wildcard argument doesn’t work on Windows</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Hexo中使用PlantUML</title>
      <link href="/blog/2024/07/26/zai-hexo-zhong-shi-yong-plantuml/"/>
      <url>/blog/2024/07/26/zai-hexo-zhong-shi-yong-plantuml/</url>
      
        <content type="html"><![CDATA[<p><a href="https://plantuml.com/zh/">PlantUML</a>是一个通用性很强的工具，可以快速、直接地创建各种图表。用来画组件图、部署图、状态图、时序图、甘特图等UML以及非UML图。</p><p>线上版 <a href="https://www.planttext.com/">https://www.planttext.com/</a><br><img src="https://s2.loli.net/2024/07/26/9VevsbduHw7R8lE.png" alt="示例"></p><h1 id="Hexo-PlantUML插件"><a href="#Hexo-PlantUML插件" class="headerlink" title="Hexo PlantUML插件"></a>Hexo PlantUML插件</h1><h2 id="hexo-tag-plantuml"><a href="#hexo-tag-plantuml" class="headerlink" title="hexo-tag-plantuml"></a><a href="https://github.com/two/hexo-tag-plantuml">hexo-tag-plantuml</a></h2><p>安装:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-plantuml --save</span><br></pre></td></tr></table></figure><p>编辑Hexo目录下的<code>_config.yml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tag_plantuml:</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">static</span></span><br></pre></td></tr></table></figure><p>用法：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">plantuml</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    Bob-&gt;Alice : hello</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">endplantuml</span> %&#125;</span></span><br></pre></td></tr></table></figure><p>显示：</p><img class="kroki" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxMjBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjEwOXB4O2hlaWdodDoxMjBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDkgMTIwIiB3aWR0aD0iMTA5cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iMjYiIHgyPSIyNiIgeTE9IjM2LjI5NjkiIHkyPSI4NS40Mjk3Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjgwIiB4Mj0iODAiIHkxPSIzNi4yOTY5IiB5Mj0iODUuNDI5NyIvPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDIiIHg9IjUiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOCIgeD0iMTIiIHk9IjI0Ljk5NTEiPkJvYjwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQyIiB4PSI1IiB5PSI4NC40Mjk3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjEyIiB5PSIxMDQuNDI0OCI+Qm9iPC90ZXh0PjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDYiIHg9IjU3IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzIiIHg9IjY0IiB5PSIyNC45OTUxIj5BbGljZTwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ2IiB4PSI1NyIgeT0iODQuNDI5NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMyIiB4PSI2NCIgeT0iMTA0LjQyNDgiPkFsaWNlPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjgsNjMuNDI5Nyw3OCw2Ny40Mjk3LDY4LDcxLjQyOTcsNzIsNjcuNDI5NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjYiIHgyPSI3NCIgeTE9IjY3LjQyOTciIHkyPSI2Ny40Mjk3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzAiIHg9IjMzIiB5PSI2Mi4zNjM4Ij5oZWxsbzwvdGV4dD48IS0tU1JDPVtTeWZGcWhMcHBDYkNKYk1tS2lYOHBTZDkxbTAwXS0tPjwvZz48L3N2Zz4='><h2 id="hexo-filter-plantuml"><a href="#hexo-filter-plantuml" class="headerlink" title="hexo-filter-plantuml"></a><a href="https://github.com/miao1007/hexo-filter-plantuml">hexo-filter-plantuml</a></h2><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-filter-plantuml --save </span><br></pre></td></tr></table></figure><p>无需配置即可使用，或者你可以参考<a href="https://github.com/miao1007/hexo-filter-plantuml?tab=readme-ov-file#advanced-configuration">Advanced configuration</a></p><p>用法：</p><p><code>puml</code> 和 <code>plantuml</code> 指令都有效。</p><p><img src="https://s2.loli.net/2024/07/26/kD87JBaFmSUWgrX.png" alt="示例1"></p><p>或者</p><p><img src="https://s2.loli.net/2024/07/26/V5anfld1jQeAJyP.png" alt="示例2"></p><img class="kroki" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyMThweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjE3NHB4O2hlaWdodDoyMThweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxNzQgMjE4IiB3aWR0aD0iMTc0cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tY2xhc3MgT2JqZWN0LS0+PGcgaWQ9ImVsZW1fT2JqZWN0Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjY0LjI5NjkiIGlkPSJPYmplY3QiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijc3IiB4PSI0OC41IiB5PSI3Ii8+PGVsbGlwc2UgY3g9IjYzLjUiIGN5PSIyMyIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik02Ni40Njg4LDI4LjY0MDYgUTY1Ljg5MDYsMjguOTM3NSA2NS4yNSwyOS4wNzgxIFE2NC42MDk0LDI5LjIzNDQgNjMuOTA2MywyOS4yMzQ0IFE2MS40MDYzLDI5LjIzNDQgNjAuMDc4MSwyNy41OTM4IFE1OC43NjU2LDI1LjkzNzUgNTguNzY1NiwyMi44MTI1IFE1OC43NjU2LDE5LjY4NzUgNjAuMDc4MSwxOC4wMzEzIFE2MS40MDYzLDE2LjM3NSA2My45MDYzLDE2LjM3NSBRNjQuNjA5NCwxNi4zNzUgNjUuMjUsMTYuNTMxMyBRNjUuOTA2MywxNi42ODc1IDY2LjQ2ODgsMTYuOTg0NCBMNjYuNDY4OCwxOS43MDMxIFE2NS44NDM4LDE5LjEyNSA2NS4yNSwxOC44NTk0IFE2NC42NTYzLDE4LjU3ODEgNjQuMDMxMywxOC41NzgxIFE2Mi42ODc1LDE4LjU3ODEgNjIsMTkuNjU2MyBRNjEuMzEyNSwyMC43MTg4IDYxLjMxMjUsMjIuODEyNSBRNjEuMzEyNSwyNC45MDYzIDYyLDI1Ljk4NDQgUTYyLjY4NzUsMjcuMDQ2OSA2NC4wMzEzLDI3LjA0NjkgUTY0LjY1NjMsMjcuMDQ2OSA2NS4yNSwyNi43ODEzIFE2NS44NDM4LDI2LjUgNjYuNDY4OCwyNS45MjE5IEw2Ni40Njg4LDI4LjY0MDYgWiAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NSIgeD0iNzcuNSIgeT0iMjcuODQ2NyI+T2JqZWN0PC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjQ5LjUiIHgyPSIxMjQuNSIgeTE9IjM5IiB5Mj0iMzkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI0OS41IiB4Mj0iMTI0LjUiIHkxPSI0NyIgeTI9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTYiIHg9IjU0LjUiIHk9IjYzLjk5NTEiPmVxdWFscygpPC90ZXh0PjwvZz48IS0tY2xhc3MgQXJyYXlMaXN0LS0+PGcgaWQ9ImVsZW1fQXJyYXlMaXN0Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjgwLjU5MzgiIGlkPSJBcnJheUxpc3QiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2MCIgeD0iNyIgeT0iMTMxLjMiLz48ZWxsaXBzZSBjeD0iNTQuMjUiIGN5PSIxNDcuMyIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik01Ny4yMTg4LDE1Mi45NDA2IFE1Ni42NDA2LDE1My4yMzc1IDU2LDE1My4zNzgxIFE1NS4zNTk0LDE1My41MzQ0IDU0LjY1NjMsMTUzLjUzNDQgUTUyLjE1NjMsMTUzLjUzNDQgNTAuODI4MSwxNTEuODkzNyBRNDkuNTE1NiwxNTAuMjM3NSA0OS41MTU2LDE0Ny4xMTI1IFE0OS41MTU2LDE0My45ODc1IDUwLjgyODEsMTQyLjMzMTIgUTUyLjE1NjMsMTQwLjY3NSA1NC42NTYzLDE0MC42NzUgUTU1LjM1OTQsMTQwLjY3NSA1NiwxNDAuODMxMiBRNTYuNjU2MywxNDAuOTg3NSA1Ny4yMTg4LDE0MS4yODQ0IEw1Ny4yMTg4LDE0NC4wMDMxIFE1Ni41OTM4LDE0My40MjUgNTYsMTQzLjE1OTQgUTU1LjQwNjMsMTQyLjg3ODEgNTQuNzgxMywxNDIuODc4MSBRNTMuNDM3NSwxNDIuODc4MSA1Mi43NSwxNDMuOTU2MiBRNTIuMDYyNSwxNDUuMDE4NyA1Mi4wNjI1LDE0Ny4xMTI1IFE1Mi4wNjI1LDE0OS4yMDYyIDUyLjc1LDE1MC4yODQ0IFE1My40Mzc1LDE1MS4zNDY5IDU0Ljc4MTMsMTUxLjM0NjkgUTU1LjQwNjMsMTUxLjM0NjkgNTYsMTUxLjA4MTIgUTU2LjU5MzgsMTUwLjggNTcuMjE4OCwxNTAuMjIxOSBMNTcuMjE4OCwxNTIuOTQwNiBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU3IiB4PSI3NC43NSIgeT0iMTUyLjE0NjciPkFycmF5TGlzdDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMTY2IiB5MT0iMTYzLjMiIHkyPSIxNjMuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OCIgeD0iMTMiIHk9IjE4MC4yOTUxIj5PYmplY3RbXSBlbGVtZW50RGF0YTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMTY2IiB5MT0iMTg3LjU5NjkiIHkyPSIxODcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM4IiB4PSIxMyIgeT0iMjA0LjU5MiI+c2l6ZSgpPC90ZXh0PjwvZz48IS0tcmV2ZXJzZSBsaW5rIE9iamVjdCB0byBBcnJheUxpc3QtLT48ZyBpZD0ibGlua19PYmplY3RfQXJyYXlMaXN0Ij48cGF0aCBjb2RlTGluZT0iMSIgZD0iTTg3LDg5LjcyIEM4NywxMDcuNTIgODcsMTExLjkyIDg3LDEzMC44OSAiIGZpbGw9Im5vbmUiIGlkPSJPYmplY3QtYmFja3RvLUFycmF5TGlzdCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0ibm9uZSIgcG9pbnRzPSI4Nyw3MS43Miw4MSw4OS43Miw5Myw4OS43Miw4Nyw3MS43MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W3lxX0FJYXFrS1IyZnFUTExTMm1nSWdwcW9JbWt1VkE3WTVlZmYxUU05a09LUXNYb21VTTBXWDNQdzVZNXI5cEt0REl5NGZWNGFhR0sxU01QTFFhUWNXMDBdLS0+PC9nPjwvc3ZnPg=='><h2 id="hexo-filter-kroki-推荐"><a href="#hexo-filter-kroki-推荐" class="headerlink" title="hexo-filter-kroki[推荐]"></a><a href="https://github.com/miao1007/hexo-filter-kroki"><strong>hexo-filter-kroki[<strong>推荐</strong>]</strong></a></h2><p>这个插件是上一个插件<code>hexo-filter-plantuml</code>的升级版本，不仅支持plantuml图，还支持其他的绘图方式。</p><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-filter-kroki --save</span><br></pre></td></tr></table></figure><p>用法和<code>hexo-filter-plantuml</code>一样，无需配置即可使用，或者你可以参考<a href="https://github.com/miao1007/hexo-filter-kroki?tab=readme-ov-file#advanced-configuration">Advanced configuration</a></p><p>查看支持的图表类型：<a href="https://kroki.io/health">https://kroki.io/health</a></p><p>查看图表示例：<a href="https://kroki.io/examples.html">https://kroki.io/examples.html</a></p><p><img src="https://s2.loli.net/2024/07/26/86CdE4XPKtpmcQ7.png" alt="wavedrom示例"></p><img class="kroki" src='data:image/svg+xml;base64,PHN2ZyBpZD0ic3ZnY29udGVudF8wIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBoZWlnaHQ9IjE1MCIgd2lkdGg9IjU0MCIgdmlld0JveD0iMCAwIDU0MCAxNTAiIG92ZXJmbG93PSJoaWRkZW4iIGNsYXNzPSJXYXZlRHJvbSI+PHN0eWxlIHR5cGU9InRleHQvY3NzIj50ZXh0e2ZvbnQtc2l6ZToxMXB0O2ZvbnQtc3R5bGU6bm9ybWFsO2ZvbnQtdmFyaWFudDpub3JtYWw7Zm9udC13ZWlnaHQ6bm9ybWFsO2ZvbnQtc3RyZXRjaDpub3JtYWw7dGV4dC1hbGlnbjpjZW50ZXI7ZmlsbC1vcGFjaXR5OjE7Zm9udC1mYW1pbHk6SGVsdmV0aWNhfS5oMXtmb250LXNpemU6MzNwdDtmb250LXdlaWdodDpib2xkfS5oMntmb250LXNpemU6MjdwdDtmb250LXdlaWdodDpib2xkfS5oM3tmb250LXNpemU6MjBwdDtmb250LXdlaWdodDpib2xkfS5oNHtmb250LXNpemU6MTRwdDtmb250LXdlaWdodDpib2xkfS5oNXtmb250LXNpemU6MTFwdDtmb250LXdlaWdodDpib2xkfS5oNntmb250LXNpemU6OHB0O2ZvbnQtd2VpZ2h0OmJvbGR9Lm11dGVke2ZpbGw6I2FhYX0ud2FybmluZ3tmaWxsOiNmNmI5MDB9LmVycm9ye2ZpbGw6I2Y2MDAwMH0uaW5mb3tmaWxsOiMwMDQxYzR9LnN1Y2Nlc3N7ZmlsbDojMDBhYjAwfS5zMXtmaWxsOm5vbmU7c3Ryb2tlOiMwMDA7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLW9wYWNpdHk6MTtzdHJva2UtZGFzaGFycmF5Om5vbmV9LnMye2ZpbGw6bm9uZTtzdHJva2U6IzAwMDtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjptaXRlcjtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1vcGFjaXR5OjE7c3Ryb2tlLWRhc2hhcnJheTpub25lfS5zM3tjb2xvcjojMDAwO2ZpbGw6bm9uZTtzdHJva2U6IzAwMDtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46bWl0ZXI7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2Utb3BhY2l0eToxO3N0cm9rZS1kYXNoYXJyYXk6MSwgMztzdHJva2UtZGFzaG9mZnNldDowO21hcmtlcjpub25lO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlfS5zNHtjb2xvcjojMDAwO2ZpbGw6bm9uZTtzdHJva2U6IzAwMDtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46bWl0ZXI7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2Utb3BhY2l0eToxO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO21hcmtlcjpub25lO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlfS5zNXtmaWxsOiNmZmY7c3Ryb2tlOm5vbmV9LnM2e2ZpbGw6IzAwMDtmaWxsLW9wYWNpdHk6MTtzdHJva2U6bm9uZX0uczd7Y29sb3I6IzAwMDtmaWxsOiNmZmY7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjFweDttYXJrZXI6bm9uZTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZX0uczh7Y29sb3I6IzAwMDtmaWxsOiNmZmZmYjQ7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjFweDttYXJrZXI6bm9uZTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZX0uczl7Y29sb3I6IzAwMDtmaWxsOiNmZmUwYjk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjFweDttYXJrZXI6bm9uZTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZX0uczEwe2NvbG9yOiMwMDA7ZmlsbDojYjllMGZmO2ZpbGwtb3BhY2l0eToxO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDoxcHg7bWFya2VyOm5vbmU7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGV9LnMxMXtjb2xvcjojMDAwO2ZpbGw6I2NjZmRmZTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MXB4O21hcmtlcjpub25lO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlfS5zMTJ7Y29sb3I6IzAwMDtmaWxsOiNjZGZkYzU7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjFweDttYXJrZXI6bm9uZTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZX0uczEze2NvbG9yOiMwMDA7ZmlsbDojZjBjMWZiO2ZpbGwtb3BhY2l0eToxO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDoxcHg7bWFya2VyOm5vbmU7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGV9LnMxNHtjb2xvcjojMDAwO2ZpbGw6I2Y1YzJjMDtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MXB4O21hcmtlcjpub25lO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlfS5zMTV7ZmlsbDojMDA0MWM0O2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lfS5zMTZ7ZmlsbDpub25lO3N0cm9rZTojMDA0MWM0O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjptaXRlcjtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1vcGFjaXR5OjE7c3Ryb2tlLWRhc2hhcnJheTpub25lfTwvc3R5bGU+PGRlZnM+PGcgaWQ9InNvY2tldCI+PHJlY3QgeT0iMTUiIHg9IjYiIGhlaWdodD0iMjAiIHdpZHRoPSIyMCIvPjwvZz48ZyBpZD0icGNsayI+PHBhdGggZD0iTTAsMjAgMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0ibmNsayI+PHBhdGggZD0ibTAsMCAwLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMDAwIj48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtMCI+PHBhdGggZD0ibTAsMjAgMywwIDMsLTEwIDMsMTAgMTEsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIwbTEiPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMG14Ij48cGF0aCBkPSJNMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTIwLDE1IC01LDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwxMCAxMCwyMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDUgNSwyMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDAgNCwxNiIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTE1LDAgNiw5IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTAsMCA5LDEiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMG1kIj48cGF0aCBkPSJtOCwyMCAxMCwwIiBjbGFzcz0iczMiLz48cGF0aCBkPSJtMCwyMCA1LDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMG11Ij48cGF0aCBkPSJtMCwyMCAzLDAgQyA3LDEwIDEwLjEwNzYwMywwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMG16Ij48cGF0aCBkPSJtMCwyMCAzLDAgQyAxMCwxMCAxNSwxMCAyMCwxMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIxMTEiPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIxbTAiPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIxbTEiPjxwYXRoIGQ9Ik0wLDAgMywwIDYsMTAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW14Ij48cGF0aCBkPSJtMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMjAsMTUgLTUsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDEwIDEwLDIwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsNSA4LDE3IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMCA3LDEzIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTUsMCA2LDkiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xMCwwIDUsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTMuNSwxLjUgNSwwIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9IjFtZCI+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW11Ij48cGF0aCBkPSJNMCwwIDUsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTgsMCAxOCwwIiBjbGFzcz0iczMiLz48L2c+PGcgaWQ9IjFteiI+PHBhdGggZD0ibTAsMCAzLDAgYyA3LDEwIDEyLDEwIDE3LDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9Inh4eCI+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDUsMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMTAgMTAsMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMTUgMTUsMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgMjAsMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTUsMjAgMjAsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDIwIDIwLDEwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJtMTUsMjAgNSwtNSIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ4bTAiPjxwYXRoIGQ9Ik0wLDAgNCwwIDksMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDUgNCwxIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxMCA1LDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNywxMyIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTUsMjAgOCwxNyIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ4bTEiPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgNCwyMCA5LDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDUgNSwwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxMCA5LDEiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNSwxNSIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ4bXgiPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsNSA1LDAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDEwLDAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDE1LDAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDIwIDIwLDAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik01LDIwIDIwLDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xMCwyMCAyMCwxMCIgY2xhc3M9InMyIi8+PHBhdGggZD0ibTE1LDIwIDUsLTUiIGNsYXNzPSJzMiIvPjwvZz48ZyBpZD0ieG1kIj48cGF0aCBkPSJtMCwwIDQsMCBjIDMsMTAgNiwyMCAxNiwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsNSA0LDEiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDUuNSw0LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYuNSw4LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDIwIDgsMTIiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Im01LDIwIDUsLTUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Im0xMCwyMCAyLjUsLTIuNSIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ4bXUiPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgNCwwIEMgNywxMCAxMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDUgNSwwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxMCAxMCwwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxNSAxMCw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwyMCA2LDE0IiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InhteiI+PHBhdGggZD0ibTAsMCA0LDAgYyA2LDEwIDExLDEwIDE2LDEwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCA0LDAgQyAxMCwxMCAxNSwxMCAyMCwxMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsNSA0LjUsMC41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxMCA2LjUsMy41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxNSA4LjUsNi41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwyMCAxMS41LDguNSIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkZGQiPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMyIvPjwvZz48ZyBpZD0iZG0wIj48cGF0aCBkPSJtMCwyMCAxMCwwIiBjbGFzcz0iczMiLz48cGF0aCBkPSJtMTIsMjAgOCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9ImRtMSI+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJkbXgiPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMjAsMTUgLTUsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDEwIDEwLDIwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsNSA1LDIwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMCA0LDE2IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTUsMCA2LDkiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xMCwwIDksMSIgY2xhc3M9InMyIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJkbWQiPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMyIvPjwvZz48ZyBpZD0iZG11Ij48cGF0aCBkPSJtMCwyMCAzLDAgQyA3LDEwIDEwLjEwNzYwMywwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iZG16Ij48cGF0aCBkPSJtMCwyMCAzLDAgQyAxMCwxMCAxNSwxMCAyMCwxMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ1dXUiPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMzIi8+PC9nPjxnIGlkPSJ1bTAiPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ1bTEiPjxwYXRoIGQ9Ik0wLDAgMTAsMCIgY2xhc3M9InMzIi8+PHBhdGggZD0ibTEyLDAgOCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVteCI+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTIwLDE1IC01LDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwxMCAxMCwyMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDUgOCwxNyIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDAgNywxMyIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTE1LDAgNiw5IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTAsMCA1LDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0zLjUsMS41IDUsMCIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ1bWQiPjxwYXRoIGQ9Im0wLDAgMywwIGMgNCwxMCA3LDIwIDE3LDIwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdSI+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczMiLz48L2c+PGcgaWQ9InVteiI+PHBhdGggZD0ibTAsMCAzLDAgYyA3LDEwIDEyLDEwIDE3LDEwIiBjbGFzcz0iczQiLz48L2c+PGcgaWQ9Inp6eiI+PHBhdGggZD0ibTAsMTAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bTAiPjxwYXRoIGQ9Im0wLDEwIDYsMCAzLDEwIDExLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iem0xIj48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InpteCI+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMjAsMTUgLTUsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDEwIDEwLDIwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsNSA4LDE3IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMCA3LDEzIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTUsMCA2LjUsOC41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTAsMCA5LDEiIGNsYXNzPSJzMiIvPjwvZz48ZyBpZD0iem1kIj48cGF0aCBkPSJtMCwxMCA3LDAgYyAzLDUgOCwxMCAxMywxMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXUiPjxwYXRoIGQ9Im0wLDEwIDcsMCBDIDEwLDUgMTUsMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InpteiI+PHBhdGggZD0ibTAsMTAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJnYXAiPjxwYXRoIGQ9Im03LC0yIC00LDAgYyAtNSwwIC01LDI0IC0xMCwyNCBsIDQsMCBDIDIsMjIgMiwtMiA3LC0yIHoiIGNsYXNzPSJzNSIvPjxwYXRoIGQ9Ik0tNywyMiBDIC0yLDIyIC0yLC0yIDMsLTIiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0tMywyMiBDIDIsMjIgMiwtMiA3LC0yIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IlBjbGsiPjxwYXRoIGQ9Ik0tMywxMiAwLDMgMywxMiBDIDEsMTEgLTEsMTEgLTMsMTIgeiIgY2xhc3M9InM2Ii8+PHBhdGggZD0iTTAsMjAgMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iTmNsayI+PHBhdGggZD0iTS0zLDggMCwxNyAzLDggQyAxLDkgLTEsOSAtMyw4IHoiIGNsYXNzPSJzNiIvPjxwYXRoIGQ9Im0wLDAgMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi0yIj48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczciLz48cGF0aCBkPSJNMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIxbXYtMiI+PHBhdGggZD0iTTIuODc1LDAgMjAsMCAyMCwyMCA5LDIwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0zLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0ieG12LTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtMiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idW12LTIiPjxwYXRoIGQ9Ik0zLDAgMjAsMCAyMCwyMCA5LDIwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0zLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iem12LTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di0yIj48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InM3Ii8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtMC0yIj48cGF0aCBkPSJNMCwyMCAwLDAgMywwIDksMjAiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Ik0wLDAgMywwIDksMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm0xLTIiPjxwYXRoIGQ9Ik0wLDAgMCwyMCAzLDIwIDksMCIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtMiI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTIwLDE1IC01LDUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwxMCAxMCwyMCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDUgOCwxNyIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDAgNywxMyIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTE1LDAgNyw4IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTAsMCA5LDEiIGNsYXNzPSJzMiIvPjwvZz48ZyBpZD0idm1kLTIiPjxwYXRoIGQ9Im0wLDAgMCwyMCAyMCwwIEMgMTAsMjAgNywxMCAzLDAiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIGMgNCwxMCA3LDIwIDE3LDIwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdS0yIj48cGF0aCBkPSJtMCwwIDAsMjAgMywwIEMgNywxMCAxMCwwIDIwLDAiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTIiPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIGMgNywxMCAxMiwxMCAxNywxMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMG12LTMiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCAzLDIwIHoiIGNsYXNzPSJzOCIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjFtdi0zIj48cGF0aCBkPSJNMi44NzUsMCAyMCwwIDIwLDIwIDksMjAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDUgMy41LDEuNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMTAgNC41LDUuNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMTUgNiw5IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwyMCA0LDE2IiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9ImRtdi0zIj48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ1bXYtMyI+PHBhdGggZD0iTTMsMCAyMCwwIDIwLDIwIDksMjAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJtNiwxMCAzLDEwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDEwIDYsMTAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idnZ2LTMiPjxwYXRoIGQ9Ik0yMCwyMCAwLDIwIDAsMCAyMCwwIiBjbGFzcz0iczgiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm0wLTMiPjxwYXRoIGQ9Ik0wLDIwIDAsMCAzLDAgOSwyMCIgY2xhc3M9InM4Ii8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtMyI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZteC0zIj48cGF0aCBkPSJNMCwwIDAsMjAgMywyMCA2LDEwIDMsMCIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMjAsMTUgLTUsNSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTIwLDEwIDEwLDIwIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsNSA4LDE3IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMCA3LDEzIiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMTUsMCA3LDgiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xMCwwIDksMSIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJ2bWQtMyI+PHBhdGggZD0ibTAsMCAwLDIwIDIwLDAgQyAxMCwyMCA3LDEwIDMsMCIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTMiPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMjAgMywwIEMgNywxMCAxMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXotMyI+PHBhdGggZD0iTTAsMCAzLDAgQyAxMCwxMCAxNSwxMCAyMCwxMCAxNSwxMCAxMCwxMCAzLDIwIEwgMCwyMCIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgYyA3LDEwIDEyLDEwIDE3LDEwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAzLDAgQyAxMCwxMCAxNSwxMCAyMCwxMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSIwbXYtNCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InM5Ii8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTQiPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9Inhtdi00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsNSAzLjUsMS41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxMCA0LjUsNS41IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMCwxNSA2LDkiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDIwIDQsMTYiIGNsYXNzPSJzMiIvPjwvZz48ZyBpZD0iZG12LTQiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCAzLDIwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi00Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9Inptdi00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Im02LDEwIDMsMTAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMTAgNiwxMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2dnYtNCI+PHBhdGggZD0iTTIwLDIwIDAsMjAgMCwwIDIwLDAiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtNCI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczkiLz48cGF0aCBkPSJNMCwwIDMsMCA5LDIwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtMS00Ij48cGF0aCBkPSJNMCwwIDAsMjAgMywyMCA5LDAiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm14LTQiPjxwYXRoIGQ9Ik0wLDAgMCwyMCAzLDIwIDYsMTAgMywwIiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC00Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDQsMTAgNywyMCAxNywyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXUtNCI+PHBhdGggZD0ibTAsMCAwLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtei00Ij48cGF0aCBkPSJNMCwwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIDE1LDEwIDEwLDEwIDMsMjAgTCAwLDIwIiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi01Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTUiPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi01Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di01Ij48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtNSI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtNSI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtNSI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC01Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTUiPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTUiPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi02Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTYiPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtNiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtNiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi02Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtNiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di02Ij48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtNiI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtNiI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtNiI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC02Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTYiPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTYiPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi03Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTciPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi03Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di03Ij48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtNyI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtNyI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtNyI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC03Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTciPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTciPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi04Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTgiPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi04Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di04Ij48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtOCI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtOCI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtOCI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC04Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTgiPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTgiPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9IjBtdi05Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgMywyMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iMW12LTkiPjxwYXRoIGQ9Ik0yLjg3NSwwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ4bXYtOSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCw1IDMuNSwxLjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDEwIDQuNSw1LjUiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0wLDE1IDYsOSIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTAsMjAgNCwxNiIgY2xhc3M9InMyIi8+PC9nPjxnIGlkPSJkbXYtOSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDMsMjAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Ik0zLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJtMCwyMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InVtdi05Ij48cGF0aCBkPSJNMywwIDIwLDAgMjAsMjAgOSwyMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ6bXYtOSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTYsMTAgMywxMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwxMCA2LDEwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZ2di05Ij48cGF0aCBkPSJNMjAsMjAgMCwyMCAwLDAgMjAsMCIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTAtOSI+PHBhdGggZD0iTTAsMjAgMCwwIDMsMCA5LDIwIiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTAsMCAzLDAgOSwyMCIgY2xhc3M9InMxIi8+PHBhdGggZD0ibTAsMjAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bTEtOSI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgOSwwIiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXgtOSI+PHBhdGggZD0iTTAsMCAwLDIwIDMsMjAgNiwxMCAzLDAiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0yMCwxNSAtNSw1IiBjbGFzcz0iczIiLz48cGF0aCBkPSJNMjAsMTAgMTAsMjAiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCw1IDgsMTciIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0yMCwwIDcsMTMiIGNsYXNzPSJzMiIvPjxwYXRoIGQ9Ik0xNSwwIDcsOCIgY2xhc3M9InMyIi8+PHBhdGggZD0iTTEwLDAgOSwxIiBjbGFzcz0iczIiLz48L2c+PGcgaWQ9InZtZC05Ij48cGF0aCBkPSJtMCwwIDAsMjAgMjAsMCBDIDEwLDIwIDcsMTAgMywwIiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTAsMCAzLDAgYyA0LDEwIDcsMjAgMTcsMjAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm11LTkiPjxwYXRoIGQ9Im0wLDAgMCwyMCAzLDAgQyA3LDEwIDEwLDAgMjAsMCIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDcsMTAgMTAsMCAyMCwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm16LTkiPjxwYXRoIGQ9Ik0wLDAgMywwIEMgMTAsMTAgMTUsMTAgMjAsMTAgMTUsMTAgMTAsMTAgMywyMCBMIDAsMjAiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJtMCwwIDMsMCBjIDcsMTAgMTIsMTAgMTcsMTAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Im0wLDIwIDMsMCBDIDEwLDEwIDE1LDEwIDIwLDEwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi0yLTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi0zLTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi00LTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM5Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi01LTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNi0yIj48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTctMiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczciLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi04LTIiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtOS0yIj48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTItMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczciLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTMtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTQtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTUtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi02LTMiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNy0zIj48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTgtMyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi05LTMiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMi00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMy00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzOCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNC00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNS00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTYtNCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi03LTQiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InM5Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtOC00Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTktNCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi0yLTUiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMy01Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTQtNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM5Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi01LTUiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTYtNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNy01Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi04LTUiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTktNSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMi02Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczciLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTMtNiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi00LTYiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNS02Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi02LTYiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTctNiI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtOC02Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi05LTYiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTItNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM3Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi0zLTciPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzOCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNC03Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczkiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTUtNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNi03Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczExIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi03LTciPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTgtNyI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtOS03Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTIiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi0yLTgiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzNyIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMy04Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczgiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTQtOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM5Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi01LTgiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTAiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTYtOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNy04Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEyIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi04LTgiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxMyIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTMiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTktOCI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtMi05Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczciLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTMtOSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InM4Ii8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi00LTkiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzOSIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtNS05Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEwIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi02LTkiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTEiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0idm12LTctOSI+PHBhdGggZD0iTTksMCAyMCwwIDIwLDIwIDksMjAgNiwxMCB6IiBjbGFzcz0iczE0Ii8+PHBhdGggZD0iTTMsMCAwLDAgMCwyMCAzLDIwIDYsMTAgeiIgY2xhc3M9InMxMiIvPjxwYXRoIGQ9Im0wLDAgMywwIDYsMjAgMTEsMCIgY2xhc3M9InMxIi8+PHBhdGggZD0iTTAsMjAgMywyMCA5LDAgMjAsMCIgY2xhc3M9InMxIi8+PC9nPjxnIGlkPSJ2bXYtOC05Ij48cGF0aCBkPSJNOSwwIDIwLDAgMjAsMjAgOSwyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJNMywwIDAsMCAwLDIwIDMsMjAgNiwxMCB6IiBjbGFzcz0iczEzIi8+PHBhdGggZD0ibTAsMCAzLDAgNiwyMCAxMSwwIiBjbGFzcz0iczEiLz48cGF0aCBkPSJNMCwyMCAzLDIwIDksMCAyMCwwIiBjbGFzcz0iczEiLz48L2c+PGcgaWQ9InZtdi05LTkiPjxwYXRoIGQ9Ik05LDAgMjAsMCAyMCwyMCA5LDIwIDYsMTAgeiIgY2xhc3M9InMxNCIvPjxwYXRoIGQ9Ik0zLDAgMCwwIDAsMjAgMywyMCA2LDEwIHoiIGNsYXNzPSJzMTQiLz48cGF0aCBkPSJtMCwwIDMsMCA2LDIwIDExLDAiIGNsYXNzPSJzMSIvPjxwYXRoIGQ9Ik0wLDIwIDMsMjAgOSwwIDIwLDAiIGNsYXNzPSJzMSIvPjwvZz48ZyBpZD0iYXJyb3cwIj48cGF0aCBkPSJtLTEyLC0zIDksMyAtOSwzIGMgMSwtMiAxLC00IDAsLTYgeiIgY2xhc3M9InMxNSIvPjxwYXRoIGQ9Ik0wLDAgLTE1LDAiIGNsYXNzPSJzMTYiLz48L2c+PG1hcmtlciBpZD0iYXJyb3doZWFkIiBzdHlsZT0iZmlsbDojMDA0MWM0IiBtYXJrZXJIZWlnaHQ9IjciIG1hcmtlcldpZHRoPSIxMCIgbWFya2VyVW5pdHM9InN0cm9rZVdpZHRoIiB2aWV3Qm94PSIwIC00IDExIDgiIHJlZlg9IjE1IiByZWZZPSIwIiBvcmllbnQ9ImF1dG8iPjxwYXRoIGQ9Ik0wIC00IDExIDAgMCA0eiIvPjwvbWFya2VyPjxtYXJrZXIgaWQ9ImFycm93dGFpbCIgc3R5bGU9ImZpbGw6IzAwNDFjNCIgbWFya2VySGVpZ2h0PSI3IiBtYXJrZXJXaWR0aD0iMTAiIG1hcmtlclVuaXRzPSJzdHJva2VXaWR0aCIgdmlld0JveD0iLTExIC00IDExIDgiIHJlZlg9Ii0xNSIgcmVmWT0iMCIgb3JpZW50PSJhdXRvIj48cGF0aCBkPSJNMCAtNCAtMTEgMCAwIDR6Ii8+PC9tYXJrZXI+PG1hcmtlciBpZD0idGVlIiBzdHlsZT0iZmlsbDojMDA0MWM0IiBtYXJrZXJIZWlnaHQ9IjYiIG1hcmtlcldpZHRoPSIxIiBtYXJrZXJVbml0cz0ic3Ryb2tlV2lkdGgiIHZpZXdCb3g9IjAgMCAxIDYiIHJlZlg9IjAiIHJlZlk9IjMiIG9yaWVudD0iYXV0byI+PHBhdGggZD0iTSAwIDAgTCAwIDYiIHN0eWxlPSJzdHJva2U6IzAwNDFjNDtzdHJva2Utd2lkdGg6MiIvPjwvbWFya2VyPjwvZGVmcz48ZyBpZD0id2F2ZXNfMCI+PHJlY3Qgd2lkdGg9IjU0MCIgaGVpZ2h0PSIxNTAiIHN0eWxlPSJzdHJva2U6bm9uZTtmaWxsOndoaXRlIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTIwLjUsMC41KSIgaWQ9ImxhbmVzXzAiPjxnIGlkPSJnbWFya3NfMCI+PGcgc3R5bGU9InN0cm9rZTojODg4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheToxLDMiPjxsaW5lIGlkPSJnbWFya18wXzAiIHgxPSIwIiB5MT0iMCIgeDI9IjAiIHkyPSIxNTAiLz48bGluZSBpZD0iZ21hcmtfMV8wIiB4MT0iNDAiIHkxPSIwIiB4Mj0iNDAiIHkyPSIxNTAiLz48bGluZSBpZD0iZ21hcmtfMl8wIiB4MT0iODAiIHkxPSIwIiB4Mj0iODAiIHkyPSIxNTAiLz48bGluZSBpZD0iZ21hcmtfM18wIiB4MT0iMTIwIiB5MT0iMCIgeDI9IjEyMCIgeTI9IjE1MCIvPjxsaW5lIGlkPSJnbWFya180XzAiIHgxPSIxNjAiIHkxPSIwIiB4Mj0iMTYwIiB5Mj0iMTUwIi8+PGxpbmUgaWQ9ImdtYXJrXzVfMCIgeDE9IjIwMCIgeTE9IjAiIHgyPSIyMDAiIHkyPSIxNTAiLz48bGluZSBpZD0iZ21hcmtfNl8wIiB4MT0iMjQwIiB5MT0iMCIgeDI9IjI0MCIgeTI9IjE1MCIvPjxsaW5lIGlkPSJnbWFya183XzAiIHgxPSIyODAiIHkxPSIwIiB4Mj0iMjgwIiB5Mj0iMTUwIi8+PGxpbmUgaWQ9ImdtYXJrXzhfMCIgeDE9IjMyMCIgeTE9IjAiIHgyPSIzMjAiIHkyPSIxNTAiLz48bGluZSBpZD0iZ21hcmtfOV8wIiB4MT0iMzYwIiB5MT0iMCIgeDI9IjM2MCIgeTI9IjE1MCIvPjxsaW5lIGlkPSJnbWFya18xMF8wIiB4MT0iNDAwIiB5MT0iMCIgeDI9IjQwMCIgeTI9IjE1MCIvPjwvZz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCw1KSIgaWQ9IndhdmVsYW5lXzBfMCI+PHRleHQgeD0iLTEwIiB5PSIxNSIgY2xhc3M9ImluZm8iIHRleHQtYW5jaG9yPSJlbmQiIHhtbDpzcGFjZT0icHJlc2VydmUiPjx0c3Bhbj5jbGs8L3RzcGFuPjwvdGV4dD48ZyBpZD0id2F2ZWxhbmVfZHJhd18wXzAiPjx1c2UgeGxpbms6aHJlZj0iI3BjbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwKSIgeGxpbms6aHJlZj0iI25jbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwKSIgeGxpbms6aHJlZj0iI3BjbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwKSIgeGxpbms6aHJlZj0iI25jbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgwKSIgeGxpbms6aHJlZj0iI3BjbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMCkiIHhsaW5rOmhyZWY9IiNuY2xrIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjApIiB4bGluazpocmVmPSIjcGNsayIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTQwKSIgeGxpbms6aHJlZj0iI25jbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MCkiIHhsaW5rOmhyZWY9IiNwY2xrIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxODApIiB4bGluazpocmVmPSIjbmNsayIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAwKSIgeGxpbms6aHJlZj0iI3BjbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIyMCkiIHhsaW5rOmhyZWY9IiNuY2xrIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNDApIiB4bGluazpocmVmPSIjcGNsayIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYwKSIgeGxpbms6aHJlZj0iI25jbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI4MCkiIHhsaW5rOmhyZWY9IiNwY2xrIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMDApIiB4bGluazpocmVmPSIjbmNsayIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzIwKSIgeGxpbms6aHJlZj0iI3BjbGsiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM0MCkiIHhsaW5rOmhyZWY9IiNuY2xrIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzNjApIiB4bGluazpocmVmPSIjcGNsayIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzgwKSIgeGxpbms6aHJlZj0iI25jbGsiLz48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzUpIiBpZD0id2F2ZWxhbmVfMV8wIj48dGV4dCB4PSItMTAiIHk9IjE1IiBjbGFzcz0iaW5mbyIgdGV4dC1hbmNob3I9ImVuZCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHRzcGFuPkRhdGE8L3RzcGFuPjwvdGV4dD48ZyBpZD0id2F2ZWxhbmVfZHJhd18xXzAiPjx1c2UgeGxpbms6aHJlZj0iI3h4eCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjApIiB4bGluazpocmVmPSIjeHh4Ii8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MCkiIHhsaW5rOmhyZWY9IiN4eHgiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYwKSIgeGxpbms6aHJlZj0iI3h4eCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODApIiB4bGluazpocmVmPSIjeG12LTMiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMCkiIHhsaW5rOmhyZWY9IiN2dnYtMyIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTIwKSIgeGxpbms6aHJlZj0iI3Ztdi0zLTQiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE0MCkiIHhsaW5rOmhyZWY9IiN2dnYtNCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTYwKSIgeGxpbms6aHJlZj0iI3Ztdi00LTUiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE4MCkiIHhsaW5rOmhyZWY9IiN2dnYtNSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAwKSIgeGxpbms6aHJlZj0iI3ZteC01Ii8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMjApIiB4bGluazpocmVmPSIjeHh4Ii8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNDApIiB4bGluazpocmVmPSIjeHh4Ii8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNjApIiB4bGluazpocmVmPSIjeHh4Ii8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyODApIiB4bGluazpocmVmPSIjeG12LTIiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMwMCkiIHhsaW5rOmhyZWY9IiN2dnYtMiIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzIwKSIgeGxpbms6aHJlZj0iI3Z2di0yIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzNDApIiB4bGluazpocmVmPSIjdnZ2LTIiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM2MCkiIHhsaW5rOmhyZWY9IiN2bXgtMiIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzgwKSIgeGxpbms6aHJlZj0iI3h4eCIvPjx0ZXh0IHg9IjEwNiIgeT0iMTUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHhtbDpzcGFjZT0icHJlc2VydmUiPjx0c3Bhbj5oZWFkPC90c3Bhbj48L3RleHQ+PHRleHQgeD0iMTQ2IiB5PSIxNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHRzcGFuPmJvZHk8L3RzcGFuPjwvdGV4dD48dGV4dCB4PSIxODYiIHk9IjE1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj48dHNwYW4+dGFpbDwvdHNwYW4+PC90ZXh0Pjx0ZXh0IHg9IjMyNiIgeT0iMTUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHhtbDpzcGFjZT0icHJlc2VydmUiPjx0c3Bhbj5kYXRhPC90c3Bhbj48L3RleHQ+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLDY1KSIgaWQ9IndhdmVsYW5lXzJfMCI+PHRleHQgeD0iLTEwIiB5PSIxNSIgY2xhc3M9ImluZm8iIHRleHQtYW5jaG9yPSJlbmQiIHhtbDpzcGFjZT0icHJlc2VydmUiPjx0c3Bhbj5SZXF1ZXN0PC90c3Bhbj48L3RleHQ+PGcgaWQ9IndhdmVsYW5lX2RyYXdfMl8wIj48dXNlIHhsaW5rOmhyZWY9IiMwMDAiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwKSIgeGxpbms6aHJlZj0iIzAwMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDApIiB4bGluazpocmVmPSIjMDAwIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MCkiIHhsaW5rOmhyZWY9IiMwMDAiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgwKSIgeGxpbms6aHJlZj0iIzBtMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTAwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTIwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTQwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTYwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTgwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAwKSIgeGxpbms6aHJlZj0iIzFtMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjIwKSIgeGxpbms6aHJlZj0iIzAwMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjQwKSIgeGxpbms6aHJlZj0iIzAwMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYwKSIgeGxpbms6aHJlZj0iIzAwMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjgwKSIgeGxpbms6aHJlZj0iIzBtMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzAwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzIwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzQwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzYwKSIgeGxpbms6aHJlZj0iIzFtMCIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzgwKSIgeGxpbms6aHJlZj0iIzAwMCIvPjwvZz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCw5NSkiIGlkPSJ3YXZlbGFuZV8zXzAiPjx0ZXh0IHg9Ii0xMCIgeT0iMTUiIGNsYXNzPSJpbmZvIiB0ZXh0LWFuY2hvcj0iZW5kIiB4bWw6c3BhY2U9InByZXNlcnZlIj48dHNwYW4+PC90c3Bhbj48L3RleHQ+PGcgaWQ9IndhdmVsYW5lX2RyYXdfM18wIi8+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMTI1KSIgaWQ9IndhdmVsYW5lXzRfMCI+PHRleHQgeD0iLTEwIiB5PSIxNSIgY2xhc3M9ImluZm8iIHRleHQtYW5jaG9yPSJlbmQiIHhtbDpzcGFjZT0icHJlc2VydmUiPjx0c3Bhbj5BY2tub3dsZWRnZTwvdHNwYW4+PC90ZXh0PjxnIGlkPSJ3YXZlbGFuZV9kcmF3XzRfMCI+PHVzZSB4bGluazpocmVmPSIjMTExIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwKSIgeGxpbms6aHJlZj0iIzExMSIvPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNjApIiB4bGluazpocmVmPSIjMTExIi8+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyMCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE0MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE4MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIyMCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI0MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI2MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI4MCkiIHhsaW5rOmhyZWY9IiMxbTAiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMwMCkiIHhsaW5rOmhyZWY9IiMwMDAiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMyMCkiIHhsaW5rOmhyZWY9IiMwbTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM0MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM2MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM4MCkiIHhsaW5rOmhyZWY9IiMxMTEiLz48L2c+PC9nPjxnIGlkPSJ3YXZlYXJjc18wIi8+PGcgaWQ9IndhdmVnYXBzXzAiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsNSkiIGlkPSJ3YXZlZ2FwXzBfMCI+PHVzZSB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNjApIiB4bGluazpocmVmPSIjZ2FwIi8+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzUpIiBpZD0id2F2ZWdhcF8xXzAiPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYwKSIgeGxpbms6aHJlZj0iI2dhcCIvPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLDY1KSIgaWQ9IndhdmVnYXBfMl8wIj48dXNlIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI2MCkiIHhsaW5rOmhyZWY9IiNnYXAiLz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwxMjUpIiBpZD0id2F2ZWdhcF80XzAiPjx1c2UgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYwKSIgeGxpbms6aHJlZj0iI2dhcCIvPjwvZz48L2c+PGcvPjwvZz48ZyBpZD0iZ3JvdXBzXzAiPjxnLz48L2c+PC9nPjwvc3ZnPgo='><p>我的流程图：</p><img class="kroki" src='data:image/svg+xml;base64,RXJyb3IgNDAwOiBTeW50YXggRXJyb3I/IChsaW5lOiAxMik='><p>时序图：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">skinparam backgroundColor #FEFEFE</span><br><span class="line">skinparam sequenceArrowThickness 2</span><br><span class="line">skinparam roundcorner 20</span><br><span class="line">skinparam maxmessagesize 60</span><br><span class="line"></span><br><span class="line">actor Developer</span><br><span class="line">participant &quot;GitHub&quot; as GH</span><br><span class="line">box &quot;GitHub Actions&quot; #LightBlue</span><br><span class="line">    participant &quot;build_env&quot; as BE</span><br><span class="line">    participant &quot;build_app&quot; as BA</span><br><span class="line">    participant &quot;release&quot; as R</span><br><span class="line">end box</span><br><span class="line"></span><br><span class="line">Developer -&gt; GH : 推送 v* 标签或手动触发</span><br><span class="line">activate GH</span><br><span class="line"></span><br><span class="line">GH -&gt; BE : 触发工作流</span><br><span class="line">activate BE</span><br><span class="line"></span><br><span class="line">BE -&gt; BE : 生成版本号</span><br><span class="line">BE -&gt; BE : 更新 pubspec.yaml</span><br><span class="line">BE -&gt; BE : 上传 pubspec.yaml</span><br><span class="line">BE --&gt; BA : 完成环境准备</span><br><span class="line">deactivate BE</span><br><span class="line"></span><br><span class="line">activate BA</span><br><span class="line">BA -&gt; BA : 下载 pubspec.yaml</span><br><span class="line">BA -&gt; BA : 设置 Flutter</span><br><span class="line"></span><br><span class="line">par 并行构建</span><br><span class="line">    BA -&gt; BA : 构建 Android</span><br><span class="line">    BA -&gt; BA : 构建 Android AAB</span><br><span class="line">    BA -&gt; BA : 构建 Web</span><br><span class="line">    BA -&gt; BA : 构建 Linux</span><br><span class="line">    BA -&gt; BA : 构建 Windows</span><br><span class="line">    BA -&gt; BA : 构建 iOS</span><br><span class="line">    BA -&gt; BA : 构建 macOS</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">BA -&gt; BA : 压缩构建结果</span><br><span class="line">BA -&gt; BA : 上传 artifacts</span><br><span class="line">BA --&gt; R : 完成所有构建</span><br><span class="line">deactivate BA</span><br><span class="line"></span><br><span class="line">activate R</span><br><span class="line">R -&gt; R : 下载所有 artifacts</span><br><span class="line">R -&gt; R : 创建 GitHub Release</span><br><span class="line">R -&gt; R : 上传 Release 资产</span><br><span class="line">R --&gt; GH : 完成发布</span><br><span class="line">deactivate R</span><br><span class="line"></span><br><span class="line">GH --&gt; Developer : 工作流完成通知</span><br><span class="line">deactivate GH</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用于构建和发布 Flutter 应用程序的GitHub Actions 工作流程</title>
      <link href="/blog/2024/07/26/yong-yu-gou-jian-he-fa-bu-flutter-ying-yong-cheng-xu-de-github-actions-gong-zuo-liu-cheng/"/>
      <url>/blog/2024/07/26/yong-yu-gou-jian-he-fa-bu-flutter-ying-yong-cheng-xu-de-github-actions-gong-zuo-liu-cheng/</url>
      
        <content type="html"><![CDATA[<p>在这个Flutter项目 <a href="https://github.com/xmaihh/FlutterHub"><strong>https://github.com/xmaihh/FlutterHub</strong> </a> 中使用Github Actions自动化构建（Android、iOS、Web、Linux、Windows、macOS）应用并发布到Release。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">          ┌─────────────────┐   ┌─────────────────┐</span><br><span class="line">          │   推送 v* 标签   │   │    手动触发      │</span><br><span class="line">          └────────┬────────┘   └────────┬────────┘</span><br><span class="line">                   │                     │</span><br><span class="line">                   └──────────┬──────────┘</span><br><span class="line">                              ▼</span><br><span class="line">                    ┌───────────────────┐</span><br><span class="line">                    │     build_env     │</span><br><span class="line">                    │ ───────────────── │</span><br><span class="line">                    │ 生成版本号        │</span><br><span class="line">                    │ 更新 pubspec.yaml │</span><br><span class="line">                    │ 上传 pubspec.yaml │</span><br><span class="line">                    └──────────┬────────┘</span><br><span class="line">                               │</span><br><span class="line">                               ▼</span><br><span class="line">    ┌───────────────────────────────────────────────────────┐</span><br><span class="line">    │                       build_app                       │</span><br><span class="line">    │ ┌─────────┐ ┌─────────┐ ┌───┐ ┌─────┐ ┌───┐ ┌───┐ ┌───┐│</span><br><span class="line">    │ │ Android │ │Android  │ │Web│ │Linux│ │Win│ │iOS│ │Mac││</span><br><span class="line">    │ │         │ │  AAB    │ │   │ │     │ │   │ │   │ │   ││</span><br><span class="line">    │ │1.下载   │ │1.下载   │ │<span class="number"> 1 </span>│ │ <span class="number"> 1 </span> │ │<span class="number"> 1 </span>│ │<span class="number"> 1 </span>│ │<span class="number"> 1 </span>││</span><br><span class="line">    │ │2.设置   │ │2.设置   │ │<span class="number"> 2 </span>│ │ <span class="number"> 2 </span> │ │<span class="number"> 2 </span>│ │<span class="number"> 2 </span>│ │<span class="number"> 2 </span>││</span><br><span class="line">    │ │3.构建   │ │3.构建   │ │<span class="number"> 3 </span>│ │ <span class="number"> 3 </span> │ │<span class="number"> 3 </span>│ │<span class="number"> 3 </span>│ │<span class="number"> 3 </span>││</span><br><span class="line">    │ │4.压缩   │ │4.压缩   │ │<span class="number"> 4 </span>│ │ <span class="number"> 4 </span> │ │<span class="number"> 4 </span>│ │<span class="number"> 4 </span>│ │<span class="number"> 4 </span>││</span><br><span class="line">    │ │5.上传   │ │5.上传   │ │<span class="number"> 5 </span>│ │ <span class="number"> 5 </span> │ │<span class="number"> 5 </span>│ │<span class="number"> 5 </span>│ │<span class="number"> 5 </span>││</span><br><span class="line">    │ └─────────┘ └─────────┘ └───┘ └─────┘ └───┘ └───┘ └───┘│</span><br><span class="line">    └───────────────────────────┬───────────────────────────┘</span><br><span class="line">                                │</span><br><span class="line">                                ▼</span><br><span class="line">                      ┌───────────────────┐</span><br><span class="line">                      │      release      │</span><br><span class="line">                      │ ───────────────── │</span><br><span class="line">                      │ 下载所有 artifacts │</span><br><span class="line">                      │ 创建 GitHub Release│</span><br><span class="line">                      │ 上传 Release 资产  │</span><br><span class="line">                      └───────────────────┘</span><br><span class="line"></span><br><span class="line">图例：</span><br><span class="line">1 = 下载 pubspec.yaml  <span class="number"> 2 </span>= 设置 Flutter  <span class="number"> 3 </span>= 构建</span><br><span class="line">4 = 压缩              <span class="number"> 5 </span>= 上传 artifact</span><br></pre></td></tr></table></figure><p>我的PlantUML图片：</p><img class="kroki" src='data:image/svg+xml;base64,RXJyb3IgNDAwOiBTeW50YXggRXJyb3I/IChsaW5lOiAxMik='><p>工作流程的主要步骤：</p><h1 id="触发条件："><a href="#触发条件：" class="headerlink" title="触发条件："></a>触发条件：</h1><ul><li>当推送带有 “v” 开头的标签时</li><li>可以手动触发</li></ul><h1 id="工作流程包含三个主要任务："><a href="#工作流程包含三个主要任务：" class="headerlink" title="工作流程包含三个主要任务："></a>工作流程包含三个主要任务：</h1><ul><li>build_env：更新版本号</li><li>build_app：构建多平台应用</li><li>release：创建发布和上传构建产物</li></ul><ol><li>build_env 任务：</li></ol><ul><li>生成版本号</li><li>更新 pubspec.yaml 中的版本号</li><li>上传更新后的 pubspec.yaml 文件</li></ul><ol start="2"><li>build_app 任务：</li></ol><ul><li>使用矩阵策略为不同平台构建应用（Android、iOS、Web、Linux、Windows、macOS）</li><li>下载更新后的 pubspec.yaml</li><li>设置 Flutter 环境</li><li>安装依赖</li><li>根据平台执行相应的构建命令</li><li>压缩构建产物</li><li>上传构建产物作为 artifact</li></ul><ol start="3"><li>release 任务：</li></ol><ul><li>下载所有构建产物</li><li>创建 GitHub Release</li><li>将构建产物上传为 Release 资产</li></ul><p>在你的<strong>Flutter项目仓库</strong>根目录下创建一个 <strong>.github&#x2F;workflows</strong> 文件夹,在该文件夹内创建一个新的 <strong>YAML</strong> 文件（例如 deploy.yml）用于定义 <strong>GitHub Actions</strong> 工作流。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Flutter</span> <span class="string">Release</span> <span class="string">Build</span> <span class="string">CI/CD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发条件配置</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;v*&#x27;</span> <span class="comment"># 当推送的标签以&quot;v&quot;开头时触发，常用于版本发布</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span> <span class="comment"># 允许手动触发工作流，便于管理和测试</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># 在 Ubuntu 环境中运行，避免了 macOS 的 sed 问题</span></span><br><span class="line">  <span class="comment"># 更新 pubspec.yaml 中的版本号</span></span><br><span class="line">  <span class="comment"># 将新版本号作为输出，供其他 job 使用</span></span><br><span class="line">  <span class="attr">build_env:</span> <span class="comment"># 更新pubspec.yaml中的版本号:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># 检出代码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span> <span class="comment"># 获取全部历史，以便计算版本号</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 生成版本号</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">Version</span> <span class="string">Number</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">generate_version</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # 标签触发 (e.g. v1.0或1.0) 移除 refs/tags/ 前缀和可选的 &#x27;v&#x27; 前缀</span></span><br><span class="line"><span class="string">          if [[ $&#123;&#123; github.ref &#125;&#125; == refs/tags/* ]]; then</span></span><br><span class="line"><span class="string">            TAG_VERSION=$(echo $&#123;&#123; github.ref &#125;&#125; | sed -E &#x27;s/^refs\/tags\/(v)?//&#x27;)</span></span><br><span class="line"><span class="string">            echo &quot;This is a tag release: $TAG_VERSION&quot;</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="comment"># 分支触发 (e.g. main或feature/new-feature) 移除 refs/heads/ 前缀</span></span><br><span class="line">          <span class="string">elif</span> [[ <span class="string">$<span class="template-variable">&#123;&#123; github.ref &#125;&#125;</span></span> <span class="string">==</span> <span class="string">refs/heads/*</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">TAG_VERSION=$(echo</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">-E</span> <span class="string">&#x27;s/^refs\/heads\///&#x27;</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">&#x27;s/\//-/g&#x27;</span><span class="string">)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;This is a branch push: $TAG_VERSION&quot;</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment"># Pull Request触发 (e.g. pr-123) 提取PR的编号 pr-&lt;number&gt;</span></span><br><span class="line">          <span class="string">elif</span> [[ <span class="string">$<span class="template-variable">&#123;&#123; github.ref &#125;&#125;</span></span> <span class="string">==</span> <span class="string">refs/pull/*</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">PR_NUMBER=$(echo</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">-E</span> <span class="string">&#x27;s/^refs\/pull\/([0-9]+)\/merge$/\1/&#x27;</span><span class="string">)</span></span><br><span class="line">            <span class="string">TAG_VERSION=&quot;pr-$PR_NUMBER&quot;</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;This is a Pull Request: $TAG_VERSION&quot;</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment"># 其他情况：直接使用 github.ref 的值 包含任何 &quot;/&quot;会被替换为 &quot;-&quot;</span></span><br><span class="line">          <span class="string">else</span></span><br><span class="line">            <span class="string">TAG_VERSION=$(echo</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">&#x27;s/\//-/g&#x27;</span><span class="string">)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;This is another trigger: $TAG_VERSION&quot;</span></span><br><span class="line">          <span class="string">fi</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;TAG_VERSION=$TAG_VERSION&quot;</span> </span><br><span class="line">          <span class="string">COMMIT_COUNT=$(git</span> <span class="string">rev-list</span> <span class="string">--count</span> <span class="string">HEAD)</span> <span class="comment"># 计算提交数量</span></span><br><span class="line">          <span class="string">SHORT_HASH=$(git</span> <span class="string">rev-parse</span> <span class="string">--short</span> <span class="string">HEAD)</span> <span class="comment"># 获取最近一次提交的短哈希</span></span><br><span class="line">          <span class="string">BUILD_VERSION=&quot;$&#123;COMMIT_COUNT&#125;&quot;</span> <span class="comment"># 组合成完整的构建版本号</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;BUILD_VERSION=$&#123;BUILD_VERSION&#125;&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_OUTPUT</span> <span class="comment"># 设置输出变量</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Generated BUILD_VERSION: $&#123;BUILD_VERSION&#125;&quot;</span> <span class="comment"># 打印完整的构建版本号 (e.g. 34)</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 更新pubspec.yaml中的版本号</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">version</span> <span class="string">in</span> <span class="string">pubspec.yaml</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">update_version_in_pubspec</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # 从pubspec.yaml中提取主版本号,(e.g. version: 1.0.0+1，提取1.0.0)</span></span><br><span class="line"><span class="string">          MAIN_VERSION=$(grep &quot;^version:&quot; pubspec.yaml | sed -E &#x27;s/version: ([0-9]+\.[0-9]+\.[0-9]+).*/\1/&#x27;)</span></span><br><span class="line"><span class="string">          echo &quot;MAIN_VERSION=$&#123;MAIN_VERSION&#125;&quot;</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="comment"># 组合新的完整版本号 (e.g. 1.0.0+34)</span></span><br><span class="line">          <span class="string">FULL_VERSION=&quot;$&#123;MAIN_VERSION&#125;+$&#123;&#123;</span> <span class="string">steps.generate_version.outputs.BUILD_VERSION</span> <span class="string">&#125;&#125;&quot;</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;FULL_VERSION=$&#123;FULL_VERSION&#125;&quot;</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment"># 更新新版本号到pubspec.yaml文件</span></span><br><span class="line">          <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/^version: .*/version: $&#123;FULL_VERSION&#125;/&quot;</span> <span class="string">pubspec.yaml</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Updated pubspec.yaml content:&quot;</span></span><br><span class="line">          <span class="string">cat</span> <span class="string">pubspec.yaml</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment"># 验证更新</span></span><br><span class="line">          <span class="string">if</span> <span class="string">grep</span> <span class="string">-q</span> <span class="string">&quot;^version: $&#123;FULL_VERSION&#125;&quot;</span> <span class="string">pubspec.yaml;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Version updated successfully to $&#123;FULL_VERSION&#125;&quot;</span></span><br><span class="line">          <span class="string">else</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Failed to update version&quot;</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Current version line:&quot;</span></span><br><span class="line">            <span class="string">grep</span> <span class="string">&quot;^version:&quot;</span> <span class="string">pubspec.yaml</span></span><br><span class="line">            <span class="string">exit</span> <span class="number">1</span></span><br><span class="line">          <span class="string">fi</span></span><br><span class="line">          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;FULL_VERSION=$&#123;FULL_VERSION&#125;&quot;</span> <span class="string">&gt;</span> <span class="string">_build_env.config</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">updated</span> <span class="string">pubspec.yaml</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">build_env_files</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            pubspec.yaml</span></span><br><span class="line"><span class="string">            _build_env.config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="attr">build_app:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build_env</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span> <span class="comment"># 使用矩阵策略中指定的操作系统进行构建</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="comment"># 定义不同的构建任务，每个任务对应一个平台</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">android</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">android-aab</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">linux</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">windows</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">windows-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ios</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">macos-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">macos</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">macos-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># 检出代码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">updated</span> <span class="string">pubspec.yaml</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">build_env_files</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Replace</span> <span class="string">pubspec.yaml</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          ls</span></span><br><span class="line"><span class="string">          cat pubspec.yaml</span></span><br><span class="line"><span class="string">          pwd</span></span><br><span class="line"><span class="string">          cat _build_env.config</span></span><br><span class="line"><span class="string"></span>        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Read</span> <span class="string">FULL_VERSION</span> <span class="string">from</span> <span class="string">_build_env.config</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">read_build_env</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Reading version from _build_env.config...&quot;</span></span><br><span class="line"><span class="string">          FULL_VERSION=$(grep &#x27;FULL_VERSION=&#x27; _build_env.config | cut -d &#x27;=&#x27; -f2)</span></span><br><span class="line"><span class="string">          echo &quot;FULL_VERSION=$&#123;FULL_VERSION&#125;&quot; &gt;&gt; $GITHUB_OUTPUT # 设置输出变量</span></span><br><span class="line"><span class="string"></span>        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 设置Flutter环境</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Flutter</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">subosito/flutter-action@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">channel:</span> <span class="string">stable</span>  <span class="comment"># 使用Flutter的稳定版</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 显示Flutter版本信息</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Flutter</span> <span class="string">version</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">--version</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># 安装Flutter依赖</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">pub</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 根据矩阵配置，为不同平台执行构建命令</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Android</span> <span class="string">APK</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;android&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">         flutter build apk</span></span><br><span class="line"><span class="string">         flutter build apk --split-per-abi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Android</span> <span class="string">App</span> <span class="string">Bundle</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;android-aab&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">build</span> <span class="string">appbundle</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Web</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;web&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">build</span> <span class="string">web</span> <span class="string">--base-href=/FlutterHub/</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Linux</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sudo apt-get update -y</span></span><br><span class="line"><span class="string">          sudo apt-get install -y ninja-build libgtk-3-dev</span></span><br><span class="line"><span class="string">          flutter build linux</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Windows</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;windows&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">build</span> <span class="string">windows</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">iOS</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;ios&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">build</span> <span class="string">ios</span> <span class="string">--release</span> <span class="string">--no-codesign</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">macOS</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;macos&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">build</span> <span class="string">macos</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 部署Web平台构建产物到GitHub Pages</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">GitHub</span> <span class="string">Pages</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">matrix.name</span> <span class="string">==</span> <span class="string">&#x27;web&#x27;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./build/web</span></span><br><span class="line">          <span class="attr">publish_branch:</span> <span class="string">gh-pages</span></span><br><span class="line">          <span class="attr">user_name:</span> <span class="string">&#x27;github-actions[bot]&#x27;</span></span><br><span class="line">          <span class="attr">user_email:</span> <span class="string">&#x27;github-actions[bot]@users.noreply.github.com&#x27;</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">&#x27;Deploy to GitHub Pages: $<span class="template-variable">&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 根据平台压缩构建产物，为上传做准备</span></span><br><span class="line">      <span class="comment"># 使用不同的命令和文件路径根据平台进行压缩</span></span><br><span class="line">      <span class="comment"># 这里使用了不同的shell命令和条件判断来处理不同的操作系统和构建产物</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Compress</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          if [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;android&quot; ]; then</span></span><br><span class="line"><span class="string">            mv build/app/outputs/flutter-apk/app-release.apk ./app-release-all-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.apk</span></span><br><span class="line"><span class="string">            mv build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk ./app-release-armeabi-v7a-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.apk</span></span><br><span class="line"><span class="string">            mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ./app-release-arm64-v8a-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.apk</span></span><br><span class="line"><span class="string">            mv build/app/outputs/flutter-apk/app-x86_64-release.apk ./app-release-x86_64-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.apk</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;android-aab&quot; ]; then</span></span><br><span class="line"><span class="string">            mv build/app/outputs/bundle/release/app-release.aab ./app-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.aab</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;web&quot; ]; then</span></span><br><span class="line"><span class="string">            zip -r web-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.zip build/web</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;linux&quot; ]; then</span></span><br><span class="line"><span class="string">            zip -r linux-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.zip build/linux/x64/release/bundle</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;windows&quot; ]; then</span></span><br><span class="line"><span class="string">            powershell Compress-Archive build/windows/x64/runner/Release windows-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.zip</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;ios&quot; ]; then</span></span><br><span class="line"><span class="string">            mkdir Payload</span></span><br><span class="line"><span class="string">            cp -r build/ios/iphoneos/Runner.app Payload/</span></span><br><span class="line"><span class="string">            zip -r ios-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.ipa Payload/</span></span><br><span class="line"><span class="string">            zip -r ios-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.zip build/ios/iphoneos</span></span><br><span class="line"><span class="string">          elif [ &quot;$&#123;&#123; matrix.name &#125;&#125;&quot; = &quot;macos&quot; ]; then</span></span><br><span class="line"><span class="string">            zip -r macos-release-$&#123;&#123; steps.read_build_env.outputs.FULL_VERSION &#125;&#125;.zip build/macos/Build/Products/Release</span></span><br><span class="line"><span class="string">          fi</span></span><br><span class="line"><span class="string"></span>        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">Build</span> <span class="string">Artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.name</span> <span class="string">&#125;&#125;-artifact</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            *.apk</span></span><br><span class="line"><span class="string">            *.aab</span></span><br><span class="line"><span class="string">            *.ipa</span></span><br><span class="line"><span class="string">            *.zip</span></span><br><span class="line"><span class="string"></span>          <span class="attr">if-no-files-found:</span> <span class="string">error</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build_app</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">all</span> <span class="string">artifacts</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">artifacts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">structure</span> <span class="string">of</span> <span class="string">downloaded</span> <span class="string">files</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">ls</span> <span class="string">-R</span> <span class="string">artifacts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Read</span> <span class="string">FULL_VERSION</span> <span class="string">from</span> <span class="string">_build_env.config</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">read_build_env</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Reading version from _build_env.config...&quot;</span></span><br><span class="line"><span class="string">          FULL_VERSION=$(grep &#x27;FULL_VERSION=&#x27; artifacts/build_env_files/_build_env.config | cut -d &#x27;=&#x27; -f2)</span></span><br><span class="line"><span class="string">          echo &quot;FULL_VERSION=$&#123;FULL_VERSION&#125;&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">create_release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/create-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">tag_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.read_build_env.outputs.FULL_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">release_name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.read_build_env.outputs.FULL_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">prerelease:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">Release</span> <span class="string">Assets</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          for artifact in artifacts/*/*.&#123;apk,aab,ipa,zip&#125;</span></span><br><span class="line"><span class="string">          do</span></span><br><span class="line"><span class="string">            if [ -f &quot;$artifact&quot; ]; then</span></span><br><span class="line"><span class="string">              asset_name=$(basename &quot;$artifact&quot;)</span></span><br><span class="line"><span class="string">              echo &quot;Uploading $asset_name&quot;</span></span><br><span class="line"><span class="string">              curl --fail -X POST \</span></span><br><span class="line"><span class="string">                -H &quot;Authorization: token $GITHUB_TOKEN&quot; \</span></span><br><span class="line"><span class="string">                -H &quot;Content-Type: $(file -b --mime-type $artifact)&quot; \</span></span><br><span class="line"><span class="string">                --data-binary @&quot;$artifact&quot; \</span></span><br><span class="line"><span class="string">                &quot;https://uploads.github.com/repos/$&#123;&#123; github.repository &#125;&#125;/releases/$&#123;&#123; steps.create_release.outputs.id &#125;&#125;/assets?name=$asset_name&quot;</span></span><br><span class="line"><span class="string">            fi</span></span><br><span class="line"><span class="string">          done</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
            <tag> Github Actions </tag>
            
            <tag> CI/CD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter各个平台的构建产物</title>
      <link href="/blog/2024/07/25/flutter-ge-ge-ping-tai-de-gou-jian-chan-wu/"/>
      <url>/blog/2024/07/25/flutter-ge-ge-ping-tai-de-gou-jian-chan-wu/</url>
      
        <content type="html"><![CDATA[<p>在 Flutter 中创建一个新项目，同时支持 Android、iOS、macOS、Windows 和 Linux 平台，假设你已经安装了 Flutter SDK 和必要的开发工具（如 Android Studio、Xcode 等）。</p><h1 id="安装-Flutter-SDK"><a href="#安装-Flutter-SDK" class="headerlink" title="安装 Flutter SDK"></a>安装 Flutter SDK</h1><p>按照 <a href="https://flutter.dev/docs/get-started/install"><strong>Flutter 官网</strong></a> 下载并按照指南进行安装。</p><h1 id="创建新项目"><a href="#创建新项目" class="headerlink" title="创建新项目"></a>创建新项目</h1><p>打开终端或命令提示符，使用以下命令创建一个新的 Flutter 项目：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter create my_flutter_app</span><br></pre></td></tr></table></figure><p>这个命令会创建一个名为 <code>my_flutter_app</code> 的新目录，其中包含一个支持 <strong>Android</strong> 和 <strong>iOS</strong> 的 Flutter 项目的初始模板。</p><h1 id="启用桌面支持"><a href="#启用桌面支持" class="headerlink" title="启用桌面支持"></a>启用桌面支持</h1><p>默认情况下，Flutter 支持 Android 和 iOS。如果你想要为 macOS、Windows 和 Linux 添加支持，你需要为每个桌面平台启用支持。运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> my_flutter_app</span><br><span class="line">flutter config --enable-windows-desktop</span><br><span class="line">flutter config --enable-macos-desktop</span><br><span class="line">flutter config --enable-linux-desktop</span><br></pre></td></tr></table></figure><p>这些命令会启用桌面平台的支持。在你启用桌面支持之后，你的项目目录中将包括针对每个桌面平台的特定代码和资源。</p><h1 id="运行和构建应用"><a href="#运行和构建应用" class="headerlink" title="运行和构建应用"></a>运行和构建应用</h1><p>现在你可以尝试在各个平台上运行你的应用了。使用以下命令来运行对应平台的应用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flutter run -d windows  <span class="comment"># 运行 Windows 应用</span></span><br><span class="line">flutter run -d macos    <span class="comment"># 运行 macOS 应用</span></span><br><span class="line">flutter run -d linux    <span class="comment"># 运行 Linux 应用</span></span><br><span class="line">flutter run -d android  <span class="comment"># 运行 Android 应用</span></span><br><span class="line">flutter run -d ios      <span class="comment"># 运行 iOS 应用</span></span><br></pre></td></tr></table></figure><h1 id="各个平台的构建产物"><a href="#各个平台的构建产物" class="headerlink" title="各个平台的构建产物"></a>各个平台的构建产物</h1><p><code>flutter build</code> 命令是用于构建和编译 Flutter 应用程序的重要工具。它可以将您的 Flutter 项目编译成可以在不同平台上运行的二进制文件或包。</p><p>在 Flutter 中，当你使用 <code>flutter build</code> 命令构建项目时，每个平台的构建产物（build artifacts）将会被存放在项目目录下特定的位置。</p><ol><li>基本语法: flutter build &lt;平台&gt;</li><li>支持的平台:<ul><li>apk: 构建 Android APK 文件</li><li>appbundle: 构建 Android App Bundle</li><li>ios: 构建 iOS 应用</li><li>web: 构建 Web 应用</li><li>windows: 构建 Windows 应用</li><li>macos: 构建 macOS 应用</li><li>linux: 构建 Linux 应用</li></ul></li><li>常用选项:<ul><li>–release: 构建发布版本(<strong>默认</strong>)</li><li>–debug: 构建调试版本</li><li>–profile: 构建性能分析版本</li><li>–split-debug-info: 分离调试信息</li><li>–obfuscate: 混淆代码</li><li>–target-platform: 指定目标平台架构</li></ul></li><li>示例:<ul><li>构建 Android APK: flutter build apk</li><li>构建 iOS 应用: flutter build ios</li><li>构建 Web 应用: flutter build web</li></ul></li><li>特殊用法:<ul><li>flutter build aar: 构建 Android Archive (AAR) 文件,用于将 Flutter 模块集成到现有 Android 项目中</li><li>flutter build bundle: 构建 Flutter 资源包,通常用于自定义构建过程</li></ul></li><li>构建过程: build 命令会执行以下步骤:<ul><li>解析项目依赖</li><li>编译 Dart 代码</li><li>生成平台特定的代码</li><li>打包资源文件</li><li>生成最终的二进制文件或包</li></ul></li><li>注意事项:<ul><li>确保在项目根目录下运行命令</li><li>不同平台可能需要额外的设置或工具(如 iOS 需要 Xcode)</li><li>构建时间可能较长,特别是首次构建</li></ul></li><li>优化技巧:<ul><li>使用 –split-debug-info 和 –obfuscate 选项可以减小应用大小并提高安全性</li><li>定期清理构建缓存(flutter clean)可以解决一些构建问题</li></ul></li></ol><h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a><strong>Android</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build apk</span><br></pre></td></tr></table></figure><p>对于 Android，构建产物默认位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/</span>app<span class="regexp">/outputs/</span>flutter-apk/</span><br></pre></td></tr></table></figure><p>在这个目录下，你可以找到 APK 文件（如 <code>app-release.apk</code>），这是发布到 Android 设备的文件。</p><p><strong>构建不同架构的 APK</strong></p><p>默认情况下，<code>flutter build apk</code> 会生成一个包含 <code>armeabi-v7a</code> 和 <code>arm64-v8a</code>（32位和64位 ARM 架构）的 APK。如果你需要为其他架构（如 x86）构建 APK 或者想要减小 APK 文件大小，你可以使用 <code>--split-per-abi</code> 选项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build apk --split-per-abi</span><br></pre></td></tr></table></figure><p>这将生成针对每个支持的 ABI 的单独 APK 文件，通常用于减少每个 APK 的大小，使其更适合特定设备类型。</p><p>构建完成后，APK 文件默认位于以下路径：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">project</span> root]<span class="regexp">/build/</span>app<span class="regexp">/outputs/</span>flutter-apk/</span><br></pre></td></tr></table></figure><p>在这个目录下，你会找到生成的 APK 文件，如：</p><ul><li><code>app-release.apk</code>：未分割 ABI 的发布版本 APK。</li><li><code>app-armeabi-v7a-release.apk</code>：仅包含 <code>armeabi-v7a</code> 架构的发布版本 APK。</li><li><code>app-arm64-v8a-release.apk</code>：仅包含 <code>arm64-v8a</code> 架构的发布版本 APK。</li></ul><p>这些文件可以直接用于安装或分发。如果你使用的是 <code>--debug</code> 或 <code>--profile</code> 选项，相应的文件名也会反映出来（例如 <code>app-debug.apk</code>）。</p><p><strong>Android App Bundle</strong><br>在 Flutter 中，构建一个 Android App Bundle (.aab 文件) 是一个常见的需求，特别是当你需要通过 Google Play 发布你的应用时。Android App Bundle 是 Google 推荐的发布格式，因为它允许 Google Play 根据用户的设备配置动态地生成并提供优化的 APK 包，从而减小应用的下载和安装大小。</p><p>要构建 Android App Bundle，你可以使用以下 Flutter 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build appbundle</span><br></pre></td></tr></table></figure><p>构建完成后，App Bundle 文件默认位于以下路径：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">project</span> root]<span class="regexp">/build/</span>app<span class="regexp">/outputs/</span>bundle<span class="regexp">/release/</span></span><br></pre></td></tr></table></figure><p>在这个目录下，你会找到生成的 <code>.aab</code> 文件，通常命名为 <code>app-release.aab</code>。</p><p><strong>发布到 Google Play</strong></p><p>生成的 <code>.aab</code> 文件是准备好上传到 Google Play 的。上传 App Bundle 而不是 APK 有几个好处：</p><ol><li><strong>大小优化</strong>：Google Play 会根据每个用户的设备生成并提供最适合的 APK，这通常会减少应用的下载和安装大小。</li><li><strong>简化的版本管理</strong>：你只需上传一个 <code>.aab</code> 文件，Google Play 会处理不同设备所需的各种 APK 分发。</li><li><strong>按需加载</strong>：你可以配置你的应用以按需加载资源和功能，进一步减少初始下载的大小。</li></ol><p><strong>注意事项</strong></p><p>确保在构建 App Bundle 之前，你的应用满足所有必要的 Google Play 要求，包括但不限于适当的 <code>AndroidManifest.xml</code> 配置、API 级别要求和权限声明。此外，如果你的应用使用了特定的硬件或软件功能，确保这些功能在 <code>AndroidManifest.xml</code> 中正确声明。</p><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a><strong>iOS</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build ios</span><br></pre></td></tr></table></figure><p>对于 iOS，构建产物位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/i</span>os<span class="regexp">/iphoneos/</span></span><br></pre></td></tr></table></figure><p>在这个目录中，你会找到一个 <code>.app</code> 目录，这是实际的应用程序包，通常用于模拟器或真实设备的测试。如果你使用 Xcode 进行归档，归档产物将会在 Xcode 的 Organizer 中。</p><h2 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a><strong>macOS</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build macos</span><br></pre></td></tr></table></figure><p>对于 macOS，构建产物位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/m</span>acos<span class="regexp">/Build/</span>Products<span class="regexp">/Release/</span></span><br></pre></td></tr></table></figure><p>这里你可以找到 <code>.app</code> 应用程序包，这是可以直接运行的 macOS 应用。</p><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a><strong>Windows</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build windows</span><br></pre></td></tr></table></figure><p>对于 Windows，构建产物位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/</span>windows<span class="regexp">/x64/</span>runner<span class="regexp">/Release/</span></span><br></pre></td></tr></table></figure><p>或者是 <code>Debug</code> 文件夹，取决于你构建的是发布版还是调试版。在这个目录下，你会找到 <code>.exe</code> 文件及其相关的依赖文件。</p><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><strong>Linux</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build linux</span><br></pre></td></tr></table></figure><p>对于 Linux，构建产物位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/</span>linux<span class="regexp">/x64/</span>release<span class="regexp">/bundle/</span></span><br></pre></td></tr></table></figure><p>在这个路径中：</p><ul><li><strong>[project root]</strong> 是你的 Flutter 项目的根目录。</li><li><strong>x64</strong> 表示目标架构，目前 Flutter 支持的是 x64（64位）。</li><li><strong>release</strong> 是构建类型，这里是发布版本。如果你构建的是调试版本，这里会是 <code>debug</code>。</li><li><strong>bundle</strong> 目录包含了可执行文件和所有必需的依赖文件，这是最终的发布包。</li></ul><p>在 <code>bundle</code> 目录内，你会找到一个可执行文件（通常以你的项目名命名），以及可能的一些资源文件和库文件。这个可执行文件就是你可以直接运行的 Linux 应用程序。</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a><strong>Web</strong></h2><p><strong>基本命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build web</span><br></pre></td></tr></table></figure><p>对于 Web 平台，构建产物位于：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">project</span> directory&gt;<span class="regexp">/build/</span>web/</span><br></pre></td></tr></table></figure><p>这个目录包含了所有部署到 Web 服务器的静态文件，如 HTML、JavaScript 和 CSS 文件。</p><p>确保在构建前选择正确的构建配置（如 Debug 或 Release），因为这将影响构建产物的性能和大小。</p><p>在这个 <code>web</code> 目录中，你会找到以下类型的文件和目录：</p><ul><li>**<code>index.html</code>**：这是你的应用的入口文件。如果你使用了 <code>--base-href</code> 选项，<code>&lt;base&gt;</code> 标签的 <code>href</code> 属性将被设置到你指定的路径。</li><li>**<code>main.dart.js</code>**：这是你的 Dart 代码编译成 JavaScript 后的文件，是运行你的 Flutter 应用的核心。</li><li>**<code>assets/</code>**：包含所有静态资源，如图片、字体以及其他从 Dart 代码中引用的文件。</li><li>**<code>favicon.png</code>**：网站的图标文件。</li><li><strong>其他 JavaScript 和源映射文件</strong>：例如，用于调试的 <code>.map</code> 文件等。</li></ul><p><strong>部署</strong></p><p>当你准备将你的 Flutter Web 应用部署到服务器时，你需要将整个 <code>build/web</code> 目录的内容上传到你的服务器。确保服务器的配置能正确处理你的应用，特别是如果你设置了基本路径（如使用了 <code>--base-href</code>）。</p><p><strong>本地测试</strong></p><p>在部署之前，你可以在本地设置一个 HTTP 服务器来测试这些文件，确保一切按预期工作。你可以使用 Python 的 <code>http.server</code> 模块，或者 Node.js 的 <code>http-server</code>，或者任何其他能够提供静态文件服务的工具。</p><p>例如，使用 Python 的简单 HTTP 服务器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> [project root]/build/web</span><br><span class="line">python -m http.server 8000</span><br></pre></td></tr></table></figure><p>然后在浏览器中访问 <code>http://localhost:8000</code> 来查看你的应用。</p><p>确保在实际的生产环境中使用专业的 Web 服务器，如 Nginx 或 Apache，以提供更好的性能和安全性。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter设置App版本</title>
      <link href="/blog/2024/07/24/flutter-she-zhi-app-ban-ben/"/>
      <url>/blog/2024/07/24/flutter-she-zhi-app-ban-ben/</url>
      
        <content type="html"><![CDATA[<p>在使用Flutter管理APP版本时，打开<code>pubspec.yaml</code>只看到一个<code>version</code>字段，例如：<code>version: 1.0.0+1</code>。</p><p>我们在使用原生<strong>iOS</strong>或者<strong>Android</strong>开发的时候,我们会在<strong>info.plist</strong>中设置<code>version</code>和<code>build</code>或是在<strong>build.gradle</strong>中设置<code>versionName</code>和<code>versionCode</code>,他们分别表示APP的版本和构建版本。</p><p>拿<strong>Android</strong>开发中简单的说，<code>versionCode</code>是给机器看的，<code>versionName</code>是给人看的。更新的时候，机器根据<code>versionCode</code>判断是升级还是降级，即使<code>versionName(版本号)</code>比以前的高，但是<code>versionCode</code>比以前的低，机器还是会判断是降级。</p><p>Flutter采用的是加号式的版本描述方式，<code>+</code>前面是版本号，<code>+</code>后面是当前版本的build号。格式是 <code>version: major.minor.patch+build</code>，其中 <code>major</code>、<code>minor</code> 和 <code>patch</code> 表示不同的发布级别，<code>build</code> 是构建号。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span><span class="string">+1</span></span><br></pre></td></tr></table></figure><p>这里 <code>1.0.0</code> 是版本号，<code>+1</code> 是构建号。每次发布新版本到应用程序商店时，您都应该至少增加构建号。</p><p>在 <strong>Android</strong> 的 <code>android/app/build.gradle</code> 文件中，<code>versionCode</code> 和 <code>versionName</code> 从 <code>pubspec.yaml</code> 文件中获取：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        versionCode flutterVersionCode.<span class="keyword">toInteger</span>()</span><br><span class="line">        versionName flutterVersionName</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <strong>iOS</strong> 中，Flutter也会自动更新项目的 <code>Info.plist</code> 文件，但如果您需要手动更新，您可以编辑 <code>CFBundleShortVersionString</code>（版本号）和 <code>CFBundleVersion</code>（构建号）：</p><figure class="highlight plist"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- version --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleShortVersionString<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>$(FLUTTER_BUILD_NAME)<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleSignature<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- build --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>$(FLUTTER_BUILD_NUMBER)<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>LSApplicationCategoryType<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Flutter在编译的时候会生成<code>ios/Flutter/Generated.xcconfig</code>和<code>android/local.properties</code>文件。这两个文件由Flutter编译自动生成，不可更改。记录了包含SDK路径或者文件路径，版本信息，环境配置（release&#x2F;debug）等信息。原生工程获取版本信息的变量就定义在这两个文件里面。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://juejin.cn/post/6844903965440606222">Flutter设置APP版本与构建版本</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows下仅为 GitHub 设置SSH代理</title>
      <link href="/blog/2024/07/15/windows-xia-jin-wei-github-she-zhi-ssh-dai-li/"/>
      <url>/blog/2024/07/15/windows-xia-jin-wei-github-she-zhi-ssh-dai-li/</url>
      
        <content type="html"><![CDATA[<p> 在测试Windows 10的PowerShell下<code> ssh -T git@github.com</code>命令时，老是报超时。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t git@github.com ssh: connect to host github.com port 22: connection timed out</span><br></pre></td></tr></table></figure><h1 id="git-代理"><a href="#git-代理" class="headerlink" title="git 代理"></a>git 代理</h1><p>设置 <code>git config --global http.https://github.com.proxy socks5://127.0.0.1:7890</code><br>设置完成后, <code>~/.gitconfig</code> 文件中会增加以下条目:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">http <span class="string">&quot;https://github.com&quot;</span></span>]</span><br><span class="line">    proxy = socks5:<span class="comment">//127.0.0.1:7890</span></span><br></pre></td></tr></table></figure><h1 id="ssh-代理"><a href="#ssh-代理" class="headerlink" title="ssh 代理"></a>ssh 代理</h1><p>修改 <code>~/.ssh/config</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">  User git</span><br><span class="line">  Port 443</span><br><span class="line">  Hostname ssh.github.com</span><br><span class="line">  IdentityFile <span class="string">&quot;C:\Users\用户名\.ssh\id_rsa&quot;</span></span><br><span class="line">  TCPKeepAlive <span class="built_in">yes</span></span><br><span class="line">  ProxyCommand <span class="string">&quot;C:\Users\用户名\scoop\apps\git\current\mingw64\bin\connect.exe&quot;</span> -S 127.0.0.1:7890 -a none %h %p</span><br><span class="line"></span><br><span class="line">Host ssh.github.com</span><br><span class="line">  User git</span><br><span class="line">  Port 443</span><br><span class="line">  Hostname ssh.github.com</span><br><span class="line">  IdentityFile <span class="string">&quot;C:\Users\用户名\.ssh\id_rsa&quot;</span></span><br><span class="line">  TCPKeepAlive <span class="built_in">yes</span></span><br><span class="line">  ProxyCommand <span class="string">&quot;C:\Users\用户名\scoop\apps\git\current\mingw64\bin\connect.exe&quot;</span> -S 127.0.0.1:7890 -a none %h %p</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSH </tag>
            
            <tag> Git </tag>
            
            <tag> Github </tag>
            
            <tag> Windows </tag>
            
            <tag> Proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitHub Actions 自动化部署 Hexo 到Github pages</title>
      <link href="/blog/2024/07/10/github-actions-zi-dong-hua-bu-shu-hexo-dao-github-pages/"/>
      <url>/blog/2024/07/10/github-actions-zi-dong-hua-bu-shu-hexo-dao-github-pages/</url>
      
        <content type="html"><![CDATA[<p>好久没写Blog了，准确来说，好久没发布Blog了。由于电脑环境的变化，之前的的环境都找不到了，懒得修，这次切换到自动化部署，以后专心写markdown。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>在 GitHub 建好两个仓库，</p><ul><li><p>私有仓库，存放<strong>Blog源码仓库</strong></p></li><li><p>公开仓库：存放<strong>Github Pages仓库</strong>：<strong>username.github.io 仓库</strong></p></li></ul><p>Blog源码仓库私有化是一些主题配置有一些API_Token，所以和 Github Pages 仓库分开管理。</p><p>一个仓库也是可以的，直接参考<a href="https://hexo.io/zh-cn/docs/github-pages">Hexo 官方部署方案</a>。</p><h1 id="设置密钥"><a href="#设置密钥" class="headerlink" title="设置密钥"></a>设置密钥</h1><p> GitHub Actions是在<strong>Blog源码仓库</strong>执行的，为了确保 GitHub Actions 能够推送代码到<strong>Github Pages仓库</strong>，使用SSH 密钥的方式来执行git的推送。</p><h2 id="生成新-SSH-密钥"><a href="#生成新-SSH-密钥" class="headerlink" title="生成新 SSH 密钥"></a><a href="https://docs.github.com/zh/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key">生成新 SSH 密钥</a></h2><p>在本地计算机上生成新的 SSH 密钥。 生成密钥后，可将公钥添加到 GitHub.com 上的帐户中，以便通过 SSH 为 Git 操作启用身份验证。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -C &quot;your_email@example.com&quot; -f github-deploy-key</span><br></pre></td></tr></table></figure><p>一路回车下去，当前目录下就会生成 <code>github-deploy-key</code> 和 <code>github-deploy-key.pub</code> 。</p><blockquote><p>千万注意：在提示符下，键入安全密码的时候，直接回车不要输入密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Enter passphrase (empty <span class="keyword">for</span> no passphrase): [Type a passphrase]</span><br><span class="line">&gt; Enter same passphrase again: [Type passphrase again] </span><br></pre></td></tr></table></figure><p>如果输入了密码，那么重新生成一个吧。</p></blockquote><h2 id="向你的Github帐户添加新的-SSH-密钥"><a href="#向你的Github帐户添加新的-SSH-密钥" class="headerlink" title="向你的Github帐户添加新的 SSH 密钥"></a><del><a href="https://docs.github.com/zh/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account#adding-a-new-ssh-key-to-your-account">向你的Github帐户添加新的 SSH 密钥</a></del></h2><p><del>向 GitHub.com 上的帐户添加SSH 公钥<code>github-deploy-key.pub</code>的内容。</del></p><ol><li><p><del>在 GitHub 任意页的右上角，单击个人资料照片，然后单击“<strong>设置</strong>”。</del></p></li><li><p><del>在边栏的“访问”部分中，单击 “SSH 和 GPG 密钥”。</del></p></li><li><p><del>单击“新建 SSH 密钥”或“添加 SSH 密钥” 。</del></p></li><li><p><del>在 “Title”（标题）字段中，为新密钥添加描述性标签。</del></p></li><li><p><del>在“密钥”字段中，粘贴公钥。</del></p></li><li><p><del>单击“添加 SSH 密钥”。</del></p><p><img src="https://s2.loli.net/2024/07/11/SwXtxivCycJZ4f7.png" alt="image-20240711173259866"></p></li></ol><blockquote><p><del>为了保险起见，你可以在本地先测试下 SSH 连接，确保设置成功。</del></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure></blockquote><h1 id="Blog源码仓库设置"><a href="#Blog源码仓库设置" class="headerlink" title="Blog源码仓库设置"></a><strong>Blog源码仓库</strong>设置</h1><p>借助存储库环境中创建的环境变量Secrets and variables设置SSH 私钥，GitHub Actions 读取并保存下来还原成SSH 私钥文件。</p><p>进入<strong>Blog源码仓库</strong>页面 → Settings → Secrets and variables → actions → New repository secret，Name 填 <code>HEXO_DEPLOY_PRI</code> ，Secret 填 <code>github-deploy-key</code> 私钥的内容。</p><p><img src="https://s2.loli.net/2024/07/11/VZ2Kzjw1C7dEXxi.png" alt="image-20240711175319943"></p><h1 id="Github-Pages仓库设置"><a href="#Github-Pages仓库设置" class="headerlink" title="Github Pages仓库设置"></a><strong>Github Pages仓库</strong>设置</h1><p>进入<strong>Github Pages仓库</strong>页面 → Settings → Deploy keys → Add deploy key，Title 填 <code>HEXO_DEPLOY_PUB</code> ，Key 填 <code>github-deploy-key.pub</code> 公钥的内容。</p><p><img src="https://s2.loli.net/2024/07/12/YWUOpze79IPuQLJ.png" alt="image-YWUOpze79IPuQLJ"></p><blockquote><p>这里有一个坑，如果你在[2.2 向你的Github账户添加新的SSH密钥](## <del><a href="https://docs.github.com/zh/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account#adding-a-new-ssh-key-to-your-account">向你的Github帐户添加新的 SSH 密钥</a></del>)会发现这里添加不上，来看一下Github对<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#deploy-keys">Deploy keys 部署密钥</a>的说明：部署密钥是授予对<strong>单个存储库的访问权限</strong>的 SSH 密钥。GitHub 将<strong>密钥的公共部分</strong>直接附加到您的存储库（这里是Github Pages仓库）而不是个人帐户，并且<strong>密钥的私有部分</strong>保留在您的服务器上（这里是执行Github Action的Blog源码仓库）。</p></blockquote><h1 id="升级最新版本的Hexo"><a href="#升级最新版本的Hexo" class="headerlink" title="升级最新版本的Hexo"></a>升级最新版本的Hexo</h1><p>我之前的Hexo版本是5.0+的版本了，怕在部署的时候遇到一些版本问题，所以直接重新安装最新版本的Hexo，在本地调试好确保可以在本地正常生成和部署页面。</p><p>参考Hexo官方文档：<a href="https://hexo.io/docs/">https://hexo.io/docs/</a></p><p>直接安装好环境，把<strong>旧的source 文件夹</strong>迁移过去即可。</p><blockquote><p>注意更新<code>package.json</code>中的所有依赖包到最新版本，使用 <code>npm-check-updates</code> 是一个有用的工具，可以用来更新 <code>package.json</code> 中的所有依赖包到最新的版本。<strong>全局安装 npm-check-updates</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-check-updates</span><br></pre></td></tr></table></figure><p><strong>检查可更新的依赖</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncu</span><br></pre></td></tr></table></figure><p>这会列出所有可以更新的依赖包及其新版本。</p><p><strong>更新 <code>package.json</code> 中的依赖版本</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncu -u</span><br></pre></td></tr></table></figure><p>这会自动更新 <code>package.json</code> 中的依赖版本。</p><p><strong>安装更新的依赖</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure><p>这会列出所有可以更新的依赖包及其新版本。</p><p><strong>更新特定依赖</strong></p><p>如果你只想更新某个特定的依赖包，可以使用 <code>npm install</code> 命令并指定最新版本或使用 <code>@latest</code> 标签。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install [package-name]@latest</span><br><span class="line">例如，要更新 hexo 到最新版本</span><br><span class="line">npm install hexo@latest</span><br></pre></td></tr></table></figure></blockquote><h1 id="Github-Actions-脚本"><a href="#Github-Actions-脚本" class="headerlink" title="Github Actions 脚本"></a>Github Actions 脚本</h1><p>在你的<strong>Blog源码仓库</strong>根目录下创建一个 <strong>.github&#x2F;workflows</strong> 文件夹,在该文件夹内创建一个新的 <strong>YAML</strong> 文件（例如 hexo-deploy.yml）用于定义 <strong>GitHub Actions</strong> 工作流。</p><p>完整的 GitHub Actions 配置文件内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">name: Deploy hexo blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置触发条件</span></span><br><span class="line"><span class="comment"># 触发条件：push更新到master 分支 触发 GitHub Actions 进行自动部署</span></span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">    - master <span class="comment"># Blog源码仓库你使用的分支名称</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">jobs</span>:</span><br><span class="line">  build:</span><br><span class="line">  <span class="comment"># 使用ubuntu镜像，node版本为20.x</span></span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    strategy:</span><br><span class="line">      matrix:</span><br><span class="line">        node-version: [20.x]</span><br><span class="line"></span><br><span class="line">    steps:</span><br><span class="line">      <span class="comment"># 拉取代码</span></span><br><span class="line">      - name: Checkout</span><br><span class="line">        uses: actions/checkout@v4</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 安装node和npm</span></span><br><span class="line">      - name: Use Node.js <span class="variable">$&#123;&#123; matrix.node-version &#125;</span>&#125;</span><br><span class="line">        uses: actions/setup-node@v4</span><br><span class="line">        with:</span><br><span class="line">          node-version: <span class="variable">$&#123;&#123; matrix.node-version &#125;</span>&#125;</span><br><span class="line">          </span><br><span class="line">      <span class="comment"># 配置环境变量，也可使用第三方的 action 发布到gh-pages，如peaceiris/actions-gh-pages@v3，就不用配置这么复杂</span></span><br><span class="line">      - name: Configuration environment</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          HEXO_DEPLOY_PRI: <span class="variable">$&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;</span>&#125;</span><br><span class="line">        run: |</span><br><span class="line">          <span class="built_in">sudo</span> timedatectl set-timezone <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">          <span class="built_in">mkdir</span> -p ~/.ssh/</span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$HEXO_DEPLOY_PRI</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\r&#x27;</span> &gt; ~/.ssh/id_rsa</span><br><span class="line">          <span class="built_in">chmod</span> 600 ~/.ssh/id_rsa</span><br><span class="line">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class="line">          git config --global user.name <span class="string">&quot;yourname&quot;</span></span><br><span class="line">          git config --global user.email <span class="string">&quot;your_email&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># npm ci 使用 package-lock.json 文件中的确切版本来安装依赖</span></span><br><span class="line">      <span class="comment"># 我这里用的主题为maupassant</span></span><br><span class="line">      - name: Install dependencies</span><br><span class="line">        run: |</span><br><span class="line">          npm i -g hexo-cli</span><br><span class="line">          npm ci</span><br><span class="line">          <span class="built_in">cd</span> themes/maupassant/</span><br><span class="line">          npm ci</span><br><span class="line"></span><br><span class="line">      - name: Deploy hexo</span><br><span class="line">        run: |</span><br><span class="line">          hexo clean</span><br><span class="line">          hexo d -g</span><br></pre></td></tr></table></figure><blockquote><p>配置部署信息</p><p>要使 <code>hexo d -g</code> 正常工作，你需要在Blog源码根目录下的 <code>_config.yml</code> 文件中配置部署信息。配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: git@github.com:username/username.github.io <span class="comment"># 更改为你的 GitHub Pages 仓库, username 是你的用户名</span></span><br><span class="line">  branch: gh-pages <span class="comment"># GitHub Pages 分支</span></span><br></pre></td></tr></table></figure></blockquote><p>提交本地的 <strong>Blog源码仓库</strong>即可触发 <strong>Github Actions</strong> 工作流实现自动部署，然后访问你的 <strong>username.github.io</strong> ！</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://alanlee.fun/2024/07/05/deploy-hexo-with-github-action/">使用 GitHub Actions 自动发布 Hexo 博客</a><br><a href="https://hackergavin.com/2024/01/11/hexo-automate-deploy/">利用 GitHub Actions 实现自动化部署 Hexo 到 Github Pages</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github Actions </tag>
            
            <tag> Hexo </tag>
            
            <tag> CI/CD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cloudflare Tunnel(实现内网穿透)的使用方法</title>
      <link href="/blog/2024/07/10/cloudflare-tunnel-shi-xian-nei-wang-chuan-tou-de-shi-yong-fang-fa/"/>
      <url>/blog/2024/07/10/cloudflare-tunnel-shi-xian-nei-wang-chuan-tou-de-shi-yong-fang-fa/</url>
      
        <content type="html"><![CDATA[<p>Cloudflare Tunnel提供了一种安全的方法来连接你的网络服务到 Cloudflare 网络，而不需要开放服务器的端口到公网上，或者在 DNS 上直接暴露服务器的 IP 地址。这种方式能够帮助越过 DNS 阻断，并增强服务的安全性。</p><p>由于服务的真实 IP 地址不会在 DNS 查询中直接暴露，Cloudflare Tunnel 可以帮助绕过基于 DNS 的阻断。用户的请求首先到达 Cloudflare 的网络，然后通过建立好的安全隧道转发到后端的服务。这意味着，即使某些 DNS 请求被拦截或阻断，用户的请求仍然可以通过 Cloudflare 的网络到达目标服务。</p><p><a href="https://www.cloudflare.com/products/tunnel/">Cloudflare Tunnel</a> 可以让服务器主动访问 Cloudflare (CF) 的 CDN 节点。这样服务器完全不需要接受任何外来连接，增强安全性。此外，Cloudflare Tunnel 也可以让服务器处于 NAT 后面，无需公网 IP 也可以提供 Web 等服务。</p><blockquote><p>要使用 Cloudflare Tunnel，相应域名必须在 CF 解析，且服务器必须能够访问最近的 CF 节点。</p></blockquote><p>本文以搭建 <code>memos</code> 为例子,类似于一个私人微博的开源项目</p><p><a href="https://github.com/usememos/memos">https://github.com/usememos/memos</a></p><p><img src="https://s2.loli.net/2024/07/10/lykGfBTxHsdtwFP.png" alt="demo-screenshot"></p><p>域名以二级域名：<code>memos.abc.com</code> 为例。</p><h1 id="memos安装"><a href="#memos安装" class="headerlink" title="memos安装"></a><code>memos</code>安装</h1><p>直接docker compose起手：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> ~/memos &amp;&amp; <span class="built_in">cd</span> ~/memos</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;services:</span></span><br><span class="line"><span class="string">  memos:</span></span><br><span class="line"><span class="string">    image: neosmemo/memos:stable</span></span><br><span class="line"><span class="string">    container_name: memos</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - ~/.memos/:/var/opt/memos</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - \&quot;5230:5230\&quot;&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> docker-compose.yml &gt; /dev/null</span><br><span class="line">$ docker compose up -d</span><br></pre></td></tr></table></figure><p>访问<code>http://localhost:5230</code>，即可打开<code>memos</code>。</p><h1 id="Nginx设置反向代理（非必要步骤）"><a href="#Nginx设置反向代理（非必要步骤）" class="headerlink" title="Nginx设置反向代理（非必要步骤）"></a>Nginx设置反向代理（非必要步骤）</h1><p>安装Nginx：</p><p>添加<code>memos</code>的反向代理配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;server &#123;</span></span><br><span class="line"><span class="string">    listen 80;</span></span><br><span class="line"><span class="string">    listen [::]:80;</span></span><br><span class="line"><span class="string">    server_name memos.abc.com;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    location / &#123;</span></span><br><span class="line"><span class="string">        proxy_pass http://localhost:5230;</span></span><br><span class="line"><span class="string">        proxy_set_header Host \$host;</span></span><br><span class="line"><span class="string">        proxy_set_header X-Real-IP \$remote_addr;</span></span><br><span class="line"><span class="string">        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="string">        proxy_set_header X-Forwarded-Proto \$scheme;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/nginx/conf.d/memos.abc.com.conf &gt; /dev/null</span><br></pre></td></tr></table></figure><p>重启Nginx，使配置生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> systemctl restart nginx</span><br></pre></td></tr></table></figure><p>报错：<code>[Nginx: Failed to start A high performance web server and a reverse proxy server](https://stackoverflow.com/questions/51525710/nginx-failed-to-start-a-high-performance-web-server-and-a-reverse-proxy-server)</code></p><blockquote><p>您已经有一个进程绑定到 HTTP 端口 80。您可以运行命令 <code>sudo lsof -i:80</code> 来获取使用该端口的进程列表，然后尝试停止正在使用80端口的进程<code>sudo fuser -k 80/tcp</code>。</p></blockquote><p>对我来说，这个错误是由端口 80 上已有的 <code>default</code> nginx 站点引起的。删除默认站点有效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">rm</span> /etc/nginx/sites-enabled/default</span><br><span class="line">$ <span class="built_in">sudo</span> service nginx restart</span><br></pre></td></tr></table></figure><h1 id="安装Cloudflared"><a href="#安装Cloudflared" class="headerlink" title="安装Cloudflared"></a>安装Cloudflared</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L <span class="string">&#x27;https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64&#x27;</span> -o cloudflared &amp;&amp; <span class="built_in">chmod</span> +x cloudflared</span><br></pre></td></tr></table></figure><h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./cloudflared tunnel login</span><br></pre></td></tr></table></figure><p>输入命令后，终端会给出一个登陆地址，我们拷贝到浏览器里面打开，选择需要授权的域名，完成后将生成一个证书文件 <code>~/.cloudflared/cert.pem</code>。</p><h2 id="创建隧道"><a href="#创建隧道" class="headerlink" title="创建隧道"></a>创建隧道</h2><p>授权完以后，我们需要创建隧道。一般建议一台服务器创建一个隧道。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cloudflared tunnel create &lt;隧道名字&gt;</span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line">$ ./cloudflared tunnel create memos</span><br></pre></td></tr></table></figure><p>创建完以后，会输出隧道的一个UUID，记录下来Tunnel ID。</p><h2 id="创建-DNS-记录"><a href="#创建-DNS-记录" class="headerlink" title="创建 DNS 记录"></a>创建 DNS 记录</h2><p>我们需要把域名指向到对应的隧道。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cloudflared tunnel route dns &lt;隧道名字&gt; &lt;域名&gt;</span><br><span class="line"><span class="comment"># 比如一级域名（和Web界面不一样，不需要输入@）</span></span><br><span class="line">cloudflared tunnel route dns memos abc.com</span><br><span class="line"><span class="comment"># 又比如二级域名</span></span><br><span class="line">cloudflared tunnel route dns memos memos.abc.com</span><br><span class="line">$ ./cloudflared tunnel route dns memos memos.abc.com</span><br></pre></td></tr></table></figure><p>这时候，Cloudflare会自动添加一条CNAME记录到对应的域名。</p><p>对于多个其他域名，我们需要登录Cloudflare的Web控制台，对应添加CNAME记录，记录值是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;隧道UUID&gt;.cfargotunnel.com</span><br><span class="line"></span><br><span class="line">比如</span><br><span class="line"></span><br><span class="line">12345-123-123-123-12345.cfargotunnel.com</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/10/fNEl6vMZUpCz4Th.png" alt="img"></p><h2 id="cloudflared-配置"><a href="#cloudflared-配置" class="headerlink" title="cloudflared 配置"></a>cloudflared 配置</h2><p>开始配置Cloudflared，先编辑一个配置文件<code>vim ~/.cloudflared/config.yml</code></p><p>输入下面的内容（根据自己要求编辑）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tunnel: &lt;隧道UUID&gt;</span><br><span class="line">credentials-file: /root/.cloudflared/&lt;隧道UUID&gt;.json</span><br><span class="line">protocol: h2mux</span><br><span class="line">ingress:</span><br><span class="line">  <span class="comment"># 第一个网站，连接到本地的80端口</span></span><br><span class="line">  - hostname: &lt;域名1.com&gt;</span><br><span class="line">    service: http://localhost:80</span><br><span class="line">  <span class="comment"># 第二个网站，https协议，连接到本地的443端口，禁用证书校验（用于自签名SSL证书）</span></span><br><span class="line">  - hostname: &lt;域名2.com&gt;</span><br><span class="line">    service: https://127.0.0.1:443</span><br><span class="line">    originRequest:</span><br><span class="line">      noTLSVerify: <span class="literal">true</span></span><br><span class="line">      originServerName: &lt;域名2.com&gt;</span><br><span class="line">  <span class="comment"># 第三个网站，8012端口，泛域名</span></span><br><span class="line">  - hostname: &lt;*.域名3.com&gt;</span><br><span class="line">    service: http://localhost:8012</span><br><span class="line">  <span class="comment"># 第四个，反代MySQL sock服务</span></span><br><span class="line">  - hostname: &lt;mysql.域名4.com&gt;</span><br><span class="line">    service: unix:/tmp/mysql.sock</span><br><span class="line">  <span class="comment"># 第五个，反代SSH服务</span></span><br><span class="line">  - hostname: &lt;ssh.域名5.com&gt;</span><br><span class="line">    service: ssh://localhost:22</span><br><span class="line">  - service: http_status:404</span><br></pre></td></tr></table></figure><p>更多支持的服务和配置方式，参考帮助文档：<a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/local/local-management/ingress/?ref=bra.live#supported-protocols">Supported protocols</a></p><p>我这里配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;tunnel: &lt;隧道UUID&gt;</span></span><br><span class="line"><span class="string">credentials-file: /root/.cloudflared/&lt;隧道UUID&gt;.json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ingress:</span></span><br><span class="line"><span class="string">  - hostname: memos.abc.com</span></span><br><span class="line"><span class="string">    service: http://localhost:80</span></span><br><span class="line"><span class="string">  - service: http_status:404&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> ~/.cloudflared/config.yml &gt; /dev/null</span><br></pre></td></tr></table></figure><p>验证下配置有没有问题</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./cloudflared tunnel ingress validate</span><br></pre></td></tr></table></figure><p>再测试下规则是否命中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./cloudflared tunnel ingress rule https://memos.abc.com</span></span><br></pre></td></tr></table></figure><p>如果没问题，OK，一切妥当，我们开始测试</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">./cloudflared</span> <span class="params">--loglevel</span> debug <span class="params">--transport-loglevel</span> warn <span class="params">--config</span> ~<span class="string">/.cloudflared/config.yml</span> tunnel run &lt;隧道UUID&gt;</span><br></pre></td></tr></table></figure><p>终端会输出一大堆log，但没有红色报错，那就没问题。</p><p>登陆Cloudflare Zero Trust的<a href="https://one.dash.cloudflare.com/?ref=bra.live">Web控制台</a>，左边选择Networks-Tunnels，可以看到隧道已经跑起来了，状态是<code>HEALTHY</code>。</p><p><img src="https://s2.loli.net/2024/07/10/dIBYseOKuZ2w5Nc.png" alt="image-20240710163347443"></p><p>按下Ctrl+z，先停掉刚才启动的服务。</p><h2 id="配置为系统服务"><a href="#配置为系统服务" class="headerlink" title="配置为系统服务"></a>配置为系统服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./cloudflared service install</span><br></pre></td></tr></table></figure><blockquote><p>创建系统服务后，配置文件会被拷贝到 <code>/etc/cloudflared/config.yml</code>。</p></blockquote><p>在创建系统服务后，你可以使用 <code>systemctl</code> 命令来管理服务。</p><h4 id="1-启动服务"><a href="#1-启动服务" class="headerlink" title="1. 启动服务"></a>1. 启动服务</h4><p>要启动 <code>cloudflared</code> 服务，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start cloudflared</span><br></pre></td></tr></table></figure><h4 id="2-停止服务"><a href="#2-停止服务" class="headerlink" title="2. 停止服务"></a>2. 停止服务</h4><p>要停止 <code>cloudflared</code> 服务，使用以下命令：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop cloudflared</span><br></pre></td></tr></table></figure><h4 id="3-重启服务"><a href="#3-重启服务" class="headerlink" title="3. 重启服务"></a>3. 重启服务</h4><p>要重启 <code>cloudflared</code> 服务，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart cloudflared</span><br></pre></td></tr></table></figure><h4 id="4-查看服务状态"><a href="#4-查看服务状态" class="headerlink" title="4. 查看服务状态"></a>4. 查看服务状态</h4><p>要查看 <code>cloudflared</code> 服务的状态，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">复制代码</span><br><span class="line"><span class="built_in">sudo</span> systemctl status cloudflared</span><br></pre></td></tr></table></figure><p>这将显示服务的运行状态、最近的日志等信息。</p><h4 id="5-启用服务开机自启动"><a href="#5-启用服务开机自启动" class="headerlink" title="5. 启用服务开机自启动"></a>5. 启用服务开机自启动</h4><p>要设置 <code>cloudflared</code> 服务在系统启动时自动启动，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> cloudflared</span><br></pre></td></tr></table></figure><h4 id="6-禁用服务开机自启动"><a href="#6-禁用服务开机自启动" class="headerlink" title="6. 禁用服务开机自启动"></a>6. 禁用服务开机自启动</h4><p>要禁用 <code>cloudflared</code> 服务在系统启动时自动启动，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> cloudflared</span><br></pre></td></tr></table></figure><h4 id="7-查看服务日志"><a href="#7-查看服务日志" class="headerlink" title="7. 查看服务日志"></a>7. 查看服务日志</h4><p>要查看 <code>cloudflared</code> 服务的日志，使用 <code>journalctl</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> journalctl -u cloudflared</span><br></pre></td></tr></table></figure><h3 id="访问站点"><a href="#访问站点" class="headerlink" title="访问站点"></a>访问站点</h3><p><code>cloudflared</code>启动后</p><p>打开网址 <code>memos.abc.com</code>，可看到我们已能成功访问到搭建的 memos 站点。</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Cloudflare </tag>
            
            <tag> Docker </tag>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Frp内网穿透服务端+客户端配置</title>
      <link href="/blog/2024/07/09/frp-nei-wang-chuan-tou-fu-wu-duan-ke-hu-duan-pei-zhi/"/>
      <url>/blog/2024/07/09/frp-nei-wang-chuan-tou-fu-wu-duan-ke-hu-duan-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h1 id="工作环境"><a href="#工作环境" class="headerlink" title="工作环境"></a>工作环境</h1><ul><li>具备公网 IP 的云服务器（Ubuntu22.04）</li><li>黑群晖DS918+</li><li>Google Chrome 126.0.6478.127</li><li>Frp v0.58.1</li><li>SSH工具</li></ul><p>FRP (Fast Reverse Proxy) 是一款高性能的内网穿透工具，<a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p><p>FRP 分为两部分：frps（FRP 服务器），frpc（FRP 客户端）。</p><p>frps 需要部署在有公网 IP 的服务器上，而 frpc 部署在内网中的机器。</p><h1 id="安装Frps（Frp服务器）"><a href="#安装Frps（Frp服务器）" class="headerlink" title="安装Frps（Frp服务器）"></a>安装Frps（Frp服务器）</h1><p>用SSH工具连上具备公网IP的云服务器，执行一键脚本需要<code>sudo -i</code>切换到root用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/mvscode/frps-onekey/master/install-frps.sh -O ./install-frps.sh</span><br><span class="line">chmod 700 ./install-frps.sh</span><br><span class="line">./install-frps.sh install</span><br></pre></td></tr></table></figure><p>接着脚本会让你依次设置各种端口，为了避免冲突，建议手动设置各个端口号.最终会出现一个汇总信息，如果没问题就继续即可安装完成。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">============== Check your input ==============</span><br><span class="line">You Server IP      : 你的公网IP</span><br><span class="line">Bind port          : 7000</span><br><span class="line">vhost http port    : 8800</span><br><span class="line">vhost https port   : 8443</span><br><span class="line">Dashboard port     : 8555</span><br><span class="line">Dashboard user     : admin</span><br><span class="line">Dashboard password : p@ssw0rd</span><br><span class="line">token              : sk-HMZUjKMPHHedvuxrhNmNoRIAxEnEGO</span><br><span class="line">subdomain_host     : 没有就填公网IP</span><br><span class="line">tcp mux            : true</span><br><span class="line">Max Pool count     : 5</span><br><span class="line">Log level          : info</span><br><span class="line">Log max days       : 3</span><br><span class="line">Log file           : frps.log</span><br><span class="line">transport protocol : enable</span><br><span class="line">kcp bind port      : 23043</span><br><span class="line">quic bind port     : 23045</span><br><span class="line">==============================================</span><br></pre></td></tr></table></figure><p>安装好后会自动运行frps，即可访问 IP + Dashboard port 端口号进入frps管理网页，http:&#x2F;&#x2F;你的公网IP:8555，输入设置的用户名和密码，能成功进入 WEB 后台就成功了。</p><p>常用命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Usage: /etc/init.d/frps &#123;start|stop|restart|status|config|version&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Uninstall（卸载）</span></span><br><span class="line">./install-frps.sh uninstall</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Update（更新）</span></span><br><span class="line">./install-frps.sh update</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="安装FRPC（Frp客户端）"><a href="#安装FRPC（Frp客户端）" class="headerlink" title="安装FRPC（Frp客户端）"></a>安装FRPC（Frp客户端）</h1><p><strong>frpc.toml</strong> 是 frp 客户端中重要的配置文件，错误的配置会导致服务无法访问，参考以下文档仔细修改每条参数。</p><p>配置模板:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">serverAddr = &quot;你的公网IP&quot; # frps 服务器地址</span><br><span class="line">serverPort = 7000 # frps 服务器端口</span><br><span class="line">auth.method = &quot;token&quot;</span><br><span class="line">auth.token = &quot;sk-HMZUjKMPHHedvuxrhNmNoRIAxEnEGO&quot; # frps 服务器token</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">穿透需要Web访问的内网服务，例如群晖的DSM管理页面</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当 <span class="built_in">type</span> = <span class="string">&quot;http&quot;</span> 或者 <span class="string">&quot;https&quot;</span> 协议时,</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">custom_domains 和 subdomain 至少需要任意一条参数，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以同时存在。如果没有此参数会导致 frp 客户端无法启动</span></span><br><span class="line"></span><br><span class="line">[[proxies]]</span><br><span class="line">name = &quot;DSM&quot; #该条穿透服务的名称，必须修改，且不能与其他用户重复</span><br><span class="line">type = &quot;http&quot;    </span><br><span class="line">localIp = &quot;192.168.50.2&quot; # 本地端口</span><br><span class="line">localPort = 5000 # 本地端口</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">customDomains = [<span class="string">&quot;192.168.50.2&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">subdomain = <span class="string">&quot;nas&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">穿透需要TCP连接的内网服务，例如 SSH的22端口或者Windows RDP的3389端口</span></span><br><span class="line">[[proxies]]</span><br><span class="line">name = &quot;SSH&quot;</span><br><span class="line">type = &quot;tcp&quot;</span><br><span class="line">localIp = &quot;192.168.50.2&quot;</span><br><span class="line">localPort = 22</span><br><span class="line">remotePort = 33078 # frps分配的端口，需要在防火墙中放行</span><br><span class="line"></span><br><span class="line">[[proxies]]</span><br><span class="line">name = &quot;RDP&quot;</span><br><span class="line">type = &quot;tcp&quot;</span><br><span class="line">localIp = &quot;192.168.50.2&quot;</span><br><span class="line">localPort = 3389</span><br><span class="line">remotePort = 33079  # frps分配的端口，需要在防火墙中放行</span><br></pre></td></tr></table></figure><blockquote><p><strong>重点提示：</strong>当 <strong>type &#x3D; tcp</strong> 时，无需配置上文的两条域名记录，可以直接使用 frp 服务器的地址作为域名，也可以将自己的域名 CNAME 或 A 记录 指向 frp 服务器的域名或 IP。</p></blockquote><p><strong>对于 Windows：</strong></p><ol><li><p>从<a href="https://github.com/fatedier/frp">官方 GitHub 仓库</a>下载  FRP 客户端</p></li><li><p>创建一个配置文件（例如 frpc.toml）并设置您的配置</p></li><li><p>使用 NSSM（Non-Sucking Service Manager）创建 Windows 服务： a. 从 <a href="https://nssm.cc/">https://nssm.cc/</a> 下载 NSSM b. 以管理员身份打开命令提示符 c. 导航到 NSSM 目录 d. 运行保存为<code>install.bat</code>并运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">: 1. download [nssm](https://github.com/kirillkovalenko/nssm) and set its diretory into the global PATH environment value</span><br><span class="line">: 2. replace the path below with where you placed frpc</span><br><span class="line">nssm install frpc &quot;D:\Tools\frpc\frpc.exe&quot; -c &quot;D:\Tools\frpc\frpc.toml&quot;</span><br><span class="line">nssm set frpc DisplayName &quot;frp client&quot;</span><br><span class="line">nssm start frpc</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>如果需要，使用 <code>nssm.exe edit FRPClient</code> 配置额外的服务参数</p></blockquote><ol start="4"><li><p>卸载服务，将代码保存为<code>uninstall.bat</code>并运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nssm stop frpc</span><br><span class="line">nssm remove frpc</span><br></pre></td></tr></table></figure></li></ol><p><strong>对于 Ubuntu&#x2F;Debian：</strong></p><ol><li><p>从官方 GitHub 仓库下载 Linux 版的 FRP 客户端。</p></li><li><p>解压文件并将它们移动到合适的位置，例如 &#x2F;usr&#x2F;local&#x2F;frp&#x2F;</p></li><li><p>创建一个配置文件（例如 &#x2F;usr&#x2F;local&#x2F;frp&#x2F;frpc.toml）并设置您的配置。</p></li><li><p>创建一个 systemd 服务文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/systemd/system/frpc.service</span><br></pre></td></tr></table></figure></li><li><p>在文件中添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   [Unit]</span><br><span class="line">   Description=FRP Client</span><br><span class="line">   After=network.target</span><br><span class="line">   </span><br><span class="line">   [Service]</span><br><span class="line">   Type=simple</span><br><span class="line">   User=nobody</span><br><span class="line">   Restart=on-failure</span><br><span class="line">   RestartSec=5s</span><br><span class="line">   ExecStart=/usr/local/frp/frpc -c /usr/local/frp/frpc.toml</span><br><span class="line">   </span><br><span class="line">   [Install]</span><br><span class="line">   WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">6. 保存文件并退出编辑器。</span><br><span class="line"></span><br><span class="line">7. 重新加载 systemd，启用并启动服务检查状态。</span><br><span class="line"></span><br><span class="line">   ```bash</span><br><span class="line">   <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">   <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> frpc</span><br><span class="line">   <span class="built_in">sudo</span> systemctl start frpc</span><br><span class="line">   <span class="built_in">sudo</span> systemctl status frpc</span><br></pre></td></tr></table></figure></li></ol><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://github.com/fatedier/frp/tree/dev">官方文档</a></p><p><a href="https://freefrp.net/docs">详解 frpc.toml 配置文件</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> docker-compose </tag>
            
            <tag> Frp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在 sudo 命令中保留特定环境变量</title>
      <link href="/blog/2024/07/06/ru-he-zai-sudo-ming-ling-zhong-bao-liu-te-ding-huan-jing-bian-liang/"/>
      <url>/blog/2024/07/06/ru-he-zai-sudo-ming-ling-zhong-bao-liu-te-ding-huan-jing-bian-liang/</url>
      
        <content type="html"><![CDATA[<p>今天在Ubuntu中执行<code>npm install -g hexo-cli</code>时，死活执行不成功。明明设置了当前用户的代理，哪怕在root和普通用户的环境变量中都设了代理，都不行，</p><p>我当前用户的**~&#x2F;.bashrc**是设置好了代理的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set proxy</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://proxy.example.com:8080</span><br><span class="line"><span class="built_in">export</span> https_proxy=https://proxy.example.com:8080</span><br><span class="line"><span class="built_in">export</span> no_proxy=<span class="string">&quot;localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure><p>解决方法是通过编辑 <code>/etc/sudoers</code> 文件来确保特定的环境变量在使用 <code>sudo</code> 时被保留。</p><p>以下是完整的操作步骤示例：</p><ol><li><p>为了安全起见，应该使用 <code>visudo</code> 命令来编辑 <code>/etc/sudoers</code> 文件。这是因为 <code>visudo</code> 会在保存文件之前检查语法，防止语法错误导致权限问题。</p></li><li><p>在打开的文件中添加或修改以下行：</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Defaults env_keep += <span class="string">&quot;http_proxy https_proxy no_proxy&quot;</span></span><br></pre></td></tr></table></figure><ol start="3"><li><p>保存并退出;</p><p>保存文件并退出编辑器。默认情况下，<code>visudo</code> 使用 <code>nano</code> 作为编辑器，你可以按 <code>Ctrl+X</code> 然后按 <code>Y</code> 并回车保存文件并退出。</p></li></ol><p>验证配置</p><p>使用 <code>sudo</code> 运行一个命令并检查环境变量是否被保留</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> -E <span class="built_in">env</span> | grep -E <span class="string">&#x27;http_proxy|https_proxy|no_proxy&#x27;</span></span><br></pre></td></tr></table></figure><p>你应该看到输出包含你设置的 <code>http_proxy</code>、<code>https_proxy</code> 和 <code>no_proxy</code> 的值。</p><p>再次执行<code>sudo npm install --unsafe-perm --verbose -g hexo-cli</code>顺利执行，问题解决！</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Hexo </tag>
            
            <tag> npm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pixel8保留Magisk进行OTA升级</title>
      <link href="/blog/2024/06/27/pixel8-bao-liu-magisk-jin-xing-ota-sheng-ji/"/>
      <url>/blog/2024/06/27/pixel8-bao-liu-magisk-jin-xing-ota-sheng-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="Pixel8保留Magisk进行OTA升级"><a href="#Pixel8保留Magisk进行OTA升级" class="headerlink" title="Pixel8保留Magisk进行OTA升级"></a>Pixel8保留Magisk进行OTA升级</h1><p>每月月初谷歌都会推送系统更新（OTA），更新的时候，会检测验证system分区是否完整，如果被修改，则会导致OTA失败，手机可能变“砖”。刷Magisk时修改了<code>boot.img</code>这个system分区的文件，所以刷Magisk后不能直接安装OTA更新。</p><h1 id="确认-A-B-系统分区支持状态"><a href="#确认-A-B-系统分区支持状态" class="headerlink" title="确认 A&#x2F;B 系统分区支持状态"></a>确认 A&#x2F;B 系统分区支持状态</h1><p>A&#x2F;B 系统分区是 Google 在 Android 7.0 时代引入的新机制，顾名思义，采用这个机制的设备拥有 A、B 两套系统分区，用户数据则能够在这两套系统分区之间共用。A&#x2F;B 分区同样也是安装了 Magisk 状态下进行无痛 OTA 系统更新的前提条件。</p><h2 id="验证支持系统更新的-A-B-分区"><a href="#验证支持系统更新的-A-B-分区" class="headerlink" title="验证支持系统更新的 A&#x2F;B 分区"></a>验证支持系统更新的 A&#x2F;B 分区</h2><p>执行adb shell命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb shell</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getprop ro.build.ab_update</span></span><br></pre></td></tr></table></figure><p>执行 getprop ro.build.ab_update 返回结果为 true 则表示你的设备采用了 A&#x2F;B 系统分区。</p><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h3 id="关闭-开发者设置中的系统自动更新"><a href="#关闭-开发者设置中的系统自动更新" class="headerlink" title="关闭  开发者设置中的系统自动更新"></a>关闭  开发者设置中的系统自动更新</h3><p>开发者设置 -&gt; 系统自动更新 -&gt; 关闭</p><h3 id="卸载Magisk"><a href="#卸载Magisk" class="headerlink" title="卸载Magisk"></a>卸载Magisk</h3><ol><li>打开应用 <code>magisk</code></li><li>点击<code>卸载Magisk</code></li><li>点击弹出窗口的<code>还原原厂映象</code></li></ol><blockquote><p>提示*<code>stock backup does not exist</code><em>或者</em><code>原厂镜像备份不存在</code>*</p></blockquote><h3 id="解决原厂镜像不存在的问题"><a href="#解决原厂镜像不存在的问题" class="headerlink" title="解决原厂镜像不存在的问题"></a>解决原厂镜像不存在的问题</h3><blockquote><p>如果还原成功则不需要进行这一步操作</p></blockquote><ol><li><p>打开应用<code>设置</code>-&gt;<code>关于手机</code>-&gt;<code>版本号</code></p><p>我这里的版本号UQ1A.240105.004</p></li><li><p>下载对应的镜像，找到对应<code>手机型号</code>对应的<code>版本号</code></p><p><a href="https://developers.google.com/android/images?hl=zh-cn#coral">下载地址</a></p><p>我这里的手机型号Pixel8，所有我下载的镜像应该是<code>shiba-uq1a.240105.004</code></p></li><li><p>解压<code>boot.img</code></p><p> 在下载好的压缩包找到 <code>image- 开头的压缩包</code> 再从这个<code>image-开头的压缩包</code>里面提取<code>boot.img</code></p></li><li><p>制作准备还原的<code>boot.img</code></p><p>在电脑上<code>push boot.img</code>到手机上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb push boot.img /sdcard/boot.img</span></span><br></pre></td></tr></table></figure><p>进入<code>adb shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb shell</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">su</span></span><br></pre></td></tr></table></figure><p>依次执行以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SHA1=$(<span class="built_in">cat</span> $(magisk --path)/.magisk/config | grep SHA1 | <span class="built_in">cut</span> -d <span class="string">&#x27;=&#x27;</span> -f 2)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gzip -9f /sdcard/boot.img</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /data/magisk_backup_<span class="variable">$&#123;SHA1&#125;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> /sdcard/boot.img.gz /data/magisk_backup_<span class="variable">$&#123;SHA1&#125;</span>/boot.img.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> -R 755 /data/magisk_backup_<span class="variable">$&#123;SHA1&#125;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chown</span> -R root.root /data/magisk_backup_<span class="variable">$&#123;SHA1&#125;</span></span></span><br></pre></td></tr></table></figure><p>上面的操作都成功了就可以了。</p></li></ol><h3 id="升级系统"><a href="#升级系统" class="headerlink" title="升级系统"></a>升级系统</h3><p>再次尝试升级系统，如果这个时候还是报升级失败的话，只能重启系统后再升级，但是如果可以直接升级了就直接升级，升级完成之后<em><strong>千万别重启</strong></em>。</p><h3 id="升级系统后不重启安装Magisk"><a href="#升级系统后不重启安装Magisk" class="headerlink" title="升级系统后不重启安装Magisk"></a>升级系统后不重启安装Magisk</h3><p>打开应用<code>Magisk</code>-&gt;安装Magisk-&gt;安装到未使用的槽位(OTA后)，完成后重启。</p><h3 id="卸载Magisk还是不能升级系统"><a href="#卸载Magisk还是不能升级系统" class="headerlink" title="卸载Magisk还是不能升级系统"></a>卸载Magisk还是不能升级系统</h3><blockquote><p>以下步骤其实就是重新刷入Magisk，此步骤需要在打开 USB 调试后将手机与电脑相连。</p></blockquote><ol><li><p>重启手机</p></li><li><p>进入系统后打开应用<code>Magisk</code>确认一下Magisk是否安装，如果未安装可以进行以下步骤。</p><p> <img src="https://s2.loli.net/2024/09/02/JP8CR16lkcvQdNx.png" alt="img"></p><p> <strong>Ramdisk</strong>的结果决定了您的设备启动分区中是否有ramdisk。</p><p> 如果您的设备有启动 ramdisk，请获取<code>boot.img</code>的副本（或<code>init_boot.img</code> ，如果存在）。</p><p> 如果您的设备<strong>没有</strong>启动 ramdisk，请获取<code>recovery.img</code>的副本。</p><p> 相对应的，请使用：</p><p> <code>fastboot flash boot /path/to/magisk_patched_xxx.img</code></p><p> <code>fastboot flash init_boot /path/to/magisk_patched_xxx.img</code></p><p> <code>fastboot flash recovery /path/to/magisk_patched_xxx.img</code>。</p><p> 使用哪个img制作的patched需要刷入到对应分区。</p></li><li><p>直接点击升级系统，等待升级完成，重启系统。</p></li><li><p>下载新系统对应的镜像</p><p>打开应用<code>设置</code>-&gt;<code>关于手机</code>-&gt;<code>版本号</code></p><p>下载对应的镜像，找到对应<code>手机型号</code>对应的<code>版本号</code></p><p><a href="https://developers.google.com/android/images?hl=zh-cn#coral">下载地址</a></p></li><li><p>解压出boot.img </p></li><li><p>上传boot.img到手机</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb push boot.img /sdcard/Download/boot.img</span></span><br></pre></td></tr></table></figure></li><li><p>打开<code>Magisk Manager</code> 安装程序</p></li><li><p>制作Magisk镜像并安装</p><p>依次点击<code>安装</code>-&gt; <code>选择并修补一个文件</code>-&gt; 刚刚push到手机上的boot.img 等待执行完成会告诉你文件名</p></li><li><p>pull制作好的Magisk镜像到电脑上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb pull /sdcard/Download/magisk_pathced_xxx.img ./</span></span><br></pre></td></tr></table></figure></li><li><p>在电脑上刷入magisk</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb reboot bootloader</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fastboot flash boot /xx/xx/magisk_pathced_xxx.img</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fastboot reboot</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="执行fastboot一直wait-device的解决办法"><a href="#执行fastboot一直wait-device的解决办法" class="headerlink" title="执行fastboot一直wait device的解决办法"></a>执行fastboot一直wait device的解决办法</h3><p>下载安装usb驱动即可。</p><ol><li>下载驱动<a href="https://dl-ssl.google.com/android/repository/latest_usb_driver_windows.zip">latest_usb_driver_windows</a></li><li>解压到文件</li><li>打开 <code>设备管理器</code> -&gt; <code>操作</code> -&gt; <code>添加驱动程序</code></li><li>选择刚刚解压的usb驱动文件夹确认安装即可。</li><li>再次执行<code>fastboot flash boot</code>命令。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Pixel8 </tag>
            
            <tag> Magisk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Tailscale+自建DERP组建私有局域网</title>
      <link href="/blog/2024/06/18/shi-yong-tailscale-zi-jian-derp-zu-jian-si-you-ju-yu-wang/"/>
      <url>/blog/2024/06/18/shi-yong-tailscale-zi-jian-derp-zu-jian-si-you-ju-yu-wang/</url>
      
        <content type="html"><![CDATA[<p>Tailscale属于一种虚拟组网工具，基于WireGuard。</p><h1 id="注册Tailscale帐号"><a href="#注册Tailscale帐号" class="headerlink" title="注册Tailscale帐号"></a>注册Tailscale帐号</h1><p><strong><a href="https://tailscale.com/">Tailscale官网 https://tailscale.com/</a></strong></p><h1 id="下载客户端"><a href="#下载客户端" class="headerlink" title="下载客户端"></a>下载客户端</h1><p><strong><a href="https://tailscale.com/download/">Tailscale客户端 https://tailscale.com/download/</a></strong></p><p><img src="https://s2.loli.net/2024/06/27/yFap9dfmCGIjswN.png"></p><p><strong>安装并完成登录</strong></p><h1 id="连接起来"><a href="#连接起来" class="headerlink" title="连接起来"></a>连接起来</h1><p>一旦你的设备都装上了Tailscale，它们就像是在一个无形的网里，只属于你的。这时，你的电脑、手机、甚至是那台老旧的平板，都能在这个网络中自由通行，无需那些烦人的防火墙的阻挡。</p><blockquote><p>以上是理想情况，打洞成功与否看各个客户端的网络环境。一般情况打洞成功率比较高，比如手机网络，有IPv6地址的网络。 一般不行：公司有防火墙。 打洞不成功就需要中转节点，客户端之间通过中转连接。那么，你懂的，这些中转节点都在国外，为了提高网络速度，最好自建国内的DERP节点。</p></blockquote><h1 id="架起你的灯塔"><a href="#架起你的灯塔" class="headerlink" title="架起你的灯塔"></a>架起你的灯塔</h1><p>自建DERP服务器。听起来高大上对吧？其实就是让你在这个网络里有自己的标志物，像是海盗的旗帜一样，让你的小伙伴们都能找到你。搭建DERP简单的一行命令（一般人没有备案域名吧）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart always --net host --name derper -d ghcr.io/yangchuansheng/ip_derper:latest </span><br></pre></td></tr></table></figure><blockquote><p>需要开放防火墙端口或者安全策略，以阿里云为例，添加<strong>12345&#x2F;tcp</strong>和<strong>3478&#x2F;udp</strong>安全策略</p></blockquote><h1 id="自由畅游"><a href="#自由畅游" class="headerlink" title="自由畅游"></a>自由畅游</h1><p>配置ACL</p><p><img src="https://s2.loli.net/2024/06/27/jvMTJOYIFUCPyqg.png"></p><p>输入配置信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;derpMap&quot;: &#123;</span><br><span class="line">&quot;OmitDefaultRegions&quot;: false, // 可以设置为 true，这样不会下发官方的 derper 节点，测试或者实际使用都可以考虑打开</span><br><span class="line">&quot;Regions&quot;: &#123;</span><br><span class="line">&quot;900&quot;: &#123;</span><br><span class="line">&quot;RegionID&quot;:   900, // tailscale 900-999 是保留给自定义 derper 的</span><br><span class="line">&quot;RegionCode&quot;: &quot;you region code&quot;,</span><br><span class="line">&quot;RegionName&quot;: &quot;you region code&quot;,</span><br><span class="line">&quot;Nodes&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">&quot;Name&quot;:     &quot;vps-1&quot;,</span><br><span class="line">&quot;RegionID&quot;: 900,</span><br><span class="line">&quot;IPv4&quot;:     &quot;xxx.xxx.xxx.xxx&quot;, # 你的VPS 公网IP地址</span><br><span class="line">// &quot;DERPPort&quot;:         4430,</span><br><span class="line">&quot;InsecureForTests&quot;: true, // 因为是自签名证书，所以客户端不做校验</span><br><span class="line">&#125;,</span><br><span class="line">],</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在，不管是在家里，公司，还是在世界的另一端，只要你的设备一连上Tailscale，那么，恭喜你，你就进入了自己的秘密花园。在这里，没有限制，只有自由。</p><p><img src="https://s2.loli.net/2024/06/27/SlhbuQkzAHUOGse.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.xiaoiluo.com/article/tailscale-derp">https://www.xiaoiluo.com/article/tailscale-derp</a></p><p><a href="https://icloudnative.io/posts/custom-derp-servers/">https://icloudnative.io/posts/custom-derp-servers/</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Tailscale </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux中安装配置docker管理器Portainer&amp;Portainer升级版本</title>
      <link href="/blog/2024/04/19/linux-zhong-an-zhuang-pei-zhi-docker-guan-li-qi-portainer-portainer-sheng-ji-ban-ben/"/>
      <url>/blog/2024/04/19/linux-zhong-an-zhuang-pei-zhi-docker-guan-li-qi-portainer-portainer-sheng-ji-ban-ben/</url>
      
        <content type="html"><![CDATA[<h1 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull portainer/portainer-ce</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker volume create portainer_data</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span></span><br></pre></td></tr></table></figure><ul><li>打开浏览器，输入<code>http://localhost:9000</code>）或者<code>http://&#123;服务器ip&#125;:9000</code>；</li><li>设置用户名和密码后进入</li></ul><h1 id="Portainer升级版本"><a href="#Portainer升级版本" class="headerlink" title="Portainer升级版本"></a>Portainer升级版本</h1><p> 在 Portainer 安装时候是指定了数据卷的，这样一来，更新 Portainer 只需要下载新的 Portainer 的镜像，删除原有容器即可，原先的记录信息都在数据卷中。</p><p>1.关闭容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker stop portainer的容器名或容器Id</span></span><br></pre></td></tr></table></figure><p>2.删除容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">rm</span> portainer的容器名或容器<span class="built_in">id</span></span></span><br></pre></td></tr></table></figure><p>3.确定下容器是否已经删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a</span></span><br></pre></td></tr></table></figure><p>4.删除镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker rmi portainer的镜像名或镜像Id</span></span><br></pre></td></tr></table></figure><p>5.拉取新版本镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull portainer/portainer-ce</span></span><br></pre></td></tr></table></figure><p>6.启动镜像，打开浏览器输入原有帐号密码即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span></span><br></pre></td></tr></table></figure><p>Portainer升级版本完整的操作日志记录</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">ubuntu@ubuntu:~$docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                          COMMAND                  CREATED        STATUS                  PORTS                                                                                                                NAMES</span><br><span class="line">fc281d660e7e   portainer/portainer-ce            <span class="string">&quot;/portainer&quot;</span>             2 weeks ago    Up 22 hours             8000/tcp, 9443/tcp, 0.0.0.0:9000-&gt;9000/tcp, :::9000-&gt;9000/tcp                                              portainer</span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker stop fc281d660e7e</span></span><br><span class="line">fc281d660e7e</span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                          COMMAND                  CREATED        STATUS                          PORTS                                                                                                      NAMES</span><br><span class="line">fc281d660e7e   portainer/portainer-ce            <span class="string">&quot;/portainer&quot;</span>             2 weeks ago    Exited (2) About a minute ago                                                                                                              portainer</span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker rm fc281d660e7e</span></span><br><span class="line">fc281d660e7e</span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker images</span></span><br><span class="line">REPOSITORY                TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">portainer/portainer-ce       latest    9281e1907542   17 months ago   278MB</span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker rmi  9281e1907542</span></span><br><span class="line"><span class="section">Untagged: portainer/portainer-ce:latest</span></span><br><span class="line"><span class="section">Untagged: portainer/portainer-ce@sha256:47b064434edf437badf7337e516e07f64477485c8ecc663ddabbe824b20c672d</span></span><br><span class="line"><span class="section">Deleted: sha256:9281e1907542d9e135476db62e7dd129a95972dc5cd297f5d01acff58c4f751f</span></span><br><span class="line"><span class="section">Deleted: sha256:067f72a72d633747ba5a6039a1b4ec3d36555fa22a07f6e5c3be2940d4d040cc</span></span><br><span class="line"><span class="section">Deleted: sha256:f6fe101531bcf0e63b651a4e3ce2676c1a7f1880288bb288ede04fc1deb1a8a1</span></span><br><span class="line"><span class="section">Deleted: sha256:e0a46f5d05e1b93a7993c45aaea39729d111d7a096e02ac1656c721e39cb5222</span></span><br><span class="line"><span class="section">Deleted: sha256:8c004456aeb58b75f792fa091b194c20d6ed4f0d95dd25b0150d71c5c9ab601b</span></span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker pull portainer/portainer-ce</span></span><br><span class="line">Using default tag: latest</span><br><span class="line"><span class="section">latest: Pulling from portainer/portainer-ce</span></span><br><span class="line"><span class="section">57654d40e0a5: Pull complete</span></span><br><span class="line"><span class="section">1f476acfabd6: Pull complete</span></span><br><span class="line"><span class="section">23f2184d3136: Pull complete</span></span><br><span class="line"><span class="section">e21d017187f1: Pull complete</span></span><br><span class="line"><span class="section">bfa9cfee4c8e: Pull complete</span></span><br><span class="line"><span class="section">9d8366b4fa62: Pull complete</span></span><br><span class="line"><span class="section">d55f4e10dc55: Pull complete</span></span><br><span class="line"><span class="section">5230628c9a1d: Pull complete</span></span><br><span class="line"><span class="section">dd27a37dee51: Pull complete</span></span><br><span class="line"><span class="section">5cc1bbad4ed2: Pull complete</span></span><br><span class="line"><span class="section">4f4fb700ef54: Pull complete</span></span><br><span class="line"><span class="section">Digest: sha256:4a1ceadd7f7898d9190ee0a6d22234c4323aefd80e796e84f5e57127f74370f1</span></span><br><span class="line"><span class="section">Status: Downloaded newer image for portainer/portainer-ce:latest</span></span><br><span class="line"><span class="section">docker.io/portainer/portainer-ce:latest</span></span><br><span class="line"><span class="section">ubuntu@ubuntu:~$ docker run -d -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span></span><br><span class="line">d6e582a7f0646ae628e15b4ee9a69f85c276d29b78cc23636b219d0f65b82f89</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Portainer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android中下载文件到SD卡的Download文件夹</title>
      <link href="/blog/2024/03/24/android-zhong-xia-zai-wen-jian-dao-sd-qia-de-download-wen-jian-jia/"/>
      <url>/blog/2024/03/24/android-zhong-xia-zai-wen-jian-dao-sd-qia-de-download-wen-jian-jia/</url>
      
        <content type="html"><![CDATA[<h1 id="存储空间"><a href="#存储空间" class="headerlink" title="存储空间"></a>存储空间</h1><p>应用保存数据的方式：</p><ul><li><strong>应用专属存储空间</strong>：存储仅供应用使用的文件，可以存储到内部存储卷中的专属目录或外部存储空间中的其他专属目录。使用内部存储空间中的目录保存其他应用不应访问的敏感信息。</li><li><strong>共享存储</strong>：存储您的应用打算与其他应用共享的文件，包括媒体、文档和其他文件。</li><li><strong>偏好设置</strong>：以键值对形式通过SharePreference存储私有原始数据。</li><li><strong>数据库</strong>：使用 Room 持久性库将结构化数据存储在Sqlite数据库中。</li></ul><p>下表汇总了这些选项的特点：</p><table><thead><tr><th></th><th>内容类型</th><th>访问方法</th><th>所需权限</th><th>其他应用是否可以访问？</th><th>卸载应用时是否移除文件？</th></tr></thead><tbody><tr><td><a href="https://developer.android.com/training/data-storage/app-specific?hl=zh-cn">应用专属文件</a></td><td>仅供您的应用使用的文件</td><td>- 从内部存储空间访问，可以使用 <code>getFilesDir()</code> 或 <code>getCacheDir()</code> 方法 ；- 从外部存储空间访问，可以使用 <code>getExternalFilesDir()</code> 或 <code>getExternalCacheDir()</code> 方法</td><td>从内部存储空间访问不需要任何权限；如果应用在搭载 Android 4.4（API 级别 19）或更高版本的设备上运行，从外部存储空间访问不需要任何权限</td><td>否</td><td>是</td></tr><tr><td><a href="https://developer.android.com/training/data-storage/shared/media?hl=zh-cn">媒体</a></td><td>可共享的媒体文件（图片、音频文件、视频）</td><td><code>MediaStore</code> API</td><td>在 Android 11（API 级别 30）或更高版本中，访问其他应用的文件需要 <code>READ_EXTERNAL_STORAGE</code>；在 Android 10（API 级别 29）中，访问其他应用的文件需要 <code>READ_EXTERNAL_STORAGE</code> 或 <code>WRITE_EXTERNAL_STORAGE</code>；在 Android 9（API 级别 28）或更低版本中，访问<strong>所有</strong>文件均需要相关权限</td><td>是，但其他应用需要 <code>READ_EXTERNAL_STORAGE</code> 权限</td><td>否</td></tr><tr><td><a href="https://developer.android.com/training/data-storage/shared/documents-files?hl=zh-cn">文档和其他文件</a></td><td>其他类型的可共享内容，包括已下载的文件</td><td>存储访问框架SAF</td><td>无</td><td>是，可以通过系统文件选择器访问</td><td>否</td></tr><tr><td><a href="https://developer.android.com/training/data-storage/shared-preferences?hl=zh-cn">应用偏好设置</a></td><td>键值对</td><td><a href="https://developer.android.com/guide/topics/ui/settings/use-saved-values?hl=zh-cn">Jetpack Preferences</a> 库</td><td>无</td><td>否</td><td>是</td></tr><tr><td>数据库</td><td>结构化数据</td><td><a href="https://developer.android.com/training/data-storage/room?hl=zh-cn">Room</a> 持久性库</td><td>无</td><td>否</td><td>否</td></tr></tbody></table><p><strong>外部存储</strong></p><p>以前的手机是存在SDcard的，但目前很多手机都取消了SDcard,Android上引入了映射机制来创建虚拟的SDcard,我们通过文件管理器看到的路径<code>storage/emulated/0</code>就是虚拟SDcard，也就是我们俗称的“外部存储空间”或者“公共存储空间”<strong>app申请的读写权限请求都是申请的外部存储空间权限</strong></p><p><strong>内部存储</strong></p><p>内存存储也就是本app的专属目录，其他app是无法访问的，适合存储敏感文件。<br>通过系统api访问到的路径：&#x2F;data&#x2F;user&#x2F;0&#x2F;app_packageName&#x2F;…<br>对应的真实目录：&#x2F;data&#x2F;date&#x2F;app_packageName&#x2F;…</p><p><strong>分区存储</strong></p><p>分区存储实际上就是外部存储空间中建一个app对应目录，本app无须申请权限就可以访问，如果申请读写权限，意味着申请外部空间所有访问权限,在Android10之前，分区存储目录是有可能被其他app访问到的。从Android11开始，其他app是无法访问的，也称之为沙盒模式。</p><h1 id="权限的变化"><a href="#权限的变化" class="headerlink" title="权限的变化"></a>权限的变化</h1><p><strong>Android 5.0 存储访问框架（SAF）</strong>：引入了存储访问框架，用于提供一种更加安全和细粒度的文件访问方式。通过 SAF，用户可以选择授予应用访问特定文件或目录的权限。</p><p><strong>Android 6.0 运行时权限</strong>：引入了运行时权限模型，应用需要在运行时动态请求存储权限，而不是在安装时获得。这进一步提高了用户的控制权。</p><p><strong>Android 7.0 File URI 限制</strong>：文件URI被限制，应用不能直接通过<code>file://</code>访问其他应用的文件，必须使用<code>ContentProvider</code>来共享文件。</p><p><strong>Android 10</strong></p><p><strong>分区存储（Scoped Storage）</strong>：引入了分区存储，限制了应用对外部存储的访问。应用只能访问自己的应用专属目录和一些特定的公共目录（如<code>Download</code>、<code>Pictures</code>等）。</p><p>媒体文件访问权限：应用可以通过特定的媒体存储API访问和操作媒体文件（如图片、音频、视频），而不需要全局存储权限。</p><p><strong>Android 11</strong></p><p>进一步收紧分区存储：分区存储变得更加严格，应用对外部存储的访问进一步受限。</p><p><strong>MANAGE_EXTERNAL_STORAGE 权限</strong>：该权限提供对应用专属目录和 <code>MediaStore</code> 之外文件的写入权限。引入了新的权限，允许某些应用访问所有的外部存储文件，但这个权限的使用受到严格限制，需要通过Google Play审核。</p><p>媒体存储访问权限：应用可以请求访问特定类型的媒体文件，更加细粒度的访问控制。</p><p><strong>Android 12</strong></p><p>特定作用域的媒体访问：为不同类型的媒体文件提供更细致的访问控制，实现了更细粒度的权限管理。</p><p><strong>Android 13</strong> 与<strong>Android 14</strong> 倒是没有对权限进行大的改动，目前已经趋于稳定。</p><h1 id="下载文件到SD卡的Download文件夹"><a href="#下载文件到SD卡的Download文件夹" class="headerlink" title="下载文件到SD卡的Download文件夹"></a>下载文件到SD卡的Download文件夹</h1><h2 id="方案一：申请权限写入"><a href="#方案一：申请权限写入" class="headerlink" title="方案一：申请权限写入"></a>方案一：申请权限写入</h2><p>需要在AndroidManifest.xml中添加以下权限：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">android:maxSdkVersion</span>=<span class="string">&quot;28&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>对于Android 10（API 29）及以上版本：</p><ul><li>使用MediaStore API来创建文件。</li><li>使用ContentResolver来获取输出流并写入文件。</li></ul><p>对于Android 9（API 28）及以下版本：</p><ul><li>直接使用File API在Download目录创建文件。</li><li>使用FileOutputStream写入文件。</li></ul><p>使用线程进行网络操作和文件写入，避免阻塞主线程。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.ContentValues</span><br><span class="line"><span class="keyword">import</span> android.net.Uri</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Environment</span><br><span class="line"><span class="keyword">import</span> android.provider.MediaStore</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">downloadFile</span><span class="params">(url: <span class="type">String</span>, fileName: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> thread = Thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> connection = URL(url).openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connect()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (connection.responseCode != HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@Thread</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> inputStream: InputStream = connection.inputStream</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">                    <span class="comment">// Android 10及以上版本</span></span><br><span class="line">                    <span class="keyword">val</span> contentValues = ContentValues().apply &#123;</span><br><span class="line">                        put(MediaStore.Downloads.DISPLAY_NAME, fileName)</span><br><span class="line">                        put(MediaStore.Downloads.MIME_TYPE, <span class="string">&quot;application/octet-stream&quot;</span>)</span><br><span class="line">                        put(MediaStore.Downloads.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">val</span> resolver = contentResolver</span><br><span class="line">                    <span class="keyword">val</span> uri = resolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)</span><br><span class="line">                    <span class="keyword">if</span> (uri != <span class="literal">null</span>) &#123;</span><br><span class="line">                        resolver.openOutputStream(uri)?.use &#123; outputStream -&gt;</span><br><span class="line">                            inputStream.copyTo(outputStream)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Android 9及以下版本</span></span><br><span class="line">                    <span class="keyword">val</span> downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">                    <span class="keyword">val</span> file = File(downloadsDir, fileName)</span><br><span class="line">                    FileOutputStream(file).use &#123; outputStream -&gt;</span><br><span class="line">                        inputStream.copyTo(outputStream)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                inputStream.close()</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        thread.start()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，WRITE_EXTERNAL_STORAGE权限只在API 28及以下版本需要。对于API 29+，我们使用MediaStore API，不需要这个权限。<br>最后，记得在运行时请求WRITE_EXTERNAL_STORAGE权限（对于Android 6.0到Android 9.0）。</p></blockquote><h2 id="方案二：无需权限SAF选择目录写入"><a href="#方案二：无需权限SAF选择目录写入" class="headerlink" title="方案二：无需权限SAF选择目录写入"></a>方案二：无需权限SAF选择目录写入</h2><p>通过 Storage Access Framework (SAF) 先获取一个目录的 URI使用 DocumentFile 来实现文件下载。</p><p>这个方法的优点包括：</p><ol><li>兼容性好：适用于所有 Android 版本。</li><li>支持可移动存储：用户可以选择 SD 卡上的目录。</li><li>无需特殊权限：不需要 WRITE_EXTERNAL_STORAGE 权限。</li><li>用户友好：用户可以选择他们想要保存文件的位置。</li></ol><p>使用这种方法时，需要注意以下几点：</p><ol><li>需要用户选择一个目录，这可能会增加一些用户交互。</li><li>你需要保存用户选择的目录 URI，以便在后续的下载中重用。</li><li>对于大文件，你可能需要考虑添加进度回调和取消功能。</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Environment</span><br><span class="line"><span class="keyword">import</span> androidx.documentfile.provider.DocumentFile</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DocumentFileDownloader</span>(<span class="keyword">private</span> <span class="keyword">val</span> context: Context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">downloadFile</span><span class="params">(url: <span class="type">String</span>, fileName: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        Thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> file = getOrCreateFile(fileName)</span><br><span class="line">                <span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">                    println(<span class="string">&quot;Could not create or access file&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@Thread</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开连接并下载</span></span><br><span class="line">                <span class="keyword">val</span> connection = URL(url).openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connect()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (connection.responseCode != HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> Exception(<span class="string">&quot;Server returned HTTP <span class="subst">$&#123;connection.responseCode&#125;</span>&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开输入流和输出流</span></span><br><span class="line">                <span class="keyword">val</span> inputStream = BufferedInputStream(connection.inputStream)</span><br><span class="line">                <span class="keyword">val</span> outputStream = BufferedOutputStream(context.contentResolver.openOutputStream(file.uri))</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 复制数据</span></span><br><span class="line">                <span class="keyword">val</span> buffer = ByteArray(<span class="number">8192</span>)</span><br><span class="line">                <span class="keyword">var</span> bytesRead: <span class="built_in">Int</span></span><br><span class="line">                <span class="keyword">while</span> (inputStream.read(buffer).also &#123; bytesRead = it &#125; != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(buffer, <span class="number">0</span>, bytesRead)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 关闭流</span></span><br><span class="line">                outputStream.flush()</span><br><span class="line">                outputStream.close()</span><br><span class="line">                inputStream.close()</span><br><span class="line"></span><br><span class="line">                println(<span class="string">&quot;File downloaded successfully: <span class="subst">$&#123;file.uri&#125;</span>&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getOrCreateFile</span><span class="params">(fileName: <span class="type">String</span>)</span></span>: DocumentFile? &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">            <span class="comment">// Android 10 及以上版本</span></span><br><span class="line">            <span class="keyword">val</span> downloadsDir = DocumentFile.fromTreeUri(context, </span><br><span class="line">                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS).toUri())</span><br><span class="line">            downloadsDir?.createFile(<span class="string">&quot;application/octet-stream&quot;</span>, fileName)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Android 9 及以下版本</span></span><br><span class="line">            <span class="keyword">val</span> downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">            <span class="keyword">val</span> file = File(downloadsDir, fileName)</span><br><span class="line">            DocumentFile.fromFile(file)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如何使用这个下载器的示例：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> downloader: DocumentFileDownloader</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> directoryUri: Uri? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        downloader = DocumentFileDownloader(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 假设你有一个按钮来触发文件选择</span></span><br><span class="line">        findViewById&lt;Button&gt;(R.id.selectFolderButton).setOnClickListener &#123;</span><br><span class="line">            selectFolder()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 假设你有一个按钮来触发下载</span></span><br><span class="line">        findViewById&lt;Button&gt;(R.id.downloadButton).setOnClickListener &#123;</span><br><span class="line">            directoryUri?.let &#123;</span><br><span class="line">                downloader.downloadFile(</span><br><span class="line">                    <span class="string">&quot;https://example.com/file.zip&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;downloaded_file.zip&quot;</span>,</span><br><span class="line">                    it</span><br><span class="line">                )</span><br><span class="line">            &#125; ?: run &#123;</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Please select a folder first&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">selectFolder</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> intent = Intent(Intent.ACTION_OPEN_DOCUMENT_TREE)</span><br><span class="line">        startActivityForResult(intent, OPEN_DIRECTORY_REQUEST_CODE)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">        <span class="keyword">if</span> (requestCode == OPEN_DIRECTORY_REQUEST_CODE &amp;&amp; resultCode == Activity.RESULT_OK) &#123;</span><br><span class="line">            <span class="keyword">data</span>?.<span class="keyword">data</span>?.let &#123; uri -&gt;</span><br><span class="line">                contentResolver.takePersistableUriPermission(</span><br><span class="line">                    uri,</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br><span class="line">                )</span><br><span class="line">                directoryUri = uri</span><br><span class="line">                <span class="comment">// 可以保存这个 URI 以便后续使用</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> OPEN_DIRECTORY_REQUEST_CODE = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="方案三：无需权限无需选择目录-DocumentFile-API写入"><a href="#方案三：无需权限无需选择目录-DocumentFile-API写入" class="headerlink" title="方案三：无需权限无需选择目录 DocumentFile API写入"></a>方案三：无需权限无需选择目录 DocumentFile API写入</h2><p>希望使用 DocumentFile API 直接创建指定的文件，而不需要用户选择目录。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Environment</span><br><span class="line"><span class="keyword">import</span> androidx.documentfile.provider.DocumentFile</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DocumentFileDownloader</span>(<span class="keyword">private</span> <span class="keyword">val</span> context: Context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">downloadFile</span><span class="params">(url: <span class="type">String</span>, fileName: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        Thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> file = getOrCreateFile(fileName)</span><br><span class="line">                <span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">                    println(<span class="string">&quot;Could not create or access file&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@Thread</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开连接并下载</span></span><br><span class="line">                <span class="keyword">val</span> connection = URL(url).openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connect()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (connection.responseCode != HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> Exception(<span class="string">&quot;Server returned HTTP <span class="subst">$&#123;connection.responseCode&#125;</span>&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开输入流和输出流</span></span><br><span class="line">                <span class="keyword">val</span> inputStream = BufferedInputStream(connection.inputStream)</span><br><span class="line">                <span class="keyword">val</span> outputStream = BufferedOutputStream(context.contentResolver.openOutputStream(file.uri))</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 复制数据</span></span><br><span class="line">                <span class="keyword">val</span> buffer = ByteArray(<span class="number">8192</span>)</span><br><span class="line">                <span class="keyword">var</span> bytesRead: <span class="built_in">Int</span></span><br><span class="line">                <span class="keyword">while</span> (inputStream.read(buffer).also &#123; bytesRead = it &#125; != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(buffer, <span class="number">0</span>, bytesRead)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 关闭流</span></span><br><span class="line">                outputStream.flush()</span><br><span class="line">                outputStream.close()</span><br><span class="line">                inputStream.close()</span><br><span class="line"></span><br><span class="line">                println(<span class="string">&quot;File downloaded successfully: <span class="subst">$&#123;file.uri&#125;</span>&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getOrCreateFile</span><span class="params">(fileName: <span class="type">String</span>)</span></span>: DocumentFile? &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">            <span class="comment">// Android 10 及以上版本</span></span><br><span class="line">            <span class="keyword">val</span> downloadsDir = DocumentFile.fromTreeUri(context, </span><br><span class="line">                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS).toUri())</span><br><span class="line">            downloadsDir?.createFile(<span class="string">&quot;application/octet-stream&quot;</span>, fileName)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Android 9 及以下版本</span></span><br><span class="line">            <span class="keyword">val</span> downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">            <span class="keyword">val</span> file = File(downloadsDir, fileName)</span><br><span class="line">            DocumentFile.fromFile(file)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个实现有以下几个特点：</p><ol><li>它直接使用公共下载目录，不需要用户选择目录。</li><li>对于 Android 10 及以上版本，它使用 DocumentFile API 来创建文件。</li><li>对于 Android 9 及以下版本，它直接在下载目录创建文件，然后将其包装为 DocumentFile。</li></ol><p>使用这个下载器的方式如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> downloader: DocumentFileDownloader</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        downloader = DocumentFileDownloader(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">        findViewById&lt;Button&gt;(R.id.downloadButton).setOnClickListener &#123;</span><br><span class="line">            downloader.downloadFile(</span><br><span class="line">                <span class="string">&quot;https://example.com/file.zip&quot;</span>,</span><br><span class="line">                <span class="string">&quot;downloaded_file.zip&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是：</p><ol><li><p>对于 Android 9 及以下版本，你仍然需要 WRITE_EXTERNAL_STORAGE 权限。你可以在 AndroidManifest.xml 中这样声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">android:maxSdkVersion</span>=<span class="string">&quot;28&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>对于 Android 6.0 到 Android 9.0，你需要在运行时请求 WRITE_EXTERNAL_STORAGE 权限。</p></li><li><p>这种方法在 Android 10 及以上版本不需要特殊权限，因为它使用了 MediaStore API 来访问下载目录。</p></li><li><p>如果你的应用目标 SDK 是 Android 10 或更高，并且你想要访问应用专用目录之外的文件，你可能需要在 AndroidManifest.xml 中添加 <code>android:requestLegacyExternalStorage=&quot;true&quot;</code>。但请注意，这只是一个临时解决方案，在 Android 11 及以上版本中不再有效。</p></li></ol><p>关于<strong>DocumentFile</strong> 和<strong>权限</strong>的情况:</p><p>Android 10（API 29）及以上：</p><ul><li>使用 DocumentFile 访问应用专属目录或通过 SAF（Storage Access Framework）访问的目录时，不需要额外的存储权限。</li><li>对于下载目录等公共目录，也不需要 WRITE_EXTERNAL_STORAGE 权限。</li></ul><p>Android 9（API 28）及以下：</p><ul><li>如果使用 DocumentFile.fromFile() 来访问外部存储上的文件，仍然需要 WRITE_EXTERNAL_STORAGE 权限。</li></ul><p>考虑到这一点，我们可以优化之前的代码，使其在<strong>所有 Android 版本上都不需要请求 WRITE_EXTERNAL_STORAGE 权限</strong>。我们可以使用 MediaStore API 来实现这一点:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.ContentValues</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.net.Uri</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Environment</span><br><span class="line"><span class="keyword">import</span> android.provider.MediaStore</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileDownloader</span>(<span class="keyword">private</span> <span class="keyword">val</span> context: Context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">downloadFile</span><span class="params">(url: <span class="type">String</span>, fileName: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        Thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> uri = getOutputUri(fileName)</span><br><span class="line">                <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">                    println(<span class="string">&quot;Could not create output URI&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@Thread</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开连接并下载</span></span><br><span class="line">                <span class="keyword">val</span> connection = URL(url).openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connect()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (connection.responseCode != HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> Exception(<span class="string">&quot;Server returned HTTP <span class="subst">$&#123;connection.responseCode&#125;</span>&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打开输入流和输出流</span></span><br><span class="line">                <span class="keyword">val</span> inputStream = BufferedInputStream(connection.inputStream)</span><br><span class="line">                <span class="keyword">val</span> outputStream = BufferedOutputStream(context.contentResolver.openOutputStream(uri))</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 复制数据</span></span><br><span class="line">                <span class="keyword">val</span> buffer = ByteArray(<span class="number">8192</span>)</span><br><span class="line">                <span class="keyword">var</span> bytesRead: <span class="built_in">Int</span></span><br><span class="line">                <span class="keyword">while</span> (inputStream.read(buffer).also &#123; bytesRead = it &#125; != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(buffer, <span class="number">0</span>, bytesRead)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 关闭流</span></span><br><span class="line">                outputStream.flush()</span><br><span class="line">                outputStream.close()</span><br><span class="line">                inputStream.close()</span><br><span class="line"></span><br><span class="line">                println(<span class="string">&quot;File downloaded successfully: <span class="variable">$uri</span>&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getOutputUri</span><span class="params">(fileName: <span class="type">String</span>)</span></span>: Uri? &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">            <span class="keyword">val</span> contentValues = ContentValues().apply &#123;</span><br><span class="line">                put(MediaStore.Downloads.DISPLAY_NAME, fileName)</span><br><span class="line">                put(MediaStore.Downloads.MIME_TYPE, <span class="string">&quot;application/octet-stream&quot;</span>)</span><br><span class="line">                put(MediaStore.Downloads.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">            &#125;</span><br><span class="line">            context.contentResolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, contentValues)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> downloadsDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)</span><br><span class="line">            Uri.fromFile(java.io.File(downloadsDir, fileName))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个实现有以下优点：</p><ol><li>它在所有 Android 版本上都不需要 WRITE_EXTERNAL_STORAGE 权限。</li><li>对于 Android 10 及以上版本，它使用 MediaStore API 来创建文件。</li><li>对于 Android 9 及以下版本，它仍然使用 File API，但通过 ContentResolver 来写入文件，这样不需要存储权限。</li></ol><p>使用这个下载器的方式如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> downloader: FileDownloader</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        downloader = FileDownloader(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">        findViewById&lt;Button&gt;(R.id.downloadButton).setOnClickListener &#123;</span><br><span class="line">            downloader.downloadFile(</span><br><span class="line">                <span class="string">&quot;https://example.com/file.zip&quot;</span>,</span><br><span class="line">                <span class="string">&quot;downloaded_file.zip&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 AndroidManifest.xml 中，你只需要声明网络权限：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>这种方法的优点是：</p><ol><li>兼容性好：适用于所有 Android 版本。</li><li>不需要存储权限：在所有版本上都不需要 WRITE_EXTERNAL_STORAGE 权限。</li><li>简单直接：不需要用户选择目录或处理 SAF。</li></ol><p>需要注意的是，这种方法将文件下载到公共的下载目录。如果你需要将文件保存到应用的私有目录，或者需要更多的文件操作灵活性，可能还是需要考虑使用 SAF 或其他方法。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://juejin.cn/post/6987569764407181349">聊一聊Android存储行为的变化</a></p><p><a href="https://juejin.cn/post/7383311950175272998">就想下载个文件到SD卡，怎就这么难？快把代码拿走吧</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Github Actions 编译Python项目自动化构建 exe</title>
      <link href="/blog/2024/01/18/shi-yong-github-actions-bian-yi-python-xiang-mu-zi-dong-hua-gou-jian-exe/"/>
      <url>/blog/2024/01/18/shi-yong-github-actions-bian-yi-python-xiang-mu-zi-dong-hua-gou-jian-exe/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/features/actions">GitHub Actions</a> 是 GitHub 的持续集成服务。</p><p>在这个Python项目 <a href="https://github.com/xmaihh/CSVFilter"><strong>https://github.com/xmaihh/CSVFilter</strong> </a> 中使用Github Actions自动化构建exe并发布到Release。</p><p><strong>pyinstaller使用问题</strong>参考**<a href="https://github.com/HaujetZhao/PyInstaller-Perfect-Build-Method">PyInstaller-Perfect-Build-Method</a>**</p><p>在每个工作流作业开始时，GitHub 会自动创建唯一的 GITHUB_TOKEN 机密以在工作流中使用。 可以使用 GITHUB_TOKEN 在工作流作业中进行身份验证。使用标准语法引用密钥<code>GITHUB_TOKEN：$&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</code>,有关详细信息请参阅“<a href="https://docs.github.com/zh/actions/security-guides/automatic-token-authentication#about-the-github_token-secret">关于 <code>GITHUB_TOKEN</code> 机密</a>”。</p><h1 id="使用-Github-Actions-编译Python项目自动化构建-exe"><a href="#使用-Github-Actions-编译Python项目自动化构建-exe" class="headerlink" title="使用 Github Actions 编译Python项目自动化构建 exe"></a>使用 Github Actions 编译Python项目自动化构建 exe</h1><p>在你的<strong>Python源码仓库</strong>根目录下创建一个 <strong>.github&#x2F;workflows</strong> 文件夹,在该文件夹内创建一个新的 <strong>YAML</strong> 文件（例如 deploy.yml）用于定义 <strong>GitHub Actions</strong> 工作流。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This workflow will upload a Python Package using PyInstaller when a release is published</span></span><br><span class="line"><span class="comment"># For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Publish</span> <span class="string">to</span> <span class="string">Release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">windows-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">OUTPUT_FILE_PREFIX:</span> <span class="string">CSVFilter.Setup</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Python</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-python@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="string">&#x27;3.12&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          python -m pip install --upgrade pip</span></span><br><span class="line"><span class="string">          pip install pip-tools</span></span><br><span class="line"><span class="string">          pip-sync requirements.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">python</span> <span class="string">prebuild_scripts/version.py</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Read</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">read_config</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          $version = (python -c &quot;import configparser;config = configparser.ConfigParser();config.read(&#x27;config.ini&#x27;);print(config.get(&#x27;DEFAULT&#x27;, &#x27;version&#x27;))&quot;)</span></span><br><span class="line"><span class="string">          echo &quot;version=$version&quot; &gt;&gt; $env:GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">executable</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Using version: $&#123;&#123; steps.read_config.outputs.version &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          pyinstaller --onefile --add-data &quot;resources;resources&quot; --add-data &quot;config.ini;.&quot; --icon=&quot;resources/csv_filter.ico&quot; --windowed --clean --name &quot;$&#123;&#123; env.OUTPUT_FILE_PREFIX &#125;&#125;.$&#123;&#123; steps.read_config.outputs.version &#125;&#125;&quot; main.py</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">release</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">create_release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/create-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">tag_name:</span> <span class="string">v$&#123;&#123;</span> <span class="string">steps.read_config.outputs.version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">release_name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.read_config.outputs.version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">prerelease:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Delete</span> <span class="string">old</span> <span class="string">releases</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          $current_release = &quot;v$&#123;&#123; steps.read_config.outputs.version &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          $releases = gh release list --limit 1000 | ForEach-Object &#123; $_.Split()[0] &#125;</span></span><br><span class="line"><span class="string">          foreach ($release in $releases) &#123;</span></span><br><span class="line"><span class="string">            if ($release -ne $current_release) &#123;</span></span><br><span class="line"><span class="string">              echo &quot;Deleting release: $release&quot;</span></span><br><span class="line"><span class="string">              gh release delete $release --cleanup-tag -y</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">release</span> <span class="string">asset</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-release-asset@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">upload_url:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.create_release.outputs.upload_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">asset_path:</span> <span class="string">dist/$&#123;&#123;</span> <span class="string">env.OUTPUT_FILE_PREFIX</span> <span class="string">&#125;&#125;.$&#123;&#123;</span> <span class="string">steps.read_config.outputs.version</span> <span class="string">&#125;&#125;.exe</span></span><br><span class="line">          <span class="attr">asset_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.OUTPUT_FILE_PREFIX</span> <span class="string">&#125;&#125;.$&#123;&#123;</span> <span class="string">steps.read_config.outputs.version</span> <span class="string">&#125;&#125;.exe</span></span><br><span class="line">          <span class="attr">asset_content_type:</span> <span class="string">application/octet-stream</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://docs.github.com/en/actions">官方文档</a></p><p><strong><a href="https://github.com/HaujetZhao/PyInstaller-Perfect-Build-Method">PyInstaller-Perfect-Build-Method</a></strong></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github Actions </tag>
            
            <tag> CI/CD </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux下如何更好地使用</title>
      <link href="/blog/2024/01/09/linux-xia-ru-he-geng-hao-di-shi-yong/"/>
      <url>/blog/2024/01/09/linux-xia-ru-he-geng-hao-di-shi-yong/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h1 id="常规安全更新"><a href="#常规安全更新" class="headerlink" title="常规安全更新"></a>常规安全更新</h1><p>通过 <code>unattended-upgrades</code>，可以使 Ubuntu 系统自动进行常规的安全相关更新，使系统一直保持 security。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install unattended-upgrades</span><br><span class="line">sudo dpkg-reconfigure unattended-upgrades</span><br></pre></td></tr></table></figure><h1 id="更改SSH端口"><a href="#更改SSH端口" class="headerlink" title="更改SSH端口"></a>更改SSH端口</h1><p>默认情况下，SSH 服务器侦听端口 22。出于安全原因，许多系统管理员选择将此默认端口更改为另一个不太可预测的数字，以帮助防止自动攻击。</p><p>分步指南：</p><ol><li><p>备份配置文件。在进行任何更改之前，最好备份 SSH 配置文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup</span><br></pre></td></tr></table></figure></li><li><p>编辑 SSH 配置文件。使用您喜欢的文本编辑器打开 SSHD 配置文件。在此示例中，我们将使用 nano。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></li><li><p>找到端口指令。找到以 Port 开头的行。默认情况下，它应该显示端口 22。</p></li><li><p>更改端口号。编辑该行以反映所需的端口号，最好高于 1024，以避免与其他标准服务发生冲突。例如，要将其更改为端口 2222，该行将如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 2222</span><br></pre></td></tr></table></figure></li><li><p>保存并关闭文件。如果您使用的是 nano，请按 CTRL + O 写入更改，然后按 Enter 键和 CTRL + X 退出。</p></li><li><p>调整防火墙规则。如果启用了防火墙（如 UFW 或 Firewalld），则需要更新其规则以允许在新的 SSH 端口上进行连接。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow 2222/tcp</span><br></pre></td></tr></table></figure></li><li><p>重新启动 SSH 服务。通过重新启动 SSH 守护程序来应用更改。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sshd</span><br></pre></td></tr></table></figure></li><li><p>测试新的 SSH 端口。在注销当前会话之前，请打开新的终端或 SSH 客户端，并尝试使用新端口连接到服务器，以确保一切正常：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh username@your_server_ip -p 2222</span><br></pre></td></tr></table></figure></li></ol><h1 id="linux下创建新用户"><a href="#linux下创建新用户" class="headerlink" title="linux下创建新用户"></a>linux下创建新用户</h1><p>Linux下新建用户需要使用<code>useradd</code>和<code>passwd</code>命令</p><ul><li><p>最基础的使用方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd &lt;username&gt; # 新建一个名为&lt;username&gt;的用户</span><br><span class="line">passwd &lt;username&gt; &lt;password&gt; # 为该用户设定密码为&lt;password&gt;</span><br></pre></td></tr></table></figure></li><li><p>最佳实践</p><p>新建用户有时候我们需要连带着完成一些其他的目的，例如修改用户的默认shell（默认的&#x2F;bin&#x2F;sh功能太少，甚至不能使用方向键和Tab键）以及为新用户指定home目录的位置，于是我们可以这么使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -d &lt;homedir&gt; -m -s /bin/bash &lt;username&gt;</span><br></pre></td></tr></table></figure><p>对上述命令的翻译：<br>新建用户<code>&lt;username&gt;</code><br><code>-s</code>：指定shell到<code>/bin/bash</code><br><code>-d</code>：指定其home目录为<code>&lt;homedir&gt;</code><br><code>-m</code>：如果指定的home目录不存在，则新建</p></li></ul><p><code>useradd</code> 可用来建立用户帐号。帐号建好之后，再用 <code>passwd</code> 设定帐号的密码。而可用 <code>userdel</code> 删除帐号。使用 <code>useradd</code> 指令所建立的帐号，实际上是保存在 <code>/etc/passwd</code> 文本文件中。</p><p>参数说明：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Usage: useradd [options] LOGIN</span><br><span class="line">       useradd -D</span><br><span class="line">       useradd -D [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --badnames                对用户名不做检测</span><br><span class="line">  -b, --base-dir BASE_DIR       为新建的用户指定home目录到BASE_DIR下</span><br><span class="line">      --btrfs-subvolume-home    use BTRFS subvolume for home directory</span><br><span class="line">  -c, --comment COMMENT         加上备注文字。备注文字会保存在passwd的备注栏位中</span><br><span class="line">  -d, --home-dir HOME_DIR       指定home目录</span><br><span class="line">  -D, --defaults                变更预设值</span><br><span class="line">  -e, --expiredate EXPIRE_DATE  新用户账户的过期时间</span><br><span class="line">  -f, --inactive INACTIVE       指定在密码过期后多少天即关闭该帐号</span><br><span class="line">  -g, --gid GROUP               为新用户指定用户组（组名或者GID）</span><br><span class="line">  -G, --groups GROUPS           指定用户所属的附加群组</span><br><span class="line">  -h, --help                    显示帮助信息</span><br><span class="line">  -k, --skel SKEL_DIR           use this alternative skeleton directory</span><br><span class="line">  -K, --key KEY=VALUE           override /etc/login.defs defaults</span><br><span class="line">  -l, --no-log-init             do not add the user to the lastlog and</span><br><span class="line">                                faillog databases</span><br><span class="line">  -m, --create-home             为此用户创建home目录</span><br><span class="line">  -M, --no-create-home          不为此用户创建home目录</span><br><span class="line">  -N, --no-user-group           不为此用户创建同名的用户组</span><br><span class="line">  -o, --non-unique              allow to create users with duplicate</span><br><span class="line">                                (non-unique) UID</span><br><span class="line">  -p, --password PASSWORD       encrypted password of the new account</span><br><span class="line">  -r, --system                  create a system account</span><br><span class="line">  -R, --root CHROOT_DIR         directory to chroot into</span><br><span class="line">  -P, --prefix PREFIX_DIR       prefix directory where are located the /etc/* files</span><br><span class="line">  -s, --shell SHELL             为新用户指定shell（例如/bin/bash）</span><br><span class="line">  -u, --uid UID                 为新用户指定UID</span><br><span class="line">  -U, --user-group              create a group with the same name as the user</span><br><span class="line">  -Z, --selinux-user SEUSER     use a specific SEUSER for the SELinux user mapping</span><br><span class="line">      --extrausers              Use the extra users database</span><br></pre></td></tr></table></figure><h1 id="向用户授予sudo权限"><a href="#向用户授予sudo权限" class="headerlink" title="向用户授予sudo权限"></a>向用户授予sudo权限</h1><p>在 Linux 机器中登录 ssh 后，我收到以下消息，执行一个sudo命令，得到提示“’username’ is not in the sudoers file. This incident will be reported.”解决这个问题的办法是，向用户授予 sudo 权限。</p><p>假设 <code>/etc/sudoers</code> 文件被更改以防止 sudo 或 admin 组中的用户将其权限提升为超级用户的权限，则对 sudoers 文件进行备份，如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/sudoers /etc/sudoers.orginal</span><br></pre></td></tr></table></figure><p>打开 sudoers 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visudo</span><br></pre></td></tr></table></figure><p>然后在管理员用户下方添加用户，如下语法所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(ALL)  ALL</span><br></pre></td></tr></table></figure><p>上面的语法每次执行sudo指令是需要passwd的，如果需要免密码，则需按如下语法所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure><h1 id="使用-fail2ban-保护您的系统"><a href="#使用-fail2ban-保护您的系统" class="headerlink" title="使用 fail2ban 保护您的系统"></a>使用 fail2ban 保护您的系统</h1><p>注意：Fail2ban 只能用于保护需要用户名&#x2F;密码身份验证的服务。例如，您无法使用 fail2ban 保护 ping。</p><p>在本文中，我将演示保护 SSH 守护程序 （SSHD） 免受暴力攻击。您可以设置过滤器，就像 <code>fail2ban</code> 它们一样，以保护系统上的几乎所有收听服务。</p><ul><li><p>安装和初始设置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install fail2ban -y</span><br><span class="line">sudo systemctl enable fail2ban</span><br><span class="line">sudo systemctl start fail2ban</span><br></pre></td></tr></table></figure><p>除非您的 <code>fail2ban</code> 配置中存在某种语法问题，否则您不会看到任何标准输出消息。</p></li><li><p>基础配置</p><p>现在配置一些基本的东西 <code>fail2ban</code> 来保护系统，而不会干扰它自己。将 <code>/etc/fail2ban/jail.conf</code> 文件复制到 <code>/etc/fail2ban/jail.local</code> 。该 <code>jail.local</code> 文件是我们感兴趣的配置文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure><p>默认情况下，fail2ban 附带一个 <code>jail.conf</code> 文件。但是，这可能会在更新中被覆盖，因此您应该将此文件复制到 <code>jail.local</code> 文件中并在其中进行调整。</p><p>如果您已有文件 <code>jail.local</code> ，请使用 <code>nano</code> 或您喜欢的文本编辑器打开它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure><p>每次进行配置更改时都必须重新启动 <code>fail2ban</code> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart fail2ban</span><br></pre></td></tr></table></figure></li><li><p>设置筛选服务</p><p>要设置过滤服务，必须在 <code>/etc/fail2ban/jail.d</code> 目录下创建相应的“jail”文件。对于 SSHD，创建一个名为 <code>sshd.local</code> 的新文件，并在其中输入服务过滤指令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[sshd]</span><br><span class="line">enabled = true</span><br><span class="line">backend= systemd</span><br><span class="line">port = ssh</span><br><span class="line">banaction = ufw[application=$(app), blocktype=reject]</span><br><span class="line">logpath = /var/log/sshd/error.log</span><br><span class="line">maxretry = 3</span><br><span class="line">findtime = 120</span><br><span class="line">bantime = 600</span><br></pre></td></tr></table></figure><p>大多数设置都是不言自明的。对上述命令的翻译， 在连续的120s内错误输入密码三次以上的用户在 600 秒（10 分钟）禁止违规系统的 IP 地址。</p><p>重新启动 <code>fail2ban</code> 服务。每次进行配置更改时都必须重新启动 <code>fail2ban</code> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart fail2ban</span><br></pre></td></tr></table></figure></li><li><p>封禁是什么样子的</p><p>查看封禁日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail /var/log/fail2ban.log</span><br></pre></td></tr></table></figure></li><li><p>解除封禁</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client set sshd unbanip 192.168.1.69</span><br></pre></td></tr></table></figure><p>发出此命令后，立刻解除对<code>192.168.1.69</code>的封禁，无需重新启动 fail2ban 守护程序。</p></li></ul><h1 id="安装docker、docker-compose和Portainer-CE"><a href="#安装docker、docker-compose和Portainer-CE" class="headerlink" title="安装docker、docker-compose和Portainer CE"></a>安装docker、docker-compose和Portainer CE</h1><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br></pre></td></tr></table></figure><p>验证安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure><p>若要创建 <code>docker</code> 组并添加用户，请执行以下操作：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br><span class="line">newgrp docker</span><br></pre></td></tr></table></figure><p>验证是否可以 <code>docker</code> 在不运行 <code>sudo</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure><p>此命令下载测试映像并在容器中运行它。当容器运行时，它会打印一条消息并退出。</p><h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><p>赋予可执行权限给下载的二进制文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><p>创建一个符号链接，将<code>docker-compose</code>命令链接到<code>/usr/bin</code>目录，以便可以全局访问</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br></pre></td></tr></table></figure><p>验证安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure><h2 id="安装Portainer-CE"><a href="#安装Portainer-CE" class="headerlink" title="安装Portainer CE"></a>安装Portainer CE</h2><p>创建Portainer将用于存储其数据库的卷</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create portainer_data</span><br></pre></td></tr></table></figure><p>下载 Portainer容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure><p>启动镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9000:9000 --name portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure><p>打开 Web 浏览器 <a href="https://localhost:9000/">https://localhost:9000</a></p><h1 id="安装Tailscale"><a href="#安装Tailscale" class="headerlink" title="安装Tailscale"></a>安装Tailscale</h1><p>安装 Tailscale</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://tailscale.com/install.sh | sh</span><br></pre></td></tr></table></figure><p>将您的机器连接到 Tailscale 网络并在浏览器中进行身份验证：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tailscale up</span><br></pre></td></tr></table></figure><p>您已连接！您可以通过运行以下命令找到您的 Tailscale IPv4 地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale ip -4</span><br></pre></td></tr></table></figure><p>如果添加的设备是服务器或远程访问的设备，则可能需要考虑<a href="https://tailscale.com/kb/1028/key-expiry">禁用密钥过期</a>，以防止需要定期重新进行身份验证。</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ArkUI（eTS）开发问题汇总</title>
      <link href="/blog/2023/12/30/arkui-ets-kai-fa-wen-ti-hui-zong/"/>
      <url>/blog/2023/12/30/arkui-ets-kai-fa-wen-ti-hui-zong/</url>
      
        <content type="html"><![CDATA[<h2 id="Q1-aboutToAppear和onAppear的区别"><a href="#Q1-aboutToAppear和onAppear的区别" class="headerlink" title="Q1.aboutToAppear和onAppear的区别?"></a>Q1.<strong>aboutToAppear和onAppear的区别?</strong></h2><p>aboutToAppear：是被@Component修饰自定义组件的生命周期方法，函数在创建自定义组件的新实例后，在执行其build函数之前执行。</p><p>onAppear：是每个组件的属性方法，在该组件显示时触发此回调。</p><h2 id="eTS里面object类型有办法更新吗"><a href="#eTS里面object类型有办法更新吗" class="headerlink" title="eTS里面object类型有办法更新吗?"></a><strong>eTS里面object类型有办法更新吗?</strong></h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lis</span>:<span class="title class_">Array</span>&lt;<span class="built_in">object</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;计划&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;image&#x27;</span>: $rawfile(<span class="string">&#x27;index/ic_public_view_list_filled2.png&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;number&#x27;</span>:<span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">lis</span>[<span class="string">&#x27;0&#x27;</span>].<span class="property">name</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>然后用这种方式更新前端不会跟着更新,文档里面看到有@State装饰,但是不支持object类型,有其他方式解决吗?</p><p>“number”最好不要作为属性，因为“number”是字段类型。Object请改为class，示例代码如下：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Observed</span> <span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">xxx</span> &#123;</span><br><span class="line"> <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"> <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"> <span class="attr">image</span>: <span class="built_in">string</span>;</span><br><span class="line"> <span class="attr">number</span>: <span class="built_in">number</span>;</span><br><span class="line"> <span class="title function_">constructor</span>(<span class="params"><span class="attr">id</span>: <span class="built_in">number</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">image</span>:<span class="built_in">string</span>,<span class="attr">number</span>:<span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">image</span> = name;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">number</span> = <span class="built_in">number</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">lis</span>: <span class="title class_">Array</span>&lt;xxx&gt; = [&#123;</span><br><span class="line">   <span class="string">&#x27;id&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">   <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;计划&#x27;</span>,</span><br><span class="line">   <span class="string">&#x27;image&#x27;</span>: xxx,</span><br><span class="line">   <span class="string">&#x27;number&#x27;</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">lis</span>[<span class="number">0</span>].<span class="property">name</span>=<span class="string">&#x27;new Name&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Q2-ets-的【TextArea】组件如何做到清空操作？"><a href="#Q2-ets-的【TextArea】组件如何做到清空操作？" class="headerlink" title="Q2.ets 的【TextArea】组件如何做到清空操作？"></a>Q2.<strong>ets 的【TextArea】组件如何做到清空操作？</strong></h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@State</span> <span class="attr">text</span>: <span class="built_in">string</span> = <span class="string">&#x27;test&#x27;</span></span><br><span class="line"><span class="title class_">TextArea</span>(&#123; <span class="attr">placeholder</span>: <span class="variable language_">this</span>.<span class="property">text</span> &#125;)</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title class_">Button</span>().<span class="title function_">onClick</span>(<span class="function">(<span class="params"><span class="attr">value</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">text</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><h2 id="Q3-怎么获取鸿蒙系统的小时制"><a href="#Q3-怎么获取鸿蒙系统的小时制" class="headerlink" title="Q3.怎么获取鸿蒙系统的小时制"></a>Q3.<strong>怎么获取鸿蒙系统的小时制</strong></h2><p>可以使用DateFormatUtil.is24HourClock方法。</p><h2 id="Q4-使用ArkUI开发的App能在安卓设备上安装吗？"><a href="#Q4-使用ArkUI开发的App能在安卓设备上安装吗？" class="headerlink" title="Q4.使用ArkUI开发的App能在安卓设备上安装吗？"></a>Q4.<strong>使用ArkUI开发的App能在安卓设备上安装吗？</strong></h2><p>不可以。HarmonyOS的应用只能运行在鸿蒙系统里。鸿蒙系统能运行HarmonyOS的应用和安卓应用。但是安卓系统只能运行安卓应用。</p><h2 id="Q5-如何实现遮罩效果"><a href="#Q5-如何实现遮罩效果" class="headerlink" title="Q5.如何实现遮罩效果"></a>Q5.如何实现遮罩效果</h2><p>使用onTouch实现按下抬起事件，.mask()实现遮罩的效果。代码如下：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">mask</span>:<span class="built_in">boolean</span>=<span class="literal">false</span></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Image</span>(<span class="string">&#x27;/comment/bg.jpg&#x27;</span>)</span><br><span class="line">        .<span class="title function_">mask</span>(<span class="variable language_">this</span>.<span class="property">mask</span>?<span class="keyword">new</span> <span class="title class_">Rect</span>(&#123; <span class="attr">width</span>: <span class="string">&#x27;500px&#x27;</span>, <span class="attr">height</span>: <span class="string">&#x27;280px&#x27;</span> &#125;).<span class="title function_">fill</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>):<span class="literal">null</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;500px&#x27;</span>).<span class="title function_">height</span>(<span class="string">&#x27;280px&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onTouch</span>(<span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">TouchEvent</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">switch</span>(event.<span class="property">type</span>)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">TouchType</span>.<span class="property">Down</span>:</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">mask</span>=<span class="literal">true</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">TouchType</span>.<span class="property">Up</span>:</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">mask</span>=<span class="literal">false</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>).<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">5</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Q6-ets声明式ui开发，怎么获取当前系统时间"><a href="#Q6-ets声明式ui开发，怎么获取当前系统时间" class="headerlink" title="Q6.ets声明式ui开发，怎么获取当前系统时间"></a>Q6.ets声明式ui开发，怎么获取当前系统时间</h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>在这里，我们将字符串用@state包裹，这样可以监听数据的更新</p><p>我们给Text绑定点击时间，然后点击，即可显示当前时间。代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Entry</span></span><br><span class="line">@<span class="title class_">Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  @<span class="title class_">State</span> <span class="attr">message</span>: string = <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">message</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">50</span>)</span><br><span class="line">          .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>).<span class="title function_">onClick</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="comment">//获取当前时间</span></span><br><span class="line"><span class="comment">//          this.message=date.toLocaleString();</span></span><br><span class="line">          <span class="comment">//周几</span></span><br><span class="line"><span class="comment">//          this.message=date.getUTCDay().toString();</span></span><br><span class="line"><span class="comment">//日期</span></span><br><span class="line"><span class="comment">//          this.message=date.getUTCDate().toString();</span></span><br><span class="line"><span class="comment">//          //农历月份</span></span><br><span class="line"><span class="comment">//          this.message=date.getUTCMonth().toString();</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">message</span>=date.<span class="title function_">getFullYear</span>() + <span class="string">&quot;年&quot;</span> + (date.<span class="title function_">getMonth</span>() + <span class="number">1</span>) + <span class="string">&quot;月&quot;</span> + date.<span class="title function_">getDate</span>() + <span class="string">&quot;日&quot;</span> + date.<span class="title function_">getHours</span>() + <span class="string">&quot;时&quot;</span> + date.<span class="title function_">getMinutes</span>() + <span class="string">&quot;分&quot;</span> + date.<span class="title function_">getSeconds</span>()+ <span class="string">&quot;秒&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Q7-如何解决安装错误或者需要将-compileSdkVersion-和-compatibleSdkVersion-以及-SDK-版本需要与运行设备的-apiVersion-对应起来"><a href="#Q7-如何解决安装错误或者需要将-compileSdkVersion-和-compatibleSdkVersion-以及-SDK-版本需要与运行设备的-apiVersion-对应起来" class="headerlink" title="Q7.如何解决安装错误或者需要将 compileSdkVersion 和 compatibleSdkVersion 以及 SDK 版本需要与运行设备的 apiVersion 对应起来"></a>Q7.如何解决安装错误或者需要将 <code>compileSdkVersion</code> 和 <code>compatibleSdkVersion</code> 以及 SDK 版本需要与运行设备的 <code>apiVersion</code> 对应起来</h1><p>运行的设备（模拟器和真机）和 SDK 版本的不匹配，因此会报 <code>INSTALL_PARSE_FAILED_USESDK_ERROR</code> 错误。</p><p>想解决这个问题，需要将 <code>compileSdkVersion</code> 和 <code>compatibleSdkVersion</code> 以及 SDK 版本需要与运行设备的 <code>apiVersion</code> 对应起来。</p><p>但是我们不能简单修改配置文件中 <code>compileSdkVersion</code> 和 c <code>ompatibleSdkVersion</code> 的版本号，因为使用不同的 <code>HarmonyOS Sdk</code> 版本，创建的 HarmonyOS 工程的目录结构和开发语言都不相同。</p><ul><li><code>API Version 4~7</code> 构建体系是由 Gradle 构建工具和构建插件组成，不要基于这个版本去开发，不然后期从 Gradle 迁移到 Hvigor 是件非常痛苦的事</li><li><code>API Version 8~9</code> 构建体系是由 Hvigor 构建工具和构建插件组成</li></ul><p>开发语言也不一样：</p><ul><li><code>API Version &gt;= 9</code> 仅仅支持 ArkTS</li><li><code>API Version == 8</code> 支持 ArkTS 和 JS</li><li><code>API Version == 7</code> 支持 ArkTS 、 JS 和 Java</li><li><code>API Version &lt; 7</code> 支持 JS 和 Java</li></ul><p>所以我们不能简单的修改  <code>compileSdkVersion</code> 和 <code>compatibleSdkVersion</code> 的版本，对于我们初学者，如果出现这个问题，建议重新创建一个新的工程。</p><p>新建项目时 <code>Compile Sdk</code> 应该选择与你运行的设备（模拟器和真机） <code>apiVersion</code> 相对应的版本号。</p><h1 id="Q8-如何安装-Android-应用到鸿蒙的模拟器"><a href="#Q8-如何安装-Android-应用到鸿蒙的模拟器" class="headerlink" title="Q8.如何安装 Android 应用到鸿蒙的模拟器"></a>Q8.如何安装 Android 应用到鸿蒙的模拟器</h1><p>我们可以使用 adb 命令安装，也可以点击  Android Studio 上运行按钮 <img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/ZFbd8icuQe1LPUqglPrAQoLLPDQ44fGXf3vNuwoaoTTuFdGHDibQ4AfgnQd4f3Drxv8XeiaSwgk0CSyefVovp1C4w/640?wx_fmt=jpeg&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片">  ，直接将 Android 应用安装到鸿蒙模拟器。</p><p>但是我们需要修改 Android 项目支持的 <code>CPU/API</code> 版本。因为 Harmony 的模拟器 CPU&#x2F;API 是 <code>x86</code>，所以需要在 <code>build.gradle</code> 文件中添加 <code>x86</code> 的支持。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">   compileSdkVersion <span class="number">33</span></span><br><span class="line">   defaultConfig &#123;</span><br><span class="line">       ndk &#123;</span><br><span class="line">           abiFilters <span class="string">&#x27;x86_64&#x27;</span>,<span class="string">&#x27;x86&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ArkUI </tag>
            
            <tag> Harmony </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RecyclerView的使用总结以及常见问题解决方案</title>
      <link href="/blog/2023/12/21/recyclerview-de-shi-yong-zong-jie-yi-ji-chang-jian-wen-ti-jie-jue-fang-an/"/>
      <url>/blog/2023/12/21/recyclerview-de-shi-yong-zong-jie-yi-ji-chang-jian-wen-ti-jie-jue-fang-an/</url>
      
        <content type="html"><![CDATA[<h1 id="RecyclerView的使用总结以及常见问题解决方案"><a href="#RecyclerView的使用总结以及常见问题解决方案" class="headerlink" title="RecyclerView的使用总结以及常见问题解决方案"></a>RecyclerView的使用总结以及常见问题解决方案</h1><h2 id="Q1：RecyclerView设置数据不显示"><a href="#Q1：RecyclerView设置数据不显示" class="headerlink" title="Q1：RecyclerView设置数据不显示"></a>Q1：RecyclerView设置数据不显示</h2><p>这个往往是因为你没有设置<code>LayoutManger</code>。 没有<code>LayoutManger</code>的话<code>RecycleView</code>是无法布局的，即是无法展示数据,下面是<code>RecycleView</code>布局的源码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">dispatchLayout</span><span class="params">()</span> &#123;  <span class="comment">//没有设置 Adapter 和 LayoutManager， 都不可能有内容</span></span><br><span class="line">    <span class="keyword">if</span> (mAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;No adapter attached; skipping layout&quot;</span>);</span><br><span class="line">            <span class="comment">// leave the state in START</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLayout == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;No layout manager attached; skipping layout&quot;</span>);</span><br><span class="line">            <span class="comment">// leave the state in START</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即<code>Adapter</code>或<code>Layout</code>任意一个为null,就不会执行布局操作。</p><h2 id="Q2：RecyclerView数据多次滚动后出现混乱"><a href="#Q2：RecyclerView数据多次滚动后出现混乱" class="headerlink" title="Q2：RecyclerView数据多次滚动后出现混乱"></a>Q2：RecyclerView数据多次滚动后出现混乱</h2><p><code>RecycleView</code>在滚动过程中<code>ViewHolder</code>是会不断复用的，因此就会带着上一次展示的UI信息(也包含滚动状态), 所以在设置一个<code>ViewHolder</code>的UI时，尽量要做<code>resetUi()</code>操作:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">override fun <span class="title function_">onBindViewHolder</span><span class="params">(holder: RecyclerView.ViewHolder, position: Int)</span> &#123;</span><br><span class="line">        holder.itemView.resetUi()</span><br><span class="line">        <span class="comment">//设置信息UI </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>resetUi()</code>这个方法就是用来把Ui还原为最初的操作。当然如果你的每一次<code>bindData</code>操作会对每一个UI对象重新赋值的话就不需要有这个操作。就不会出现<code>itemView</code>的UI混乱问题。</p><h2 id="Q3：如何获取当前-ItemView展示的位置"><a href="#Q3：如何获取当前-ItemView展示的位置" class="headerlink" title="Q3：如何获取当前 ItemView展示的位置"></a>Q3：如何获取当前 ItemView展示的位置</h2><p>我们可能会有这样的需求: 当<code>RecycleView</code>中的特定<code>Item</code>滚动到某个位置时做一些操作。比如某个<code>Item</code>滚动到顶部时，展示搜索框。那怎么实现呢？</p><p>首先要获取的Item肯定处于数据源的某个位置并且肯定要展示在屏幕。因此我们可以直接获取这个<code>Item</code>的<code>ViewHolder</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">val</span> <span class="variable">holder</span> <span class="operator">=</span> recyclerView.findViewHolderForAdapterPosition(speicalItemPos) ?: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="type">val</span> <span class="variable">offsetWithScreenTop</span> <span class="operator">=</span> holder.itemview.top</span><br><span class="line"></span><br><span class="line"><span class="title function_">if</span><span class="params">(offsetWithScreenTop &lt;= <span class="number">0</span>)</span>&#123;  <span class="comment">//这个ItemView已经滚动到屏幕顶部</span></span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Q4：如何在固定时间内滚动一款距离"><a href="#Q4：如何在固定时间内滚动一款距离" class="headerlink" title="Q4：如何在固定时间内滚动一款距离"></a>Q4：如何在固定时间内滚动一款距离</h2><p><code>smoothScrollToPosition()</code>大家应该都用过，如果滚动2、3个Item。那么整体的用户体验还是非常棒的。</p><p>但是，如果你滚动20个Item，那这个体验可能就会就很差了。</p><p>恩，滚动的时间有点长。因此对于这种case其实我推荐直接使用<code>scrollToPosition(20)</code>，效果要比这个好。 可是如果你就是想在<code>200ms</code>内从<code>Item 1</code>滚到<code>Item 20</code>怎么办呢？</p><p>可以参考<a href="https://stackoverflow.com/questions/28803319/android-control-smooth-scroll-over-recycler-view/28853254">StackOverflow上的一个答案</a>。大致写法是这样的:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义 LayoutManager， Hook smoothScrollToPosition 方法</span></span><br><span class="line">recyclerView.layoutManager = object : LinearLayoutManager(<span class="built_in">this</span>, LinearLayoutManager.VERTICAL, <span class="literal">false</span>) &#123;</span><br><span class="line">    override fun <span class="title function_">smoothScrollToPosition</span><span class="params">(recyclerView: RecyclerView?, state: RecyclerView.State?, position: Int)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (recyclerView == <span class="literal">null</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">scroller</span> <span class="operator">=</span> get200MsScroller(recyclerView.context, position * <span class="number">500</span>)</span><br><span class="line">        scroller.targetPosition = position</span><br><span class="line">        <span class="title function_">startSmoothScroll</span><span class="params">(scroller)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> fun <span class="title function_">get200MsScroller</span><span class="params">(context: Context, distance: Int)</span>: RecyclerView.SmoothScroller = object : LinearSmoothScroller(context) &#123;</span><br><span class="line">    override fun <span class="title function_">calculateSpeedPerPixel</span><span class="params">(displayMetrics: DisplayMetrics)</span>: Float &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">200.0f</span> / distance) <span class="comment">//表示滚动 distance 花费200ms</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如上面我把时间改为<code>10000</code>,那么就是用10s的时间完成这个滚动操作。</p><h2 id="Q5：如何测量当前RecyclerView的高度"><a href="#Q5：如何测量当前RecyclerView的高度" class="headerlink" title="Q5：如何测量当前RecyclerView的高度"></a>Q5：如何测量当前RecyclerView的高度</h2><p>先描述一下这个需求: <code>RecyclerView</code>中的每个<code>ItemView</code>的高度都是不固定的。我数据源中有20条数据，在没有渲染的情况下我想知道这个20条数据被<code>RecycleView</code>渲染后的总共高度。</p><p>怎么做呢？我的思路是利用<code>LayoutManager</code>来测量，因为<code>RecycleView</code>在对<code>子View</code>进行布局时就是用<code>LayoutManager</code>来测量<code>子View</code>来计算还有多少剩余空间可用，源码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">layoutChunk</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state,LayoutState layoutState, LayoutChunkResult result)</span> &#123;</span><br><span class="line">     <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> layoutState.next(recycler);   <span class="comment">//这个方法会向 recycler要一个View</span></span><br><span class="line">     ...</span><br><span class="line">     measureChildWithMargins(view, <span class="number">0</span>, <span class="number">0</span>);  <span class="comment">//测量这个View的尺寸，方便布局, 这个方法是public</span></span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>所以我们也可以利用<code>layoutManager.measureChildWithMargins</code>方法来测量，代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> fun <span class="title function_">measureAllItemHeight</span><span class="params">()</span>:Int &#123;</span><br><span class="line">    <span class="type">val</span> <span class="variable">measureTemplateView</span> <span class="operator">=</span> SimpleStringView(<span class="built_in">this</span>)</span><br><span class="line">    <span class="type">var</span> <span class="variable">totalItemHeight</span> <span class="operator">=</span></span><br><span class="line">    dataSource.forEach &#123;  <span class="comment">//dataSource当前中的所有数据</span></span><br><span class="line">        measureTemplateView.bindData(it, <span class="number">0</span>) <span class="comment">//设置好UI数据</span></span><br><span class="line">        recyclerView.layoutManager.measureChild(measureTemplateView, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">//调用源码中的子View的测量方法</span></span><br><span class="line">        currentHeight += measureTemplateView.measuredHeight</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> totalItemHeight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>但要注意的是，这个方法要等布局稳定的时候才可以用，如果你在<code>Activity.onCreate</code>中调用，那么应该<code>post</code>一下</strong>， 即:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recyclerView.post&#123;</span><br><span class="line">    <span class="type">val</span> <span class="variable">totalHeight</span> <span class="operator">=</span> measureAllItemHeight()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Q6：IndexOutOfBoundsException-Inconsistency-detected-Invalid-item-position-5-offset-5-state-9"><a href="#Q6：IndexOutOfBoundsException-Inconsistency-detected-Invalid-item-position-5-offset-5-state-9" class="headerlink" title="Q6：IndexOutOfBoundsException: Inconsistency detected. Invalid item position 5(offset:5).state:9"></a>Q6：IndexOutOfBoundsException: Inconsistency detected. Invalid item position 5(offset:5).state:9</h2><p>这个异常通常是由于<code>Adapter的数据源大小</code>改变没有及时通知<code>RecycleView</code>做UI刷新导致的，或者通知的方式有问题。 比如如果数据源变化了(比如数量变少了),而没有调用<code>notifyXXX</code>, 那么此时滚动<code>RecycleView</code>就会产生这个异常。</p><p>解决办法很简单 : <strong><code>Adapter的数据源</code>改变时应立即调用<code>adapter.notifyXXX</code>来刷新<code>RecycleView</code></strong> 。</p><p>分析一下这个异常为什么会产生:</p><p>在<code>RecycleView刷新机制</code>一文介绍过，<code>RecycleView</code>的滚动操作是不会走<code>RecycleView</code>的正常布局过程的，它直接根据滚动的距离来摆放<code>新的子View</code>。 想象一下这种场景，原来数据源集合中<br>有8个Item，然后删除了4个后没有调用<code>adapter.notifyXXX()</code>，这时直接滚动<code>RecycleView</code>，比如滚动将要出现的是第6个Item，<code>LinearLayoutManager</code>就会向<code>Recycler</code>要第6个Item的View:</p><p><code>Recycler.tryGetViewHolderForPositionByDeadline()</code>:&#x3D;&gt;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">offsetPosition</span> <span class="operator">=</span> mAdapterHelper.findPositionOffset(position);  <span class="comment">//position是6 </span></span><br><span class="line"><span class="keyword">if</span> (offsetPosition &lt; <span class="number">0</span> || offsetPosition &gt;= mAdapter.getItemCount()) &#123;    <span class="comment">//但此时  mAdapter.getItemCount() = 5</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Inconsistency detected. Invalid item &quot;</span></span><br><span class="line">                + <span class="string">&quot;position &quot;</span> + position + <span class="string">&quot;(offset:&quot;</span> + offsetPosition + <span class="string">&quot;).&quot;</span></span><br><span class="line">                + <span class="string">&quot;state:&quot;</span> + mState.getItemCount() + exceptionLabel());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即这时就会抛出异常。如果调用了<code>adapter.notifyXXX</code>的话，<code>RecycleView</code>就会进行一次完全的布局操作，就不会有这个异常的产生。</p><p>其实还有很多异常和这个原因差不多，比如:<code>IllegalArgumentException: Scrapped or attached views may not be recycled. isScrap:false</code>(很多情况也是由于没有及时同步UI和数据)</p><p>所以在使用<code>RecycleView</code>时一定要注意保证<strong>数据和UI的同步，数据变化，及时刷新RecyclerView</strong>, 这样就能避免很多crash。</p><h2 id="Q7：如何对RecyclerView进行封装"><a href="#Q7：如何对RecyclerView进行封装" class="headerlink" title="Q7：如何对RecyclerView进行封装"></a>Q7：如何对RecyclerView进行封装</h2><p>现在很多app都会使用<code>RecyclerView</code>来构建一个页面，这个页面中有各种卡片类型。为了支持快速开发我们通常会对<code>RecycleView</code>的<code>Adapter</code>做一层封装来方便我们写各种类型的卡片,下面这种封装是我认为一种比较好的封装:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对 RecyclerView.Adapter 的封装。方便业务书写。 业务只需要处理 (UI Bean) -&gt; (UI View) 的映射逻辑即可</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CommonRvAdapter</span>&lt;T&gt;(<span class="keyword">private</span> val dataSource: List&lt;T&gt;) : RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">onCreateViewHolder</span><span class="params">(parent: ViewGroup, viewType: Int)</span>: RecyclerView.ViewHolder &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">item</span> <span class="operator">=</span> createItem(viewType)</span><br><span class="line">        <span class="keyword">return</span> CommonViewHolder(parent.context, parent, item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">onBindViewHolder</span><span class="params">(holder: RecyclerView.ViewHolder, position: Int)</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">commonViewHolder</span> <span class="operator">=</span> holder as CommonViewHolder&lt;T&gt;</span><br><span class="line">        commonViewHolder.adapterItemView.bindData(dataSource[position], position)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">getItemCount</span><span class="params">()</span> = dataSource.size</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">getItemViewType</span><span class="params">(position: Int)</span>: Int &#123;</span><br><span class="line">        <span class="keyword">return</span> getItemType(dataSource[position])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> viewType 需要创建的ItemView的viewType, 由 &#123;<span class="doctag">@link</span> getItemType(item: T)&#125; 根据数据产生</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回这个 viewType 对应的 AdapterItemView</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">abstract</span> fun <span class="title function_">createItem</span><span class="params">(viewType: Int)</span>: AdapterItemView&lt;T&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> T 代表dataSource中的一个data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回 显示 T 类型的data的 ItemView的 类型</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">abstract</span> fun <span class="title function_">getItemType</span><span class="params">(item: T)</span>: Int</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wrapper 的ViewHolder。 业务不必理会RecyclerView的ViewHolder</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">CommonViewHolder</span>&lt;T&gt;(context: Context?, parent: ViewGroup, val adapterItemView: AdapterItemView&lt;T&gt;)</span><br><span class="line">    <span class="comment">//这一点做了特殊处理，如果业务的AdapterItemView本身就是一个View，那么直接当做ViewHolder的itemView。 否则inflate出一个view来当做ViewHolder的itemView</span></span><br><span class="line">        : RecyclerView.ViewHolder(<span class="keyword">if</span> (adapterItemView is View) adapterItemView <span class="keyword">else</span> LayoutInflater.from(context).inflate(adapterItemView.getLayoutResId(), parent, <span class="literal">false</span>)) &#123;</span><br><span class="line">        init &#123;</span><br><span class="line">            adapterItemView.initViews(itemView)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 能被 CommonRvAdapter 识别的一个 ItemView 。 业务写一个RecyclerView中的ItemView，只需要实现这个接口即可。</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">AdapterItemView</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    fun <span class="title function_">getLayoutResId</span><span class="params">()</span>: Int</span><br><span class="line"></span><br><span class="line">    fun <span class="title function_">initViews</span><span class="params">(var1: View)</span></span><br><span class="line"></span><br><span class="line">    fun <span class="title function_">bindData</span><span class="params">(data: T, post: Int)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么我认为这是一个不错的封装?</p><p><strong>业务如果写一个新的Adapter的话只需要实现两个方法:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> fun <span class="title function_">createItem</span><span class="params">(viewType: Int)</span>: AdapterItemView&lt;T&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> fun <span class="title function_">getItemType</span><span class="params">(item: T)</span>: Int</span><br></pre></td></tr></table></figure><p>即业务写一个<code>Adapter</code>只需要对 <strong>UI 数据</strong> -&gt; <strong>UI View</strong> 做映射即可, 不需要关心<code>RecycleView.ViewHolder</code>的逻辑。</p><p><strong>因为抽象了<code>AdapterItemView</code>, ItemView足够灵活</strong></p><p>由于封装了<code>RecycleView.ViewHolder</code>的逻辑，因此对于<code>UI item view</code>业务方只需要返回一个实现了<code>AdapterItemView</code>的对象即可。可以是一个<code>View</code>,也可以不是一个<code>View</code>, 这是因为<code>CommonViewHolder</code>在构造的时候对它做了兼容:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val view : View = <span class="keyword">if</span> (adapterItemView is View) adapterItemView <span class="keyword">else</span> LayoutInflater.from(context).inflate(adapterItemView.getLayoutResId(), parent, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><p>即如果实现了<code>AdapterItemView</code>的对象本身就是一个<code>View</code>,那么直接把它当做<code>ViewHolder</code>的<code>itemview</code>,否则就<code>inflate</code>出一个<code>View</code>作为<code>ViewHolder</code>的<code>itemview</code>。</p><p>其实这里我比较推荐实现<code>AdapterItemView</code>的同时直接实现一个<code>View</code>,即不要把<code>inflate</code>的工作交给底层框架。比如这样:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SimpleStringView</span>(context: Context) : FrameLayout(context), AdapterItemView&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        LayoutInflater.from(context).inflate(getLayoutResId, <span class="built_in">this</span>)  <span class="comment">//自己去负责inflate工作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">getLayoutResId</span><span class="params">()</span> = R.layout.view_test</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">initViews</span><span class="params">(var1: View)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">bindData</span><span class="params">(data: String, post: Int)</span> &#123; simpleTextView.text = data &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么呢？原因有两点 :</p><ol><li>继承自一个View可复用性很高，封装性很高。即这个<code>SimpleStringView</code>不仅可以在<code>RecycleView</code>中当一个<code>itemView</code>,也可以在任何地方使用。</li><li>方便单元测试，直接new这个View就好了。</li></ol><p>但其实直接继承自一个<code>View</code>是有坑的，即上面那行inflate代码<code>LayoutInflater.from(context).inflate(getLayoutResId, this)</code></p><p>它其实是把<code>xml</code>文件inflate成一个<code>View</code>。然后add到你<code>ViewGroup</code>中。因为<code>SimpleStringView</code>就是一个<code>FrameLayout</code>，所有相当于add到这个<code>FrameLayout</code>中。这其实就有问题了。比如你的布局文件是下面这种:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FrameLayout&gt;</span><br><span class="line">.....</span><br><span class="line">&lt;/FrameLayout&gt;</span><br></pre></td></tr></table></figure><p><strong>这就相当于你可能多加了一层无用的父View</strong></p><p>所有如果是直接继承自一个View的话，我推荐这样写:</p><ol><li>布局文件中尽可能使用<code>&lt;merge&gt;</code>标签来消除这层无用的父View, 即上面的<code>&lt;FrameLayout&gt;</code>改为<code>&lt;merge&gt;</code></li><li>很简单的布局的可以直接在代码中写，不要inflate。这样其实也可以减少inflate的耗时，稍微提高了一点性能吧。</li></ol><p>当然，如果你不需要对这个View做复用的话你可以不用直接继承自<code>View</code>,只实现<code>AdapterItemView</code>接口, inflate的工作交给底层框架即可。这样是不会产生上面这个问题的。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> RecyclerView </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何配置docker通过代理服务器拉取镜像</title>
      <link href="/blog/2023/12/06/ru-he-pei-zhi-docker-tong-guo-dai-li-fu-wu-qi-la-qu-jing-xiang/"/>
      <url>/blog/2023/12/06/ru-he-pei-zhi-docker-tong-guo-dai-li-fu-wu-qi-la-qu-jing-xiang/</url>
      
        <content type="html"><![CDATA[<h1 id="如何配置docker通过代理服务器拉取镜像"><a href="#如何配置docker通过代理服务器拉取镜像" class="headerlink" title="如何配置docker通过代理服务器拉取镜像"></a>如何配置docker通过代理服务器拉取镜像</h1><p>如果 docker 所在的环境是通过代理服务器和互联网连通的，那么需要一番配置才能让 docker 正常从外网正常拉取镜像。然而仅仅通过配置环境变量的方法是不够的。本文结合已有文档，介绍如何配置代理服务器能使docker正常拉取镜像。</p><h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>如果不配置代理服务器就直接拉镜像，docker 会直接尝试连接镜像仓库，并且连接超时报错。如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash">docker pull portainer/portainer-ce</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">Error response from daemon: unknown: &lt;html&gt;&lt;body&gt;&lt;h1&gt;408 Request Time-out&lt;/h1&gt;</span><br><span class="line">Your browser didn&#x27;t send a complete request in time.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure><h1 id="容易误导的官方文档"><a href="#容易误导的官方文档" class="headerlink" title="容易误导的官方文档"></a>容易误导的官方文档</h1><p>有这么一篇关于 docker 配置代理服务器的 <a href="https://docs.docker.com/network/proxy/#configure-the-docker-client">官方文档</a> ，如果病急乱投医，直接按照这篇文章配置，是不能成功拉取镜像的。这篇文档说：如果你的 <strong>容器</strong> 需要使用代理服务器，那么可以以如下方式配置： 在运行容器的用户 home 目录下，配置 <code>~/.docker/config.json</code> 文件。重新启动容器后，这些环境变量将自动设置进容器，从而容器内的进程可以使用代理服务。</p><p>所以这篇文章是讲如何配置运行 容器 的环境，与如何拉取镜像无关。如果按照这篇文档的指导，如同南辕北辙。</p><p>要解决问题，我们首先来看一般情况下命令行如何使用代理。</p><h1 id="正确的官方文档"><a href="#正确的官方文档" class="headerlink" title="正确的官方文档"></a>正确的官方文档</h1><p>常规的命令行程序如果要使用代理，需要设置两个环境变量：<code>HTTP_PROXY</code> 和 <code>HTTPS_PROXY</code> 。但是仅仅这样设置环境变量，也不能让 docker 成功拉取镜像。</p><p>我们仔细观察 上面的报错信息，有一句说明了报错的来源：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Error </span>response from daemon: </span><br></pre></td></tr></table></figure><p>下面是来自 <a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">官方文档</a> 的操作步骤和详细解释：</p><p>1、创建 dockerd 相关的 systemd 目录，这个目录下的配置将覆盖 dockerd 的默认配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span></span><br></pre></td></tr></table></figure><p>新建配置文件 <code>/etc/systemd/system/docker.service.d/http-proxy.conf</code>，这个文件中将包含环境变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=http://proxy.example.com:80&quot;</span><br><span class="line">Environment=&quot;HTTPS_PROXY=https://proxy.example.com:443&quot;</span><br></pre></td></tr></table></figure><p>如果你自己建了私有的镜像仓库，需要 dockerd 绕过代理服务器直连，那么配置 NO_PROXY 变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=http://proxy.example.com:80&quot;</span><br><span class="line">Environment=&quot;HTTPS_PROXY=https://proxy.example.com:443&quot;</span><br><span class="line">Environment=&quot;NO_PROXY=your-registry.com,10.10.10.10,*.example.com&quot;</span><br></pre></td></tr></table></figure><p>多个 <code>NO_PROXY</code> 变量的值用逗号分隔，而且可以使用通配符（*），极端情况下，如果 <code>NO_PROXY=*</code>，那么所有请求都将不通过代理服务器。</p><p>重新加载配置文件，重启 docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> systemctl daemon-reload</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> systemctl restart docker</span></span><br></pre></td></tr></table></figure><p>检查确认环境变量已经正确配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> systemctl show --property=Environment docker</span></span><br></pre></td></tr></table></figure><p>从 docker info 的结果中查看配置项。</p><p>这样配置后，应该可以正常拉取 docker 镜像。</p><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>docker 镜像由 docker daemon 管理，所以不能用修改 shell 环境变量的方法使用代理服务，而是从 systemd 角度设置环境变量。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.cnblogs.com/abc1069/p/17496240.html">https://www.cnblogs.com/abc1069/p/17496240.html</a><br><a href="https://www.lfhacks.com/tech/pull-docker-images-behind-proxy/#correct">https://www.lfhacks.com/tech/pull-docker-images-behind-proxy/#correct</a><br><a href="https://stackoverflow.com/questions/69047394/cant-pull-docker-image-behind-a-proxy">https://stackoverflow.com/questions/69047394/cant-pull-docker-image-behind-a-proxy</a><br><a href="https://mikemylonakis.com/unix/docker-proxy/">https://mikemylonakis.com/unix/docker-proxy/</a><br><a href="https://docs.docker.com/config/daemon/systemd/">https://docs.docker.com/config/daemon/systemd/</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>梅林(Merlin)固件的路由器中安装opkg</title>
      <link href="/blog/2023/10/06/mei-lin-merlin-gu-jian-de-lu-you-qi-zhong-an-zhuang-opkg/"/>
      <url>/blog/2023/10/06/mei-lin-merlin-gu-jian-de-lu-you-qi-zhong-an-zhuang-opkg/</url>
      
        <content type="html"><![CDATA[<h1 id="创建软件安装目录"><a href="#创建软件安装目录" class="headerlink" title="创建软件安装目录"></a>创建软件安装目录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /jffs</span><br><span class="line">mkdir /jffs/opt</span><br><span class="line">ln -nsf /jffs/opt /tmp/opt</span><br></pre></td></tr></table></figure><h1 id="安装opkg"><a href="#安装opkg" class="headerlink" title="安装opkg"></a>安装opkg</h1><p>梅林固件自带一个entware.sh的安装脚本，但是要求必须插上一个ext4等linux文件系统的U盘。这里下载的这个安装脚本不需要插u盘。没有U盘，也懒得试了，直接脚本吧。</p><p>版本1:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://qnapware.zyxmon.org/binaries-armv7/installer/entware_install_arm.sh</span><br><span class="line">sh ./entware_install_arm.sh</span><br></pre></td></tr></table></figure><p>版本2:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.entware.net/binaries/armv7/installer/entware_install.sh</span><br><span class="line">chmod u+x entware_install.sh</span><br><span class="line">sh ./entware_install.sh</span><br></pre></td></tr></table></figure><blockquote><p>哪个脚本地址能用就用哪个版本吧</p></blockquote><h1 id="自动挂载opt分区"><a href="#自动挂载opt分区" class="headerlink" title="自动挂载opt分区"></a>自动挂载opt分区</h1><p>在<code>/jffs/scripts</code>位置建立文件，文件名：<code>post-mount</code><br>可以在电脑上建立后传到路由器中<br>内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">ln -nsf /jffs/opt /tmp/opt</span><br></pre></td></tr></table></figure><p>给脚本添加权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+rx /jffs/scripts/post-mount</span><br></pre></td></tr></table></figure><p>至此opkg软件源安装完毕。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Openwrt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编译VLC for Android</title>
      <link href="/blog/2022/10/09/bian-yi-vlc-for-android/"/>
      <url>/blog/2022/10/09/bian-yi-vlc-for-android/</url>
      
        <content type="html"><![CDATA[<p>本页介绍在 Linux 上 <a href="https://wiki.videolan.org/AndroidCompile/">编译VLC for Android</a> 。</p><h1 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h1><ul><li><p>您<em>必须</em>在 Linux（或 OSX，如果您知道自己在做什么）上构建。</p></li><li><p><em>必须</em>安装以下软件包：</p><ul><li>GNU 自动工具：autoconf、libtool、automake和make（又名gmake）</li><li>…及其依赖项：m4和gawk，mawk或nawk，</li><li>GNU C 和 C++ 编译器又名gcc和g++，</li><li>一些 GNU 构建实用程序：pkg-config和patch，</li><li>以下其他构建实用程序：Apache Ant（或Ant）、cmake、protobuf、ragel、</li><li>Subversion 和 Git 版本控制系统</li><li>解压缩并使用curl或wget来检索源代码。</li></ul></li><li><p>可能需要其中一些工具的最新版本。在撰写本文时，特别需要 gettext 0.19.3 或更高版本。</p></li><li><p>如果缺少上述任何一项，预计构建会在某个时候失败。</p></li><li><p>如果针对 Android-x86 设备，则还必须安装yasm 。</p></li></ul><p><a href="https://git.videolan.org/?p=vlc.git;a=blob;f=extras/tools/bootstrap;h=e60e5ebf93e69e7bb731e80d0fbc6ebd1226dfdb;hb=HEAD#l73">此处</a>列出了工具依赖项的精确列表。</p><p>64位用户：您必须按照此处指定的方式安装这些32位库： <a href="https://wiki.videolan.org/AndroidCompile/#Can.27t_run_aapt_or_adb_on_Linux_64-bit">#Can.27t_run_aapt_or_adb_on_Linux_64-bit</a></p><h1 id="Ubuntu上的示例"><a href="#Ubuntu上的示例" class="headerlink" title="Ubuntu上的示例"></a>Ubuntu上的示例</h1><p>安装包如下：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get <span class="keyword">install </span>automake ant autopoint cmake <span class="keyword">build-essential </span>libtool-<span class="keyword">bin\ </span></span><br><span class="line">     patch pkg-<span class="built_in">config</span> protobuf-compiler ragel <span class="keyword">subversion </span>unzip git\ </span><br><span class="line">    openjdk<span class="number">-8</span>-<span class="keyword">jre </span>openjdk<span class="number">-8</span>-<span class="keyword">jdk </span>flex python wget</span><br></pre></td></tr></table></figure><p>Android开发工具包</p><ul><li>转到<a href="https://developer.android.com/studio">Android SDK&#x2F;IDE页面</a></li></ul><p>请按以下步骤操作：</p><ol><li>从<a href="https://developer.android.com/studio">Android Studio下载页面</a>中下载最新的<code>“command line tools only”</code>软件包，然后将其解压缩。</li><li>将解压缩的<code>cmdline-tools</code>目录移至您选择的新目录，例如<code>android_sdk</code>。这个新目录就是您的<code>Android SDK</code>目录。</li><li>在解压缩的<code>cmdline-tools</code>目录中，创建一个名为<code>latest</code>的子目录。</li><li>将原始<code>cmdline-tools</code>目录内容（包括<code>lib</code>目录、<code>bin</code>目录、<code>NOTICE.txt</code>文件和<code>source.properties</code>文件）移动到新创建的<code>latest</code>目录中。现在，您就可以从这个位置使用命令行工具了。</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android_sdk<span class="regexp">/cmdline-tools/</span>latest<span class="regexp">/bin/</span>sdkmanager --version</span><br></pre></td></tr></table></figure><p>更多的<a href="https://developer.android.com/studio/command-line/sdkmanager">SDKManager用法</a>。</p><p>安装 CMake 或 NDK</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sdkmanager <span class="string">&quot;platform-tools&quot;</span> <span class="string">&quot;platforms;android-33&quot;</span></span><br><span class="line">sdkmanager --<span class="keyword">install</span> <span class="string">&quot;ndk;25.1.8937393&quot;</span></span><br><span class="line">sdkmanager --<span class="keyword">install</span> <span class="string">&quot;ndk;21.4.7075529&quot;</span></span><br><span class="line">sdkmanager --<span class="keyword">install</span> <span class="string">&quot;cmake;3.22.1&quot;</span></span><br></pre></td></tr></table></figure><p>出现这个错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lib/fseterr.c: In function &#x27;fseterr&#x27;:</span><br><span class="line">lib/fseterr.c:77:3: error: #error &quot;Please port gnulib fseterr.c to your platform! Look at the definitions of ferror and clearerr on your system, then report this to bug-gnulib.&quot;</span><br><span class="line">   77 |  #error &quot;Please port gnulib fseterr.c to your platform! Look at the definitions of ferror and clearerr on your system, then report this to bug-gnulib.&quot;</span><br><span class="line">      |   ^~~~~</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> VLC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidStudio的MarkDown不预览</title>
      <link href="/blog/2022/06/23/androidstudio-de-markdown-bu-yu-lan/"/>
      <url>/blog/2022/06/23/androidstudio-de-markdown-bu-yu-lan/</url>
      
        <content type="html"><![CDATA[<p>Markdown Editor 插件后提示<code>Your environment does not support JCEF, cannot use Markdown Editor</code></p><h1 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h1><p>在idea中按快捷键<code>CTRL+SHIFT+A</code>,打开动作指令窗口, 或者双击Shift在最上方选择Action, 在输入框中输入<code>Choose Boot Java Runtime for the IDE</code>(其实输入个Choose Boot就提示出来了), 在弹出窗口中的select中选择一个 xxx JetBrains Runtime With JCEF, 点OK等待下载完成重启即可。</p><img src="https://s2.loli.net/2022/06/23/pkS7o5gTmelwO3A.png" alt="image-20220623174608039" style="zoom:50%;" />]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派4-Ubuntu-Server20.04.4LTS配置xfce桌面环境和TightVNC服务器</title>
      <link href="/blog/2022/06/09/shu-mei-pai-4-ubuntu-server20.04.4lts-pei-zhi-xfce-zhuo-mian-huan-jing-he-tightvnc-fu-wu-qi/"/>
      <url>/blog/2022/06/09/shu-mei-pai-4-ubuntu-server20.04.4lts-pei-zhi-xfce-zhuo-mian-huan-jing-he-tightvnc-fu-wu-qi/</url>
      
        <content type="html"><![CDATA[<h1 id="步骤1-–-安装桌面环境和VNC服务器"><a href="#步骤1-–-安装桌面环境和VNC服务器" class="headerlink" title="步骤1 – 安装桌面环境和VNC服务器"></a>步骤1 – 安装桌面环境和VNC服务器</h1><p>默认情况下，Ubuntu Server 20.04没有安装图形桌面环境或VNC服务器，所以我们首先安装它们。具体来说，我们将为最新的Xfce桌面环境和官方Ubuntu存储库中提供的TightVNC软件包安装软件包。</p><p>在您的服务器上，更新您的包列表：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>现在在您的服务器上安装Xfce桌面环境：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install xfce4 xfce4-goodies</span><br></pre></td></tr></table></figure><p>安装完成后，安装TightVNC服务器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install tightvncserver</span><br></pre></td></tr></table></figure><p>要在安装后完成VNC服务器的初始配置，请使用该vncserver命令设置安全密码并创建初始配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver</span><br></pre></td></tr></table></figure><p>系统将提示您输入并验证密码以远程访问您的计算机：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">You will require a password to access your desktops.</span><br><span class="line">Password:</span><br><span class="line">Verify:</span><br></pre></td></tr></table></figure><p>密码长度必须介于六到八个字符之间。超过8个字符的密码将自动截断。</p><p>验证密码后，您可以选择创建仅查看密码。使用仅查看密码登录的用户将无法使用鼠标或键盘控制VNC实例。如果您想使用VNC服务器向其他人演示内容，这是一个有用的选项，但这不是必需的。</p><p>然后，该过程为服务器创建必要的默认配置文件和连接信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Would you like to enter a view-only password (y/n)? n</span><br><span class="line">xauth:  file /home/sammy/.Xauthority does not exist</span><br><span class="line"></span><br><span class="line">New &#x27;X&#x27; desktop is your_hostname:1</span><br><span class="line"></span><br><span class="line">Creating default startup script /home/sammy/.vnc/xstartup</span><br><span class="line">Starting applications specified in /home/sammy/.vnc/xstartup</span><br><span class="line">Log file is /home/sammy/.vnc/your_hostname:1.log</span><br></pre></td></tr></table></figure><p>现在让我们配置VNC服务器。</p><h1 id="步骤2-–-配置VNC服务器VNC服务器"><a href="#步骤2-–-配置VNC服务器VNC服务器" class="headerlink" title="步骤2 – 配置VNC服务器VNC服务器"></a>步骤2 – 配置VNC服务器VNC服务器</h1><p>需要知道启动时要执行的命令。具体来说，VNC需要知道它应该连接到哪个图形桌面。</p><p>这些命令位于主目录下xstartup的.vnc文件夹中调用的配置文件中。启动脚本是vncserver在上一步中运行时创建的，但我们将创建自己的脚本以启动Xfce桌面。</p><p>首次设置VNC时，它会在端口5901上启动默认服务器实例。该端口称为显示端口，由VNC称为:1。VNC可以在其他显示端口上启动多个实例，例如:2，:3等等。</p><p>因为我们将要更改VNC服务器的配置方式，所以首先5901使用以下命令停止在端口上运行的VNC服务器实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver -kill :1</span><br></pre></td></tr></table></figure><p>输出应该如下所示，尽管您会看到不同的PID：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Killing Xtightvnc process ID 17648</span><br></pre></td></tr></table></figure><p>在修改xstartup文件之前，请备份原始文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ~/.vnc/xstartup ~/.vnc/xstartup.bak</span><br></pre></td></tr></table></figure><p>现在创建一个新xstartup文件并在文本编辑器中打开它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano ~/.vnc/xstartup</span><br></pre></td></tr></table></figure><p>无论何时启动或重新启动VNC服务器，都会自动执行此文件中的命令。如果尚未启动，我们需要VNC启动我们的桌面环境。将这些命令添加到文件中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">!/bin/sh</span></span><br><span class="line">unset SESSION_MANAGER</span><br><span class="line">unset DBUS_SESSION_BUS_ADDRESS</span><br><span class="line">startxfce4 &amp;</span><br><span class="line"></span><br><span class="line">[ -x /etc/vnc/xstartup ] &amp;&amp; exec /etc/vnc/xstartup</span><br><span class="line">[ -r $HOME/.Xresources ] &amp;&amp; xrdb $HOME/.Xresources</span><br><span class="line">xsetroot -solid grey</span><br></pre></td></tr></table></figure><p>文件中的第一个命令不去研究了。第二个命令告诉服务器启动Xfce，在这里您可以找到舒适地管理服务器所需的所有图形软件。</p><p>为确保VNC服务器能够正确使用此新启动文件，我们需要使其可执行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x ~/.vnc/xstartup</span><br></pre></td></tr></table></figure><p>现在，重新启动VNC服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver</span><br></pre></td></tr></table></figure><p>您将看到类似于此的输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">New &#x27;X&#x27; desktop is your_hostname:1</span><br><span class="line"></span><br><span class="line">Starting applications specified in /home/sammy/.vnc/xstartup</span><br><span class="line">Log file is /home/sammy/.vnc/your_hostname:1.log</span><br></pre></td></tr></table></figure><p>配置到位后，让我们从本地计算机连接到服务器。</p><h1 id="步骤3-–-安全地连接VNC桌面"><a href="#步骤3-–-安全地连接VNC桌面" class="headerlink" title="步骤3 – 安全地连接VNC桌面"></a>步骤3 – 安全地连接VNC桌面</h1><p>连接时VNC本身不使用安全协议。我们将使用SSH隧道安全地连接到我们的服务器，然后告诉我们的VNC客户端使用该隧道而不是直接连接。</p><p>在本地计算机上创建SSH连接，以便安全地转发到localhostVNC连接。您可以使用以下命令通过Linux或macOS上的终端执行此操作：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 5901:127.0.0.1:5901 -C -N -l sammy your_server_ip</span><br></pre></td></tr></table></figure><p>该-L开关指定的端口绑定。在这种情况下，我们将5901远程连接的端口5901绑定到本地计算机上的端口。该-C开关启用压缩，而-N开关告诉ssh我们不希望执行远程命令。该-l开关指定远程登录名。</p><p>记得替换sammy，并your_server_ip与您的服务器的须藤非root用户名和IP地址。</p><p>如果您使用的是图形化SSH客户端（如PuTTY），请将your_server_ip用作连接IP，并在程序的SSH隧道设置中设置localhost:5901为新的转发端口。</p><p>隧道运行后，使用VNC客户端进行连接localhost:5901。系统将提示您使用在步骤1中设置的密码进行身份验证。</p><p>接下来让我们将VNC服务器设置为服务。</p><h1 id="步骤4-–-将VNC作为系统服务运行"><a href="#步骤4-–-将VNC作为系统服务运行" class="headerlink" title="步骤4 – 将VNC作为系统服务运行"></a>步骤4 – 将VNC作为系统服务运行</h1><p>接下来，我们将VNC服务器设置为systemd服务，以便我们可以根据需要启动，停止和重新启动它，就像任何其他服务一样。这还将确保在服务器重新启动时VNC启动。</p><p>首先，使用您喜欢的文本编辑器创建一个新的<code>/etc/systemd/system/vncserver@.service</code>单元文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/vncserver@.service</span><br></pre></td></tr></table></figure><p>@名称末尾的符号将让我们传入一个我们可以在服务配置中使用的参数。我们将使用它来指定我们在管理服务时要使用的VNC显示端口。</p><p>将以下行添加到该文件中。请务必更改<code>用户</code>，<code>组</code>，<code>WorkingDirectory</code>的值以及<code>PIDFILE</code>值中的用户名以匹配您的用户名：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Start TightVNC server at startup</span><br><span class="line">After=syslog.target network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=sammy</span><br><span class="line">Group=sammy</span><br><span class="line">WorkingDirectory=/home/sammy</span><br><span class="line"></span><br><span class="line">PIDFile=/home/sammy/.vnc/%H:%i.pid</span><br><span class="line">ExecStartPre=-/usr/bin/vncserver -kill :%i &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ExecStart=/usr/bin/vncserver -depth 24 -geometry 1280x800 :%i</span><br><span class="line">ExecStop=/usr/bin/vncserver -kill :%i</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>如果VNC已经运行，该ExecStartPre命令将停止。该ExecStart命令启动VNC并将颜色深度设置为24位颜色，分辨率为1280×800。您也可以修改这些启动选项以满足您的需求。</p><p>保存并关闭文件。</p><p>接下来，让系统知道新的单元文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>启用单元文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable vncserver@1.service</span><br></pre></td></tr></table></figure><p>在1以下的@符号表示，其显示编号的服务应该出现过，在这种情况下，默认:1为在步骤2中进行了讨论..</p><p>如果VNC服务器仍然在运行，请停止它的当前实例。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver -kill :1</span><br></pre></td></tr></table></figure><p>然后启动它，就像启动任何其他systemd服务一样。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start vncserver@1</span><br></pre></td></tr></table></figure><p>您可以使用此命令验证它是否已启动：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status vncserver@1</span><br></pre></td></tr></table></figure><p>如果它正确启动，输出应如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">● vncserver@1.service - Start TightVNC server at startup</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/vncserver@.service; indirect; vendor preset: enabled)   </span><br><span class="line">   Active: active (running) since Mon 2018-07-09 18:13:53 UTC; 2min 14s ago  </span><br><span class="line">  Process: 22322 ExecStart=/usr/bin/vncserver -depth 24 -geometry 1280x800 :1 (code=exited, status=0/SUCCESS)   </span><br><span class="line">  Process: 22316 ExecStartPre=/usr/bin/vncserver -kill :1 &gt; /dev/null 2&gt;&amp;1 (code=exited, status=0/SUCCESS) Main PID: 22330 (Xtightvnc)</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>重新启动计算机后，您的VNC服务器现在可用。</p><p>再次启动SSH隧道：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 5901:127.0.0.1:5901 -C -N -l sammy your_server_ip</span><br></pre></td></tr></table></figure><p>然后使用VNC客户端软件建立新连接localhost:5901以连接到您的计算机。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://www.fromars.com/tightvnc_xfce4.html">安装配置TightVNC和xfce4</a><br><a href="http://www.penguintutor.com/raspberrypi/tightvnc">Remote GUI access to a Linux computer using Tightvnc with systemd</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Raspberry Pi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在macOS使用DNS over Https(DoH)</title>
      <link href="/blog/2022/03/01/ru-he-zai-macos-shi-yong-dns-over-https-doh/"/>
      <url>/blog/2022/03/01/ru-he-zai-macos-shi-yong-dns-over-https-doh/</url>
      
        <content type="html"><![CDATA[<h1 id="安装HomeBrew"><a href="#安装HomeBrew" class="headerlink" title="安装HomeBrew"></a>安装HomeBrew</h1><p><code>HomeBrew</code>官方推荐快速安装<a href="https://brew.sh/">Homebrew</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)&quot;</span><br></pre></td></tr></table></figure><h1 id="安装cloudflared"><a href="#安装cloudflared" class="headerlink" title="安装cloudflared"></a>安装cloudflared</h1><p>用Homebrew快速安装<a href="https://github.com/cloudflare/cloudflared">cloudflared</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install cloudflare/cloudflare/cloudflared</span><br></pre></td></tr></table></figure><h1 id="设置cloudflared"><a href="#设置cloudflared" class="headerlink" title="设置cloudflared"></a>设置cloudflared</h1><p>DNS服务节点地址：<a href="https://iqdns.xyz/all.html">iQDNS</a></p><h1 id="创建cloudflared配置文件："><a href="#创建cloudflared配置文件：" class="headerlink" title="创建cloudflared配置文件："></a>创建cloudflared配置文件：</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/etc/cloudflared</span><br><span class="line">vim /usr/local/etc/cloudflared/config.yaml</span><br></pre></td></tr></table></figure><p>粘贴以下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">proxy-dns: true</span><br><span class="line">proxy-dns-upstream:</span><br><span class="line">  - https://a.passcloud.xyz/dns-query</span><br><span class="line">  - https://adh.avpclub.gq/dns-query</span><br><span class="line">  - https://dns.futa.gg/dns-query</span><br><span class="line">  - https://1.1.1.1/dns-query</span><br><span class="line">  - https://1.0.0.1/dns-query</span><br></pre></td></tr></table></figure><p>保存退出。</p><h1 id="启动cloudflared"><a href="#启动cloudflared" class="headerlink" title="启动cloudflared"></a>启动cloudflared</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cloudflared service install</span><br></pre></td></tr></table></figure><p>cloudflared Service 执行命令启动后，以后开机都会自动启动cloudflared DNS 服务器，会在本机监听port 53。</p><h1 id="删除cloudflared"><a href="#删除cloudflared" class="headerlink" title="删除cloudflared"></a>删除cloudflared</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cloudflared service uninstall</span><br></pre></td></tr></table></figure><h1 id="修改macOS系统网络设置"><a href="#修改macOS系统网络设置" class="headerlink" title="修改macOS系统网络设置"></a>修改macOS系统网络设置</h1><p>打开macOS的 「系统偏好设置」，依次找到「网络」-&gt;「高级」-&gt;「DNS」，在DNS服务器填入 本机IP<code>127.0.0.1</code>即可。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jkg.tw/p3361/">如何在 macOS 使用 DNS over Https（DoH）</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> macOS </tag>
            
            <tag> DoH </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android5.0以下引用SVG崩溃的解决方案</title>
      <link href="/blog/2022/01/19/android5-0-yi-xia-yin-yong-svg-beng-kui-de-jie-jue-fang-an/"/>
      <url>/blog/2022/01/19/android5-0-yi-xia-yin-yong-svg-beng-kui-de-jie-jue-fang-an/</url>
      
        <content type="html"><![CDATA[<h1 id="1、xml里面引用"><a href="#1、xml里面引用" class="headerlink" title="1、xml里面引用"></a>1、xml里面引用</h1><p>在根布局加上：<code>xmlns:app=http://schemas.android.com/apk/res-auto</code></p><p>然后：</p><p><code>app:srcCompat=&quot;@drawable/ic_backspace&quot; /&gt;</code></p><h1 id="2、在代码里面设置"><a href="#2、在代码里面设置" class="headerlink" title="2、在代码里面设置"></a>2、在代码里面设置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ImageView img.setDrawableR.drawable.ic_backspace);</span><br><span class="line"></span><br><span class="line">ImageView img.setImageResource(R.drawable.ic_backspace);</span><br></pre></td></tr></table></figure><h1 id="3、自定义属性里面包含svg图片"><a href="#3、自定义属性里面包含svg图片" class="headerlink" title="3、自定义属性里面包含svg图片"></a>3、自定义属性里面包含svg图片</h1><p>需要使用<code>TintedTypedArray</code>来解析</p><h1 id="4、不能使用android-background来引用svg图片"><a href="#4、不能使用android-background来引用svg图片" class="headerlink" title="4、不能使用android:background来引用svg图片"></a>4、不能使用android:background来引用svg图片</h1><p>如果要设置background可以使用<code>方式2</code>通过代码来设置</p><h1 id="5、Glide不支持直接引用svg图片"><a href="#5、Glide不支持直接引用svg图片" class="headerlink" title="5、Glide不支持直接引用svg图片"></a>5、Glide不支持直接引用svg图片</h1><h1 id="6、Android-5-0以下，如果不继承AppCompatActivity，获取svg图片方法"><a href="#6、Android-5-0以下，如果不继承AppCompatActivity，获取svg图片方法" class="headerlink" title="6、Android 5.0以下，如果不继承AppCompatActivity，获取svg图片方法"></a>6、Android 5.0以下，如果不继承AppCompatActivity，获取svg图片方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">VectorEnabledTintResources</span> <span class="variable">resources</span> <span class="operator">=</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">VectorEnabledTintResources</span>(getApplicationContext(), getResources());</span><br><span class="line"></span><br><span class="line"><span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> resources.getDrawable(R.drawable.ic_3s);</span><br></pre></td></tr></table></figure><h1 id="7、selector里可以用svg图片"><a href="#7、selector里可以用svg图片" class="headerlink" title="7、selector里可以用svg图片"></a>7、selector里可以用svg图片</h1><h1 id="8、渐变色的崩溃"><a href="#8、渐变色的崩溃" class="headerlink" title="8、渐变色的崩溃"></a>8、渐变色的崩溃</h1><p>崩溃范围：Android API 24以下，使用drawableLeft等。</p><p>原因：SVG的渐变色只能用aapt标签包含，需要放在<code>drawable-v24</code>包中，如果依然放在drawable包中，没有问题。但高版本gradle使用aapt2进行资源打包，在低于24的手机上会因为找不到资源崩溃。但之前使用aapt进行资源打包的项目没有问题，因为此时生成了对应的png图。</p><p>特别说明：设置<code>background</code>、<code>srcCompat</code>不会有问题，但需要注意是否显示正常。</p><p>布局无法使用 <code>background</code> 和 <code>srcCompat</code> 代替时，那么可以使用以下代码动态获取 <code>drawable</code> 设置：</p><p><code>AppCompatResources.getDrawable(context, resId)</code></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Github Actions 编译Flutter项目自动化构建</title>
      <link href="/blog/2021/07/23/shi-yong-github-actions-bian-yi-flutter-xiang-mu-zi-dong-hua-gou-jian/"/>
      <url>/blog/2021/07/23/shi-yong-github-actions-bian-yi-flutter-xiang-mu-zi-dong-hua-gou-jian/</url>
      
        <content type="html"><![CDATA[<p>在 Flutter 配置 Github Action，打开项目的根目录中设置一个新的目录和文件 <code>.github/workflows/deploy.yml</code></p><p>这是此次要实现的GitHub Actions的大致工作流程:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------------+         +------------------+         +-----------------+</span><br><span class="line">|                |         |                  |         |                 |</span><br><span class="line">|  触发事件       +--------&gt;+  准备环境         +--------&gt;+  构建与测试      |</span><br><span class="line">| (push 或 PR)   |         | (确定 Flutter    |         | (构建 APK 和     |</span><br><span class="line">|                |         |  版本)           |         |  iOS 应用，运行  |</span><br><span class="line">+----------------+         +------------------+        |  测试)           |</span><br><span class="line">                                                       +--------+--------+</span><br><span class="line">                                                                |</span><br><span class="line">                                                                |</span><br><span class="line">                                                                v</span><br><span class="line">                                                       +--------+--------+</span><br><span class="line">                                                       |                 |</span><br><span class="line">                                                       |   部署           |</span><br><span class="line">                                                       | (上传构建产物到   |</span><br><span class="line">                                                       |  生产环境)       |</span><br><span class="line">                                                       |                 |</span><br><span class="line">                                                       +-----------------+</span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Flutter</span> <span class="string">CI/CD</span> <span class="string">Pipeline</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;v*&#x27;</span>  <span class="comment"># 只有带有特定版本格式（如v1.0）的标签才会触发此工作流</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]  <span class="comment"># 只有针对 main 分支的 PR 才会触发此工作流</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">prepare:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">flutter_version:</span> <span class="string">&#x27;2.2.3&#x27;</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Determine</span> <span class="string">Flutter</span> <span class="string">version</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;::set-output name=flutter_version::2.2.3&quot;</span>  <span class="comment"># 设置 Flutter 版本，以便后续任务使用</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build_and_test:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">prepare</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">platform:</span> [<span class="string">apk</span>, <span class="string">ios</span>]</span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">apk</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">ios</span></span><br><span class="line">            <span class="attr">os:</span> <span class="string">macos-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span>  <span class="comment"># 检出仓库代码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Flutter</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">subosito/flutter-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">flutter-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.prepare.outputs.flutter_version</span> <span class="string">&#125;&#125;</span>  <span class="comment"># 使用之前确定的 Flutter 版本</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">pub</span> <span class="string">get</span>  <span class="comment"># 安装 Flutter 项目依赖</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">flutter</span> <span class="string">test</span>  <span class="comment"># 运行所有测试</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          if [ &quot;$&#123;&#123; matrix.platform &#125;&#125;&quot; == &quot;apk&quot; ]; then</span></span><br><span class="line"><span class="string">            flutter build apk --release  # 构建 Android APK</span></span><br><span class="line"><span class="string">          else</span></span><br><span class="line"><span class="string">            flutter build ios --release --no-codesign  # 构建 iOS 应用，无需代码签名</span></span><br><span class="line"><span class="string"></span>        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Archive</span> <span class="string">Artifacts</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.platform</span> <span class="string">&#125;&#125;-release</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            build/app/outputs/flutter-apk/*.apk</span></span><br><span class="line"><span class="string">            build/ios/iphoneos/*.app</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build_and_test</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">Artifacts</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">apk-release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          VERSION=$&#123;GITHUB_REF#refs/tags/&#125;</span></span><br><span class="line"><span class="string">          echo &quot;Deploying version $VERSION to production&quot;</span></span><br><span class="line"><span class="string">          # 这里可以添加具体的部署命令，例如上传到应用商店或服务器</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
            <tag> Github Actions </tag>
            
            <tag> CI/CD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu执行sudo apt-get update时报错Could not resolve &#39;mirrors.cloud.aliyuncs.com&#39;</title>
      <link href="/blog/2021/06/18/ubuntu-zhi-xing-sudo-apt-get-update-shi-bao-cuo-could-not-resolve-mirrors.cloud.aliyuncs.com/"/>
      <url>/blog/2021/06/18/ubuntu-zhi-xing-sudo-apt-get-update-shi-bao-cuo-could-not-resolve-mirrors.cloud.aliyuncs.com/</url>
      
        <content type="html"><![CDATA[<p>解决办法：ubuntu换源</p><p>可选择的国内源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">阿里源</span></span><br><span class="line">http://mirrors.aliyun.com/ubuntu/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">中科大源</span></span><br><span class="line">https://mirrors.ustc.edu.cn/ubuntu/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">163源</span></span><br><span class="line">http://mirrors.163.com/ubuntu/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清华源</span></span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/ubuntu/</span><br></pre></td></tr></table></figure><h1 id="备份-sources-list-文件"><a href="#备份-sources-list-文件" class="headerlink" title="备份 sources.list 文件"></a>备份 <code>sources.list</code> 文件</h1><p>在进行任何修改之前，最好先备份原始文件，以防出现问题时可以恢复：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><h1 id="使用-sed-命令进行替换"><a href="#使用-sed-命令进行替换" class="headerlink" title="使用 sed 命令进行替换"></a>使用 <code>sed</code> 命令进行替换</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s|mirrors.cloud.aliyuncs.com|mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><ul><li><p><code>-i</code> 选项表示直接编辑文件。</p></li><li><p><code>s|old|new|g</code> 是替换命令，其中 <code>old</code> 是要替换的字符串，<code>new</code> 是替换后的字符串。</p></li><li><p><code>|</code> 用于分隔字符串，避免与 URL 中的 <code>/</code> 混淆。</p></li></ul><h1 id="验证替换结果"><a href="#验证替换结果" class="headerlink" title="验证替换结果"></a>验证替换结果</h1><p>编辑或查看 <code>sources.list</code> 文件，确认替换是否成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>最后执行更新源 <code>sudo apt-get update</code>，问题解决。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ylgy接口分析</title>
      <link href="/blog/2021/06/18/ylgy-jie-kou-fen-xi/"/>
      <url>/blog/2021/06/18/ylgy-jie-kou-fen-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="羊了个羊"><a href="#羊了个羊" class="headerlink" title="&#x2F;羊了个羊"></a>&#x2F;羊了个羊</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">暂无描述</span><br></pre></td></tr></table></figure><h4 id="接口状态"><a href="#接口状态" class="headerlink" title="接口状态"></a>接口状态</h4><blockquote><p>开发中</p></blockquote><h4 id="接口URL"><a href="#接口URL" class="headerlink" title="接口URL"></a>接口URL</h4><blockquote><p><a href="https://cat-match.easygame2021.com/sheep/v1/game/game_over?rank_score=1&rank_state=1&rank_time=547&rank_role=1&skin=1">https://cat-match.easygame2021.com/sheep/v1/game/game_over?rank_score=1&amp;rank_state=1&amp;rank_time=547&amp;rank_role=1&amp;skin=1</a></p></blockquote><h4 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h4><blockquote><p>GET</p></blockquote><h4 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h4><blockquote><p>json</p></blockquote><h4 id="请求Header参数"><a href="#请求Header参数" class="headerlink" title="请求Header参数"></a>请求Header参数</h4><table><thead><tr><th>参数名</th><th>示例值</th><th>参数类型</th><th>是否必填</th><th>参数描述</th></tr></thead><tbody><tr><td>T</td><td>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTQyMzM4OTUsIm5iZiI6MTY2MzEzMTY5NSwiaWF0IjoxNjYzMTI5ODk1LCJqdGkiOiJDTTpjYXRfbWF0Y2g6bHQxMjM0NTYiLCJvcGVuX2lkIjoiIiwidWlkIjoxOTI0OTg4MywiZGVidWciOiIiLCJsYW5nIjoiIn0.CeWygeMs8ibZsMBgEWU4iD1CnNX4E3_49LMnIA-XFkQ</td><td>Text</td><td>是</td><td>-</td></tr></tbody></table><h4 id="请求Query参数"><a href="#请求Query参数" class="headerlink" title="请求Query参数"></a>请求Query参数</h4><table><thead><tr><th>参数名</th><th>示例值</th><th>参数类型</th><th>是否必填</th><th>参数描述</th></tr></thead><tbody><tr><td>rank_score</td><td>1</td><td>Text</td><td>是</td><td>-</td></tr><tr><td>rank_state</td><td>1</td><td>Text</td><td>是</td><td>-</td></tr><tr><td>rank_time</td><td>547</td><td>Text</td><td>是</td><td>-</td></tr><tr><td>rank_role</td><td>1</td><td>Text</td><td>是</td><td>-</td></tr><tr><td>skin</td><td>1</td><td>Text</td><td>是</td><td>-</td></tr></tbody></table><h4 id="请求Body参数"><a href="#请求Body参数" class="headerlink" title="请求Body参数"></a>请求Body参数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h4 id="预执行脚本"><a href="#预执行脚本" class="headerlink" title="预执行脚本"></a>预执行脚本</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">暂无预执行脚本</span><br></pre></td></tr></table></figure><h4 id="后执行脚本"><a href="#后执行脚本" class="headerlink" title="后执行脚本"></a>后执行脚本</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">暂无后执行脚本</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本博客的一些插件和使用方法</title>
      <link href="/blog/2021/01/10/ben-bo-ke-de-yi-xie-cha-jian-he-shi-yong-fang-fa/"/>
      <url>/blog/2021/01/10/ben-bo-ke-de-yi-xie-cha-jian-he-shi-yong-fang-fa/</url>
      
        <content type="html"><![CDATA[<p>在这里把本博客的一些觉得有意思的插件和配置整理出来，作为自己的备忘录，同时也方便新手配置和学习。</p><p>本博客使用的hexo主题为<a href="https://github.com/tufu9441/maupassant-hexo">maupassant</a>，正如他的口号所言，<strong>大道至简</strong>。</p><p><a href="https://github.com/tufu9441/maupassant-hexo">maupassant</a>详细的基本配置信息，请参见此链接：<a href="https://www.haomwei.com/technology/maupassant-hexo.html">https://www.haomwei.com/technology/maupassant-hexo.html</a>，我们不必再次重复造轮子。</p><h1 id="创建新页面"><a href="#创建新页面" class="headerlink" title="创建新页面"></a>创建新页面</h1><p>配置完成后本地运行项目，发现项目中没有关于我和留言页面，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo new page guestbook <span class="comment"># 创建留言页面</span></span><br><span class="line">hexo new page about <span class="comment"># 创建关于我页面</span></span><br><span class="line">hexo new page <span class="built_in">history</span> <span class="comment"># 创建时间线页面</span></span><br></pre></td></tr></table></figure><p>这将在你的 source 目录下创建名为 guestbook、about、history 的文件夹，里面各包含一个 index.md 文件。</p><p>在_config.maupassant.yml文件找到对应属性进行配置</p><pre><code class="yaml">menu:  - page: home    directory: .    icon: fa-home  - page: archive    directory: archives/    icon: fa-archive  - page: history    directory: history/    icon: fa-book    - page: about    directory: about/    icon: fa-user    - page: guestbook    directory: guestbook/    icon: fa-comments    - page: rss    directory: atom.xml    icon: fa-rss</code></pre>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker快速部署Mastodon</title>
      <link href="/blog/2020/10/10/docker-kuai-su-bu-shu-mastodon/"/>
      <url>/blog/2020/10/10/docker-kuai-su-bu-shu-mastodon/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker快速部署Mastodon"><a href="#Docker快速部署Mastodon" class="headerlink" title="Docker快速部署Mastodon"></a>Docker快速部署Mastodon</h1><h2 id="安装需要的软件包"><a href="#安装需要的软件包" class="headerlink" title="安装需要的软件包"></a>安装需要的软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt -y update</span><br><span class="line">apt -y install curl git nginx python-certbot-nginx</span><br></pre></td></tr></table></figure><p>安装docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.docker.com/ | sh</span><br><span class="line">systemctl enable --now nginx docker</span><br></pre></td></tr></table></figure><p>安装docker-compose</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/docker/compose/releases/download/1.27.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><p>拉取mastodon项目文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/tootsuite/mastodon.git</span><br><span class="line">cd mastodon/</span><br></pre></td></tr></table></figure><p>复制一份配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp .env.production.sample .env.production</span><br></pre></td></tr></table></figure><p>把项目内自带的docker-compose.yml重命名或者删除都可，这个配置有问题🤨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv docker-compose.yml docker-compose.yml.bak</span><br></pre></td></tr></table></figure><p>新建一个<code>docker-compose.yml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano docker-compose.yml</span><br></pre></td></tr></table></figure><p>写入以下内容：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mastodon-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:9.6-alpine</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">256mb</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">mastodon</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">imlala</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;pg_isready&quot;</span>, <span class="string">&quot;-U&quot;</span>, <span class="string">&quot;postgres&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./postgres:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mastodon-redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.0-alpine</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mastodon-web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tootsuite/mastodon</span></span><br><span class="line">    <span class="attr">env_file:</span> <span class="string">.env.production</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">bash</span> <span class="string">-c</span> <span class="string">&quot;rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-redis</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;wget -q --spider --proxy=off localhost:3000/health || exit 1&quot;</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;127.0.0.1:3000:3000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./public/system:/mastodon/public/system</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mastodon-streaming:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tootsuite/mastodon</span></span><br><span class="line">    <span class="attr">env_file:</span> <span class="string">.env.production</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">node</span> <span class="string">./streaming</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-redis</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;wget -q --spider --proxy=off localhost:4000/api/v1/streaming/health || exit 1&quot;</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;127.0.0.1:4000:4000&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mastodon-sidekiq:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tootsuite/mastodon</span></span><br><span class="line">    <span class="attr">env_file:</span> <span class="string">.env.production</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">sidekiq</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mastodon-redis</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./public/system:/mastodon/public/system</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p>运行这个命令，进入配置向导</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose run --rm mastodon-web bundle exec rake mastodon:setup</span><br></pre></td></tr></table></figure><p>配置如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Domain name: # 填写你的域名</span><br><span class="line">Do you want to enable single user mode? # Yes</span><br><span class="line">Are you using Docker to run Mastodon? # Yes</span><br><span class="line">PostgreSQL host: # mastodon-db</span><br><span class="line">PostgreSQL port: # 5432</span><br><span class="line">Name of PostgreSQL database: # mastodon</span><br><span class="line">Name of PostgreSQL user: # imlala</span><br><span class="line">Password of PostgreSQL user: # 填你在compose内设置的密码</span><br><span class="line">Redis host: # mastodon-redis</span><br><span class="line">Redis port: # 6379</span><br><span class="line">Redis password: # 留空，直接回车</span><br><span class="line">Do you want to store uploaded files on the cloud? # No</span><br><span class="line">Do you want to send e-mails from localhost? # Yes</span><br><span class="line">Send a test e-mail with this configuration right now? # No</span><br><span class="line">Save configuration? Yes</span><br></pre></td></tr></table></figure><blockquote><p>这个配置的是单用户模式，也就是默认不开放注册，其次没有配置SMTP。接下来它会把你填写的配置打印出来，现在需要把你之前填的这些配置复制下来。</p></blockquote><p>⚠️注意到了一个非常坑的地方，接下来你会看到这个提示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Prepare the database now? (Y/n)</span><br></pre></td></tr></table></figure><p>不要选择Y或N，直接Ctrl+C退出来。然后清空如下配置文件内的默认配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &gt; .env.production</span><br></pre></td></tr></table></figure><p>编辑它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano .env.production</span><br></pre></td></tr></table></figure><p>把你之前通过向导复制的配置粘贴到里面保存后重新运行一次向导：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose run --rm mastodon-web bundle exec rake mastodon:setup</span><br></pre></td></tr></table></figure><p>这次的配置和之前的务必保持一致。再次来到下面这个位置的时候，就可以Yes了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Prepare the database now? (Y/n) # Yes</span><br><span class="line">Compile the assets now? (Y/n) # Yes</span><br></pre></td></tr></table></figure><p>接下来的步骤就是创建管理员账户了，继续跟着这个向导走就OK了。全部完成之后，up起来其他的服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>现在还需要把public的目录所有者改为容器内的，不然后续不能上传头像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R 991:991 public</span><br></pre></td></tr></table></figure><p>现在来复制一份nginx的站点配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /opt/mastodon/dist/nginx.conf /etc/nginx/conf.d/mastodon.conf</span><br></pre></td></tr></table></figure><p>编辑<code>mastodon.conf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/nginx/conf.d/mastodon.conf</span><br></pre></td></tr></table></figure><p>在这个配置文件内，官方都写好了模版，你只需要改动两个server块下面的位置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  listen [::]:80;</span><br><span class="line">  server_name imlala.best; # 换成你的域名</span><br><span class="line">  root /opt/mastodon/public; # public目录的绝对路径</span><br><span class="line">...</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  listen [::]:443 ssl http2;</span><br><span class="line">  server_name imlala.best; # 换成你的域名</span><br><span class="line">  root /opt/mastodon/public; # public目录的绝对路径</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用cerbot签发ssl证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cerbot --nginx</span><br></pre></td></tr></table></figure><p>Done，到这里就完成部署了。</p><p>后续要搬家，直接打包<code>opt/mastodon</code>这个目录就好了，传到别的机器内解压后直接up起来就可以了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(SOLVED)dial tcp lookup xxx on 1270053 read udp xxxx timeout</title>
      <link href="/blog/2020/07/30/solved-dial-tcp-lookup-api.cloudflare.com-on-127.0.0.53-read-udp-xxxx-timeout/"/>
      <url>/blog/2020/07/30/solved-dial-tcp-lookup-api.cloudflare.com-on-127.0.0.53-read-udp-xxxx-timeout/</url>
      
        <content type="html"><![CDATA[<p>[SOLVED]dial tcp: lookup api.cloudflare.com on 127.0.0.53:53: read udp 127.0.0.1:39199-&gt;127.0.0.53:53: i&#x2F;o timeout</p><p>DNS指向了127.0.0.53</p><p>解决办法：</p><p>Ubuntu修改DNS</p><ul><li>永久修改dns</li><li>临时修改dns</li></ul><p>决定系统dns的文件是<code>/etc/resolv.conf</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /etc/resolv.conf</span><br><span class="line">lrwxrwxrwx 1 root root 29 Jun  3 15:49 /etc/resolv.conf -&gt; ../run/systemd/resolve/stub-resolv.conf</span><br></pre></td></tr></table></figure><p>这个文件是一个软链接，改了只能临时起作用，重启后会失效。</p><h1 id="永久修改DNS"><a href="#永久修改DNS" class="headerlink" title="永久修改DNS"></a>永久修改DNS</h1><p>修改 <code>/etc/systemd/resolved.conf</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim  /etc/systemd/resolved.conf</span><br></pre></td></tr></table></figure><p>参数说明：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定 DNS 服务器，以空白分隔，支持 IPv4 或 IPv6 位置</span></span><br><span class="line">DNS=8.8.8.8 114.114.115.115</span><br><span class="line"><span class="comment"># 备用 DNS 服务器</span></span><br><span class="line">FallbackDNS=8.8.8.8</span><br><span class="line"><span class="comment"># 指定本地 DNS 域</span></span><br><span class="line">Domains=domain.com</span><br><span class="line"><span class="comment"># 设置 链路本地多播名称解析（Link-Local Multicast Name Resolution） 是否激活，可用的选项有 yes、no、resolve</span></span><br><span class="line">LLMNR=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 设置 多播 DNS（Multicast DNS） 是否激活，可用的选项有 yes、no、resolve</span></span><br><span class="line">MulticastDNS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 设置 DNS 安全扩展（DNS Security Extensions） 是否激活，可用的选项有 yes、no、allow-downgrade</span></span><br><span class="line">DNSSEC=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 设置 DNS 缓存 是否激活，可用的选项有 yes、no、no-negative</span></span><br><span class="line">Cache=no-negative</span><br><span class="line"><span class="comment"># 设置 通过 TLS 的 DNS，可用的选项有 yes、no 、opportunistic</span></span><br><span class="line">DNSOverTLS=opportunistic</span><br><span class="line"><span class="comment"># 设置 控制本地 DNS 监听器的行为，可用的选项有 yes、no 、udp</span></span><br><span class="line">DNSStubListener=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>完整示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Resolve]</span><br><span class="line">DNS=8.8.8.8 8.8.4.4</span><br><span class="line">FallbackDNS=1.1.1.1 1.0.0.1</span><br><span class="line">Domains=example.com</span><br><span class="line">LLMNR=<span class="built_in">yes</span></span><br><span class="line">MulticastDNS=<span class="built_in">yes</span></span><br><span class="line">DNSSEC=<span class="built_in">yes</span></span><br><span class="line">DNSOverTLS=opportunistic</span><br><span class="line">Cache=<span class="built_in">yes</span></span><br><span class="line">DNSStubListener=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>根据需要修改<code>resolved.conf</code>文件中的DNS，然后保存。</p><p>应用配置更改后，需要重新启动<code>systemd-resolved</code>服务以应用更改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart systemd-resolved</span><br></pre></td></tr></table></figure><p>要检查当前生效的配置，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolvectl status</span><br></pre></td></tr></table></figure><h1 id="临时修改DNS"><a href="#临时修改DNS" class="headerlink" title="临时修改DNS"></a>临时修改DNS</h1><p>如果我们临时使用的话，也可以临时修改DNS。</p><p>修改下面的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><p>加入要修改的DNS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure><p>如果多个DNS，就一行一个，修改之后保存退出即可；此方法修改后即刻生效，但重启后失效。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(SOLVED)运行flutter doctor时出错或者长时间无响应</title>
      <link href="/blog/2020/04/27/yun-xing-flutter-doctor-shi-chu-cuo-huo-zhe-chang-shi-jian-wu-xiang-ying/"/>
      <url>/blog/2020/04/27/yun-xing-flutter-doctor-shi-chu-cuo-huo-zhe-chang-shi-jian-wu-xiang-ying/</url>
      
        <content type="html"><![CDATA[<p>问题：运行 <code>flutter doctor</code> 时出错或者长时间无响应</p><p>在命令行中，pub 支持 <code>http_proxy</code> 和 <code>https_proxy</code> 环境变量。您可以按如下方式设置代理服务器环境变量。</p><p>On Linux&#x2F;macOS:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=hostname:port</span><br></pre></td></tr></table></figure><p>On Windows Command Prompt:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> https_proxy=hostname:port</span><br></pre></td></tr></table></figure><p>On Windows PowerShell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Env</span>:https_proxy=<span class="string">&quot;hostname:port&quot;</span></span><br></pre></td></tr></table></figure><p>If the proxy requires credentials, you can set them as follows.</p><p>On Linux&#x2F;macOS:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> https_proxy=username:password@hostname:port</span><br></pre></td></tr></table></figure><p>On Windows Command Prompt:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> https_proxy=username:password@hostname:port</span><br></pre></td></tr></table></figure><p>On Windows PowerShell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Env</span>:https_proxy=<span class="string">&quot;username:password@hostname:port&quot;</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/54343994/difficulty-getting-error-when-running-flutter-doctor">Difficulty getting error when running flutter doctor</a><br><a href="https://dart.dev/tools/pub/troubleshoot#pub-get-fails-from-behind-a-corporate-firewall">Pub get fails from behind a corporate firewall</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android设备连接到RS232外围设备的不同方式</title>
      <link href="/blog/2020/01/30/android-she-bei-lian-jie-dao-rs232-wai-wei-she-bei-de-bu-tong-fang-shi/"/>
      <url>/blog/2020/01/30/android-she-bei-lian-jie-dao-rs232-wai-wei-she-bei-de-bu-tong-fang-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>这描述了可用于将 Android 设备连接到 RS232 外围设备的不同方式。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p><img src="https://docs.google.com/drawings/pub?id=1ltkNApgZH9xUvzxF3xODOludDYqXwMsTRtSco9TzKC8&w=1203&h=702&nonsence=file.png" alt="img"></p><h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案 1"></a>解决方案 1</h2><ul><li>优点<ul><li>无需外部API，Android SDK提供类<a href="http://developer.android.com/reference/android/bluetooth/BluetoothSocket.html">BluetoothSocket</a></li><li>无需修改硬件</li><li>支持硬件流控</li></ul></li><li>缺点<ul><li>蓝牙耗电</li><li>高延迟</li><li>低带宽</li></ul></li><li>应用程序接口<ul><li><a href="http://developer.android.com/guide/topics/wireless/bluetooth.html">安卓开发工具包</a></li></ul></li></ul><h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案 2"></a>解决方案 2</h2><ul><li><p>优点</p><ul><li>USB 到 RS232 适配器便宜且容易找到</li><li>无需修改硬件</li><li>无需外部电池</li><li>低延迟</li><li>高带宽</li></ul></li><li><p>缺点</p><ul><li>您的 Android 设备需要一个 USB 主机连接器（大多数平板电脑有一个，但手机通常没有）</li><li>您可能需要 root 设备才能更改 &#x2F;dev&#x2F;ttyUSB0 文件权限，并加载内核模块。</li></ul></li><li><p>应用程序接口</p><ul><li>android-串口-api</li></ul></li></ul><h2 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案 3"></a>解决方案 3</h2><ul><li>优点<ul><li>最便宜的解决方案</li></ul></li><li>缺点<ul><li>必须构建硬件适配器 ( <a href="http://www.instructables.com/id/Android-G1-Serial-Cable">http://www.instructables.com/id/Android-G1-Serial-Cable</a> )</li><li>很少有Android设备兼容</li><li>不支持硬件流控制（仅 RX&#x2F;TX，无 RTS&#x2F;CTS 信号）</li></ul></li><li>应用程序接口<ul><li>android-串口-api</li></ul></li></ul><h2 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案 4"></a>解决方案 4</h2><ul><li>优点<ul><li>与任何带有 USB 从连接器的 Android 设备兼容，即 99.9% 的 Android 设备。</li><li>无需root你的手机</li><li>低延迟</li><li>高带宽</li><li>您可以同时使用微控制器的其他 GPIO</li></ul></li><li>缺点<ul><li><ul><li></li></ul></li></ul></li><li>应用程序接口<ul><li><a href="https://github.com/ytai/ioio/wiki/UART">UART</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> RS232 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>远程连接局域网内的Android模拟器</title>
      <link href="/blog/2019/12/26/yuan-cheng-lian-jie-ju-yu-wang-nei-de-android-mo-ni-qi/"/>
      <url>/blog/2019/12/26/yuan-cheng-lian-jie-ju-yu-wang-nei-de-android-mo-ni-qi/</url>
      
        <content type="html"><![CDATA[<p>本文主要介绍如何远程连接位于局域网内的 Android 模拟器进行调试。我们知道 Android 模拟器十分耗费资源，如果这时候有一台空余的机器，可以单独运行一个 Android 模拟器，然后再远程连接到该模拟器，从而能够减轻工作机的负担。</p><p>原理:使用 SSH 进行端口映射</p><h1 id="１-在空余机器打开Android模拟器，并打开Terminal终端，输入adb-devices查看模拟器ip-端口"><a href="#１-在空余机器打开Android模拟器，并打开Terminal终端，输入adb-devices查看模拟器ip-端口" class="headerlink" title="１.在空余机器打开Android模拟器，并打开Terminal终端，输入adb devices查看模拟器ip+端口"></a>１.在空余机器打开Android模拟器，并打开Terminal终端，输入adb devices查看模拟器ip+端口</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb devices</span></span><br><span class="line">List of devices attached/</span><br><span class="line">192.168.58.102:5555device</span><br></pre></td></tr></table></figure><h1 id="2-在运行AndroidStudio的机器上打开Terminal终端，ssh连接空余机器并将Android模拟器映射到本地localhost-15555，连接成功后注意不要关闭该窗口"><a href="#2-在运行AndroidStudio的机器上打开Terminal终端，ssh连接空余机器并将Android模拟器映射到本地localhost-15555，连接成功后注意不要关闭该窗口" class="headerlink" title="2.在运行AndroidStudio的机器上打开Terminal终端，ssh连接空余机器并将Android模拟器映射到本地localhost:15555，连接成功后注意不要关闭该窗口"></a>2.在运行AndroidStudio的机器上打开Terminal终端，ssh连接空余机器并将Android模拟器映射到本地localhost:15555，连接成功后注意不要关闭该窗口</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22 -L localhost:15555:192.168.58.102:5555 xmaihh@192.168.200.189</span><br></pre></td></tr></table></figure><h1 id="3-在运行AndroidStudio的机器上打开新的Terminal终端，连接Android模拟器"><a href="#3-在运行AndroidStudio的机器上打开新的Terminal终端，连接Android模拟器" class="headerlink" title="3.在运行AndroidStudio的机器上打开新的Terminal终端，连接Android模拟器"></a>3.在运行AndroidStudio的机器上打开新的Terminal终端，连接Android模拟器</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb connect localhost:15555</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Kotlin编写Android自定义View</title>
      <link href="/blog/2019/12/24/shi-yong-kotlin-bian-xie-android-zi-ding-yi-view/"/>
      <url>/blog/2019/12/24/shi-yong-kotlin-bian-xie-android-zi-ding-yi-view/</url>
      
        <content type="html"><![CDATA[<h1 id="使用-Kotlin-编写-Android-自定义-View"><a href="#使用-Kotlin-编写-Android-自定义-View" class="headerlink" title="使用 Kotlin 编写 Android 自定义 View"></a>使用 Kotlin 编写 Android 自定义 View</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由于 Kotlin 的构造函数与 Java 的构造函数在样子上十分不同, 导致使用 Kotlin 编写 Android 自定义 View 时会遇到一些困难.</p><p>在本篇中将记录我对此的一些学习心得.</p><h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><p>Kotlin 自定义 View 的构造函数写法有两种, 我们分别来看.</p><p>Android 的自定义 View 包含有多个构造函数, 如何用 Kotlin 实现呢?</p><h1 id="写法一"><a href="#写法一" class="headerlink" title="写法一"></a>写法一</h1><p>第一种写法与 Java 构造函数类似, 代码如下:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KotlinView</span> : <span class="type">View</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">constructor</span>(context: Context) : <span class="keyword">this</span>(context, <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">constructor</span>(context: Context, attrs: AttributeSet?) : <span class="keyword">this</span>(context, attrs, <span class="number">0</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">constructor</span>(context: Context, attrs: AttributeSet?, defStyleAttr: <span class="built_in">Int</span>) : <span class="keyword">super</span>(context, attrs, defStyleAttr) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与使用 Java 的构造函数对比一下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaView</span> <span class="keyword">extends</span> <span class="title class_">View</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaView</span> <span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaView</span> <span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaView</span> <span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这样就很容易理解了.</p><h1 id="写法二"><a href="#写法二" class="headerlink" title="写法二"></a>写法二</h1><p>另一种写法如下:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomComponent</span> : <span class="type">LinearLayout</span> &#123;</span><br><span class="line">    <span class="meta">@JvmOverloads</span></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">        context: Context, </span><br><span class="line">        attrs: AttributeSet? = <span class="literal">null</span>, </span><br><span class="line">        defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span>)</span><br><span class="line">        : <span class="keyword">super</span>(context, attrs, defStyleAttr)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line">    <span class="keyword">constructor</span>(</span><br><span class="line">       context: Context, </span><br><span class="line">       attrs: AttributeSet?, </span><br><span class="line">       defStyleAttr: <span class="built_in">Int</span>, </span><br><span class="line">       defStyleRes: <span class="built_in">Int</span>)</span><br><span class="line">        : <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中, 这里使用了 Kotlin 构造函数的参数可以指定默认值的特性. <code>@JvmOverloads</code> 是一个 Kotlin 注解, 作用是替换构造函数的默认值生成多个版本的重载构造方法.</p><h1 id="inflate-视图"><a href="#inflate-视图" class="headerlink" title="inflate 视图"></a>inflate 视图</h1><p>有一个常见的场景是, 我们在自定义视图中需要 inflate 一个 xml 布局, 在 Kotlin 中的做法是写在 init 中:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    LayoutInflater</span><br><span class="line">        .from(context)</span><br><span class="line">        .inflate(R.layout.view_custom_component, <span class="keyword">this</span>, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="解析自定义-View-属性"><a href="#解析自定义-View-属性" class="headerlink" title="解析自定义 View 属性"></a>解析自定义 View 属性</h1><p>自定义 View 往往会声明一些属性, 用于在 xml 中设置.</p><p>在这里, 关于如何 declare-styleable 如何写 xml 这些基础内容我们都省略, 只看与 Kotlin 相关的关键步骤, 如何解析 StyledAttributes, 代码如下:</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">attrs?.let &#123;</span><br><span class="line">    <span class="keyword">val</span> typedArray = context.obtainStyledAttributes(it, </span><br><span class="line">        R.styleable.custom_component_attributes, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> title = resources.getText(typedArray</span><br><span class="line">            .getResourceId(R.styleable</span><br><span class="line">            .custom_component_attributes_custom_component_title,           </span><br><span class="line">            R.string.component_one))</span><br><span class="line"></span><br><span class="line">    my_title.text = title</span><br><span class="line">    my_edit.hint = </span><br><span class="line">        <span class="string">&quot;<span class="subst">$&#123;resources.getString(R.string.hint_text)&#125;</span> <span class="variable">$title</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    typedArray.recycle()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是, 对于写法一, 在 init {} 是拿不到 attrs, 因此需要写一个私有的初始化方法, 在各个构造函数中显式调用. 对于写法二, 直接在 init {} 中编写即可.</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://steemit.com/kotlin/@maxiee/kotlin-android-view">使用 Kotlin 编写 Android 自定义 View</a></p><p><a href="https://antonioleiva.com/custom-views-android-kotlin/">Custom Views in Android with Kotlin (KAD 06)</a></p><p><a href="https://android.jlelse.eu/building-custom-component-with-kotlin-fc082678b080">Building Custom Component with Kotlin</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java中double转int类型按四舍五入取整</title>
      <link href="/blog/2019/12/11/java-zhong-double-zhuan-int-lei-xing-an-si-she-wu-ru-qu-zheng/"/>
      <url>/blog/2019/12/11/java-zhong-double-zhuan-int-lei-xing-an-si-she-wu-ru-qu-zheng/</url>
      
        <content type="html"><![CDATA[<p>Java中的double转int类型，小数点后面抹零，只取小数点前的整数<br>所以被踩了丢失精度的坑，后续在将小数的double转换成为int的时候，一定要注意，小数点后面的部分是自动抹去的。<br>例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span><span class="number">1.76</span>;</span><br><span class="line">System.out.println((<span class="type">int</span>)d);</span><br><span class="line"><span class="type">double</span> <span class="variable">f</span> <span class="operator">=</span><span class="number">1.16</span>;</span><br><span class="line">System.out.println((<span class="type">int</span>)f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出是:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p>正确double转int按四舍五入取整</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;向上取整:&quot;</span> + (<span class="type">int</span>) Math.ceil(<span class="number">96.1</span>));<span class="comment">// 97 (去掉小数凑整:不管小数是多少，都进一)</span></span><br><span class="line">        System.out.println(<span class="string">&quot;向下取整&quot;</span> + (<span class="type">int</span>) Math.floor(<span class="number">96.8</span>));<span class="comment">// 96 (去掉小数凑整:不论小数是多少，都不进位)</span></span><br><span class="line">        System.out.println(<span class="string">&quot;四舍五入取整:&quot;</span> + Math.round(<span class="number">96.1</span>));<span class="comment">// 96 (这个好理解，不解释)</span></span><br><span class="line">        System.out.println(<span class="string">&quot;四舍五入取整:&quot;</span> + Math.round(<span class="number">96.8</span>));<span class="comment">// 97</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">向上取整: <span class="number">97</span></span><br><span class="line">向下取整: <span class="number">96</span></span><br><span class="line">四舍五入取整:<span class="number">96</span></span><br><span class="line">四舍五人取整:<span class="number">97</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java位运算(移位、与、或、异或、非)</title>
      <link href="/blog/2019/11/05/java-wei-yun-suan-yi-wei-yu-huo-yi-huo-fei/"/>
      <url>/blog/2019/11/05/java-wei-yun-suan-yi-wei-yu-huo-yi-huo-fei/</url>
      
        <content type="html"><![CDATA[<p>Java的位运算符：左移（&lt;&lt;）、右移（&gt;&gt;）、无符号右移（&gt;&gt;&gt;）、与（&amp;）、异或（|）、非（~）<br>除了 非(~) 是一元操作符外，其他都是二元操作符。</p><table><thead><tr><th>运算符</th><th>运算</th><th>说明</th></tr></thead><tbody><tr><td>&lt;&lt;</td><td>左移</td><td>空位补0,被移除的高位丢失</td></tr><tr><td>&gt;&gt;</td><td>右移</td><td>被移位的二进制最高位是0,右移后，空缺位补0,最高位是1,最高位补1</td></tr><tr><td>&gt;&gt;&gt;</td><td>无符号右移</td><td>被移位的二进制无论是０或者是１，空缺位都是用０补</td></tr><tr><td>&amp;</td><td>与运算</td><td>任何二进制位和0进行&amp;运算，结果都是0，和１进行&amp;运算，都是原值</td></tr><tr><td>l</td><td>或运算</td><td>任何二进制位和０进行或运算，结果都是原值，和1进行或运算，都是1</td></tr><tr><td>^</td><td>异或运算</td><td>任何相同二进制位进行异或运算，结果都是０，不同二进制位进行异或运算，结果都是１</td></tr><tr><td>~</td><td>非运算</td><td>反转操作数的二进制位，即0变成1，1变成0</td></tr></tbody></table><ol><li><p>左移(&lt;&lt;)</p><p>​示例1: 将５左移２位</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">5</span> &lt;&lt; <span class="number">2</span>);<span class="comment">//运行结果是20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>java</code>中，整数默认就是<code>int</code>类型32位，首先将５转为二进制表示:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000 0000 0000 0000 0000 0000 0000 0101      然后左移2位后，低位补0</span><br><span class="line"></span><br><span class="line">0000 0000 0000 0000 0000 0000 0001 0100      换算成10进制为20</span><br></pre></td></tr></table></figure></li><li><p>右移(&gt;&gt;)</p><p>​示例2: 将５右移２位</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">5</span>&gt;&gt;<span class="number">2</span>);<span class="comment">//运行结果是1</span></span><br></pre></td></tr></table></figure><p>还是先将５转为二进制表示:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000 0000 0000 0000 0000 0000 0000 0101      然后右移2位，高位补0</span><br><span class="line"></span><br><span class="line">0000 0000 0000 0000 0000 0000 0000 0001      换算成10进制为１</span><br></pre></td></tr></table></figure></li><li><p>无符号右移(&gt;&gt;&gt;)</p><p>​示例3: 分别将５右移3位、将-５右移３位、将-5无符号右移３位</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">5</span>&gt;&gt;<span class="number">3</span>);<span class="comment">//结果是0</span></span><br><span class="line">System.out.println(-<span class="number">5</span>&gt;&gt;<span class="number">3</span>);<span class="comment">//结果是-1</span></span><br><span class="line">System.out.println(-<span class="number">5</span>&gt;&gt;&gt;<span class="number">3</span>);<span class="comment">//结果是536870911</span></span><br></pre></td></tr></table></figure><p>还是来看看位移过程:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">5换算成二进制： 0000 0000 0000 0000 0000 0000 0000 0101</span><br><span class="line">5右移3位后结果为0，0的二进制为： 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line"></span><br><span class="line">-5换算成二进制： 1111 1111 1111 1111 1111 1111 1111 1011</span><br><span class="line">-5右移3位后结果为-1，-1的二进制为： 1111 1111 1111 1111 1111 1111 1111 1111</span><br><span class="line">-5无符号右移3位后的结果 536870911 换算成二进制： 0001 1111 1111 1111 1111 1111 1111 1111</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>正数右移，高位用0补，负数右移，高位用1补，当负数使用无符号右移时，用0进行部位(自然而然的，就由负数变成了正数了)</p></blockquote><ol start="4"><li><p>与(&amp;)</p><p>​示例4: 5&amp;3 进行与运算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">5</span> &amp; <span class="number">3</span>);<span class="comment">//结果为1</span></span><br></pre></td></tr></table></figure><p>转换为二进制比较:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5转换为二进制：0000 0000 0000 0000 0000 0000 0000 0101</span><br><span class="line">3转换为二进制：0000 0000 0000 0000 0000 0000 0000 0011</span><br><span class="line"></span><br><span class="line">1转换为二进制：0000 0000 0000 0000 0000 0000 0000 0001</span><br></pre></td></tr></table></figure><blockquote><p>与(&amp;)第一个操作数的的第n位于第二个操作数的第n位如果都是1，那么结果的第n为也为1，否则为0</p></blockquote></li><li><p>或(|)</p><p>​示例5: 5|3 进行或运算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">5</span> | <span class="number">3</span>);<span class="comment">//结果为7</span></span><br></pre></td></tr></table></figure><p>转换为二进制比较:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5转换为二进制：0000 0000 0000 0000 0000 0000 0000 0101</span><br><span class="line">3转换为二进制：0000 0000 0000 0000 0000 0000 0000 0011</span><br><span class="line"></span><br><span class="line">7转换为二进制：0000 0000 0000 0000 0000 0000 0000 0111</span><br></pre></td></tr></table></figure><blockquote><p>或(|)第一个操作数的的第n位于第二个操作数的第n位 只要有一个是1，那么结果的第n为也为1，否则为0</p></blockquote></li><li><p>异或(^)</p><p>​示例6: 5^3 进行异或运算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">5</span> ^ <span class="number">3</span>);<span class="comment">//结果为6</span></span><br></pre></td></tr></table></figure><p>转换为二进制比较:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5转换为二进制：0000 0000 0000 0000 0000 0000 0000 0101</span><br><span class="line">3转换为二进制：0000 0000 0000 0000 0000 0000 0000 0011</span><br><span class="line"></span><br><span class="line">6转换为二进制：0000 0000 0000 0000 0000 0000 0000 0110</span><br></pre></td></tr></table></figure><blockquote><p>异或(^)第一个操作数的的第n位于第二个操作数的第n位 相反，那么结果的第n为也为1，否则为0</p></blockquote></li><li><p>非(~)</p><p>​示例7: ~5 进行非运算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(~<span class="number">5</span>);<span class="comment">//结果为-6</span></span><br></pre></td></tr></table></figure><p>转换为二进制比较:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5转换为二进制：0000 0000 0000 0000 0000 0000 0000 0101</span><br><span class="line">-6转换为二进制：1111 1111 1111 1111 1111 1111 1111 1010</span><br></pre></td></tr></table></figure><blockquote><p>非：操作数的第n位为1，那么结果的第n位为0，反之。</p></blockquote></li></ol><p>位运算操作符衍生而来的有：</p><ul><li><p>&amp;&#x3D; 按位与赋值</p></li><li><p>|&#x3D; 按位或赋值</p></li><li><p>^&#x3D; 按位非赋值</p></li><li><p>&gt;&gt;&#x3D; 右移赋值</p></li><li><p>&#x3D; 无符号右移赋值</p></li><li><p>&lt;&lt;&#x3D; 赋值左移</p></li></ul><p>和 +&#x3D; 一个概念。</p><p>示例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">a &amp;= <span class="number">3</span>; <span class="comment">//此时等同于　a = a&amp;3　即　ａ = 5＆３; </span></span><br><span class="line">System.out.println(a);<span class="comment">//结果是1</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/xiaochunyong/article/details/7748713">Java 位运算</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序开发的内容安全审核</title>
      <link href="/blog/2019/10/20/xiao-cheng-xu-kai-fa-de-nei-rong-an-quan-shen-he/"/>
      <url>/blog/2019/10/20/xiao-cheng-xu-kai-fa-de-nei-rong-an-quan-shen-he/</url>
      
        <content type="html"><![CDATA[<p>最近做一个带图片和文字发布的微信小程序，当时心里犯嘀咕，没有自我审查估摸着上不了。果不其然微信小程序提交代码审核的时候，审核不通过，提示如下:为避免您的小程序被滥用，请你完善内容审核机制，如调用小程序内容安全API，或使用其他技术、人工审核手段，过滤色情、违法等有害信息，保障发布内容的安全。<br>得，去到后台一看，审核员测试了一个词<code>xxx</code>给显示出来了，直接导致小程序不通过。<br><img src="https://i.loli.net/2019/11/22/W9agLfOjtbvFyoM.png"></p><p>好在提示给了解决方案，因此这里做一下记录。</p><h1 id="调用小程序内容安全API"><a href="#调用小程序内容安全API" class="headerlink" title="调用小程序内容安全API"></a>调用小程序内容安全API</h1><ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.imgSecCheck.html">校验一张图片是否含有违法违规内容</a></li><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.mediaCheckAsync.html">异步校验图片&#x2F;音频是否含有违法违规内容</a></li><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html">检查一段文本是否含有违法违规内容</a></li></ul><p>还挺全，我主要用到了图片和文字审查，所以对<code>security.imgSecCheck</code>和<code>security.msgSecCheck</code>的使用做记录。</p><img src="https://i.loli.net/2019/11/22/UvmjLFTXAphqdlD.png" style="zoom:50%;" /><h1 id="开通云开发"><a href="#开通云开发" class="headerlink" title="开通云开发"></a>开通云开发</h1><p>在微信开发者工具打开你的小程序工程，点击“云开发”菜单进去，之前没开的按照提示填写云开发环境名称就好。</p><p><img src="https://i.loli.net/2019/11/22/wLgMkAFEbOeIVPH.png"></p><h1 id="创建云函数"><a href="#创建云函数" class="headerlink" title="创建云函数"></a>创建云函数</h1><p>在你小程序工程的<code>app.js</code>同级目录下创建一个文件夹<code>functions</code>来存放云函数</p><p><img src="https://i.loli.net/2019/11/22/35T7Gke9bxDOacA.png"></p><p>并在<code>project.config.json</code>中配置<code>&quot;cloudfunctionRoot&quot;: &quot;functions/&quot;,</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;项目配置文件&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cloudfunctionRoot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;functions/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;packOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ignore&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span> ...</span><br><span class="line">.......</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/11/22/th5suyaJXiNWeK8.png"></p><p>编译一下，可以看到<code>functions</code>文件夹有变化后面加上了你之前创建的环境名。右键<code>functions</code>文件夹唤出菜单新建<code>Node.js</code>云函数</p><p><img src="https://i.loli.net/2019/11/22/aytDq2p1cdun4xj.png"></p><p>我这里创建了一个名称叫<code>ContentCheck</code>的云函数，调用<code>security.imgSecCheck</code>和<code>security.msgSecCheck</code>需要声明权限，需要配置一个<code>config.json</code>文件，如果目录文件中没有<code>config.json</code>，需要自己建一个。</p><p><img src="https://i.loli.net/2019/11/22/xmzKXBnf69LhR5V.png"></p><p><strong>config.json</strong>的配置如下:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;permissions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;openapi&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;security.msgSecCheck&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;security.imgSecCheck&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>ContentCheck</strong>云函数的目录结构如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├─checkContent</span><br><span class="line">│      config.<span class="property">json</span>    <span class="comment">//云调用的权限配置</span></span><br><span class="line">│      index.<span class="property">js</span>       <span class="comment">//云服务器node 入口文件</span></span><br><span class="line">│      package.<span class="property">json</span>   <span class="comment">// NPM包依赖</span></span><br><span class="line">│ ...</span><br></pre></td></tr></table></figure><p>编辑<code>ContentCheck</code>云函数目录下的<code>index.js</code>文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 云函数入口文件</span></span><br><span class="line"><span class="keyword">const</span> cloud = <span class="built_in">require</span>(<span class="string">&#x27;wx-server-sdk&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cloud.<span class="title function_">init</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 云函数入口函数</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">main</span> = <span class="title function_">async</span>(event, context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> msgR = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> imageR = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//  检查文本内容是否违规</span></span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">msg</span>) &#123;</span><br><span class="line">      msgR = <span class="keyword">await</span> cloud.<span class="property">openapi</span>.<span class="property">security</span>.<span class="title function_">msgSecCheck</span>(&#123;</span><br><span class="line">        <span class="attr">content</span>: event.<span class="property">msg</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  检查图像内容是否违规</span></span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">img</span>) &#123;</span><br><span class="line">      imageR = <span class="keyword">await</span> cloud.<span class="property">openapi</span>.<span class="property">security</span>.<span class="title function_">imgSecCheck</span>(&#123;</span><br><span class="line">        <span class="attr">media</span>: &#123;</span><br><span class="line">          <span class="attr">header</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">contentType</span>: <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">          <span class="attr">value</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(event.<span class="property">img</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      msgR,</span><br><span class="line">      imageR</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> e</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编辑完云函数之后，右键<code>ContentCheck</code>唤起菜单选择 上传并部署：云端安装依赖<br><img src="https://i.loli.net/2019/11/22/Ho3zqjR9NIuPp5y.png"></p><p><strong>注意</strong><br>使用微信小程序云函数开发本地需要实现安装好Node.js环境，并配置好环境变量，之前新电脑没装Node.js环境导致上传的云函数老是调用失败，解决办法是安装好Node.js就好了。<br>验证Node.js是否安装<code>npm -v</code>和<code>node -version</code></p><p><img src="https://i.loli.net/2019/11/22/JN8oOtmIZSE3zMV.png"></p><h1 id="调用云函数"><a href="#调用云函数" class="headerlink" title="调用云函数"></a>调用云函数</h1><p>在<code>app.js</code>初始化云环境，参数<code>env</code>可以在云开发的设置中可以看到当前的环境ID</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="title class_">App</span>(&#123;</span><br><span class="line">  <span class="attr">onLaunch</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    wx.<span class="property">cloud</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">      <span class="attr">env</span>: <span class="string">&quot;manjaro-7l50h&quot;</span>,</span><br><span class="line">      <span class="attr">traceUser</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/11/22/nxMyfWwH4eO6oD7.png"></p><ol><li><p>检查文字是否违规</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//  调用ContentCheck云函数检查文字是否违规</span></span><br><span class="line">   wx.<span class="property">cloud</span>.<span class="title function_">callFunction</span>(&#123;</span><br><span class="line">     <span class="attr">name</span>: <span class="string">&#x27;ContentCheck&#x27;</span>,</span><br><span class="line">     <span class="attr">data</span>: &#123;</span><br><span class="line">       <span class="attr">msg</span>: _this.<span class="property">data</span>.<span class="property">msg</span>,</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="title function_">success</span>(<span class="params">res</span>) &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">result</span>)</span><br><span class="line">       <span class="keyword">if</span> (res.<span class="property">result</span>.<span class="property">msgR</span>.<span class="property">errCode</span> == <span class="number">87014</span>) &#123;</span><br><span class="line">         wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">           <span class="attr">title</span>: <span class="string">&#x27;文字违规&#x27;</span>,</span><br><span class="line">         &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文字违规打印的console.log(res.result)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">msgR</span>: &#123;</span><br><span class="line"><span class="attr">errCode</span>: <span class="number">87014</span>,</span><br><span class="line"><span class="attr">errMsg</span>: <span class="string">&quot;openapi.security.msgSecCheck:fail risky content hint: [cSp9ka06218622]&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">imageR</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 文字正常打印的console.log(res.result)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">msgR</span>: &#123;</span><br><span class="line"><span class="attr">errCode</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">errMsg</span>: <span class="string">&quot;openapi.security.msgSecCheck:ok&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">imageR</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>检查图片是否违规</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  调用ContentCheck云函数检查图片是否违规</span></span><br><span class="line">   wx.<span class="property">cloud</span>.<span class="title function_">callFunction</span>(&#123;</span><br><span class="line">     <span class="attr">name</span>: <span class="string">&#x27;ContentCheck&#x27;</span>,</span><br><span class="line">     <span class="attr">data</span>: &#123;</span><br><span class="line">       <span class="attr">img</span>: _this.<span class="property">data</span>.<span class="property">img</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="title function_">success</span>(<span class="params">res</span>) &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">result</span>)</span><br><span class="line">       <span class="keyword">if</span>(res.<span class="property">result</span>.<span class="property">imageR</span>.<span class="property">errCode</span> == <span class="number">87014</span>)&#123;</span><br><span class="line">         wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">           <span class="attr">title</span>: <span class="string">&#x27;图片违规&#x27;</span>,</span><br><span class="line">         &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 图片违规打印的console.log(res.result)</span></span><br><span class="line">   &#123;</span><br><span class="line">   <span class="attr">msgR</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">imageR</span>: &#123;</span><br><span class="line">   <span class="attr">errCode</span>: <span class="number">87014</span>,</span><br><span class="line">   <span class="attr">errMsg</span>: <span class="string">&quot;openapi.security.imgSecCheck:fail risky content hint: [LGrV.a05623955]&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 图片正常打印的console.log(res.result)</span></span><br><span class="line">   &#123;</span><br><span class="line">   <span class="attr">msgR</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">imageR</span>: &#123;</span><br><span class="line">   <span class="attr">errCode</span>: <span class="number">0</span>,</span><br><span class="line">   <span class="attr">errMsg</span>: <span class="string">&quot;openapi.security.imgSecCheck:ok&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ol><p><a href="https://github.com/xmaihh/Gamecode/tree/master/contentSecCheck">完整例子 contentSecCheck</a></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.imgSecCheck.html">微信小程序官方文档</a><br><a href="https://segmentfault.com/a/1190000019955207">小程序评论回复和发帖功能实战</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> weixin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter开发中的页面跳转和传值</title>
      <link href="/blog/2019/10/13/flutter-kai-fa-zhong-de-ye-mian-tiao-zhuan-he-chuan-zhi/"/>
      <url>/blog/2019/10/13/flutter-kai-fa-zhong-de-ye-mian-tiao-zhuan-he-chuan-zhi/</url>
      
        <content type="html"><![CDATA[<p>在Android原生开发中,页面跳转用Intent类实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>,SecondActivity.class);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure><p>而在安卓原生开发中，页面传值有多种方法，常见的可以用intent、Bundle、自定义类、静态变量等等来传值。<br>Flutter提供了两种方法路由，分别是 <a href="https://flutter.dev/docs/cookbook/navigation/navigation-basics">Navigator.push()</a>  以及 <a href="https://flutter.dev/docs/cookbook/navigation/named-routes">Navigator.pushNamed()</a> 。</p><blockquote><p>此文基于 Flutter版本 Channel stable，v1.9.1+hotfix.2</p></blockquote><h1 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h1><h2 id="构建路由Navigator-push"><a href="#构建路由Navigator-push" class="headerlink" title="构建路由Navigator.push()"></a>构建路由Navigator.push()</h2><ol><li>Navigator.push()<br>从第一个页面(FirstPage())跳转到第二个页面(SecondPage())<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Within the `FirstPage` widget</span></span><br><span class="line">onPressed: () &#123;</span><br><span class="line">  Navigator.push(</span><br><span class="line">    context,</span><br><span class="line">    MaterialPageRoute(builder: (context) =&gt; SecondPage()),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>使用<code>Navigator.pop()</code>回到第一个页面(FirstPage())<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Within the SecondPage widget</span></span><br><span class="line">onPressed: () &#123;</span><br><span class="line">  Navigator.pop(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="命名路由Navigator-pushNamed"><a href="#命名路由Navigator-pushNamed" class="headerlink" title="命名路由Navigator.pushNamed()"></a>命名路由Navigator.pushNamed()</h2><ol><li>Navigator.pushNamed()<br>首先需要定义一个<code>routes</code><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MaterialApp(</span><br><span class="line">  <span class="comment">// home: FirstPage(),</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Start the app with the &quot;/&quot; named route. In this case, the app starts</span></span><br><span class="line">  <span class="comment">// on the FirstPage widget.</span></span><br><span class="line">  initialRoute: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  routes: &#123;</span><br><span class="line">    <span class="comment">// When navigating to the &quot;/&quot; route, build the FirstPage widget.</span></span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>: (context) =&gt; FirstPage(),</span><br><span class="line">    <span class="comment">// When navigating to the &quot;/second&quot; route, build the SecondPage widget.</span></span><br><span class="line">    <span class="string">&#x27;/second&#x27;</span>: (context) =&gt; SecondPage(),</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>注意这里定义了<code>initialRoute</code>之后，就不能定义<code>home</code>属性。应该把之前定义的<code>home</code>属性注释掉。<br><code>initialRoute</code>属性不能与<code>home</code>共存，只能选一个。</p></blockquote><ol start="2"><li>从第一个页面(FirstPage())跳转到第二个页面(SecondPage())</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Within the `FirstPage` widget</span></span><br><span class="line">onPressed: () &#123;</span><br><span class="line">  <span class="comment">// Navigate to the second page using a named route.</span></span><br><span class="line">  Navigator.pushNamed(context, <span class="string">&#x27;/second&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>Navigator.pop()</code>回到第一个页面(FirstPage())</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Within the SecondPage widget</span></span><br><span class="line">onPressed: () &#123;</span><br><span class="line">  Navigator.pop(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="传值跳转"><a href="#传值跳转" class="headerlink" title="传值跳转"></a>传值跳转</h1><h2 id="构建路由Navigator-push-1"><a href="#构建路由Navigator-push-1" class="headerlink" title="构建路由Navigator.push()"></a>构建路由Navigator.push()</h2><ol><li>首先定义需要传的值</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// You can pass any object to the arguments parameter.</span></span><br><span class="line"><span class="comment">// In this example, create a class that contains a customizable</span></span><br><span class="line"><span class="comment">// title and message.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScreenArguments</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> message;</span><br><span class="line"></span><br><span class="line">  ScreenArguments(<span class="keyword">this</span>.title, <span class="keyword">this</span>.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>第二个页面(SecondPage())接受传值</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A widget that extracts the necessary arguments from the ModalRoute.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// Extract the arguments from the current ModalRoute settings and cast</span></span><br><span class="line">    <span class="comment">// them as ScreenArguments.</span></span><br><span class="line">    <span class="keyword">final</span> ScreenArguments args = ModalRoute.of(context).settings.arguments;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(args.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(args.message),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>从第一个页面(FirstPage())传值<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">onPressed: () &#123;</span><br><span class="line">    <span class="comment">// When the user taps the button, navigate to the specific route</span></span><br><span class="line">    <span class="comment">// and provide the arguments as part of the RouteSettings.</span></span><br><span class="line">    Navigator.push(</span><br><span class="line">      context,</span><br><span class="line">      MaterialPageRoute(</span><br><span class="line">        builder: (context) =&gt; SecondPage(),</span><br><span class="line">        <span class="comment">// Pass the arguments as part of the RouteSettings. The</span></span><br><span class="line">        <span class="comment">// ExtractArgumentScreen reads the arguments from these</span></span><br><span class="line">        <span class="comment">// settings.</span></span><br><span class="line">        settings: RouteSettings(</span><br><span class="line">          arguments: ScreenArguments(</span><br><span class="line">            <span class="string">&#x27;Extract Arguments Screen&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;This message is extracted in the build method.&#x27;</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="命名路由Navigator-pushNamed-1"><a href="#命名路由Navigator-pushNamed-1" class="headerlink" title="命名路由Navigator.pushNamed()"></a>命名路由Navigator.pushNamed()</h2><ol><li>首先定义需要传的值</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// You can pass any object to the arguments parameter.</span></span><br><span class="line"><span class="comment">// In this example, create a class that contains a customizable</span></span><br><span class="line"><span class="comment">// title and message.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScreenArguments</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> message;</span><br><span class="line"></span><br><span class="line">  ScreenArguments(<span class="keyword">this</span>.title, <span class="keyword">this</span>.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>其次定义一下<code>routes</code></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  MaterialApp(</span><br><span class="line">  <span class="comment">// Provide a function to handle named routes. Use this function to</span></span><br><span class="line">  <span class="comment">// identify the named route being pushed, and create the correct</span></span><br><span class="line">  <span class="comment">// Screen.</span></span><br><span class="line">  onGenerateRoute: </span><br><span class="line">      (settings) &#123;</span><br><span class="line">    <span class="comment">// If you push the PassArguments route</span></span><br><span class="line">    <span class="keyword">if</span> (settings.name == <span class="string">&quot;/passArguments&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Cast the arguments to the correct type: ScreenArguments.</span></span><br><span class="line">      <span class="keyword">final</span> ScreenArguments args = settings.arguments;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Then, extract the required data from the arguments and</span></span><br><span class="line">      <span class="comment">// pass the data to the correct screen.</span></span><br><span class="line">      <span class="keyword">return</span> MaterialPageRoute(</span><br><span class="line">        builder: (context) &#123;</span><br><span class="line">          <span class="keyword">return</span> SecondPage(</span><br><span class="line">            title: args.title,</span><br><span class="line">            message: args.message,</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>第二个页面(SecondPage())接受传值</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Widget that accepts the necessary arguments via the constructor.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> message;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This Widget accepts the arguments as constructor parameters. It does not</span></span><br><span class="line">  <span class="comment">// extract the arguments from the ModalRoute.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The arguments are extracted by the onGenerateRoute function provided to the</span></span><br><span class="line">  <span class="comment">// MaterialApp widget.</span></span><br><span class="line">  <span class="keyword">const</span> SecondPage(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.title,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.message,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(message),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>从第一个页面(FirstPage())传值</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">onPressed: () &#123;</span><br><span class="line">  <span class="comment">// When the user taps the button, navigate to a named route</span></span><br><span class="line">  <span class="comment">// and provide the arguments as an optional parameter.</span></span><br><span class="line">  Navigator.pushNamed(</span><br><span class="line">    context,</span><br><span class="line">    <span class="string">&quot;/passArguments&quot;</span>,</span><br><span class="line">    arguments: ScreenArguments(</span><br><span class="line">      <span class="string">&#x27;Accept Arguments Screen&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;This message is extracted in the onGenerateRoute function.&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="第三方插件"><a href="#第三方插件" class="headerlink" title="第三方插件"></a>第三方插件</h1><p>Fluro是Flutter路由库</p><p>添加方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"> <span class="attr">fluro:</span> <span class="string">&quot;^1.5.1&quot;</span></span><br></pre></td></tr></table></figure><p>使用例子</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;app_route.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:fluro/fluro.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  router.define(<span class="string">&#x27;home/:data&#x27;</span>, handler: <span class="keyword">new</span> Handler(</span><br><span class="line">      handlerFunc: (BuildContext context, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; params) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Home(params[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>]);</span><br><span class="line">      &#125;));</span><br><span class="line">  runApp(<span class="keyword">new</span> Login());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; <span class="keyword">new</span> LoginState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Login</span>&gt;</span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">        title: <span class="string">&#x27;Fluro 例子&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        home: <span class="keyword">new</span> Scaffold(</span><br><span class="line">          appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">            title: <span class="keyword">new</span> Text(<span class="string">&quot;登录&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          body: <span class="keyword">new</span> Builder(builder: (BuildContext context) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Center(child:</span><br><span class="line">            <span class="keyword">new</span> Container(</span><br><span class="line">                height: <span class="number">30.0</span>,</span><br><span class="line">                color: Colors.blue,</span><br><span class="line">                child:<span class="keyword">new</span> FlatButton(</span><br><span class="line">                  child: <span class="keyword">const</span> Text(<span class="string">&#x27;传递帐号密码&#x27;</span>),</span><br><span class="line">                  onPressed: () &#123;</span><br><span class="line">                    <span class="keyword">var</span> bodyJson = <span class="string">&#x27;&#123;&quot;user&quot;:Manjaro,&quot;pass&quot;:passwd123&#125;&#x27;</span>;</span><br><span class="line">                    router.navigateTo(context, <span class="string">&#x27;/home/<span class="subst">$bodyJson</span>&#x27;</span>);</span><br><span class="line">                  &#125;,</span><br><span class="line">                )),</span><br><span class="line">            );</span><br><span class="line">          &#125;),</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span></span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _result;</span><br><span class="line">  Home(<span class="keyword">this</span>._result);</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; <span class="keyword">new</span> HomeState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Home</span>&gt;</span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Center(</span><br><span class="line">        child: <span class="keyword">new</span> Scaffold(</span><br><span class="line">          appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">            title: <span class="keyword">new</span> Text(<span class="string">&quot;个人主页&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          body:<span class="keyword">new</span> Center(child:  <span class="keyword">new</span> Text(widget._result)),</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ‘app_route.dart’的代码:</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:fluro/fluro.dart&#x27;</span>;</span><br><span class="line">Router router = <span class="keyword">new</span> Router();</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2019/11/21/xsScWX6qYb75fw9.gif" style="zoom:80%;" /><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://pub.dev/packages/fluro">fluro</a><br><a href="https://flutter.dev/docs/cookbook/navigation/navigate-with-arguments">官方文档</a><br><a href="https://my.oschina.net/u/248241/blog/1796503">flutter移动开发中的页面跳转和传值</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派4-Ubuntu18.04.2LTS下配置WiFi与SSH连接</title>
      <link href="/blog/2019/09/17/shu-mei-pai-4-ubuntu18.04.2lts-xia-pei-zhi-wifi-yu-ssh-lian-jie/"/>
      <url>/blog/2019/09/17/shu-mei-pai-4-ubuntu18.04.2lts-xia-pei-zhi-wifi-yu-ssh-lian-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><ul><li><a href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/">Raspberry Pi 4</a></li><li>SD卡，读卡器</li><li>电源适配器</li></ul><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="下载安装到SD卡"><a href="#下载安装到SD卡" class="headerlink" title="下载安装到SD卡"></a>下载安装到SD卡</h2><p>树莓派系统官方镜像下载：·<a href="https://www.raspberrypi.org/downloads/raspbian/">Raspberry Pi Raspbian</a></p><p>下载<a href="https://www.balena.io/etcher/">Etcher</a>工具，把镜像烧写到SD卡里面去<br>工具的操作很简单的三个步骤:<br>选择镜像 –&gt; 选择SD卡 –&gt; 烧写!</p><p><img src="https://i.loli.net/2019/09/17/n6rucIg4UNXQTqj.png"></p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>出于安全考虑，SSH在raspbian中默认disabled。启用SSH,在SD卡的boot目录下建立一个空白文件<code>ssh</code>即可启用,文件命名为 ssh。注意要小写且不要有任何扩展名。</p><p>配置WiFi,在SD卡的boot目录下建立一个 <code>wpa_supplicant.conf</code>文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">update_config=1</span><br><span class="line">country=US</span><br><span class="line"> </span><br><span class="line">network=&#123;</span><br><span class="line">ssid=&quot;WiFi-A&quot;</span><br><span class="line">psk=&quot;123456789&quot;</span><br><span class="line">key_mgmt=WPA-PSK</span><br><span class="line">priority=1</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">network=&#123;</span><br><span class="line">ssid=&quot;WiFi-B&quot;</span><br><span class="line">psk=&quot;123456789&quot;</span><br><span class="line">key_mgmt=WPA-PSK</span><br><span class="line">priority=2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/17/GbJksDFXnLjf5i8.png"></p><h2 id="连接数莓派"><a href="#连接数莓派" class="headerlink" title="连接数莓派"></a>连接数莓派</h2><p>将SD卡放入Raspberry Pi中，它应该在启用网络的情况下启动到Debian。如果出现问题，您可以通过将SD卡移回Linux计算机并查看var &#x2F; log目录来查看日志。</p><p>要连接到Raspberry Pi，需要知道它已分配的IP地址。在无线路由器上找到Raspberry Pi的IP地址,需确保Ubuntu 连接的和Raspberry Pi是在同一个局域网内.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh pi@hostname</span></span><br></pre></td></tr></table></figure><blockquote><p>hostname为树莓派的ip地址.</p></blockquote><p>官方系统镜像默认用户名为<code>pi</code>,密码为<code>raspberry</code>.</p><p><img src="https://i.loli.net/2019/09/17/8qxRmcvLn7zAEGJ.png"></p><blockquote><p>执行<code>passwd</code>命令来修改默认密码</p></blockquote><p>Raspbian镜像基于Debian Buster,基本命令使用和Debian基本一致.</p><ul><li><p>更新</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt-get update</span><br></pre></td></tr></table></figure></li><li><p>升级</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt-get upgrade</span><br></pre></td></tr></table></figure></li><li><p>安装软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt-get install &lt;name of software&gt;</span><br></pre></td></tr></table></figure></li><li><p>检查SD容量<br>当运行<code>upgrade</code>命令时，会显示数据下载量和空间需要量。可以运行df -h来确定卡剩余空间是否足够。注意下载的包(.deb文件)保存在<code>/var/cache/apt/archives</code>路径下。你可以通过<code>sudo apt-get clean</code>来争取空间。</p></li><li><p>配置更改<br>可对树莓派进行配置更改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo raspi-config</span><br></pre></td></tr></table></figure></li></ul><h1 id="安装docker和docker-compose"><a href="#安装docker和docker-compose" class="headerlink" title="安装docker和docker-compose"></a>安装docker和docker-compose</h1><p>树莓派是ARM架构的,如果需要找树莓派专用的镜像，那就在Dockerhub上搜索ARM或Rpi相关就能找到了。<br>有一个叫<a href="https://hub.docker.com/u/hypriot/">Hypriot</a>的仓库制作了非常多树莓派专用docker，可以参考下。</p><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt-get update</span><br><span class="line">pi@raspberrypi:~ $ sudo apt-get upgrade</span><br><span class="line">pi@raspberrypi:~ $ curl -sSL https://get.docker.com| sh</span><br></pre></td></tr></table></figure><p>然后运行<code>hello world</code>检测是否安装成功.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo docker run hello-world</span><br></pre></td></tr></table></figure><h2 id="无需sudo执行docker"><a href="#无需sudo执行docker" class="headerlink" title="无需sudo执行docker"></a>无需sudo执行docker</h2><p>为了每次执行docker不需要总是输入sudo，我们需要为docker创建一个用户组，并授予权限才行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建docker用户组</span></span><br><span class="line">pi@raspberrypi:~ $ sudo groupadd docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把当前用户加入到docker用户组</span></span><br><span class="line">pi@raspberrypi:~ $ sudo gpasswd -a $USER docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新当前用户组变动（就不用退出并重新登录了）</span></span><br><span class="line">pi@raspberrypi:~ $ newgrp docker</span><br></pre></td></tr></table></figure><p>或者 直接执行下面这条命令,会重启,需要重新登入.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo usermod -aG docker pi &amp;&amp; sudo reboot</span><br></pre></td></tr></table></figure><h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><h3 id="第一种方法"><a href="#第一种方法" class="headerlink" title="第一种方法"></a>第一种方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt-get update</span><br><span class="line">pi@raspberrypi:~ $ sudo apt-get install -y python python-pip</span><br><span class="line">pi@raspberrypi:~ $ sudo pip install docker-compose</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/17/JZfydCovKcF9MTn.png"></p><p>先执行,再执行<code>docker-compose</code>安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo apt install -y python python-pip libffi-dev</span><br></pre></td></tr></table></figure><p><del>### 第二种方法</del><br><del><a href="https://github.com/docker/compose">https://github.com/docker/compose</a></del><br><del>通过把<code>docker compose</code>当作一个<code>docker</code>的<code>container</code>下载并运行</del></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">    -v &quot;$PWD:/rootfs/$PWD&quot; \</span><br><span class="line">    -w=&quot;/rootfs/$PWD&quot; \</span><br><span class="line">    docker/compose:1.24.1 up</span><br></pre></td></tr></table></figure><p><del>设置alias快捷键,编辑(<code>~/.bash_profile</code>)</del></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alias docker-compose=&quot;&#x27;&quot;&#x27;docker run \</span><br><span class="line">    -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">    -v &quot;$PWD:/rootfs/$PWD&quot; \</span><br><span class="line">    -w=&quot;/rootfs/$PWD&quot; \</span><br><span class="line">    docker/compose:1.24.1&#x27;&quot;&#x27;&quot;</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>[<a href="https://segmentfault.com/a/1190000018028887">树莓派安装Docker</a>]<br><a href="http://www.penguintutor.com/raspberrypi/">Raspberry Pi - Linux computer for learning programming</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Raspberry Pi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidStudio快速生成jni头文件</title>
      <link href="/blog/2019/07/31/androidstudio-kuai-su-sheng-cheng-jni-tou-wen-jian/"/>
      <url>/blog/2019/07/31/androidstudio-kuai-su-sheng-cheng-jni-tou-wen-jian/</url>
      
        <content type="html"><![CDATA[<p>依次打开<code>Settings</code>–&gt;<code>Tools</code>–&gt;<code>External Tools</code>–&gt;<code>点击加号创建一个快速生成jni头文件的工具</code></p><p><img src="https://i.loli.net/2019/07/31/5d41618c4f9d413087.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Program: javah  </span><br><span class="line">2. Parameters: -v -jni -d $ModuleFileDir$/src/main/cpp $FileClass$  </span><br><span class="line">3. Working directory: $SourcepathEntry$  </span><br></pre></td></tr></table></figure><p>选中包含native方法的 JAVA 文件，右键唤起菜单，依次找到<code>ExternalTools</code>&#x3D;&gt;<code>Jni create .h</code>，执行前面添加的生成.h头文件的工具。<br><img src="https://i.loli.net/2019/07/31/5d41688405d3932421.jpg"><br><img src="https://i.loli.net/2019/07/31/5d416983e1d3667068.png"></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android录音</title>
      <link href="/blog/2019/07/30/android-lu-yin/"/>
      <url>/blog/2019/07/30/android-lu-yin/</url>
      
        <content type="html"><![CDATA[<h1 id="介绍-Android-中录音功能的实现"><a href="#介绍-Android-中录音功能的实现" class="headerlink" title="介绍 Android 中录音功能的实现"></a>介绍 Android 中录音功能的实现</h1><h2 id="录音方法"><a href="#录音方法" class="headerlink" title="录音方法"></a>录音方法</h2><p>Android 中的录音主要有两种方式 MediaRecorder 和 AudioRecord</p><ul><li><p>MediaRecorder（基于文件）</p><p>  可以录制音、视频；</p><p>  封装了录制、编码、压缩、线程等功能，直接生成可播放的音频文件；</p><p>  优点：封装度高，操作简单</p><p>  缺点：编码格式有限，.aac  .amr  .3gp，但是没有 mp3、wav 格式</p></li><li><p>AudioRecord（基于字节流）</p><p>  ​    只能录制音频；</p><p>  ​    输出的是 PCM 的声音数据，如果保存成文件是不能直接播放的，需要编码；</p><p>  ​    可以捕获音频流，边录制边处理，比如编码、变声、添加背景音乐。</p><p>  ​    优点：更灵活</p><p>  ​    缺点：需自行处理编码、开线程等工作</p><p>  ​    应用场景：语音聊天、汤姆猫、K歌…</p></li></ul><blockquote><p>PCM：Pulse Code Modulation（脉冲编码调制），是对连续变化的模拟信号进行抽样、量化和编码产生的数字信号。<br>它不是一种音频格式，它是声音文件的元数据，也就是声音的内容，没有文件头。经过某种格式的压缩、编码算法处理以后，再加上这种格式的文件头，才是这种格式的音频文件。</p></blockquote><h2 id="音频参数"><a href="#音频参数" class="headerlink" title="音频参数"></a>音频参数</h2><ul><li>采样频率：</li></ul><p>​       自然界的声音转换成数字格式时，要对它进行采样，每秒钟采样的次数就是采样率。就好比电影的1秒24帧画面。最常用：44.1kHz。</p><ul><li>采样位数：</li></ul><p>​       一个采样样本用多少位二进制数编码，最常用：16位。</p><ul><li>声道数：</li></ul><p>​       分为单声道和双声道，双声道又叫立体声，双声道音频文件比单声道大一倍。</p><ul><li>比特率（码率）：</li></ul><p>​       每秒钟音频文件所占的 bit 数。单位 ：kbps（每秒千比特数）。比特率（原始音频 PCM） &#x3D; 采样频率 x 采样位数  x  声道数，这是未经压缩的比特率，压缩后会远小于这个值。<br>​<br>​       采用44.1kHz采样频率、16位采样位数、双声道编码的原始音频 PCM 比特率为：1411.2 kbps 。而最常见的 mp3 格式的比特率为：128kbps，约 1MB&#x2F;分钟。</p><ul><li>编码格式：</li></ul><p>​       将原始音频 PCM 采用特定压缩算法处理后，加上文件头，所保存成的文件的格式。例如 mp3、wav、aac…</p><h2 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h2><ul><li>mp3</li></ul><p>​       是当今最流行的一种数字音频编码和有损压缩格式，就是将 PCM 通过算法进行压缩，常规 mp3 文件约为 1MB&#x2F;分钟。</p><ul><li>aac</li></ul><p>​        是 mp3 的下一代格式，也是有损压缩，相对于mp3，aac 格式的音频更佳，文件更小。ios 平台也支持，跨平台性好。</p><ul><li>wav</li></ul><p>​        最流行的非压缩数据格式，微软开发。</p><ul><li>amr</li></ul><p>​        压缩比比较大，但相对其他的压缩格式质量比较差，多用于人声，通话录音。</p><blockquote><p>riff：一种文件描述的格式，wav文件就采用了riff描述，前面44字节就是 riff 描述内容，就是文件头。</p></blockquote><h2 id="MediaRecorder"><a href="#MediaRecorder" class="headerlink" title="MediaRecorder"></a>MediaRecorder</h2><p> 首先在 AndroidManifest 配置文件中添加录音权限：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECORD_AUDIO&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>Android 6.0 以上还要动态获取权限。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音对象声明</span></span><br><span class="line">   <span class="keyword">private</span> MediaRecorder mRecorder;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startRecording</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 创建录音对象</span></span><br><span class="line">       mRecorder = <span class="keyword">new</span> <span class="title class_">MediaRecorder</span>();</span><br><span class="line">       <span class="comment">// 设置声音来源 MIC 即手机麦克风</span></span><br><span class="line">       mRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span><br><span class="line">       <span class="comment">// 设置音频格式 aac</span></span><br><span class="line">       mRecorder.setOutputFormat(MediaRecorder.OutputFormat.AAC_ADTS);</span><br><span class="line">       <span class="comment">// 设置录音文件</span></span><br><span class="line">       mRecorder.setOutputFile(getExternalCacheDir() + <span class="string">&quot;/demo.aac&quot;</span>);</span><br><span class="line">       <span class="comment">// 设置编码器</span></span><br><span class="line">       mRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 准备录音</span></span><br><span class="line">           mRecorder.prepare();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 开始录音</span></span><br><span class="line">       mRecorder.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>录音是耗时操作，但是，由于<code>MediaRecorder</code>已经封装了线程，故以上代码放在主线程即可。<br><code>MediaRecorder</code>是很占资源的，使用完毕需要释放掉：</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopRecording</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 停止录音</span></span><br><span class="line">       mRecorder.stop();</span><br><span class="line">       <span class="comment">// 释放资源</span></span><br><span class="line">       mRecorder.release();</span><br><span class="line">       <span class="comment">// 引用置空</span></span><br><span class="line">       mRecorder = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="AudioRecord"><a href="#AudioRecord" class="headerlink" title="AudioRecord"></a>AudioRecord</h2><p>首先在 AndroidManifest 配置文件中添加录音权限：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECORD_AUDIO&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>当然 Android 6.0 以上还要动态获取权限，具体实现方式请百度之。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isRecording</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startRecording</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 耗时操作要开线程</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 音源</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">audioSource</span> <span class="operator">=</span> MediaRecorder.AudioSource.MIC;</span><br><span class="line">            <span class="comment">// 采样率</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">44100</span>;</span><br><span class="line">            <span class="comment">// 声道数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">channelConfig</span> <span class="operator">=</span> AudioFormat.CHANNEL_IN_STEREO;<span class="comment">//双声道</span></span><br><span class="line">            <span class="comment">// 采样位数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">audioFormat</span> <span class="operator">=</span> AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">            <span class="comment">// 获取最小缓存区大小</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">minBufferSize</span> <span class="operator">=</span> AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">            <span class="comment">// 创建录音对象</span></span><br><span class="line">            <span class="type">AudioRecord</span> <span class="variable">audioRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(audioSource, sampleRate, channelConfig, audioFormat, minBufferSize);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建随机读写流</span></span><br><span class="line">                <span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="comment">// 留出文件头的位置</span></span><br><span class="line">                raf.seek(<span class="number">44</span>);</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[minBufferSize];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 录音中</span></span><br><span class="line">                audioRecord.startRecording();</span><br><span class="line">                isRecording = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">readSize</span> <span class="operator">=</span> audioRecord.read(buffer, <span class="number">0</span>, minBufferSize);</span><br><span class="line">                    raf.write(buffer,<span class="number">0</span>,readSize);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 录音停止</span></span><br><span class="line">                audioRecord.stop();</span><br><span class="line">                audioRecord.release();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 写文件头</span></span><br><span class="line">                WriteWaveFileHeader(raf, raf.length(),sampleRate,<span class="number">2</span>,sampleRate*<span class="number">16</span>*<span class="number">2</span>/<span class="number">8</span>);</span><br><span class="line">                raf.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为 wav 文件添加文件头，前提是在头部预留了 44字节空间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> raf</span></span><br><span class="line"><span class="comment">     *              随机读写流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileLength</span></span><br><span class="line"><span class="comment">     *              文件总长</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sampleRate</span></span><br><span class="line"><span class="comment">     *              采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channels</span></span><br><span class="line"><span class="comment">     *              声道数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteRate</span></span><br><span class="line"><span class="comment">     *              码率 = 采样率 * 采样位数 * 声道数 / 8</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">WriteWaveFileHeader</span><span class="params">(RandomAccessFile raf, <span class="type">long</span> fileLength, <span class="type">long</span> sampleRate, <span class="type">int</span> channels, <span class="type">long</span> byteRate)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalDataLen</span> <span class="operator">=</span> fileLength + <span class="number">36</span>;</span><br><span class="line">        <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">44</span>];</span><br><span class="line">        header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF/WAVE header</span></span><br><span class="line">        header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">        header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        header[<span class="number">4</span>] = (<span class="type">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">5</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">6</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">7</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">        header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">        header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">        header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27; chunk</span></span><br><span class="line">        header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">        header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">        header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">        header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">22</span>] = (<span class="type">byte</span>) channels;</span><br><span class="line">        header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">24</span>] = (<span class="type">byte</span>) (sampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">25</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">26</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">27</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">28</span>] = (<span class="type">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">29</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">30</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">31</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">32</span>] = (<span class="type">byte</span>) (<span class="number">2</span> * <span class="number">16</span> / <span class="number">8</span>); <span class="comment">// block align</span></span><br><span class="line">        header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">34</span>] = <span class="number">16</span>; <span class="comment">// bits per sample</span></span><br><span class="line">        header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">        header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">40</span>] = (<span class="type">byte</span>) (fileLength &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">41</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">42</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">43</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        raf.seek(<span class="number">0</span>);</span><br><span class="line">        raf.write(header, <span class="number">0</span>, <span class="number">44</span>);</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure><p> 以下是停止录音的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopRecording</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">// 停止录音</span></span><br><span class="line">     isRecording = <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="边录边播（AudioRecord-AudioTrack）"><a href="#边录边播（AudioRecord-AudioTrack）" class="headerlink" title="边录边播（AudioRecord + AudioTrack）"></a>边录边播（AudioRecord + AudioTrack）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isRecording</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 耗时操作要开线程</span></span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 音源</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">audioSource</span> <span class="operator">=</span> MediaRecorder.AudioSource.MIC;</span><br><span class="line">               <span class="comment">// 采样率</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">8000</span>;</span><br><span class="line">               <span class="comment">// 声道数</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">channelConfig</span> <span class="operator">=</span> AudioFormat.CHANNEL_IN_STEREO;<span class="comment">//双声道</span></span><br><span class="line">               <span class="comment">// 采样位数</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">audioFormat</span> <span class="operator">=</span> AudioFormat.ENCODING_PCM_8BIT;</span><br><span class="line">               <span class="comment">// 获取录音最小缓存区大小</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">recorderBufferSize</span> <span class="operator">=</span> AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">               <span class="comment">// 创建录音对象</span></span><br><span class="line">               <span class="type">AudioRecord</span> <span class="variable">audioRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(audioSource, sampleRate, channelConfig, audioFormat, recorderBufferSize);</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 音频类型</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">streamType</span> <span class="operator">=</span> AudioManager.STREAM_MUSIC;</span><br><span class="line">               <span class="comment">// 静态音频还是音频流</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">mode</span> <span class="operator">=</span> AudioTrack.MODE_STREAM;</span><br><span class="line">               <span class="comment">//  获取播放最小缓存区大小</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">playerBufferSize</span> <span class="operator">=</span> AudioTrack.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">               <span class="comment">// 创建播放对象</span></span><br><span class="line">               <span class="type">AudioTrack</span> <span class="variable">audioTrack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioTrack</span>(streamType, sampleRate, channelConfig, audioFormat, playerBufferSize, mode);</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 缓存区</span></span><br><span class="line">               <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[recorderBufferSize];</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 录音中</span></span><br><span class="line">               audioTrack.play();</span><br><span class="line">               audioRecord.startRecording();</span><br><span class="line">               isRecording = <span class="literal">true</span>;</span><br><span class="line">               <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                   audioRecord.read(buffer, <span class="number">0</span>, recorderBufferSize);</span><br><span class="line">                   audioTrack.write(buffer, <span class="number">0</span>, buffer.length);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 录音停止</span></span><br><span class="line">               audioRecord.stop();</span><br><span class="line">               audioTrack.stop();</span><br><span class="line">               audioRecord.release();</span><br><span class="line">               audioTrack.release();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p> 停止录音和播放：</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 停止录音</span></span><br><span class="line">       isRecording = <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="录制mp3格式音频"><a href="#录制mp3格式音频" class="headerlink" title="录制mp3格式音频"></a>录制mp3格式音频</h2><p> 众多周知，mp3 是跨平台性最好的音频格式，由于采用了压缩率更高的有损压缩算法，文件大小是大约每分钟1M，使其在网络中传输更快，占用存储空间也更少；与此同时，它的声音质量也不错，尤其是人声（相声、评书、脱口秀），当然追求无损音乐的除外。<br> Android 中没有提供录制 mp3 的 API，需要使用开源库 lame，lame 是专门用于编码 mp3 的轻量高效的 c 代码库。由于采用 c 语言编写，故需要用到 jni。</p><h3 id="下载lame库"><a href="#下载lame库" class="headerlink" title="下载lame库"></a>下载lame库</h3><ul><li>lame库下载(以下使用的是<code>lame</code> v3.100)<br>  <a href="https://sourceforge.net/projects/lame/files/lame/">https://sourceforge.net/projects/lame/files/lame/</a></li></ul><h3 id="源码导入"><a href="#源码导入" class="headerlink" title="源码导入"></a>源码导入</h3><p>解压下载的lame库，把<code>libmp3lame</code>文件夹下后缀为<code>.c .h</code>的文件（不包括子文件夹i386和vector下的）复制到cpp&#x2F;lame文件夹内，同时把<code>include</code>目录下的lame.h也复制到cpp&#x2F;lame文件夹内，此时 lame文件夹内包含42个文件。<br><img src="https://i.loli.net/2019/07/31/5d4157b88dbd619403.png"><br>（可参考<a href="https://github.com/xmaihh/MFSocket/tree/master/liblame/src/main/cpp/lame%EF%BC%89">https://github.com/xmaihh/MFSocket/tree/master/liblame/src/main/cpp/lame）</a></p><h3 id="修改库文件"><a href="#修改库文件" class="headerlink" title="修改库文件"></a>修改库文件</h3><p>打开刚刚拷贝的lame库文件，修改：</p><ol><li>util.h 文件，把 570 行的两处 ieee754_float32_t 改为 float  因为Android下并不支持该类型</li><li>set_get.h 文件，把头部的 #include &lt;lame.h&gt; 改为 #include “lame.h”</li><li>fft.c 文件，删除第47行  #include “vector&#x2F;lame_intrin.h”</li><li>id3tag.c和machine.h两个文件里，將HAVE_STRCHR和HAVE_MEMCPY的ifdef结构体删除或者注释</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> STDC_HEADERS</span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">/*# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="comment">#  define strchr index</span></span><br><span class="line"><span class="comment">#  define strrchr rindex</span></span><br><span class="line"><span class="comment"># endif*/</span></span><br><span class="line"><span class="type">char</span>   *<span class="title function_">strchr</span><span class="params">()</span>, *<span class="title function_">strrchr</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">/*# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="comment">#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="comment">#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="comment"># endif*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>可参考以下完整修改文件</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/VbrTag.c b/VbrTag.c</span></span><br><span class="line"><span class="comment">index 5800a44..36ee7b6 100644</span></span><br><span class="line"><span class="comment">--- a/VbrTag.c</span></span><br><span class="line"><span class="comment">+++ b/VbrTag.c</span></span><br><span class="line"><span class="meta">@@ -26,6 +26,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/bitstream.c b/bitstream.c</span></span><br><span class="line"><span class="comment">index aa35915..a2fe294 100644</span></span><br><span class="line"><span class="comment">--- a/bitstream.c</span></span><br><span class="line"><span class="comment">+++ b/bitstream.c</span></span><br><span class="line"><span class="meta">@@ -29,6 +29,7 @@</span></span><br><span class="line"> </span><br><span class="line"> #include &lt;stdlib.h&gt;</span><br><span class="line"> #include &lt;stdio.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> </span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"><span class="comment">diff --git a/encoder.c b/encoder.c</span></span><br><span class="line"><span class="comment">index 48f46c7..437067f 100644</span></span><br><span class="line"><span class="comment">--- a/encoder.c</span></span><br><span class="line"><span class="comment">+++ b/encoder.c</span></span><br><span class="line"><span class="meta">@@ -30,6 +30,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/fft.c b/fft.c</span></span><br><span class="line"><span class="comment">index 4eea1ad..27febdb 100644</span></span><br><span class="line"><span class="comment">--- a/fft.c</span></span><br><span class="line"><span class="comment">+++ b/fft.c</span></span><br><span class="line"><span class="meta">@@ -44,7 +44,7 @@</span></span><br><span class="line"> #include &quot;util.h&quot;</span><br><span class="line"><span class="comment">--- a/fft.c</span></span><br><span class="line"><span class="comment">+++ b/fft.c</span></span><br><span class="line"><span class="meta">@@ -44,7 +44,7 @@</span></span><br><span class="line"> #include &quot;util.h&quot;</span><br><span class="line"> #include &quot;fft.h&quot;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#include &quot;vector/lame_intrin.h&quot;</span></span><br><span class="line"><span class="addition">+//#include &quot;vector/lame_intrin.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/id3tag.c b/id3tag.c</span></span><br><span class="line"><span class="comment">index ac48510..8f148b8 100644</span></span><br><span class="line"><span class="comment">--- a/id3tag.c</span></span><br><span class="line"><span class="comment">+++ b/id3tag.c</span></span><br><span class="line"><span class="meta">@@ -41,17 +41,20 @@</span></span><br><span class="line"> # include &lt;string.h&gt;</span><br><span class="line"> # include &lt;ctype.h&gt;</span><br><span class="line"> #else</span><br><span class="line"><span class="deletion">-# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="deletion">-#  define strchr index</span></span><br><span class="line"><span class="deletion">-#  define strrchr rindex</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="addition">+//#  define strchr index</span></span><br><span class="line"><span class="addition">+//#  define strrchr rindex</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> char   *strchr(), *strrchr();</span><br><span class="line"><span class="deletion">-# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="deletion">-#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="addition">+//#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/lame.c b/lame.c</span></span><br><span class="line"><span class="comment">index cb82225..299fd56 100644</span></span><br><span class="line"><span class="comment">--- a/lame.c</span></span><br><span class="line"><span class="comment">+++ b/lame.c</span></span><br><span class="line"><span class="meta">@@ -31,6 +31,8 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/machine.h b/machine.h</span></span><br><span class="line"><span class="comment">index bf6fff2..c675c20 100644</span></span><br><span class="line"><span class="comment">--- a/machine.h</span></span><br><span class="line"><span class="comment">+++ b/machine.h</span></span><br><span class="line"><span class="meta">@@ -31,15 +31,15 @@</span></span><br><span class="line"> # include &lt;stdlib.h&gt;</span><br><span class="line"> # include &lt;string.h&gt;</span><br><span class="line"> #else</span><br><span class="line"><span class="deletion">-# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="deletion">-#  define strchr index</span></span><br><span class="line"><span class="deletion">-#  define strrchr rindex</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_STRCHR</span></span><br><span class="line"><span class="addition">+//#  define strchr index</span></span><br><span class="line"><span class="addition">+//#  define strrchr rindex</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> char   *strchr(), *strrchr();</span><br><span class="line"><span class="deletion">-# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="deletion">-#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="deletion">-# endif</span></span><br><span class="line"><span class="addition">+//# ifndef HAVE_MEMCPY</span></span><br><span class="line"><span class="addition">+//#  define memcpy(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//#  define memmove(d, s, n) bcopy ((s), (d), (n))</span></span><br><span class="line"><span class="addition">+//# endif</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #if  defined(__riscos__)  &amp;&amp;  defined(FPA10)</span><br><span class="line"><span class="comment">diff --git a/newmdct.c b/newmdct.c</span></span><br><span class="line"><span class="comment">index 596cac9..ac98abd 100644</span></span><br><span class="line"><span class="comment">--- a/newmdct.c</span></span><br><span class="line"><span class="comment">+++ b/newmdct.c</span></span><br><span class="line"><span class="meta">@@ -30,6 +30,7 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/psymodel.c b/psymodel.c</span></span><br><span class="line"><span class="comment">index 60076ee..1393c2a 100644</span></span><br><span class="line"><span class="comment">--- a/psymodel.c</span></span><br><span class="line"><span class="comment">+++ b/psymodel.c</span></span><br><span class="line"><span class="meta">@@ -145,7 +145,8 @@</span> blocktype_d[2]        block type to use for previous granule</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize.c b/quantize.c</span></span><br><span class="line"><span class="comment">index 9ba9c16..2906c00 100644</span></span><br><span class="line"><span class="comment">--- a/quantize.c</span></span><br><span class="line"><span class="comment">+++ b/quantize.c</span></span><br><span class="line"><span class="meta">@@ -28,6 +28,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize_pvt.c b/quantize_pvt.c</span></span><br><span class="line">:</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize.c b/quantize.c</span></span><br><span class="line"><span class="comment">index 9ba9c16..2906c00 100644</span></span><br><span class="line"><span class="comment">--- a/quantize.c</span></span><br><span class="line"><span class="comment">+++ b/quantize.c</span></span><br><span class="line"><span class="meta">@@ -28,6 +28,8 @@</span></span><br><span class="line"> # include &lt;config.h&gt;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/quantize_pvt.c b/quantize_pvt.c</span></span><br><span class="line"><span class="comment">index d8d6447..3cd9966 100644</span></span><br><span class="line"><span class="comment">--- a/quantize_pvt.c</span></span><br><span class="line"><span class="comment">+++ b/quantize_pvt.c</span></span><br><span class="line"><span class="meta">@@ -36,6 +36,7 @@</span></span><br><span class="line"> #include &quot;reservoir.h&quot;</span><br><span class="line"> #include &quot;lame-analysis.h&quot;</span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> #define NSATHSCALE 100  /* Assuming dynamic range=96dB, this value should be 92 */</span><br><span class="line"><span class="comment">diff --git a/set_get.h b/set_get.h</span></span><br><span class="line"><span class="comment">index 37e4bcd..99ab73c 100644</span></span><br><span class="line"><span class="comment">--- a/set_get.h</span></span><br><span class="line"><span class="comment">+++ b/set_get.h</span></span><br><span class="line"><span class="meta">@@ -21,7 +21,7 @@</span></span><br><span class="line"> #ifndef __SET_GET_H__</span><br><span class="line"> #define __SET_GET_H__</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#include &lt;lame.h&gt;</span></span><br><span class="line"><span class="addition">+#include &quot;lame.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> #if defined(__cplusplus)</span><br><span class="line"> extern  &quot;C&quot; &#123;</span><br><span class="line"><span class="comment">diff --git a/takehiro.c b/takehiro.c</span></span><br><span class="line"><span class="comment">index 67aba1b..ca02f98 100644</span></span><br><span class="line"><span class="comment">--- a/takehiro.c</span></span><br><span class="line"><span class="comment">+++ b/takehiro.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/util.c b/util.c</span></span><br><span class="line"><span class="comment">index 43b457c..e9255fe 100644</span></span><br><span class="line"><span class="comment">--- a/util.c</span></span><br><span class="line"><span class="comment">+++ b/util.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,7 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #include &lt;float.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;malloc.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br><span class="line"><span class="comment">diff --git a/util.h b/util.h</span></span><br><span class="line"><span class="comment">index 13f0cd4..b6bf306 100644</span></span><br><span class="line"><span class="comment">--- a/util.h</span></span><br><span class="line"><span class="comment">+++ b/util.h</span></span><br><span class="line"><span class="meta">@@ -567,7 +567,7 @@</span> extern  &quot;C&quot; &#123;</span><br><span class="line"> </span><br><span class="line"> /* log/log10 approximations */</span><br><span class="line">     extern void init_log_table(void);</span><br><span class="line"><span class="deletion">-    extern ieee754_float32_t fast_log2(ieee754_float32_t x);</span></span><br><span class="line"><span class="addition">+    extern float fast_log2(float x);</span></span><br><span class="line"> </span><br><span class="line">     int     isResamplingNecessary(SessionConfig_t const* cfg);</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/vbrquantize.c b/vbrquantize.c</span></span><br><span class="line"><span class="comment">index 0f703b7..60834d3 100644</span></span><br><span class="line"><span class="comment">--- a/vbrquantize.c</span></span><br><span class="line"><span class="comment">+++ b/vbrquantize.c</span></span><br><span class="line"><span class="meta">@@ -27,6 +27,8 @@</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="addition">+#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;string.h&gt;</span></span><br><span class="line"> #include &quot;lame.h&quot;</span><br><span class="line"> #include &quot;machine.h&quot;</span><br><span class="line"> #include &quot;encoder.h&quot;</span><br></pre></td></tr></table></figure><h3 id="编写CmakeList-txt"><a href="#编写CmakeList-txt" class="headerlink" title="编写CmakeList.txt"></a>编写CmakeList.txt</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.6</span>.<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span>(CURRENT_DIR <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;CURRENT_DIR:&quot;</span> <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>src/main/cpp/lame)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(LAME_DIR src/main/cpp/lame)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;LAME_DIR:&quot;</span> <span class="variable">$&#123;LAME_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">aux_source_directory</span>(src/main/cpp/lame SRC_LIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(mp3lame</span><br><span class="line">        SHARED</span><br><span class="line">        src/main/cpp/MP3Recorder.c</span><br><span class="line">        <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add_library(mp3lame</span></span><br><span class="line"><span class="comment">#        SHARED</span></span><br><span class="line"><span class="comment">#        src/main/cpp/MP3Recorder.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/bitstream.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/fft.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/id3tag.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/mpglib_interface.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/presets.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/quantize.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/reservoir.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/tables.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/util.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/VbrTag.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/encoder.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/gain_analysis.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/lame.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/newmdct.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/psymodel.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/quantize_pvt.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/set_get.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/takehiro.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/vbrquantize.c</span></span><br><span class="line"><span class="comment">#        src/main/cpp/lame/version.c)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">find_library</span>( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">        log-lib</span><br><span class="line">        log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(mp3lame</span><br><span class="line">        <span class="variable">$&#123;log-lib&#125;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（可参考<a href="https://github.com/xmaihh/MFSocket/blob/master/liblame/CMakeLists.txt%EF%BC%89">https://github.com/xmaihh/MFSocket/blob/master/liblame/CMakeLists.txt）</a></p><h3 id="编写-java-类和-c-文件"><a href="#编写-java-类和-c-文件" class="headerlink" title="编写 java 类和 c 文件"></a>编写 java 类和 c 文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MP3Recorder</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">     System.loadLibrary(<span class="string">&quot;mp3lame&quot;</span>);   </span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 lame编码器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inSampleRate</span></span><br><span class="line"><span class="comment">     *              输入采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outChannel</span></span><br><span class="line"><span class="comment">     *              声道数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outSampleRate</span></span><br><span class="line"><span class="comment">     *              输出采样率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outBitrate</span></span><br><span class="line"><span class="comment">     *              比特率(kbps)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> quality</span></span><br><span class="line"><span class="comment">     *              0~9，0最好</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(<span class="type">int</span> inSampleRate, <span class="type">int</span> outChannel, <span class="type">int</span> outSampleRate, <span class="type">int</span> outBitrate, <span class="type">int</span> quality)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  编码，把 AudioRecord 录制的 PCM 数据转换成 mp3 格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer_l</span></span><br><span class="line"><span class="comment">     *          左声道输入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer_r</span></span><br><span class="line"><span class="comment">     *          右声道输入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> samples</span></span><br><span class="line"><span class="comment">     *          输入数据的size</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mp3buf</span></span><br><span class="line"><span class="comment">     *          输出数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *          输出到mp3buf的byte数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">encode</span><span class="params">(<span class="type">short</span>[] buffer_l, <span class="type">short</span>[] buffer_r, <span class="type">int</span> samples, <span class="type">byte</span>[] mp3buf)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  刷写</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mp3buf</span></span><br><span class="line"><span class="comment">     *          mp3数据缓存区</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *          返回刷写的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">flush</span><span class="params">(<span class="type">byte</span>[] mp3buf)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭 lame 编码器，释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成.h文件</p><p><a href="https://xmaihh.github.io/2019/07/31/AndroidStudio%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90jni%E5%A4%B4%E6%96%87%E4%BB%B6/">AndroidStudio快速生成jni头文件</a></p><p>编写MP3Recorder.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lame/lame.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MP3Recorder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> lame_global_flags *glf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    init</span></span><br><span class="line"><span class="comment"> * Signature: (IIIII)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_com_android_liblame_MP3Recorder_init</span></span><br><span class="line">        <span class="params">(JNIEnv *env, jclass instance, jint inSamplerate, jint outChannel, jint outSamplerate,</span></span><br><span class="line"><span class="params">         jint outBitrate, jint quality)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (glf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        lame_close(glf);</span><br><span class="line">        glf = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    glf = lame_init();</span><br><span class="line">    lame_set_in_samplerate(glf, inSamplerate);</span><br><span class="line">    lame_set_num_channels(glf, outChannel);</span><br><span class="line">    lame_set_out_samplerate(glf, outSamplerate);</span><br><span class="line">    lame_set_brate(glf, outBitrate);</span><br><span class="line">    lame_set_quality(glf, quality);</span><br><span class="line">    lame_init_params(glf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    encode</span></span><br><span class="line"><span class="comment"> * Signature: ([S[SI[B)I</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_android_liblame_MP3Recorder_encode</span></span><br><span class="line">        <span class="params">(JNIEnv *env, jclass instance, jshortArray buffer_l, jshortArray buffer_r, jint samples,</span></span><br><span class="line"><span class="params">         jbyteArray mp3buf)</span> &#123;</span><br><span class="line">    jshort *j_buffer_l = (*env)-&gt;GetShortArrayElements(env, buffer_l, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    jshort *j_buffer_r = (*env)-&gt;GetShortArrayElements(env, buffer_r, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> jsize mp3buf_size = (*env)-&gt;GetArrayLength(env, mp3buf);</span><br><span class="line">    jbyte *j_mp3buf = (*env)-&gt;GetByteArrayElements(env, mp3buf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = lame_encode_buffer(glf, j_buffer_l, j_buffer_r,</span><br><span class="line">                                    samples, j_mp3buf, mp3buf_size);</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;ReleaseShortArrayElements(env, buffer_l, j_buffer_l, <span class="number">0</span>);</span><br><span class="line">    (*env)-&gt;ReleaseShortArrayElements(env, buffer_r, j_buffer_r, <span class="number">0</span>);</span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, mp3buf, j_mp3buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    flush</span></span><br><span class="line"><span class="comment"> * Signature: ([B)I</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_android_liblame_MP3Recorder_flush</span></span><br><span class="line">        <span class="params">(JNIEnv *env, jclass instance, jbyteArray mp3buf)</span> &#123;</span><br><span class="line">    <span class="type">const</span> jsize mp3buf_size = (*env)-&gt;GetArrayLength(env, mp3buf);</span><br><span class="line">    jbyte *j_mp3buf = (*env)-&gt;GetByteArrayElements(env, mp3buf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = lame_encode_flush(glf, j_mp3buf, mp3buf_size);</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, mp3buf, j_mp3buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_android_liblame_MP3Recorder</span></span><br><span class="line"><span class="comment"> * Method:    close</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_com_android_liblame_MP3Recorder_close</span></span><br><span class="line">        <span class="params">(JNIEnv *env, jclass instance)</span> &#123;</span><br><span class="line">    lame_close(glf);</span><br><span class="line">    glf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置build-gradle"><a href="#配置build-gradle" class="headerlink" title="配置build.gradle"></a>配置<code>build.gradle</code></h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">....</span><br><span class="line">...</span><br><span class="line">..</span><br><span class="line">.</span><br><span class="line">   <span class="comment">//*</span></span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path <span class="string">&quot;CMakeLists.txt&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>点一下小锤子 :hammer: MakeProject。</p><p>编译生成 so库。</p><h3 id="录制MP3格式音频"><a href="#录制MP3格式音频" class="headerlink" title="录制MP3格式音频"></a>录制MP3格式音频</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isRecording;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//开始录音</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// 音源</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">audioSource</span> <span class="operator">=</span> MediaRecorder.AudioSource.MIC;</span><br><span class="line">                <span class="comment">// 采样率</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">44100</span>;</span><br><span class="line">                <span class="comment">// 声道</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">channelConfig</span> <span class="operator">=</span> AudioFormat.CHANNEL_IN_MONO;<span class="comment">//单声道</span></span><br><span class="line">                <span class="comment">// 采样位数</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">audioFormat</span> <span class="operator">=</span> AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">                <span class="comment">// 录音缓存区大小</span></span><br><span class="line">                <span class="type">int</span> bufferSizeInBytes;</span><br><span class="line">                <span class="comment">// 文件输出流</span></span><br><span class="line">                FileOutputStream fos;</span><br><span class="line">                <span class="comment">// 录音最小缓存大小</span></span><br><span class="line">                bufferSizeInBytes = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">                <span class="type">AudioRecord</span> <span class="variable">audioRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(audioSource, sampleRate, channelConfig, audioFormat, bufferSizeInBytes);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(getExternalCacheDir() + <span class="string">&quot;/demo.mp3&quot;</span>);</span><br><span class="line">                    MP3Recorder.init(sampleRate, <span class="number">2</span>, sampleRate, <span class="number">128</span>, <span class="number">5</span>);</span><br><span class="line">                    <span class="type">short</span>[] buffer = <span class="keyword">new</span> <span class="title class_">short</span>[bufferSizeInBytes];</span><br><span class="line">                    <span class="type">byte</span>[] mp3buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) (<span class="number">7200</span> + buffer.length * <span class="number">1.25</span>)];</span><br><span class="line">                    audioRecord.startRecording();</span><br><span class="line">                    isRecording = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">while</span> (isRecording &amp;&amp; audioRecord.getRecordingState() == AudioRecord.RECORDSTATE_RECORDING) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">readSize</span> <span class="operator">=</span> audioRecord.read(buffer, <span class="number">0</span>, bufferSizeInBytes);</span><br><span class="line">                        <span class="keyword">if</span> (readSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">encodeSize</span> <span class="operator">=</span> MP3Recorder.encode(buffer, buffer, readSize, mp3buffer);</span><br><span class="line">                            <span class="keyword">if</span> (encodeSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    fos.write(mp3buffer, <span class="number">0</span>, encodeSize);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">int</span> <span class="variable">flushSize</span> <span class="operator">=</span> MP3Recorder.flush(mp3buffer);</span><br><span class="line">                    <span class="keyword">if</span> (flushSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            fos.write(mp3buffer, <span class="number">0</span>, flushSize);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fos.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    audioRecord.stop();</span><br><span class="line">                    audioRecord.release();</span><br><span class="line">                    MP3Recorder.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// 停止录音</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        isRecording = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="音频解码"><a href="#音频解码" class="headerlink" title="音频解码"></a>音频解码</h1><p> 想要转换音频格式（如 mp3格式转 wav格式）或者添加背景音乐，都需要解码声音文件。<br> Android SDK 中提供了解码的 API，它就是 MediaCodec，也就是音频解码器，我们用它实现 mp3格式音频的解码：<br>把mp3格式转wav格式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startDecoding</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 待解码声音文件路径</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> getExternalCacheDir() + <span class="string">&quot;/bg.mp3&quot;</span>;</span><br><span class="line">       <span class="comment">// 音/视频 提取器</span></span><br><span class="line">       <span class="type">MediaExtractor</span> <span class="variable">mediaExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>(); <span class="keyword">try</span> &#123;</span><br><span class="line">           mediaExtractor.setDataSource(filePath);</span><br><span class="line">           <span class="comment">// 分离音频用的，获取音频数据</span></span><br><span class="line">           <span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> mediaExtractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line">         <span class="comment">/*// 获取采样率</span></span><br><span class="line"><span class="comment">           int sampleRate = mediaFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE);</span></span><br><span class="line"><span class="comment">           // 获取声道数</span></span><br><span class="line"><span class="comment">           int channelCount = mediaFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT);</span></span><br><span class="line"><span class="comment">           // 获取时长</span></span><br><span class="line"><span class="comment">           long duration = mediaFormat.getLong(MediaFormat.KEY_DURATION);*/</span></span><br><span class="line">           <span class="comment">// 获取类型</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">mime</span> <span class="operator">=</span> mediaFormat.getString(MediaFormat.KEY_MIME);</span><br><span class="line">         <span class="comment">/*System.out.println(&quot;sampleRate:&quot; + sampleRate + &quot;,channelCount:&quot; +</span></span><br><span class="line"><span class="comment">           channelCount + &quot;,duration:&quot; + duration + &quot;,mime:&quot; + mime );*/</span></span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 选择音轨</span></span><br><span class="line">           mediaExtractor.selectTrack(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">// 解码器</span></span><br><span class="line">           <span class="type">MediaCodec</span> <span class="variable">mediaCodec</span> <span class="operator">=</span> MediaCodec.createDecoderByType(mime);</span><br><span class="line">           <span class="comment">// 配置解码器</span></span><br><span class="line">           mediaCodec.configure(mediaFormat, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="comment">// 开始解码</span></span><br><span class="line">           mediaCodec.start();</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 解码器在此缓存中获取输入数据</span></span><br><span class="line">           ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers();</span><br><span class="line">           <span class="comment">// 编码器将解码后的数据放入此缓存中，保存的是pcm数据</span></span><br><span class="line">           ByteBuffer[] outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">           <span class="comment">// 用于描述解码得到的byte[]数据的相关信息</span></span><br><span class="line">           MediaCodec.<span class="type">BufferInfo</span> <span class="variable">bufferInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 创建随机读写流</span></span><br><span class="line">           <span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">           <span class="comment">// 留出文件头的位置</span></span><br><span class="line">           raf.seek(<span class="number">44</span>);</span><br><span class="line">           <span class="comment">// 解码状态</span></span><br><span class="line">           <span class="type">boolean</span> <span class="variable">isDecoding</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">           main:</span><br><span class="line">           <span class="keyword">while</span> (isDecoding) &#123;</span><br><span class="line">               <span class="keyword">for</span> (ByteBuffer ib : inputBuffers) &#123;</span><br><span class="line">                   <span class="comment">// 获取输入缓存器</span></span><br><span class="line">                   <span class="type">int</span> <span class="variable">inputIndex</span> <span class="operator">=</span> mediaCodec.dequeueInputBuffer(-<span class="number">1</span>);</span><br><span class="line">                   <span class="keyword">if</span> (inputIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">break</span> main;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> inputBuffers[inputIndex];</span><br><span class="line">                   <span class="comment">// 读取数据到输入缓存器</span></span><br><span class="line">                   <span class="type">int</span> <span class="variable">sampleSize</span> <span class="operator">=</span> mediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">if</span> (sampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                       isDecoding = <span class="literal">false</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// 通知解码器输入了数据</span></span><br><span class="line">                       mediaCodec.queueInputBuffer(inputIndex, <span class="number">0</span>, sampleSize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                       <span class="comment">// 移动到下一取样处</span></span><br><span class="line">                       mediaExtractor.advance();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 获取输出缓存器</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">outputIndex</span> <span class="operator">=</span> mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               <span class="keyword">if</span> (outputIndex == -<span class="number">2</span>) &#123;</span><br><span class="line">                   <span class="comment">// 格式变了，重新获取一次</span></span><br><span class="line">                   outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">               ByteBuffer outputBuffer;</span><br><span class="line">               <span class="comment">// PCM数据</span></span><br><span class="line">               <span class="type">byte</span>[] chunckPCM;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">while</span> (outputIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                   outputBuffer = outputBuffers[outputIndex];</span><br><span class="line">                   <span class="comment">// bufferInfo 定义了次数据块的大小</span></span><br><span class="line">                   chunckPCM = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferInfo.size];</span><br><span class="line">                   <span class="comment">// 将buffer内的数据取出到字节数组中</span></span><br><span class="line">                   outputBuffer.get(chunckPCM);</span><br><span class="line">                   <span class="comment">// 数据取出后，一定记得清空，mediaCodec是反复使用这些buffer的</span></span><br><span class="line">                   outputBuffer.clear();</span><br><span class="line">                   <span class="comment">// 输出PCM数据到文件夹</span></span><br><span class="line">                   raf.write(chunckPCM, <span class="number">0</span>, bufferInfo.size);</span><br><span class="line">                   <span class="comment">// 释放输出buffer，不然mediaCodec用完所有buffer后，就不再向外输出数据</span></span><br><span class="line">                   mediaCodec.releaseOutputBuffer(outputIndex, <span class="literal">false</span>);</span><br><span class="line">                   <span class="comment">// 再次获取数据,如果没有数据则outputIndex=-1,结束循环</span></span><br><span class="line">                   outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">10000</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">           WriteWaveFileHeader(raf, raf.length(), <span class="number">44100</span>, <span class="number">1</span>, <span class="number">44100</span> * <span class="number">16</span> / <span class="number">8</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 为 wav 文件添加文件头，前提是在头部预留了 44字节空间</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> raf        随机读写流</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileLength 文件总长</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> sampleRate 采样率</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> channels   声道数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> byteRate   码率 = 采样率 * 采样位数 * 声道数 / 8</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">WriteWaveFileHeader</span><span class="params">(RandomAccessFile raf, <span class="type">long</span> fileLength, <span class="type">long</span> sampleRate, <span class="type">int</span> channels, <span class="type">long</span> byteRate)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       <span class="type">long</span> <span class="variable">totalDataLen</span> <span class="operator">=</span> fileLength + <span class="number">36</span>;</span><br><span class="line">       <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">44</span>];</span><br><span class="line">       header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF/WAVE header</span></span><br><span class="line">       header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">       header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">       header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">       header[<span class="number">4</span>] = (<span class="type">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">5</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">6</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">7</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;</span><br><span class="line">       header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">       header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">       header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">       header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27; chunk</span></span><br><span class="line">       header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">       header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">       header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">       header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">       header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">       header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">22</span>] = (<span class="type">byte</span>) channels;</span><br><span class="line">       header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">24</span>] = (<span class="type">byte</span>) (sampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">25</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">26</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">27</span>] = (<span class="type">byte</span>) ((sampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">28</span>] = (<span class="type">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">29</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">30</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">31</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">32</span>] = (<span class="type">byte</span>) (<span class="number">2</span> * <span class="number">16</span> / <span class="number">8</span>); <span class="comment">// block align</span></span><br><span class="line">       header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">34</span>] = <span class="number">16</span>; <span class="comment">// bits per sample</span></span><br><span class="line">       header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">       header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">       header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">       header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">       header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">       header[<span class="number">40</span>] = (<span class="type">byte</span>) (fileLength &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">41</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">42</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       header[<span class="number">43</span>] = (<span class="type">byte</span>) ((fileLength &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">       raf.seek(<span class="number">0</span>);</span><br><span class="line">       raf.write(header, <span class="number">0</span>, <span class="number">44</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1 id="录音添加背景音乐并实时播放，类似K歌效果"><a href="#录音添加背景音乐并实时播放，类似K歌效果" class="headerlink" title="录音添加背景音乐并实时播放，类似K歌效果"></a>录音添加背景音乐并实时播放，类似K歌效果</h1><p>K歌类 APP 都是录音加伴奏，这里实现 mp3 格式的背景音乐解码，与录音合并，并最终输出 mp3 格式的文件。即边录音边解码边合成，录音结束即合并结束。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 录音状态</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> isRecording;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始录音</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 音源</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">audioSource</span> <span class="operator">=</span> MediaRecorder.AudioSource.MIC;</span><br><span class="line">            <span class="comment">// 采样率</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">44100</span>;</span><br><span class="line">            <span class="comment">// 声道</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">channelConfig</span> <span class="operator">=</span> AudioFormat.CHANNEL_IN_MONO;<span class="comment">//单声道</span></span><br><span class="line">            <span class="comment">// 采样位数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">audioFormat</span> <span class="operator">=</span> AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line">            <span class="comment">// 录音最小缓存区大小</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">bufferSizeInBytes</span> <span class="operator">=</span> AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);</span><br><span class="line">            <span class="comment">// 录音对象</span></span><br><span class="line">            <span class="type">AudioRecord</span> <span class="variable">audioRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(audioSource, sampleRate, channelConfig, audioFormat, bufferSizeInBytes);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 音轨提取器</span></span><br><span class="line">                <span class="type">MediaExtractor</span> <span class="variable">mediaExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">                <span class="comment">// 给音轨提取器设置文件路径</span></span><br><span class="line">                mediaExtractor.setDataSource(getExternalCacheDir() + <span class="string">&quot;/bg.mp3&quot;</span>);</span><br><span class="line">                <span class="comment">// 获取音频格式信息</span></span><br><span class="line">                <span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> mediaExtractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 获取音频类型</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">mime</span> <span class="operator">=</span> mediaFormat.getString(MediaFormat.KEY_MIME);</span><br><span class="line">                <span class="comment">// 选中音轨</span></span><br><span class="line">                mediaExtractor.selectTrack(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 构造解码器</span></span><br><span class="line">                <span class="type">MediaCodec</span> <span class="variable">mediaCodec</span> <span class="operator">=</span> MediaCodec.createDecoderByType(mime);</span><br><span class="line">                <span class="comment">// 配置解码器</span></span><br><span class="line">                mediaCodec.configure(mediaFormat, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 开始解码</span></span><br><span class="line">                mediaCodec.start();</span><br><span class="line">                <span class="comment">// 解码器在此缓存中获取输入数据</span></span><br><span class="line">                ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers();</span><br><span class="line">                <span class="comment">// 编码器将解码后的数据放入此缓存中，存放的是pcm数据</span></span><br><span class="line">                ByteBuffer[] outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">                <span class="comment">// 用于描述解码得到的byte[]数据的相关信息</span></span><br><span class="line">                MediaCodec.<span class="type">BufferInfo</span> <span class="variable">bufferInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">                <span class="comment">// 背景音乐解码后的数据输出流，先存储，然后读取再和录音合并</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos_wav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>);</span><br><span class="line">                <span class="comment">// 读取处理好的背景音乐，和录音合并</span></span><br><span class="line">                <span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(getExternalCacheDir() + <span class="string">&quot;/demo.wav&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="comment">// 背景音字节数</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">length</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 存储大小端</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isBigEnding</span> <span class="operator">=</span> ByteOrder.nativeOrder() == ByteOrder.BIG_ENDIAN;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 录音缓存</span></span><br><span class="line">                <span class="type">short</span>[] buffer = <span class="keyword">new</span> <span class="title class_">short</span>[bufferSizeInBytes];</span><br><span class="line">                <span class="comment">// 最终生成的mp3数据的缓存器</span></span><br><span class="line">                <span class="type">byte</span>[] mp3buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) (<span class="number">7200</span> + buffer.length * <span class="number">1.25</span>)];</span><br><span class="line">                <span class="comment">// 开始录音</span></span><br><span class="line">                audioRecord.startRecording();</span><br><span class="line">                <span class="comment">// 录音状态</span></span><br><span class="line">                isRecording = <span class="literal">true</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 最终文件输出流</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(getExternalCacheDir() + <span class="string">&quot;/demo.mp3&quot;</span>);</span><br><span class="line">                <span class="comment">// mp3编码器初始化</span></span><br><span class="line">                MP3Recorder.init(sampleRate, <span class="number">1</span>, sampleRate, <span class="number">128</span>, <span class="number">5</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span> (isRecording) &#123;</span><br><span class="line">                    <span class="comment">// 读取录音</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">readSize</span> <span class="operator">=</span> audioRecord.read(buffer, <span class="number">0</span>, bufferSizeInBytes);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 解码背景音乐</span></span><br><span class="line">                    <span class="keyword">for</span> (ByteBuffer ib : inputBuffers) &#123;</span><br><span class="line">                        <span class="comment">// 获取输入缓存器</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">inputIndex</span> <span class="operator">=</span> mediaCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (inputIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> inputBuffers[inputIndex];</span><br><span class="line">                        <span class="comment">// 读取数据到输入缓存器</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">sampleSize</span> <span class="operator">=</span> mediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (sampleSize &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 通知解码器输入了数据</span></span><br><span class="line">                            mediaCodec.queueInputBuffer(inputIndex, <span class="number">0</span>, sampleSize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                            <span class="comment">// 移动到下一取样处</span></span><br><span class="line">                            mediaExtractor.advance();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 输出缓存器</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">outputIndex</span> <span class="operator">=</span> mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (outputIndex == -<span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="comment">// 格式变了，重新获取一次</span></span><br><span class="line">                        outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                    ByteBuffer outputBuffer;</span><br><span class="line">                    <span class="comment">// PCM数据</span></span><br><span class="line">                    <span class="type">byte</span>[] chunckPCM;</span><br><span class="line">                    <span class="comment">// 循环读取解码数据</span></span><br><span class="line">                    <span class="keyword">while</span> (outputIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 拿到用于存放PCM数据的buffer</span></span><br><span class="line">                        outputBuffer = outputBuffers[outputIndex];</span><br><span class="line">                        <span class="comment">// bufferInfo 定义了数据块的大小</span></span><br><span class="line">                        chunckPCM = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferInfo.size];</span><br><span class="line">                        <span class="comment">// 将buffer内的数据取出到字节数组中</span></span><br><span class="line">                        outputBuffer.get(chunckPCM);</span><br><span class="line">                        <span class="comment">// 数据取出后，一定记得清空，mediaCodec是反复使用这些buffer的</span></span><br><span class="line">                        outputBuffer.clear();</span><br><span class="line">                        <span class="comment">// 输出PCM数据到文件夹</span></span><br><span class="line">                        fos_wav.write(chunckPCM, <span class="number">0</span>, bufferInfo.size);</span><br><span class="line">                        <span class="comment">// 背景音字节数（解码后的）</span></span><br><span class="line">                        length += bufferInfo.size;</span><br><span class="line">                        <span class="comment">// 释放输出buffer，不然mediaCodec用完所有buffer后，就不再向外输出数据</span></span><br><span class="line">                        mediaCodec.releaseOutputBuffer(outputIndex, <span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">// 再次获取数据,如果没有数据则outputIndex=-1,结束循环</span></span><br><span class="line">                        outputIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 混音</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buffer.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (raf.getFilePointer() &gt;= length - <span class="number">1</span>) &#123;</span><br><span class="line">                            raf.seek(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isBigEnding) &#123;</span><br><span class="line">                            buffer[i] += (<span class="type">short</span>) ((raf.read() &lt;&lt; <span class="number">8</span>) + raf.read());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            buffer[i] += (<span class="type">short</span>) (raf.read() + (raf.read() &lt;&lt; <span class="number">8</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (readSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">encodeSize</span> <span class="operator">=</span> MP3Recorder.encode(buffer, buffer, readSize, mp3buffer);</span><br><span class="line">                        <span class="keyword">if</span> (encodeSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                fos.write(mp3buffer, <span class="number">0</span>, encodeSize);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="type">int</span> <span class="variable">flushSize</span> <span class="operator">=</span> MP3Recorder.flush(mp3buffer);</span><br><span class="line">                <span class="keyword">if</span> (flushSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fos.write(mp3buffer, <span class="number">0</span>, flushSize);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                    raf.close();</span><br><span class="line">                    fos_wav.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                audioRecord.stop();</span><br><span class="line">                audioRecord.release();</span><br><span class="line">                MP3Recorder.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">    isRecording = <span class="literal">false</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://blog.elight.cn/?post=200">Android 录音详解（一）—— MediaRecorder、AudioRecord、生成wav格式、边录边播</a><br><a href="http://blog.elight.cn/?post=201">Android 录音详解（二）—— 录制 mp3 格式音频（ lame 库的编译及使用）</a><br><a href="http://blog.elight.cn/?post=213">Android 录音详解（三）—— 音频解码</a><br><a href="http://blog.elight.cn/?post=220">Android 录音详解（四）—— 录音添加背景音乐</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS下Wireshark报错Permission denied</title>
      <link href="/blog/2019/07/19/ubuntu18-04-2lts-xia-wireshark-bao-cuo-permission-denied/"/>
      <url>/blog/2019/07/19/ubuntu18-04-2lts-xia-wireshark-bao-cuo-permission-denied/</url>
      
        <content type="html"><![CDATA[<h1 id="安装Wireshark"><a href="#安装Wireshark" class="headerlink" title="安装Wireshark"></a>安装Wireshark</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install wireshark</span></span><br></pre></td></tr></table></figure><p>打开Wireshark，报错提示权限不足。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Couldn’t run /usr/bin/dumpcap in child process: Permission denied</span><br></pre></td></tr></table></figure><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install libcap2-bin</span></span><br><span class="line">// 添加一个组，名字为 wireshark</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> groupadd wireshark</span>  </span><br><span class="line">// 把当前的用户名添加到 wireshark组</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> usermod -a -G wireshark YOUR-USER-NAME</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">newgrp wireshark</span></span><br><span class="line">// 修改组别</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chgrp</span> wireshark /usr/bin/dumpcap</span></span><br><span class="line">// 添加执行权限</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 754 /usr/bin/dumpcap</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">setcap</span> <span class="string">&#x27;CAP_NET_RAW+eip CAP_NET_ADMIN+eip&#x27;</span> /usr/bin/dumpcap</span></span><br></pre></td></tr></table></figure><h1 id="重启或者登出当前用户重新登入"><a href="#重启或者登出当前用户重新登入" class="headerlink" title="重启或者登出当前用户重新登入"></a>重启或者登出当前用户重新登入</h1>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS配置vnc+frp内网穿透实现桌面远程访问</title>
      <link href="/blog/2019/07/10/ubuntu18-04-2lts-pei-zhi-vnc-frp-nei-wang-chuan-tou-shi-xian-zhuo-mian-yuan-cheng-fang-wen/"/>
      <url>/blog/2019/07/10/ubuntu18-04-2lts-pei-zhi-vnc-frp-nei-wang-chuan-tou-shi-xian-zhuo-mian-yuan-cheng-fang-wen/</url>
      
        <content type="html"><![CDATA[<p>之前使用<strong>Teamviewer</strong>来远程电脑，更新之后老是提示被商用，无奈，寻求其他方案如anyDesk、向日葵远程控制、splashtop、VNC。</p><p>frp项目地址：<a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br>frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp,http 和 https协议。<br>VNC，全称为Virtual Network Computing，它是一个桌面共享系统。功能，类似于windows中的远程桌面功能。VNC与Windows远程桌面一样是使用RFB(Remote FrameBuffer，远程帧缓冲）协议来实现远程控制另外一台计算机。</p><h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>本文介绍的是在Ubuntu 18.04.2LTS Bionic Beaver上开启VNC服务端并frp穿透内网实现远程桌面共享。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul><li>操作系统 Ubuntu 18.04.2LTS Bionic Beaver(x86_64)</li><li>云服务器（公网ip地址）</li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="Step-1-启用远程桌面共享"><a href="#Step-1-启用远程桌面共享" class="headerlink" title="Step 1 启用远程桌面共享"></a>Step 1 启用远程桌面共享</h1><p>首先查看下Ubuntu系统上是否安装远程桌面共享，没有的话就执行安装:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install -y vino</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/11/5d269f14e8d6180155.png" alt="desktop sharing"></p><p>使用<code>Activities</code>菜单搜索<code>Sharing</code>可以在<code>Settings</code>部分看到选项，直接打开它，或者以命令行的方式打开</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gnome-control-center sharing</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/11/5d26a667acfd332834.png" alt="Sharing"></p><p>单击Screen Sharing以开始远程桌面配置</p><p><img src="https://i.loli.net/2019/07/11/5d26a7c92f53141971.png"></p><p>将开关打开为<code>ON</code>，可以选择设置密码并记住你设置的密码，后面连接的时候要用密码。</p><p><code>Allow connections to control the screen</code>选项使远程用户能够主动与远程桌面交互。如果未选中此选项，则远程桌面会话将设置为只读。</p><p>启用Ubuntu的远程桌面功能后，可以看到系统正在侦听端口<code>5900</code></p><p><img src="https://i.loli.net/2019/07/11/5d26a98f1745624536.png"></p><p>如果您启用了<strong>UFW</strong>防火墙，请打开<code>5900</code>端口</p><p>类似于:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ufw allow from any to any port 5900 proto tcp</span></span><br><span class="line">Rule added</span><br><span class="line">Rule added (v6)</span><br></pre></td></tr></table></figure><h1 id="Step-2-建立远程桌面连接"><a href="#Step-2-建立远程桌面连接" class="headerlink" title="Step 2 建立远程桌面连接"></a>Step 2 建立远程桌面连接</h1><p>我们将在Ubuntu 18.04系统上使用<a href="https://remmina.org/">Remmina</a>远程桌面客户端，如果没有先安装一个，打开<code>Ubuntu Software</code>搜索<code>remmina</code>安装或者命令行方式安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install remmina</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/11/5d26ab913e00539267.png"></p><p>使用<code>Activities</code>菜单搜索并启动Remmina远程桌面客户端或运行命令行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">remmina</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/11/5d26adac35c9b24367.png"></p><p>从下拉菜单中选择协议<code>VNC</code>,然后输入Ubuntu远程桌面系统的主机名或IP地址，按下<code>Enter</code>键即可连接.</p><p><img src="https://i.loli.net/2019/07/11/5d26af736fdc768784.png"></p><p>输入前面设置的密码确认连接。</p><p><img src="https://i.loli.net/2019/07/11/5d26aff21109717706.png"></p><p>连接成功，是这个样子。</p><p><img src="https://i.loli.net/2019/07/11/5d26b11972e9c82984.png"></p><p>远程桌面共享连接成功。你也可以使用Remmina面板进一步调整远程桌面连接设置。</p><p>好了，到了这一步已经确认我们Ubuntu18.04系统的桌面共享服务已经安装好了。这意味着你将可以与你局域网内的机器实现桌面共享，接下来，使用frp实现内网穿透，对外网提供服务，随时随地可以使用网络远程桌面到Ubuntu 18.04。</p><h1 id="Step-3-配置frp实现内网穿透"><a href="#Step-3-配置frp实现内网穿透" class="headerlink" title="Step 3 配置frp实现内网穿透"></a>Step 3 配置frp实现内网穿透</h1><p>首先下载frp二进制文件 <a href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a><br>根据处理器架构选择对应压缩包</p><ul><li>Windows 64位 ：frp_版本号_windows_amd64.zip</li><li>Windows 32位：frp_版本号_windows_386.zip</li><li>Linux 64位：frp_版本号_linux_amd64.tar.gz</li><li>Linux 32位：frp_版本号_linux_386.tar.gz</li></ul><blockquote><p>注意：从0.18.0版本开始，新版与旧版不兼容，并且部分配置字段不同。请确保服务端和客户端使用同一版本。</p></blockquote><h2 id="下载程序"><a href="#下载程序" class="headerlink" title="下载程序"></a>下载程序</h2><p>我这里云服务器和Ubuntu18.04都是<code>x86_64</code>架构的，所以我下载<code>linux_amd64</code>的压缩包</p><p>下面以<code>x84_64</code>处理器架构举例， 此时frp 最新版是<code>v0.27.0</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看cpu架构</span></span><br><span class="line">arch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建frp文件夹并进入</span></span><br><span class="line">mkdir frp &amp;&amp; cd frp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">wget -q -c --no-check-certificate https://github.com/fatedier/frp/releases/download/v0.27.0/frp_0.27.0_linux_amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -xzvf frp_0.27.0_linux_amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入文件夹</span></span><br><span class="line">cd frp_0.27.0_linux_amd64</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确保 frps 程序具有可执行权限</span></span><br><span class="line">chmod +x frps</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行</span></span><br><span class="line">./frps --help</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/11/5d26db3f4493072975.png"></p><blockquote><p>如果有报错  <code>-bash: ./frps: cannot execute binary file: Exec format error</code>就说明你下错版本</p></blockquote><h2 id="配置程序"><a href="#配置程序" class="headerlink" title="配置程序"></a>配置程序</h2><p>服务端配置参考<a href="https://github.com/fatedier/frp/blob/master/conf/frps_full.ini">frps_full.ini</a><br>客户端配置参考<a href="https://github.com/fatedier/frp/blob/master/conf/frpc_full.ini">frpc_full.ini</a></p><h3 id="服务端-frps-ini"><a href="#服务端-frps-ini" class="headerlink" title="服务端 -frps.ini"></a>服务端 -frps.ini</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面这句开头必须要有，表示配置的开始</span></span><br><span class="line">[common]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frp 服务端端口（必须）</span></span><br><span class="line">bind_port = 7000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frp 服务端密码（必须）</span></span><br><span class="line">token = 12345678</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">认证超时时间，由于时间戳会被用于加密认证，防止报文劫持后被他人利用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因此服务端与客户端所在机器的时间差不能超过这个时间（秒）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认为900秒，即15分钟，如果设置成0就不会对报文时间戳进行超时验证</span></span><br><span class="line">authentication_timeout = 900</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">仪表盘端口，只有设置了才能使用仪表盘（即后台）</span></span><br><span class="line">dashboard_port = 7500</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">仪表盘访问的用户名密码，如果不设置，则默认都是 admin</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你想要用 frp 穿透访问内网中的网站（例如路由器设置页面）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">则必须要设置以下两个监听端口，不设置则不会开启这项功能</span></span><br><span class="line">vhost_http_port = 10080</span><br><span class="line">vhost_https_port = 10443</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此设置需要配合客户端设置，仅在穿透到内网中的 http 或 https 时有用（可选）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">假设此项设置为 example.com，客户端配置 http 时将 subdomain 设置为 <span class="built_in">test</span>，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">则你将 test.example.com 解析到服务端后，可以使用此域名来访问客户端对应的 http</span></span><br><span class="line">subdomain_host = example.com</span><br></pre></td></tr></table></figure><p>这是我的服务端-frps.ini的配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line">token = 12345678</span><br><span class="line">authentication_timeout = 900</span><br><span class="line">dashboard_port = 7500</span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line">vhost_http_port = 8080</span><br><span class="line">subdomain_host = example.com</span><br><span class="line">max_pool_count = 10</span><br><span class="line">log_file = ./frps.log</span><br><span class="line">log_level = info</span><br><span class="line">log_max_days = 3</span><br></pre></td></tr></table></figure><h3 id="客户端-frpc-ini"><a href="#客户端-frpc-ini" class="headerlink" title="客户端 -frpc.ini"></a>客户端 -frpc.ini</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基本配置(必须)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面这句开头必须要有，表示配置的开始</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################################</span></span></span><br><span class="line">[common]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frp 服务端地址，可以填ip或者域名</span></span><br><span class="line">server_addr = 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frp 服务端端口，即填写服务端配置中的 bind_port</span></span><br><span class="line">server_port = 7000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">填写 frp 服务端密码</span></span><br><span class="line">token = 12345678</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">转发 ssh</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义一个配置名称，格式为“[名称]”，放在开头</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################</span></span></span><br><span class="line">[ssh]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接类型，填 tcp 或 udp</span></span><br><span class="line">type = tcp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地ip，填你需要转发到的目的ip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果是转发到frp客户端所在本机（比如路由器）则填 127.0.0.1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">否则填对应机器的内网ip</span></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要转发到的端口，比如 ssh 端口是 22</span></span><br><span class="line">local_port = 22</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否加密客户端与服务端之间的通信，默认是 <span class="literal">false</span></span></span><br><span class="line">use_encryption = false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否压缩客户端与服务端之间的通信，默认是 <span class="literal">false</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">压缩可以节省流量，但需要消耗 CPU 资源</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加密自然也会消耗 CPU 资源，但是不大</span></span><br><span class="line">use_compression = false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frp 服务端的远程监听端口，即你访问服务端的 remote_port 就相当于访问</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端的 local_port，如果填0则会随机分配一个端口</span></span><br><span class="line">remote_port = 6001</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">转发HTTP(s)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义一个配置名称，格式为“[名称]”，放在开头</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################</span></span></span><br><span class="line">[router-web]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接类型，填 http 或 https</span></span><br><span class="line">type = http</span><br><span class="line"></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 80</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http 可以考虑加密和压缩一下</span></span><br><span class="line">use_encryption = true</span><br><span class="line">use_compression = true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义访问网站的用户名和密码，如果不定义的话谁都可以访问，会不安全</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有些路由器如果从内部访问web是不需要用户名密码的，因此需要在这里加一层密码保护</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你发现不加这个密码保护，路由器配置页面原本的用户认证能正常生效的话，可以不加</span></span><br><span class="line">http_user = admin</span><br><span class="line">http_pwd = admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">还记得我们在服务端配置的 subdomain_host = example.com 吗</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">假设这里我们填 web01，那么你将 web01.example.com 解析到服务端ip后</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">你就可以使用 域名:端口 来访问你的 http 了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个域名的作用是用来区分不同的 http，因为你可以配置多个这样的配置</span></span><br><span class="line">subdomain = web01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义域名，这个不同于 subdomain，你可以设置与 subdomain_host 无关的其他域名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">subdomain 与 custom_domains 中至少有一个必须要设置</span></span><br><span class="line">custom_domains = web02.yourdomain.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配路径，可以设置多个，用逗号分隔，比如你设置 locations 为以下这个，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">那么所有 http://xxx/abc 和 http://xxx/def 都会被转发到 http://xxx/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不需要这个功能可以不写这项，就直接该怎么访问就怎么访问</span></span><br><span class="line">locations = /abc,/def</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重写 host header，相当于反向代理中的“发送域名”</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果设置了，转发 http 时，请求中的 host 会被替换成这个</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般情况下不需要用到这个，可以不写这项</span></span><br><span class="line">host_header_rewrite = dev.yourdomain.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCP/UDP 范围转发</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义一个配置名称，格式为“[range:名称]”，放在开头</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################</span></span></span><br><span class="line">[range:multi-port]</span><br><span class="line"></span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">use_encryption = false</span><br><span class="line">use_compression = false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地端口和远程端口可以指定多个范围，如下格式，且范围之间必须一一对应</span></span><br><span class="line">local_port = 6010-6020,6022,6024-6028</span><br><span class="line">remote_port = 16010-16020,16022,16024-16028</span><br></pre></td></tr></table></figure><p>这是我的客户端-frpc.ini的配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = example.com</span><br><span class="line">server_port = 7000</span><br><span class="line">token = 12345678</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">local_ip = 192.168.103.145</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = example.com</span><br><span class="line"></span><br><span class="line">[RDP]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 192.168.103.145</span><br><span class="line">local_port = 5900</span><br><span class="line">remote_port = 5900</span><br></pre></td></tr></table></figure><h4 id="服务器端运行启动"><a href="#服务器端运行启动" class="headerlink" title="服务器端运行启动"></a>服务器端运行启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">nohup</span> /root/frp/frps -c /root/frp/frps.ini &amp;</span></span><br></pre></td></tr></table></figure><h4 id="客户端-Ubuntu18-04-启动"><a href="#客户端-Ubuntu18-04-启动" class="headerlink" title="客户端(Ubuntu18.04)启动"></a>客户端(Ubuntu18.04)启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">nohup</span> /home/xmaihh/frp/frpc -c /home/xmaihh/frp/frpc.ini &amp;</span></span><br></pre></td></tr></table></figure><h4 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pkill frps   或者 pkill frpc</span></span><br></pre></td></tr></table></figure><blockquote><p>云服务器注意放行相关端口.</p></blockquote><h4 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h4><p>自启动可以修改<code>/etc/rc.local</code>文件,加入启动命令<br>或者其他系统自行设置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh -e</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># rc.local</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This script is executed at the end of each multiuser runlevel.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Make sure that the script will <span class="string">&quot;exit 0&quot;</span> on success or any other</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value on error.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># In order to enable or disable this script just change the execution</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bits.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># By default this script does nothing.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">nohup</span> socat TCP4-LISTEN:4443,reuseaddr,fork TCP4:192.168.103.145:8123 &gt;&gt; /root/socat.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">nohup</span> socat UDP4-LISTEN:4443,reuseaddr,fork UDP4:192.168.103.145:8123 &gt;&gt; /root/socat.log 2&gt;&amp;1 &amp;</span></span><br><span class="line">nohup /root/frp/frps -c /root/frp/frps.ini &amp;</span><br><span class="line">exit 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="建立远程连"><a href="#建立远程连" class="headerlink" title="建立远程连"></a>建立远程连</h1><p>请注意<code>remote_port = 5900</code>我把Ubuntu18.04的VNC Sharing端口<code>5900</code>映射到云服务器的<code>5900</code>端口，建立连接时，连接你的<code>服务器+服务器端口号</code>。</p><p>这里我使用手机开数据网络，关闭WIFi，下载<code>VNC Viewer</code>客户端来一下远程连接。</p><p><img src="https://i.loli.net/2019/07/12/5d27d97f26fb410469.png"></p><p>打开手机<code>VNC Viewer</code>,点击<code>+</code>,在<code>Address</code>处填入 ip+端口形式 <code>xxx.xxx.xxx.xxx::5900</code>或者 域名+端口形式 <code>example.com::5900</code>。</p><p><img src="https://i.loli.net/2019/07/12/5d27dba5ee57884621.png"></p><p>点击进行下一步输入密码以看到画面了。</p><p><img src="https://i.loli.net/2019/07/12/5d27dbbc9663997267.png"></p><h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="No-matching-security-types"><a href="#No-matching-security-types" class="headerlink" title="No matching security types"></a>No matching security types</h2><p>VNC客户端不支持加密。任何连接到远程桌面共享服务器的尝试都将导致<code>No matching security types</code>错误</p><p>如果遇到这个错误，请按照以下步骤解决:</p><ol><li>安装<code>dconf</code>工具</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install dconf-tools</span></span><br></pre></td></tr></table></figure><ol start="2"><li>打开<code>dconf-editor</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dconf-editor</span></span><br></pre></td></tr></table></figure><p>依次切换到<code>org-&gt;gnome-&gt;desktop-&gt;remote-access</code>并将<code>require-encryption</code>项目关闭。</p><p><img src="https://i.loli.net/2019/07/12/5d27e1f110d9a37918.png"></p><ol start="3"><li>执行</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gsettings <span class="built_in">set</span> org.gnome.Vino require-encryption <span class="literal">false</span></span></span><br></pre></td></tr></table></figure><blockquote><p>如果输出警告：<code>GLib-GIO-Message: 10:19:43.137: Using the &#39;memory&#39; GSettings backend.  Your settings will not be saved or shared with other applications.</code><br>可以先执行<code>export GIO_EXTRA_MODULES=/usr/lib/x86_64-linux-gnu/gio/modules/</code>然后再执行3。</p></blockquote><ol start="4"><li>确认已禁用远程服务器上的加密</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gsettings list-recursively org.gnome.Vino | grep encrypt</span> </span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/12/5d27e488a925935610.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.tecmint.com/enable-desktop-sharing-in-ubuntu-linux-mint/">How To Enable Desktop Sharing In Ubuntu and Linux Mint</a><br><a href="https://moe.best/tutorial/frp.html">内网穿透神器搭建 萌新也看得懂的教程系列</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL字符转义处理方法</title>
      <link href="/blog/2019/06/18/mysql-zi-fu-zhuan-yi-chu-li-fang-fa/"/>
      <url>/blog/2019/06/18/mysql-zi-fu-zhuan-yi-chu-li-fang-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL转义字符"><a href="#MySQL转义字符" class="headerlink" title="MySQL转义字符"></a>MySQL转义字符</h1><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>\0</td><td>ASCII 0(NUL)字符</td><td></td></tr><tr><td>&#39;</td><td>ASCII 39 单引号(‘’’)</td><td></td></tr><tr><td>&quot;</td><td>ASCII 34 双引号(‘“’)</td><td></td></tr><tr><td>\b</td><td>ASCII 8 退格符</td><td></td></tr><tr><td>\n</td><td>ASCII 10 换行符</td><td></td></tr><tr><td>\r</td><td>ASCII 13 回车符</td><td></td></tr><tr><td>\t</td><td>ASCII 9 制表符(TAB)</td><td></td></tr><tr><td>\Z</td><td>ASCII 26(控制（Ctrl）-Z)。该字符可以编码为‘\Z’，以允许你解决在Windows中ASCII 26代表文件结尾这一问题</td><td></td></tr><tr><td>\</td><td>反斜线(‘\’)字符</td><td></td></tr><tr><td>%</td><td>‘%’字符</td><td></td></tr><tr><td>_</td><td>‘_’字符</td><td></td></tr></tbody></table><p>比如,对单引号、双引号和反斜杠的转义处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">origin = origin.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>)</span><br><span class="line">origin = origin.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\\&#x27;&quot;</span>)</span><br><span class="line">origin = origin.replace(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;\\&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="判断是否需要转义方法"><a href="#判断是否需要转义方法" class="headerlink" title="判断是否需要转义方法"></a>判断是否需要转义方法</h1><p>判断字符串是否含有特殊符号,Java方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断内容是否需要进行转义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isNeedEscape</span><span class="params">(String x)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">needsHexEscape</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(x)) &#123;</span><br><span class="line">        <span class="keyword">return</span> needsHexEscape;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">stringLength</span> <span class="operator">=</span> x.length();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i &gt;= stringLength)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> x.charAt(i);</span><br><span class="line">        <span class="keyword">switch</span>(c)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// &#x27;\0&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>: <span class="comment">// &#x27;\n&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>: <span class="comment">// &#x27;\r&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">92</span>: <span class="comment">// &#x27;\\&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">39</span>: <span class="comment">// &#x27;\&#x27;&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">34</span>: <span class="comment">// &#x27;&quot;&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">26</span>: <span class="comment">// &#x27;\032&#x27;</span></span><br><span class="line">            needsHexEscape = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(needsHexEscape)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        i++;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> needsHexEscape;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对字符转义处理:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对mysql字符进行转义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">escapeString</span><span class="params">(String x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(Strings.isBlank(x)) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!isNeedEscape(x)) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">stringLength</span> <span class="operator">=</span> x.length();</span><br><span class="line">    <span class="type">String</span> <span class="variable">parameterAsString</span> <span class="operator">=</span> x;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>((<span class="type">int</span>)((<span class="type">double</span>)x.length() * <span class="number">1.1000000000000001D</span>));</span><br><span class="line">    <span class="comment">// 可以指定结果前后追加单引号：&#x27;</span></span><br><span class="line">    <span class="comment">//buf.append(&#x27;\&#x27;&#x27;);</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; stringLength; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> x.charAt(i);</span><br><span class="line">        <span class="keyword">switch</span>(c)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// &#x27;\0&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>: <span class="comment">// &#x27;\n&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;n&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>: <span class="comment">// &#x27;\r&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">92</span>: <span class="comment">// &#x27;\\&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">39</span>: <span class="comment">// &#x27;\&#x27;&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">34</span>: <span class="comment">// &#x27;&quot;&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">26</span>: <span class="comment">// &#x27;\032&#x27;</span></span><br><span class="line">            buf.append(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;Z&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        buf.append(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 可以指定结果前后追加单引号：&#x27;</span></span><br><span class="line">    <span class="comment">//buf.append(&#x27;\&#x27;&#x27;);</span></span><br><span class="line">    parameterAsString = buf.toString();</span><br><span class="line">    <span class="keyword">return</span> parameterAsString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>MySQL</code>语句没有处理好转义字符，通常会报错:<code>Error code 1064: Syntax error</code></p></blockquote><h1 id="Python中re-escape-函数"><a href="#Python中re-escape-函数" class="headerlink" title="Python中re.escape()函数"></a>Python中<code>re.escape()</code>函数</h1><p>re.escape()是用来处理需要进行正则表达式匹配的字符串中，本身包含正则表达式元字符的情况，这个函数的处理方法也很简单，就是对字符串中所有的非字母（ASCII letters）、数字（numbers）及下划线（’_’）的字符前都加反斜线（’\‘），这样进行转义处理。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">a = <span class="string">&quot;he&#x27;s pen.&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a)  <span class="comment"># he&#x27;s pen.</span></span><br><span class="line">a = re.escape(a)</span><br><span class="line"><span class="built_in">print</span>(a)  <span class="comment"># he\&#x27;s\ pen\.</span></span><br><span class="line">a = a.replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(a)  <span class="comment"># he&#x27;s pen.</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jyoryo.com/index.php/archives/21.html">MySQL字符转义涉及的问题及解决</a><br><a href="https://www.polarxiong.com/archives/Python-%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E9%9D%9E%E5%AD%97%E6%AF%8D-%E6%95%B0%E5%AD%97%E6%88%96%E4%B8%8B%E5%88%92%E7%BA%BF%E5%AD%97%E7%AC%A6%E8%BF%9B%E8%A1%8C%E8%BD%AC%E4%B9%89.html">Python:对字符串中非字母、数字或下划线字符进行转义</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux与Windows文件显示乱码</title>
      <link href="/blog/2019/06/05/linux-yu-windows-wen-jian-xian-shi-luan-ma/"/>
      <url>/blog/2019/06/05/linux-yu-windows-wen-jian-xian-shi-luan-ma/</url>
      
        <content type="html"><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>从Windows内拷贝一个txt文件到Linux下打开显示乱码</p><ul><li><p>Windows下默认使用GB2312编码</p></li><li><p>Linux下默认使用UTF-8编码</p></li></ul><p>＃　解决办法</p><p>使用Linux下的<code>iconv</code>命令改变文件的编码</p><p>  <code>test.txt</code>由<code>GB2312</code>转换成<code>UTF-8</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv　 -f 　GB2312　 -t　 UTF-8　 test.txt　 -o 　test.txt</span><br></pre></td></tr></table></figure><p>  <code>test.txt</code>由<code>UTF-8</code>转换成<code>GB2312</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv　-f　 UTF-8　 -t　 GB2312 　test.txt　 -o 　test.txt</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装MySQL</title>
      <link href="/blog/2019/05/17/ubuntu18-04-2lts-an-zhuang-mysql/"/>
      <url>/blog/2019/05/17/ubuntu18-04-2lts-an-zhuang-mysql/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.mysql.com/">MySQL</a>是一个开源数据库管理系统，通常作为流行的<a href="https://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP</a> （Linux，Apache，MySQL，PHP &#x2F; Python &#x2F; Perl）的一部分进行安装。 它使用关系数据库和SQL（结构化查询语言）来管理其数据。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul><li>Ubuntu 18.04.2 LTS</li><li>MySQL 5.7.26</li><li>MySQL Workbench (可视化＊可选)</li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在 Ubuntu 18.04 中，默认情况下最新版本的 MySQL 包含在 APT 软件包存储库中,直接执行安装即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt update</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install mysql-server</span></span><br></pre></td></tr></table></figure><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>接下来配置MySQL，执行命令，运行MySQL附带的安全脚本，根据提示操作修改一些默认规则。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mysql_secure_installation</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/17/5cde7753987ea12819.png"></p><p><img src="https://i.loli.net/2019/05/17/5cde78771595f84396.png"></p><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>安装完MySQL已经开始自动运行。 运行命令检查一下状态。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status mysql.service</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/17/5cde790f819fe19186.png"></p><p>显示如上信息说明mysql服务是正常的。</p><p>如果MySQL没有运行，你可以用<code>sudo systemctl start mysql</code>启动它。</p><p>尝试使用mysqladmin工具连接到数据库，该工具是允许您运行管理命令的客户端。 例如，该命令表示以root身份连接到MySQL（ -u root ），提示输入密码（ -p ）并返回该版本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mysqladmin -p -u root version</span></span><br></pre></td></tr></table></figure><p>得到类似以下输出:<br><img src="https://i.loli.net/2019/05/17/5cde7fec58af778411.png"></p><h1 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h1><p>MySQL可视化工具软件安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install mysql-workbench</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/17/5cde82554de7656758.png"></p><p>在Ubuntu中打开MySQL Workbench软件可以看到有一个本地连接，点进去打开开报错了。</p><p><img src="https://i.loli.net/2019/05/17/5cde84a6c61a011438.png"></p><blockquote><p>这跟前面配置有一些关系，前面删除了匿名用户和测试数据库，禁止了远程root用户登录。</p></blockquote><p>这里来通过配置添加一个可以访问的数据库。</p><h2 id="进入MySQL控制台"><a href="#进入MySQL控制台" class="headerlink" title="进入MySQL控制台"></a>进入MySQL控制台</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mysql -uroot -p</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/20/5ce25bd4e87f614892.png"></p><h2 id="新建数据库和用户"><a href="#新建数据库和用户" class="headerlink" title="新建数据库和用户"></a>新建数据库和用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 创建数据库ticket</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">CREATE DATABASE ticket;</span></span><br><span class="line">// 创建用户xmai(密码Uf4bGZ53Ds*#) 并赋予其ticketDB数据库的所有权限</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GRANT ALL PRIVILEGES ON ticket.* TO xmai@localhost IDENTIFIED BY <span class="string">&quot;Uf4bGZ53Ds*#&quot;</span>;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/21/5ce3a2ddd80a069294.png"></p><blockquote><p>我们在前面MySQL配置时，增加了密码强度验证插件validate_password，相关参数设置的较为严格。使用了该插件会检查设置的密码是否符合当前设置的强度规则，若不满足则拒绝设置并报错类似<code>ERROR 1819 (HY000):Your password does not satisfy the current policy requirements</code>。前面我选择的是<code>[1] MEDIUM Length &gt;=8 , numeric,mixed case, and special characters</code></p></blockquote><h2 id="进行访问控制配置"><a href="#进行访问控制配置" class="headerlink" title="进行访问控制配置"></a>进行访问控制配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 允许xmai用户可以从任意机器上登入mysql</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GRANT ALL PRIVILEGES ON ticket.* TO xmai@<span class="string">&quot;%&quot;</span> IDENTIFIED BY <span class="string">&quot;Uf4bGZ53Ds*#&quot;</span>;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/21/5ce3a337c4c2c27607.png"></p><p>配置完成。</p><p>打开MySQL workbench连接数据库</p><p><img src="https://i.loli.net/2019/05/21/5ce3a3ca4f6b732789.png"></p><p>配置访问的数据库用户名和密码，确定。</p><p><img src="https://i.loli.net/2019/05/21/5ce3a4dc6156450553.png"></p><h2 id="允许局域网连接"><a href="#允许局域网连接" class="headerlink" title="允许局域网连接"></a>允许局域网连接</h2><p>修改连接 <code>bind-address</code> 配置项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure><p>修改<code>bind-address = 127.0.0.1</code>配置或者修改为<code>bind-address = 0.0.0.0</code>，来允许所有IP访问，或者输入一个你指定的IP地址</p><p>保存后使用以下命令重启mysql</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> /etc/init.d/mysql restart</span><br></pre></td></tr></table></figure><p>使用以下命令进入mysql修改访问权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> mysql -uroot -p</span><br><span class="line">输入密码</span><br><span class="line">$ use mysql</span><br><span class="line">//授权用户能进行远程连接</span><br><span class="line">$ grant all privileges on *.* to root@<span class="string">&quot;%&quot;</span> identified by <span class="string">&quot;password&quot;</span> with grant option;</span><br><span class="line">//刷新权限信息</span><br><span class="line">$ flush privileges;</span><br></pre></td></tr></table></figure><p>命令中的两个星号，第一个星号表示数据库名称，第二个星号表示该数据库下的某个表名称。写成两个星号表示所有的数据库都进行授权。<br>root表示授权root账号。<br>“%”表示授权的用户IP可以指定，这里代表任意的IP地址都能访问MySQL数据库。<br>“password”表示分配账号对应的密码，这里密码自己替换成你的mysql root帐号密码</p><p>所以此处可以写成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant all PRIVILEGES on testdabatase.testtable to username@<span class="string">&#x27;192.168.1.2&#x27;</span> identified by <span class="string">&#x27;user-pass&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Error-1366-Incorrect-string-value-‘-xE7-xA0-x94-xE5-x8F-x91…’-for-column-‘departname’-at-row-1"><a href="#Error-1366-Incorrect-string-value-‘-xE7-xA0-x94-xE5-x8F-x91…’-for-column-‘departname’-at-row-1" class="headerlink" title="Error 1366: Incorrect string value: ‘\xE7\xA0\x94\xE5\x8F\x91…’ for column ‘departname’ at row 1"></a>Error 1366: Incorrect string value: ‘\xE7\xA0\x94\xE5\x8F\x91…’ for column ‘departname’ at row 1</h2><p>插入数据时,报异常。MySQL的utf8编码最多3个字节，UTF-8编码有可能是两个、三个、四个字节，如Emoji表情或者某些特殊字符是4个字节,所以数据插不进去 。</p><p>一顿搜索后找到解决方案</p><ol><li>在mysql的安装目录下找到<code>/etc/mysql/my.cnf</code>,作如下修改</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">default-character-set=utf8mb4</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/21/5ce3b6a8168b938652.png"></p><p>​修改后重启Mysql   <code> sudo service mysql restart</code></p><ol start="2"><li>将已经建好的表也转换成utf8mb4</li></ol><p>在终端执行<code>sudo mysql -uroot -p</code>命令进入MySQL控制台<br>然后执行 命令：<code>alter table TABLE_NAME convert to character set utf8mb4 collate utf8mb4_bin;</code></p><p>将TABLE_NAME替换成你的表名即可。</p><p><img src="https://i.loli.net/2019/05/21/5ce3b49a3e2f723010.png"></p><p>可以看到插入数据成功！</p><p><img src="https://i.loli.net/2019/05/21/5ce3baaca602961339.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.howtoing.com/how-to-install-mysql-on-ubuntu-18-04/">如何在Ubuntu 18.04上安装MySQL</a></p><p><a href="https://blog.csdn.net/azhegps/article/details/71480633">解决mysql插入数据时出现Incorrect string value: ‘\xF0\x9F…’ for column ‘name’ at row 1的异常</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang交叉编译</title>
      <link href="/blog/2019/05/16/golang-jiao-cha-bian-yi/"/>
      <url>/blog/2019/05/16/golang-jiao-cha-bian-yi/</url>
      
        <content type="html"><![CDATA[<p>Golang交叉编译，一个平台环境下生成其他平台的可执行程序。</p><ul><li>GOOS：目标平台的操作系统（darwin、freebsd、linux、windows） </li><li>GOARCH：目标平台的体系架构（386、amd64、arm） </li><li>CGO_ENABLED:  开启&#x2F;禁止C与Go混编(0,1)</li></ul><p>Mac 下编译 Linux 和 Windows 64位可执行程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go</span></span><br></pre></td></tr></table></figure><p>Linux 下编译 Mac 和 Windows 64位可执行程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build main.go</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go</span></span><br></pre></td></tr></table></figure><p>Windows 下编译 Mac 和 Linux 64位可执行程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SET CGO_ENABLED=0 </span><br><span class="line">SET GOOS=darwin </span><br><span class="line">SET GOARCH=amd64 </span><br><span class="line">go build main.go </span><br><span class="line"></span><br><span class="line">SET CGO_ENABLED=0 </span><br><span class="line">SET GOOS=linux </span><br><span class="line">SET GOARCH=amd64 </span><br><span class="line">go build main.go</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/huyongtq/article/details/81805065">go交叉编译arm上的程序</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装微信web开发工具(wine)</title>
      <link href="/blog/2019/05/14/ubuntu18-04-2lts-an-zhuang-wei-xin-web-kai-fa-gong-ju-wine/"/>
      <url>/blog/2019/05/14/ubuntu18-04-2lts-an-zhuang-wei-xin-web-kai-fa-gong-ju-wine/</url>
      
        <content type="html"><![CDATA[<p>当我打开微信小程序开发者工具<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=19051421">下载页</a><br><img src="https://i.loli.net/2019/05/15/5cdb74fe9716f93266.png"></p><p>额，没有Linux版本。好吧，自力更生。</p><h1 id="Linux微信web开发者工具"><a href="#Linux微信web开发者工具" class="headerlink" title="Linux微信web开发者工具"></a>Linux微信web开发者工具</h1><h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><ul><li><a href="https://wiki.winehq.org/Ubuntu">Wine</a></li><li><a href="https://github.com/cytle/wechat_web_devtools">Linux微信web开发者工具</a></li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><p>如果您之前安装过来自其他仓库的 Wine 安装包，请在尝试安装 WineHQ 安装包之前删除它及依赖它的所有安装包（如：wine-mono、wine-gecko、winetricks），否则可能导致依赖冲突。</p><h2 id="Step1-删除之前安装的Wine"><a href="#Step1-删除之前安装的Wine" class="headerlink" title="Step1 删除之前安装的Wine"></a>Step1 删除之前安装的Wine</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 1. 删除软件及配置文件</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get --purge remove wine</span></span><br><span class="line">// 2. 删除没用的依赖包</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get autoremove wine</span></span><br><span class="line">// 3. 此时dpkg的列表中有&quot;rc&quot;状态的软件包,可以执行以下命令进行最后清理</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dpkg -l |grep ^rc|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |<span class="built_in">sudo</span> xargs dpkg -P</span></span><br><span class="line">// 4. 然后删除安装包,位于/root/.wine和/home/usrname/.wine</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf /root/.wine</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf /home/usrname/.wine</span></span><br></pre></td></tr></table></figure><blockquote><p>删除之后可能残留wine快捷方式的残留目录，进入目录检查下是否包含wine相关的内容</p><p>&#x2F;usr&#x2F;share&#x2F;applications&#x2F;            <em>&#x2F;&#x2F;wine快捷方式</em><br>&#x2F;usr&#x2F;share&#x2F;app-install&#x2F;                <em>&#x2F;&#x2F;wine快捷方式</em><br>&#x2F;home&#x2F;username&#x2F;.lacal&#x2F;             <em>&#x2F;&#x2F;wine应用程序快捷方式</em><br>&#x2F;home&#x2F;username&#x2F;.cache&#x2F;           <em>&#x2F;&#x2F;wine应用程序快捷方式</em><br>&#x2F;home&#x2F;username&#x2F;.config&#x2F;menus&#x2F;applications-merged&#x2F; </p></blockquote><h2 id="Step2-安装-WineHQ-安装包"><a href="#Step2-安装-WineHQ-安装包" class="headerlink" title="Step2 安装 WineHQ 安装包"></a>Step2 安装 <a href="https://wiki.winehq.org/Ubuntu_zhcn">WineHQ 安装包</a></h2><p>如果您使用的是 64 位系统，请开启 32 bit 架构支持（如果您之前没有开启的话）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> dpkg --add-architecture i386</span> </span><br><span class="line">// 下载添加仓库密钥</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget -nc https://dl.winehq.org/wine-builds/Release.key</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-key add Release.key</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/</span></span><br><span class="line">// 添加仓库</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-add-repository<span class="string">&#x27;deb https://dl.winehq.org/wine-builds/ubuntu/ xenial main&#x27;</span></span></span><br><span class="line">// 更新软件包</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get update</span></span><br><span class="line">// 安装以下任一一个安装包</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install --install-recommends winehq-stable   // 稳定的分支</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install --install-recommends winehq-devel    // 开发分支</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install --install-recommends winehq-staging  //Staging 分支</span></span><br><span class="line">// 查看wine版本命令</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wine --version</span></span><br></pre></td></tr></table></figure><blockquote><p>错误1：“E: 仓库 “<a href="http://ppa.launchpad.net/ubuntu-wine/ppa/ubuntu">http://ppa.launchpad.net/ubuntu-wine/ppa/ubuntu</a> bionic Release” 没有 Release 文件。”  Ubuntu18.04LTS的版本代号为<code>bionic</code>，<br>这里报错我把这里<code>bionic</code>修改为Ubuntu16.04LTS的版本代号<code>xenial</code></p><p>错误2：’’W: GPG 错误：<a href="http://dl.winehq.org/wine-builds/ubuntu">http://dl.winehq.org/wine-builds/ubuntu</a> xenial InRelease: 由于没有公钥，无法验证下列签名： NO_PUBKEY 76F1A20FF987672F<br>E: 仓库 “<a href="http://dl.winehq.org/wine-builds/ubuntu">http://dl.winehq.org/wine-builds/ubuntu</a> xenial InRelease” 没有数字签名”<br>执行命令<code>$ sudo apt-key adv --recv-keys --keyserver keyserver.Ubuntu.com F987672F</code></p></blockquote><h2 id="Step3-安装Linux微信web开发者工具"><a href="#Step3-安装Linux微信web开发者工具" class="headerlink" title="Step3  安装Linux微信web开发者工具"></a>Step3  安装<a href="https://github.com/cytle/wechat_web_devtools">Linux微信web开发者工具</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/cytle/wechat_web_devtools.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> wechat_web_devtools</span></span><br><span class="line">// 自动下载最新 `nw.js` , 同时部署目录 `~/.config/wechat_web_devtools/`</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bin/wxdt install</span></span><br><span class="line">// 启动</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bin/wxdt</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/15/5cdb8297a445c94962.png"></p><h2 id="Step4-创建一个启动图标"><a href="#Step4-创建一个启动图标" class="headerlink" title="Step4 创建一个启动图标"></a>Step4 创建一个启动图标</h2><p>在 &#x2F;usr&#x2F;shared&#x2F;applications&#x2F; 目录下，添加 xxx.desktop 文件（xxx为应用程序名），填写相关信息，保存即可。</p><p>例如，Icon&#x3D;xxx ,Exec&#x3D;xxx 替换为你的相应目录即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env xdg-open</span></span><br><span class="line"></span><br><span class="line">[Desktop Entry]</span><br><span class="line">Encoding=UTF-8</span><br><span class="line">Type=Application</span><br><span class="line">Categories=Development;</span><br><span class="line">Icon=/home/xmaihh/Application/wechat_web_devtools/images/we_dev.png</span><br><span class="line">Exec=/home/xmaihh/Application/wechat_web_devtools/bin/wxdt                      </span><br><span class="line">Name=WeChat Web develop tools</span><br><span class="line">Name[zh_CN]=微信Web开发工具</span><br><span class="line">MimeType=</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/15/5cdb892f6e8e153613.png"></p><p>附上<a href="https://i.loli.net/2019/05/15/5cdb836d0232a43197.png">微信Web开发工具icon128x128</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS解决KVM permision denied报错</title>
      <link href="/blog/2019/05/10/ubuntu18-04-2lts-jie-jue-kvm-permision-denied-bao-cuo/"/>
      <url>/blog/2019/05/10/ubuntu18-04-2lts-jie-jue-kvm-permision-denied-bao-cuo/</url>
      
        <content type="html"><![CDATA[<p>我在尝试在Ubuntu18.04.2LTS的AndroidStudio上运行Android Virtual Device(AVD) 时，遇到这个报错：<code>/dev/kvm device: permission denied</code>。</p><p><img src="https://i.loli.net/2019/05/10/5cd4f15ca663e.png"></p><p>解决：</p><ol><li>Install <code>qemu-kvm</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install qemu-kvm</span></span><br></pre></td></tr></table></figure><ol start="2"><li>添加当前用户到kvm组</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> adduser &lt;username&gt; kvm</span></span><br></pre></td></tr></table></figure><ol start="3"><li>添加当前用户权限</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chown</span> &lt;username&gt; /dev/kvm</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/10/5cd4f3a098847.png"></p><p>完成所有步骤后，可以成功启动AVD了。</p><p><img src="https://i.loli.net/2019/05/10/5cd4f4139318f.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.chirathr.com/android/ubuntu/2018/08/13/fix-avd-error-ubuntu-18-04/">How to fix KVM permission denied error on Ubuntu 18.04</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-SDK开发</title>
      <link href="/blog/2019/04/30/android-sdk-kai-fa/"/>
      <url>/blog/2019/04/30/android-sdk-kai-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="SDK简介"><a href="#SDK简介" class="headerlink" title="SDK简介"></a>SDK简介</h1><p>SDK(Software Development Kit)，广泛意义上的 <code>SDK</code> 一般都是为特定的软件包、软件框架、硬件平台、操作系统等建立应用程序时所使用的开发工具的集合（<code>系统 SDK</code>）。而狭义上的 <code>SDK</code>（<code>应用 SDK</code>） 则是基于<code>系统 SDK</code> 进行开发的新的、独立于具体业务且完成特定功能的一组工具的集合。通常情况下，SDK 在应用程序中是作为特定功能提供者的角色出现的。例如推送功能的 SDK、统计功能的 SDK、广告功能的 SDK、性能监测功能的 SDK 以及分享功能的 SDK 等等。</p><h1 id="SDK设计"><a href="#SDK设计" class="headerlink" title="SDK设计"></a>SDK设计</h1><ul><li>易用性</li><li>稳定性</li><li>灵活性</li><li>最小资源开销</li><li>主线程</li><li>最小权限原则</li><li>严格的生命周期把控</li></ul><h1 id="API设计"><a href="#API设计" class="headerlink" title="API设计"></a>API设计</h1><ul><li>单一职责原则</li><li>参数尽可能少</li><li>参数合法性校验</li><li>优美的降解(预期的异常抛出)</li><li>实现不要影响API</li></ul><h1 id="版本管理"><a href="#版本管理" class="headerlink" title="版本管理"></a>版本管理</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">     alpha版本</span><br><span class="line">        +</span><br><span class="line">        v</span><br><span class="line">     beta版本</span><br><span class="line">        +</span><br><span class="line">        v</span><br><span class="line">release candidate版本(rc版)</span><br><span class="line">        +</span><br><span class="line">        v</span><br><span class="line">  release版本(发布)</span><br></pre></td></tr></table></figure><ul><li><p>alpha 版：该版本表示该 SDK 产品在此阶段主要是以实现功能为主，通常只在开发团队内部交流使用。一般来说，该版本的 SDK 产品存在的 Bug 较多，需要经历多个 alpha 版本的迭代才能进入 beta 版。</p></li><li><p>beta 版：该版本相对于 alpha 版已经有了很大的改进，修复了严重的 Bug，但是还存在一些已知或是未知的 Bug，通常情况下只在开发团队以及测试团队之间交流使用，需要经历多个 beta 版本的迭代才能进入 rc 版。</p></li><li><p>release candidate 版（rc 版）：该版本的 SDK 趋于成熟，基本上不会出现导致错误的 Bug，原则上不再增加新的功能，与正式发布的正式版没有太大的差异。通常情况下该版本用于进行小规模灰度测试，原则上不会提供给应用程序开发者使用。</p></li><li><p>release 版：该版本意味着 最终发布，在经历了前面几个版本的迭代之后产生的最终版本，也就是最终交付到应用程序开发者使用的版本。</p></li></ul><h1 id="SDK版本号命名"><a href="#SDK版本号命名" class="headerlink" title="SDK版本号命名"></a>SDK版本号命名</h1><p>一个比较合理的版本号命名规范由如下四部分组成：</p><p>V1_0_2_201904301717_beta</p><ol><li>主版本号（1）</li><li>子版本号（0）</li><li>阶段版本号（2）</li><li>迭代版本号（201904301717_beta）</li></ol><p>SDK版本号修改原则:</p><ul><li><p>主版本号：当功能模块有较大的变动，比如增加多个模块或者 SDK 整体架构发生变化时，由需求决定是否修改。</p></li><li><p>子版本号：当功能有一定的增加或变化时，由项目决定是否修改。</p></li><li><p>阶段版本号：当修复 Bug 以及小规模调整时，需要经常发布修订版，此时可由项目经理决定是否修改。</p></li><li><p>迭代版本号：用于记录该版本的 SDK 发布时的时间以及当前的迭代状态。原则上，当项目处于 alpha、beta以及 rc 版时，该版本号需要体现每一次的修改时间以及状态。当项目处于 release 版时，该版本号用于记录该版本的发版时间。</p></li></ul><h1 id="API版本管理"><a href="#API版本管理" class="headerlink" title="API版本管理"></a>API版本管理</h1><p><code>API</code>的版本受到 SDK 版本迭代状态的约束，但是不受 SDK 版本号修改原则的限制。<br>只有处于 <code>release</code>（或<code>rc</code> ） 状态的  API 才能是对外提供服务的，否则该 API 应该是对应用程序开发人员不可见的。换句话说就是，坚决不发布处于 alpha 和 beta 状态的 API。</p><p>API 一旦对外发布，其内部实现以及方法签名原则上处于不可变更状态：</p><p>如果需要修改 API 的内部实现，在保证方法签名不变的情况下，API 必须通过测试用例的边界及功能测试，并尽可能的给出原 API 实现的备份——使用<code>oldMethodName</code>前缀标识原 API；<br>如果需要变更方法签名，比如增加、删除参数或是改变返回值类型，那么在保证原 API 不变的情况下，使用方法重载实现新的 API。<br>如果需要废弃某些 API，应在 SDK release 版本迭代的前 N 个版本使用<code>@deprecated</code>标识需要废弃的 API，并给出该 API 的替代方案以及具体的 API 移除时间（或是 SDK 版本）。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jianshu.com/p/28becca53726">Android SDK 开发（第一部分</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidStudio获取sha1码</title>
      <link href="/blog/2019/04/26/androidstudio-huo-qu-sha1-ma/"/>
      <url>/blog/2019/04/26/androidstudio-huo-qu-sha1-ma/</url>
      
        <content type="html"><![CDATA[<p>在使用百度地图API时，需要获取项目的sha1码，在AndroidStudio3.3版本获取方法如下：</p><p><img src="https://i.loli.net/2019/04/26/5cc2c43ccf73f.png"></p><p>双击执行<code>SigningReport</code>任务后，在<code>Run</code>窗口即可看到生成的<code>SHA1</code>和<code>MD5</code>码，如图所示。</p><p><img src="https://i.loli.net/2019/04/26/5cc2c4cd22c1b.png"></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android颜色透明度计算</title>
      <link href="/blog/2019/04/24/android-yan-se-tou-ming-du-ji-suan/"/>
      <url>/blog/2019/04/24/android-yan-se-tou-ming-du-ji-suan/</url>
      
        <content type="html"><![CDATA[<h1 id="Android颜色透明度计算"><a href="#Android颜色透明度计算" class="headerlink" title="Android颜色透明度计算"></a>Android颜色透明度计算</h1><h2 id="Android中颜色简介"><a href="#Android中颜色简介" class="headerlink" title="Android中颜色简介"></a>Android中颜色简介</h2><p>Android中的颜色值通常遵循RGB&#x2F;ARGB标准，使用时通常以<code>#</code>字符开头，以16进制表示。<br>其中RGB依次代表红色（Red）、绿色（Green）、蓝色（Blue）.<br>ARGB依次代表透明度(Alpha)、红色（Red）、绿色（Green）、蓝色（Blue） </p><p>eg:#FF00CC99其中FF是透明度，00是红色值，CC是绿色值，99是蓝色值</p><h2 id="不透明度"><a href="#不透明度" class="headerlink" title="不透明度"></a>不透明度</h2><p>透明度的范围是0-255，在计算机中，我们就用16进制(00-FF)表示，全透明就是00，完全不透明就是FF</p><p>透明度和不透明度加起来等于1或者说100%</p><h2 id="计算方法"><a href="#计算方法" class="headerlink" title="计算方法"></a>计算方法</h2><p>255 * 不透明度 -&gt; 转换成16进制数</p><p>eg:30%不透明度也就是255*30%&#x3D;76.5，四舍五入77，然后利用计算器转为16进制为4D</p><p>下面是代码计算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">float</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="number">255</span> * i * <span class="number">1.0f</span> / <span class="number">100f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">alpha</span> <span class="operator">=</span> Math.round(temp);</span><br><span class="line">            <span class="type">String</span> <span class="variable">hexStr</span> <span class="operator">=</span> Integer.toHexString(alpha);</span><br><span class="line">            <span class="keyword">if</span> (hexStr.length() &lt; <span class="number">2</span>)</span><br><span class="line">                hexStr = <span class="string">&quot;0&quot;</span> + hexStr;</span><br><span class="line">            System.out.println(i + <span class="string">&quot;%, &quot;</span> + hexStr.toUpperCase());</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h2><table><thead><tr><th>不透明度</th><th>16进制表示</th></tr></thead><tbody><tr><td>0%</td><td>00</td></tr><tr><td>1%</td><td>03</td></tr><tr><td>2%</td><td>05</td></tr><tr><td>3%</td><td>08</td></tr><tr><td>4%</td><td>0A</td></tr><tr><td>5%</td><td>0D</td></tr><tr><td>6%</td><td>0F</td></tr><tr><td>7%</td><td>12</td></tr><tr><td>8%</td><td>14</td></tr><tr><td>9%</td><td>17</td></tr><tr><td>10%</td><td>1A</td></tr><tr><td>11%</td><td>1C</td></tr><tr><td>12%</td><td>1F</td></tr><tr><td>13%</td><td>21</td></tr><tr><td>14%</td><td>24</td></tr><tr><td>15%</td><td>26</td></tr><tr><td>16%</td><td>29</td></tr><tr><td>17%</td><td>2B</td></tr><tr><td>18%</td><td>2E</td></tr><tr><td>19%</td><td>30</td></tr><tr><td>20%</td><td>33</td></tr><tr><td>21%</td><td>36</td></tr><tr><td>22%</td><td>38</td></tr><tr><td>23%</td><td>3B</td></tr><tr><td>24%</td><td>3D</td></tr><tr><td>25%</td><td>40</td></tr><tr><td>26%</td><td>42</td></tr><tr><td>27%</td><td>45</td></tr><tr><td>28%</td><td>47</td></tr><tr><td>29%</td><td>4A</td></tr><tr><td>30%</td><td>4D</td></tr><tr><td>31%</td><td>4F</td></tr><tr><td>32%</td><td>52</td></tr><tr><td>33%</td><td>54</td></tr><tr><td>34%</td><td>57</td></tr><tr><td>35%</td><td>59</td></tr><tr><td>36%</td><td>5C</td></tr><tr><td>37%</td><td>5E</td></tr><tr><td>38%</td><td>61</td></tr><tr><td>39%</td><td>63</td></tr><tr><td>40%</td><td>66</td></tr><tr><td>41%</td><td>69</td></tr><tr><td>42%</td><td>6B</td></tr><tr><td>43%</td><td>6E</td></tr><tr><td>44%</td><td>70</td></tr><tr><td>45%</td><td>73</td></tr><tr><td>46%</td><td>75</td></tr><tr><td>47%</td><td>78</td></tr><tr><td>48%</td><td>7A</td></tr><tr><td>49%</td><td>7D</td></tr><tr><td>50%</td><td>80</td></tr><tr><td>51%</td><td>82</td></tr><tr><td>52%</td><td>85</td></tr><tr><td>53%</td><td>87</td></tr><tr><td>54%</td><td>8A</td></tr><tr><td>55%</td><td>8C</td></tr><tr><td>56%</td><td>8F</td></tr><tr><td>57%</td><td>91</td></tr><tr><td>58%</td><td>94</td></tr><tr><td>59%</td><td>96</td></tr><tr><td>60%</td><td>99</td></tr><tr><td>61%</td><td>9C</td></tr><tr><td>62%</td><td>9E</td></tr><tr><td>63%</td><td>A1</td></tr><tr><td>64%</td><td>A3</td></tr><tr><td>65%</td><td>A6</td></tr><tr><td>66%</td><td>A8</td></tr><tr><td>67%</td><td>AB</td></tr><tr><td>68%</td><td>AD</td></tr><tr><td>69%</td><td>B0</td></tr><tr><td>70%</td><td>B3</td></tr><tr><td>71%</td><td>B5</td></tr><tr><td>72%</td><td>B8</td></tr><tr><td>73%</td><td>BA</td></tr><tr><td>74%</td><td>BD</td></tr><tr><td>75%</td><td>BF</td></tr><tr><td>76%</td><td>C2</td></tr><tr><td>77%</td><td>C4</td></tr><tr><td>78%</td><td>C7</td></tr><tr><td>79%</td><td>C9</td></tr><tr><td>80%</td><td>CC</td></tr><tr><td>81%</td><td>CF</td></tr><tr><td>82%</td><td>D1</td></tr><tr><td>83%</td><td>D4</td></tr><tr><td>84%</td><td>D6</td></tr><tr><td>85%</td><td>D9</td></tr><tr><td>86%</td><td>DB</td></tr><tr><td>87%</td><td>DE</td></tr><tr><td>88%</td><td>E0</td></tr><tr><td>89%</td><td>E3</td></tr><tr><td>90%</td><td>E6</td></tr><tr><td>91%</td><td>E8</td></tr><tr><td>92%</td><td>EB</td></tr><tr><td>93%</td><td>ED</td></tr><tr><td>94%</td><td>F0</td></tr><tr><td>95%</td><td>F2</td></tr><tr><td>96%</td><td>F5</td></tr><tr><td>97%</td><td>F7</td></tr><tr><td>98%</td><td>FA</td></tr><tr><td>99%</td><td>FC</td></tr><tr><td>100%</td><td>FF</td></tr></tbody></table><p>eg:</p><p>UI给出的颜色值为#000000，不透明度为40%。<br>那么结合上表，40%不透明度对应的16进制的值为66，那么最终颜色值就是#66000000</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/wangliblog/article/details/73248122">Android颜色透明度（不透明度）计算</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS下解決Dia无法输入中文问题</title>
      <link href="/blog/2019/04/16/ubuntu18-04-2lts-xia-jie-jue-dia-wu-fa-shu-ru-zhong-wen-wen-ti/"/>
      <url>/blog/2019/04/16/ubuntu18-04-2lts-xia-jie-jue-dia-wu-fa-shu-ru-zhong-wen-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>Dia是一款和MS <em>Visio</em>类似的绘制流程图、UML图、电路图、网络、数据库等结构化图形的工具，支持<a href="http://dia-installer.de/download/macosx.html">Mac OS X </a> 、<a href="http://dia-installer.de/download/linux.html">Linux</a> 、<a href="http://dia-installer.de/download/index.html">Windows </a>  。</p><ul><li>官网地址<a href="http://dia-installer.de/">Dia Diagram Editor</a></li><li>开源地址:<a href="https://github.com/GNOME/dia">github</a><br><img src="https://i.loli.net/2019/04/16/5cb536cd29418.png" alt="Dia界面"></li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="安装Dia"><a href="#安装Dia" class="headerlink" title="安装Dia"></a>安装Dia</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install dia -y</span></span><br></pre></td></tr></table></figure><h1 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h1><p>修改&#x2F;usr&#x2F;bin&#x2F;dia文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dia-normal --integrated &quot;$@&quot;改为 dia-normal &quot;$@&quot;</span><br></pre></td></tr></table></figure><p>一番搜索下来比较多的方法是修改<code>/usr/bin/dia</code>文件,当我敲下 <code>sudo vim /usr/bin/dia</code>命令后,展示在我眼前的是以下画面<br><img src="https://i.loli.net/2019/04/16/5cb53879c9912.png"><br>是Doc转Unix转码问题，不成功，网上说这样能解决中文输入的问题，但是又会引起左边工具栏和主窗口分离的问题，每次画个图还得经常拖动工具条，调整其大小，反正就是用起来很麻烦，不完美，遂放弃。</p><h1 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h1><p>修改 <code>/usr/share/applications/dia.desktop</code>文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把Exec=dia %F 改为Exec=env GTK_IM_MODULE=xim dia %F</span><br></pre></td></tr></table></figure><p>这个设置解决了从启动栏的快捷方式中启动Dia后，输入中文的问题。</p><h1 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h1><p>在终端启动时增加启动设置<br>启动命令dia 前边增加<code>env GTK_IM_MODULE=xim</code>，即用<code>env GTK_IM_MODULE=xim dia</code>来启动Dia，为了避免每次启动都要输入这么一长串，我们设置别名alias，执行命令<code>alias dia=&quot;env GTK_IM_MODULE=xim dia&quot;</code>，以后再启动Dia时还是使用dia就可以了<br>这个解决了从终端启动Dia后，输入中文的问题。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://jlice.top/post/201805311.html">解决Dia在Linux上的输入法问题</a><br><a href="https://www.jianshu.com/p/9a7d736126d1">完美解决Dia无法输入中文的问题</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Lottie动画的使用</title>
      <link href="/blog/2019/04/10/android-lottie-dong-hua-de-shi-yong/"/>
      <url>/blog/2019/04/10/android-lottie-dong-hua-de-shi-yong/</url>
      
        <content type="html"><![CDATA[<p>Lottie是一个用于Android，iOS，Web和Windows的库，用于解析使用<a href="https://github.com/airbnb/lottie-web">Bodymovin</a>导出为json的<a href="http://www.adobe.com/products/aftereffects.html">Adobe After Effects</a>动画，并在移动设备和网络上呈现它们！</p><p><img src="https://i.loli.net/2019/04/10/5cad843949bf3.gif"></p><p>介绍下Android的使用</p><p>github地址 ： <a href="https://github.com/airbnb/lottie-android">lottie-android</a></p><p>官方文档：<a href="http://airbnb.io/lottie/">airbnb.io&#x2F;lottie</a></p><p>动画json下载：<a href="https://lottiefiles.com/">https://lottiefiles.com</a></p><p>效果图：</p><p><img src="https://i.loli.net/2019/04/10/5cad8590aecf0.gif"></p><p><img src="https://i.loli.net/2019/04/10/5cad85cd323a1.gif"></p><p><img src="https://i.loli.net/2019/04/10/5cad85a10a6dd.gif"></p><h1 id="Android项目使用"><a href="#Android项目使用" class="headerlink" title="Android项目使用"></a>Android项目使用</h1><p>首先，在项目<code>build.grade</code>文件中引入依赖：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  implementation &#x27;com.airbnb.android:lottie:$lottieVersion&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有2种使用方式：</p><p>直接在布局文件使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.airbnb.lottie.LottieAnimationView</span><br><span class="line">        android:id=&quot;@+id/animation_view&quot;</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        // 放在 res/raw 目录下的动画文件</span><br><span class="line">        app:lottie_rawRes=&quot;@raw/hello_world&quot;</span><br><span class="line">        // 放在assets目录下的动画文件</span><br><span class="line">        app:lottie_fileName=&quot;hello_world.json&quot;</span><br><span class="line">        // 开启循环</span><br><span class="line">        app:lottie_loop=&quot;true&quot;</span><br><span class="line">        // 自动播放</span><br><span class="line">        app:lottie_autoPlay=&quot;true&quot; /&gt;</span><br></pre></td></tr></table></figure><p>在Java代码中使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LottieAnimationView animationView = findViewById(R.id.animation_view);</span><br><span class="line">animationView.setAnimation(R.raw.hello_world);</span><br><span class="line">// or</span><br><span class="line">animationView.setAnimation(R.raw.hello_world.json);</span><br><span class="line">animationView.playAnimation();</span><br></pre></td></tr></table></figure><p>好的，让我们运行一下项目。</p><p>然后你就会发现奇迹出现了，没有一张图片，没有一个gif，但是动画效果出来了！就是这么简单，就是这么暴力！</p><h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><ul><li>LottieAnimationView.loop(true);<br>设置动画循环演示。</li><li>mLottieAnimationView.isAnimating();<br>是否在演示中。</li><li>mLottieAnimationView.setProgress(0.5f);<br>设置演示的进度。</li><li>mLottieAnimationView.getProgress();<br>获取演示的进度。</li><li>mLottieAnimationView.getDuration();<br>获取演示的时间。</li><li>mLottieAnimationView.playAnimation();<br>运行动画。</li><li>mLottieAnimationView.pauseAnimation();<br>暂停动画。</li><li>mLottieAnimationView.cancelAnimation();<br>关闭动画。</li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jianshu.com/p/cae606f45c0b">Lottie- 让Android动画实现更简单</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Lottie </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装ZeroTier实现内网穿透</title>
      <link href="/blog/2019/04/02/ubuntu18-04-2lts-an-zhuang-zerotier-shi-xian-nei-wang-chuan-tou/"/>
      <url>/blog/2019/04/02/ubuntu18-04-2lts-an-zhuang-zerotier-shi-xian-nei-wang-chuan-tou/</url>
      
        <content type="html"><![CDATA[<h1 id="ZeroTier"><a href="#ZeroTier" class="headerlink" title="ZeroTier"></a>ZeroTier</h1><p>官网 https:&#x2F;<a href="http://www.zerotier.com/">www.zerotier.com</a></p><p>github地址  <a href="https://github.com/zerotier/ZeroTierOne">https://github.com/zerotier/ZeroTierOne</a></p><p>ZeroTier在计算机和任何其他计算机之间设置VPN隧道组成一个局域网中，该网内设备自由访问，可完全免费使用多达100台设备。</p><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="Step-1-编译安装ZeroTier"><a href="#Step-1-编译安装ZeroTier" class="headerlink" title="Step 1 编译安装ZeroTier"></a>Step 1 编译安装ZeroTier</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/zerotier/ZeroTierOne.git  ~/ZeroTier</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/ZeroTier</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ./zerotier-one -d</span></span><br></pre></td></tr></table></figure><p>或者直接 去到 <a href="http://www.zerotier.com/download.shtml">http://www.zerotier.com/download.shtml</a>下载页面下载编译好的二进制文件安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -s https://install.zerotier.com/ | <span class="built_in">sudo</span> bash</span></span><br></pre></td></tr></table></figure><p>安装完成将会收到如下打印：</p><p><img src="https://i.loli.net/2019/04/02/5ca2cd8ca7fd1.png"></p><h1 id="Step-2-创建Network"><a href="#Step-2-创建Network" class="headerlink" title="Step 2 创建Network"></a>Step 2 创建Network</h1><p>进入官网 <a href="http://www.zerotier.com/">http://www.zerotier.com/</a> 注册账号登入后，创建一个Network</p><p><img src="https://i.loli.net/2019/04/02/5ca2ccdd67369.png"></p><p>在终端运行以下命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> zerotier-cli <span class="built_in">join</span> &lt;network_id&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>network_id是上面创建的ID,记得使用root权限</p></blockquote><p><img src="https://i.loli.net/2019/04/02/5ca2d1ff54141.png"></p><h1 id="Step-3-授权设备访问"><a href="#Step-3-授权设备访问" class="headerlink" title="Step 3  授权设备访问"></a>Step 3  授权设备访问</h1><p>在Network管理页面点击Network_ID进来后，可以看到<code>Access Control</code>默认设置为 <code>PRIVATE</code></p><p>意味着所有机器必须先通过ZeroTier接口批准才能连接。这是默认选项，更安全</p><p>还有一个选项 <code>PUBLIC</code></p><p>意味着具有网络ID的任何人都可以连接。这是最简单的选择，但安全性稍差。</p><p>这里我使用默认选项 <code>PRIVATE</code></p><p>需要选中<em>Auth</em>下方的框 ，批准每台机器的连接这个网络</p><p><img src="https://i.loli.net/2019/04/02/5ca2d3e05457e.png"></p><p>其他选项，比如这里可以选择 内网网段</p><p><img src="https://i.loli.net/2019/04/02/5ca2d85f8bb98.png"></p><h1 id="Step-4-测试远程连接SSH"><a href="#Step-4-测试远程连接SSH" class="headerlink" title="Step  4 测试远程连接SSH"></a>Step  4 测试远程连接SSH</h1><p>我在一台Android设备上安装<a href="https://play.google.com/store/apps/details?id=com.zerotier.one">ZeroTier客户端</a></p><p>Ubuntu18.04.2LTS打开SSH服务</p><p>安装即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install openssh-server</span></span><br></pre></td></tr></table></figure><p>手机上操作比较简单，先<code>Join Network</code>，输入Network_ID选添加即可，打开后会出现一个建立VPN隧道的小钥匙图标 🔑。</p><p> <img src="https://i.loli.net/2019/04/02/5ca2fb875dd3b.png"></p><p>手机上打开ssh工具连接Ubuntu18.04.2LTS，可以看到我使用4G网络成功通过隧道ssh连接到了电脑</p><p><img src="https://i.loli.net/2019/04/02/5ca2fcab14aac.png"></p><p>电脑终端查看ssh连接</p><p><img src="https://i.loli.net/2019/04/02/5ca2d6f3bacf7.png"></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> ZeroTier </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装Beyond-Compare4</title>
      <link href="/blog/2019/04/01/ubuntu18-04-2lts-an-zhuang-beyond-compare4/"/>
      <url>/blog/2019/04/01/ubuntu18-04-2lts-an-zhuang-beyond-compare4/</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu18-04-2LTS安装Beyond-Compare4"><a href="#Ubuntu18-04-2LTS安装Beyond-Compare4" class="headerlink" title="Ubuntu18.04.2LTS安装Beyond-Compare4"></a>Ubuntu18.04.2LTS安装Beyond-Compare4</h1><p> <a href="https://www.scootersoftware.com/download.php">Beyond Compare</a>是一套非常实用的文件及文件夹对比工具，不仅可以快速比较出两个文件夹的不同之处，还可以详细的比较文件之间的内容差异。</p><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>Ubuntu18.04.2LTS(64位)</li><li>Beyond-Compare4</li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="Step1-官网下载最新版Beyond-Compare4"><a href="#Step1-官网下载最新版Beyond-Compare4" class="headerlink" title="Step1  官网下载最新版Beyond Compare4"></a>Step1  官网下载最新版Beyond Compare4</h1><p>下载页面 <a href="http://www.scootersoftware.com/download.php">http://www.scootersoftware.com/download.php</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> dpkg -i bcompare-4.2.9.23626_amd64.deb</span></span><br></pre></td></tr></table></figure><h1 id="Step2-激活License"><a href="#Step2-激活License" class="headerlink" title="Step2 激活License"></a>Step2 激活License</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /usr/lib/beyondcompare/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> sed -i <span class="string">&quot;s/keexjEP3t4Mue23hrnuPtY4TdcsqNiJL-5174TsUdLmJSIXKfG2NGPwBL6vnRPddT7tH29qpkneX63DO9ECSPE9rzY1zhThHERg8lHM9IBFT+rVuiY823aQJuqzxCKIE1bcDqM4wgW01FH6oCBP1G4ub01xmb4BGSUG6ZrjxWHJyNLyIlGvOhoY2HAYzEtzYGwxFZn2JZ66o4RONkXjX0DF9EzsdUef3UAS+JQ+fCYReLawdjEe6tXCv88GKaaPKWxCeaUL9PejICQgRQOLGOZtZQkLgAelrOtehxz5ANOOqCaJgy2mJLQVLM5SJ9Dli909c5ybvEhVmIC0dc9dWH+/N9KmiLVlKMU7RJqnE+WXEEPI1SgglmfmLc1yVH7dqBb9ehOoKG9UE+HAE1YvH1XX2XVGeEqYUY-Tsk7YBTz0WpSpoYyPgx6Iki5KLtQ5G-aKP9eysnkuOAkrvHU8bLbGtZteGwJarev03PhfCioJL4OSqsmQGEvDbHFEbNl1qJtdwEriR+VNZts9vNNLk7UGfeNwIiqpxjk4Mn09nmSd8FhM4ifvcaIbNCRoMPGl6KU12iseSe+w+1kFsLhX+OhQM8WXcWV10cGqBzQE9OqOLUcg9n0krrR3KrohstS9smTwEx9olyLYppvC0p5i7dAx2deWvM1ZxKNs0BvcXGukR+/g&quot;</span> BCompare</span></span><br></pre></td></tr></table></figure><h1 id="Step3-注册License"><a href="#Step3-注册License" class="headerlink" title="Step3 注册License"></a>Step3 注册License</h1><p>打开软件，会提示“Trial Mode Error! “表示Step2成功,接着输入下面TEAM ZWT生成的密钥即可注册成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--- BEGIN LICENSE KEY ---</span><br><span class="line">GXN1eh9FbDiX1ACdd7XKMV7hL7x0ClBJLUJ-zFfKofjaj2yxE53xauIfkqZ8FoLpcZ0Ux6McTyNmODDSvSIHLYhg1QkTxjCeSCk6ARz0ABJcnUmd3dZYJNWFyJun14rmGByRnVPL49QH+Rs0kjRGKCB-cb8IT4Gf0Ue9WMQ1A6t31MO9jmjoYUeoUmbeAQSofvuK8GN1rLRv7WXfUJ0uyvYlGLqzq1ZoJAJDyo0Kdr4ThF-IXcv2cxVyWVW1SaMq8GFosDEGThnY7C-SgNXW30jqAOgiRjKKRX9RuNeDMFqgP2cuf0NMvyMrMScnM1ZyiAaJJtzbxqN5hZOMClUTE+++</span><br><span class="line">--- END LICENSE KEY -----</span><br></pre></td></tr></table></figure><p>成功后会在~&#x2F;.config&#x2F;bcompare&#x2F;下生成BC4Key.txt,内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> xmaihh@xmaihh-H81M-S1:~$ cat ~/.config/bcompare/BC4Key.txt </span><br><span class="line">Beyond Compare <span class="number">4</span></span><br><span class="line">Licensed to:    pwelyn</span><br><span class="line">Quantity:       <span class="number">9999</span> users</span><br><span class="line">Serial number:  <span class="number">9571</span>-<span class="number">9981</span></span><br><span class="line">License <span class="built_in">type</span>:   Pro Edition <span class="keyword">for</span> Windows/Linux/OS X</span><br><span class="line"></span><br><span class="line">--- BEGIN LICENSE KEY ---</span><br><span class="line">GXN1eh9FbDiX1ACdd7XKMV7hL7x0ClBJLUJ-zFfKofjaj2yxE53xauIfk</span><br><span class="line">qZ8FoLpcZ0Ux6McTyNmODDSvSIHLYhg1QkTxjCeSCk6ARz0ABJcnUmd3d</span><br><span class="line">ZYJNWFyJun14rmGByRnVPL49QH+Rs0kjRGKCB-cb8IT4Gf0Ue9WMQ1A6t</span><br><span class="line">31MO9jmjoYUeoUmbeAQSofvuK8GN1rLRv7WXfUJ0uyvYlGLqzq1ZoJAJD</span><br><span class="line">yo0Kdr4ThF-IXcv2cxVyWVW1SaMq8GFosDEGThnY7C-SgNXW30jqAOgiR</span><br><span class="line">jKKRX9RuNeDMFqgP2cuf0NMvyMrMScnM1ZyiAaJJtzbxqN5hZOMClUTE+</span><br><span class="line">--- END LICENSE KEY -----</span><br></pre></td></tr></table></figure><h1 id="Step-4-为所有用户注册bcompare命令"><a href="#Step-4-为所有用户注册bcompare命令" class="headerlink" title="Step 4 为所有用户注册bcompare命令"></a>Step 4 为所有用户注册bcompare命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">cp</span> ~/.config/bcompare/BC4Key.txt /etc/</span></span><br></pre></td></tr></table></figure><p>如果Key失效，可以在 <strong><a href="https://www.serials.be/serial/Beyond_Compare_4_Linux_68803632.html">https://www.serials.be/serial/Beyond_Compare_4_Linux_68803632.html</a></strong>生成新的Key</p><p><img src="https://i.loli.net/2019/04/01/5ca1c98459e45.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://my.oschina.net/sfshine/blog/1829595">Crack-Beyond-Compare 4 -linux </a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS使用Gdrive同步文件、自动备份Hexo源文件</title>
      <link href="/blog/2019/03/28/ubuntu18-04-2lts-shi-yong-gdrive-tong-bu-wen-jian-zi-dong-bei-fen-hexo-yuan-wen-jian/"/>
      <url>/blog/2019/03/28/ubuntu18-04-2lts-shi-yong-gdrive-tong-bu-wen-jian-zi-dong-bei-fen-hexo-yuan-wen-jian/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/gdrive-org/gdrive">Gdrive项目地址</a></p><p>Gdrive是一个命令行操作Google云端硬盘账户的操作工具</p><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul><li><a href="%5Bhttps://drive.google.com%5D(https://drive.google.com/)">Google Drive账号</a></li><li>Ubuntu18.04.2LTS</li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="安装Gdrive"><a href="#安装Gdrive" class="headerlink" title="安装Gdrive"></a>安装Gdrive</h1><p>该工具的官方<a href="https://github.com/gdrive-org/gdrive">GitHub页面 </a>，并下载系统的可执行文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget -O ~/gdrive  <span class="string">&quot;https://docs.google.com/uc?id=0B3X9GlR6EmbnQ0FtZmJJUXEyRTA&amp;export=download&quot;</span>   <span class="comment">##gdrive-linux-x64</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x ~/gdrive    <span class="comment">##添加可执行权限</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s  ~/gdrive/gdrive   /usr/bin/gdrive<span class="comment">##建立软连接</span></span></span><br></pre></td></tr></table></figure><h1 id="授权Gdrive"><a href="#授权Gdrive" class="headerlink" title="授权Gdrive"></a>授权Gdrive</h1><p>为确保该工具能连接到Google云端硬盘账户，需要执行<code>gdrive about</code>进行授权,之后会在用户目录下生成<code>.gdrive</code>文件夹产生配置文件,不需要记得删除文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive about</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/03/28/5c9c3438ba922.png" alt="gdrive about"><br>把这串网址粘贴到浏览器并登入账号<br><img src="https://i.loli.net/2019/03/28/5c9c35bd3ccc3.png"><br>点击<code>允许</code>会返回一串代码,复制<br><img src="https://i.loli.net/2019/03/28/5c9c36267f5e0.png"><br>回到终端,将复制的代码粘贴上去<br><img src="https://i.loli.net/2019/03/28/5c9c370f31f63.png"></p><h1 id="使用Gdrive"><a href="#使用Gdrive" class="headerlink" title="使用Gdrive"></a>使用Gdrive</h1><p>常用命令如下，更多查看gdrive官网：<a href="https://github.com/gdrive-org/gdrive">gdrive</a></p><ul><li><p>列出Google Drive根目录下文件、文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive list</span></span><br></pre></td></tr></table></figure></li><li><p>下载Google Drive根目录下的文件、文件夹到本地</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive download &#123;文件(夹)名&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>本地文件上传到Google Drive根目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive upload &#123;文件(夹)名&#125;</span></span><br></pre></td></tr></table></figure></li></ul><p>本地文件上传到指定目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive upload --parent &#123;Dir <span class="built_in">id</span>&#125; &#123;文件(夹)名&#125;</span></span><br></pre></td></tr></table></figure><ul><li>在Google Drive根目录下创建文件夹<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gdrive <span class="built_in">mkdir</span> &#123;文件夹名&#125;</span></span><br></pre></td></tr></table></figure></li></ul><blockquote><p>:Dir id可以通过<code>gdrive list</code>查看</p></blockquote><p><img src="https://i.loli.net/2019/03/28/5c9c3af7f3e20.png"></p><h1 id="附上自动备份Hexo源文件脚本"><a href="#附上自动备份Hexo源文件脚本" class="headerlink" title="附上自动备份Hexo源文件脚本"></a>附上自动备份Hexo源文件脚本</h1><p>按需要修改自己所要备份的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#---------------Folder you want to backup----------------##</span></span></span><br><span class="line">NameOfFolder=&quot;hexo&quot;</span><br><span class="line">SourceOffFolder=&quot;/home/xmaihh/Documents&quot;</span><br><span class="line">BackupLocation=&quot;/home/xmaihh/backups&quot;</span><br><span class="line">date=$(date +&quot;%Y-%m-%d&quot;)</span><br><span class="line">LOG_FILE=&quot;home/xmaihh/googledrive.log&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#-----That mean,you will Backup the folder /home/xmaihh/Documents/hexo and will save into Folder /home/xmaihh/backups</span></span></span><br><span class="line"></span><br><span class="line">if [ ! -d $BackupLocation ]; then</span><br><span class="line">mkdir -p $BackupLocation</span><br><span class="line">fi</span><br><span class="line">find $BackupLocation/*.zip -mtime +10 -exec rm &#123;&#125; \;</span><br><span class="line">for fd in $NameOfFolder; do</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Name of the Backup File</span></span><br><span class="line">file=$fd-$date.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Zip the Folder you will want to Backup</span></span><br><span class="line">echo &quot;Starting to zip the folder and files&quot;</span><br><span class="line">cd $SourceOffFolder</span><br><span class="line">zip -r $BackupLocation/$file $fd</span><br><span class="line">sleep 5s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Process Upload Files to Google Drive</span></span></span><br><span class="line">gdrive upload $BackupLocation/$file</span><br><span class="line">if test $? = 0</span><br><span class="line">then</span><br><span class="line">echo &quot;Your Data Successfully Uploaded to the Google Drive!&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;Error in Your Data Upload to Google Drive&quot; &gt; $LOG_FILE</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://lighti.me/1532.html">Gdrive：Linux下同步Google Drive文件、自动备份网站到Google Drive</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> Hexo </tag>
            
            <tag> Gdrive </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python项目生成依赖requirements.txt的两种方法</title>
      <link href="/blog/2019/03/27/python-xiang-mu-sheng-cheng-yi-lai-requirements-txt-de-liang-chong-fang-fa/"/>
      <url>/blog/2019/03/27/python-xiang-mu-sheng-cheng-yi-lai-requirements-txt-de-liang-chong-fang-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="为什么要有requirements-txt"><a href="#为什么要有requirements-txt" class="headerlink" title="为什么要有requirements.txt"></a>为什么要有requirements.txt</h1><p><code>requirements.txt</code>保存Python项目所依赖的类库。<code>Python</code>提供通过<code>requirements.txt</code>文件来进行项目中依赖的三方库进行整体安装导入。</p><p><code>requirements.txt</code>文件的格式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">requests==<span class="number">1.2</span><span class="number">.0</span></span><br><span class="line">Flask==<span class="number">0.10</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux sudo</li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="方法1："><a href="#方法1：" class="headerlink" title="方法1："></a>方法1：</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip freeze &gt; requirements.txt</span></span><br></pre></td></tr></table></figure><p>使用pip的<code>freeze</code>命令为您的项目生成一个<code>requirements.txt</code>文件：如果将其保存在requirements.txt中，则可以<code>pip install -r requirements.txt</code>来安装这些依赖。</p><blockquote><p>注意：<code>pip freeze</code>输出的是本地环境中所有三方包信息，但是会比<code>pip list</code>少几个包，因为<code>pip</code>，<code>wheel</code>，<code>setuptools</code>等包，是自带的而无法(un)install的，如果要显示所有包可以加上参数<code>-all</code>，即<code>pip freeze -all</code></p></blockquote><h1 id="方法2："><a href="#方法2：" class="headerlink" title="方法2："></a>方法2：</h1><p>使用<code>pipreqs</code>生成<code>requirements.txt</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip install pipreqs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pipreqs /path/to/project</span></span><br></pre></td></tr></table></figure><p>有关其他选项，请参阅<a href="https://github.com/bndr/pipreqs">https://github.com/bndr/pipreqs</a></p><blockquote><p>注意：<code>pipreqs</code>生成指定目录下的依赖类库</p></blockquote><h1 id="两种方法的区别"><a href="#两种方法的区别" class="headerlink" title="两种方法的区别"></a>两种方法的区别</h1><p><code>pip freeze</code>保存环境中的所有包，包括那些在当前项目中不使用的包。（如果你没有virtualenv,类库就会很杂很多）<br><code>pip freeze</code>仅保存在您的环境中使用<code>pip install</code>安装的软件包。<br><code>pipreqs</code>它会根据当前目录下的项目的依赖来导出三方类库</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装VMware Workstation</title>
      <link href="/blog/2019/03/27/ubuntu18-04-2lts-an-zhuang-vmware-workstation/"/>
      <url>/blog/2019/03/27/ubuntu18-04-2lts-an-zhuang-vmware-workstation/</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu18-04-2LTS安装VMware-Workstation"><a href="#Ubuntu18-04-2LTS安装VMware-Workstation" class="headerlink" title="Ubuntu18.04.2LTS安装VMware Workstation"></a>Ubuntu18.04.2LTS安装VMware Workstation</h1><h1 id="操作系统与软件版本"><a href="#操作系统与软件版本" class="headerlink" title="操作系统与软件版本"></a>操作系统与软件版本</h1><ul><li>Ubuntu18.04.2LTS bionic </li><li>VMware Workstation 14PRO或更高版本</li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><code>#</code> -要求使用root权限直接以root用户使用命令或对执行的命令使用linux <code>sudo</code></li><li><code>$</code> -要求给定的linux命令作为常规非特权用户执行</li></ul><h1 id="Step1-下载VMware-workstation"><a href="#Step1-下载VMware-workstation" class="headerlink" title="Step1 下载VMware workstation"></a>Step1 下载VMware workstation</h1><p>首先是下载VMware安装文件,打开命令行终端并使用<code>wget</code>命令执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget -O ~/vmware.bin https://www.vmware.com/go/getworkstation-linux</span></span><br></pre></td></tr></table></figure><h1 id="Step2-安装WMware依赖"><a href="#Step2-安装WMware依赖" class="headerlink" title="Step2 安装WMware依赖"></a>Step2 安装WMware依赖</h1><p>安装WMware依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt install build-essential</span></span><br></pre></td></tr></table></figure><h1 id="Step3-安装WMware-workstation"><a href="#Step3-安装WMware-workstation" class="headerlink" title="Step3 安装WMware workstation"></a>Step3 安装WMware workstation</h1><p>启动安装向导</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> bash ~/vmware.bin</span></span><br></pre></td></tr></table></figure><p>按照安装向导完成安装。如果您有序列号，请输入VMware序列号或留空。</p><p>附上VMware Workstation 15Pro激活密钥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YG5H2-ANZ0H-M8ERY-TXZZZ-YKRV8</span><br><span class="line"></span><br><span class="line">UG5J2-0ME12-M89WY-NPWXX-WQH88</span><br><span class="line"></span><br><span class="line">UA5DR-2ZD4H-089FY-6YQ5T-YPRX6</span><br><span class="line"></span><br><span class="line">GA590-86Y05-4806Y-X4PEE-ZV8E0</span><br><span class="line"></span><br><span class="line">ZF582-0NW5N-H8D2P-0XZEE-Z22VA</span><br><span class="line"></span><br><span class="line">YA18K-0WY8P-H85DY-L4NZG-X7RAD</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/03/27/5c9af1534a0f4.png"></p><h1 id="启动VMware"><a href="#启动VMware" class="headerlink" title="启动VMware"></a>启动VMware</h1><p>在你的开始菜单搜索系统上安装好的VMware</p><p><img src="https://i.loli.net/2019/03/27/5c9af0b066e6a.png" alt="启动WMware"></p><h1 id="打开VMware"><a href="#打开VMware" class="headerlink" title="打开VMware"></a>打开VMware</h1><p>启动VMware Workstation</p><p><img src="https://i.loli.net/2019/03/27/5c9af299bddbc.png" alt="Ubuntu 18.04.2LTS上的VMware Workstation 15 PRO"></p><h1 id="附上：VMware-Win镜像"><a href="#附上：VMware-Win镜像" class="headerlink" title="附上：VMware Win镜像"></a>附上：VMware Win镜像</h1><p>链接: <a href="https://pan.baidu.com/s/1B4UBgVBaKm_GjDgbWxE-ig">https://pan.baidu.com/s/1B4UBgVBaKm_GjDgbWxE-ig</a> 提取码: <code>jh8z</code> </p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS修改主文件夾名稱爲英文</title>
      <link href="/blog/2019/03/17/ubuntu18-04-2lts-xiu-gai-zhu-wen-jian-jia-ming-cheng-wei-ying-wen/"/>
      <url>/blog/2019/03/17/ubuntu18-04-2lts-xiu-gai-zhu-wen-jian-jia-ming-cheng-wei-ying-wen/</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu18-04-2LTS修改主文件夾名稱爲英文"><a href="#Ubuntu18-04-2LTS修改主文件夾名稱爲英文" class="headerlink" title="Ubuntu18.04.2LTS修改主文件夾名稱爲英文"></a>Ubuntu18.04.2LTS修改主文件夾名稱爲英文</h1><h2 id="方法1："><a href="#方法1：" class="headerlink" title="方法1："></a>方法1：</h2><p>先重命名中文文件夾，然後</p><p>编辑~&#x2F;.config&#x2F;user-dirs.dirs文件</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>vim ~<span class="regexp">/.config/user</span>-dirs.dirs</span><br></pre></td></tr></table></figure><p>修改文件內容爲：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">XDG_DESKTOP_DIR</span>=<span class="string">&quot;$HOME/Desktop&quot;</span></span><br><span class="line"><span class="attr">XDG_DOWNLOAD_DIR</span>=<span class="string">&quot;$HOME/Downloads&quot;</span></span><br><span class="line"><span class="attr">XDG_TEMPLATES_DIR</span>=<span class="string">&quot;$HOME/Templates&quot;</span></span><br><span class="line"><span class="attr">XDG_PUBLICSHARE_DIR</span>=<span class="string">&quot;$HOME/Public&quot;</span></span><br><span class="line"><span class="attr">XDG_DOCUMENTS_DIR</span>=<span class="string">&quot;$HOME/Documents&quot;</span></span><br><span class="line"><span class="attr">XDG_MUSIC_DIR</span>=<span class="string">&quot;$HOME/Music&quot;</span></span><br><span class="line"><span class="attr">XDG_PICTURES_DIR</span>=<span class="string">&quot;$HOME/Pictures&quot;</span></span><br><span class="line"><span class="attr">XDG_VIDEOS_DIR</span>=<span class="string">&quot;$HOME/Videos&quot;</span></span><br></pre></td></tr></table></figure><h2 id="方法2："><a href="#方法2：" class="headerlink" title="方法2："></a>方法2：</h2><p>打开终端，在终端中输入命令:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> <span class="attribute">LANG</span>=en_US</span><br><span class="line">$ xdg-user-dirs-gtk-update</span><br></pre></td></tr></table></figure><p>跳出对话框询问是否将目录转化为英文路径,同意并关闭。<br>在终端中输入命令:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> <span class="attribute">LANG</span>=zh_CN</span><br></pre></td></tr></table></figure><p>重新启动系统，系统会提示更新文件名称，选择不再提示,并取消修改。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装Oracle Java JDK 8</title>
      <link href="/blog/2019/03/15/ubuntu18-04-2lts-an-zhuang-oraclejavajdk-8/"/>
      <url>/blog/2019/03/15/ubuntu18-04-2lts-an-zhuang-oraclejavajdk-8/</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu18-04-2LTS安装Oracle-Java-JDK-8"><a href="#Ubuntu18-04-2LTS安装Oracle-Java-JDK-8" class="headerlink" title="Ubuntu18.04.2LTS安装Oracle Java JDK 8"></a>Ubuntu18.04.2LTS安装Oracle Java JDK 8</h1><p>Webupd8 Team维护一个PPA存储库，其中包含适用于所有当前Ubuntu版本的Oracle Java 8安装程序脚本。</p><h2 id="1-打开终端并运行命令添加PPA："><a href="#1-打开终端并运行命令添加PPA：" class="headerlink" title="1.打开终端并运行命令添加PPA："></a>1.打开终端并运行命令添加PPA：</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:webupd8team/java</span><br></pre></td></tr></table></figure><p>输入密码（输入时不会显示星号），然后按Enter键继续。</p><h2 id="2-然后运行命令安装Java-8安装程序并在提示时接受许可证："><a href="#2-然后运行命令安装Java-8安装程序并在提示时接受许可证：" class="headerlink" title="2.然后运行命令安装Java 8安装程序并在提示时接受许可证："></a>2.然后运行命令安装Java 8安装程序并在提示时接受许可证：</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install oracle-java8-installer</span><br></pre></td></tr></table></figure><h2 id="3-安装完成后，Oracle-Java-8应自动设置为默认值。-如果没有，运行命令："><a href="#3-安装完成后，Oracle-Java-8应自动设置为默认值。-如果没有，运行命令：" class="headerlink" title="3.安装完成后，Oracle Java 8应自动设置为默认值。 如果没有，运行命令："></a>3.安装完成后，Oracle Java 8应自动设置为默认值。 如果没有，运行命令：</h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install oracle-java8-<span class="keyword">set</span>-<span class="keyword">default</span></span><br></pre></td></tr></table></figure><h2 id="4-卸载："><a href="#4-卸载：" class="headerlink" title="4.卸载："></a>4.卸载：</h2><p>移除PPA软件包总是很容易，只需打开终端并运行命令即可：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> <span class="built_in">remove</span> --autoremove oracle-java8-installer oracle-java10-installer</span><br></pre></td></tr></table></figure><p>然后启动软件和更新 - &gt;其他软件选项卡以删除PPA存储库。</p><h1 id="在Ubuntu18-04-2LTS安裝Android-NDK"><a href="#在Ubuntu18-04-2LTS安裝Android-NDK" class="headerlink" title="在Ubuntu18.04.2LTS安裝Android NDK"></a>在Ubuntu18.04.2LTS安裝Android NDK</h1><h2 id="1-下载地址："><a href="#1-下载地址：" class="headerlink" title="1.下载地址："></a>1.下载地址：</h2><p><a href="https://link.jianshu.com/?t=https://developer.android.com/ndk/downloads/index.html">https://developer.android.com/ndk/downloads/index.html</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c http:<span class="regexp">//</span>dl.google.com<span class="regexp">/android/</span>ndk/android-ndk-r18b-linux-x86_64.zip</span><br></pre></td></tr></table></figure><h2 id="2-解压"><a href="#2-解压" class="headerlink" title="2.解压"></a>2.解压</h2><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip android-ndk-r<span class="number">18</span>b-linux-<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.zip</span><br></pre></td></tr></table></figure><h2 id="3-移动到自己想放的位置："><a href="#3-移动到自己想放的位置：" class="headerlink" title="3.移动到自己想放的位置："></a>3.移动到自己想放的位置：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /usr/lib/ndk    </span><br><span class="line"><span class="built_in">mv</span> ndk-r18b  /usr/lib/ndk</span><br></pre></td></tr></table></figure><h2 id="4-设置环境变量"><a href="#4-设置环境变量" class="headerlink" title="4.设置环境变量"></a>4.设置环境变量</h2><p>编辑 .profile 或者 .bash_profile,参照jdk环境变量设置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">ANDROID_NDK</span>=/usr/lib/ndk/ndk-r18b</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="variable">$ANDROID_NDK</span>:$PATH</span><br></pre></td></tr></table></figure><h2 id="5-使修改的配置立刻生效：执行source-etc-profile或者-source-bashrc"><a href="#5-使修改的配置立刻生效：执行source-etc-profile或者-source-bashrc" class="headerlink" title="5.使修改的配置立刻生效：执行source /etc/profile或者 source ~/.bashrc"></a>5.使修改的配置立刻生效：执行<code>source /etc/profile</code>或者 <code>source ~/.bashrc</code></h2><h2 id="6-检查是否安装成功："><a href="#6-检查是否安装成功：" class="headerlink" title="6.检查是否安装成功："></a>6.检查是否安装成功：</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ndk-build -C</span></span><br></pre></td></tr></table></figure><p>若返回下面的信息表示NDK有效</p><p><a href="https://i.loli.net/2019/03/15/5c8b0bccde35a.png"><img src="https://i.loli.net/2019/03/15/5c8b0bccde35a.png" alt="檢查ndk-build是否安裝成功"></a>檢查ndk-build是否安裝成功</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18.04.2LTS安装、配置、美化</title>
      <link href="/blog/2019/03/14/ubuntu18-04-2lts-an-zhuang-pei-zhi-mei-hua/"/>
      <url>/blog/2019/03/14/ubuntu18-04-2lts-an-zhuang-pei-zhi-mei-hua/</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu18-04-2LTS安装、配置、美化"><a href="#Ubuntu18-04-2LTS安装、配置、美化" class="headerlink" title="Ubuntu18.04.2LTS安装、配置、美化"></a>Ubuntu18.04.2LTS安装、配置、美化</h1><h2 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h2><ul><li>准备<a href="http://releases.ubuntu.com/">Ubuntu18.04镜像</a></li><li>关闭Secure Boot</li></ul><h2 id="硬盘分区"><a href="#硬盘分区" class="headerlink" title="硬盘分区"></a>硬盘分区</h2><p>硬盘一般分为IDE硬盘、SCSI硬盘和SATA硬盘三种。</p><p>在Linux系统中，IDE接口的硬盘被称为hd，SCSI和SATA接口的硬盘则被称为sd，其中IDE硬盘基本上已经淘汰，现在市面上最常见的就是SATA接口的硬盘，第1块硬盘称为sda，第2块硬盘称为sdb……，依此类推。</p><p>一块硬盘最多有4个主分区，主分区以外的分区称为<a href="https://www.baidu.com/s?wd=%E6%89%A9%E5%B1%95%E5%88%86%E5%8C%BA&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd">扩展分区</a>，硬盘可以没有扩展分区，但是一定要有主分区，在主分区中要有一个激活分区用来启动Windows系统，在扩展分区中可以建立若干个逻辑分区，因此，最合理的分区方式应该最多分三个主分区，一个扩展分区，这样可以有效地利用有限的主分区，然后在扩展分区中建立逻辑分区。</p><p>在Linux系统中每一个硬盘总共最多有 16个分区，硬盘上的4个主分区，分别标识为sdal、sda2、sda3和sda4，逻辑分区则从sda5开始标识一直到sda16。</p><p>Linux可以把分区作为挂载点，载入目录，其中最常用的硬盘大小（500G-1000G）分配目录推荐如下表所示：</p><table><thead><tr><th>目录</th><th>建议大小</th><th>格式</th><th>描述</th></tr></thead><tbody><tr><td>EFI</td><td>100M</td><td></td><td>一定要放在开头，主分区，分配32M以上</td></tr><tr><td>&#x2F;</td><td>150G-200G</td><td>ext4</td><td>根目录</td></tr><tr><td>swap</td><td>物理内存两倍</td><td>swap</td><td>交换空间：交换分区相当于Windows中的“虚拟内存”，如果内存低的话（1-4G），物理内存的两倍，高点的话（8-16G）要么等于物理内存，要么物理内存+2g左右，</td></tr><tr><td>&#x2F;boot</td><td>1G左右</td><td>ext4</td><td><strong>空间起始位置</strong> 分区格式为ext4 <strong>&#x2F;boot</strong> <strong>建议：应该大于400MB或1GB</strong> Linux的内核及引导系统程序所需要的文件，比如 vmlinuz initrd.img文件都位于这个目录中。在一般情况下，GRUB或LILO系统引导管理器也位于这个目录；启动撞在文件存放位置，如kernels，initrd，grub。</td></tr><tr><td>&#x2F;tmp</td><td>5G左右</td><td>ext4</td><td>系统的临时文件，一般系统重启不会被保存。（建立服务器需要？）</td></tr><tr><td>&#x2F;home</td><td>尽量大些</td><td>ext4</td><td>用户工作目录；个人配置文件，如个人环境变量等；所有账号分配一个工作目录。</td></tr></tbody></table><h2 id="修改DNS"><a href="#修改DNS" class="headerlink" title="修改DNS"></a>修改DNS</h2><h3 id="Step1-添加Google’s-DNS"><a href="#Step1-添加Google’s-DNS" class="headerlink" title="Step1:添加Google’s DNS"></a>Step1:添加Google’s DNS</h3><p><code>vim /etc/systemd/resolved.conf</code><br>在文件中添加內容：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">DNS</span>=<span class="number">8.8.8.8</span> <span class="number">2001</span>:<span class="number">4860</span>:<span class="number">4860</span>::<span class="number">8888</span></span><br><span class="line"><span class="attribute">FallbackDNS</span>=<span class="number">8.8.4.4</span> <span class="number">2001</span>:<span class="number">4860</span>:<span class="number">4860</span>::<span class="number">8844</span></span><br></pre></td></tr></table></figure><h3 id="Step2-重啓網絡或者重啓電腦"><a href="#Step2-重啓網絡或者重啓電腦" class="headerlink" title="Step2:重啓網絡或者重啓電腦"></a>Step2:重啓網絡或者重啓電腦</h3><h2 id="更换root密码"><a href="#更换root密码" class="headerlink" title="更换root密码"></a>更换root密码</h2><p><a href="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313142321.png"><img src="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313142321.png" alt="更换root密码"></a>更换root密码更换root密码</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmaihh<span class="variable">@xmaihh</span>-<span class="variable constant_">H81M</span>-<span class="variable constant_">S1</span><span class="symbol">:~</span><span class="variable">$ </span>sudo passwd root</span><br><span class="line">输入新的 <span class="variable constant_">UNIX</span> 密码： </span><br><span class="line">重新输入新的 <span class="variable constant_">UNIX</span> 密码： </span><br><span class="line">passwd：已成功更新密码</span><br><span class="line">xmaihh<span class="variable">@xmaihh</span>-<span class="variable constant_">H81M</span>-<span class="variable constant_">S1</span><span class="symbol">:~</span>$</span><br></pre></td></tr></table></figure><h2 id="sudo免密码"><a href="#sudo免密码" class="headerlink" title="sudo免密码"></a>sudo免密码</h2><p>shell输入:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmaihh<span class="variable">@xmaihh</span>-<span class="variable constant_">H81M</span>-<span class="variable constant_">S1</span><span class="symbol">:~</span><span class="variable">$ </span>sudo visudo</span><br></pre></td></tr></table></figure><p>显示如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file MUST be edited with the &#x27;visudo&#x27; command as root.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please consider adding local content in /etc/sudoers.d/ instead of</span></span><br><span class="line"><span class="comment"># directly modifying this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See the man page for details on how to write a sudoers file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">Defaults</span>        <span class="string">env_reset</span></span><br><span class="line"><span class="string">Defaults</span>        <span class="string">mail_badpass</span></span><br><span class="line"><span class="string">Defaults</span>        <span class="string">secure_path=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:$</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Host alias specification</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User alias specification</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cmnd alias specification</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User privilege specification</span></span><br><span class="line"><span class="string">root</span>    <span class="string">ALL=(ALL:ALL)</span> <span class="string">ALL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Members of the admin group may gain root privileges</span></span><br><span class="line"><span class="string">%admin</span> <span class="string">ALL=(ALL)</span> <span class="string">ALL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow members of group sudo to execute any command</span></span><br><span class="line"><span class="string">%sudo</span>   <span class="string">ALL=(ALL:ALL)</span> <span class="string">ALL</span></span><br><span class="line"><span class="string">xmaihh</span>  <span class="string">ALL=(ALL)</span> <span class="attr">NOPASSWD:</span> <span class="string">ALL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See sudoers(5) for more information on &quot;#include&quot; directives:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#includedir /etc/sudoers.d</span></span><br></pre></td></tr></table></figure><blockquote><p>只要在**%sudo ALL&#x3D;(ALL:ALL) ALL**下面添加一行username  ALL&#x3D;(ALL) NOPASSWD: ALL</p></blockquote><h2 id="更新源"><a href="#更新源" class="headerlink" title="更新源"></a>更新源</h2><p>找到Software &amp; Updates，将源更新为阿里云的源 或者其他国内的源</p><p>然后自己手动更新一下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade</span><br></pre></td></tr></table></figure><h2 id="Sougou-Pinyin"><a href="#Sougou-Pinyin" class="headerlink" title="Sougou Pinyin"></a>Sougou Pinyin</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get <span class="keyword">install </span>fcitx-<span class="keyword">bin </span>     <span class="comment">#安装fcitx-bin</span></span><br><span class="line">sudo apt-get update --fix-missing   <span class="comment">#修复fcitx-bin安装失败的情况</span></span><br><span class="line">sudo apt-get <span class="keyword">install </span>fcitx-<span class="keyword">bin </span>     <span class="comment">#重新安装fcitx-bin</span></span><br><span class="line">sudo apt-get <span class="keyword">install </span>fcitx-table    <span class="comment">#安装fcitx-table</span></span><br></pre></td></tr></table></figure><p>然后去<a href="https://pinyin.sogou.com/linux/">搜狗输入法Linux官网</a>下载64bit的deb包程序，如：sogoupinyin_2.2.0.0108_amd64.deb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dpkg -i sogoupinyin*.deb       <span class="comment">#安装搜狗拼音</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -f             <span class="comment">#修复搜狗拼音安装的错误</span></span><br><span class="line"><span class="built_in">sudo</span> dpkg -i sogoupinyin*.deb       <span class="comment">#重新安装搜狗拼音</span></span><br></pre></td></tr></table></figure><p>重启！重启！重启！也就是注销当前用户再重登的事</p><h2 id="WPS"><a href="#WPS" class="headerlink" title="WPS"></a>WPS</h2><p>去<a href="https://www.wps.com/download/">wps_linux官网</a>下载64bit的deb包程序，如：<a href="http://kdl.cc.ksosoft.com/wps-community/download/6757/wps-office_10.1.0.6757_amd64.deb">wps-office_10.1.0.6757_amd64.deb</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dpkg -i libpng12-0*.deb      <span class="comment">#安装依赖libpng12-0</span></span><br><span class="line"><span class="built_in">sudo</span> dpkg -i wps*.deb  <span class="comment">#安装wps</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -f           <span class="comment">#若出现错误没有安装成功,用来修复</span></span><br></pre></td></tr></table></figure><p>下载<a href="https://drive.google.com/open?id=17bFkK8VvJ9MHnPGTAiDJlPf2mX_ItAer">wps字体</a>,然后解压<br>(或者<a href="https://pan.baidu.com/s/1xBd0XIdB2tqDiDR7zABrSg">链接</a>提取码:ea2d)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /usr/share/fonts/WPS-Fonts       <span class="comment">#新建wps字体存储文件夹</span></span><br><span class="line"><span class="built_in">cd</span> ~/Downloads     <span class="comment">#进入下载好的字体目录</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install unzip  <span class="comment">#安装zip解压软件</span></span><br><span class="line"><span class="built_in">sudo</span> unzip wps_symbol_fonts.zip -d /usr/share/fonts/WPS-Fonts/  <span class="comment">#解压字体到指定文件夹</span></span><br><span class="line"><span class="built_in">sudo</span> mkfontscale    <span class="comment">#生成字体索引</span></span><br><span class="line"><span class="built_in">sudo</span> mkfontdir      <span class="comment">#生成字体索引</span></span><br><span class="line"><span class="built_in">sudo</span> fc-cache       <span class="comment">#更新字体缓存</span></span><br></pre></td></tr></table></figure><h2 id="压缩软件"><a href="#压缩软件" class="headerlink" title="压缩软件"></a>压缩软件</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install p7zip-<span class="keyword">full</span> p7zip-rar rar unzip</span><br></pre></td></tr></table></figure><h2 id="Google-Chrome"><a href="#Google-Chrome" class="headerlink" title="Google Chrome"></a>Google Chrome</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -q -O - https://raw.githubusercontent.com/longhr/ubuntu1604hub/master/linux_signing_key.pub | <span class="built_in">sudo</span> apt-key add</span><br><span class="line"><span class="built_in">sudo</span> sh -c <span class="string">&#x27;echo &quot;deb [ arch=amd64 ] http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google-chrome.list&#x27;</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install google-chrome-stable</span><br></pre></td></tr></table></figure><h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-<span class="built_in">get</span> install vim</span><br></pre></td></tr></table></figure><h2 id="安裝VS-Code"><a href="#安裝VS-Code" class="headerlink" title="安裝VS Code"></a>安裝VS Code</h2><p>首先下载官方安装包：<br><a href="https://code.visualstudio.com/docs/?dv=linux64_deb">https://code.visualstudio.com/docs/?dv=linux64_deb</a><br>然后在该文件路径运行以下命令：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> dpkg -i code_1.<span class="number">24</span>.<span class="number">1</span>-<span class="number">1528912196</span>_amd64.deb</span><br></pre></td></tr></table></figure><p>或者双击安装包，要安装依赖的话先安装依赖，如果双击安装无反应，可以在命令行中运行安装，然后安装所需依赖即可</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install -f</span><br></pre></td></tr></table></figure><h2 id="多版本gcc和g-共存"><a href="#多版本gcc和g-共存" class="headerlink" title="多版本gcc和g++共存"></a>多版本gcc和g++共存</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> apt-get install gcc-<span class="number">5</span> gcc-<span class="number">5</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> apt-get install g++-<span class="number">5</span> g++-<span class="number">5</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> apt-get install gcc-<span class="number">6</span> gcc-<span class="number">6</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> apt-get install g++-<span class="number">6</span> g++-<span class="number">6</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> apt-get install gcc-<span class="number">7</span> gcc-<span class="number">7</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> apt-get install g++-<span class="number">7</span> g++-<span class="number">7</span>-multilib</span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-<span class="number">5</span> <span class="number">50</span></span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-<span class="number">6</span> <span class="number">60</span></span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-<span class="number">7</span> <span class="number">70</span></span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-<span class="number">5</span> <span class="number">50</span></span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-<span class="number">6</span> <span class="number">60</span></span><br><span class="line"><span class="attribute">sudo</span> update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-<span class="number">7</span> <span class="number">70</span></span><br></pre></td></tr></table></figure><p>然后选择gcc和g++版本</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">update</span><span class="operator">-</span>alternatives <span class="comment">--config gcc</span></span><br><span class="line">sudo <span class="keyword">update</span><span class="operator">-</span>alternatives <span class="comment">--config g++</span></span><br></pre></td></tr></table></figure><h2 id="多版本python和pip共存"><a href="#多版本python和pip共存" class="headerlink" title="多版本python和pip共存"></a>多版本python和pip共存</h2><p>ubuntu18.04自带python3，但是没有python2，pip2，pip3。</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python2</span>.<span class="string">7</span>  <span class="comment">#安装python2.7</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python-minimal</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">curl</span></span><br><span class="line"><span class="string">curl</span> <span class="string">https</span>://<span class="string">bootstrap</span>.<span class="string">pypa</span>.<span class="string">io</span>/<span class="built_in">get-pip.py</span> -<span class="string">o</span> <span class="built_in">get-pip.py</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python-testresources</span>   <span class="comment">#防止pip2出错</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python3-testresources</span>  <span class="comment">#防止pip3出错</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">python3</span> <span class="built_in">get-pip.py</span> <span class="comment">#安装pip3</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">python2</span> <span class="built_in">get-pip.py</span> <span class="comment">#安装pip3</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">pip3</span> <span class="string">install</span> <span class="built_in">--upgrade</span> <span class="string">pip</span> <span class="comment">#升级pip3</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">pip2</span> <span class="string">install</span> <span class="built_in">--upgrade</span> <span class="string">pip</span> <span class="comment">#升级pip2</span></span><br></pre></td></tr></table></figure><p>此时pip和python并不知道指向2还是3，需要自己修改。我们使用alias来设置别名。我要让pip和python都指向3</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ whereis pip</span><br><span class="line">pip: <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip3.<span class="number">6</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip2.<span class="number">7</span></span><br><span class="line">$ whereis python</span><br><span class="line">python: <span class="regexp">/usr/</span>bin<span class="regexp">/python2.7 /u</span>sr<span class="regexp">/bin/</span>python2.<span class="number">7</span>-config <span class="regexp">/usr/</span>bin<span class="regexp">/python3.6m /u</span>sr<span class="regexp">/bin/</span>python3.<span class="number">6</span> <span class="regexp">/usr/</span>bin<span class="regexp">/python3.6m-config /u</span>sr<span class="regexp">/bin/</span>python3.<span class="number">6</span>-config <span class="regexp">/usr/</span>bin<span class="regexp">/python /u</span>sr<span class="regexp">/lib/</span>python2.<span class="number">7</span> <span class="regexp">/usr/</span>lib<span class="regexp">/python3.7 /u</span>sr<span class="regexp">/lib/</span>python3.<span class="number">6</span> <span class="regexp">/etc/</span>python2.<span class="number">7</span> <span class="regexp">/etc/</span>python3.<span class="number">6</span> <span class="regexp">/etc/</span>python <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python2.<span class="number">7</span> <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python3.<span class="number">6</span> <span class="regexp">/usr/i</span>nclude<span class="regexp">/python2.7 /u</span>sr<span class="regexp">/include/</span>python3.<span class="number">6</span>m <span class="regexp">/usr/i</span>nclude<span class="regexp">/python3.6 /u</span>sr<span class="regexp">/share/</span>python <span class="regexp">/usr/</span>share<span class="regexp">/man/m</span>an1/python.<span class="number">1</span>.gz</span><br></pre></td></tr></table></figure><blockquote><p>error: Traceback (most recent call last):<br>  File “setup.py”, line 1, in <module><br>    from distutils.core import setup<br>ImportError: No module named distutils.core<br>报错缺少<code>python-distutils</code>包，安装即可。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install python3-distutils</span></span><br></pre></td></tr></table></figure><p>可见pip3在：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip3.<span class="number">6</span></span><br></pre></td></tr></table></figure><p>python在：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin/python3.<span class="number">6</span></span><br></pre></td></tr></table></figure><p>自定义alias别名：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure><p>打开文件后，在最后一行加：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alias</span> pip=<span class="regexp">/usr/local</span><span class="regexp">/bin/pip</span>3.<span class="number">6</span></span><br><span class="line"><span class="keyword">alias</span> python=<span class="regexp">/usr/bin</span><span class="regexp">/python3.6</span></span><br></pre></td></tr></table></figure><p>然后更新环境：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="支持exfat"><a href="#支持exfat" class="headerlink" title="支持exfat"></a>支持exfat</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install exfat-fuse exfat-utils</span><br></pre></td></tr></table></figure><h2 id="音视频"><a href="#音视频" class="headerlink" title="音视频"></a>音视频</h2><h3 id="安装FFmpeg"><a href="#安装FFmpeg" class="headerlink" title="安装FFmpeg"></a>安装FFmpeg</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:djcj/hybrid</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ffmpeg</span><br></pre></td></tr></table></figure><h3 id="安装解码器"><a href="#安装解码器" class="headerlink" title="安装解码器"></a>安装解码器</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ubuntu-restricted-extras</span><br></pre></td></tr></table></figure><h3 id="安装VLC视频播放器"><a href="#安装VLC视频播放器" class="headerlink" title="安装VLC视频播放器"></a>安装VLC视频播放器</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install vlc browser-plugin-vlc</span><br></pre></td></tr></table></figure><h3 id="安装录制gif软件peek"><a href="#安装录制gif软件peek" class="headerlink" title="安装录制gif软件peek"></a>安装录制gif软件peek</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:peek-developers/stable</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install peek</span><br></pre></td></tr></table></figure><h2 id="美化"><a href="#美化" class="headerlink" title="美化"></a>美化</h2><h3 id="查看gnome版本"><a href="#查看gnome版本" class="headerlink" title="查看gnome版本"></a>查看gnome版本</h3><p>gnome3版本以下</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gnome-panel --<span class="keyword">version</span>   或者  gnome-<span class="keyword">about</span> --gnome-<span class="keyword">version</span></span><br></pre></td></tr></table></figure><p>gnome3版本以上</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gnome-session --<span class="keyword">version</span>  或者 gnome-<span class="keyword">shell</span> --<span class="keyword">version</span></span><br></pre></td></tr></table></figure><p>如我的gnome3版本如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">xmaihh</span>@xmaihh-H81M-S1:~$ gnome-shell --version</span><br><span class="line"><span class="attribute">GNOME</span> Shell <span class="number">3</span>.<span class="number">28</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="使用Tweaks对gnome美化"><a href="#使用Tweaks对gnome美化" class="headerlink" title="使用Tweaks对gnome美化"></a>使用Tweaks对gnome美化</h3><p>Ubuntu 18.04 LTS 内置的是 gnome 桌面环境,安装一些主题、图标美化一下整个系统。再用几个插件增强一下效果和使用体验即可。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get <span class="keyword">install </span>gnome-tweak-tool   <span class="comment">#安装tweak</span></span><br><span class="line">sudo apt-get <span class="keyword">install </span>gnome-<span class="keyword">shell-extensions </span>-y  <span class="comment">#安装shell扩展</span></span><br><span class="line">sudo apt <span class="keyword">install </span>chrome-gnome-<span class="keyword">shell </span>    <span class="comment">#为了能在浏览器内安装gnome插件，火狐和谷歌都能用</span></span><br><span class="line">sudo apt-get <span class="keyword">install </span>gtk2-engines-pixbuf    <span class="comment">#防止GTK2错误</span></span><br><span class="line">sudo apt <span class="keyword">install </span>libxml2-utils</span><br></pre></td></tr></table></figure><p>gnome桌面环境主题、图标 下载地址：<br><a href="https://www.gnome-look.org/">https://www.gnome-look.org/</a><br>以下是我使用配置：<br><a href="https://github.com/EliverLara/Ant">仿macOS主题Ant</a><br><a href="https://i.loli.net/2019/03/13/5c88ce2486591.png"><img src="https://i.loli.net/2019/03/13/5c88ce2486591.png" alt="Ant"></a>AntAnt<br>安装使用配置: &#96;Ctrl+Alt+T 打开terminal，执行如下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">rm</span> /var/lib/apt/lists/lock</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">rm</span> /var/cache/apt/archives/lock</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get update</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apt-get install gnome-tweak-tool</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> .themes</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/.themes/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/EliverLara/Ant.git</span></span><br></pre></td></tr></table></figure><p>主题已经安装完成了，你可以打开 Tweaks – Appearance – Applications ，找到你刚下载下来的主题并一键使用。<br><a href="https://i.loli.net/2019/03/13/5c88cf808feb5.png"><img src="https://i.loli.net/2019/03/13/5c88cf808feb5.png" alt="Ant主题使用"></a>Ant主题使用Ant主题使用<br><a href="https://github.com/keeferrourke/la-capitaine-icon-theme">仿macOS主题扁平化图标 La Capitaine</a><br><a href="https://i.loli.net/2019/03/13/5c88d29138933.png"><img src="https://i.loli.net/2019/03/13/5c88d29138933.png" alt="La Capitaine"></a>La CapitaineLa Capitaine</p><p>同样，&#96;Ctrl+Alt+T 打开terminal，执行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/.icons</span><br><span class="line">$ <span class="built_in">cd</span> ~/.icons/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/keeferrourke/la-capitaine-icon-theme.git</span><br></pre></td></tr></table></figure><p>OK，图标包安装完成，直接打开 Tweaks – Appearance – Icons ，选择使用即可。</p><p><a href="https://github.com/micheleg/dash-to-dock">仿macOS主题dask栏</a></p><p><a href="https://i.loli.net/2019/03/13/5c88d25f1c902.png"><img src="https://i.loli.net/2019/03/13/5c88d25f1c902.png" alt="dash-to-dock"></a>dash-to-dockdash-to-dock</p><p>这是一个dask栏插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> .temp</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> .temp/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/micheleg/dash-to-dock/archive/master.zip</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> master/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure><p>还没结束！现在进入重点部分，在键盘按下 <strong>Alt+F2 键</strong>，在弹出的窗口中输入字母 <code>r</code>。</p><p>嗯，现在才正式安装完插件。</p><p><a href="https://i.loli.net/2019/03/13/5c88d3dc523e6.png"><img src="https://i.loli.net/2019/03/13/5c88d3dc523e6.png" alt="Tweaks tool的界面"></a>Tweaks tool的界面Tweaks tool的界面</p><h3 id="Dash-to-dock-Settings"><a href="#Dash-to-dock-Settings" class="headerlink" title="Dash to dock Settings"></a>Dash to dock Settings</h3><p><a href="https://i.loli.net/2019/03/14/5c89a64d80b0c.png"><img src="https://i.loli.net/2019/03/14/5c89a64d80b0c.png" alt="Dash to dock Settings"></a>Dash to dock SettingsDash to dock Settings</p><h4 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h4><ol><li>我在安装的时候遇到Ubuntu18.04.2LTS自带dock栏与dash to dock冲突,输入以下命令将自带dock移动到～下，重启后即可解决此问题(也可移动到其他目录或者直接rm删除)。<strong>Ubuntu 更新后需要再执行一遍</strong>，因为更新会修复自带的 dock。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> /usr/share/gnome-shell/extensions/ubuntu-dock@ubuntu.com ~/</span><br><span class="line">或者</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /usr/share/gnome-shell/extensions/ubuntu-dock@ubuntu.com</span><br></pre></td></tr></table></figure><ol><li>前面说到查看gnome版本，<a href="https://github.com/micheleg/dash-to-dock">dash-to-dock</a>有对应的<code>branch</code>，<code>git clone</code>拉取时加上<code>-b</code>参数拉取对应版本分支</li></ol><h2 id="聊天软件"><a href="#聊天软件" class="headerlink" title="聊天软件"></a>聊天软件</h2><ul><li><p><a href="https://telegram.org/">Telegram</a></p></li><li><p>Wechat Work&amp; Foxmail</p><p>使用<a href="https://github.com/wszqkzqk/deepin-wine-ubuntu">deepin-wine-ubuntu</a> 移植的企业微信 和Foxmail</p></li></ul><p>其他deepin-wine容器：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/">阿里云镜像下载</a></p><p>安装使用：</p><p>打开terminal,执行下列命令</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/wszqkzqk/deepin-wine-ubuntu.git</span><br></pre></td></tr></table></figure><p>cd到deepin-wine-for-ubuntu文件夹下面，执行下列命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure><p>在home目录下新建一个文件夹,我命名的是softwares，然后cd进入softwares，执行如下命令:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/deepin/</span>pool<span class="regexp">/non-free/</span>d<span class="regexp">/deepin.com.weixin.work/</span>deepin.com.weixin.work_2.<span class="number">4.16</span>.<span class="number">1347</span>deepin0_i386.deb</span><br></pre></td></tr></table></figure><p>在softwares目录下,执行以下命令</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -<span class="selector-tag">i</span> deepin<span class="selector-class">.com</span><span class="selector-class">.weixin</span><span class="selector-class">.work_2</span>.<span class="number">4.16</span>.<span class="number">1347</span>deepin0_i386.deb</span><br></pre></td></tr></table></figure><h2 id="网速和CPU使用率工具"><a href="#网速和CPU使用率工具" class="headerlink" title="网速和CPU使用率工具"></a>网速和CPU使用率工具</h2><p>打开terminal,执行下列命令</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:fossfreedom/indicator-sysmonitor</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install indicator-sysmonitor</span><br></pre></td></tr></table></figure><p>接着执行命令</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ndicator<span class="punctuation">-</span>sysmonitor <span class="meta">&amp;</span></span><br></pre></td></tr></table></figure><p>然后Ctrl+C就可以实现后台运行indicator-sysmonitor</p><p><a href="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313142855.png"><img src="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313142855.png" alt="运行效果"></a>运行效果运行效果</p><p>设置开机启动</p><p><a href="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313143941.png"><img src="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313143941.png" alt="设置开机启动"></a>设置开机启动设置开机启动</p><p><a href="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313144129.png"><img src="https://raw.githubusercontent.com/xmaihh/piggo-token/master/img20190313144129.png" alt="参数配置"></a>参数配置参数配置</p><h2 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h2><p>下载<a href="https://nodejs.org/zh-cn/download/">Node.js</a></p><p>接着执行以下命令</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/<span class="keyword">node</span><span class="title">/</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">wget</span> https://npm.taobao.org/mirrors/<span class="keyword">node</span><span class="title">/v10</span>.<span class="number">15.3</span>/<span class="keyword">node</span><span class="title">-v10</span>.<span class="number">15.3</span>-linux-x64.tar.gz  <span class="comment">#下载安装包</span></span><br><span class="line"></span><br><span class="line">tar -zxvf <span class="keyword">node</span><span class="title">-v10</span>.<span class="number">15.3</span>-linux-x64.tar.gz  <span class="comment"># 解压安装包</span></span><br><span class="line"></span><br><span class="line">rm  <span class="keyword">node</span><span class="title">-v10</span>.<span class="number">15.3</span>-linux-x64.tar.gz  <span class="comment"># 移除安装包</span></span><br><span class="line"></span><br><span class="line">ln -s /usr/local/<span class="keyword">node</span><span class="title">/node-v10</span>.<span class="number">15.3</span>-linux-x64/bin/npm /usr/local/bin/npm</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/<span class="keyword">node</span><span class="title">/node-v10</span>.<span class="number">15.3</span>-linux-x64/bin/<span class="keyword">node</span> <span class="title">/usr</span>/local/bin/<span class="keyword">node</span><span class="title"></span></span><br></pre></td></tr></table></figure><p>查看npm版本</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xmaihh<span class="variable">@xmaihh</span>-<span class="variable constant_">H81M</span>-<span class="variable constant_">S1</span><span class="symbol">:/usr/local/node</span><span class="variable">$ </span>npm -v</span><br><span class="line"><span class="number">6.4</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>npm升级,@后面是版本号</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">npm</span> i -g npm@<span class="number">6</span>.<span class="number">4</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>在 Ubuntu 这类 Debian 体系的系统上，可以用 apt-get 安装：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install git</span><br></pre></td></tr></table></figure><p>配置信息</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git config --<span class="keyword">global</span> user.name <span class="string">&quot;yourname&quot;</span> <span class="meta">#引号里面输入你的名字</span></span><br><span class="line">git config --<span class="keyword">global</span> user.email <span class="string">&quot;youremail&quot;</span> <span class="meta">#输入邮箱</span></span><br><span class="line">git config --<span class="keyword">global</span> core.autocrlf <span class="literal">false</span> <span class="meta">#消除由于Windows和Linux平台中换行符的差异导致的问题</span></span><br><span class="line">git config --<span class="keyword">global</span> core.quotepath off <span class="meta">#消除由于路径或者是文件名包含中文导致的乱码问题</span></span><br><span class="line">git config --<span class="keyword">global</span> gui.encoding utf<span class="number">-8</span> <span class="meta">#消除gui界面中文乱码问题(如果全程使用命令行的话不用担心这个问题)</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;youremail&quot;</span> <span class="meta">#配置ssh的密钥，输完之后一路回车</span></span><br><span class="line">eval `ssh-agent` <span class="meta">#启用ssh-agent</span></span><br><span class="line">ssh-<span class="keyword">add</span> ~/.ssh/id_rsa <span class="meta">#添加密钥</span></span><br><span class="line">ssh-<span class="keyword">add</span> -l <span class="meta">#将它添加到已知的key列表中</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub <span class="meta">#把这个公钥添加到自己的Github账户上去</span></span><br></pre></td></tr></table></figure><h1 id="2019-7-30补充-卸载Sougou输入法"><a href="#2019-7-30补充-卸载Sougou输入法" class="headerlink" title="2019-7-30补充 卸载Sougou输入法"></a>2019-7-30补充 卸载Sougou输入法</h1><p>鉴于Sougou Pinyin输入法在gnome3桌面日常崩溃，每每查看 &#x2F;var&#x2F;crash&#x2F; 目录下崩溃日志都有，卸载了。</p><p>  $ sudo apt-get  purge  sogoupinyin     （卸载搜狗拼音输入法）<br>  $ sudo apt-get purge  fcitx     （卸载fcitx）<br>  $ sudo apt-get autoremove    （彻底卸载fcitx及相关配置）<br>注销重新登录一下或者重启。</p><p>新输入法<br>rime输入法</p><p>$ sudo apt install ibus-rime（安装rime输入法）</p><p>$ sudo apt install librime-data-wubi（安装五笔库）</p><p>$ sudo apt install librime-data-pinyin-simp （安装简体拼音库）<br>在 ~&#x2F;.config&#x2F;ibus&#x2F;rime&#x2F; 下新建一个文件  default.custom.yaml （覆盖默认设置）</p><p>内容是：</p><p>patch:</p><pre><code>   schema_list:           - schema: wubi_pinyin           - schema: pinyin_simp           - schema: wubi86</code></pre><p>说明：schema 是输入法顺序，如果仅用拼音或五笔，则将对应的项移到最前面，本人要五笔拼音一起混用，所以将wubi_pinyin放到了前面。</p><p>并且修改</p><p>wubi_pinyin.schema.yaml</p><p>switches下的reset 值由0改为1，意思是重启后默认由中文状态改为英文状态。</p><p>重启操作系统，使安装生效。</p><p>打开“setting（设置）”，“Region&amp;Language（区域和语言）”，点+号，添加输入法 Chinese(Rime) 。如果不用其它输入法，可以删除，其实也真不用其它输入法了</p><p>注销重新登录一下或者重启。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.jackyu.club/jack/1-13/">Ubuntu18.04完整新手安装教程</a></p><p><a href="https://sspai.com/post/45791">Ubuntu 18.04 LTS 安装（踩坑）配置全记录</a></p><p><a href="https://blog.csdn.net/u012052268/article/details/77145427">安装Ubuntu Linux系统时硬盘分区最合理的方法</a></p><p><a href="https://blog.csdn.net/hymanjack/article/details/80285400">Ubuntu18.04安装后应该做的事</a></p><p><a href="https://links.jianshu.com/go?to=%5Bhttps://jingyan.baidu.com/article/4853e1e5b090a31909f7269c.html%5D(https://jingyan.baidu.com/article/4853e1e5b090a31909f7269c.html)">Ubuntu 18.04 安装 ibus-rime 输入法</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>高字节与低字节、高地址与低地址、大端模式与小端模式、网络字节顺序与主机字节顺序</title>
      <link href="/blog/2019/03/06/gao-zi-jie-yu-di-zi-jie-gao-di-zhi-yu-di-di-zhi-da-duan-mo-shi-yu-xiao-duan-mo-shi-wang-luo-zi-jie-shun-xu-yu-zhu-ji-zi-jie-shun-xu/"/>
      <url>/blog/2019/03/06/gao-zi-jie-yu-di-zi-jie-gao-di-zhi-yu-di-di-zhi-da-duan-mo-shi-yu-xiao-duan-mo-shi-wang-luo-zi-jie-shun-xu-yu-zhu-ji-zi-jie-shun-xu/</url>
      
        <content type="html"><![CDATA[<ul><li>字节序，顾名思义字节的顺序，再多说两句就是大于一个字节类型的数据在内存中的存放顺序(一个字节的数据当然就无需谈顺序的问题了)。</li><li>低地址、高地址：内存地址可以对应十六进制的数值，值大的为高地址，否则为低地址。</li><li>网络字节顺序NBO(Network Byte Order):按从高到低的顺序存储，在网络上使用统一的网络字节顺序，可以避免兼容性问题。</li><li>主机字节顺序HBO(Host Byte Order):不同的机器HBO不相同，与CPU设计有关计算机数据存储有两种字节优先顺序：高位字节优先和低位字节优先。在网络上数据以高位字节优先顺序在网络上传输，所以对于在内部是以低位字节优先方式存储数据的机器，在网络上传输数据时就需要进行转换。</li></ul><h1 id="高字节与低字节"><a href="#高字节与低字节" class="headerlink" title="高字节与低字节"></a>高字节与低字节</h1><p>字节顺序是指占内存多于一个字节类型的数据在内存中的存放顺序，通常有小端、大端两种字节顺序。<br>小端字节序指低字节数据存放在内存低地址处，高字节数据存放在内存高地址处；<br>大端字节序是高字节数据存放在低地址处，低字节数据存放在高地址处。</p><ul><li>计算机的数值应视为连续若干个二进制位的集合</li><li>所谓高、低字节就是此集合中位地址高&#x2F;低的二进制位集合</li><li>例如定义一个unsigned short型变量在0x1234 5678，那么这个变量的地址就是0x1234 5678，占用0x1234 5678与0x1234 5679两字节存储空间，其中0x1234 5678是低字节、0x1234 5679是高字节</li><li>一个16进制数有两个字节组成，例如：A9。高字节就是指16进制数的前8位（权重高的8位），如上例中的A。低字节就是指16进制数的后8位（权重低的8位），如上例中的9</li></ul><p>举个栗子，按平时书写习惯，从左到右是高位到地位的顺序，假设有一张1000块的钞票，从左往右写就是<code>1000</code>，1所在的位置为高位，想象一下如果把<code>1</code>写在低位，就是<code>0001</code>，那样你得到的就是1块钱了。</p><h1 id="高地址与低地址"><a href="#高地址与低地址" class="headerlink" title="高地址与低地址"></a>高地址与低地址</h1><p>在内存中，栈是向下生长的,以char arr[4]为例，（因为char类型数据只有一个字节，不存在字节序的问题）依次输出每个元素的地址，可以发现，arr[0]的地址最低，arr[3]的地址最高，如图:</p><p><img src="https://i.loli.net/2019/03/06/5c7f8954dea03.png" alt="高地址与低地址 char举例"></p><h2 id="高低位"><a href="#高低位" class="headerlink" title="高低位"></a>高低位</h2><p>接下来看什么是高低位</p><p> 给一个十进制整数，<code>123456</code>，很明显左边的是高位，右边的是低位。计算机也是这样认为的。给一个16进制数，<code>0x12345678</code>，以字节为单位，从高位到低位依次是 <code>0x12</code>、<code>0x34</code>、<code>0x56</code>、<code>0x78</code>。</p><p> 接下来将高地地址和高低位对应。</p><pre><code> 一个整形占4个字节，给一个整形数据0x12345678，如果是大端存储，存储格式如下:</code></pre><p><img src="https://i.loli.net/2019/03/06/5c7f8e88da55d.png" alt="大端存储"></p><p>如果是小端存储，存储格式如下:</p><p><img src="https://i.loli.net/2019/03/06/5c7f9034ba334.png" alt="小端存储"></p><h2 id="如何判断当前系统是大端还是小端呢？"><a href="#如何判断当前系统是大端还是小端呢？" class="headerlink" title="如何判断当前系统是大端还是小端呢？"></a>如何判断当前系统是大端还是小端呢？</h2><p>最简单地来说，我们可以用 1 为例，1在栈中存储的大小端格式分别如下图所示:</p><p><img src="https://i.loli.net/2019/03/06/5c7f934a6fbb2.png"></p><p>如果我们可以得到 1 在内存中存储的第一个字节，那么我们就可以知道当前系统是大端存储还是小端存储了。</p><h1 id="大端模式与小端模式"><a href="#大端模式与小端模式" class="headerlink" title="大端模式与小端模式"></a>大端模式与小端模式</h1><h2 id="为什么会有大小端？"><a href="#为什么会有大小端？" class="headerlink" title="为什么会有大小端？"></a>为什么会有大小端？</h2><p> 这是因为在计算机系统中，我们是以字节为单位的，每个地址单元都对应着一个字节，一个字节为 8bit。但是在C语言中除了8bit的char之外，还有16bit的short型，32bit的long型（要看具体的编译器），另外，对于位数大于 8位的处理器，例如16位或者32位的处理器，由于寄存器宽度大于一个字节，那么必然存在着一个如果将多个字节安排的问题。因此就导致了大端存储模式和小端存储模式。例如一个16bit的short型x，在内存中的地址为0x0010，x的值为0x1122，那么0x11为高字节，0x22为低字节。对于大端模式，就将0x11放在低地址中，即0x0010中，0x22放在高地址中，即0x0011中。小端模式，刚好相反。我们常用的X86结构是小端模式，而KEIL C51则为大端模式。很多的ARM，DSP都为小端模式。有些ARM处理器还可以由硬件来选择。</p><h2 id="大小端是什么"><a href="#大小端是什么" class="headerlink" title="大小端是什么?"></a>大小端是什么?</h2><p><img src="https://i.loli.net/2019/03/06/5c7f95c739fca.png" alt="大小端是什么"></p><ul><li><p>所谓的大端模式，是指数据的低位保存在内存的高地址中，而数据的高位，保存在内存的低地址中；</p></li><li><p>所谓的小端模式，是指数据的低位保存在内存的低地址中，而数据的高位保存在内存的高地址中。</p></li></ul><p>大端方式将高位存放在低地址，小端方式将低位存放在低地址。采用大端方式 进行数据存放符合人类的正常思维，而采用小端方式进行数据存放利于计算机处理。</p><h2 id="大小端分别的优势"><a href="#大小端分别的优势" class="headerlink" title="大小端分别的优势"></a>大小端分别的优势</h2><ul><li><p>小端模式(Little-Endian)：强制转换数据不需要调整字节内容，1、2、4字节的存储方式一样。</p></li><li><p>大端模式(Big-Endian)：符号位的判定固定为第一个字节，容易判断正负。</p></li></ul><h2 id="大小端的判断"><a href="#大小端的判断" class="headerlink" title="大小端的判断"></a>大小端的判断</h2><p>简单介绍两种方法<br>方法1：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">hehe</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">&#125;un;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    un.a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(un.c == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;小端存储\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;大端存储\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法2：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span> *p = (<span class="type">char</span> *)&amp;a;</span><br><span class="line">    <span class="keyword">if</span>(*p == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;小端存储\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;大端存储\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="网络字节序与主机字节序"><a href="#网络字节序与主机字节序" class="headerlink" title="网络字节序与主机字节序"></a>网络字节序与主机字节序</h1><ul><li><p>网络字节顺序NBO（Network Byte Order）：按从高到低的顺序存储，在网络上使用统一的网络字节顺序，可以避免兼容性问题。</p></li><li><p>主机字节顺序（HBO，Host Byte Order）：不同的机器HBO不相同，与CPU设计有关计算机数据存储有两种字节优先顺序：高位字节优先和低位字节优先。</p></li></ul><p>Internet上数据以高位字节优先顺序在网络上传输，所以对于在内部是以低位字节优先方式存储数据的机器，在Internet上传输数据时就需要进行转换。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/qq_27384769/article/details/80700320">https://blog.csdn.net/qq_27384769&#x2F;article&#x2F;details&#x2F;80700320</a><br><a href="https://blog.csdn.net/Dawn_sf/article/details/54565487">https://blog.csdn.net/Dawn_sf&#x2F;article&#x2F;details&#x2F;54565487</a><br><a href="https://blog.csdn.net/liubing8609/article/details/82054745">https://blog.csdn.net/liubing8609/article/details/82054745</a><br><a href="https://blog.csdn.net/ywgdk/article/details/52788447">https://blog.csdn.net/ywgdk/article/details/52788447</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jni </tag>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>W/linker: libxxx.so: unused DT entry: type 0x6ffffffe arg 0x5a4</title>
      <link href="/blog/2019/03/05/w-linker-libxxx-so-unused-dt-entry-type-0x6ffffffe-arg-0x5a4/"/>
      <url>/blog/2019/03/05/w-linker-libxxx-so-unused-dt-entry-type-0x6ffffffe-arg-0x5a4/</url>
      
        <content type="html"><![CDATA[<p>我正在使用<a href="https://github.com/xmaihh/Android-Serialport">libserialport.so</a>,在运行时，我收到以下警告:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W/linker: libserialport.so: unused DT entry: type <span class="number">0x6ffffffe</span> arg <span class="number">0x5a4</span></span><br><span class="line">    libserialport.so: unused DT entry: type <span class="number">0x6fffffff</span> arg <span class="number">0x1</span></span><br></pre></td></tr></table></figure><h1 id="Q-What-are-“unused-DT-entry”-errors"><a href="#Q-What-are-“unused-DT-entry”-errors" class="headerlink" title="Q:What are “unused DT entry” errors?"></a>Q:What are “unused DT entry” errors?</h1><p>If you have reached this page, it’s probably because you have compiled or attempted to run some binaries on your ARM based Android system, with the result that your binary&#x2F;app crashes or generates a lot of warnings in your logcat. Typically something like this:</p><p>如果您已到达此页面，可能是因为您已编译或尝试在基于ARM的Android系统上运行某些二进制文件，结果导致您的二进制文件&#x2F;应用程序崩溃或在您的系统中生成大量警告  logcat。通常是这样的:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: linker: /blahblah/libopenssl.so: unused DT entry: type <span class="number">0x6ffffffe</span> arg <span class="number">0x1188</span></span><br></pre></td></tr></table></figure><h1 id="Q-What-is-a-“DT-entry”"><a href="#Q-What-is-a-“DT-entry”" class="headerlink" title="Q: What is a “DT entry”?"></a>Q: What is a “DT entry”?</h1><p>In a few words, they are descriptive array entries in the file structure of an ELF file. Specifically they are known as  Dynamic Array Tags and are requirements for executable and shared objects. However, not all entries are required or available, depending on the processor and kernel architecture.</p><p>In our case we are faced with a “Warning” that one of these are “unused”. What that means is, that your executable or library (*.so) files has been compiled with the DT entry indicated, but your kernel is not supporting that entry, for various reasons. The best examples are found on ARM based Android systems, where the system library paths are fixed and the cross compilers used for your firmware (OS&#x2F;kernel) are set not to use these entries. Usually the binaries still run just fine, but the kernel is flagging this warning every time you’re using it.</p><p>简而言之，它们是<a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a>文件的文件结构中的描述性数组条目  。具体而言，它们被称为  Dynamic Array Tags 可执行和共享对象的要求。但是，并非所有条目都是必需的或可用的，具体取决于处理器和内核体系结构。在我们的案例中，我们面临一个“警告”，其中一个是“未使用”。这意味着，您的可执行文件或库（*.so）文件已使用 指示的DT条目进行编译  ，但由于各种原因，您的内核不支持该条目。最好的例子可以在基于ARM的Android系统上找到，其中系统库路径是固定的，用于固件的交叉编译器（OS &#x2F;内核）设置为不使用这些条目。通常二进制文件仍然可以正常运行，但内核每次使用它时都会标记此警告。</p><h1 id="Q-When-does-this-happen"><a href="#Q-When-does-this-happen" class="headerlink" title="Q: When does this happen?"></a>Q: When does this happen?</h1><p>This can happen when:</p><ul><li>Your ARM kernel is cross-compiled using the wrong flags (usually meant for other processor architectures).</li><li>您的ARM内核使用错误的标志进行交叉编译（通常用于其他处理器体系结构）。</li><li>Your ARM binaries and libraries are cross-compiled using AOS deprecated compilation flags.</li><li>您的ARM二进制文件和库是使用AOS弃用的编译标志进行交叉编译的。</li><li>and probably other ways yet to be discovered..</li><li>可能还有其他方法尚待发现..</li></ul><blockquote><p>Starting from 5.1 (API 22) the Android linker warns about the VERNEED and VERNEEDNUM ELF dynamic sections.</p></blockquote><blockquote><p>从5.1（API 22）开始，Android链接器会警告VERNEED和VERNEEDNUM ELF动态部分。</p></blockquote><p>The most common flags that cause this error on Android devices are:</p><p>在Android设备上导致此错误的最常见标志是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DT_RPATH        <span class="number">0x0f</span> (<span class="number">15</span>)       The DT_STRTAB string table offset of a <span class="literal">null</span>-terminated library search path string. </span><br><span class="line">                                This element<span class="string">&#x27;s use has been superseded by DT_RUNPATH.</span></span><br><span class="line"><span class="string">DT_RUNPATH      0x1d (29)       The DT_STRTAB string table offset of a null-terminated library search path string.</span></span><br><span class="line"><span class="string">DT_VERNEED      0x6ffffffe      The address of the version dependency table. Elements within this table contain </span></span><br><span class="line"><span class="string">                                indexes into the string table DT_STRTAB. This element requires that the </span></span><br><span class="line"><span class="string">                                DT_VERNEEDNUM element also be present.</span></span><br><span class="line"><span class="string">DT_VERNEEDNUM   0x6fffffff      The number of entries in the DT_VERNEEDNUM table.</span></span><br></pre></td></tr></table></figure><p>Tracking down the error above, we find that this message comes from the <code>bionic</code> library <a href="https://github.com/aosp-mirror/platform_bionic/blob/1fedfedda8a2b75ed56669e28265f943312ec22f/linker/linker.cpp#L2967-L2986">linker.cpp</a>:<br>追踪上面的错误，我们发现此消息来自  <code>bionic</code> 库<a href="https://github.com/aosp-mirror/platform_bionic/blob/1fedfedda8a2b75ed56669e28265f943312ec22f/linker/linker.cpp#L2967-L2986">linker.cpp</a>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">case</span> DT_VERNEED:</span><br><span class="line">    verneed_ptr_ = load_bias + d-&gt;d_un.d_ptr;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> DT_VERNEEDNUM:</span><br><span class="line">    verneed_cnt_ = d-&gt;d_un.d_val;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> DT_RUNPATH:</span><br><span class="line">    <span class="comment">// this is parsed after we have strtab initialized (see below).</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">if</span> (!relocating_linker) &#123;</span><br><span class="line">      DL_WARN(<span class="string">&quot;\&quot;%s\&quot; unused DT entry: type %p arg %p&quot;</span>, get_realpath(),</span><br><span class="line">          reinterpret_cast&lt;<span class="keyword">void</span>*&gt;(d-&gt;d_tag), reinterpret_cast&lt;<span class="keyword">void</span>*&gt;(d-&gt;d_un.d_val));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The code (above) supporting this symbol versioning was committed on April 9, 2015. Thus if your NDK build is either set to support API’s earlier than this, or using build tools linking to this earlier library, you will get these warnings.</p><p>支持此<a href="https://lists.debian.org/lsb-spec/1999/12/msg00017.html">符号版本控制</a>的代码（上文）   于<a href="https://github.com/android/platform_bionic/commit/2a815361448d01b0f4e575f507ce31913214c536#diff-9d78f752a519d0c92b4cf2c888fe26e4">2015</a>年<a href="https://github.com/android/platform_bionic/commit/2a815361448d01b0f4e575f507ce31913214c536#diff-9d78f752a519d0c92b4cf2c888fe26e4">4月9日</a>提交  。因此，如果您的NDK构建设置为支持早于此的API，或者使用链接到此早期库的构建工具，您将收到这些警告。</p><h1 id="Q-How-do-I-find-what-DT-entries-my-system-or-binaries-are-using"><a href="#Q-How-do-I-find-what-DT-entries-my-system-or-binaries-are-using" class="headerlink" title="Q: How do I find what DT entries my system or binaries are using?"></a>Q: How do I find what DT entries my system or binaries are using?</h1><p>There are many ways to do this:</p><ol><li>You look into your kernel sources for <code>&lt;linux/elf.h&gt;</code>.</li><li>You look in your Android NDK installation folders and check:</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To find all elf.h files:</span></span><br><span class="line">find /&lt;path_to&gt;/ndk/platforms/android-*/arch-arm*/usr/include/linux/ -iname &quot;elf.h&quot;</span><br></pre></td></tr></table></figure><ol start="3"><li>Do an readelf of your binary:</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">readelf --dynamic libopenssl.so</span></span><br><span class="line"></span><br><span class="line"> Dynamic section at offset 0x23b960 contains 28 entries:</span><br><span class="line"> Tag        Type                         Name/Value</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x23ce18</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   952 (bytes)</span><br><span class="line"> 0x00000017 (JMPREL)                     0x15e70</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000011 (REL)                        0x11c8</span><br><span class="line"> 0x00000012 (RELSZ)                      85160 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffa (RELCOUNT)                   10632</span><br><span class="line"> 0x00000015 (DEBUG)                      0x0</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x148</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000005 (STRTAB)                     0x918</span><br><span class="line"> 0x0000000a (STRSZ)                      1011 (bytes)</span><br><span class="line"> 0x00000004 (HASH)                       0xd0c</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libdl.so]</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so]</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x238458</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               8 (bytes)</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x238460</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               16 (bytes)</span><br><span class="line"> 0x00000020 (PREINIT_ARRAY)              0x238470</span><br><span class="line"> 0x00000021 (PREINIT_ARRAYSZ)            0x8</span><br><span class="line"> 0x0000001e (FLAGS)                      BIND_NOW</span><br><span class="line"> 0x6ffffffb (FLAGS_1)                    Flags: NOW</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x108c</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x1188</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 2</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure><p> As you can see from the error above, the type corresponds to DT_VERNEED.</p><p>From <a href="http://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html#scrolltoc">THIS</a> document:</p><blockquote><p>DT_RPATH</p></blockquote><p>This element holds the string table offset of a null-terminated search library search path string, discussed in “Shared Object Dependencies.” The offset is an index into the table recorded in the DT_STRTAB entry. DT_RPATH may give a string that holds a list of directories, separated by colons (:). All LD_LIBRARY_PATH directories are searched after those from DT_RPATH.</p><p>DT_RPATH此元素保存以“共享对象依赖关系”中讨论的以null结尾的搜索库搜索路径字符串的字符串表偏移量。偏移量是DT_STRTAB条目中记录的表的索引。DT_RPATH可以给出一个包含目录列表的字符串，以冒号（:)分隔。在DT_RPATH之后搜索所有LD_LIBRARY_PATH目录。</p><h1 id="Q-So-how-do-you-solve-or-deal-with-these-issues"><a href="#Q-So-how-do-you-solve-or-deal-with-these-issues" class="headerlink" title="Q: So how do you solve or deal with these issues?"></a>Q: So how do you solve or deal with these issues?</h1><p>There are essentially 3 ways to deal with this:</p><ol><li>the quick</li><li>the bad</li><li>the ugly</li></ol><h2 id="The-Quick-you-don’t-have-any-sources-or-just-can’t-be-bothered"><a href="#The-Quick-you-don’t-have-any-sources-or-just-can’t-be-bothered" class="headerlink" title="The Quick (you don’t have any sources or just can’t be bothered)"></a>The Quick (you don’t have any sources or just can’t be bothered)</h2><p>Use an “ELF cleaner” to remove the offending DT entries from a all your binaries. This is an easy and quick remedy, especially when you don’t have the sources to recompile them properly for your system. There are at least <a href="https://github.com/kost/android-elf-cleaner">two cleaners</a> out there that you can use.</p><h2 id="The-Bad-you-have-the-sources"><a href="#The-Bad-you-have-the-sources" class="headerlink" title="The Bad (you have the sources)"></a>The Bad (you have the sources)</h2><p>Is the right way to do it, because you’ll become a bad-ass ARM cross compiler guru in the process of getting it to work. You basically need to find and tune the compiler settings in the Makefiles used.</p><p>From <a href="https://gitlab.com/jbwhips883/termux-packages">here</a>:</p><p><a href="https://github.com/kost/android-elf-cleaner">解决方法：https://github.com/kost/android-elf-cleaner</a></p><blockquote><p>The Android linker (&#x2F;system&#x2F;bin&#x2F;linker) does not support RPATH or RUNPATH, so we set LD_LIBRARY_PATH&#x3D;$USR&#x2F;lib and try to avoid building useless rpath entries with –disable-rpath configure flags. Another option to avoid depending on LD_LIBRARY_PATH would be supplying a custom linker - this is not done due to the overhead of maintaining a custom linker.</p></blockquote><h2 id="The-Ugly-You-just-want-your-app-to-work-with-any-dirty-binary"><a href="#The-Ugly-You-just-want-your-app-to-work-with-any-dirty-binary" class="headerlink" title="The Ugly (You just want your app to work with any dirty binary.)"></a>The Ugly (You just want your app to work with any dirty binary.)</h2><p>You tell your Java app not to freak out when checking for null in error handlers and instead get fed these warnings, possibly causing fatal exceptions. Use something like:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OpensslErrorThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> opensslStderr.readLine();</span><br><span class="line">                <span class="keyword">if</span>(line == <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// OK</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(line.contains(<span class="string">&quot;unused DT entry&quot;</span>))&#123;</span><br><span class="line">                    Log.i(TAG, <span class="string">&quot;Ignoring \&quot;unused DT entry\&quot; error from openssl: &quot;</span> + line);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// throw exception!</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Exception!&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This is very bad and ugly as it doesn’t solve anything, while bloating your code. In addition, the warnings are there for a reason, and that is that in future AOS versions, this will become a full fledged error!</p><h1 id="Q-What-else"><a href="#Q-What-else" class="headerlink" title="Q. What else?"></a>Q. What else?</h1><p>Many changes in the API’s between 18-25 (J to N) has been made in way the Android kernel and libraries are compiled. I cannot provide a remotely close explanation of all that, but perhaps this will help guide you in the right direction. The best sources is of course looking in the Android sources and documentation itself.</p><p>For example, <a href="https://github.com/android/platform_bionic/blob/master/android-changes-for-ndk-developers.md">HERE</a> or <a href="https://developer.android.com/ndk/guides/standalone_toolchain.html">HERE</a>.</p><p>And finally the full list:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">Name                    Value           d_un            Executable              Shared Object</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line">DT_NULL                 0               Ignored         Mandatory               Mandatory</span><br><span class="line">DT_NEEDED               1               d_val           Optional                Optional</span><br><span class="line">DT_PLTRELSZ             2               d_val           Optional                Optional</span><br><span class="line">DT_PLTGOT               3               d_ptr           Optional                Optional</span><br><span class="line">DT_HASH                 4               d_ptr           Mandatory               Mandatory</span><br><span class="line">DT_STRTAB               5               d_ptr           Mandatory               Mandatory</span><br><span class="line">DT_SYMTAB               6               d_ptr           Mandatory               Mandatory</span><br><span class="line">DT_RELA                 7               d_ptr           Mandatory               Optional</span><br><span class="line">DT_RELASZ               8               d_val           Mandatory               Optional</span><br><span class="line">DT_RELAENT              9               d_val           Mandatory               Optional</span><br><span class="line">DT_STRSZ                0x0a (10)       d_val           Mandatory               Mandatory</span><br><span class="line">DT_SYMENT               0x0b (11)       d_val           Mandatory               Mandatory</span><br><span class="line">DT_INIT                 0x0c (12)       d_ptr           Optional                Optional</span><br><span class="line">DT_FINI                 0x0d (13)       d_ptr           Optional                Optional</span><br><span class="line">DT_SONAME               0x0e (14)       d_val           Ignored                 Optional</span><br><span class="line">DT_RPATH                0x0f (15)       d_val           Optional                Optional</span><br><span class="line">DT_SYMBOLIC             0x10 (16)       Ignored         Ignored                 Optional</span><br><span class="line">DT_REL                  0x11 (17)       d_ptr           Mandatory               Optional</span><br><span class="line">DT_RELSZ                0x12 (18)       d_val           Mandatory               Optional</span><br><span class="line">DT_RELENT               0x13 (19)       d_val           Mandatory               Optional</span><br><span class="line">DT_PLTREL               0x14 (20)       d_val           Optional                Optional</span><br><span class="line">DT_DEBUG                0x15 (21)       d_ptr           Optional                Ignored</span><br><span class="line">DT_TEXTREL              0x16 (22)       Ignored         Optional                Optional</span><br><span class="line">DT_JMPREL               0x17 (23)       d_ptr           Optional                Optional</span><br><span class="line">DT_BIND_NOW             0x18 (24)       Ignored         Optional                Optional</span><br><span class="line">DT_INIT_ARRAY           0x19 (25)       d_ptr           Optional                Optional</span><br><span class="line">DT_FINI_ARRAY           0x1a (26)       d_ptr           Optional                Optional</span><br><span class="line">DT_INIT_ARRAYSZ         0x1b (27)       d_val           Optional                Optional</span><br><span class="line">DT_FINI_ARRAYSZ         0x1c (28)       d_val           Optional                Optional</span><br><span class="line">DT_RUNPATH              0x1d (29)       d_val           Optional                Optional</span><br><span class="line">DT_FLAGS                0x1e (30)       d_val           Optional                Optional</span><br><span class="line">DT_ENCODING             0x1f (32)       Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_PREINIT_ARRAY        0x20 (32)       d_ptr           Optional                Ignored</span><br><span class="line">DT_PREINIT_ARRAYSZ      0x21 (33)       d_val           Optional                Ignored</span><br><span class="line">DT_MAXPOSTAGS           0x22 (34)       Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_LOOS                 0x6000000d      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_SUNW_AUXILIARY       0x6000000d      d_ptr           Unspecified             Optional</span><br><span class="line">DT_SUNW_RTLDINF         0x6000000e      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_FILTER          0x6000000e      d_ptr           Unspecified             Optional</span><br><span class="line">DT_SUNW_CAP             0x60000010      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_SYMTAB          0x60000011      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_SYMSZ           0x60000012      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_ENCODING        0x60000013      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_SUNW_SORTENT         0x60000013      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_SYMSORT         0x60000014      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_SYMSORTSZ       0x60000015      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_TLSSORT         0x60000016      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_TLSSORTSZ       0x60000017      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_CAPINFO         0x60000018      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_STRPAD          0x60000019      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_CAPCHAIN        0x6000001a      d_ptr           Optional                Optional</span><br><span class="line">DT_SUNW_LDMACH          0x6000001b      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_CAPCHAINENT     0x6000001d      d_val           Optional                Optional</span><br><span class="line">DT_SUNW_CAPCHAINSZ      0x6000001f      d_val           Optional                Optional</span><br><span class="line">DT_HIOS                 0x6ffff000      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_VALRNGLO             0x6ffffd00      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_CHECKSUM             0x6ffffdf8      d_val           Optional                Optional</span><br><span class="line">DT_PLTPADSZ             0x6ffffdf9      d_val           Optional                Optional</span><br><span class="line">DT_MOVEENT              0x6ffffdfa      d_val           Optional                Optional</span><br><span class="line">DT_MOVESZ               0x6ffffdfb      d_val           Optional                Optional</span><br><span class="line">DT_POSFLAG_1            0x6ffffdfd      d_val           Optional                Optional</span><br><span class="line">DT_SYMINSZ              0x6ffffdfe      d_val           Optional                Optional</span><br><span class="line">DT_SYMINENT             0x6ffffdff      d_val           Optional                Optional</span><br><span class="line">DT_VALRNGHI             0x6ffffdff      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_ADDRRNGLO            0x6ffffe00      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_CONFIG               0x6ffffefa      d_ptr           Optional                Optional</span><br><span class="line">DT_DEPAUDIT             0x6ffffefb      d_ptr           Optional                Optional</span><br><span class="line">DT_AUDIT                0x6ffffefc      d_ptr           Optional                Optional</span><br><span class="line">DT_PLTPAD               0x6ffffefd      d_ptr           Optional                Optional</span><br><span class="line">DT_MOVETAB              0x6ffffefe      d_ptr           Optional                Optional</span><br><span class="line">DT_SYMINFO              0x6ffffeff      d_ptr           Optional                Optional</span><br><span class="line">DT_ADDRRNGHI            0x6ffffeff      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_RELACOUNT            0x6ffffff9      d_val           Optional                Optional</span><br><span class="line">DT_RELCOUNT             0x6ffffffa      d_val           Optional                Optional</span><br><span class="line">DT_FLAGS_1              0x6ffffffb      d_val           Optional                Optional</span><br><span class="line">DT_VERDEF               0x6ffffffc      d_ptr           Optional                Optional</span><br><span class="line">DT_VERDEFNUM            0x6ffffffd      d_val           Optional                Optional</span><br><span class="line">DT_VERNEED              0x6ffffffe      d_ptr           Optional                Optional</span><br><span class="line">DT_VERNEEDNUM           0x6fffffff      d_val           Optional                Optional</span><br><span class="line">DT_LOPROC               0x70000000      Unspecified     Unspecified             Unspecified</span><br><span class="line">DT_SPARC_REGISTER       0x70000001      d_val           Optional                Optional</span><br><span class="line">DT_AUXILIARY            0x7ffffffd      d_val           Unspecified             Optional</span><br><span class="line">DT_USED                 0x7ffffffe      d_val           Optional                Optional</span><br><span class="line">DT_FILTER               0x7fffffff      d_val           Unspecified             Optional</span><br><span class="line">DT_HIPROC               0x7fffffff      Unspecified     Unspecified             Unspecified</span><br></pre></td></tr></table></figure><h1 id="WARNING-linker-demo-unused-DT-entry-type-0x6ffffffe-解决！！"><a href="#WARNING-linker-demo-unused-DT-entry-type-0x6ffffffe-解决！！" class="headerlink" title="WARNING: linker: .&#x2F;demo: unused DT entry: type 0x6ffffffe 解决！！"></a>WARNING: linker: .&#x2F;demo: unused DT entry: type 0x6ffffffe 解决！！</h1><ul><li>demo.c</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;www.chinapyg.com!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Android.mk</li></ul><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_MODULE    := demo </span><br><span class="line">LOCAL_SRC_FILES := ../demo.c </span><br><span class="line">LOCAL_ARM_MODE := arm</span><br><span class="line">LOCAL_CFLAGS := -g</span><br><span class="line">LOCAL_CFLAGS += -pie -fPIE</span><br><span class="line">LOCAL_LDFLAGS += -pie -fPIE</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br></pre></td></tr></table></figure><ul><li>Application.mk</li></ul><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">APP_OPTIM := release</span><br><span class="line">APP_PLATFORM := android-14  </span><br><span class="line">APP_ABI := armeabi-v7a</span><br></pre></td></tr></table></figure><ul><li>NDK编译:</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\piao\Downloads\adbi\demo\jni</span><br><span class="line">λ ndk-build.cmd</span><br><span class="line">[armeabi-v7a] Compile arm    : demo &lt;= demo.c</span><br><span class="line">[armeabi-v7a] Executable     : demo</span><br><span class="line">[armeabi-v7a] Install        : demo =&gt; libs/armeabi-v7a/demo</span><br></pre></td></tr></table></figure><p>经过测试~~</p><p>此警告只会在5.0以上系统出现：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ido:/data/local/tmp <span class="comment"># ./demo</span></span><br><span class="line">WARNING: linker: ./demo: unused DT entry: <span class="built_in">type</span> 0x6ffffffe arg 0x41c</span><br><span class="line">WARNING: linker: ./demo: unused DT entry: <span class="built_in">type</span> 0x6fffffff arg 0x1</span><br><span class="line">www.chinapyg.com!</span><br></pre></td></tr></table></figure><p>解决方法：<a href="https://github.com/kost/android-elf-cleaner">https://github.com/kost/android-elf-cleaner</a></p><p>在Ubuntu16.04编译后:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">piao@piaopiao:~/Desktop/android-elf-cleaner$ make</span><br><span class="line">g++   -std=c++14 -Wall -Wextra -pedantic -Werror android-elf-cleaner.cpp -o android-elf-cleaner</span><br></pre></td></tr></table></figure><p>然后执行:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">piao@piaopiao:~/Desktop/android-elf-cleaner$ ./android-elf-cleaner demo</span><br><span class="line">./android-elf-cleaner: Removing the DT_VERNEEDED dynamic section entry from <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">./android-elf-cleaner: Removing the DT_VERNEEDNUM dynamic section entry from <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">piao@piaopiao:~/Desktop/android-elf-cleaner$</span><br></pre></td></tr></table></figure><p>再次push到手机里面运行:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ido:/data/local/tmp <span class="comment"># ./demo</span></span><br><span class="line">www.chinapyg.com!</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/33206409/unused-dt-entry-type-0x1d-arg">https://stackoverflow.com/questions/33206409/unused-dt-entry-type-0x1d-arg</a><br><a href="http://blog.sina.com.cn/s/blog_602f87700102x01t.html">NDK升级遇到的一些问题汇总</a><br><a href="https://www.dllhook.com/post/211.html"> WARNING: linker: .&#x2F;demo: unused DT entry: type 0x6ffffffe 解决！！</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidStudio </tag>
            
            <tag> Jni </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java-getExtractedText对android上的非活动InputConnection警告</title>
      <link href="/blog/2019/03/05/java-getextractedtext-dui-android-shang-de-fei-huo-dong-inputconnection-jing-gao/"/>
      <url>/blog/2019/03/05/java-getextractedtext-dui-android-shang-de-fei-huo-dong-inputconnection-jing-gao/</url>
      
        <content type="html"><![CDATA[<p>我在logcat中获得以下警告</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W/IInputConnectionWrapper: finishComposingText on inactive InputConnection</span><br></pre></td></tr></table></figure><p>一直找不到背后的原因,网上找到一个类似的问题，看到如下的<code>logcat</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">W/IInputConnectionWrapper(<span class="number">21214</span>): getTextBeforeCursor on inactive InputConnection</span><br><span class="line">W/IInputConnectionWrapper(<span class="number">21214</span>): getSelectedText on inactive InputConnection</span><br><span class="line">W/IInputConnectionWrapper(<span class="number">21214</span>): getTextBeforeCursor on inactive InputConnection</span><br><span class="line">W/IInputConnectionWrapper(<span class="number">21214</span>): getTextAfterCursor on inactive InputConnection</span><br><span class="line">...</span><br><span class="line">I/Choreographer(<span class="number">20010</span>): Skipped <span class="number">30</span> frames!  The application may be doing too much work on its main thread.</span><br></pre></td></tr></table></figure><h1 id="我的情况"><a href="#我的情况" class="headerlink" title="我的情况"></a>我的情况</h1><p>我有一个EditText视图用户类型。当用户按下按钮时，EditText被清除。当我快速按下按钮时，很多非活动的InputConnection条目流出。</p><p>例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editText.setText(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>我的logcat中的最后一行提供了一个很好的指示，正在发生什么。果然，InputConnection被清除文本的请求所淹没。我试图修改代码以检查文本长度，然后再尝试清除它:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (editText.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    editText.setText(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这有助于缓解快速按下按钮不再导致<code>IInputConnectionWrapper</code>警告流的问题。然而，当用户在键入东西和按下按钮之间快速交替时，或者当应用程序处于充分负载等时按下按钮，这仍然容易出现问题。</p><p>幸运的是，我发现了另一种方式来清除文本：<code>Editable.clear()</code>.有了这一点，我不会得到警告：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (editText.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    editText.getText().clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，如果你想清除所有的输入状态，而不只是文本(自动文本，autocap，multitap，撤消)，你可以使用<code>TextKeyListener.clear(Editable e)</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (editText.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    TextKeyListener.clear(editText.getText());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://codeday.me/bug/20180429/159033.html">android - W&#x2F;IInputConnectionWrapper(1066)：showStatusIcon在非活动的InputConnection</a><br><a href="https://codeday.me/bug/20190108/514667.html">java - 如何将活动上下文放入非活动类android？</a><br><a href="https://codeday.me/bug/20170829/64838.html">android - 警告：导出的活动不需要权限</a><br><a href="https://codeday.me/bug/20181213/451206.html">android-activity - 在非活动类中获取当前活动上下文</a><br><a href="https://codeday.me/bug/20180508/160725.html">java - 从非活动单例类获取应用程序上下文</a><br><a href="https://codeday.me/bug/20181007/280723.html">android - 在超时警告通知后检索活动</a><br><a href="https://codeday.me/bug/20170714/40764.html">java - 使用非活动的startActivityForResult</a><br><a href="https://codeday.me/bug/20180105/113304.html">Java PMD对非临时类成员的警告</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[译文]Android内存泄漏的八种对应解决办法(下)</title>
      <link href="/blog/2019/02/26/yi-wen-android-nei-cun-xie-lou-de-ba-chong-dui-ying-jie-jue-ban-fa-xia/"/>
      <url>/blog/2019/02/26/yi-wen-android-nei-cun-xie-lou-de-ba-chong-dui-ying-jie-jue-ban-fa-xia/</url>
      
        <content type="html"><![CDATA[<p>在上一篇<a href="https://xmaihh.github.io/2019/02/26/%E8%AF%91%E6%96%87-Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9A%84%E5%85%AB%E7%A7%8D%E5%8F%AF%E8%83%BD-%E4%B8%8A/"><code>[译文]Android内存泄漏的八种可能(上)</code></a>中，我们讨论了八种容易发生内存泄漏的代码。其中，尤其严重的是泄漏<code>Activity</code>对象，因为它占用了大量系统内存。不管内存泄漏的代码表现形式如何，其核心问题在于：</p><ul><li>在Activity生命周期之外仍持有其引用</li></ul><p>幸运的是，一旦泄漏发生且被定位到了，修复方法是相当简单的。</p><h1 id="Static-Actitivities"><a href="#Static-Actitivities" class="headerlink" title="Static Actitivities"></a>Static Actitivities</h1><p>这种泄漏</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> MainActivity activity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setStaticActivity</span><span class="params">()</span> &#123;</span><br><span class="line">    activity = <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造静态变量持有<code>Activity</code>对象很容易造成内存泄漏，因为静态变量是全局存在的，所以当MainActivity生命周期结束时，引用仍被持有。这种写法开发者是有理由来使用的，所以我们需要正确的释放引用让垃圾回收机制在它被销毁的同时将其回收。</p><p>Android提供了特殊的<code>Set</code>集合 <a href="https://developer.android.com/reference/java/lang/ref/package-summary.html#classes">https://developer.android.com/reference/java/lang/ref/package-summary.html#classes</a></p><p>允许开发者控制引用的“强度”。<code>Activity</code>对象泄漏是由于需要被销毁时，仍然被强引用着，只要强引用存在就无法被回收。</p><p>可以用弱引用代替强引用。</p><p><a href="https://developer.android.com/reference/java/lang/ref/WeakReference.html">https://developer.android.com/reference/java/lang/ref/WeakReference.html</a></p><p>弱引用不会阻止对象的内存释放，所以即使有弱引用的存在，该对象也可以被回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WeakReference&lt;MainActivity&gt; activityReference;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setStaticActivity</span><span class="params">()</span> &#123;</span><br><span class="line">       activityReference = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;MainActivity&gt;(<span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1 id="Static-Views"><a href="#Static-Views" class="headerlink" title="Static Views"></a>Static Views</h1><p>静态变量持有View</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> View view;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setStaticView</span><span class="params">()</span> &#123;</span><br><span class="line">    view = findViewById(R.id.sv_button);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于<code>View</code>持有其宿主<code>Activity</code>的引用，导致的问题与<code>Activity</code>一样严重。弱引用是个有效的解决方法，然而还有另一种方法是在生命周期结束时清除引用，<code>Activity#onDestory()</code>方法就很适合把引用置空。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> View view;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (view != <span class="literal">null</span>) &#123;</span><br><span class="line">        unsetStaticView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unsetStaticView</span><span class="params">()</span> &#123;</span><br><span class="line">    view = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Inner-Class"><a href="#Inner-Class" class="headerlink" title="Inner Class"></a>Inner Class</h1><p>这种泄漏</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object inner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createInnerClass</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">InnerClass</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    inner = <span class="keyword">new</span> <span class="title class_">InnerClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与上述两种情况相似，开发者必须注意少用<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/nested.html">非静态内部类</a>，因为非静态内部类持有外部类的隐式引用，容易导致意料之外的泄漏。然而内部类可以访问外部类的私有变量，只要我们注意引用的生命周期，就可以避免意外的发生。</p><ul><li>避免静态变量</li></ul><p>这样持有内部类的成员变量是可以的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object inner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createInnerClass</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">InnerClass</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    inner = <span class="keyword">new</span> <span class="title class_">InnerClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Anonymous-Classes"><a href="#Anonymous-Classes" class="headerlink" title="Anonymous Classes"></a>Anonymous Classes</h1><p>前面我们看到的都是持有全局生命周期的静态成员变量引起的，直接或间接通过链式引用<code>Activity</code>导致的泄漏。这次我们用<code>AsyncTask</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">startAsyncTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Handler</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">createHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.handleMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Thread</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTimer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>全部都是因为<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/anonymousclasses.html">匿名类</a>导致的。匿名类是特殊的内部类——写法更为简洁。当需要一次性特殊的子类时，Java提供的语法糖能让表达式最少化。这种很赞很偷懒的写法容易导致泄漏。正如使用内部类一样，只要不跨越生命周期，内部类是完全没问题的。但是，这些类是用于产生后台线程的，这些Java线程是全局的，而且持有创建者的引用（即匿名类的引用），而匿名类又持有外部类的引用。线程是可能长时间运行的，所以一直持有<code>Activity</code>的引用导致当销毁时无法回收。<br>这次我们不能通过移除静态成员变量解决，因为线程是于应用生命周期相关的。为了避免泄漏，我们必须舍弃简洁偷懒的写法，把子类声明为静态内部类。</p><ul><li>静态内部类不持有外部类的引用，打破了链式引用。</li></ul><p>所以对于<code>AsyncTask</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NimbleTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startAsyncTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">NimbleTask</span>().execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Handler</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NimbleHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.handleMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NimbleRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">NimbleHandler</span>().postDelayed(<span class="keyword">new</span> <span class="title class_">NimbleRunnable</span>(), Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>TimerTask</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NimbleTimerTask</span> <span class="keyword">extends</span> <span class="title class_">TimerTask</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTimer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">NimbleTimerTask</span>(), Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，如果你坚持使用匿名类，只要在生命周期结束时中断线程就可以。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Thread thread;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">spawnThread</span><span class="params">()</span> &#123;</span><br><span class="line">    thread = <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Sensor-Manager"><a href="#Sensor-Manager" class="headerlink" title="Sensor Manager"></a>Sensor Manager</h1><p>这种泄漏</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SensorManager</span> <span class="variable">sensorManager</span> <span class="operator">=</span> (SensorManager) getSystemService(SENSOR_SERVICE);</span><br><span class="line">    <span class="type">Sensor</span> <span class="variable">sensor</span> <span class="operator">=</span> sensorManager.getDefaultSensor(Sensor.TYPE_ALL);</span><br><span class="line">    sensorManager.registerListener(<span class="built_in">this</span>, sensor, SensorManager.SENSOR_DELAY_FASTEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Android系统服务不当容易导致泄漏，为了<code>Activity</code>与服务交互，我们把<code>Activity</code>作为监听器，引用链在传递事件和回调中形成了。只要<code>Activity</code>维持注册监听状态，引用就会一直持有，内存就不会被释放。</p><ul><li>在Activity结束时注销监听器</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SensorManager sensorManager;</span><br><span class="line"><span class="keyword">private</span> Sensor sensor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (sensor != <span class="literal">null</span>) &#123;</span><br><span class="line">        unregisterListener();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unregisterListener</span><span class="params">()</span> &#123;</span><br><span class="line">    sensorManager.unregisterListener(<span class="built_in">this</span>, sensor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>Activity</code>泄漏的案例我们已经都走过一遍了，其他都大同小异。建议日后遇到类似的情况时，就使用相应的解决方法。内存泄漏只要发生过一次，通过详细的检查，很容易解决并防范于未然。</p><p>是时候做最佳实践者了！</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://blog.nimbledroid.com/2016/09/06/stop-memory-leaks.html">http://blog.nimbledroid.com/2016/09/06/stop-memory-leaks.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[译文]Android内存泄漏的八种可能(上)</title>
      <link href="/blog/2019/02/26/yi-wen-android-nei-cun-xie-lou-de-ba-chong-ke-neng-shang/"/>
      <url>/blog/2019/02/26/yi-wen-android-nei-cun-xie-lou-de-ba-chong-ke-neng-shang/</url>
      
        <content type="html"><![CDATA[<p>Java是垃圾回收语言的一种，其优点是开发者无需特意管理内存分配，降低了应用由于局部故障(segmentation fault)导致崩溃，同时防止未释放的内存把堆栈(heap)挤爆的可能，所以写出来的代码更为安全。</p><p>不幸的是，在Java中仍存在很多容易导致内存泄漏的逻辑可能(logical leak)。如果不小心，你的Android应用很容易浪费掉未释放的内存，最终导致内存用光的错误抛出(out-of-memory，OOM)。</p><p>一般内存泄漏(traditional memory leak)的原因是：由忘记释放分配的内存导致的。（译者注：<code>Cursor</code>忘记关闭等）<br>逻辑内存泄漏(logical memory leak)的原因是：当应用不再需要这个对象，当仍未释放该对象的所有引用。</p><p><code>如果持有对象的强引用，垃圾回收器是无法在内存中回收这个对象。</code></p><p>在Android开发中，最容易引发的内存泄漏问题的是<a href="https://developer.android.com/reference/android/content/Context.html">Context</a>。比如<a href="https://developer.android.com/reference/android/app/Activity.html">Activity</a>的<code>Context</code>，就包含大量的内存引用，例如<code>View Hierarchies</code>和其他资源。一旦泄漏了<code>Context</code>，也意味泄漏它指向的所有对象。Android机器内存有限，太多的内存泄漏容易导致OOM。</p><p>检测逻辑内存泄漏需要主观判断，特别是对象的生命周期并不清晰。幸运的是，Activity有着明确的<a href="https://developer.android.com/reference/android/app/Activity.html#ActivityLifecycle">生命周期</a>，很容易发现泄漏的原因。<a href="https://developer.android.com/reference/android/app/Activity.html#onDestroy()">Activity.onDestroy()</a>被视为<code>Activity</code>生命的结束，程序上来看，它应该被销毁了，或者Android系统需要回收这些内存（译者注：当内存不够时，Android会回收看不见的<code>Activity</code>）。<br>如果这个方法执行完，在堆栈中仍存在持有该Activity的强引用，垃圾回收器就无法把它标记成已回收的内存，而我们本来目的就是要回收它！<br>结果就是<code>Activity</code>存活在它的生命周期之外。</p><p><code>Activity</code>是重量级对象，应该让Android系统来处理它。然而，逻辑内存泄漏总是在不经意间发生。（译者注：曾经试过一个Activity导致20M内存泄漏）。在Android中，导致潜在内存泄漏的陷阱不外乎两种：</p><ul><li>全局进程(process-global)的static变量。这个无视应用的状态，持有Activity的强引用的怪物。</li><li>活在Activity生命周期之外的线程。没有清空对Activity的强引用。</li></ul><p>检查一下你有没有遇到下列的情况。</p><h1 id="Static-Activities"><a href="#Static-Activities" class="headerlink" title="Static Activities"></a>Static Activities</h1><p>在类中定义了静态<code>Activity</code>变量，把当前运行的<code>Activity</code>实例赋值于这个静态变量。<br>如果这个静态变量在<code>Activity</code>生命周期结束后没有清空，就导致内存泄漏。因为static变量是贯穿这个应用的生命周期的，所以被泄漏的<code>Activity</code>就会一直存在于应用的进程中，不会被垃圾回收器回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Activity activity;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setStaticActivity</span><span class="params">()</span> &#123;</span><br><span class="line">    activity = <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">View</span> <span class="variable">saButton</span> <span class="operator">=</span> findViewById(R.id.sa_button);</span><br><span class="line">  saButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">      setStaticActivity();</span><br><span class="line">      nextActivity();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a0feb907c.png" alt="Memory Leak 1 - Static Activity"></p><h1 id="Static-Views"><a href="#Static-Views" class="headerlink" title="Static Views"></a>Static Views</h1><p>类似的情况会发生在单例模式中，如果<code>Activity</code>经常被用到，那么在内存中保存一个实例是很实用的。正如之前所述，强制延长<code>Activity</code>的生命周期是相当危险而且不必要的，无论如何都不能这样做。</p><p>特殊情况：如果一个View初始化耗费大量资源，而且在一个<code>Activity</code>生命周期内保持不变，那可以把它变成static，加载到视图树上(View Hierachy)，<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L132">像这样</a>，当<code>Activity</code>被销毁时，应当释放资源。（译者注：示例代码中并没有释放内存，把这个static view置null即可，但是还是不建议用这个static view的方法）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> view;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setStaticView</span><span class="params">()</span> &#123;</span><br><span class="line">     view = findViewById(R.id.sv_button);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">View</span> <span class="variable">svButton</span> <span class="operator">=</span> findViewById(R.id.sv_button);</span><br><span class="line">   svButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">       setStaticView();</span><br><span class="line">       nextActivity();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a28acb265.png" alt="Memory Leak 2 - Static View"></p><h1 id="Inner-Classes"><a href="#Inner-Classes" class="headerlink" title="Inner Classes"></a>Inner Classes</h1><p>继续，假设<code>Activity</code>中有个<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L126">内部类</a>，这样做可以提高可读性和封装性。将如我们创建一个内部类，而且持有一个静态变量的引用，恭喜，内存泄漏就离你不远了（译者注：销毁的时候置空，嗯）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object inner;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">createInnerClass</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">class</span> <span class="title class_">InnerClass</span> &#123;</span><br><span class="line">       &#125;</span><br><span class="line">       inner = <span class="keyword">new</span> <span class="title class_">InnerClass</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">View</span> <span class="variable">icButton</span> <span class="operator">=</span> findViewById(R.id.ic_button);</span><br><span class="line">   icButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">       <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">           createInnerClass();</span><br><span class="line">           nextActivity();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a3827f856.png" alt="Memory Leak 3 - Inner Class"></p><p>内部类的优势之一就是可以访问外部类，不幸的是，导致内存泄漏的原因，就是内部类持有外部类实例的强引用。</p><h1 id="Anonymous-Classes"><a href="#Anonymous-Classes" class="headerlink" title="Anonymous Classes"></a>Anonymous Classes</h1><p>相似地，匿名类也维护了外部类的引用。所以内存泄漏很容易发生，<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L102">当你在<code>Activity</code>中定义了匿名的<code>AsyncTask</code></a><br>。当异步任务在后台执行耗时任务期间，<code>Activity</code>不幸被销毁了（译者注：用户退出，系统回收），这个被<code>AsyncTask</code>持有的<code>Activity</code>实例就不会被垃圾回收器回收，直到异步任务结束。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">startAsyncTask</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span> <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">              <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;.execute();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">  setContentView(R.layout.activity_main);</span><br><span class="line">  <span class="type">View</span> <span class="variable">aicButton</span> <span class="operator">=</span> findViewById(R.id.at_button);</span><br><span class="line">  aicButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">          startAsyncTask();</span><br><span class="line">          nextActivity();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a4bd45062.png" alt="Memory Leak 4 - AsyncTask"></p><h1 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h1><p>同样道理，<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L114">定义匿名的<code>Runnable</code>，用匿名类<code>Handler</code>执行</a>。<code>Runnable</code>内部类会持有外部类的隐式引用，被传递到<code>Handler</code>的消息队列<code>MessageQueue</code>中，在<code>Message</code>消息没有被处理之前，<code>Activity</code>实例不会被销毁了，于是导致内存泄漏。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">createHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.handleMessage(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">View</span> <span class="variable">hButton</span> <span class="operator">=</span> findViewById(R.id.h_button);</span><br><span class="line">    hButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">            createHandler();</span><br><span class="line">            nextActivity();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a5ab1f03e.png" alt="Memory Leak 5 - Handler"></p><h1 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h1><p>我们再次通过<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L142">Thread</a>和<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L150">TimerTask</a>来展现内存泄漏。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">spawnThread</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">          <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">              <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">View</span> <span class="variable">tButton</span> <span class="operator">=</span> findViewById(R.id.t_button);</span><br><span class="line">  tButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        spawnThread();</span><br><span class="line">        nextActivity();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a695b7543.png" alt="Memory Leak 6 - Thread"></p><h1 id="TimerTask"><a href="#TimerTask" class="headerlink" title="TimerTask"></a>TimerTask</h1><p>只要是匿名类的实例，不管是不是在工作线程，都会持有<code>Activity</code>的引用，导致内存泄漏。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTimer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, Long.MAX_VALUE &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">View</span> <span class="variable">ttButton</span> <span class="operator">=</span> findViewById(R.id.tt_button);</span><br><span class="line">    ttButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">            scheduleTimer();</span><br><span class="line">            nextActivity();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a70924397.png" alt="Memory Leak 7 - TimerTask"></p><h1 id="Sensor-Manager"><a href="#Sensor-Manager" class="headerlink" title="Sensor Manager"></a>Sensor Manager</h1><p>最后，通过<a href="https://developer.android.com/reference/android/content/Context.html#getSystemService(java.lang.String)">Context.getSystemService(int name)</a>可以获取系统服务。这些服务工作在各自的进程中，帮助应用处理后台任务，处理硬件交互。如果需要使用这些服务，可以注册<a href="https://github.com/NimbleDroid/Memory-Leaks/blob/master/app/src/main/java/com/nimbledroid/memoryleaks/MainActivity.java#L136">监听器</a>，这会导致服务持有了<code>Context</code>的引用，如果在<code>Activity</code>销毁的时候没有注销这些监听器，会导致内存泄漏。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">()</span> &#123;</span><br><span class="line">              <span class="type">SensorManager</span> <span class="variable">sensorManager</span> <span class="operator">=</span> (SensorManager) getSystemService(SENSOR_SERVICE);</span><br><span class="line">              <span class="type">Sensor</span> <span class="variable">sensor</span> <span class="operator">=</span> sensorManager.getDefaultSensor(Sensor.TYPE_ALL);</span><br><span class="line">              sensorManager.registerListener(<span class="built_in">this</span>, sensor, SensorManager.SENSOR_DELAY_FASTEST);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">View</span> <span class="variable">smButton</span> <span class="operator">=</span> findViewById(R.id.sm_button);</span><br><span class="line">       smButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">               registerListener();</span><br><span class="line">               nextActivity();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/02/26/5c74a7d1725c1.png" alt="Memory Leak 8 - Sensor Manager"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>看过那么多会导致内存泄漏的例子，容易导致吃光手机的内存使垃圾回收处理更为频发，甚至最坏的情况会导致OOM。垃圾回收的操作是很昂贵的开销，会导致肉眼可见的卡顿。所以，实例化的时候注意持有的引用链，并经常进行内存泄漏检查。</p><p>（译者注：本文没有提及比较通用的解决方法，<a href="https://xmaihh.github.io/2019/02/26/%E8%AF%91%E6%96%87-Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9A%84%E5%85%AB%E7%A7%8D%E5%AF%B9%E5%BA%94%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95-%E4%B8%8B/">具体可以参考这篇文章，静态内部类解脱你的烦恼</a>）</p><p>祝好运。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://blog.nimbledroid.com/2016/05/23/memory-leaks.html">http://blog.nimbledroid.com/2016/05/23/memory-leaks.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fragment异常：android.view.InflateException: Binary XML file line #7: Error inflating class fragment</title>
      <link href="/blog/2019/02/22/fragment-yi-chang-android-view-inflateexception-binary-xml-file-line-7-error-inflating-class-fragment/"/>
      <url>/blog/2019/02/22/fragment-yi-chang-android-view-inflateexception-binary-xml-file-line-7-error-inflating-class-fragment/</url>
      
        <content type="html"><![CDATA[<p>fragment是个很好的控件，但今天在静态使用fragment的时候，遇到个问题，错误信息如下:</p><h1 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h1><p>Caused by: android.view.InflateException: Binary XML file line #7: Error inflating class fragment</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;#80434343&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragment_float_window&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.xmaihh.example.ui.fragment.FloatWindowFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><ul><li><p>1.xml布局中，fragment未设置id</p></li><li><p>2.嵌入的Activity要继承于FragmentActivity ，而不是Activity</p></li><li><p>3.xml中引入的包名不对,注意检查<br> <code>android:name=&quot;com.xmaihh.example.ui.fragment.FloatWindowFragment&quot;</code></p></li><li><p>4.还有种可能就是你Fragment引入的包名不对，v4包下的还是系统的Fragment要统一好 注意<code>android.support.v4.app.FragmentActivity</code>和<code>android.app.Fragment</code>区别</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android logcat命令详解</title>
      <link href="/blog/2019/02/21/android-logcat-ming-ling-xiang-jie/"/>
      <url>/blog/2019/02/21/android-logcat-ming-ling-xiang-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="Android-Log系统"><a href="#Android-Log系统" class="headerlink" title="Android Log系统"></a>Android Log系统</h1><p>Android提供了一个灵活的logging系统，允许应用程序和系统组件等整个系统记录logging信息，它是独立于Linux Kernel的一个logging系统，kernel是通过<code>pr_info</code>、<code>printk</code>等存储，通过<code>dmesg</code>或<code>cat /proc/kmsg</code>获取。不过，Android logging 系统也是将信息存在内核缓存区。其结构如下：<br><img src="https://i.loli.net/2019/02/21/5c6e43fee4322.png"></p><p>Logging system由如下几部分组成：</p><ul><li>实现loging信息存储的kernel驱动和缓存区</li><li>C，C++和Java 类添加与读取log</li><li>一个单独浏览log信息的程序（logcat）</li><li>能够查看和过滤来自主机的log信息（通过Android Studio 或者 DDMS）</li></ul><h1 id="Android-logcat介绍"><a href="#Android-logcat介绍" class="headerlink" title="Android logcat介绍"></a>Android logcat介绍</h1><p>logcat是android中的一个命令行工具，可以用于得到程序的log信息</p><h2 id="android-util-Log"><a href="#android-util-Log" class="headerlink" title="android.util.Log"></a><a href="https://developer.android.com/reference/android/util/Log">android.util.Log</a></h2><p>通常，我们使用android.util.Log类来打印日志消息，通过Logcat来查看打印的日志<br>Log类提供的方法，优先级按照从高到低的顺序如下:</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>Log.e(String,String)(error)</td><td>显示错误信息</td></tr><tr><td>Log.w(String,String)(waning)</td><td>显示警告信息</td></tr><tr><td>Log.i(String,String)(information)</td><td>显示一般信息</td></tr><tr><td>Log.d(String,String)(debug)</td><td>显示调试信息</td></tr><tr><td>Log.v(String,String) (vervbose)</td><td>显示全部信息</td></tr></tbody></table><p>e.g.</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过代码打印log</span></span><br><span class="line"><span class="keyword">Log</span>.<span class="built_in">d</span>(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;LogCollectorThread is create&quot;</span>);</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line"><span class="comment">// adb获取log</span></span><br><span class="line"><span class="keyword">shell</span>@android:/$ adb logcat</span><br></pre></td></tr></table></figure><p>adb logcat 输出的日志:</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D/:MainActivity: LogCollectorThread <span class="keyword">is</span> <span class="keyword">create</span></span><br></pre></td></tr></table></figure><h2 id="logcat缓冲区"><a href="#logcat缓冲区" class="headerlink" title="logcat缓冲区"></a>logcat缓冲区</h2><h3 id="缓冲区介绍"><a href="#缓冲区介绍" class="headerlink" title="缓冲区介绍"></a>缓冲区介绍</h3><p>android log输出量巨大，特别是通信系统的log，因此，android把log输出到不同的缓冲区中，目前定义了四个log缓冲区：</p><ol><li>Radio：输出通信系统的log</li><li>System：输出系统组件的log</li><li>Event：输出event模块的log</li><li>Main：所有java层的log，遗迹不属于上面3层的log<br>缓冲区主要给系统组件使用，一般的应用不需要关心，应用的log都输出到main缓冲区中<br>默认log输出（不指定缓冲区的情况下）是输出System和Main缓冲区的log</li></ol><h3 id="缓冲区模型"><a href="#缓冲区模型" class="headerlink" title="缓冲区模型"></a>缓冲区模型</h3><p><img src="https://i.loli.net/2019/02/21/5c6e4e93a1230.png"></p><h3 id="获取缓冲区命令"><a href="#获取缓冲区命令" class="headerlink" title="获取缓冲区命令"></a>获取缓冲区命令</h3><table><thead><tr><th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>描述</th></tr></thead><tbody><tr><td><code>-b&lt;buffer&gt;</code></td><td>加载一个可使用的日志缓冲区提供查看，默认值是<code>main</code></td></tr></tbody></table><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adb logcat –<span class="selector-tag">b</span> radio</span><br><span class="line"></span><br><span class="line">adb logcat –<span class="selector-tag">b</span> system</span><br><span class="line"></span><br><span class="line">adb logcat –<span class="selector-tag">b</span> events</span><br><span class="line"></span><br><span class="line">adb logcat –<span class="selector-tag">b</span> <span class="selector-tag">main</span></span><br></pre></td></tr></table></figure><h2 id="logcat命令参数"><a href="#logcat命令参数" class="headerlink" title="logcat命令参数"></a>logcat命令参数</h2><h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><table><thead><tr><th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>描述</th></tr></thead><tbody><tr><td><code>-b &lt;buffer&gt;</code></td><td>加载一个可使用的日志缓冲区供查看，比如event和radio。默认值是main  具体查看<a href="https://developer.android.com/studio/command-line/logcat#alternativeBuffers">Viewing Alternative Log Buffers</a>.</td></tr><tr><td><code>-c</code></td><td>清除缓冲区中的全部日志并退出（清除完后可以使用-g查看缓冲区）</td></tr><tr><td><code>-d</code></td><td>将缓冲区的log转存到屏幕中然后退出</td></tr><tr><td><code>-f &lt;filename&gt;</code></td><td>将log输出到指定的文件中&lt;文件名&gt;.默认为标准输出（stdout）</td></tr><tr><td><code>-g</code></td><td>打印日志缓冲区的大小并退出</td></tr><tr><td><code>-n &lt;count&gt;</code></td><td>设置日志的最大数目<code>&lt;count&gt;</code>，默认值是4，需要和<code>-r</code>选项一起使用</td></tr><tr><td><code>-r &lt;kbytes&gt;</code></td><td>没<code>&lt;kbytes&gt;</code>时输出日志，默认值是16，需要和<code>-f</code>选项一起使用</td></tr><tr><td><code>-s</code></td><td>设置过滤器</td></tr><tr><td><code>-v &lt;format&gt;</code></td><td>设置输出格式的日志消息。默认是短暂的格式。支持的格式列表 参看<a href="https://developer.android.com/studio/command-line/logcat#outputFormat">Controlling Log Output Format</a></td></tr></tbody></table><h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将缓冲区的log打印到屏幕并退出</span></span><br><span class="line">adb logcat -d </span><br><span class="line"><span class="comment">//清除缓冲区log（testCase运行前可以先清除一下）</span></span><br><span class="line">adb logcat -c</span><br><span class="line"><span class="comment">//打印缓冲区大小并退出</span></span><br><span class="line">adb logcat -<span class="selector-tag">g</span></span><br><span class="line"><span class="comment">//输出log</span></span><br><span class="line">adb logcat -f /sdcard/log<span class="selector-class">.txt</span> -n <span class="number">10</span> -<span class="attribute">r</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="logcat格式化输出"><a href="#logcat格式化输出" class="headerlink" title="logcat格式化输出"></a>logcat格式化输出</h2><p>日志消息包含一个元数据字段，除了标签和优先级，您可以修改输出显示一个特定的元数据字段格式的消息。为此，您使用-v选项来指定一个支持的输出格式。一下为支持的格式：</p><table><thead><tr><th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;格式&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th><th>说明</th></tr></thead><tbody><tr><td><code>brief</code></td><td>显示优先级&#x2F;标记和过程的PID发出的消息（默认格式）</td></tr><tr><td><code>process</code></td><td>只显示PID</td></tr><tr><td><code>tag</code></td><td>只显示优先级&#x2F;标记</td></tr><tr><td><code>raw</code></td><td>显示原始的日志消息，没有其他元数据字段</td></tr><tr><td><code>time</code></td><td>调用显示日期、时间、优先级&#x2F;标签和过程的PID发出消息</td></tr><tr><td><code>threadtime</code></td><td>调用显示日期、时间、优先级、标签遗迹PID TID线程发出的消息</td></tr><tr><td><code>long</code></td><td>显示所有元数据字段与空白行和单独的消息</td></tr></tbody></table><p>当logcat开始，指定想要输出格式<code>-v</code>选项：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[adb]</span> logcat <span class="selector-attr">[-v &lt;format&gt;]</span></span><br><span class="line">adb logcat –v thread</span><br></pre></td></tr></table></figure><blockquote><p>只能指定一个输出格式<code>-v</code></p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h2><p><img src="https://i.loli.net/2019/02/21/5c6e571e84ea1.png"></p><h1 id="logcat优先级"><a href="#logcat优先级" class="headerlink" title="logcat优先级"></a>logcat优先级</h1><p>优先级使用字符标识，一下优先级从低到高:</p><ul><li>V –Verbose(最低优先级)</li><li>D – Debug</li><li>I – Info</li><li>W – Warning</li><li>E – Error</li><li>F – Fatal</li><li>S – Silent</li></ul><p>为了减少不想要日志的输出，可以建立一个过滤器<br>过滤语法：<code>tag：priority</code></p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">//</span> 过滤<span class="variable">TAG</span>为<span class="variable">ActivityManager</span>输出级别大于<span class="built_in">I</span>的日志与<span class="variable">TAG</span>为<span class="variable">MyApp</span>输出级别大于<span class="built_in">D</span>的日志</span><br><span class="line"></span><br><span class="line"><span class="variable">adb</span> <span class="variable">logcat</span> <span class="variable">ActivityManager</span><span class="operator">:</span><span class="built_in">I</span>  <span class="variable">My</span> <span class="variable">App</span><span class="operator">:</span><span class="built_in">D</span> <span class="operator">*:</span><span class="variable">S</span></span><br><span class="line"></span><br><span class="line"> <span class="operator">...</span></span><br><span class="line"><span class="operator">//</span> 设置过滤级别为<span class="variable">W</span>以上</span><br><span class="line"><span class="variable">adb</span> <span class="variable">logcat</span> <span class="operator">*:</span><span class="variable">W</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://elinux.org/Android_Logging_System">https://elinux.org/Android_Logging_System</a><br><a href="https://developer.android.com/studio/command-line/logcat">https://developer.android.com/studio/command-line/logcat</a><br><a href="https://www.cnblogs.com/JianXu/p/5468839.html">https://www.cnblogs.com/JianXu/p/5468839.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Logcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>定制开关保存LOGCAT和KMSG日志输出到文件</title>
      <link href="/blog/2019/02/20/ding-zhi-kai-guan-bao-cun-logcat-he-kmsg-ri-zhi-shu-chu-dao-wen-jian/"/>
      <url>/blog/2019/02/20/ding-zhi-kai-guan-bao-cun-logcat-he-kmsg-ri-zhi-shu-chu-dao-wen-jian/</url>
      
        <content type="html"><![CDATA[<p>在 “设置” 应用中的开发者选项添加一个开关 保存Logcat和KMSG日志</p><h1 id="添加te文件"><a href="#添加te文件" class="headerlink" title="添加te文件"></a>添加te文件</h1><p>由于SELinux的原因,需要在sepolicy下添加catlot.te</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">type</span> catlog, domain;</span><br><span class="line"><span class="attribute">type</span> catlog_exec, exec_type, file_type;</span><br><span class="line"></span><br><span class="line"><span class="attribute">allow</span> init catlog_exec:file &#123; <span class="attribute">execute</span> getattr read open &#125;;</span><br><span class="line"><span class="attribute">allow</span> init catlog:process &#123; <span class="attribute">transition</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> init catlog:process &#123; <span class="attribute">rlimitinh</span> siginh noatsecure &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog kernel:system &#123; <span class="attribute">syslog_mod</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog catlog:capability &#123; <span class="attribute">dac_override</span> sys_nice &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog catlog:capability2 &#123; <span class="attribute">syslog</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog catlog_exec:file &#123; <span class="attribute">execute</span> entrypoint read open &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog shell_exec:file &#123; <span class="attribute">getattr</span> read &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog rootfs:lnk_file &#123; <span class="attribute">getattr</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog proc:file &#123; <span class="attribute">write</span> open read &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog tmpfs:lnk_file &#123; <span class="attribute">read</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog storage_file:dir &#123; <span class="attribute">search</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog storage_file:lnk_file &#123; <span class="attribute">read</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog mnt_user_file:dir &#123; <span class="attribute">search</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog mnt_user_file:lnk_file &#123; <span class="attribute">read</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog fuse:dir &#123; <span class="attribute">search</span> getattr create write read open add_name rename remove_name &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog fuse:file &#123; <span class="attribute">getattr</span> create write open rename append &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog toolbox_exec:file &#123; <span class="attribute">execute</span> read open getattr execute_no_trans &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog logdr_socket:sock_file &#123; <span class="attribute">write</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog logd:unix_stream_socket &#123; <span class="attribute">connectto</span> &#125;;</span><br><span class="line"><span class="attribute">allow</span> catlog logcat_exec:file &#123; <span class="attribute">execute</span> read open execute_no_trans getattr &#125;;</span><br></pre></td></tr></table></figure><h1 id="添加cat-log-sh脚本"><a href="#添加cat-log-sh脚本" class="headerlink" title="添加cat_log.sh脚本"></a>添加<code>cat_log.sh</code>脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/system/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在init.rc下加入如下语句</span></span><br><span class="line"><span class="comment"># service  catlog /system/bin/busybox  sh  /system/bin/cat_log.sh</span></span><br><span class="line"><span class="comment">#     disabled</span></span><br><span class="line"><span class="comment">#     oneshot</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># on property:sys.boot_completed=1</span></span><br><span class="line"><span class="comment">#   start catlog</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">enable_log</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">       LOG_FILE=<span class="string">&quot;/data/tool.log&quot;</span></span><br><span class="line"></span><br><span class="line">       <span class="built_in">exec</span> 2&gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">       <span class="built_in">exec</span> 1&gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;----------------------------------&quot;</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;para: $*&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enable_log $* ; <span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/panic</span><br><span class="line"></span><br><span class="line"><span class="comment">#命名文件夹名字e5_log,也可以自己更改</span></span><br><span class="line">ENABLE_LOG_FILE=<span class="string">&quot;/mnt/sdcard/.enable_logsave&quot;</span></span><br><span class="line">LOG_DIR=<span class="string">&quot;/mnt/sdcard/LOGSAVE&quot;</span></span><br><span class="line">LAST_LOG_DIR=<span class="string">&quot;/mnt/sdcard/LOGSAVE/last&quot;</span></span><br><span class="line">SAVE_LOG_COUNT=5   <span class="comment"># 保存上5次的log，值最小为1;例为5,则last.1为最后一次重启前的log；last.5为最老的log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo “save last_time  $&#123;SAVE_LOG_COUNT&#125; log”</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#if [ ! -f &quot;$ENABLE_LOG_FILE&quot; ];then                     </span></span><br><span class="line"><span class="comment">#   echo &quot;disable logsave&quot;                    </span></span><br><span class="line"><span class="comment">#   exit                                                 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fi </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo &quot;enable logsave&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$LOG_DIR</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">mkdir</span> <span class="variable">$LOG_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [  -d <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$SAVE_LOG_COUNT</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">rm</span> -r <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$SAVE_LOG_COUNT</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#for((i= $&#123;SAVE_LOG_COUNT&#125;-1; $i &gt;= 1 ;i--));do</span></span><br><span class="line"><span class="comment">#for i in  $(seq  `expr $SAVE_LOG_COUNT - 1`  -1 1)</span></span><br><span class="line">i=$((SAVE_LOG_COUNT -<span class="number">1</span>))</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -ge 1 ]</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">        <span class="keyword">if</span> [  -d <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$i</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">               <span class="comment">#echo &quot;$LAST_LOG_DIR.$i is exists &quot;</span></span><br><span class="line">               <span class="keyword">if</span> [ <span class="string">&quot;`ls -a <span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$i</span>`&quot;</span> = <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                       <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$i</span> is indeed empty&quot;</span></span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$i</span> is not empty&quot;</span></span><br><span class="line">                       <span class="comment">#j=`expr $i + 1`</span></span><br><span class="line">                       j=$((<span class="variable">$i</span>+<span class="number">1</span>)) </span><br><span class="line">                       <span class="built_in">mv</span>  <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$i</span>&quot;</span>  <span class="string">&quot;<span class="variable">$LAST_LOG_DIR</span>.<span class="variable">$j</span>&quot;</span></span><br><span class="line">               <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">#else</span></span><br><span class="line">               <span class="comment">#echo &quot;$LAST_LOG_DIR.$i isnot exists&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        i=$((<span class="variable">$i</span>-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建上一次日志保存目录</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$LAST_LOG_DIR</span>.<span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存上次开机之后的log</span></span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$LOG_DIR</span>/*.<span class="built_in">log</span> <span class="variable">$LAST_LOG_DIR</span>.<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$LOG_DIR</span>/*.<span class="built_in">log</span>* <span class="variable">$LAST_LOG_DIR</span>.<span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d%H%M)</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /sys/fs/pstore/console-ramoops<span class="string">&quot;-0&quot;</span> &gt; <span class="variable">$LOG_DIR</span>/<span class="string">&quot;<span class="variable">$DATE</span>&quot;</span>_panic_kmsg.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;------start kmsg log------&quot;</span></span><br><span class="line"><span class="built_in">cat</span> /proc/kmsg &gt; <span class="variable">$LOG_DIR</span>/<span class="string">&quot;<span class="variable">$DATE</span>&quot;</span>_kmsg.<span class="built_in">log</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;------start logcat log------&quot;</span></span><br><span class="line">logcat -v time -n 1 -f <span class="variable">$LOG_DIR</span>/<span class="string">&quot;<span class="variable">$DATE</span>&quot;</span>_logcat.<span class="built_in">log</span> -r10240 </span><br></pre></td></tr></table></figure><h1 id="拷贝脚本到system-bin"><a href="#拷贝脚本到system-bin" class="headerlink" title="拷贝脚本到system/bin"></a>拷贝脚本到<code>system/bin</code></h1><p>在mk文件添加</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_COPY_FILES +=$(CUR_PATH)/cat_log.<span class="keyword">sh</span>:<span class="built_in">system</span>/bin/cat_log.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><h1 id="property-service里赋予权限"><a href="#property-service里赋予权限" class="headerlink" title="property_service里赋予权限"></a><code>property_service</code>里赋予权限</h1><p>在property_service.cpp 的检查权限check_mac_perms函数中添加</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;persist.sys.cat_log&quot;</span>,name) == <span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1 id="init-rc里声明服务"><a href="#init-rc里声明服务" class="headerlink" title="init.*.rc里声明服务"></a><code>init.*.rc</code>里声明服务</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#catlog</span></span><br><span class="line">service catlog /system/bin/cat_log.sh</span><br><span class="line">    seclabel u:r:catlog:s0</span><br><span class="line">    disabled</span><br><span class="line">    oneshot</span><br><span class="line"></span><br><span class="line">on <span class="keyword">property</span><span class="title"></span>:persist.sys.<span class="attr">cat_log=</span><span class="number">1</span></span><br><span class="line">     <span class="literal">start</span> catlog</span><br><span class="line"></span><br><span class="line">on <span class="keyword">property</span><span class="title"></span>:persist.sys.<span class="attr">cat_log=</span><span class="number">0</span></span><br><span class="line">     <span class="literal">stop</span> catlog</span><br></pre></td></tr></table></figure><blockquote><p>其中的seclabel就是SELinux要用到的标志</p></blockquote><h1 id="开发者选项中添加一个SwitchPreference组件"><a href="#开发者选项中添加一个SwitchPreference组件" class="headerlink" title="开发者选项中添加一个SwitchPreference组件"></a>开发者选项中添加一个SwitchPreference组件</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;SwitchPreference</span><br><span class="line">    android:<span class="attribute">key</span>=<span class="string">&quot;logcat_enable&quot;</span></span><br><span class="line">    android:<span class="attribute">title</span>=<span class="string">&quot;@string/logcat_enable&quot;</span></span><br><span class="line">    android:<span class="attribute">summary</span>=<span class="string">&quot;@string/logcat_summary&quot;</span></span><br><span class="line">    android:<span class="attribute">fragment</span>=<span class="string">&quot;com.android.tv.settings.system.development.AdbDialog&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><h1 id="添加开关控制逻辑"><a href="#添加开关控制逻辑" class="headerlink" title="添加开关控制逻辑"></a>添加开关控制逻辑</h1><p>在DevelopmentFragment.java的onPreferenceTreeClick里添加相关逻辑</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span>(preference == mLogcatPreference)&#123;</span><br><span class="line">            if (mLogcatPreference.isChecked())&#123;</span><br><span class="line">                <span class="built_in">writeLogcatEnableOptions</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="built_in">setLogcatEnable</span>(getPreferenceManager()<span class="selector-class">.getContext</span>(), <span class="number">1</span>);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                <span class="built_in">writeLogcatEnableOptions</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="built_in">setLogcatEnable</span>(getPreferenceManager()<span class="selector-class">.getContext</span>(), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h1 id="开机时初始化状态"><a href="#开机时初始化状态" class="headerlink" title="开机时初始化状态"></a>开机时初始化状态</h1><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> action = intent.getAction();</span><br><span class="line">            <span class="keyword">if</span> (action.<span class="keyword">equals</span>(Intent.ACTION_BOOT_COMPLETED)) &#123;</span><br><span class="line">                SharedPreferences sharedPreferences = context</span><br><span class="line">                        .getSharedPreferences(<span class="string">&quot;TvSetting&quot;</span>, Context.MODE_PRIVATE);</span><br><span class="line">                <span class="built_in">boolean</span> enable_log_save = sharedPreferences.getBoolean(</span><br><span class="line">                        <span class="string">&quot;enable_log_save&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">                <span class="built_in">String</span> persist_sys_cat_log = SystemProperties.get(<span class="string">&quot;persist.sys.cat_log&quot;</span>);</span><br><span class="line">                <span class="keyword">Log</span>.i(<span class="string">&quot;BootReceiver&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;action==ACTION_BOOT_COMPLETED,BootReceiver is start&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (persist_sys_cat_log.<span class="keyword">equals</span>(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                    SystemProperties.<span class="built_in">set</span>(<span class="string">&quot;persist.sys.cat_log&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>编译运行，打开开关，可以看到LOG保存到了sdcard&#x2F;LOGSAVE目录下面。</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Debian/Ubuntu时区和自动较时设置</title>
      <link href="/blog/2019/01/17/debian-ubuntu-shi-qu-he-zi-dong-jiao-shi-she-zhi/"/>
      <url>/blog/2019/01/17/debian-ubuntu-shi-qu-he-zi-dong-jiao-shi-she-zhi/</url>
      
        <content type="html"><![CDATA[<p>NTP 是通过网络自动校时的一种 TCP&#x2F;IP 协议。Debian&#x2F;Ubuntu 中有两种方式实现时间同步：ntpdate 和 ntpd，前者为一天调整一次时间，后者 ntpd 为守护进程，可以持续不断地调整时间。个人推荐使用 ntpd，它实际占用资源是很小的。</p><h1 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h1><p>使用 tzconfig 或 tzselect 工具来设置时区</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>tzselect</span><br></pre></td></tr></table></figure><p>选你要设置的时区,比如 Asia&#x2F;China&#x2F;Beijing</p><p>然后执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &gt;&gt;~/.profile&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">TZ=&#x27;Asia/Beijing&#x27;; export TZ</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>最后执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /etc/localtime</span><br><span class="line"><span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Beijing /etc/localtime</span><br></pre></td></tr></table></figure><h1 id="设置时间同步服务器"><a href="#设置时间同步服务器" class="headerlink" title="设置时间同步服务器"></a>设置时间同步服务器</h1><h2 id="方法一：ntpdate-方式"><a href="#方法一：ntpdate-方式" class="headerlink" title="方法一：ntpdate 方式"></a>方法一：ntpdate 方式</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -<span class="attribute">y</span> ntpdate #安装</span><br><span class="line">vim /etc/cron.daily/ntpdate #添加下面一行，每天同步。</span><br><span class="line">ntpdate ntp<span class="selector-class">.ubuntu</span><span class="selector-class">.com</span> cn<span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span></span><br><span class="line">chmod <span class="number">755</span> /etc/cron.daily/ntpdate #修改权限</span><br><span class="line">ntpdate -d cn<span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span> #立即同步时间</span><br></pre></td></tr></table></figure><h2 id="ntpd-方式"><a href="#ntpd-方式" class="headerlink" title="ntpd 方式"></a>ntpd 方式</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y ntpd <span class="comment">#安装</span></span><br><span class="line">vim <span class="regexp">/etc/</span>ntp.conf <span class="comment">#添加下面一行</span></span><br><span class="line">server cn.pool.ntp.org</span><br><span class="line"><span class="regexp">/etc/i</span>nit.d/ntp restart <span class="comment">#重启</span></span><br></pre></td></tr></table></figure><h2 id="以下适用于-debian"><a href="#以下适用于-debian" class="headerlink" title="以下适用于 debian"></a>以下适用于 debian</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -<span class="attribute">y</span> ntp</span><br><span class="line">vim /etc/ntp<span class="selector-class">.conf</span> #修改为下面几行</span><br><span class="line">server <span class="number">0</span><span class="selector-class">.debian</span><span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span> iburst dynamic</span><br><span class="line">server <span class="number">1</span><span class="selector-class">.debian</span><span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span> iburst dynamic</span><br><span class="line">server <span class="number">2</span><span class="selector-class">.debian</span><span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span> iburst dynamic</span><br><span class="line">server <span class="number">3</span><span class="selector-class">.debian</span><span class="selector-class">.pool</span><span class="selector-class">.ntp</span><span class="selector-class">.org</span> iburst dynamic</span><br><span class="line">/etc/init.d/ntp restart #重启</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Debian </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python3-UnicodeEncodeError:-&#39;ascii&#39;-codec-can&#39;t-encode-character-&#39;Ü&#39;-in-position-6:-ordinal-not-in-range(128)</title>
      <link href="/blog/2019/01/17/python3-unicodeencodeerror-ascii-codec-can-t-encode-character-xdc-in-position-6-ordinal-not-in-range-128/"/>
      <url>/blog/2019/01/17/python3-unicodeencodeerror-ascii-codec-can-t-encode-character-xdc-in-position-6-ordinal-not-in-range-128/</url>
      
        <content type="html"><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>每次我尝试运行我的程序时都会返回错误，并且我的程序可以在其他应用程序中运行</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Error:</span><br><span class="line"></span><br><span class="line">Traceback (most recent <span class="keyword">call</span> <span class="keyword">last</span>):</span><br><span class="line">File <span class="string">&quot;/sdcard/pythonP/ex95.py&quot;</span>, <span class="built_in">line</span> <span class="number">16</span>, in </span><br><span class="line">gols[<span class="keyword">f</span><span class="string">&quot;partida&#123;g&#125;&quot;</span>] = <span class="keyword">int</span>(<span class="built_in">input</span>(<span class="keyword">f</span><span class="comment">&quot;quantidade de gols na</span></span><br><span class="line">partida &#123;g&#125;\xaa: <span class="comment">&quot;))</span></span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;ascii&#x27;</span> codec can<span class="string">&#x27;t encode character &#x27;</span>\<span class="keyword">x</span></span><br><span class="line">aa<span class="string">&#x27; in position 31: ordinal not in range(128)</span></span><br></pre></td></tr></table></figure><p>正在尝试输出一个非ASCII字符的字符串。您是否尝试将LANG &#x3D; C.UTF-8预先添加到您的python命令中，看看是否有帮助（Do LANG&#x3D;C.UTF8 python3 your-script.py）？（至少ubuntu映像）似乎默认为Clocale，它只是ASCII。<br>Ubuntu rootfs中不正确配置的语言环境的结果（构建脚本引用了C语言环境，而C.UTF-8Unicode支持则需要）。设置此区域设置（例如，通过执行export LANG&#x3D;C.UTF-8）一切正常。<br>这也打破了一些其他的应用程序（例如，pipenv并且mosh拒绝非Unicode终端上运行）。</p><p>问题可以通过以下简单的python脚本重现：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃！/ usr / bin / <span class="built_in">env</span> python3 </span><br><span class="line"><span class="built_in">print</span>（ “ HalloÜmlaut！”）</span><br></pre></td></tr></table></figure><p>在Ubuntu上，这给了我以下错误</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@localhost:~$ <span class="keyword">python3</span> testcase.<span class="keyword">py</span></span><br><span class="line">Traceback (most recent <span class="keyword">call</span> <span class="keyword">last</span>):</span><br><span class="line">  File <span class="string">&quot;testcase.py&quot;</span>, <span class="built_in">line</span> <span class="number">2</span>, in <span class="symbol">&lt;module&gt;</span></span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&quot;Hallo \xdcmlaut!&quot;</span>)</span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;ascii&#x27;</span> codec can<span class="string">&#x27;t encode character &#x27;</span>\xdc<span class="string">&#x27; in position 6: ordinal not in range(128)</span></span><br></pre></td></tr></table></figure><h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> LANG = C.UTF-8</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 your-script.py</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用GPG加密Github Commits</title>
      <link href="/blog/2018/12/25/shi-yong-gpg-jia-mi-github-commits/"/>
      <url>/blog/2018/12/25/shi-yong-gpg-jia-mi-github-commits/</url>
      
        <content type="html"><![CDATA[<p><img src="https://i.loli.net/2018/12/25/5c218fc76d90d.png"><br>GnuPG（简称 GPG），它是目前最流行、最好用的开源加密工具之一。<br>GPG 有许多用途，比如对文件，邮件的加密。而本文要说的是，如何使用 GPG 来加密 Github Commits,从而保证提交的commit在传输的过程中没有被篡改。。<br>在 Github 上查看一些项目的 Commits 时，偶尔会发现「This commit was signed with a verified signature.」字样。</p><h1 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h1><p>git自带gpg命令,后续步骤直接在git bash里生成密匙。<br>Git官网 <a href="https://git-scm.com/">https://git-scm.com</a></p><h1 id="生成密匙"><a href="#生成密匙" class="headerlink" title="生成密匙"></a>生成密匙</h1><p>打开git bash,直接输入:</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="comment">--gen-key</span></span><br></pre></td></tr></table></figure><p>回车,提示信息如下:</p><figure class="highlight irpf90"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gpg (GnuPG) <span class="number">1.4</span><span class="number">.21</span>; Copyright (C) <span class="number">2015</span> <span class="keyword">Free</span> Software Foundation, Inc.</span><br><span class="line">This is <span class="keyword">free</span> software: you are <span class="keyword">free</span> to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">Please <span class="keyword">select</span> what <span class="keyword">kind</span> of key you want:</span><br><span class="line">   (<span class="number">1</span>) RSA and RSA (<span class="keyword">default</span>)</span><br><span class="line">   (<span class="number">2</span>) DSA and Elgamal</span><br><span class="line">   (<span class="number">3</span>) DSA (<span class="built_in">sign</span> <span class="keyword">only</span>)</span><br><span class="line">   (<span class="number">4</span>) RSA (<span class="built_in">sign</span> <span class="keyword">only</span>)</span><br><span class="line">Your selection?</span><br></pre></td></tr></table></figure><p>选择加密算法，默认选择第一个选项即可，表示加密和签名都使用 RSA 算法。<br>选 1，回车。<br>选择密钥长度，默认为 2048，建议输入 4096。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RSA keys may <span class="keyword">be </span><span class="keyword">between </span><span class="number">1024</span> <span class="keyword">and </span><span class="number">4096</span> <span class="keyword">bits </span>long.</span><br><span class="line">What keysize do you want? (<span class="number">2048</span>)</span><br></pre></td></tr></table></figure><p>输入 <code>4096</code>，回车。</p><p>设定密钥的有效期。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Please specify how <span class="type">long</span> the <span class="keyword">key</span> should be valid.</span><br><span class="line">         <span class="number">0</span> = <span class="keyword">key</span> does <span class="built_in">not</span> expire</span><br><span class="line">      &lt;n&gt;  = <span class="keyword">key</span> expires <span class="keyword">in</span> n days</span><br><span class="line">      &lt;n&gt;w = <span class="keyword">key</span> expires <span class="keyword">in</span> n weeks</span><br><span class="line">      &lt;n&gt;m = <span class="keyword">key</span> expires <span class="keyword">in</span> n months</span><br><span class="line">      &lt;n&gt;y = <span class="keyword">key</span> expires <span class="keyword">in</span> n years</span><br><span class="line"><span class="keyword">Key</span> <span class="built_in">is</span> valid <span class="keyword">for</span>? (<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>密钥只是个人使用的话，建议选择第一个选项，即永不过期。<br>输入 <code>0</code>，回车。</p><p>系统会问你上述设置是否正确。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Is <span class="keyword">this</span> correct? (y/N)</span><br></pre></td></tr></table></figure><p>输入 <code>y</code>，回车。</p><p>系统会要求你输入个人信息。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">You need a <span class="keyword">user</span> <span class="title">ID</span> to identify your key; the software constructs the <span class="keyword">user</span> <span class="title">ID</span></span><br><span class="line">from the Real Name, Comment <span class="keyword">and</span> Email Address <span class="keyword">in</span> this form:</span><br><span class="line">    <span class="string">&quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">Real name:</span><br></pre></td></tr></table></figure><p>「Real name」填入你的名字，需是英文。回车。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Email <span class="selector-tag">address</span>:</span><br></pre></td></tr></table></figure><p>「Email address」填入你的邮箱地址。回车。</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Comment:</span></span><br></pre></td></tr></table></figure><p>「Comment」可以空着不填。回车。<br>系统会再次让你确认填入的信息。</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">You</span> <span class="variable">selected</span> <span class="variable">this</span> <span class="variable">USER</span><span class="operator">-</span><span class="variable">ID</span><span class="operator">:</span></span><br><span class="line">    <span class="string">&quot;Teddysun &lt;i@teddysun.com&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">Change</span> <span class="punctuation">(</span><span class="built_in">N</span><span class="punctuation">)</span><span class="variable">ame</span><span class="operator">,</span> <span class="punctuation">(</span><span class="built_in">C</span><span class="punctuation">)</span><span class="variable">omment</span><span class="operator">,</span> <span class="punctuation">(</span><span class="built_in">E</span><span class="punctuation">)</span><span class="variable">mail</span> <span class="variable">or</span> <span class="punctuation">(</span><span class="built_in">O</span><span class="punctuation">)</span><span class="variable">kay</span><span class="operator">/</span><span class="punctuation">(</span><span class="variable">Q</span><span class="punctuation">)</span><span class="variable">uit</span><span class="operator">?</span></span><br></pre></td></tr></table></figure><p>输入 <code>O</code>，回车。<br>系统会让你设定一个私钥的密码。</p><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">You need a Passphrase <span class="keyword">to</span> protect your secret key.</span><br><span class="line">Enter passphrase:</span><br><span class="line"><span class="keyword">Repeat</span> passphrase:</span><br></pre></td></tr></table></figure><p>注意这里要留空不填，直接回车即可。这是因为 TortoiseGit 不支持 1.4.x 含有私钥密码。直接使用git bash的话不影响，可选择设置密码。<br>系统这时开始生成密钥，，这时会要求你做一些随机的举动，以生成一个随机数。你拿起鼠标随便晃晃，直到完成密钥生成。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">We need <span class="keyword">to</span> generate a lot <span class="keyword">of</span> random bytes. It <span class="keyword">is</span> a good idea <span class="keyword">to</span> <span class="keyword">perform</span></span><br><span class="line"><span class="keyword">some</span> other action (<span class="keyword">type</span> <span class="keyword">on</span> the keyboard, <span class="keyword">move</span> the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance <span class="keyword">to</span> gain enough entropy.</span><br></pre></td></tr></table></figure><p>最后，提示生成完毕。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg: key <span class="number">0</span>F136FEA marked <span class="keyword">as</span> ultimately <span class="keyword">trusted</span></span><br><span class="line"><span class="built_in">public</span> <span class="keyword">and</span> secret key created <span class="keyword">and</span> signed.</span><br></pre></td></tr></table></figure><h1 id="列出密钥"><a href="#列出密钥" class="headerlink" title="列出密钥"></a>列出密钥</h1><p>命令如下：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">gpg</span> <span class="literal">--</span><span class="comment">list</span><span class="literal">--</span><span class="comment">keys</span></span><br></pre></td></tr></table></figure><p>输出结果如下：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">/c/Users/Administrator/.gnupg/pubring.gpg</span></span><br><span class="line"><span class="section">-----------------------------------------</span></span><br><span class="line">pub   4096R/0F136FEA 2018-12-25</span><br><span class="line">uid                  xmaihh (xmaihh@protonmail.com) &lt;xmaihh@protonmail.com&gt;</span><br><span class="line">sub   4096R/13FA2C24 2018-12-25</span><br></pre></td></tr></table></figure><p>第一行显示公钥文件名（pubring.gpg）<br>第二行显示公钥特征（4096 位，Hash 字符串和生成时间）<br>第三行显示用户信息<br>第四行显示私钥特征</p><h1 id="输出密钥"><a href="#输出密钥" class="headerlink" title="输出密钥"></a>输出密钥</h1><p>公钥文件（.gnupg&#x2F;pubring.gpg）以二进制形式储存，armor 参数可以将其转换为 ASCII 码显示。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="attr">--armor</span> <span class="attr">--output</span> public-key<span class="selector-class">.txt</span> <span class="attr">--export</span> <span class="selector-attr">[密钥ID]</span></span><br></pre></td></tr></table></figure><p>[密钥ID]指定用户的公钥，如 <code>0F136FEA</code>，output 参数指定输出文件名，如 public-key.txt</p><p>同时，export-secret-keys 参数可以转换私钥。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="attr">--armor</span> <span class="attr">--output</span> private-key<span class="selector-class">.txt</span> <span class="attr">--export-secret-keys</span></span><br></pre></td></tr></table></figure><p>public-key.txt 和 private-key.txt 默认会导出至git bash 当前工作目录下。</p><h1 id="上传公钥至Github"><a href="#上传公钥至Github" class="headerlink" title="上传公钥至Github"></a>上传公钥至Github</h1><p>点击用户头像，打开 <code>Settings</code>，左侧菜单点击 <code>SSH and GPG keys</code>，在 <code>GPG keys</code> 那里，点击 <code>New GPG key</code>。<br>在输入框里填入刚刚导出的 <code>public-key.txt</code> 内容。<br>点击 <code>Add GPG key</code>，完成上传。</p><h1 id="设置git"><a href="#设置git" class="headerlink" title="设置git"></a>设置git</h1><p>回到 <code>Git Bash</code> 窗口，根据刚才 <code>gpg –list-keys</code> 显示的结果，此时已经知道密钥 ID 为 <code>0F136FEA</code><br>设置 Git 使用该密钥 ID 加密：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">config</span> <span class="comment">--global user.signingkey 0F136FEA</span></span><br></pre></td></tr></table></figure><p>设置 Git 全局使用该密钥加密：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global commit.gpgsign <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>最后，再输入以下命令查看 Git 配置情况：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config -l</span><br></pre></td></tr></table></figure><p>可以看到包含以下信息说明设置成功。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user.signingkey</span>=<span class="number">0</span>F136FEA</span><br><span class="line"><span class="attr">commit.gpgsign</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>至此，使用 <code>GPG</code> 加密 <code>Github Commits</code> 就正式完成了。<br>以后再 <code>Git Commit</code>，同步到 <code>Github</code> 上之后，就会发现该 <code>Commit</code> 已显示 <code>Verified</code>。</p><p>参考链接:<br><a href="https://teddysun.com/496.html">https://teddysun.com/496.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> Github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu16.04升级到18.04LTS记录</title>
      <link href="/blog/2018/12/21/ubuntu16-04-sheng-ji-dao-18-04lts-ji-lu/"/>
      <url>/blog/2018/12/21/ubuntu16-04-sheng-ji-dao-18-04lts-ji-lu/</url>
      
        <content type="html"><![CDATA[<h1 id="更新Ubuntu-16-04"><a href="#更新Ubuntu-16-04" class="headerlink" title="更新Ubuntu 16.04"></a>更新Ubuntu 16.04</h1><p>在升级之前，先更新当前的16.04至最新状态。建议升级之前更新&#x2F;升级所有已安装的软件包。</p><p>首先更新APT源和软件包至最新</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt dist-upgrade &amp;&amp; <span class="built_in">sudo</span> apt autoremove</span><br></pre></td></tr></table></figure><h1 id="安装和配置Ubuntu-update-manager"><a href="#安装和配置Ubuntu-update-manager" class="headerlink" title="安装和配置Ubuntu update manager"></a>安装和配置<code>Ubuntu update manager</code></h1><p>更新完组件后，运行以下命令安装<code>update-manager-core</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install update-manager-core</span><br></pre></td></tr></table></figure><p>打开<code>update-manager</code>配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/update-manager/release-upgrades</span><br></pre></td></tr></table></figure><blockquote><p>确保设置为Prompt&#x3D;lts</p></blockquote><h1 id="执行升级命令"><a href="#执行升级命令" class="headerlink" title="执行升级命令"></a>执行升级命令</h1><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">do</span>-release-upgrade -d</span><br></pre></td></tr></table></figure><p>出现升级提示时，全部选择y</p><p>等待所有的软件包下载…安装…到重启… </p><p>当所有操作执行完毕后，系统就升级到最新的Ubuntu 18.04 LTS版本了。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android获得点击屏幕的位置坐标</title>
      <link href="/blog/2018/12/17/android-huo-de-dian-ji-ping-mu-de-wei-zhi-zuo-biao/"/>
      <url>/blog/2018/12/17/android-huo-de-dian-ji-ping-mu-de-wei-zhi-zuo-biao/</url>
      
        <content type="html"><![CDATA[<h1 id="开发者选项获得点击屏幕的位置坐标"><a href="#开发者选项获得点击屏幕的位置坐标" class="headerlink" title="开发者选项获得点击屏幕的位置坐标"></a>开发者选项获得点击屏幕的位置坐标</h1><p>在手机开发者选项中,打开指针位置,可以在屏幕上方获取当前点击位置的坐标点(x,y)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">P:1/1  X:553  Y:1851  Xv:0:0  Yv:0:0 Prs:1.0  Size:0.13</span><br></pre></td></tr></table></figure> <img src="https://i.loli.net/2018/12/18/5c18b910782fd.jpg" width = "300" alt="Android开发者选项_指针位置" align=center /><p> 命令行窗口输入：<code>adb shell input tap 553 1851</code>实现点击效果</p><h1 id="通过adb-shell-getevent命令获得点击屏幕的位置坐标"><a href="#通过adb-shell-getevent命令获得点击屏幕的位置坐标" class="headerlink" title="通过adb shell getevent命令获得点击屏幕的位置坐标"></a>通过<code>adb shell getevent</code>命令获得点击屏幕的位置坐标</h1><ol><li>命令行窗口输入:<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getevent -p | grep -e &quot;0035&quot; -e &quot;0036&quot;</span><br></pre></td></tr></table></figure></li></ol><p>获得event 体系里 width宽（0035）和height高（0036）</p><p><img src="https://i.loli.net/2018/12/18/5c18bd9839f38.png"><br><img src="https://i.loli.net/2018/12/18/5c18bf79433b8.png"><br>2. 计算比例<br>用到其中的max值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0035（width） max 1024</span><br><span class="line">0036（height） max 600</span><br></pre></td></tr></table></figure><p>跟手机屏幕的分辨率比较，获取手机分辨率在命令行窗口输入:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm size </span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/12/18/5c18c406093bf.png"></p><p>即手机分辨率是: 1280(width) x 600(height)</p><p>计算比例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rateW = 1280(手机屏幕的宽) / 1024(event里0035的max) = 1.25</span><br><span class="line">rateH = 600(手机屏幕的高) / 600(event里0036的max) = 1</span><br></pre></td></tr></table></figure><ol start="3"><li>点击屏幕计算点击位置的坐标</li></ol><p>在命令行窗口输入:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getevent | grep -e &quot;0035&quot; -e &quot;0036&quot;</span><br></pre></td></tr></table></figure><blockquote><p>注意：这里的命令<code>adb shell getevent</code>不带<code>-p</code>参数</p></blockquote><p>例如,点击屏幕一个位置得到输出:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/input/event0: 0003 0035 00000280</span><br><span class="line">/dev/input/event0: 0003 0036 0000018c</span><br></pre></td></tr></table></figure><p>把0035和0036后面的位置数据从16进制转化为10进制</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">width = 0x280 = 2*16*16 + 8*16 = 640</span><br><span class="line">height = 0x8ec = 1*16*16 + 8*16 + 12 = 396</span><br></pre></td></tr></table></figure><p>这是在event体系里的位置，将其转化为屏幕位置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screenW = width*rateW = 640*1.25 = 800</span><br><span class="line">screenH = height*rateH = 396*1 = 396</span><br></pre></td></tr></table></figure><p>最终算出来了<br>刚刚点击的屏幕位置坐标就是（800, 396）</p><h1 id="代码TouchEvent里面的位置直接就是你在屏幕上的点击位置"><a href="#代码TouchEvent里面的位置直接就是你在屏幕上的点击位置" class="headerlink" title="代码TouchEvent里面的位置直接就是你在屏幕上的点击位置"></a>代码TouchEvent里面的位置直接就是你在屏幕上的点击位置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    ACTION_DOWN:用户按下屏幕的事件</span></span><br><span class="line"><span class="comment">//    ACTION_MOVE:用户滑动的时间</span></span><br><span class="line"><span class="comment">//    ACTION_UP:用户手指从按下状态抬起屏幕的时间</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    getAction方法：得到操作时间的类型</span></span><br><span class="line"><span class="comment">//    getDwonTime方法：得到用户按下的时间</span></span><br><span class="line"><span class="comment">//    getEventTime方法：得到用户操作的时间</span></span><br><span class="line"><span class="comment">//    getPressure方法：得到用户的触摸压力值</span></span><br><span class="line"></span><br><span class="line">    override fun <span class="title function_">onTouchEvent</span><span class="params">(event: MotionEvent?)</span>: Boolean &#123;</span><br><span class="line">        <span class="keyword">if</span> (MotionEvent.ACTION_DOWN == event!!.action) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">x</span> <span class="operator">=</span> event.x</span><br><span class="line">            <span class="type">var</span> <span class="variable">y</span> <span class="operator">=</span> event.y</span><br><span class="line">            tv!!.text = <span class="string">&quot;您点击的位置是:\nx: &quot;</span> + x + <span class="string">&quot;\ny: &quot;</span> + y</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onTouchEvent(event)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/12/18/5c18c98c3685a.png"><br>详细代码<br><a href="https://github.com/xmaihh/KotlinTrainingThings/releases/tag/v1.0">https://github.com/xmaihh/KotlinTrainingThings/releases/tag/v1.0</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java中bit的操作技巧</title>
      <link href="/blog/2018/12/10/java-zhong-bit-de-cao-zuo-ji-qiao/"/>
      <url>/blog/2018/12/10/java-zhong-bit-de-cao-zuo-ji-qiao/</url>
      
        <content type="html"><![CDATA[<p>Java中定义八种基本数据类型,最小到byte,然而最近在底层操作中遇到需要根据一个byte中的bit来操作,作此记录。</p><h1 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h1><ul><li>byte b; 1字节（8位） （-128~127）（-2的7次方到2的7次方-1）</li><li>short s; 2字节（16位） （-32768~32767）（-2的15次方到2的15次方-1）</li><li>char c;2字节（16位）（C语言中是1字节）可以存储一个汉字</li><li>int i; 4字节（32位） （一个字长）（-2147483648~2147483647）（-2的31次方到2的31次方-1）</li><li>long l; 8字节（64位） （-9223372036854774808~9223372036854774807）（-2的63次方到2的63次方-1）</li><li>float f; 4字节（32位） （3.402823e+38 ~ 1.401298e-45）（e+38是乘以10的38次方，e-45是乘以10的负45次方）(-2^128 ~ +2^128)</li><li>double d; 8字节（64位） （1.797693e+308~ 4.9000000e-324)(-2^1024 ~ +2^1024)</li><li>boolean bool; false&#x2F;true (理论上占用1bit,1&#x2F;8字节，实际处理按1byte处理)</li></ul><h1 id="bit操作技巧"><a href="#bit操作技巧" class="headerlink" title="bit操作技巧"></a>bit操作技巧</h1><p> bit：位<br>    一个二进制数据0或1，是1bit；<br>Java中最小基本数据类型是byte,Java中要根据byte获得bit就要进行一些位操作可以根据<code> 1 byte = 8 bit</code>这个转化关系来。</p><h2 id="将byte转换bit"><a href="#将byte转换bit" class="headerlink" title="将byte转换bit"></a>将byte转换bit</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 将byte转换为一个长度为8的byte数组，数组每个值代表bit</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; e.g.</span></span><br><span class="line"><span class="comment">    * byte b = 0x35; // 0011 0101</span></span><br><span class="line"><span class="comment">    * // 输出 [0, 0, 1, 1, 0, 1, 0, 1]</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param b</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   public static <span class="keyword">byte[] </span>getBooleanArray(<span class="keyword">byte </span><span class="keyword">b) </span>&#123;</span><br><span class="line">       <span class="keyword">byte[] </span>array = new <span class="keyword">byte[8];</span></span><br><span class="line"><span class="keyword"></span>       for (int i = <span class="number">7</span><span class="comment">; i &gt;= 0; i--) &#123;</span></span><br><span class="line">           array[i] = (<span class="keyword">byte) </span>(<span class="keyword">b </span>&amp; <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">b </span>= (<span class="keyword">byte) </span>(<span class="keyword">b </span>&gt;&gt; <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       return array;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 把byte转为字符串的bit</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; e.g.</span></span><br><span class="line"><span class="comment">    * byte b = 0x35; // 0011 0101</span></span><br><span class="line"><span class="comment">    * // 输出 00110101</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param b</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   public static String <span class="keyword">byteToBit(byte </span><span class="keyword">b) </span>&#123;</span><br><span class="line">       return <span class="string">&quot;&quot;</span></span><br><span class="line">               + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x1</span>) + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1</span>)</span><br><span class="line">               + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1</span>) + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x1</span>)</span><br><span class="line">               + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x1</span>) + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x1</span>)</span><br><span class="line">               + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x1</span>) + (<span class="keyword">byte) </span>((<span class="keyword">b </span>&gt;&gt; <span class="number">0</span>) &amp; <span class="number">0x1</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p>输出内容就是各个 bit 位的 0 和 1 值，还有一种<br>JDK自带的方法<code>Integer.toBinaryString(0x35);</code>,会忽略前面的 0 ,输出为<code>110101</code></p></blockquote><h2 id="bit转换byte"><a href="#bit转换byte" class="headerlink" title="bit转换byte"></a>bit转换byte</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 二进制字符串转byte</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">byteStr</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> byte <span class="title function_">decodeBinaryString</span>(<span class="params"><span class="title class_">String</span> byteStr</span>) &#123;</span><br><span class="line">       int re, len;</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">null</span> == byteStr) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       len = byteStr.<span class="title function_">length</span>();</span><br><span class="line">       <span class="keyword">if</span> (len != <span class="number">4</span> &amp;&amp; len != <span class="number">8</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (len == <span class="number">8</span>) &#123;<span class="comment">// 8 bit处理</span></span><br><span class="line">           <span class="keyword">if</span> (byteStr.<span class="title function_">charAt</span>(<span class="number">0</span>) == <span class="string">&#x27;0&#x27;</span>) &#123;<span class="comment">// 正数</span></span><br><span class="line">               re = <span class="title class_">Integer</span>.<span class="built_in">parseInt</span>(byteStr, <span class="number">2</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;<span class="comment">// 负数</span></span><br><span class="line">               re = <span class="title class_">Integer</span>.<span class="built_in">parseInt</span>(byteStr, <span class="number">2</span>) - <span class="number">256</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;<span class="comment">// 4 bit处理</span></span><br><span class="line">           re = <span class="title class_">Integer</span>.<span class="built_in">parseInt</span>(byteStr, <span class="number">2</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> (byte) re;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android的四大启动模式</title>
      <link href="/blog/2018/12/03/android-de-si-da-qi-dong-mo-shi/"/>
      <url>/blog/2018/12/03/android-de-si-da-qi-dong-mo-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h1><ol><li>standard：标准模式</li><li>singleTop：栈顶复用模式</li><li>singleTask：栈内复用模式</li><li>singleInstance：单一实例模式</li></ol><h1 id="启动模式"><a href="#启动模式" class="headerlink" title="启动模式"></a>启动模式</h1><h2 id="standard：标准模式"><a href="#standard：标准模式" class="headerlink" title="standard：标准模式"></a>standard：标准模式</h2><p>系统默认模式。每次启动一个Activity都会重新创建一个新的实例，不管这个实例是否已经存在。在这个模式下，谁启动了Activity，那么这个Activity就运行在启动它的那个Activity所在栈中。</p><h2 id="singleTop：栈顶复用模式"><a href="#singleTop：栈顶复用模式" class="headerlink" title="singleTop：栈顶复用模式"></a>singleTop：栈顶复用模式</h2><p>在这种模式下，如果新的Activity已经位于任务栈顶，那么此Activity不会被重新创建，同时它的onNewIntent方法会被回调，通过此方法的参数我们可以取出当前的请求信息</p><h2 id="singleTask：栈内复用模式"><a href="#singleTask：栈内复用模式" class="headerlink" title="singleTask：栈内复用模式"></a>singleTask：栈内复用模式</h2><p>这是一种单例模式，在这种模式下，只要Activity在一个栈中存在，那么多次启动此Activity都不会创建实例，和singleTop是一样，系统也会调用onNewIntent。还有一点，就是singleTask有clearTop的效果，会导致栈内已有的Activity全部出栈。</p><h2 id="singleInstance：单一实例模式"><a href="#singleInstance：单一实例模式" class="headerlink" title="singleInstance：单一实例模式"></a>singleInstance：单一实例模式</h2><p>这是一种加强的singleTask模式，它除了具有singleTask的所有特性以外，还加强了一点，那就是具有此模式的Activity只能单独位于一个任务栈中，比如Activity A是singleInstance模式，当A启动后，系统会为它创建一个新的任务栈，然后A独自在这个新的任务栈中，由于栈内复用的特性，后续均不会创建新的Activity，除非这个独特的任务栈被系统销毁。整个手机操作系统里面只有一个实例存在。不同的应用去打开这个activity 共享公用的同一个activity。他会运行在自己单独，独立的任务栈里面，并且任务栈里面只有他一个实例存在。</p><h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><h2 id="standard使用场景："><a href="#standard使用场景：" class="headerlink" title="standard使用场景："></a>standard使用场景：</h2><p>邮件客户端，在新建一个邮件的时候，适合新建一个新的实例</p><h2 id="singleTop使用场景："><a href="#singleTop使用场景：" class="headerlink" title="singleTop使用场景："></a>singleTop使用场景：</h2><p>消息推送，通知栏弹出Notification，点击Notification跳转到指定Activity，使用singleTop避免生成重复的页面。<br>登录的时候，登录成功跳转到主页，按下两次登录按钮，使用singleTask避免生成两个主页。<br>从activity A启动了个service进行耗时操作，或者某种监听，这个时候你home键了，service收集到信息，要返回activityA。</p><h2 id="singleTask使用场景："><a href="#singleTask使用场景：" class="headerlink" title="singleTask使用场景："></a>singleTask使用场景：</h2><p>提供给第三方应用调用的页面，做浏览器、微博之类的应用，浏览器的主界面等等。<br>程序的主界面，进入多层嵌套之后，一键退回，之前打开的Activity全部出栈。</p><h2 id="singleInstance使用场景："><a href="#singleInstance使用场景：" class="headerlink" title="singleInstance使用场景："></a>singleInstance使用场景：</h2><p>呼叫来电界面，打电话、发短信功能。<br>闹铃提醒，将闹铃提醒与闹铃设置分离。</p><h1 id="四种启动模式的区别"><a href="#四种启动模式的区别" class="headerlink" title="四种启动模式的区别"></a>四种启动模式的区别</h1><p><img src="https://github.com/xmaihh/xmaihh.github.io/raw/master/asset/Android-launchMode.png" alt="Android启动模式"></p><h1 id="启动模式的设置"><a href="#启动模式的设置" class="headerlink" title="启动模式的设置"></a>启动模式的设置</h1><h2 id="在AndroidMainifest的Activity配置进行设置"><a href="#在AndroidMainifest的Activity配置进行设置" class="headerlink" title="在AndroidMainifest的Activity配置进行设置"></a>在<code>AndroidMainifest</code>的Activity配置进行设置</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity </span><br><span class="line">    android:<span class="attribute">name</span>=<span class="string">&quot;.singletop.SingleTopActivity&quot;</span> </span><br><span class="line">    android:<span class="attribute">launchMode</span>=<span class="string">&quot;singleTop&quot;</span></span><br><span class="line">    android:<span class="attribute">taskAffinity</span>=<span class="string">&quot;com.xmaihh.demo.standard&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>taskAffinitys属性在默认情况下一个应用中的所有activity具有相同的taskAffinity，即应用程序的包名。我们可以通过设置不同的taskAffinity属性给应用中的activity分组，也可以把不同的应用中的activity的taskAffinity设置成相同的值。</p></blockquote><h2 id="通过Intent设置标志位"><a href="#通过Intent设置标志位" class="headerlink" title="通过Intent设置标志位"></a>通过Intent设置标志位</h2><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Intent</span> inten = new <span class="keyword">Intent</span> (ActivityA.this,ActivityB.<span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">intent</span>,addFlags(<span class="keyword">Intent</span>,FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">startActivity(<span class="keyword">intent</span>);</span><br></pre></td></tr></table></figure><p>标志位属性</p><table><thead><tr><th>标记位属性</th><th>含义</th></tr></thead><tbody><tr><td>FLAG_ACTIVITY_SINGLE_TOP</td><td>指定启动模式为栈顶复用模式（SingleTop）</td></tr><tr><td>FLAG_ACTIVITY_NEW_TASK</td><td>指定启动模式为栈内复用模式（SingleTask）</td></tr><tr><td>FLAG_ACTIVITY_CLEAR_TOP</td><td>所有位于其上层的Activity都要移除，SingleTask模式默认具有此标记效果</td></tr><tr><td>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</td><td>具有该标记的Activity不会出现在历史Activity的列表中，即无法通过历史列表回到该Activity上</td></tr></tbody></table><blockquote><p>两种设置方式有区别<br>1.优先级不同<br>Intent设置方式的优先级 &gt; Manifest设置方式，即 以前者为准<br>2.限定范围不同<br>Manifest设置方式无法设定 FLAG_ACTIVITY_CLEAR_TOP；Intent设置方式 无法设置单例模式（SingleInstance）</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidStudio的module library添加aar的配置</title>
      <link href="/blog/2018/11/20/androidstudio-de-module-library-tian-jia-aar-de-pei-zhi/"/>
      <url>/blog/2018/11/20/androidstudio-de-module-library-tian-jia-aar-de-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h1 id="使用aar的步骤"><a href="#使用aar的步骤" class="headerlink" title="使用aar的步骤"></a>使用aar的步骤</h1><ol><li>在app的build.gradle中加入配置<br>一般来说,对<code>/项目工程/app/build.gradle</code>加入配置<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">android</span>&#123;</span><br><span class="line">    <span class="operator">...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        <span class="keyword">flatDir</span> &#123;</span><br><span class="line">            dirs <span class="symbol">&#x27;libs</span>&#x27;   <span class="comment">// aar目录</span></span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>将aar文件拷贝到<code>app/libs</code>目录下 (e.g. aar文件为 xxxx-release.aar)</li><li>在app的dependencies中加入aar引用<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">implementation</span><span class="params">(name: <span class="string">&#x27;xxxx-release&#x27;</span>, ext: <span class="string">&#x27;aar&#x27;</span>)</span></span></span><br></pre></td></tr></table></figure>重新编译即可使用新加入的aar文件了</li></ol><h1 id="在module-library使用aar的步骤"><a href="#在module-library使用aar的步骤" class="headerlink" title="在module library使用aar的步骤"></a>在module library使用aar的步骤</h1><ol><li><p>在<code>module library</code>的build.gradle中加入配置</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line">android&#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">        flatDir &#123;</span><br><span class="line">            dirs <span class="string">&#x27;libs&#x27;</span>,<span class="string">&#x27;../module_library/libs</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">dependencies &#123;</span></span><br><span class="line"><span class="string">    implementation fileTree(include: [&#x27;</span>*.jar<span class="string">&#x27;], dir: &#x27;</span>libs<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    implementation(name: &#x27;</span>xxxx-releas<span class="string">e&#x27;, ext: &#x27;</span>aar<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>这里主要是配置路径：这个是相对项目下的路径，一定要配上&#x2F;module_library&#x2F;libs,否则会由于路径不对找不到对应的aar</p></li><li><p>将aar文件拷贝到<code>module_library/libs</code>目录下 (e.g. aar文件为 xxxx-release.aar)</p></li><li><p>在<code>module library</code>的dependencies中加入aar引用</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">implementation</span><span class="params">(name: <span class="string">&#x27;xxxx-release&#x27;</span>, ext: <span class="string">&#x27;aar&#x27;</span>)</span></span></span><br></pre></td></tr></table></figure><blockquote></blockquote><p>如果觉得写绝对路径比较复杂，可以更简单点,在Top-level build.gradle定义</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ext</span>&#123;</span><br><span class="line">   MODULE_DIR_PATH <span class="operator">=</span> projectDir.getPath() <span class="operator">+</span>  <span class="string">&quot;/module_library/libs&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么依赖可以写成</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">        <span class="keyword">flatDir</span> &#123;</span><br><span class="line">            dirs <span class="string">&#x27;libs&#x27;</span>,  rootProject.ext.MODULE_DIR_PATH</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android工程中assets与raw文件夹的区别</title>
      <link href="/blog/2018/11/13/android-gong-cheng-zhong-assets-yu-raw-wen-jian-jia-de-qu-bie/"/>
      <url>/blog/2018/11/13/android-gong-cheng-zhong-assets-yu-raw-wen-jian-jia-de-qu-bie/</url>
      
        <content type="html"><![CDATA[<p>  我们都知道Android工程中assets与raw文件夹都可以用来存放文件<br>比如已经设计好的数据库文件可以选择放到assets中（当然你们也可以放到raw里 ），这样程序在打包时会原封不动的保存到apk包中，不会被编译成二进制。早期android2.3以前的版本有着assets和raw里资源文件不能超过1M的限制，当然现在已经没有这个限制了。</p><h1 id="res-raw和assets的相同点"><a href="#res-raw和assets的相同点" class="headerlink" title="res&#x2F;raw和assets的相同点"></a>res&#x2F;raw和assets的相同点</h1><p>两者目录下的文件在打包后会原封不动的保存在apk包中，不会被编译成二进制</p><h1 id="res-raw和assets的不同点"><a href="#res-raw和assets的不同点" class="headerlink" title="res&#x2F;raw和assets的不同点"></a>res&#x2F;raw和assets的不同点</h1><ol><li>res&#x2F;raw中的文件会被映射到R.java文件中，访问的时候直接使用资源ID即R.id.filename；assets文件夹下的文件不会被映射到R.java中，访问的时候需要AssetManager类。</li><li>res&#x2F;raw不可以有目录结构，而assets则可以有目录结构，也就是assets目录下可以再建立文件夹</li></ol><blockquote><ul><li>由于raw是Resources (res)的子目录，Android会自动的为这目录中的所有资源文件生成一个ID，这个ID会被存储在R类当中，作为一个文件的引用。这意味着这个资源文件可以很容易的被Android的类和方法访问到，甚至在Android XML文件中你也可以@raw&#x2F;的形式引用到它。在Android中，使用ID是访问一个文件最快捷的方式。MP3和Ogg文件放在这个目录下是比较合适的。</li><li>assets目录更像一个附录类型的目录，Android不会为这个目录中的文件生成ID并保存在R类当中，因此它与Android中的一些类和方法兼容度更低。同时，由于你需要一个字符串路径来获取这个目录下的文件描述符，访问的速度会更慢。但是把一些文件放在这个目录下会使一些操作更加方便，比方说拷贝一个数据库文件到系统内存中。要注意的是，你无法在Android XML文件中引用到assets目录下的文件，只能通过AssetManager来访问这些文件。数据库文件和游戏数据等放在这个目录下是比较合适的。</li></ul></blockquote><h1 id="读取文件资源"><a href="#读取文件资源" class="headerlink" title="读取文件资源"></a>读取文件资源</h1><ol><li>读取res&#x2F;raw下的文件资源，通过以下方式获取输入流来进行写操作<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream is <span class="operator">=</span> getResources().openRawResource(R.id.filename)<span class="comment">; </span></span><br></pre></td></tr></table></figure></li><li>读取assets下的文件资源，通过以下方式获取输入流来进行写操作<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AssetManager am <span class="operator">=</span> null<span class="comment">;  </span></span><br><span class="line"><span class="attribute">am</span> <span class="operator">=</span> getAssets()<span class="comment">;  </span></span><br><span class="line">InputStream is <span class="operator">=</span> am.open(<span class="string">&quot;filename&quot;</span>)<span class="comment">;  </span></span><br></pre></td></tr></table></figure></li></ol><h1 id="读取-res-raw下文件并写入sd卡的示例方法"><a href="#读取-res-raw下文件并写入sd卡的示例方法" class="headerlink" title="读取&#x2F;res&#x2F;raw下文件并写入sd卡的示例方法"></a>读取&#x2F;res&#x2F;raw下文件并写入sd卡的示例方法</h1><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> makeFile() &#123;</span><br><span class="line">    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;开始创建文件&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">if</span> (Environment.getExternalStorageState().equals(</span><br><span class="line">            Environment.MEDIA_MOUNTED)) &#123;</span><br><span class="line">        String dirPath = Environment.getExternalStorageDirectory()</span><br><span class="line">                .getPath() + <span class="string">&quot;/WeiPics&quot;</span>; <span class="comment">// 要保存的路径</span></span><br><span class="line">        String fileName = <span class="string">&quot;notes1.png&quot;</span>; <span class="comment">// 文件名</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">File</span> dir = <span class="keyword">new</span> <span class="keyword">File</span>(dirPath);</span><br><span class="line">            <span class="keyword">if</span> (!dir.exists()) &#123;<span class="comment">// 如果目录不存在，创建目录</span></span><br><span class="line">                dir.mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(dirPath + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;<span class="comment">// 如果文件不存在，创建文件</span></span><br><span class="line">                InputStream ins = getResources().openRawResource(</span><br><span class="line">                        R.raw.notes1);</span><br><span class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">file</span>);</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8192</span>];</span><br><span class="line">                <span class="keyword">int</span> <span class="keyword">count</span> = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> ((<span class="keyword">count</span> = ins.<span class="keyword">read</span>(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    fos.<span class="keyword">write</span>(buffer, <span class="number">0</span>, <span class="keyword">count</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.close();</span><br><span class="line">                ins.close();</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;创建文件成功&quot;</span>,</span><br><span class="line">                        Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，在Manifest中记得加入相关权限</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="attribute">name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>读取&#x2F;assets下文件并写入sd卡的示例方法<br>和上面的方法几乎一致，只是把：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InputStream ins <span class="operator">=</span> getResources().openRawResource(</span><br><span class="line">                        R.raw.notes1)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>改为:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssetManager assetManager <span class="operator">=</span> getAssets()<span class="comment">;</span></span><br><span class="line">InputStream ins <span class="operator">=</span> assetManager.open(<span class="string">&quot;Notes1.png&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><h1 id="获取assets文件夹的所有文件"><a href="#获取assets文件夹的所有文件" class="headerlink" title="获取assets文件夹的所有文件"></a>获取assets文件夹的所有文件</h1><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AssetManager am <span class="operator">=</span> context.getAssets()<span class="comment">;</span></span><br><span class="line">String[] path <span class="operator">=</span> null<span class="comment">;</span></span><br><span class="line">try &#123;</span><br><span class="line">    path <span class="operator">=</span> am.list(<span class="string">&quot;&quot;</span>)<span class="comment">;  // &quot;&quot;获取所有,填入目录获取该目录下所有资源</span></span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace()<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何正确写出单例模式</title>
      <link href="/blog/2018/11/09/ru-he-zheng-que-xie-chu-dan-li-mo-shi/"/>
      <url>/blog/2018/11/09/ru-he-zheng-que-xie-chu-dan-li-mo-shi/</url>
      
        <content type="html"><![CDATA[<p>单例模式算是设计模式中最容易理解，也是最容易手写代码的模式了吧。但是其中的坑却不少，所以也常作为面试题来考。本文主要对几种单例写法的整理，并分析其优缺点。很多都是一些老生常谈的问题，但如果你不知道如何创建一个线程安全的单例，不知道什么是双检锁，那这篇文章可能会帮助到你。</p><h1 id="懒汉式，线程不安全"><a href="#懒汉式，线程不安全" class="headerlink" title="懒汉式，线程不安全"></a>懒汉式，线程不安全</h1><p>当被问到要实现一个单例模式时，很多人的第一反应是写出如下的代码，包括教科书上也是这样教我们的。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;</span><br><span class="line">   <span class="keyword"> private</span><span class="keyword"> static</span> Singleton instance;</span><br><span class="line">   <span class="keyword"> private</span> Singleton ()&#123;&#125;</span><br><span class="line">   <span class="keyword"> public</span><span class="keyword"> static</span> Singleton getInstance() &#123;</span><br><span class="line">    <span class="built_in"> if </span>(instance == null) &#123;</span><br><span class="line">        <span class="built_in"> instance </span>=<span class="built_in"> new </span>Singleton();</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="built_in"> return </span>instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码简单明了，而且使用了懒加载模式，但是却存在致命的问题。当有多个线程并行调用 getInstance() 的时候，就会创建多个实例。也就是说在多线程下不能正常工作。</p><h1 id="懒汉式，线程安全"><a href="#懒汉式，线程安全" class="headerlink" title="懒汉式，线程安全"></a>懒汉式，线程安全</h1><p>为了解决上面的问题，最简单的方法是将整个 getInstance() 方法设为同步（synchronized）。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public<span class="keyword"> static</span> synchronized Singleton getInstance() &#123;</span><br><span class="line">   <span class="built_in"> if </span>(instance == null) &#123;</span><br><span class="line">       <span class="built_in"> instance </span>=<span class="built_in"> new </span>Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in"> return </span>instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然做到了线程安全，并且解决了多实例的问题，但是它并不高效。因为在任何时候只能有一个线程调用 getInstance() 方法。但是同步操作只需要在第一次调用时才被需要，即第一次创建单例实例对象时。这就引出了双重检验锁。</p><h1 id="双重检验锁"><a href="#双重检验锁" class="headerlink" title="双重检验锁"></a>双重检验锁</h1><p>双重检验锁模式（double checked locking pattern），是一种使用同步块加锁的方法。程序员称其为双重检查锁，因为会有两次检查<code>instance == null</code>，一次是在同步块外，一次是在同步块内。为什么在同步块内还要再检验一次？因为可能会有多个线程一起进入同步块外的 if，如果在同步块内不进行二次检验的话就会生成多个实例了。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public<span class="keyword"> static</span> Singleton getSingleton() &#123;</span><br><span class="line">   <span class="built_in"> if </span>(instance == null) &#123;                         //Single Checked</span><br><span class="line">        synchronized (Singleton.class) &#123;</span><br><span class="line">           <span class="built_in"> if </span>(instance == null) &#123;                 //Double Checked</span><br><span class="line">               <span class="built_in"> instance </span>=<span class="built_in"> new </span>Singleton();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in"> return </span>instance ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码看起来很完美，很可惜，它是有问题。主要在于instance &#x3D; new Singleton()这句，这并非是一个原子操作，事实上在 JVM 中这句话大概做了下面 3 件事情。</p><ol><li>给 instance 分配内存</li><li>调用 Singleton 的构造函数来初始化成员变量</li><li>将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）</li></ol><p>但是在 JVM 的即时编译器中存在指令重排序的优化。也就是说上面的第二步和第三步的顺序是不能保证的，最终的执行顺序可能是 1-2-3 也可能是 1-3-2。如果是后者，则在 3 执行完毕、2 未执行之前，被线程二抢占了，这时 instance 已经是非 null 了（但却没有初始化），所以线程二会直接返回 instance，然后使用，然后顺理成章地报错。</p><p>我们只需要将 instance 变量声明成 volatile 就可以了。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;</span><br><span class="line">   <span class="keyword"> private</span> volatile<span class="keyword"> static</span> Singleton instance; //声明成 volatile</span><br><span class="line">   <span class="keyword"> private</span> Singleton ()&#123;&#125;</span><br><span class="line">   <span class="keyword"> public</span><span class="keyword"> static</span> Singleton getSingleton() &#123;</span><br><span class="line">       <span class="built_in"> if </span>(instance == null) &#123;                         </span><br><span class="line">            synchronized (Singleton.class) &#123;</span><br><span class="line">               <span class="built_in"> if </span>(instance == null) &#123;       </span><br><span class="line">                   <span class="built_in"> instance </span>=<span class="built_in"> new </span>Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="built_in"> return </span>instance;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有些人认为使用 volatile 的原因是可见性，也就是可以保证线程在本地不会存有 instance 的副本，每次都是去主内存中读取。但其实是不对的。使用 volatile 的主要原因是其另一个特性：禁止指令重排序优化。也就是说，在 volatile 变量的赋值操作后面会有一个内存屏障（生成的汇编代码上），读操作不会被重排序到内存屏障之前。比如上面的例子，取操作必须在执行完 1-2-3 之后或者 1-3-2 之后，不存在执行到 1-3 然后取到值的情况。从「先行发生原则」的角度理解的话，就是对于一个 volatile 变量的写操作都先行发生于后面对这个变量的读操作（这里的“后面”是时间上的先后顺序）。</p><p>但是特别注意在 Java 5 以前的版本使用了 volatile 的双检锁还是有问题的。其原因是 Java 5 以前的 JMM （Java 内存模型）是存在缺陷的，即时将变量声明成 volatile 也不能完全避免重排序，主要是 volatile 变量前后的代码仍然存在重排序问题。这个 volatile 屏蔽重排序的问题在 Java 5 中才得以修复，所以在这之后才可以放心使用 volatile。</p><p>相信你不会喜欢这种复杂又隐含问题的方式，当然我们有更好的实现线程安全的单例模式的办法。</p><h1 id="饿汉式-static-final-field"><a href="#饿汉式-static-final-field" class="headerlink" title="饿汉式 static final field"></a>饿汉式 static final field</h1><p>这种方法非常简单，因为单例的实例被声明成 static 和 final 变量了，在第一次加载类到内存中时就会初始化，所以创建实例本身是线程安全的。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton&#123;</span><br><span class="line">    //类加载时就初始化</span><br><span class="line">   <span class="keyword"> private</span><span class="keyword"> static</span><span class="keyword"> final</span> Singleton<span class="built_in"> instance </span>=<span class="built_in"> new </span>Singleton();</span><br><span class="line">    </span><br><span class="line">   <span class="keyword"> private</span> Singleton()&#123;&#125;</span><br><span class="line">   <span class="keyword"> public</span><span class="keyword"> static</span> Singleton getInstance()&#123;</span><br><span class="line">       <span class="built_in"> return </span>instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种写法如果完美的话，就没必要在啰嗦那么多双检锁的问题了。缺点是它不是一种懒加载模式（lazy initialization），单例会在加载类后一开始就被初始化，即使客户端没有调用 getInstance()方法。饿汉式的创建方式在一些场景中将无法使用：譬如 Singleton 实例的创建是依赖参数或者配置文件的，在 getInstance() 之前必须调用某个方法设置参数给它，那样这种单例写法就无法使用了。</p><h1 id="静态内部类-static-nested-class"><a href="#静态内部类-static-nested-class" class="headerlink" title="静态内部类 static nested class"></a>静态内部类 static nested class</h1><p>我比较倾向于使用静态内部类的方法，这种方法也是《Effective Java》上所推荐的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;  </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span> <span class="params">()</span>&#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.INSTANCE; </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种写法仍然使用JVM本身机制保证了线程安全问题；由于 SingletonHolder 是私有的，除了 getInstance() 之外没有办法访问它，因此它是懒汉式的；同时读取实例的时候不会进行同步，没有性能缺陷；也不依赖 JDK 版本。</p><h1 id="枚举-Enum"><a href="#枚举-Enum" class="headerlink" title="枚举 Enum"></a>枚举 Enum</h1><p>用枚举写单例实在太简单了！这也是它最大的优点。下面这段代码就是声明枚举实例的通常做法。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EasySingleton&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以通过EasySingleton.INSTANCE来访问实例，这比调用getInstance()方法简单多了。创建枚举默认就是线程安全的，所以不需要担心double checked locking，而且还能防止反序列化导致重新创建新的对象。但是还是很少看到有人这样写，可能是因为不太熟悉吧。Java 5 之前，我们定义常量都是： public static fianl,要Java 5以上支持枚举Enum。</p><h1 id="容器类管理"><a href="#容器类管理" class="headerlink" title="容器类管理"></a>容器类管理</h1><p>Android很多系统服务都是通过容器获取的单例，将多种单例类型注入到一个统一的管理类中，在使用时根据key获取对象对应类型的对象。这种方式使得我们可以管理多种类型的单例，并且在使用时可以通过统一的接口进行获取操作， 降低了用户的使用成本，也对用户隐藏了具体实现，降低了耦合度。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 使用容器实现单例模式（可以用于管理单例，有兴趣的可以尝试一下）</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InstanceManager</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; objectMap = <span class="keyword">new </span><span class="class title_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="title function_">InstanceManager</span>()&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerService</span>(<span class="built_in">String</span> <span class="built_in">key</span>,<span class="built_in">Object</span> instance)&#123;</span><br><span class="line"><span class="keyword">if</span> (!objectMap.<span class="property">containsKey</span>(<span class="built_in">key</span>))&#123;</span><br><span class="line">objectMap.<span class="property">put</span>(<span class="built_in">key</span>,instance);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">Object</span> <span class="title function_">getService</span>(<span class="built_in">String</span> <span class="built_in">key</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> objectMap.<span class="property">get</span>(<span class="built_in">key</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 使用方式</span></span><br><span class="line"><span class="comment">* Dog类就不贴出来了 </span></span><br><span class="line"><span class="comment">* 自己随便写个就行</span></span><br><span class="line"><span class="comment">* 可以运行一下看看 打印的地址是否一致</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line">InstanceManager .<span class="property">registerService</span>(<span class="string">&quot;dog&quot;</span>, <span class="keyword">new </span><span class="class title_">Dog</span>());</span><br><span class="line"></span><br><span class="line">Dog dog = (Dog) InstanceManager .<span class="property">getService</span>(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">Dog dog2 = (Dog) InstanceManager .<span class="property">getService</span>(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">Dog dog3 = (Dog) InstanceManager .<span class="property">getService</span>(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">Dog dog4 = (Dog) InstanceManager .<span class="property">getService</span>(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.<span class="property">out</span>.<span class="property">println</span>(dog);</span><br><span class="line">System.<span class="property">out</span>.<span class="property">println</span>(dog2);</span><br><span class="line">System.<span class="property">out</span>.<span class="property">println</span>(dog3);</span><br><span class="line">System.<span class="property">out</span>.<span class="property">println</span>(dog4);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>一般来说，单例模式有五种写法：懒汉、饿汉、双重检验锁、静态内部类、枚举。上述所说都是线程安全的实现，文章开头给出的第一种方法不算正确的写法。</p><p>就我个人而言，一般情况下直接使用饿汉式就好了，如果明确要求要懒加载（lazy initialization）会倾向于使用静态内部类，如果涉及到反序列化创建对象时会试着使用枚举的方式来实现单例。</p><p>判断一个设计是否应该为单例模式：</p><ul><li><p>Quote from 《 Use your singletons wisely 》每一个应用（组件&#x2F;模块）是否以完全一致的方式来使用这个类？</p></li><li><p>Will every application use this class exactly the same way? (keyword: exactly)每一个应用（组件&#x2F;模块）是否真的只需要这个类的一个实例呢？</p></li><li><p>Will every application ever need only one instance of this class? (keyword: ever &amp; one)<br>Should the clients of this class be unaware of the application they are part of? 对于这个类的客户端类来说，对他们自己是应用中的一部分这件事是否应该保持毫无察觉的状态呢？</p></li></ul><h1 id="Read-More"><a href="#Read-More" class="headerlink" title="Read More"></a>Read More</h1><p><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/#comments">如何正确地写出单例模式</a></p><p><a href="http://javarevisited.blogspot.sg/2014/05/double-checked-locking-on-singleton-in-java.html">Double Checked Locking on Singleton Class in Java</a></p><p><a href="http://javarevisited.blogspot.sg/2012/07/why-enum-singleton-are-better-in-java.html">Why Enum Singleton are better in Java</a></p><p><a href="http://javarevisited.blogspot.com/2012/12/how-to-create-thread-safe-singleton-in-java-example.html">How to create thread safe Singleton in Java</a></p><p><a href="http://javarevisited.blogspot.com/2011/03/10-interview-questions-on-singleton.html">10 Singleton Pattern Interview questions in Java</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Design pattern </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Program type already present: com.alibaba.android.arouter.routes.ARouter</title>
      <link href="/blog/2018/11/07/program-type-already-present-com-alibaba-android-arouter-routes-arouter/"/>
      <url>/blog/2018/11/07/program-type-already-present-com-alibaba-android-arouter-routes-arouter/</url>
      
        <content type="html"><![CDATA[<p>今天在写东西的时候报了一个错误，这个是使用 alibaba 的路由框架 <a href="https://github.com/alibaba/ARouter">ARouter</a>，进行模块间通信报才错。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Program type already present: com<span class="selector-class">.alibaba</span><span class="selector-class">.android</span><span class="selector-class">.arouter</span><span class="selector-class">.routes</span>.ARouter</span><br></pre></td></tr></table></figure><p>意思是 Arouter 配置的路径的组路径已经存在了，举一个栗子：</p><p>我们在中配置模块 A 中 A1 类，可以配置路径为：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">static</span> <span class="type">String</span> REGIST_A_A1 = <span class="string">&quot;/A/A1&quot;</span>;</span><br></pre></td></tr></table></figure><p>这时候如果我们要配置模块 B 中的类，就不能使用 A 来作为组的路径了，要不然就会报错。在不同的模块中，配置的组路径不能一样，而在同一个模块中，自己的路径不能相同，就是上面 A1 位置不能相同。 </p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sqlite数据库使用笔记</title>
      <link href="/blog/2018/10/26/sqlite-shu-ju-ku-shi-yong-bi-ji/"/>
      <url>/blog/2018/10/26/sqlite-shu-ju-ku-shi-yong-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="sqlite的特点"><a href="#sqlite的特点" class="headerlink" title="sqlite的特点"></a>sqlite的特点</h1><p><a href="https://www.sqlite.org/index.html">sqlite</a>只支持库级锁，同时只能允许一个写操作。但SQLite尽量延迟申请X锁，直到数据块真正写盘时才申请X锁，非常巧妙而有效。</p><blockquote><p>注: 读锁(S锁）、写锁(X锁）</p></blockquote><p><a href="https://www.sqlite.org/faq.html#q6">Is SQLite threadsafe?</a>  SQLite官网上的最权威的解答,答案是sqlite是线程安全的。</p><h1 id="sqlite的线程模式"><a href="#sqlite的线程模式" class="headerlink" title="sqlite的线程模式"></a>sqlite的线程模式</h1><p>SQLite支持<a href="https://www.sqlite.org/threadsafe.html">3种线程模式</a></p><ol><li><p>单线程：禁用所有的mutex锁，并发使用时会出错。当SQLite编译时加了SQLITE_THREADSAFE&#x3D;0参数，或者在初始化SQLite前调用sqlite3_config(SQLITE_CONFIG_SINGLETHREAD)时启用。</p></li><li><p>多线程：只要一个数据库连接不被多个线程同时使用就是安全的。源码中是启用bCoreMutex，禁用bFullMutex。实际上就是禁用数据库连接和prepared statement（准备好的语句）上的锁，因此不能在多个线程中并发使用同一个数据库连接或prepared statement。当SQLite编译时加了SQLITE_THREADSAFE&#x3D;2参数时默认启用。若SQLITE_THREADSAFE不为0，可以在初始化SQLite前，调用sqlite3_config(SQLITE_CONFIG_MULTITHREAD)启用；或者在创建数据库连接时，设置SQLITE_OPEN_NOMUTEX flag。</p></li><li><p>串行：启用所有的锁，包括bCoreMutex和bFullMutex。因为数据库连接和prepared statement都已加锁，所以多线程使用这些对象时没法并发，也就变成串行了。当SQLite编译时加了SQLITE_THREADSAFE&#x3D;1参数时默认启用。若SQLITE_THREADSAFE不为0，可以在初始化SQLite前，调用sqlite3_config(SQLITE_CONFIG_SERIALIZED)启用；或者在创建数据库连接时，设置SQLITE_OPEN_FULLMUTEX flag。</p></li></ol><h1 id="sqlite的事务"><a href="#sqlite的事务" class="headerlink" title="sqlite的事务"></a>sqlite的事务</h1><p><a href="https://www.sqlite.org/lang_transaction.html">事务</a>是和数据库连接相关的，每个数据库连接（使用pager来）维护自己的事务，且同时只能有一个事务（但是可以用SAVEPOINT来实现内嵌事务）。数据库只有在<a href="https://www.sqlite.org/lang_transaction.html">事务</a>中才能被更改。所有更改数据库的命令（除SELECT以外的所有SQL命令）都会自动开启一个新事务，并且当最后一个查询完成时自动提交。</p><p>下面用Android&#x2F;Java来演示一下:</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Database<span class="selector-class">.beginTransaction</span>();  <span class="comment">//手动设置开始事务</span></span><br><span class="line"><span class="built_in">dosomething</span>();</span><br><span class="line">userDatabase<span class="selector-class">.setTransactionSuccessful</span>();        <span class="comment">//设置事务处理成功，不设置会自动回滚不提交</span></span><br><span class="line">userDatabase<span class="selector-class">.endTransaction</span>();        <span class="comment">//处理完成</span></span><br></pre></td></tr></table></figure><p>事务在改写数据库文件时，会先生成一个rollback journal（回滚日志），记录初始状态（其实就是备份），所有改动都是在数据库文件上进行的。当事务需要回滚时，可以将备份文件的内容还原到数据库文件；提交成功时，默认的delete模式下会直接删除这个日志。这个日志也可以帮助解决事务执行过程中断电，导致数据库文件损坏的问题。但如果操作系统或文件系统有bug，或是磁盘损坏，则仍有可能无法恢复。</p><h1 id="sqlite的锁机制"><a href="#sqlite的锁机制" class="headerlink" title="sqlite的锁机制"></a>sqlite的锁机制</h1><p>SQLite基于锁来实现并发控制。SQLite的锁是粗粒度的，并不拥有PostgreSQL那样细粒度的行锁，这也使得SQLite较为轻量级。当一个连接要写数据库时，所有其它的连接都被锁住，直到写连接结束它的事务。</p><p>sqlite的数据库连接有5种锁状态:</p><table><thead><tr><th align="center">状态</th><th align="center">对应的锁</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">未加锁（unlock）</td><td align="center">—</td><td align="center">未和数据库建立连接、已建立连接但是还没访问数据库、已用BEGIN开始了一个事务但未开始读写数据库，处于这些情形时是未加锁状态。</td></tr><tr><td align="center">共享（shared）</td><td align="center">共享锁</td><td align="center">连接需要从数据库中读取数据时，需要申请获得一个共享锁，如果获得成功，则进入共享状态。</td></tr><tr><td align="center">预留（reserved）</td><td align="center">预留锁</td><td align="center">连接需要写数据库时，首先申请一个预留锁，一个数据库同时只能有一个预留锁，预留锁可以与共享锁共存。获得预留锁后进入预留状态，这时会先在缓冲区中进行需要的修改、更新操作，操作后的结果依然保存在缓冲区中，未真正写入数据库。</td></tr><tr><td align="center">未决（pending）</td><td align="center">未决锁</td><td align="center">连接从预留升为排它前，需要先升为未决，这时其它连接就不能获得共享锁了，但已经拥有共享锁的连接仍然可以继续正常读数据库，此时，拥有未决锁的连接等待其它拥有共享锁的连接完成工作并释放其共享锁后，提成到排它锁。</td></tr><tr><td align="center">排它（exclusive）</td><td align="center">排它锁</td><td align="center">连接需要提交修改时，需要将预留锁升为排它锁，这时其它连接都无法获得任何锁，直到当前连接的排它状态结束。</td></tr></tbody></table><ul><li>UNLOCKED：表示数据库此时并未被读写。</li><li>SHARED：表示数据库可以被读取。SHARED锁可以同时被多个线程拥有。一旦某个线程持有SHARED锁，就没有任何线程可以进行写操作。</li><li>RESERVED：表示准备写入数据库。RESERVED锁最多只能被一个线程拥有，此后它可以进入PENDING状态。</li><li>PENDING：表示即将写入数据库，正在等待其他读线程释放SHARED锁。一旦某个线程持有PENDING锁，其他线程就不能获取SHARED锁。这样一来，只要等所有读线程完成，释放SHARED锁后，它就可以进入EXCLUSIVE状态了。</li><li>EXCLUSIVE：表示它可以写入数据库了。进入这个状态后，其他任何线程都不能访问数据库文件。因此为了并发性，它的持有时间越短越好。</li></ul><p>一个线程只有在拥有低级别的锁的时候，才能获取更高一级的锁。SQLite就是靠这5种类型的锁，巧妙地实现了读写线程的互斥。同时也可看出，写操作必须进入EXCLUSIVE状态，此时并发数被降到1，这也是SQLite被认为并发插入性能不好的原因。<br>另外，read-uncommitted和WAL模式会影响这个锁的机制。在这2种模式下，读线程不会被写线程阻塞，即使写线程持有PENDING或EXCLUSIVE锁。</p><h1 id="sqlite的死锁"><a href="#sqlite的死锁" class="headerlink" title="sqlite的死锁"></a>sqlite的死锁</h1><p>在使用事务的情况下，SQLite的锁机制存在死锁的可能性。</p><p>举例说明死锁:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">连接<span class="number">1</span>：<span class="keyword">BEGIN </span>（UNLOCKED）</span><br><span class="line">连接<span class="number">1</span>：SELECT ... （<span class="keyword">SHARED）</span></span><br><span class="line"><span class="keyword"></span>连接<span class="number">1</span>：<span class="keyword">INSERT </span>... （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">BEGIN </span>（UNLOCKED）</span><br><span class="line">连接<span class="number">2</span>：SELECT ... （<span class="keyword">SHARED）</span></span><br><span class="line"><span class="keyword"></span>连接<span class="number">1</span>：COMMIT （PENDING，尝试获取EXCLUSIVE锁，但还有<span class="keyword">SHARED锁未释放，返回SQLITE_BUSY）</span></span><br><span class="line"><span class="keyword"></span>连接<span class="number">2</span>：<span class="keyword">INSERT </span>... （尝试获取RESERVED锁，但已有PENDING锁未释放，返回SQLITE_BUSY）</span><br></pre></td></tr></table></figure><p>现在2个连接都在等待对方释放锁，于是就死锁了。当然，实际情况并没那么糟糕，任何一方选择不继续等待，回滚事务就行了。</p><p>不过要更好地解决这个问题，就必须更深入地了解事务了。<br>实际上BEGIN语句可以有3种起始状态：</p><ul><li>DEFERRED：默认值，开始事务时不获取任何锁。进行第一次读操作时获取。</li><li>SHARED锁，进行第一次写操作时获取RESERVED锁。</li><li>IMMEDIATE：开始事务时获取RESERVED锁。<br>EXCLUSIVE：开始事务时获取EXCLUSIVE锁。</li></ul><p>现在考虑2个事务在开始时都使用IMMEDIATE方式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">连接<span class="number">1</span>：<span class="keyword">BEGIN</span> IMMEDIATE （RESERVED）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">SELECT</span> ... （RESERVED）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">INSERT</span> ... （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">BEGIN</span> IMMEDIATE （尝试获取RESERVED锁，但已有RESERVED锁未释放，因此事务开始失败，返回SQLITE_BUSY，等待用户重试）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">COMMIT</span> （EXCLUSIVE，写入完成后释放）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">BEGIN</span> IMMEDIATE （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">SELECT</span> ... （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">INSERT</span> ... （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">COMMIT</span> （EXCLUSIVE，写入完成后释放）</span><br></pre></td></tr></table></figure><p>这样死锁就被避免了。</p><p>而EXCLUSIVE方式则更为严苛，即使其他连接以DEFERRED方式开启事务也不会死锁：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">连接<span class="number">1</span>：<span class="keyword">BEGIN</span> EXCLUSIVE （EXCLUSIVE）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">SELECT</span> ... （EXCLUSIVE）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">INSERT</span> ... （EXCLUSIVE）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">BEGIN</span> （UNLOCKED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">SELECT</span> ... （尝试获取SHARED锁，但已有EXCLUSIVE锁未释放，返回SQLITE_BUSY，等待用户重试）</span><br><span class="line">连接<span class="number">1</span>：<span class="keyword">COMMIT</span> （EXCLUSIVE，写入完成后释放）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">SELECT</span> ... （SHARED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">INSERT</span> ... （RESERVED）</span><br><span class="line">连接<span class="number">2</span>：<span class="keyword">COMMIT</span> （EXCLUSIVE，写入完成后释放）</span><br></pre></td></tr></table></figure><p>不过在并非很高的情况下，直接获取EXCLUSIVE锁的难度比较大；而且为了避免EXCLUSIVE状态长期阻塞其他请求，最好的方式还是让所有写事务都以IMMEDIATE方式开始。<br>顺带一提，要实现重试的话，可以使用sqlite3_busy_timeout()或sqlite3_busy_handler()函数。</p><p>由此可见，要想保证线程安全的话，可以有这4种方式：</p><ol><li>SQLite使用单线程模式，用一个专门的线程访问数据库。</li><li>SQLite使用单线程模式，用一个线程队列来访问数据库，队列一次只允许一个线程执行，队列里的线程共用一个数据库连接。</li><li>SQLite使用多线程模式，每个线程创建自己的数据库连接。</li><li>SQLite使用串行模式，所有线程共用全局的数据库连接。</li></ol><p>第一种方式太过麻烦，需要线程间通信。<br>第二种方式可以用dispatch_queue_create()来创建一个serial queue，或者用一个maxConcurrentOperationCount为1的NSOperationQueue来实现。<br>这种方式的缺点就是事务必须在一个block或operation里完成，否则会乱序；而耗时较长的事务会阻塞队列。另外，没法利用多核CPU的优势。</p><h1 id="sqlite的WAL模式"><a href="#sqlite的WAL模式" class="headerlink" title="sqlite的WAL模式"></a>sqlite的WAL模式</h1><p>WAL的全称Write Ahead Log,修改并不直接写入到数据库文件中，而是写入到另外一个称为WAL的文件中；如果事务失败，WAL中的记录会被忽略，撤销修改；如果事务成功，它将在随后的某个时间被写回到数据库文件中，提交修改。</p><p>WAL使用检查点将修改写回数据库，默认情况下，当WAL文件发现有1000页修改时，将自动调用检查点。这个页数大小可以自行配置。</p><p>使用WAL的优势:</p><ul><li>读写操作不再互相阻塞，一定程度上解决了SQLite在处理高并发上的性能瓶颈</li><li>大多数场景中，带来很大的性能提升</li><li>磁盘I&#x2F;O行为更容易被预测</li></ul><p>缺点:<br>除非数据达到GB级时，性能才会降低。</p><p>android中如何开启WAL模式</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQLiteDatabase <span class="keyword">db</span> = SQLiteDatabase.openDatabase(<span class="string">&quot;db_filename&quot;</span>, </span><br><span class="line">cursorFactory,CREATE_IF_NECESSARY, myDatabaseErrorHandler);</span><br><span class="line"><span class="keyword">db</span>.enableWriteAheadLogging();</span><br></pre></td></tr></table></figure><p>来看看SQLiteDatabase开启WAL的核心方法源码:</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> enableWriteAheadLogging() &#123;</span><br><span class="line">        <span class="comment">// make sure the database is not READONLY. WAL doesn&#x27;t make sense for readonly-databases.</span></span><br><span class="line">        <span class="keyword">if</span> (isReadOnly()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// acquire lock - no that no other thread is enabling WAL at the same time</span></span><br><span class="line">        lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">if</span> (mConnectionPool != <span class="built_in">null</span>) &#123;</span><br><span class="line">                <span class="comment">// already enabled</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPath.equalsIgnoreCase(MEMORY_DB_PATH)) &#123;</span><br><span class="line">                <span class="keyword">Log</span>.i(<span class="built_in">TAG</span>, <span class="string">&quot;can&#x27;t enable WAL for memory databases.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// make sure this database has NO attached databases because sqlite&#x27;s write-ahead-logging</span></span><br><span class="line">            <span class="comment">// doesn&#x27;t work for databases with attached databases</span></span><br><span class="line">            <span class="keyword">if</span> (mHasAttachedDbs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">Log</span>.isLoggable(<span class="built_in">TAG</span>, <span class="keyword">Log</span>.DEBUG)) &#123;</span><br><span class="line">                    <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>,</span><br><span class="line">                            <span class="string">&quot;this database: &quot;</span> + mPath + <span class="string">&quot; has attached databases. can&#x27;t  enable WAL.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mConnectionPool = <span class="literal">new</span> DatabaseConnectionPool(this);  <span class="comment">// 创建数据库连接池，由于要支持并发访问所以需要连接池的支持</span></span><br><span class="line">            setJournalMode(mPath, <span class="string">&quot;WAL&quot;</span>); <span class="comment">// 调用setJournalMode设置模式为WAL</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>开启了WAL模式之后，事务的开始需要注意，在源码的注释是这样写到</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Writers should use &#123;@link <span class="punctuation">#</span><span class="keyword">beginTransactionNonExclusive</span><span class="params">()</span>&#125; or</span><br><span class="line">     * &#123;@link <span class="punctuation">#</span><span class="keyword">beginTransactionWithListenerNonExclusive</span><span class="params">(<span class="variable">SQLiteTransactionListener</span>)</span>&#125;</span><br></pre></td></tr></table></figure><p>调用者需要使用beginTransactionNonExclusive或者beginTransactionWithListenerNonExclusive来开始事务，也就是执行：BEGIN IMMEDIATE; 支持多并发。</p><p>开启了WAL模式磁盘中是这样的文件格式:</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xxx<span class="meta">.db</span></span><br><span class="line">xxx<span class="meta">.db</span>-shm</span><br><span class="line">xxx<span class="meta">.db</span>-wal</span><br></pre></td></tr></table></figure><blockquote><p>-shm文件包含-wal文件的数据索引，-shm文件提升-wal文件的读性能<br>如果-shm文件被删除，下次数据库连接时会自动新建一个-shm文件<br>如果执行了checkpoint命令，-war文件可以删除。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
            <tag> Sqlite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>动手实现一个微信小程序</title>
      <link href="/blog/2018/10/18/dong-shou-shi-xian-yi-ge-wei-xin-xiao-cheng-xu/"/>
      <url>/blog/2018/10/18/dong-shou-shi-xian-yi-ge-wei-xin-xiao-cheng-xu/</url>
      
        <content type="html"><![CDATA[<h1 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h1><ul><li>微信小程序开发者工具 v1.02.1809260</li><li>调试基础库 2.0.4</li></ul><h1 id="实现功能"><a href="#实现功能" class="headerlink" title="实现功能"></a>实现功能</h1><ul><li>上传一张图片检测图片中的人脸展示人脸属性信息，如年龄、性别、表情、美丑打分等。</li></ul><h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><ul><li>接口用到的百度AI开放平台的人脸检测与属性分析<br><a href="https://ai.baidu.com/docs#/Face-Detect-V3/top">接口文档</a></li></ul><h1 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h1><ol><li>本地选取一张图片</li><li>获取图片base64编码</li><li>获取百度开发api请求token</li><li>请求人脸检测接口</li></ol><h1 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h1><p><img src="https://github.com/xmaihh/weixinxiaochengxu/raw/master/arts/baiduai_face.png" alt="效果图"></p><h1 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h1><p>先用python把接口调试一下，测试调通</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_token</span>(<span class="params">host</span>):</span><br><span class="line">    header_dict = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko&#x27;</span>,</span><br><span class="line">                   <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">    req = request.Request(url=host, headers=header_dict)</span><br><span class="line">    res = request.urlopen(req)</span><br><span class="line">    res = res.read()</span><br><span class="line">    res_json = json.loads(res.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(res_json)</span><br><span class="line">    <span class="keyword">return</span> res_json[<span class="string">&quot;access_token&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">进行post请求</span></span><br><span class="line"><span class="string">url:请求地址</span></span><br><span class="line"><span class="string">values:请求体</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_info_post_json_data</span>(<span class="params">url, value</span>):</span><br><span class="line">    header_dict = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko&#x27;</span>,</span><br><span class="line">                   <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">    req = request.Request(url=url, data=value, headers=header_dict)</span><br><span class="line">    res = request.urlopen(req)</span><br><span class="line">    res = res.read()</span><br><span class="line">    <span class="keyword">return</span> (res.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">调用百度API,进行人脸探测</span></span><br><span class="line"><span class="string">imgPath: 图片地址</span></span><br><span class="line"><span class="string">access_token: 开发者token</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getBaiduFaceTech</span>(<span class="params">imgPath, access_token</span>):</span><br><span class="line">    request_url = <span class="string">&quot;https://aip.baidubce.com/rest/2.0/face/v3/detect&quot;</span></span><br><span class="line">    <span class="comment"># 二进制方式打开图片文件</span></span><br><span class="line">    f = <span class="built_in">open</span>(imgPath, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    <span class="comment"># 图片转换成base64</span></span><br><span class="line">    img = base64.b64encode(f.read())</span><br><span class="line">    params = &#123;<span class="string">&quot;image&quot;</span>: img, <span class="string">&quot;image_type&quot;</span>: <span class="string">&quot;BASE64&quot;</span>, <span class="string">&quot;face_field&quot;</span>: <span class="string">&quot;age,beauty,expression,face_shape,gender,glasses,landmark,race,quality,face_type&quot;</span>&#125;</span><br><span class="line">    params = urllib.parse.urlencode(params).encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    request_url = request_url + <span class="string">&quot;?access_token=&quot;</span> + access_token</span><br><span class="line">    <span class="comment"># 调用post其请求方法</span></span><br><span class="line">    face_info = get_info_post_json_data(request_url, params)</span><br><span class="line">    <span class="comment"># json字符串转为对象</span></span><br><span class="line">    face_json = json.loads(face_info)</span><br><span class="line">    <span class="keyword">if</span> face_json[<span class="string">&quot;error_code&quot;</span>] != <span class="number">0</span>:</span><br><span class="line">    <span class="comment"># 如果没有发现人像,会返回为空</span></span><br><span class="line">    <span class="keyword">elif</span> face_json[<span class="string">&quot;result&quot;</span>][<span class="string">&#x27;face_num&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 把想要的部分提取存入字典中</span></span><br><span class="line">        result = face_json[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;face_list&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;分值:&quot;</span> + <span class="built_in">str</span>(result[<span class="string">&#x27;beauty&#x27;</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;年龄:&quot;</span> + <span class="built_in">str</span>(result[<span class="string">&#x27;age&#x27;</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;性别:&quot;</span> + result[<span class="string">&#x27;gender&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] + <span class="string">&quot;\n可能性:&quot;</span> + <span class="built_in">str</span>(result[<span class="string">&#x27;gender&#x27;</span>][<span class="string">&#x27;probability&#x27;</span>]))</span><br><span class="line">        gender = result[<span class="string">&#x27;gender&#x27;</span>][<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">        age = <span class="built_in">str</span>(result[<span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">        beauty = <span class="built_in">str</span>(result[<span class="string">&#x27;beauty&#x27;</span>])</span><br><span class="line">        probability = <span class="built_in">str</span>(result[<span class="string">&#x27;gender&#x27;</span>][<span class="string">&#x27;probability&#x27;</span>])</span><br><span class="line">        face_dict = &#123;<span class="string">&quot;gender&quot;</span>: gender, <span class="string">&quot;age&quot;</span>: age, <span class="string">&quot;probability&quot;</span>: probability, <span class="string">&quot;beauty&quot;</span>: beauty&#125;</span><br><span class="line">        <span class="keyword">return</span> face_dict</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == &#x27;__main__&#x27;:</span></span><br><span class="line"><span class="string">    # client_id 为官网获取的AK， client_secret 为官网获取的SK</span></span><br><span class="line"><span class="string">    host = &#x27;https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&amp;client_id=【百度云应用的AK】&amp;client_secret=【百度云应用的SK】&#x27;</span></span><br><span class="line"><span class="string">    token = get_token(host)</span></span><br><span class="line"><span class="string">    # 调用百度人脸识别API</span></span><br><span class="line"><span class="string">    face_dict = getBaiduFaceTech(&quot;face.jpg&quot;, token)</span></span><br></pre></td></tr></table></figure><h2 id="步骤1-本地选取一张图片"><a href="#步骤1-本地选取一张图片" class="headerlink" title="步骤1:本地选取一张图片"></a>步骤1:本地选取一张图片</h2><p>直接调用小程序wx.chooseImage(Object object)从本地相册选择图片或使用相机拍照<br><a href="https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html">https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">chooseImage</span>(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">      <span class="attr">sizeType</span>: [<span class="string">&#x27;compressed&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认二者都有</span></span><br><span class="line">      <span class="attr">sourceType</span>: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回选中照片的本地文件路径列表,tempFilePath可以作为img标签的src属性显示图片</span></span><br><span class="line">        <span class="keyword">var</span> tempFilePaths = res.<span class="property">tempFilePaths</span>;</span><br><span class="line">        _this.<span class="title function_">setData</span>(&#123;</span><br><span class="line">          <span class="attr">img</span>: tempFilePaths[<span class="number">0</span>],</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure><h2 id="步骤2"><a href="#步骤2" class="headerlink" title="步骤2:"></a>步骤2:</h2><p>早期在微信小程序中将图片base64化需要借助微信原生的 wx.canvasGetImageData 得到图片的像素信息，再通过开源库<a href="https://github.com/photopea/UPNG.js">UPNG</a>将像素信息编码，最后通过wx.arrayBufferToBase64转化为base64数据,看起来就挺麻烦的,我使用的调试基础库2.0.4,小程序有新接口获取图片base64编码，wx.getFileSystemManager() 注意版本库要在1.9.9以后的版本才支持<br><a href="https://developers.weixin.qq.com/miniprogram/dev/api/file/wx.getFileSystemManager.html">https://developers.weixin.qq.com/miniprogram/dev/api/file/wx.getFileSystemManager.html</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">getFileSystemManager</span>().<span class="title function_">readFile</span>(&#123;</span><br><span class="line">           <span class="attr">filePath</span>: _this.<span class="property">data</span>.<span class="property">img</span>, <span class="comment">// 选择图片返回的相对路径</span></span><br><span class="line">           <span class="attr">encoding</span>: <span class="string">&#x27;base64&#x27;</span>, <span class="comment">//编码格式</span></span><br><span class="line">           <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">             <span class="comment">// console.log(&#x27;data:image/png;base64,&#x27; + res.data)</span></span><br><span class="line">             _this.<span class="title function_">setData</span>(&#123;</span><br><span class="line">               <span class="attr">base64</span>: res.<span class="property">data</span>,</span><br><span class="line">             &#125;)</span><br><span class="line">             <span class="comment">//   &#125;</span></span><br><span class="line">             <span class="comment">// &#125;)</span></span><br></pre></td></tr></table></figure><h2 id="步骤3"><a href="#步骤3" class="headerlink" title="步骤3:"></a>步骤3:</h2><p>百度的api要求向API服务地址使用POST发送请求，必须在URL中带上参数access_token，没得办法要用人家的服务就得按规矩来,直接使用wx.request()发起一个网络请求<br><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wx<span class="selector-class">.request</span>(&#123;</span><br><span class="line">     url: <span class="string">&#x27;https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&amp;client_id=【百度云应用的AK】&amp;client_secret=【百度云应用的SK】&#x27;</span>,</span><br><span class="line">     <span class="selector-tag">header</span>: &#123;</span><br><span class="line">       <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     method: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">     <span class="built_in">success</span>(res) &#123;</span><br><span class="line">       _this<span class="selector-class">.setData</span>(&#123;</span><br><span class="line">         access_token: res<span class="selector-class">.data</span><span class="selector-class">.access_token</span>,</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><h2 id="步骤4"><a href="#步骤4" class="headerlink" title="步骤4:"></a>步骤4:</h2><p>带上access_token和图片base64编码请求人脸检测接口,还是一个wx.request()发起一个网络请求<br><a href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">               <span class="attr">url</span>: <span class="string">&#x27;https://aip.baidubce.com/rest/2.0/face/v3/detect&#x27;</span> + <span class="string">&#x27;?access_token=&#x27;</span> + _this.<span class="property">data</span>.<span class="property">access_token</span>,</span><br><span class="line">               <span class="attr">data</span>: &#123;</span><br><span class="line">                 <span class="comment">// image: _this.data.img,</span></span><br><span class="line">                 <span class="attr">image</span>: _this.<span class="property">data</span>.<span class="property">base64</span>,</span><br><span class="line">                 <span class="attr">image_type</span>: <span class="string">&#x27;BASE64&#x27;</span>,</span><br><span class="line">                 <span class="comment">// image_type:&#x27;URL&#x27;,</span></span><br><span class="line">                 <span class="attr">face_field</span>: <span class="string">&#x27;age,beauty,expression,face_shape,gender,glasses,landmark,race,quality,face_type&#x27;</span>,</span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">header</span>: &#123;</span><br><span class="line">                 <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">               <span class="title function_">success</span>(<span class="params">res</span>) &#123;</span><br><span class="line">                 wx.<span class="title function_">hideLoading</span>();</span><br><span class="line">                 <span class="comment">// console.log(res.data);</span></span><br><span class="line">                 <span class="keyword">var</span> data = res.<span class="property">data</span>;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;)</span><br></pre></td></tr></table></figure><p>完整参考代码 <a href="https://github.com/xmaihh/weixinxiaochengxu">weixinxiaochengxu</a></p><blockquote><blockquote><p>参考链接</p></blockquote></blockquote><p>[微信小程序图片压缩及base64化上传]<a href="https://zhuanlan.zhihu.com/p/37440710">https://zhuanlan.zhihu.com/p/37440710</a></p><p>[小程序选择相册后转为base64编码的方法]<a href="https://www.jianshu.com/p/5d99db6b6901">https://www.jianshu.com/p/5d99db6b6901</a></p><p>[小程序图片转Base64，方法总结]<a href="https://blog.csdn.net/qq_36875339/article/details/81086205">https://blog.csdn.net/qq_36875339/article/details/81086205</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> weixin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pip Import Error:cannot import name main解决方案</title>
      <link href="/blog/2018/10/13/pip-import-error-cannot-import-name-main-jie-jue-fang-an/"/>
      <url>/blog/2018/10/13/pip-import-error-cannot-import-name-main-jie-jue-fang-an/</url>
      
        <content type="html"><![CDATA[<p>在使用pip来进行安装操作时碰到这样的问题</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ pip install jrnl</span><br><span class="line">Traceback (most recent <span class="keyword">call</span> last):</span><br><span class="line">  File &quot;/usr/bin/pip&quot;, <span class="type">line</span> <span class="number">9</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">from</span> pip <span class="keyword">import</span> main</span><br><span class="line">ImportError: cannot <span class="keyword">import</span> <span class="type">name</span> main</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>是因为将pip更新为10.0.0后库里面的函数有所变动造成这个问题<br>解决方案：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /usr/bin/pip</span><br></pre></td></tr></table></figure><p>将原来的:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from pip import main</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sys.<span class="keyword">exit</span>(main())</span><br></pre></td></tr></table></figure><p>改成:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from pip import __main__</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sys.<span class="keyword">exit</span>(__main__._main())</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ArchLinux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android事件分发机制</title>
      <link href="/blog/2018/10/12/android-shi-jian-fen-fa-ji-zhi/"/>
      <url>/blog/2018/10/12/android-shi-jian-fen-fa-ji-zhi/</url>
      
        <content type="html"><![CDATA[<h1 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h1><ol><li>-&gt; dispatchTouchEvent()<br>-&gt; onInterceptTouchEvent()<br>-&gt; onTouchEvent()</li><li>requestDisallowInterceptTouchEvent(boolean)</li><li>onTouchEvent() –&gt; onTouchListener –&gt; onClickListener的先后顺序</li></ol><h1 id="什么是事件分发"><a href="#什么是事件分发" class="headerlink" title="什么是事件分发"></a>什么是事件分发</h1><p>Android中的视图是由一个个View嵌套构成的层级视图，即一个View里包含有子View，而这个子View里面又可以再添加View。当用户触摸屏幕产生一系列事件时，事件会由高到低，由外向内依次传递，最终把事件交到一个具体的View手上处理，这个传递的过程就叫做事件分发。</p><blockquote><p>Android将触摸事件统一封装成MontionEvent类，以Down事件开始，Up事件结束。</p></blockquote><h1 id="事件传递流程"><a href="#事件传递流程" class="headerlink" title="事件传递流程"></a>事件传递流程</h1><p>Android中事件传递是由最终的view的接收到,传递过程是从父布局到子布局,也就是从Activity到ViewGroup到View的过程。</p><p>View里,有两个回调函数</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;</span><br></pre></td></tr></table></figure><p>ViewGroup里,有三个回调函数</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;</span><br></pre></td></tr></table></figure><p>Activity里，有两个回调函数</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span></span>;  </span><br></pre></td></tr></table></figure><blockquote><p><code>dispatchTouchEvent</code>是处理触摸事件分发,事件(多数情况)是从Activity的<code>dispatchTouchEvent</code>开始的。执行<code>super.dispatchTouchEvent(ev)</code>,事件向下分发。<code>onInterceptTouchEvent</code>是ViewGroup提供的方法,默认返回false,返回true表示拦截。<code>onTouchEvent</code>是View中提供的方法,ViewGroup也有这个方法,view中不提供onInterceptTouchEvent。view中默认返回true,表示消费了这个事件.</p></blockquote><p><img src="https://github.com/xmaihh/xmaihh.github.io/raw/master/asset/Android-dispatch-touch-event.jpg" alt="Android事件分发"></p><p>(1) 事件从 Activity.dispatchTouchEvent()开始传递，只要没有被停止或拦截，从最上层的 View(ViewGroup)开始一直往下(子 View)传递。子 View 可以通过 onTouchEvent()对事件进行处理。</p><p>(2) 事件由父 View(ViewGroup)传递给子 View，ViewGroup 可以通过 onInterceptTouchEvent()对事件做拦截，停止其往下传递。</p><p>(3) 如果事件从上往下传递过程中一直没有被停止，且最底层子 View 没有消费事件，事件会反向往上传递，这时父 View(ViewGroup)可以进行消费，如果还是没有被消费的话，最后会到 Activity 的 onTouchEvent()函数。</p><p>(4) 如果 View 没有对 ACTION_DOWN 进行消费，之后的其他事件不会传递过来。</p><p>(5) OnTouchListener 优先于 onTouchEvent()对事件进行消费。<br>上面的消费即表示相应函数返回值为 true。</p><h1 id="requestDisallowInterceptTouchEvent-boolean"><a href="#requestDisallowInterceptTouchEvent-boolean" class="headerlink" title="requestDisallowInterceptTouchEvent(boolean)"></a>requestDisallowInterceptTouchEvent(boolean)</h1><p>对于底层的View来说，有一种方法可以阻止父层的View截获touch事件,就是调用<code>getParent().requestDisallowInterceptTouchEvent(true);</code>方法。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">onTouchEvent</span>(<span class="params"><span class="title class_">MotionEvent</span> event</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.<span class="title function_">getAction</span>())&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">MotionEvent</span>.<span class="property">ACTION_DOWN</span>:</span><br><span class="line">                <span class="title function_">getParent</span>().<span class="title function_">requestDisallowInterceptTouchEvent</span>(<span class="literal">true</span>);</span><br><span class="line">                <span class="title class_">Log</span>.<span class="title function_">d</span>(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;down&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">MotionEvent</span>.<span class="property">ACTION_UP</span>:</span><br><span class="line">                <span class="title class_">Log</span>.<span class="title function_">d</span>(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;up&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">MotionEvent</span>.<span class="property">ACTION_MOVE</span>:</span><br><span class="line">                <span class="title class_">Log</span>.<span class="title function_">d</span>(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;move&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>一旦底层View收到onTouchEvent的action后调用<code>getParent().requestDisallowInterceptTouchEvent(true)</code>那么父层View就不会再调用onInterceptTouchEvent了,典型应用就是在处理滑动冲突的时候使用。</p><h1 id="onTouchEvent-–-onTouchListener-–-onClickListener的先后顺序"><a href="#onTouchEvent-–-onTouchListener-–-onClickListener的先后顺序" class="headerlink" title="onTouchEvent() –&gt; onTouchListener –&gt; onClickListener的先后顺序"></a>onTouchEvent() –&gt; onTouchListener –&gt; onClickListener的先后顺序</h1><p>View的dispatchTouchEvent()方法，意味将准备开始处理事件</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> boolean <span class="title">dispatchTouchEvent</span>(<span class="params">MontionEvent <span class="keyword">event</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="keyword">if</span> (li != <span class="literal">null</span> &amp;&amp; li.mOnTouchListener != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">            &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, <span class="keyword">event</span>)) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(<span class="keyword">event</span>)) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们给View设置了onTouchListener监听器，则优先会回调Listener的onTouch()方法。如果onTouch()方法返回了false,则还是会执行onTouchEvent()方法。通常我们给View设置的onClickListener，就是在onTouchEvent()方法中的Up事件处理的。所以onTouchListener优先级大于onClickListener</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">switch</span> (action) &#123;</span><br><span class="line">    case MotionEvent<span class="selector-class">.ACTION_UP</span>:</span><br><span class="line">    </span><br><span class="line">    if (!<span class="built_in">post</span>(mPerformClick)) &#123;</span><br><span class="line">    <span class="comment">//该方法里会回调onClick()</span></span><br><span class="line">    <span class="built_in">performClick</span>();</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>View的CLICKABLE属性要为ture，View才能消费上事件。不然onTouchEvent()会执行结束返回false，没有机会消费事件。当我们给View设置监听器后，就会将CLICKABLE属性设为true。(Button默认为ture)</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">            || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line">    <span class="comment">//View,setEnable()后还是能处理事件。如果我们有给View设置监听器，该事件被消费。</span></span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">setPressed</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">        <span class="keyword">return</span> clickable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以按照 onTouchEvent() –&gt; onTouchListener –&gt; onClickListener的先后顺序来执行的。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通讯帧格式之CRC校验</title>
      <link href="/blog/2018/10/10/tong-xun-zheng-ge-shi-zhi-crc-xiao-yan/"/>
      <url>/blog/2018/10/10/tong-xun-zheng-ge-shi-zhi-crc-xiao-yan/</url>
      
        <content type="html"><![CDATA[<p>CRC即循环冗余校验码（Cyclic Redundancy Check <a href="https://baike.baidu.com/item/crc%E6%A0%A1%E9%AA%8C">1</a>  ）：是数据通信领域中最常用的一种查错校验码，其特征是信息字段和校验字段的长度可以任意选定。循环冗余检查（CRC）是一种数据传输检错功能，对数据进行多项式计算，并将得到的结果附在帧的后面，接收设备也执行类似的算法，以保证数据传输的正确性和完整性。<br>CRC校验的原理即通信双方规定一个二进制除数，传输帧必须能够被其整除，否则说明出错。</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>Had</td><td>Length</td><td>Address</td><td>Command</td><td>CRC1</td><td>Data</td><td>CRC2</td></tr><tr><td>0xaa 0x55</td><td>1 byte</td><td>address</td><td>CMD</td><td>1 byte</td><td>n bytes</td><td>1 byte</td></tr></tbody></table><ul><li>Head： 2个字节，默认0xaa, 0x55，代表帧头，是大端模块式。0x55, 0xaa，代表小端模式。不同模式的数据在系统内的排列方式。例如：数据为0x1234，在大端模式时数据排列方式为0x12，0x34，MSB字节在低地址。小端模式时数据排列方式为0x34，0x12，MSB字节在高地址。大端模式应答帧的帧头为0xa5, 0x5a，小端模式的应答帧头为：0x5a, 0xa5。</li><li>Length： 1个字节，是此通讯帧的长度。范围6-255，Length 为所有字节的长度，包括HEAD,Length,Command,CRC1,Data,CRC2。</li><li>Address：1个字节，此为各个从机模块的地址。</li><li>Command：1个字节，是主&#x2F;从机通讯的命令，即主机要求从机进行操作的操作码。命令范围是0X01~0x7f。</li><li>CRC1： 1个字节，是head, length, command这4个字节的CRC校验码。因为数据的长度异常重要，一旦此数据出错误，程序处理不当，将会带来灾难性的后果。所以单独对长度和操作码做了一次CRC校验。如果是命令帧，该校验字段就会与后面的CRC2合并。</li><li>Data：N个字节，是通讯的数据包，根据协议版本及操作码的不同，数据内容有所不同。</li><li>CRC2： 1个字节，是所有字段的CRC校验码。</li></ul><p>CRC8的校验方式，具体如下表：</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const uint8_t nCrc8Tab[] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x5e</span>,<span class="number">0xbc</span>,<span class="number">0xe2</span>,<span class="number">0x61</span>,<span class="number">0x3f</span>,<span class="number">0xdd</span>,<span class="number">0x83</span>,<span class="number">0xc2</span>,<span class="number">0x9c</span>,<span class="number">0x7e</span>,<span class="number">0x20</span>,<span class="number">0xa3</span>,<span class="number">0xfd</span>,<span class="number">0x1f</span>,<span class="number">0x41</span>,</span><br><span class="line">    <span class="number">0x9d</span>,<span class="number">0xc3</span>,<span class="number">0x21</span>,<span class="number">0x7f</span>,<span class="number">0xfc</span>,<span class="number">0xa2</span>,<span class="number">0x40</span>,<span class="number">0x1e</span>,<span class="number">0x5f</span>,<span class="number">0x01</span>,<span class="number">0xe3</span>,<span class="number">0xbd</span>,<span class="number">0x3e</span>,<span class="number">0x60</span>,<span class="number">0x82</span>,<span class="number">0xdc</span>,</span><br><span class="line">    <span class="number">0x23</span>,<span class="number">0x7d</span>,<span class="number">0x9f</span>,<span class="number">0xc1</span>,<span class="number">0x42</span>,<span class="number">0x1c</span>,<span class="number">0xfe</span>,<span class="number">0xa0</span>,<span class="number">0xe1</span>,<span class="number">0xbf</span>,<span class="number">0x5d</span>,<span class="number">0x03</span>,<span class="number">0x80</span>,<span class="number">0xde</span>,<span class="number">0x3c</span>,<span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0xbe</span>,<span class="number">0xe0</span>,<span class="number">0x02</span>,<span class="number">0x5c</span>,<span class="number">0xdf</span>,<span class="number">0x81</span>,<span class="number">0x63</span>,<span class="number">0x3d</span>,<span class="number">0x7c</span>,<span class="number">0x22</span>,<span class="number">0xc0</span>,<span class="number">0x9e</span>,<span class="number">0x1d</span>,<span class="number">0x43</span>,<span class="number">0xa1</span>,<span class="number">0xff</span>,</span><br><span class="line">    <span class="number">0x46</span>,<span class="number">0x18</span>,<span class="number">0xfa</span>,<span class="number">0xa4</span>,<span class="number">0x27</span>,<span class="number">0x79</span>,<span class="number">0x9b</span>,<span class="number">0xc5</span>,<span class="number">0x84</span>,<span class="number">0xda</span>,<span class="number">0x38</span>,<span class="number">0x66</span>,<span class="number">0xe5</span>,<span class="number">0xbb</span>,<span class="number">0x59</span>,<span class="number">0x07</span>,</span><br><span class="line">    <span class="number">0xdb</span>,<span class="number">0x85</span>,<span class="number">0x67</span>,<span class="number">0x39</span>,<span class="number">0xba</span>,<span class="number">0xe4</span>,<span class="number">0x06</span>,<span class="number">0x58</span>,<span class="number">0x19</span>,<span class="number">0x47</span>,<span class="number">0xa5</span>,<span class="number">0xfb</span>,<span class="number">0x78</span>,<span class="number">0x26</span>,<span class="number">0xc4</span>,<span class="number">0x9a</span>,</span><br><span class="line">    <span class="number">0x65</span>,<span class="number">0x3b</span>,<span class="number">0xd9</span>,<span class="number">0x87</span>,<span class="number">0x04</span>,<span class="number">0x5a</span>,<span class="number">0xb8</span>,<span class="number">0xe6</span>,<span class="number">0xa7</span>,<span class="number">0xf9</span>,<span class="number">0x1b</span>,<span class="number">0x45</span>,<span class="number">0xc6</span>,<span class="number">0x98</span>,<span class="number">0x7a</span>,<span class="number">0x24</span>,</span><br><span class="line">    <span class="number">0xf8</span>,<span class="number">0xa6</span>,<span class="number">0x44</span>,<span class="number">0x1a</span>,<span class="number">0x99</span>,<span class="number">0xc7</span>,<span class="number">0x25</span>,<span class="number">0x7b</span>,<span class="number">0x3a</span>,<span class="number">0x64</span>,<span class="number">0x86</span>,<span class="number">0xd8</span>,<span class="number">0x5b</span>,<span class="number">0x05</span>,<span class="number">0xe7</span>,<span class="number">0xb9</span>,</span><br><span class="line">    <span class="number">0x8c</span>,<span class="number">0xd2</span>,<span class="number">0x30</span>,<span class="number">0x6e</span>,<span class="number">0xed</span>,<span class="number">0xb3</span>,<span class="number">0x51</span>,<span class="number">0x0f</span>,<span class="number">0x4e</span>,<span class="number">0x10</span>,<span class="number">0xf2</span>,<span class="number">0xac</span>,<span class="number">0x2f</span>,<span class="number">0x71</span>,<span class="number">0x93</span>,<span class="number">0xcd</span>,</span><br><span class="line">    <span class="number">0x11</span>,<span class="number">0x4f</span>,<span class="number">0xad</span>,<span class="number">0xf3</span>,<span class="number">0x70</span>,<span class="number">0x2e</span>,<span class="number">0xcc</span>,<span class="number">0x92</span>,<span class="number">0xd3</span>,<span class="number">0x8d</span>,<span class="number">0x6f</span>,<span class="number">0x31</span>,<span class="number">0xb2</span>,<span class="number">0xec</span>,<span class="number">0x0e</span>,<span class="number">0x50</span>,</span><br><span class="line">    <span class="number">0xaf</span>,<span class="number">0xf1</span>,<span class="number">0x13</span>,<span class="number">0x4d</span>,<span class="number">0xce</span>,<span class="number">0x90</span>,<span class="number">0x72</span>,<span class="number">0x2c</span>,<span class="number">0x6d</span>,<span class="number">0x33</span>,<span class="number">0xd1</span>,<span class="number">0x8f</span>,<span class="number">0x0c</span>,<span class="number">0x52</span>,<span class="number">0xb0</span>,<span class="number">0xee</span>,</span><br><span class="line">    <span class="number">0x32</span>,<span class="number">0x6c</span>,<span class="number">0x8e</span>,<span class="number">0xd0</span>,<span class="number">0x53</span>,<span class="number">0x0d</span>,<span class="number">0xef</span>,<span class="number">0xb1</span>,<span class="number">0xf0</span>,<span class="number">0xae</span>,<span class="number">0x4c</span>,<span class="number">0x12</span>,<span class="number">0x91</span>,<span class="number">0xcf</span>,<span class="number">0x2d</span>,<span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0xca</span>,<span class="number">0x94</span>,<span class="number">0x76</span>,<span class="number">0x28</span>,<span class="number">0xab</span>,<span class="number">0xf5</span>,<span class="number">0x17</span>,<span class="number">0x49</span>,<span class="number">0x08</span>,<span class="number">0x56</span>,<span class="number">0xb4</span>,<span class="number">0xea</span>,<span class="number">0x69</span>,<span class="number">0x37</span>,<span class="number">0xd5</span>,<span class="number">0x8b</span>,</span><br><span class="line">    <span class="number">0x57</span>,<span class="number">0x09</span>,<span class="number">0xeb</span>,<span class="number">0xb5</span>,<span class="number">0x36</span>,<span class="number">0x68</span>,<span class="number">0x8a</span>,<span class="number">0xd4</span>,<span class="number">0x95</span>,<span class="number">0xcb</span>,<span class="number">0x29</span>,<span class="number">0x77</span>,<span class="number">0xf4</span>,<span class="number">0xaa</span>,<span class="number">0x48</span>,<span class="number">0x16</span>,</span><br><span class="line">    <span class="number">0xe9</span>,<span class="number">0xb7</span>,<span class="number">0x55</span>,<span class="number">0x0b</span>,<span class="number">0x88</span>,<span class="number">0xd6</span>,<span class="number">0x34</span>,<span class="number">0x6a</span>,<span class="number">0x2b</span>,<span class="number">0x75</span>,<span class="number">0x97</span>,<span class="number">0xc9</span>,<span class="number">0x4a</span>,<span class="number">0x14</span>,<span class="number">0xf6</span>,<span class="number">0xa8</span>,</span><br><span class="line">    <span class="number">0x74</span>,<span class="number">0x2a</span>,<span class="number">0xc8</span>,<span class="number">0x96</span>,<span class="number">0x15</span>,<span class="number">0x4b</span>,<span class="number">0xa9</span>,<span class="number">0xf7</span>,<span class="number">0xb6</span>,<span class="number">0xe8</span>,<span class="number">0x0a</span>,<span class="number">0x54</span>,<span class="number">0xd7</span>,<span class="number">0x89</span>,<span class="number">0x6b</span>,<span class="number">0x35</span>,</span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>  CRC8计算函数</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">uint8_t</span>  CalCrc8(uint8_t *pBuf,uint8_t nBufLen)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">uint8_t</span>  nCrcVal = 0x00;</span><br><span class="line">    <span class="attribute">uint8_t</span>  i;</span><br><span class="line">    <span class="attribute">uint8_t</span>  nTabIdx;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">if</span> (pBuf &amp;&amp; (nBufLen &gt; <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attribute">for</span> (i = <span class="number">0</span>; <span class="attribute">i</span> &lt; nBufLen; <span class="attribute">i</span> ++)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attribute">nTabIdx</span> = (*(pBuf+i))<span class="regexp"> ^</span> nCrcVal;</span><br><span class="line">        <span class="attribute">nCrcVal</span> = nCrc8Tab[nTabIdx];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line"><span class="attribute">return</span> nCrcVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>附上java版本:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">package <span class="keyword">bp.comm.project.util;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CRC8相关计算</span></span><br><span class="line"><span class="comment"> * CRC-8  X8+X5+X4+1       100110001</span></span><br><span class="line"><span class="comment"> * encode: utf-8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public class CRC8 &#123;</span><br><span class="line">    static <span class="keyword">byte[] </span>crc8_tab = &#123;</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x00</span>, (<span class="keyword">byte) </span><span class="number">0x5e</span>, (<span class="keyword">byte) </span><span class="number">0xbc</span>, (<span class="keyword">byte) </span><span class="number">0xe2</span>, (<span class="keyword">byte) </span><span class="number">0x61</span>, (<span class="keyword">byte) </span><span class="number">0x3f</span>, (<span class="keyword">byte) </span><span class="number">0xdd</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x83</span>, (<span class="keyword">byte) </span><span class="number">0xc2</span>, (<span class="keyword">byte) </span><span class="number">0x9c</span>, (<span class="keyword">byte) </span><span class="number">0x7e</span>, (<span class="keyword">byte) </span><span class="number">0x20</span>, (<span class="keyword">byte) </span><span class="number">0xa3</span>, (<span class="keyword">byte) </span><span class="number">0xfd</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x1f</span>, (<span class="keyword">byte) </span><span class="number">0x41</span>, (<span class="keyword">byte) </span><span class="number">0x9d</span>, (<span class="keyword">byte) </span><span class="number">0xc3</span>, (<span class="keyword">byte) </span><span class="number">0x21</span>, (<span class="keyword">byte) </span><span class="number">0x7f</span>, (<span class="keyword">byte) </span><span class="number">0xfc</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xa2</span>, (<span class="keyword">byte) </span><span class="number">0x40</span>, (<span class="keyword">byte) </span><span class="number">0x1e</span>, (<span class="keyword">byte) </span><span class="number">0x5f</span>, (<span class="keyword">byte) </span><span class="number">0x01</span>, (<span class="keyword">byte) </span><span class="number">0xe3</span>, (<span class="keyword">byte) </span><span class="number">0xbd</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x3e</span>, (<span class="keyword">byte) </span><span class="number">0x60</span>, (<span class="keyword">byte) </span><span class="number">0x82</span>, (<span class="keyword">byte) </span><span class="number">0xdc</span>, (<span class="keyword">byte) </span><span class="number">0x23</span>, (<span class="keyword">byte) </span><span class="number">0x7d</span>, (<span class="keyword">byte) </span><span class="number">0x9f</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xc1</span>, (<span class="keyword">byte) </span><span class="number">0x42</span>, (<span class="keyword">byte) </span><span class="number">0x1c</span>, (<span class="keyword">byte) </span><span class="number">0xfe</span>, (<span class="keyword">byte) </span><span class="number">0xa0</span>, (<span class="keyword">byte) </span><span class="number">0xe1</span>, (<span class="keyword">byte) </span><span class="number">0xbf</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x5d</span>, (<span class="keyword">byte) </span><span class="number">0x03</span>, (<span class="keyword">byte) </span><span class="number">0x80</span>, (<span class="keyword">byte) </span><span class="number">0xde</span>, (<span class="keyword">byte) </span><span class="number">0x3c</span>, (<span class="keyword">byte) </span><span class="number">0x62</span>, (<span class="keyword">byte) </span><span class="number">0xbe</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xe0</span>, (<span class="keyword">byte) </span><span class="number">0x02</span>, (<span class="keyword">byte) </span><span class="number">0x5c</span>, (<span class="keyword">byte) </span><span class="number">0xdf</span>, (<span class="keyword">byte) </span><span class="number">0x81</span>, (<span class="keyword">byte) </span><span class="number">0x63</span>, (<span class="keyword">byte) </span><span class="number">0x3d</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x7c</span>, (<span class="keyword">byte) </span><span class="number">0x22</span>, (<span class="keyword">byte) </span><span class="number">0xc0</span>, (<span class="keyword">byte) </span><span class="number">0x9e</span>, (<span class="keyword">byte) </span><span class="number">0x1d</span>, (<span class="keyword">byte) </span><span class="number">0x43</span>, (<span class="keyword">byte) </span><span class="number">0xa1</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xff</span>, (<span class="keyword">byte) </span><span class="number">0x46</span>, (<span class="keyword">byte) </span><span class="number">0x18</span>, (<span class="keyword">byte) </span><span class="number">0xfa</span>, (<span class="keyword">byte) </span><span class="number">0xa4</span>, (<span class="keyword">byte) </span><span class="number">0x27</span>, (<span class="keyword">byte) </span><span class="number">0x79</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x9b</span>, (<span class="keyword">byte) </span><span class="number">0xc5</span>, (<span class="keyword">byte) </span><span class="number">0x84</span>, (<span class="keyword">byte) </span><span class="number">0xda</span>, (<span class="keyword">byte) </span><span class="number">0x38</span>, (<span class="keyword">byte) </span><span class="number">0x66</span>, (<span class="keyword">byte) </span><span class="number">0xe5</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xbb</span>, (<span class="keyword">byte) </span><span class="number">0x59</span>, (<span class="keyword">byte) </span><span class="number">0x07</span>, (<span class="keyword">byte) </span><span class="number">0xdb</span>, (<span class="keyword">byte) </span><span class="number">0x85</span>, (<span class="keyword">byte) </span><span class="number">0x67</span>, (<span class="keyword">byte) </span><span class="number">0x39</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xba</span>, (<span class="keyword">byte) </span><span class="number">0xe4</span>, (<span class="keyword">byte) </span><span class="number">0x06</span>, (<span class="keyword">byte) </span><span class="number">0x58</span>, (<span class="keyword">byte) </span><span class="number">0x19</span>, (<span class="keyword">byte) </span><span class="number">0x47</span>, (<span class="keyword">byte) </span><span class="number">0xa5</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xfb</span>, (<span class="keyword">byte) </span><span class="number">0x78</span>, (<span class="keyword">byte) </span><span class="number">0x26</span>, (<span class="keyword">byte) </span><span class="number">0xc4</span>, (<span class="keyword">byte) </span><span class="number">0x9a</span>, (<span class="keyword">byte) </span><span class="number">0x65</span>, (<span class="keyword">byte) </span><span class="number">0x3b</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xd9</span>, (<span class="keyword">byte) </span><span class="number">0x87</span>, (<span class="keyword">byte) </span><span class="number">0x04</span>, (<span class="keyword">byte) </span><span class="number">0x5a</span>, (<span class="keyword">byte) </span><span class="number">0xb8</span>, (<span class="keyword">byte) </span><span class="number">0xe6</span>, (<span class="keyword">byte) </span><span class="number">0xa7</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xf9</span>, (<span class="keyword">byte) </span><span class="number">0x1b</span>, (<span class="keyword">byte) </span><span class="number">0x45</span>, (<span class="keyword">byte) </span><span class="number">0xc6</span>, (<span class="keyword">byte) </span><span class="number">0x98</span>, (<span class="keyword">byte) </span><span class="number">0x7a</span>, (<span class="keyword">byte) </span><span class="number">0x24</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xf8</span>, (<span class="keyword">byte) </span><span class="number">0xa6</span>, (<span class="keyword">byte) </span><span class="number">0x44</span>, (<span class="keyword">byte) </span><span class="number">0x1a</span>, (<span class="keyword">byte) </span><span class="number">0x99</span>, (<span class="keyword">byte) </span><span class="number">0xc7</span>, (<span class="keyword">byte) </span><span class="number">0x25</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x7b</span>, (<span class="keyword">byte) </span><span class="number">0x3a</span>, (<span class="keyword">byte) </span><span class="number">0x64</span>, (<span class="keyword">byte) </span><span class="number">0x86</span>, (<span class="keyword">byte) </span><span class="number">0xd8</span>, (<span class="keyword">byte) </span><span class="number">0x5b</span>, (<span class="keyword">byte) </span><span class="number">0x05</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xe7</span>, (<span class="keyword">byte) </span><span class="number">0xb9</span>, (<span class="keyword">byte) </span><span class="number">0x8c</span>, (<span class="keyword">byte) </span><span class="number">0xd2</span>, (<span class="keyword">byte) </span><span class="number">0x30</span>, (<span class="keyword">byte) </span><span class="number">0x6e</span>, (<span class="keyword">byte) </span><span class="number">0xed</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xb3</span>, (<span class="keyword">byte) </span><span class="number">0x51</span>, (<span class="keyword">byte) </span><span class="number">0x0f</span>, (<span class="keyword">byte) </span><span class="number">0x4e</span>, (<span class="keyword">byte) </span><span class="number">0x10</span>, (<span class="keyword">byte) </span><span class="number">0xf2</span>, (<span class="keyword">byte) </span><span class="number">0xac</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x2f</span>, (<span class="keyword">byte) </span><span class="number">0x71</span>, (<span class="keyword">byte) </span><span class="number">0x93</span>, (<span class="keyword">byte) </span><span class="number">0xcd</span>, (<span class="keyword">byte) </span><span class="number">0x11</span>, (<span class="keyword">byte) </span><span class="number">0x4f</span>, (<span class="keyword">byte) </span><span class="number">0xad</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xf3</span>, (<span class="keyword">byte) </span><span class="number">0x70</span>, (<span class="keyword">byte) </span><span class="number">0x2e</span>, (<span class="keyword">byte) </span><span class="number">0xcc</span>, (<span class="keyword">byte) </span><span class="number">0x92</span>, (<span class="keyword">byte) </span><span class="number">0xd3</span>, (<span class="keyword">byte) </span><span class="number">0x8d</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x6f</span>, (<span class="keyword">byte) </span><span class="number">0x31</span>, (<span class="keyword">byte) </span><span class="number">0xb2</span>, (<span class="keyword">byte) </span><span class="number">0xec</span>, (<span class="keyword">byte) </span><span class="number">0x0e</span>, (<span class="keyword">byte) </span><span class="number">0x50</span>, (<span class="keyword">byte) </span><span class="number">0xaf</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xf1</span>, (<span class="keyword">byte) </span><span class="number">0x13</span>, (<span class="keyword">byte) </span><span class="number">0x4d</span>, (<span class="keyword">byte) </span><span class="number">0xce</span>, (<span class="keyword">byte) </span><span class="number">0x90</span>, (<span class="keyword">byte) </span><span class="number">0x72</span>, (<span class="keyword">byte) </span><span class="number">0x2c</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x6d</span>, (<span class="keyword">byte) </span><span class="number">0x33</span>, (<span class="keyword">byte) </span><span class="number">0xd1</span>, (<span class="keyword">byte) </span><span class="number">0x8f</span>, (<span class="keyword">byte) </span><span class="number">0x0c</span>, (<span class="keyword">byte) </span><span class="number">0x52</span>, (<span class="keyword">byte) </span><span class="number">0xb0</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xee</span>, (<span class="keyword">byte) </span><span class="number">0x32</span>, (<span class="keyword">byte) </span><span class="number">0x6c</span>, (<span class="keyword">byte) </span><span class="number">0x8e</span>, (<span class="keyword">byte) </span><span class="number">0xd0</span>, (<span class="keyword">byte) </span><span class="number">0x53</span>, (<span class="keyword">byte) </span><span class="number">0x0d</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xef</span>, (<span class="keyword">byte) </span><span class="number">0xb1</span>, (<span class="keyword">byte) </span><span class="number">0xf0</span>, (<span class="keyword">byte) </span><span class="number">0xae</span>, (<span class="keyword">byte) </span><span class="number">0x4c</span>, (<span class="keyword">byte) </span><span class="number">0x12</span>, (<span class="keyword">byte) </span><span class="number">0x91</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xcf</span>, (<span class="keyword">byte) </span><span class="number">0x2d</span>, (<span class="keyword">byte) </span><span class="number">0x73</span>, (<span class="keyword">byte) </span><span class="number">0xca</span>, (<span class="keyword">byte) </span><span class="number">0x94</span>, (<span class="keyword">byte) </span><span class="number">0x76</span>, (<span class="keyword">byte) </span><span class="number">0x28</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xab</span>, (<span class="keyword">byte) </span><span class="number">0xf5</span>, (<span class="keyword">byte) </span><span class="number">0x17</span>, (<span class="keyword">byte) </span><span class="number">0x49</span>, (<span class="keyword">byte) </span><span class="number">0x08</span>, (<span class="keyword">byte) </span><span class="number">0x56</span>, (<span class="keyword">byte) </span><span class="number">0xb4</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xea</span>, (<span class="keyword">byte) </span><span class="number">0x69</span>, (<span class="keyword">byte) </span><span class="number">0x37</span>, (<span class="keyword">byte) </span><span class="number">0xd5</span>, (<span class="keyword">byte) </span><span class="number">0x8b</span>, (<span class="keyword">byte) </span><span class="number">0x57</span>, (<span class="keyword">byte) </span><span class="number">0x09</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xeb</span>, (<span class="keyword">byte) </span><span class="number">0xb5</span>, (<span class="keyword">byte) </span><span class="number">0x36</span>, (<span class="keyword">byte) </span><span class="number">0x68</span>, (<span class="keyword">byte) </span><span class="number">0x8a</span>, (<span class="keyword">byte) </span><span class="number">0xd4</span>, (<span class="keyword">byte) </span><span class="number">0x95</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xcb</span>, (<span class="keyword">byte) </span><span class="number">0x29</span>, (<span class="keyword">byte) </span><span class="number">0x77</span>, (<span class="keyword">byte) </span><span class="number">0xf4</span>, (<span class="keyword">byte) </span><span class="number">0xaa</span>, (<span class="keyword">byte) </span><span class="number">0x48</span>, (<span class="keyword">byte) </span><span class="number">0x16</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xe9</span>, (<span class="keyword">byte) </span><span class="number">0xb7</span>, (<span class="keyword">byte) </span><span class="number">0x55</span>, (<span class="keyword">byte) </span><span class="number">0x0b</span>, (<span class="keyword">byte) </span><span class="number">0x88</span>, (<span class="keyword">byte) </span><span class="number">0xd6</span>, (<span class="keyword">byte) </span><span class="number">0x34</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x6a</span>, (<span class="keyword">byte) </span><span class="number">0x2b</span>, (<span class="keyword">byte) </span><span class="number">0x75</span>, (<span class="keyword">byte) </span><span class="number">0x97</span>, (<span class="keyword">byte) </span><span class="number">0xc9</span>, (<span class="keyword">byte) </span><span class="number">0x4a</span>, (<span class="keyword">byte) </span><span class="number">0x14</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xf6</span>, (<span class="keyword">byte) </span><span class="number">0xa8</span>, (<span class="keyword">byte) </span><span class="number">0x74</span>, (<span class="keyword">byte) </span><span class="number">0x2a</span>, (<span class="keyword">byte) </span><span class="number">0xc8</span>, (<span class="keyword">byte) </span><span class="number">0x96</span>, (<span class="keyword">byte) </span><span class="number">0x15</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0x4b</span>, (<span class="keyword">byte) </span><span class="number">0xa9</span>, (<span class="keyword">byte) </span><span class="number">0xf7</span>, (<span class="keyword">byte) </span><span class="number">0xb6</span>, (<span class="keyword">byte) </span><span class="number">0xe8</span>, (<span class="keyword">byte) </span><span class="number">0x0a</span>, (<span class="keyword">byte) </span><span class="number">0x54</span>,</span><br><span class="line">            (<span class="keyword">byte) </span><span class="number">0xd7</span>, (<span class="keyword">byte) </span><span class="number">0x89</span>, (<span class="keyword">byte) </span><span class="number">0x6b</span>, (<span class="keyword">byte) </span><span class="number">0x35</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算数组的CRC8校验值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param data 需要计算的数组</span></span><br><span class="line"><span class="comment">     * @return CRC8校验值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public static <span class="keyword">byte </span>calcCrc(<span class="keyword">byte[] </span>data) &#123;</span><br><span class="line">        return calcCrc8(data, <span class="number">0</span>, data.length, (<span class="keyword">byte) </span><span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算CRC8校验值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param data   数据</span></span><br><span class="line"><span class="comment">     * @param offset 起始位置</span></span><br><span class="line"><span class="comment">     * @param len    长度</span></span><br><span class="line"><span class="comment">     * @return 校验值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public static <span class="keyword">byte </span>calcCrc8(<span class="keyword">byte[] </span>data, int offset, int len) &#123;</span><br><span class="line">        return calcCrc8(data, offset, len, (<span class="keyword">byte) </span><span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算CRC8校验值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param data   数据</span></span><br><span class="line"><span class="comment">     * @param offset 起始位置</span></span><br><span class="line"><span class="comment">     * @param len    长度</span></span><br><span class="line"><span class="comment">     * @param preval 之前的校验值</span></span><br><span class="line"><span class="comment">     * @return 校验值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public static <span class="keyword">byte </span>calcCrc8(<span class="keyword">byte[] </span>data, int offset, int len, <span class="keyword">byte </span>preval) &#123;</span><br><span class="line">        <span class="keyword">byte </span>ret = preval;</span><br><span class="line">        for (int i = offset<span class="comment">; i &lt; (offset + len); ++i) &#123;</span></span><br><span class="line">            ret = crc8_tab[(<span class="number">0x00ff</span> &amp; (ret ^ data[i]))];</span><br><span class="line">        &#125;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jni </tag>
            
            <tag> C/C++ </tag>
            
            <tag> CRC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C-数据类型uint8_t、uint16_t、uint32_t、uint64_t、size_t、ssize_t</title>
      <link href="/blog/2018/10/08/c-shu-ju-lei-xing-uint8-t-uint16-t-uint32-t-uint64-t-size-t-ssize-t/"/>
      <url>/blog/2018/10/08/c-shu-ju-lei-xing-uint8-t-uint16-t-uint32-t-uint64-t-size-t-ssize-t/</url>
      
        <content type="html"><![CDATA[<h2 id="C语言6种基本数据类型"><a href="#C语言6种基本数据类型" class="headerlink" title="C语言6种基本数据类型"></a>C语言6种基本数据类型</h2><ol><li>整型：short、int、long</li><li>浮点型：float、double</li><li>字符类型：char</li></ol><p>typedef用来定义关键字或标识符的别名</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">double</span> wages;</span><br><span class="line"><span class="keyword">typedef</span> wages salary;</span><br></pre></td></tr></table></figure><p>一般整形对应的*_t类型为：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>字节     <span class="built_in">uint8</span>_t</span><br><span class="line"><span class="number">2</span>字节     <span class="built_in">uint16</span>_t</span><br><span class="line"><span class="number">4</span>字节     <span class="built_in">uint32</span>_t</span><br><span class="line"><span class="number">8</span>字节     <span class="built_in">uint64</span>_t</span><br></pre></td></tr></table></figure><p>ssize_t是signed size_t，<br>size_t是标准C库中定义的，应为unsigned int。定义为typedef int ssize_t。<br>而ssize_t:这个数据类型用来表示可以被执行读写操作的数据块的大小.它和size_t类似,但必需是signed.意即：它表示的是sign size_t类型的。<br>size_t是一些C&#x2F;C++标准在stddef.h中定义的。这个类型足以用来表示对象的大小。<br>size_t的真实类型与操作系统有关，在32位架构中被普遍定义为：<br>typedef   unsigned int size_t;<br>而在64位架构中被定义为：<br>typedef  unsigned long size_t;<br>size_t在32位架构上是4字节，在64位架构上是8字节，在不同架构上进行编译时需要注意这个问题。<br>而int在不同架构下都是4字节，与size_t不同；且int为带符号数，size_t为无符号数</p><p>附：C99标准中inttypes.h的内容<br>在C99标准中定义了这些数据类型，具体定义在：&#x2F;usr&#x2F;include&#x2F;stdint.h    ISO C99: 7.18 Integer types</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __int8_t_defined  </span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __int8_t_defined  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">char</span>             <span class="type">int8_t</span>;   </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">short</span> <span class="type">int</span>               <span class="type">int16_t</span>;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span>                     <span class="type">int32_t</span>;  </span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __WORDSIZE == 64  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">int</span>                <span class="type">int64_t</span>;  </span><br><span class="line"><span class="meta"># <span class="keyword">else</span>  </span></span><br><span class="line">__extension__  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span>           <span class="type">int64_t</span>;  </span><br><span class="line"><span class="meta"># <span class="keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>      </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span>           <span class="type">uint8_t</span>;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span>      <span class="type">uint16_t</span>;  </span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __uint32_t_defined  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span>            <span class="type">uint32_t</span>;  </span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __uint32_t_defined  </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __WORDSIZE == 64  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span>       <span class="type">uint64_t</span>;  </span><br><span class="line"><span class="meta">#<span class="keyword">else</span>  </span></span><br><span class="line">__extension__  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span>  <span class="type">uint64_t</span>;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure><h2 id="格式化输出"><a href="#格式化输出" class="headerlink" title="格式化输出"></a>格式化输出</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ui<span class="symbol">nt16</span>_t <span class="meta">%</span>hu</span><br><span class="line">ui<span class="symbol">nt32</span>_t <span class="meta">%</span>u</span><br><span class="line">ui<span class="symbol">nt64</span>_t <span class="meta">%</span>llu</span><br></pre></td></tr></table></figure><h2 id="uint8-t类型的输出"><a href="#uint8-t类型的输出" class="headerlink" title="uint8_t类型的输出"></a>uint8_t类型的输出</h2><p>注意uint8_t的定义为</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span>           <span class="type">uint8_t</span>;</span><br></pre></td></tr></table></figure><p>uint8_t实际上是一个char。所以输出uint8_t类型的变量实际上输出其对应的字符，而不是数值。例：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint8_t num <span class="operator">=</span> <span class="number">67</span><span class="comment">;</span></span><br><span class="line">cout &lt;&lt; num &lt;&lt; endl<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>输出结果：C</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android视图Activiy、PhoneWindow、DecorView和ViewRoot</title>
      <link href="/blog/2018/10/06/android-shi-tu-activiy-phonewindow-decorview-he-viewroot/"/>
      <url>/blog/2018/10/06/android-shi-tu-activiy-phonewindow-decorview-he-viewroot/</url>
      
        <content type="html"><![CDATA[<h2 id="概念简介"><a href="#概念简介" class="headerlink" title="概念简介"></a>概念简介</h2><ul><li>Activity : 控制生命周期和处理事件</li><li>Window : 视图承载器</li><li>DecorView : Android视图树的根节点视图,顶级View</li><li>ViewRoot : 执行或传递所有View的绘制以及事件分发等交互<br><img src="https://github.com/xmaihh/xmaihh.github.io/raw/master/asset/Activity-PhoneWindo-DecorView-ViewRoot.webp" alt="Android视图结构"><br><img src="https://i.loli.net/2018/12/17/5c16fe0012986.png"><br>Activity并不负责视图控制，它只是控制生命周期和处理事件，真正控制视图的是Window。一个Activity包含了一个Window，Window才是真正代表一个窗口，也就是说Activity没有Window，那就相当于是Service了。<br>Activity和Window是通过ActivityThread调用Activity的attach()函数联系起来的<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[window]:通过PolicyManager创建window,实现callback函数,所以,当window接收到</span></span><br><span class="line"><span class="comment">//外界状态改变时,会调用activity的方法,</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="type">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="params"><span class="function">        Instrumentation instr, IBinder token, <span class="type">int</span> ident,</span></span></span><br><span class="line"><span class="params"><span class="function">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="params"><span class="function">        CharSequence title, Activity parent, <span class="type">String</span> id,</span></span></span><br><span class="line"><span class="params"><span class="function">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="params"><span class="function">        Configuration config, <span class="type">String</span> referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    mWindow = PolicyManager.<span class="built_in">makeNewWindow</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//当window接收系统发送给它的IO输入事件时,例如键盘和触摸屏事件,就可以转发给相应的Activity</span></span><br><span class="line">    mWindow.<span class="built_in">setCallback</span>(<span class="keyword">this</span>);</span><br><span class="line">    .....</span><br><span class="line">    <span class="comment">//设置本地窗口管理器</span></span><br><span class="line">    mWindow.<span class="built_in">setWindowManager</span>(</span><br><span class="line">            (WindowManager)context.<span class="built_in">getSystemService</span>(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.<span class="built_in">flattenToString</span>(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>Window是视图的承载器，内部持有一个 DecorView，而这个DecorView才是 view 的根布局。Window是一个抽象类，实际在Activity中持有的是其子类PhoneWindow。PhoneWindow中有个内部类DecorView，通过创建DecorView来加载Activity中设置的布局setContentView(R.layout.activity_main)<br>Window 通过WindowManager将DecorView加载其中，并将DecorView交给ViewRoot，进行视图绘制以及其他交互</li></ul><p>DecorView是FrameLayout的子类，它可以被认为是Android视图树的根节点视图。DecorView作为顶级View，一般情况下它内部包含一个竖直方向的LinearLayout，在这个LinearLayout里面有上下三个部分，上面是个ViewStub,延迟加载的视图（根据Theme设置设置ActionBar），中间的是标题栏(根据Theme设置，有的布局没有)，下面的是内容栏。具体情况和Android版本及Theme有关</p><p>ViewRoot对应ViewRootImpl类，它是连接WindowManagerService和DecorView的纽带，View的三大流程(测量（measure），布局（layout），绘制（draw）)均通过ViewRoot来完成。ViewRoot并不属于View树的一份子。从源码实现上来看，它既非View的子类，也非View的父类，但是，它实现了ViewParent接口，这让它可以作为View的名义上的父视图。ViewRoot继承了Handler类，可以接收事件并分发，Android的所有触屏事件、按键事件、界面刷新等事件都是通过ViewRoot进行分发的</p><h2 id="视图创建过程"><a href="#视图创建过程" class="headerlink" title="视图创建过程"></a>视图创建过程</h2><p>接着跟着源码分析界面的显示过程来引入Activity中Window的创建,以及View的加载显示过程<br>在ActivityThread.performLaunchActivity中,创建Activity的实例,接着会调用Activity.attach()来初始化一些内容,而Window对象就是在attach里进行创建初始化赋值的<br>Activity.attach:</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final <span class="literal">void</span> attach（<span class="params">...</span>） &#123; </span><br><span class="line">    <span class="params">...</span>    </span><br><span class="line">    mWindow = <span class="literal">new</span> PhoneWindow(this);    </span><br><span class="line">    mWindow.setWindowManager((WindowManager)context.getSystemService(Context.WINDOW_SERVICE), </span><br><span class="line">        mToken, mComponent.flattenToString(),</span><br><span class="line">        (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);   </span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="built_in">null</span>) &#123;            </span><br><span class="line">        mWindow.setContainer(mParent.getWindow());        </span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();    </span><br><span class="line">    <span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Window.setWindowManager:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setWindowManager</span>(<span class="params"><span class="title class_">WindowManager</span> wm, <span class="title class_">IBinder</span> appToken, <span class="title class_">String</span> appName,<span class="built_in">boolean</span> hardwareAccelerated</span>) &#123; </span><br><span class="line">    ...    </span><br><span class="line">    mWindowManager = ((<span class="title class_">WindowManagerImpl</span>)wm).<span class="title function_">createLocalWindowManager</span>(<span class="variable language_">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Activity里新建一个PhoneWindow对象。在Android中,Window是个抽象的概念,Android中Window的具体实现类是PhoneWindow,Activity和Dialog中的Window对象都是PhoneWindow。</p><p>同时得到一个WindowManager对象,WindowManager是一个抽象类,这个WindowManager的具体实现实在WindowManagerImpl中,对比Context和ContextImpl。</p><p>每个Activity会有一个WindowManager对象,这个mWindowManager就是和WindowManagerService(WMS)进行通信,也是WMS识别View具体属于那个Activity的关键,创建时传入IBinder 类型的mToken。</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWindow.setWindowManager(<span class="params">...</span>,mToken, <span class="params">...</span>,<span class="params">...</span>)</span><br></pre></td></tr></table></figure><p>这个Activity的mToken,这个mToken是一个IBinder,WMS就是通过这个IBinder来管理Activity里的View</p><p>接着在onCreate的setContentView中,</p><p>Activity.setContentView():</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">setContentView</span>(<span class="variable">@LayoutRes</span> int layoutResID) &#123;</span><br><span class="line">    <span class="selector-tag">getWindow</span>()<span class="selector-class">.setContentView</span>(layoutResID);</span><br><span class="line">    <span class="selector-tag">initWindowDecorActionBar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PhoneWindow.setContentView():</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">setContentView</span><span class="params">(<span class="type">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">installDecor</span>();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PhoneWindow.installDecor:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span>()</span> &#123;</span><br><span class="line"><span class="comment">//根据不同的Theme,创建不同的DecorView,DecorView是一个FrameLayout </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时只是创建了PhoneWindow,和DecorView,但目前二者也没有任何关系,产生利息的时刻是在ActivityThread.performResumeActivity中,再调用r.activity.performResume()，调用r.activity.makeVisible,将DecorView添加到当前的Window上</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mWindowAdded) &#123;</span><br><span class="line">        ViewManager wm = getWindowManager();</span><br><span class="line">        wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">        mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WindowManager的addView的具体实现在WindowManagerImpl中,而WindowManagerImpl的addView又会调用WindowManagerGlobal.addView。</p><p>WindowManagerGlobal.addView:</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void addView(<span class="keyword">View</span> <span class="keyword">view</span>, ViewGroup.LayoutParams params,<span class="keyword">Display</span> <span class="keyword">display</span>, <span class="keyword">Window</span> parentWindow) &#123;</span><br><span class="line">    ...</span><br><span class="line">    ViewRootImpl root = new ViewRootImpl(<span class="keyword">view</span>.getContext(), <span class="keyword">display</span>);</span><br><span class="line">    <span class="keyword">view</span>.setLayoutParams(wparams);</span><br><span class="line">    mViews.<span class="keyword">add</span>(<span class="keyword">view</span>);</span><br><span class="line">    mRoots.<span class="keyword">add</span>(root);</span><br><span class="line">    mParams.<span class="keyword">add</span>(wparams);</span><br><span class="line">    root.setView(<span class="keyword">view</span>, wparams, panelParentView);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个过程创建一个ViewRootImpl,并将之前创建的DecoView作为参数闯入,以后DecoView的事件都由ViewRootImpl来管理了,比如DecoView上添加View,删除View。ViewRootImpl实现了ViewParent这个接口,这个接口最常见的一个方法是requestLayout()</p><p>ViewRootImpl是个ViewParent，在DecoView添加的View时,就会将View中的ViewParent设为DecoView所在的ViewRootImpl,View的ViewParent相同时,理解为这些View在一个View链上。所以每当调用View的requestLayout()时,其实是调用到ViewRootImpl，ViewRootImpl会控制整个事件的流程。可以看出一个ViewRootImpl对添加到DecoView的所有View进行事件管理</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用RecyclerView和ViewPager实现GalleryView可无限左滑右滑</title>
      <link href="/blog/2018/09/30/yong-recyclerview-he-viewpager-shi-xian-galleryview-ke-wu-xian-zuo-hua-you-hua/"/>
      <url>/blog/2018/09/30/yong-recyclerview-he-viewpager-shi-xian-galleryview-ke-wu-xian-zuo-hua-you-hua/</url>
      
        <content type="html"><![CDATA[<h1 id="GalleryViewDemo"><a href="#GalleryViewDemo" class="headerlink" title="GalleryViewDemo"></a>GalleryViewDemo</h1><ul><li><a href="https://github.com/xmaihh/GalleryViewDemo#recyclerview%E5%AE%9E%E7%8E%B0galleryview%E6%95%88%E6%9E%9C%E5%8F%AF%E4%BC%AA%E6%97%A0%E9%99%90%E6%97%A0%E9%99%90%E5%B7%A6%E6%BB%91%E5%8F%B3%E6%BB%91">RecyclerView实现GalleryView</a></li><li><a href="https://github.com/xmaihh/GalleryViewDemo#viewpager%E5%AE%9E%E7%8E%B0galleryview%E6%95%88%E6%9E%9C%E5%8F%AF%E6%97%A0%E9%99%90%E5%B7%A6%E6%BB%91%E5%8F%B3%E6%BB%91">ViewPager实现GalleryView</a></li></ul><ol><li>导包<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">implementation</span> &#x27;com.android.support:design:<span class="number">28</span>.<span class="number">0</span>.<span class="number">0</span>&#x27;</span><br><span class="line"><span class="attribute">implementation</span> &#x27;com.android.support:recyclerview-v7:<span class="number">28</span>.<span class="number">0</span>.<span class="number">0</span>&#x27;</span><br></pre></td></tr></table></figure>一个是ViewPager所在包,另一个是RecyclerView所在包</li></ol><h2 id="RecyclerView实现GalleryView效果可-伪无限-无限左滑右滑"><a href="#RecyclerView实现GalleryView效果可-伪无限-无限左滑右滑" class="headerlink" title="RecyclerView实现GalleryView效果可(伪无限)无限左滑右滑"></a>RecyclerView实现GalleryView效果可(伪无限)无限左滑右滑</h2><p>先上效果图</p><p><img src="https://github.com/xmaihh/GalleryViewDemo/raw/master/app/arts/recyclerviewgallery.gif" alt="RecyclerView实现的GalleryView效果"><br><img src="https://github.com/xmaihh/GalleryViewDemo/raw/master/app/arts/viewpagergallery.gif" alt="ViewPager实现的GalleryView效果"></p><p>要点：</p><ol><li>在有限的数据里面, 实现无限个Item,也就是可循环</li><li>在第一次显示的时候, 就可以左滑</li><li>滑动Item被放大</li></ol><p>用RecyclerView实现GalleryView效果已经有BCsl大神的<a href="https://github.com/BCsl/GalleryLayoutManager">BCsl&#x2F;GalleryLayoutManager</a>使用自定义 LayoutManager 实现 Android 中 Gallery 或者 ViewPager 控件的效果<br>美滋滋:-P<br><a href="https://github.com/BCsl/GalleryLayoutManager">传送门在这里</a><br>支持垂直和水平两个方向，支持 RecycleView 的试图回收机制</p><h3 id="在有限的数据里面-实现无限个Item"><a href="#在有限的数据里面-实现无限个Item" class="headerlink" title="在有限的数据里面,实现无限个Item"></a>在有限的数据里面,实现无限个Item</h3><p>在RecyclerView.Adapter的方法中:</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Integer.MAX_VALUE，即2147483647(2^32-1),距离真正的无限大还是有点差距的，不过效果也可以</p><h3 id="第一次显示的时候实现左滑"><a href="#第一次显示的时候实现左滑" class="headerlink" title="第一次显示的时候实现左滑"></a>第一次显示的时候实现左滑</h3><p>只需要在一开始的时候,产生一定的偏移量就可以左滑了</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Override</span></span><br><span class="line">public void setAdapter(Adapter adapter) &#123;</span><br><span class="line">    super<span class="selector-class">.setAdapter</span>(adapter);</span><br><span class="line">    <span class="built_in">scrollToPosition</span>(getAdapter()<span class="selector-class">.getItemRawCount</span>() * <span class="number">10000</span>);<span class="comment">//开始时的偏移量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RecyclerView有4个滑动方法:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">scrollBy</span><span class="params">(x,y)</span></span></span><br><span class="line"><span class="function"><span class="title">scrollToPosition</span><span class="params">(int position)</span></span></span><br><span class="line"><span class="function"><span class="title">smoothScrollToPosition</span><span class="params">(int position)</span></span></span><br><span class="line"><span class="function"><span class="title">scrollToPositionWithOffset</span><span class="params">(position,<span class="number">0</span>)</span></span></span><br></pre></td></tr></table></figure><p>smoothScrollToPosition 其实可以理解成一个模拟的滑动操作，会回调那个滑动监听的回调方法,有滑动效果。而 scrollToPosition 相当于直接把你想要的东西再重绘到界面上，不带滑动效果。<br>smoothScrollToPosition(position)和scrollToPosition(position)效果基本相似，也是把你想显示的项显示出来，只要那一项现在看得到了，那它就罢工了，<br>不同的是smoothScrollToPosition是平滑到你想显示的项，而scrollToPosition是直接定位显示。<br>scrollToPositionWithOffset(position,0)可以定位到指定项如果该项可以置顶就将其置顶显示，第二个参数可以决定 距离顶部的offset 偏移量<br>scrollBy(x, y)这个方法是自己去控制移动的距离，单位是像素,所以在使用scrollBy(x, y)需要自己去计算移动的高度或宽度</p><p>如果使用BCsl大BCsl&#x2F;GalleryLayoutManager的自定义 LayoutManager 实现的 Gallery 可使用以下方法初始化偏移量:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">GalleryLayoutManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GalleryLayoutManager</span>(GalleryLayoutManager.HORIZONTAL);</span><br><span class="line">manager.attach(recyclerView, <span class="number">1000000</span>);</span><br></pre></td></tr></table></figure><h3 id="滑动Item放大"><a href="#滑动Item放大" class="headerlink" title="滑动Item放大"></a>滑动Item放大</h3><p>实现GalleryLayoutManager.ItemTransformer的方法重写即可</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> void transformItem(GalleryLayoutManager layoutManager, View item, <span class="built_in">float</span> <span class="built_in">fraction</span>) &#123;</span><br><span class="line">    //以圆心进行缩放</span><br><span class="line">    item.setPivotX(item.getWidth() / <span class="number">2.0</span>f);</span><br><span class="line">    item.setPivotY(item.getHeight() / <span class="number">2.0</span>f);</span><br><span class="line">    <span class="built_in">float</span> <span class="built_in">scale</span> = <span class="number">1</span> - <span class="number">0.433</span>f * Math.<span class="built_in">abs</span>(<span class="built_in">fraction</span>); // <span class="number">0.433</span>f是放大的View面积和缩小的View面积的比值</span><br><span class="line">    item.setScaleX(<span class="built_in">scale</span>);</span><br><span class="line">    item.setScaleY(<span class="built_in">scale</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ViewPager-实现GalleryView效果"><a href="#ViewPager-实现GalleryView效果" class="headerlink" title="ViewPager 实现GalleryView效果"></a>ViewPager 实现GalleryView效果</h2><p>继承JakeWharton&#x2F;salvage大封装的可用于复用的PagerAdapter<a href="https://github.com/JakeWharton/salvage/blob/master/salvage/src/main/java/com/jakewharton/salvage/RecyclingPagerAdapter.java">RecyclingPagerAdapter</a><br>支持View回收,美滋滋:-P</p><h2 id="ViewPager实现GalleryView效果可无限左滑右滑"><a href="#ViewPager实现GalleryView效果可无限左滑右滑" class="headerlink" title="ViewPager实现GalleryView效果可无限左滑右滑"></a>ViewPager实现GalleryView效果可无限左滑右滑</h2><p>要点：</p><ol><li>在有限的数据里面, 实现无限个Item,也就是可循环</li><li>在第一次显示的时候, 就可以左滑</li><li>滑动的Item被放大<br>ViewPager这里用到JakeWharton大实现的支持view的回收机制PagerAdapter <a href="https://github.com/JakeWharton/salvage/blob/master/salvage/src/main/java/com/jakewharton/salvage/RecyclingPagerAdapter.java">RecyclingPagerAdapter</a>继承这个PagerAdapter就可以实现类似RecyclerView的回收机制了</li></ol><h3 id="在有限的数据-实现循环"><a href="#在有限的数据-实现循环" class="headerlink" title="在有限的数据,实现循环"></a>在有限的数据,实现循环</h3><p><img src="https://github.com/xmaihh/GalleryViewDemo/raw/master/app/arts/viewpagergallery.png" alt="viewpagergallery.png"></p><ol><li>在 ViewPager 的首尾多添加一个 View，监听 ViewPager 滚动事件，当滑到边界时，设置当前 position 为中间的某个 item，不过这种方式容易出现页面闪动导致滑动不连贯，这是因为 ViewPager#setCurrentItem(item)是需要时间来完成测量及绘制的</li></ol><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mViewPager.addOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (position &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="comment">//如果item位置小于1，也就是滑动到第0个item的位置时，则直接跳转到倒数第二个view处，并关闭跳转动画</span></span><br><span class="line">                   mViewPager.setCurrentItem(mPagerAdapter.getCount() - <span class="number">2</span>, <span class="keyword">false</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &gt; mPagerAdapter.getCount() - <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//同理如果item位置大于倒数第二个view的位置，也就是滑动到最后一个item的位置时，则直接跳转到第二个view处，并关闭跳转动画</span></span><br><span class="line">                   mViewPager.setCurrentItem(<span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>在ViewPagerAdapter的方法中:<br>实现起来较为简单。需要注意的是，我们需要设置 ViewPager 的初始 position<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="在第一次显示的时候-就可以左滑"><a href="#在第一次显示的时候-就可以左滑" class="headerlink" title="在第一次显示的时候, 就可以左滑"></a>在第一次显示的时候, 就可以左滑</h3><p>这个简单只需要在一开始的时候,产生一定的偏移量就可以左滑了</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**这里需要将setOffscreenPageLimit的值设置成数据源的总个数，设置ViewPager缓存页面数量,最小可设置成屏幕可见的个数**/</span></span><br><span class="line">mViewPager<span class="selector-class">.setOffscreenPageLimit</span>(mPagerAdapter.getCount());</span><br><span class="line"><span class="comment">/**设置ViewPager位置**/</span></span><br><span class="line">mViewPager<span class="selector-class">.setCurrentItem</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="滑动的Item被放大"><a href="#滑动的Item被放大" class="headerlink" title="滑动的Item被放大"></a>滑动的Item被放大</h3><ol><li><p>需在根节点设置android:clipChildren为false即可，默认为true<br>可以通过android:layout_gravity控制超出的部分如何显示。<br>android:clipChildren的意思：是否限制子View在其范围内<br>需要在父节点和ViewPager界面设置android:clipChildren属性</p></li><li><p>setPageTransformer(boolean reverseDrawingOrder, PageTransformer transformer))方法<br>通过创建一个类实现ViewPager.PageTransformer然后重写transformPage方法来实现切换效果</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心就是实现transformPage(View page, float position)这个方法</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    @<span class="function">Override</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="type">void</span> <span class="title">transformPage</span><span class="params">(View page, <span class="type">float</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//以圆心进行缩放</span></span><br><span class="line">        page.<span class="built_in">setPivotX</span>(page.<span class="built_in">getWidth</span>() / <span class="number">2.0f</span>);</span><br><span class="line">        page.<span class="built_in">setPivotY</span>(page.<span class="built_in">getHeight</span>() / <span class="number">2.0f</span>);</span><br><span class="line">        <span class="type">float</span> scale = <span class="number">1</span> - <span class="number">0.433f</span> * Math.<span class="built_in">abs</span>(position);</span><br><span class="line">        page.<span class="built_in">setScaleX</span>(scale);</span><br><span class="line">        page.<span class="built_in">setScaleY</span>(scale);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">            page.<span class="built_in">getParent</span>().<span class="built_in">requestLayout</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android经典蓝牙开发简介</title>
      <link href="/blog/2018/09/19/android-jing-dian-lan-ya-kai-fa-jian-jie/"/>
      <url>/blog/2018/09/19/android-jing-dian-lan-ya-kai-fa-jian-jie/</url>
      
        <content type="html"><![CDATA[<p><a href="https://developer.android.com/guide/topics/connectivity/bluetooth?hl=zh-cn">官方文档</a></p><p>使用 Bluetooth API，Android 应用可执行以下操作：</p><ul><li>扫描其他蓝牙设备</li><li>查询本地蓝牙适配器的配对蓝牙设备</li><li>建立 RFCOMM 通道</li><li>通过服务发现连接到其他设备</li><li>与其他设备进行双向数据传输</li><li>管理多个连接</li></ul><p>接下来简单介绍经典蓝牙(Classic Bluetooth)的点对点蓝牙设备的数据交换技术，经典蓝牙（以下简称蓝牙）开发所用到的API都来自于android.bluetooth包中</p><h2 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h2><h3 id="BluetoothAdapter"><a href="#BluetoothAdapter" class="headerlink" title="BluetoothAdapter"></a>BluetoothAdapter</h3><p>BluetoothAdapter类的对象代表本地的蓝牙适配器。BluetoothAdapter是所有蓝牙交互操作的入口点，通过使用该类的对象，可以完成以下操作：</p><ul><li>发现其他蓝牙设备</li><li>查询已配对的设备</li><li>通过已知的MAC地址实例化远程蓝牙设备</li><li>创建BluetoothServerSocket类对象监听与其他蓝牙设备的通信</li></ul><h3 id="BluetoothDevice"><a href="#BluetoothDevice" class="headerlink" title="BluetoothDevice"></a>BluetoothDevice</h3><p>表示远程的蓝牙设备。使用该类对象可进行远程蓝牙设备的连接请求，以及查询该蓝牙设备的信息，例如名称，地址等。</p><h3 id="BluetoothSocket"><a href="#BluetoothSocket" class="headerlink" title="BluetoothSocket"></a>BluetoothSocket</h3><p>表示蓝牙socket的接口（与TCP Socket类似）。该类的对象作为应用中数据传输的连接点。</p><h3 id="BluetoothServerSocket"><a href="#BluetoothServerSocket" class="headerlink" title="BluetoothServerSocket"></a>BluetoothServerSocket</h3><p>表示服务器socket，用来监听未来的请求（和TCP ServerSocket类似）。为了能使两个蓝牙设备进行连接，一个设备必须使用该类开启服务器socket，当远程的蓝牙设备请求该服务端设备时，如果连接被接受，BluetoothServerSocket将会返回一个已连接的BluetoothSocket类对象。</p><h3 id="BluetoothClass"><a href="#BluetoothClass" class="headerlink" title="BluetoothClass"></a>BluetoothClass</h3><p>描述蓝牙设备的主要特征。BluetoothClass的类对象是一个只读的蓝牙设备的属性集。尽管该类对象并不能可靠地描述BluetoothProfile的所有内容以及该设备支持的所有服务信息，但是该类对象仍然有助于对该设备的类型进行提示。</p><h3 id="BluetoothProfile"><a href="#BluetoothProfile" class="headerlink" title="BluetoothProfile"></a>BluetoothProfile</h3><p>表示蓝牙规范，蓝牙规范是两个基于蓝牙设备通信的标准。</p><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><h3 id="android-permission-BLUETOOTH"><a href="#android-permission-BLUETOOTH" class="headerlink" title="android.permission.BLUETOOTH"></a>android.permission.BLUETOOTH</h3><p>为了能够在你开发的应用设备中使用蓝牙功能，必须声明蓝牙的权限”BLUETOOTH”。在进行蓝牙的通信，例如请求连接，接受连接以及交换数据中，需要用到该权限。该权限用于允许应用程序连接已经配对的蓝牙设备，并不包括对未配对设备的连接请求</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="android-permission-BLUETOOTH-ADMIN"><a href="#android-permission-BLUETOOTH-ADMIN" class="headerlink" title="android.permission.BLUETOOTH_ADMIN"></a>android.permission.BLUETOOTH_ADMIN</h3><p>如果你的应用程序需要实例化蓝牙设备的搜索或者对蓝牙的设置进行操作，那么必须声明BLUETOOTH_ADMIN权限。大多数应用需要该权限对本地的蓝牙设备进行搜索。该权限的其他能力并不应当被使用，除非你的应用是一个电源管理的应用，需要对蓝牙的设置进行修改。该权限用于发现并配对蓝牙设备。<br>注：如果使用BLUETOOTH_ADMIN权限，则必须同时声明BLUETOOTH权限。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="android-permission-ACCESS-COARSE-LOCATION"><a href="#android-permission-ACCESS-COARSE-LOCATION" class="headerlink" title="android.permission.ACCESS_COARSE_LOCATION"></a>android.permission.ACCESS_COARSE_LOCATION</h3><p> 在Android 6.0，原来的蓝牙功能，发现扫描蓝牙设备时，无法获取到蓝牙设备；因为在6.0后，蓝牙这块增加一个动态权限；需要在程序中动态申请。 6.0及后续版本，使用蓝牙扫描，来需要添加如下的权限，且该权限还需要在使用时动态申请。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Android6.0 蓝牙扫描才需要--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission-sdk-23</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="开启蓝牙"><a href="#开启蓝牙" class="headerlink" title="开启蓝牙"></a>开启蓝牙</h2><p>在你的应用程序能够使用蓝牙进行通信之前，你需要进行确认蓝牙设备是否被当前设备所支持。如果当前设备支持蓝牙，则需要请求开启蓝牙设备。该部分可使用BluetoothAdapter通过两步完成</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BluetoothAdapter mBluetoothAdapter <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter()<span class="comment">;</span></span><br><span class="line">if (mBluetoothAdapter <span class="operator">=</span><span class="operator">=</span> null) &#123;</span><br><span class="line">    // Device does not support Bluetooth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，你需要确保蓝牙处于开启的状态。调用isEnabled()方法来检查蓝牙目前是否可用。如果该方法返回false，那么蓝牙处于不可用的状态。为了请求蓝牙设备的开启，使用ACTION_REQUEST_ENABLE的Intent，并调用startActivityForResult()方法。这将会通过系统设置开启你的蓝牙，例如</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="comment">!mBluetoothAdapter.isEnabled()) &#123;</span></span><br><span class="line">    <span class="keyword">Intent</span> enableBtIntent = new <span class="keyword">Intent</span>(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">    startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>常量REQUEST_ENABLE_BT是本地定义的整型（需要大于0），当系统通过onActivityResult() 返回至你的应用程序时，将作为requestCode的参数。<br>如果成功开启了蓝牙，你的Activity将收到RESULT_OK作为resultCode。如果蓝牙不能成功开启（例如用户选择“取消”），则resultCode为RESULT_CANCELED。<br>可选择的是，你的应用也可以监听”ACTION_STATE_CHANGED”的广播Intent(不再赘述广播机制。新手请查阅文档或留言)。当蓝牙的状态发生变化时，系统将会进行广播。该广播包含两个额外的域，分别是：EXTRA_STATE和EXTRA_PREVIOUS_STATE，分别包含蓝牙的新旧状态。可能的值为：STATE_TURNING_ON（开启中），STATE_ON（已开启）， STATE_TURNING_OFF（关闭中）以及 STATE_OFF（已关闭）。</p><h2 id="查找设备"><a href="#查找设备" class="headerlink" title="查找设备"></a>查找设备</h2><p>使用BluetoothAdapter，通过搜索设备或查询配对设备列表可以找到远程蓝牙设备。</p><p>设备搜索(Device Discovery)是一个扫描的过程，用来搜索本地开启蓝牙的设备，在此之后请求每一个扫描到设备的信息。然而，一个蓝牙设备只有处于可见状态下才会返回设备信息，例如设备名称，MAC地址等。使用该信息，设备能够实例化和该设备的蓝牙连接。</p><p>当第一次和远程蓝牙设备进行连接时，一个配对的请求将会自动呈现在用户面前。当设备配对时，设备的基础信息将会被保存并能够使用蓝牙的API进行读取。使用远程蓝牙设备的MAC地址，介于蓝牙设备间的连接将能够在任意时刻实例化，而不需要进行搜索操作（假定设备在蓝牙的通信范围内）[4]。</p><p>请记住配对(paired)和连接(connected)是不同的。配对意味着两个蓝牙设备知道彼此的存在，并有一个共享的key用于验证，并且能够彼此建立加密的链接。连接则意味着设备当前共享同一个RFCOMM通道，并能够彼此交换数据。当前的蓝牙API要求在建立RFCOMM通道之前进行配对。</p><h3 id="发现设备"><a href="#发现设备" class="headerlink" title="发现设备"></a>发现设备</h3><p>执行发现设备的操作，仅仅需要执行startDiscovery()方法。该过程是异步的，该方法将会立刻返回一个布尔值表明搜索是否已经开始。通常情况下，该搜索的过程调用12秒钟的查询，随后返回找到的设备。</p><p>你的应用程序必须使用ACTION_FOUNDd的Intent注册一个BroadastReceiver。该Intent用来接受每一个查找到设备的信息。对于每一个设备，系统将会广播ACTION_FOUND。该Intent包含两个额外域，EXTRA_DEVICE 和 EXTRA_CLASS。分别包含一个BluetoothDevice类对象和BluetoothClass类对象。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a BroadcastReceiver for ACTION_FOUND</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BroadcastReceiver</span> <span class="variable">mReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">        <span class="comment">// When discovery finds a device</span></span><br><span class="line">        <span class="keyword">if</span> (BluetoothDevice.ACTION_FOUND.equals(action)) &#123;</span><br><span class="line">            <span class="comment">// Get the BluetoothDevice object from the Intent</span></span><br><span class="line">            <span class="type">BluetoothDevice</span> <span class="variable">device</span> <span class="operator">=</span> intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);</span><br><span class="line">            <span class="comment">// Add the name and address to an array adapter to show in a ListView</span></span><br><span class="line">            mArrayAdapter.add(device.getName() + <span class="string">&quot;\n&quot;</span> + device.getAddress());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Register the BroadcastReceiver</span></span><br><span class="line"><span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(BluetoothDevice.ACTION_FOUND);</span><br><span class="line">registerReceiver(mReceiver, filter); <span class="comment">// Don&#x27;t forget to unregister during onDestroy</span></span><br></pre></td></tr></table></figure><p>执行设备搜索的操作是一项很繁重的任务，会消耗大量的资源。一旦你找到了一个设备并要进行连接，请务必确认是否停止搜索设备的操作。如果已经进行了连接，那么搜索操作将会显著地降低连接的速率，因此你应当在连接时停止搜索。可通过cancelDiscovery()方法停止搜索。</p><h4 id="蓝牙设备可见性"><a href="#蓝牙设备可见性" class="headerlink" title="蓝牙设备可见性"></a>蓝牙设备可见性</h4><p>Android设备默认情况下蓝牙是不可见的。用户可以使蓝牙在有限的时间内可见，或者应用可以在用户界面内请求用户开启可见性。如果想要使自己的蓝牙设备可见，使用ACTION_REQUEST_DISCOVERABLE的Intent，调用startActivityForResult(Intent, int)方法即可。这将会通过系统设置请求开启搜索模式。默认情况下，设备将在120秒内可见。你可以定义不同的时间长度，通过添加Intent的extra： EXTRA_DISCOVERABLE_DURATION即可。该时长最大为3600秒，最小为0，超出该范围的值都会被设为120秒。其中，0表示设备始终处于可见状态。例如：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent <span class="keyword">discoverableIntent </span>= new</span><br><span class="line">Intent(<span class="keyword">BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, </span><span class="number">300</span>);</span><br><span class="line">startActivity(<span class="keyword">discoverableIntent);</span></span><br></pre></td></tr></table></figure><p>一个请求蓝牙可见的对话框将会被显示出来。如果用户选择“是”，那么该设备将会在指定时间内可见，你的Activity将会在onActiviyResult()中返回和时限相同的result code。如果用户选择“否”，那么result code将为ESULT_CANCELED。</p><p>如果蓝牙设备没有开启，在执行搜索操作时将会自动开启蓝牙设备。</p><p>设备将在指定时间内保持可见。如果你想要检查状态的变化，可以通过使用ACTION_SCAN_MODE_CHANGED的Intent注册广播进行监听。该广播onReceive()的Intent包含两个额外域：EXTRA_SCAN_MODE 和 EXTRA_PREVIOUS_SCAN_MODE，分别表示新旧状态。可能的值有：SCAN_MODE_CONNECTABLE_DISCOVERABLE（可连接可见），SCAN_MODE_CONNECTABLE（可连接但不可见） 或 SCAN_MODE_NONE（不可连接不可见）。</p><p>如果仅仅是连接到远程蓝牙设备的话，你并不需要开启可见性。开启可见性仅仅在你的应用中作为服务端时才是必要的。因为其他蓝牙设备必须找到你的设备之后才能建立连接。</p><h3 id="查询配对设备"><a href="#查询配对设备" class="headerlink" title="查询配对设备"></a>查询配对设备</h3><p>在搜索设备之前，有必要查询已配对的设备集，来得知想要连接的设备是否已经配对。为了执行上述操作，可以调用getBondedDevices()方法。该方法返回一个BluetoothDevice的集合来代表配对设备。例如，你可以查询所有的配对设备并使用ArrarAdapter显示它们：</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;BluetoothDevice&gt; pairedDevices = mBluetoothAdapter.getBondedDevices();</span><br><span class="line">// If there are paired devices<span class="built_in"></span></span><br><span class="line"><span class="built_in">if </span>(pairedDevices.size() &gt; 0) &#123;</span><br><span class="line">    // Loop through paired devices</span><br><span class="line">    for (BluetoothDevice device<span class="keyword"> :</span> pairedDevices) &#123;</span><br><span class="line">        // Add the name<span class="built_in"> and </span>address to an<span class="built_in"> array </span>adapter to show in a ListView</span><br><span class="line">        mArrayAdapter.add(device.getName() + <span class="string">&quot;\n&quot;</span> + device.getAddress());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="连接设备"><a href="#连接设备" class="headerlink" title="连接设备"></a>连接设备</h2><p>为了在你的应用中让双方设备建立连接，你必须同时实现服务器端和客户端的机制。因为其中一个设备一定会开启服务器Socket，而另一个进行连接（使用作为服务器端的MAC地址进行连接）。当客户端和服务器端彼此拥有一个在同一个RFCOMM通道已连接的BluetoothSocket时便可以进行数据的交换。在每一端，都可以获得输入和输出流，从而可以开始数据的传输。该部分将在后文描述，本部分只描述如何初始化设备间的连接。</p><p>服务器端和客户端通过不同的方式获得BluetoothSocket。当一个连接接受(accept)的时候服务器端接收BluetoothSocket。而客户端则通过打开服务器端的RFCOMM通道得到BluetoothSocket。</p><p>一种实现技术是，应用程序同时实现客户端和服务器端。因此，每一个服务器端的程序拥有一个server socket并监听连接。当然，也可以在一个应用中实现服务器端的功能，而另一个应用中实现客户端的部分。</p><p>如果两个设备之前并没有配对过，那么Android的框架将会自动进行配对的请求通知。因此当尝试进行连接时，你的应用并不需要关心两台设备是否已经配对。你的RFCOMM连接将会被阻塞，直到用户成功配对，或因为用户拒绝配对而取消，或者配对失败以及超时等。</p><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>两个设备进行连接时，必须有一个设备通过BluetoothServerSocket作为服务器。该server socket的目的是监听未来的连接请求，并当该请求被接受时，提供一个已经连接的BluetoothSocket。当从BluetoothServerSocket获得BluetoothSocket时，BluetoothServerSocket必须被抛弃，除非你想要连接多个设备。</p><p>步骤如下：</p><ol><li>通过调用listenUsingRfcommWithServiceRecord(String, UUID)获取BluetoothServerSocket。<br>String是你服务的可辨别名称。系统将会自动写入一个新的“服务发现协议(Service Discovery Protocol 简称SDP)”数据库入口至你的设备，该名称可随意命名，通常情况下是应用名称。UUID也包括SDP的入口，并作为和客户端连接基础。当客户端尝试连接至服务端设备时，将会带有想要连接设备的独一无二的UUID。这些UUID必须匹配，目的是为了能够使连接被接受。<br>可通过网络上的诸多UUID生成器来获得UUID的字符串，然后通过fromString(String)方法获得。</li><li>通过调用accept()，开始监听连接请求。<br>这是一个阻塞的调用，将会在抛出异常或者连接被接受时返回。连接只有在远程设备发送一个带有和服务器端已注册的UUID相匹配的连接请求时才会被接受。当连接成功时,accept()将会返回一个已经连接的BluetoothSocket。<br>3.通过调用close()，关闭连接。 除非你想要接受多个连接，否则的话，调用close()进行关闭。<br>这将会释放server socket以及相关的资源，但是并不会关闭从accept()中返回的，已经连接的BluetoothSocket。和TCP&#x2F;IP不同，RFCOMM仅仅允许在一个通道中同时存在一个客户端。因此大多数情况下，在获得BluetoothSocket后立即调用close()是很有必要的。</li></ol><p>accept()方法不应当在主线程（UI线程）中执行，因为这是一个阻塞的调用，能够租住任何和程序的交互。通常情况下和BluetoothServerSocket以及BluetoothSocket有关的任何操作都应该在新的线程中进行。在另外的线程中调用close()方法将会撤销该阻塞方法调用并立即返回。请注意，BluetoothServerSocket和BluetoothSokcet中的任何方法都是线程安全的。</p><p>例子如下：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BluetoothServerSocket</span> mmServerSocket;</span><br><span class="line"> </span><br><span class="line">    public <span class="type">AcceptThread</span>() &#123;</span><br><span class="line">        <span class="comment">// Use a temporary object that is later assigned to mmServerSocket,</span></span><br><span class="line">        <span class="comment">// because mmServerSocket is final</span></span><br><span class="line">        <span class="type">BluetoothServerSocket</span> tmp = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the client code</span></span><br><span class="line">            tmp = mBluetoothAdapter.listenUsingRfcommWithServiceRecord(<span class="type">NAME</span>, <span class="type">MY_UUID</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123; &#125;</span><br><span class="line">        mmServerSocket = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void run() &#123;</span><br><span class="line">        <span class="type">BluetoothSocket</span> socket = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Keep listening until exception occurs or a socket is returned</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket = mmServerSocket.accept();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If a connection was accepted</span></span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">                manageConnectedSocket(socket);</span><br><span class="line">                mmServerSocket.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/** Will cancel the listening socket, and cause the thread to finish */</span></span><br><span class="line">    public void cancel() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmServerSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在例子中，一旦连接被接受并获得BluetoothSocket后，应用立即将该BluetoothSocket发送至独立的线程并关闭BluetoothSocket，挑出循环。<br>注意到，当accept()返回BluetoothSocket时，socket已经连接了，因此不应该调用connect方法。<br>manageConnectedSocket()是一个虚构的方法，用来初始化数据传输的线程，将在后文介绍数据传输的部分。<br>一旦监听到连接并获得BluetoothSocket时，应当立即调用close()关闭BluetoothServerSocket。cancel()则为此提供了一个公共的方法。</p><blockquote><p>BluetoothAdapter中提供了两种创建BluetoothServerSocket 方式，一是mBluetoothAdapter.listenUsingRfcommWithServiceRecord(“name”,UUID)创建安全的RFCOMM Bluetooth socket，该连接是安全的需要进行配对。而通过listenUsingInsecureRfcommWithServiceRecord创建的RFCOMM Bluetooth socket是不安全的，连接时不需要进行配对。<br>与之对应的安全的客户端创建createRfcommSocketToServiceRecord()。另一种不安全连接对应的函数是createInsecureRfcommSocketToServiceRecord()。</p></blockquote><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>为了和服务器端连接，首先需要拥有一个代表远程服务器的BluetoothDevice对象。之后必须使用BluetoothDevice获得一个BluetoothSocket并初始化连接。</p><p>基本步骤如下。</p><ol><li>使用BluetoothDevice，通过调用createRfcommSocketToServiceRecord(UUID)或者createInsecureRfcommSocketToServiceRecord(UUID)得到BluetoothSocket。<br>通过调用connect()方法初始化连接。</li><li>系统将会在远程服务器上查询匹配UUID的SDP。如果查询成功，将会共享RFCOMM通道用于连接，connect()方法将会返回。该方法是一个阻塞的调用。如果12秒钟内未能成功连接，该方法将会跑出一个异常。<br>因为connect()是一个阻塞的调用，因此该连接的过程总是应当在一个独立的线程中进行。<br>应当确保在调用connect()时设备没有执行搜索设备的操作。如果搜索设备也在同时进行，那么将会显著地降低连接速率，并很大程度上会连接失败。<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BluetoothSocket</span> mmSocket;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BluetoothDevice</span> mmDevice;</span><br><span class="line"> </span><br><span class="line">    public <span class="type">ConnectThread</span>(<span class="type">BluetoothDevice</span> device) &#123;</span><br><span class="line">        <span class="comment">// Use a temporary object that is later assigned to mmSocket,</span></span><br><span class="line">        <span class="comment">// because mmSocket is final</span></span><br><span class="line">        <span class="type">BluetoothSocket</span> tmp = <span class="literal">null</span>;</span><br><span class="line">        mmDevice = device;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Get a BluetoothSocket to connect with the given BluetoothDevice</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the server code</span></span><br><span class="line">            tmp = device.createRfcommSocketToServiceRecord(<span class="type">MY_UUID</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123; &#125;</span><br><span class="line">        mmSocket = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void run() &#123;</span><br><span class="line">        <span class="comment">// Cancel discovery because it will slow down the connection</span></span><br><span class="line">        mBluetoothAdapter.cancelDiscovery();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Connect the device through the socket. This will block</span></span><br><span class="line">            <span class="comment">// until it succeeds or throws an exception</span></span><br><span class="line">            mmSocket.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> connectException) &#123;</span><br><span class="line">            <span class="comment">// Unable to connect; close the socket and get out</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mmSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> closeException) &#123; &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">        manageConnectedSocket(mmSocket);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/** Will cancel an in-progress connection, and close the socket */</span></span><br><span class="line">    public void cancel() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>cancelDiscovery() 在连接建立之前被调用。你应当总是在连接前这么做。这样做是安全的，虽然没有检查是否在搜索设备。（如果想要进行检查，可以调用isDiscovering()）。<br>manageConnectedSocket()是一个虚构的方法，用来初始化数据传输的线程，将在后文介绍数据传输的部分。<br>在完成BluetoothSocket的处理后，始终记得调用close()方法来进行清理。</li></ol><h2 id="管理连接"><a href="#管理连接" class="headerlink" title="管理连接"></a>管理连接</h2><p>当成功进行设备间的连接时，每一个设备都持有一个已连接的BluetoothSocket。这时终于可以进行数据的传输了。使用BluetoothSocket，数据的传输非常简单。<br>步骤如下：</p><ol><li>通过getInputStream()以及getOutputStream()分别获得输入输出流。</li><li>通过read(byte[]) 和 write(byte[]) 读写数据。</li></ol><p>首先需要一个专门的线程进行读写的操作。这是很重要的一点，因为read(byte[]) 和 write(byte[])方法都是阻塞调用的。read(byte[])将会阻塞，直到从流中读到数据。write(byte[])并不会经常阻塞，但如果远程设备没有足够快的调用读操作以及缓存已满时而被阻塞。你应当在该独立线程的主循环中进行数据的读取，并在该线程中一个独立的公有方法进行写的操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectedThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream mmInStream;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream mmOutStream;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectedThread</span><span class="params">(BluetoothSocket socket)</span> &#123;</span><br><span class="line">        mmSocket = socket;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">tmpIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">tmpOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Get the input and output streams, using temp objects because</span></span><br><span class="line">        <span class="comment">// member streams are final</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tmpIn = socket.getInputStream();</span><br><span class="line">            tmpOut = socket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123; &#125;</span><br><span class="line"> </span><br><span class="line">        mmInStream = tmpIn;</span><br><span class="line">        mmOutStream = tmpOut;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];  <span class="comment">// buffer store for the stream</span></span><br><span class="line">        <span class="type">int</span> bytes; <span class="comment">// bytes returned from read()</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Keep listening to the InputStream until an exception occurs</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Read from the InputStream</span></span><br><span class="line">                bytes = mmInStream.read(buffer);</span><br><span class="line">                <span class="comment">// Send the obtained bytes to the UI activity</span></span><br><span class="line">                mHandler.obtainMessage(MESSAGE_READ, bytes, -<span class="number">1</span>, buffer)</span><br><span class="line">                        .sendToTarget();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Call this from the main activity to send data to the remote device */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmOutStream.write(bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Call this from the main activity to shutdown the connection */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造函数获得必要的流，一旦执行，线程将会等待数据从输入流中流出。当read(byte[])返回字节时，数据将通过父类的Handler被发送至Activity。之后再返回并等待更多的字节流。<br>发送数据则仅仅需要简单地调用线程的write()方法即可。<br>线程中的cancel（）方法很重要，因为连接可以随时在任意时间通过BluetoothSocket终止。该方法在结束使用蓝牙连接后，应当总是被调用。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><h3 id="附上小例子-Demo"><a href="#附上小例子-Demo" class="headerlink" title="附上小例子 Demo"></a>附上小例子 <a href="https://github.com/xmaihh/Android-Bluetooth">Demo</a></h3>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> BT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Module里调用aar出现failed to resolve的问题</title>
      <link href="/blog/2018/09/12/jie-jue-module-li-diao-yong-aar-chu-xian-failed-to-resolve-de-wen-ti/"/>
      <url>/blog/2018/09/12/jie-jue-module-li-diao-yong-aar-chu-xian-failed-to-resolve-de-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>环境：AndroidStudio 3.1.4</p><ol><li>在Module的build.gradle添加<br>在dependencies{}标签里<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">compile</span><span class="params">(name: <span class="string">&#x27;第三方aar库名称&#x27;</span>, ext: <span class="string">&#x27;aar&#x27;</span>)</span></span></span><br></pre></td></tr></table></figure>在android{}标签里<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    <span class="keyword">flatDir</span> &#123;</span><br><span class="line">        dirs <span class="string">&#x27;libs&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在App的build.gradle添加<br>在dependencies{}标签里<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    <span class="keyword">flatDir</span> &#123;</span><br><span class="line">        dirs <span class="keyword">project</span>(<span class="string">&#x27;:你的Module名&#x27;</span>).<span class="keyword">file</span>(<span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>重新编译即可</li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> AndroidStudio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-BLE蓝牙之Central</title>
      <link href="/blog/2018/09/10/android-ble-lan-ya-zhi-central/"/>
      <url>/blog/2018/09/10/android-ble-lan-ya-zhi-central/</url>
      
        <content type="html"><![CDATA[<p>低功耗蓝牙(BLE)Android 4.3（API 18）以上才支持<br>Android 5.0(API 21) 扫描蓝牙需要定位权限，否则扫描不到设备,实际使用时候发现 5.0不需要也可以扫描，Android 6.0(API 23)以上必须需要定位权限<br>官方文档:<a href="https://developer.android.com/guide/topics/connectivity/bluetooth-le.html?hl=zh-cn">https://developer.android.com/guide/topics/connectivity/bluetooth-le.html?hl=zh-cn</a></p><h2 id="声明权限"><a href="#声明权限" class="headerlink" title="声明权限"></a>声明权限</h2><p>在项目的AndroidManifest.xml中声明权限</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 定位权限第二个包含第一个，所以这里就声明了一个，两个都声明也可以</span><br><span class="line"> <span class="comment">&lt;!-- &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt; --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span>/&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span>/&gt;</span></span><br><span class="line"> // 是否必须支持低功耗蓝牙，此处不必须</span><br><span class="line">  <span class="tag">&lt;<span class="name">uses-feature</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:name</span>=<span class="string">&quot;android.hardware.bluetooth_le&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:required</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  // 是有gps硬件</span><br><span class="line"> <span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">&quot;android.hardware.location.gps&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="检查是否支持BLE"><a href="#检查是否支持BLE" class="headerlink" title="检查是否支持BLE"></a>检查是否支持BLE</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首先检查是否支持BLE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;BLE not supported&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line"><span class="comment">//            finish();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mBluetoothManager = (BluetoothManager) getSystemService(BLUETOOTH_SERVICE);</span><br><span class="line">        mBluetoothAdapter = mBluetoothManager.getAdapter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Bluetooth not supported&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">            Intent enableBtIntent = <span class="keyword">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">            startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">            <span class="comment">//判断是否打开蓝牙,如果没有打开需要回调打开蓝牙,这里省略,请自行打开蓝牙</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>通过BluetoothManager得到蓝牙适配器BluetoothAdapter,如果获取到的Adapter为空说明不支持蓝牙，或者没有蓝牙模块</p><h2 id="扫描设备"><a href="#扫描设备" class="headerlink" title="扫描设备"></a>扫描设备</h2><p>低功耗蓝牙和经典蓝牙的扫描方式不同,蓝牙扫描耗电比较严重，所以一定要记得在合适的实际停止扫描，比如定时停止、扫描到目标设备就停止,扫描时调用Adapter的startLeScan()方法,然而这个方法被标记为过时，API&gt;&#x3D;21被另一个取代。然后通过回调得到扫描结果（经典蓝牙是通过广播得到扫描结果）</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> mBluetoothAdapter.<span class="built_in">startLeScan</span>(<span class="keyword">this</span>);</span><br><span class="line"> ...</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扫描结果回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> @<span class="function">Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">onLeScan</span><span class="params">(BluetoothDevice device, <span class="type">int</span> rssi, <span class="type">byte</span>[] scanRecord)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 得到扫描结果</span></span><br><span class="line">    Log.<span class="built_in">i</span>(TAG, <span class="string">&quot;扫描到的设备, name=&quot;</span> + device.<span class="built_in">getName</span>() + <span class="string">&quot;,address=&quot;</span> + device.<span class="built_in">toString</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>device：代表外设即目标设备 rssi：设一个强度值，但是时负值，利用这个值通过公式可以算出离你的距离<br>scanRecord：广播数据，附加的数据</p><h2 id="停止扫描"><a href="#停止扫描" class="headerlink" title="停止扫描"></a>停止扫描</h2><p>扫描完成务必停止，因为扫描不仅耗电，还影响连接速度，所以当要连接的时候，先停止扫描时必须的</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopScan</span>()</span> &#123;</span><br><span class="line">    initHandler();</span><br><span class="line">    Log.i(TAG, <span class="string">&quot;停止扫描，蓝牙设备&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mScanning) &#123;</span><br><span class="line">        mScanning = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 开始扫描的接口,要一样的不然停止不了</span></span><br><span class="line">        mBluetoothAdapter.stopLeScan(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (scanRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">        mHandler.removeCallbacks(scanRunnable);</span><br><span class="line">        scanRunnable = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="连接设备"><a href="#连接设备" class="headerlink" title="连接设备"></a>连接设备</h2><p>通常Ble连接设备速度还是很快的，连接理论上来说也是无状态的，所以也需要一个定时任务来，保证超时停止。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">connect</span>(<span class="params"><span class="title class_">Context</span> context, <span class="title class_">String</span> address</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mConnectionState == <span class="variable constant_">STATE_CONNECTED</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span> || <span class="title class_">TextUtils</span>.<span class="title function_">isEmpty</span>(address)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">initHandler</span>();</span><br><span class="line">    <span class="keyword">if</span> (connectRunnable == <span class="literal">null</span>) &#123;</span><br><span class="line">        connectRunnable = <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">                mConnectionState = <span class="variable constant_">STATE_DISCONNECTING</span>;</span><br><span class="line">                <span class="title function_">disconnect</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// 30s没反应停止连接</span></span><br><span class="line">    mHandler.<span class="title function_">postDelayed</span>(connectRunnable, <span class="number">30</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="title function_">stopScan</span>();</span><br><span class="line"><span class="comment">// 获取到远程设备，</span></span><br><span class="line">    final <span class="title class_">BluetoothDevice</span> device = mBluetoothAdapter.<span class="title function_">getRemoteDevice</span>(address);</span><br><span class="line">    <span class="keyword">if</span> (device == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开始连接，第二个参数表示是否需要自动连接，true设备靠近自动连接，第三个表示连接回调</span></span><br><span class="line">    mBluetoothGatt = device.<span class="title function_">connectGatt</span>(context, <span class="literal">false</span>, mGattCallback);</span><br><span class="line">    mBluetoothDeviceAddress = address;</span><br><span class="line">    mConnectionState = <span class="variable constant_">STATE_CONNECTING</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="监听连接回调"><a href="#监听连接回调" class="headerlink" title="监听连接回调"></a>监听连接回调</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BluetoothGattCallback mGattCallback = <span class="keyword">new</span> BluetoothGattCallback() &#123;</span><br><span class="line"><span class="comment">// 连接状态变化</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onConnectionStateChange</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status, <span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (newState == BluetoothProfile.STATE_CONNECTED) &#123; <span class="comment">// 连接上</span></span><br><span class="line">            mConnectionState = STATE_CONNECTED;</span><br><span class="line">            <span class="keyword">boolean</span> success = mBluetoothGatt.discoverServices(); <span class="comment">// 去发现服务</span></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Attempting to start service discovery:&quot;</span> +</span><br><span class="line">                    success);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(newState == BluetoothProfile.STATE_DISCONNECTED)</span> </span>&#123; <span class="comment">// 连接断开</span></span><br><span class="line">            mConnectionState = STATE_DISCONNECTED;       </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发现服务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServicesDiscovered</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status == BluetoothGatt.GATT_SUCCESS) &#123;</span><br><span class="line">            Log.i(TAG,<span class="string">&quot;发现服务&quot;</span>);</span><br><span class="line">            <span class="comment">// 解析服务</span></span><br><span class="line">            discoverService();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 特征读取变化</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCharacteristicRead</span><span class="params">(BluetoothGatt gatt,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     BluetoothGattCharacteristic characteristic,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status == BluetoothGatt.GATT_SUCCESS) &#123;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCharacteristicChanged</span><span class="params">(BluetoothGatt gatt,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        BluetoothGattCharacteristic characteristic)</span> </span>&#123;</span><br><span class="line">        mConnectionState = STATE_CONNECTED;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="断开连接"><a href="#断开连接" class="headerlink" title="断开连接"></a>断开连接</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span> || mBluetoothGatt == <span class="literal">null</span>) &#123;</span><br><span class="line">        mConnectionState = STATE_DISCONNECTED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 连接成功的GATT</span></span><br><span class="line">    mBluetoothGatt.disconnect();</span><br><span class="line">    mBluetoothGatt.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="多设备连接"><a href="#多设备连接" class="headerlink" title="多设备连接"></a>多设备连接</h2><p>蓝牙适配器没有听过连接多个设备的接口，需要自己实现，即获取到目标设备的address后调用连接方法</p><blockquote><p>蓝牙操作的注意事项<br>蓝牙的写入操作( 包括 Descriptor 的写入操作), 读取操作必须序列化进行. 写入数据和读取数据是不能同时进行的, 如果调用了写入数据的方法, 马上调用又调用写入数据或者读取数据的方法,第二次调用的方法会立即返回 false, 代表当前无法进行操作. 详情可以参考 <a href="http://a1anwang.com/post-18.html">蓝牙读写操作返回 false，为什么多次读写只有一次回调？</a><br>Android 连接外围设备的数量有限，当不需要连接蓝牙设备的时候，必须调用 BluetoothGatt#close 方法释放资源。详细的参考可以看这里 <a href="http://www.eoeandroid.com/thread-902192-1-1.html?_dsign=d85c38ec">Android BLE 蓝牙开发的各种坑</a><br>蓝牙 API 连接蓝牙设备的超时时间大概在 20s 左右，具体时间看系统实现。有时候某些设备进行蓝牙连接的时间会很长，大概十多秒。如果自己手动设置了连接超时时间（例如通过 Handler#postDelay 设置了 5s 后没有进入 BluetoothGattCallback#onConnectionStateChange 就执行 BluetoothGatt#close 操作强制释放断开连接释放资源）在某些设备上可能会导致接下来几次的连接尝试都会在 BluetoothGattCallback#onConnectionStateChange 返回 state &#x3D;&#x3D; 133。另外可以参考这篇吐槽 <a href="http://www.loverobots.cn/android-ble-connection-solution-bluetoothgatt-status-133.html">Android 中 BLE 连接出现“BluetoothGatt status 133”的解决方法</a><br>所有的蓝牙操作使用 Handler 固定在一条线程操作，这样能省去很多因为线程不同步导致的麻烦</p></blockquote><h3 id="重要实例"><a href="#重要实例" class="headerlink" title="重要实例"></a>重要实例</h3><p>经典蓝牙聊天实例：<a href="https://github.com/googlesamples/android-BluetoothChat">https://github.com/googlesamples/android-BluetoothChat</a><br>低功耗蓝牙：<a href="https://github.com/googlesamples/android-BluetoothLeGatt">https://github.com/googlesamples/android-BluetoothLeGatt</a><br>作为外设（API&gt;&#x3D;21）：<a href="https://github.com/googlesamples/android-BluetoothAdvertisements">https://github.com/googlesamples/android-BluetoothAdvertisements</a><br>基础概念讲解：<a href="http://blog.csdn.net/qinxiandiqi/article/details/40741269">http://blog.csdn.net/qinxiandiqi/article/details/40741269</a><br>深入理论:<a href="http://www.race604.com/android-ble-in-action/">http://www.race604.com/android-ble-in-action/</a><br>AndroidBLE蓝牙框架，包括扫描、连接、设置通知、发送数据、读取、接收数据和OTA升级以及各种直观的回调:<br><a href="https://github.com/Alex-Jerry/Android-BLE">https://github.com/Alex-Jerry/Android-BLE</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> BLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android BLE蓝牙之Peripheral</title>
      <link href="/blog/2018/09/04/android-ble-lan-ya-zhi-peripheral/"/>
      <url>/blog/2018/09/04/android-ble-lan-ya-zhi-peripheral/</url>
      
        <content type="html"><![CDATA[<p>Android 5.0（API 21）之前不能当成外设(蓝牙耳机、音响等)来使用，只能作为中心即主机<br>并不是Android 5.0的系统就可以支持BLE Peripheral，这个和硬件也是有关系的,谷歌从ANdroid 5.0系统SDK已经开始支持check手机是否支持BLE Peripheral</p><h2 id="声明蓝牙开发权限"><a href="#声明蓝牙开发权限" class="headerlink" title="声明蓝牙开发权限"></a>声明蓝牙开发权限</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span>/&gt;</span><br><span class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span>/&gt;</span><br><span class="line"><span class="comment">// 是否必须支持低功耗蓝牙，此处必须</span></span><br><span class="line"> &lt;uses-feature</span><br><span class="line">    android:<span class="built_in">name</span>=<span class="string">&quot;android.hardware.bluetooth_le&quot;</span></span><br><span class="line">    android:required=<span class="string">&quot;true&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><h2 id="检查是否支持BLE、BLE-Peripheral"><a href="#检查是否支持BLE、BLE-Peripheral" class="headerlink" title="检查是否支持BLE、BLE Peripheral"></a>检查是否支持BLE、BLE Peripheral</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首先检查是否支持BLE、BLE Peripheral</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;BLE not supported&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line"><span class="comment">//            finish();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mBluetoothManager = (BluetoothManager) getSystemService(BLUETOOTH_SERVICE);</span><br><span class="line">        mBluetoothAdapter = mBluetoothManager.getAdapter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Bluetooth not supported&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">            Intent enableBtIntent = <span class="keyword">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">            startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">            <span class="comment">//判断是否打开蓝牙,如果没有打开需要回调打开蓝牙,这里省略,请自行打开蓝牙</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mBluetoothAdapter.isMultipleAdvertisementSupported()) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;This device not support peripheral&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mBluetoothLeAdvertiser = mBluetoothAdapter.getBluetoothLeAdvertiser();</span><br><span class="line">        <span class="keyword">if</span> (mBluetoothLeAdvertiser == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;This device not support peripheral&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="准备发送广播"><a href="#准备发送广播" class="headerlink" title="准备发送广播"></a>准备发送广播</h2><h3 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mBluetoothLeAdvertiser<span class="selector-class">.startAdvertising</span>(createAdvSettings(true, <span class="number">0</span>), <span class="built_in">createAdvertiseData</span>(), mAdvertiseCallback);</span><br></pre></td></tr></table></figure><h3 id="广播设置参数AdvertiseSettings"><a href="#广播设置参数AdvertiseSettings" class="headerlink" title="广播设置参数AdvertiseSettings"></a>广播设置参数AdvertiseSettings</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** create AdvertiseSettings */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> AdvertiseSettings <span class="title function_">createAdvSettings</span><span class="params">(<span class="type">boolean</span> connectable, <span class="type">int</span> timeoutMillis)</span> &#123;</span><br><span class="line"> AdvertiseSettings.<span class="type">Builder</span> <span class="variable">mSettingsbuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvertiseSettings</span>.Builder();</span><br><span class="line"> mSettingsbuilder.setAdvertiseMode(AdvertiseSettings.ADVERTISE_MODE_BALANCED);</span><br><span class="line"> mSettingsbuilder.setConnectable(connectable);</span><br><span class="line"> mSettingsbuilder.setTimeout(timeoutMillis);</span><br><span class="line"> mSettingsbuilder.setTxPowerLevel(AdvertiseSettings.ADVERTISE_TX_POWER_HIGH);</span><br><span class="line"> <span class="type">AdvertiseSettings</span> <span class="variable">mAdvertiseSettings</span> <span class="operator">=</span> mSettingsbuilder.build();</span><br><span class="line"><span class="keyword">if</span>(mAdvertiseSettings == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(D)&#123;</span><br><span class="line">Toast.makeText(mContext, <span class="string">&quot;mAdvertiseSettings == null&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">Log.e(TAG,<span class="string">&quot;mAdvertiseSettings == null&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mAdvertiseSettings;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="广播数据AdvertiseData"><a href="#广播数据AdvertiseData" class="headerlink" title="广播数据AdvertiseData"></a>广播数据AdvertiseData</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AdvertiseData <span class="title function_">createAdvertiseData</span><span class="params">()</span>&#123; </span><br><span class="line"> AdvertiseData.<span class="type">Builder</span>    <span class="variable">mDataBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvertiseData</span>.Builder();</span><br><span class="line">mDataBuilder.addServiceUuid(ParcelUuid.fromString(HEART_RATE_SERVICE));</span><br><span class="line"><span class="type">AdvertiseData</span> <span class="variable">mAdvertiseData</span> <span class="operator">=</span> mDataBuilder.build();</span><br><span class="line"><span class="keyword">if</span>(mAdvertiseData==<span class="literal">null</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(D)&#123;</span><br><span class="line">Toast.makeText(mContext, <span class="string">&quot;mAdvertiseSettings == null&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">Log.e(TAG,<span class="string">&quot;mAdvertiseSettings == null&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mAdvertiseData;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="广播回调Callback"><a href="#广播回调Callback" class="headerlink" title="广播回调Callback"></a>广播回调Callback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">AdvertiseCallback</span> <span class="variable">mAdvertiseCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvertiseCallback</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartSuccess</span><span class="params">(AdvertiseSettings settingsInEffect)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onStartSuccess(settingsInEffect);</span><br><span class="line"> <span class="keyword">if</span> (settingsInEffect != <span class="literal">null</span>) &#123;</span><br><span class="line"> Log.d(TAG, <span class="string">&quot;onStartSuccess TxPowerLv=&quot;</span> + settingsInEffect.getTxPowerLevel() + <span class="string">&quot; mode=&quot;</span> + settingsInEffect.getMode()</span><br><span class="line"> + <span class="string">&quot; timeout=&quot;</span> + settingsInEffect.getTimeout());</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> Log.e(TAG, <span class="string">&quot;onStartSuccess, settingInEffect is null&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">showText(<span class="string">&quot;1. initGattServer Success&quot;</span>);</span><br><span class="line"> Log.e(TAG,<span class="string">&quot;onStartSuccess settingsInEffect&quot;</span> + settingsInEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartFailure</span><span class="params">(<span class="type">int</span> errorCode)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onStartFailure(errorCode);</span><br><span class="line">showText(<span class="string">&quot;1. initGattServer failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="广播关闭"><a href="#广播关闭" class="headerlink" title="广播关闭"></a>广播关闭</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopAdvertise</span>()</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (mBluetoothLeAdvertiser != <span class="literal">null</span>) &#123;</span><br><span class="line"> mBluetoothLeAdvertiser.stopAdvertising(mAdvertiseCallback);</span><br><span class="line"> mBluetoothLeAdvertiser = <span class="literal">null</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>附上代码地址: <a href="https://github.com/xmaihh/Android-BLEPeripheral">https://github.com/xmaihh/Android-BLEPeripheral</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> BLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android BLE蓝牙简介</title>
      <link href="/blog/2018/09/02/android-ble-lan-ya-jian-jie/"/>
      <url>/blog/2018/09/02/android-ble-lan-ya-jian-jie/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>android 从4.3系统开始可以连接BLE设备,iOS是从7.0版本开始支持BLE<br>android 从5.0系统开始可以模拟设备发出BLE广播,这个新功能是对标于iOS系统的手机模拟iBeacon设备<br>BLE设备之所以能被手机扫描到,是因为BLE设备在每隔一段时间广播一次,这个广播里面包含很多数据<br>并不是Android L的系统就可以支持BLE Peripheral，这个和硬件也是有关系的,谷歌从5.0系统SDK已经开始支持check手机是否支持BLE Peripheral<br>在Android 5.0 API 21 android.bluetooth.le包下，新增加 Scaner相关类和 Advertiser 相关类,大致结构如下：</p><ul><li>Android BLE 周边设备 （Peripheral）可以通过 Advertiser 相关类实现操作； </li><li>Android BLE 中心设备 （Central）可以通过 Scanner相关类实现蓝牙扫描； </li><li>Android BLE 建立中心连接的时候，使用 BlueToothDevice#connectGatt() 实现</li></ul><h2 id="Central-和-Peripheral"><a href="#Central-和-Peripheral" class="headerlink" title="Central 和 Peripheral"></a>Central 和 Peripheral</h2><h3 id="蓝牙通信规则"><a href="#蓝牙通信规则" class="headerlink" title="蓝牙通信规则"></a>蓝牙通信规则</h3><p>Bluetooth BLE 的交互有两个角色 ： Central 与 Peripheral 。可以对比传统的CS结构，理解为客户端-服务端结构。</p><ul><li>服务端 （外围设备）： Peripheral 通常具有其他设备所需要的数据，即数据提供服务；</li><li>客户端（中心设备）：Central 通常通过使用Perpheral 的信息来实现一些特定的功能 ;</li></ul><h3 id="Central-发现并连接广播中的-Peripheral"><a href="#Central-发现并连接广播中的-Peripheral" class="headerlink" title="Central 发现并连接广播中的 Peripheral"></a>Central 发现并连接广播中的 Peripheral</h3><p>在BLE中 ，Peripheral 通过广播的方式向Central提供数据是主要方式。主要操作如下：</p><ul><li>服务端 外围设备（Peripheral）： 向外广播数据包（Advertising）形式的数据，比如设备名称，功能等;</li><li>客户端 中心设备（Central ） ： 可以通过实现扫描和监听到广播数据包，并展示数据;</li></ul><h3 id="外围设备（Peripheral-）数据构成"><a href="#外围设备（Peripheral-）数据构成" class="headerlink" title="外围设备（Peripheral ）数据构成"></a>外围设备（Peripheral ）数据构成</h3><ul><li>Peripheral 包含一个或者多个Service（服务）以及有关其连接信号强度的有用信息 。</li><li>Service ：是指为了实现一个功能或者特性的数据采集和相关行为的集合，包含一个或多个特征（Characteristic）。</li><li>Characteristic ：它包括一个value和0至多个对次value的描述（Descriptor），知道更多数据细节。</li><li>Descriptor ： 对Characteristic的描述，例如范围、计量单位等</li></ul><h2 id="Central-与-Peripheral-通信"><a href="#Central-与-Peripheral-通信" class="headerlink" title="Central 与 Peripheral 通信"></a>Central 与 Peripheral 通信</h2><p>在 Central 与 Perpheral 建立连接后，就可以发现（discoverServices）Perpheral 提供的所有的Services和Characteristic 。然后，Central 可以通过读写Service中的Characteristic 的value与Perpheral进行通信</p><h3 id="Central-（中心设备）开发流程"><a href="#Central-（中心设备）开发流程" class="headerlink" title="Central （中心设备）开发流程"></a>Central （中心设备）开发流程</h3><ol><li><p>建立中心角色<br>确定中心角色，客户端确立。</p></li><li><p>扫描 外设<br>扫描设备：Android 5.0 以下使用 BluetoothAdapter#startLeScan() 实现扫描，Android5.0及其以上，使用android.bluetooth.le 包下 BluetoothLeScaner#startScan()实现。</p></li><li><p>建立连接<br>中心设备主要的类 BluetoothGatt 核心对象，通过 BlueToothDevice#connectGatt（） 可以获取到操作对象</p></li><li><p>获取services与characteristics<br>在连接设备的时候，会使用BluetoothGattCallback 进行一些数据返回和状态返回，当连接成功时，进行discoverservices </p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onConnectionStateChange</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status, <span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newState == BluetoothGatt.STATE_CONNECTED) &#123;</span><br><span class="line">        gatt.discoverServices();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServicesDiscovered</span><span class="params">(BluetoothGatt gatt, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onServicesDiscovered(gatt, status);</span><br><span class="line">    <span class="comment">//当调用 discoverServices的时候，会调用此方法</span></span><br><span class="line">    printServices(gatt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>与外设设备交互和订阅 Characteristic 通知</p></li><li><p>断开连接 </p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mBluetoothGatt != <span class="literal">null</span>) &#123;</span><br><span class="line">        mBluetoothGatt.disconnect();</span><br><span class="line">        mBluetoothGatt.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="Peripheral（外围设备）开发流程"><a href="#Peripheral（外围设备）开发流程" class="headerlink" title="Peripheral（外围设备）开发流程"></a>Peripheral（外围设备）开发流程</h3><ol><li><p>确定外围设备</p></li><li><p>初始化外围设备管理对象<br>Android 5.0 之前没有外围设备开发，目前使用 BluetoothLeAdvertiser 进行外围设备管理；可以通过下面的方法获取 BluetoothAdapter#getBluetoothLeAdvertiser() 可以获取到该对象。</p></li><li><p>打开外围广播<br>根据SERIVE_UUID，打开一个外围设备连接，通过下面类实现BluetoothLeAdvertiser#startAdvertising();</p></li><li><p>获取外围设备Server<br>通过BluetoothGattServer 进行订阅通知，读写Characteristic操作，通过下面方法获取。<br>mBluetoothManager.openGattServer(mContext, bluetoothGattServerCallback)</p></li></ol><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p>后续会推出Android-BLE蓝牙之Peripheral和Android-BLE蓝牙之Central详细记录BLE蓝牙作为中心设备和外围设备开发<br><a href="https://developer.android.google.cn/reference/android/bluetooth/le/AdvertiseData.html">https://developer.android.google.cn/reference/android/bluetooth/le/AdvertiseData.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> BLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android串口通信</title>
      <link href="/blog/2018/08/23/android-chuan-kou-tong-xin/"/>
      <url>/blog/2018/08/23/android-chuan-kou-tong-xin/</url>
      
        <content type="html"><![CDATA[<h3 id="开发环境："><a href="#开发环境：" class="headerlink" title="开发环境："></a>开发环境：</h3><ul><li>AndroidStudio3.1.4</li><li>JDK_1.8.0_152_release</li><li>Compile Sdk Version API28</li><li>Gradle 4.4</li><li>NDK 17.1.4828580</li></ul><p>Android与下位机通信，串口通信是比较常见的一种方案。Google官方提供了一个项目<a href="https://code.google.com/archive/p/android-serialport-api/">android-serialport-api</a>用来读取和写入Linux TTY串行端口<br>支持的功能包括：<em>列出设备上可用的串行端口，包括USB到串行适配器</em>配置串行端口（波特率，停止位，权限，…）*提供标准InputStream和OutputStream Java接口<br>代码库地址<a href="https://github.com/cepr/android-serialport-api">https://github.com/cepr/android-serialport-api</a></p><p>AndroidStudio3.1使用CMake来编译jni</p><p>1.下载<a href="https://github.com/cepr/android-serialport-api">https://github.com/cepr/android-serialport-api</a>到本地。<br>在项目名&#x2F;app&#x2F;src&#x2F;main&#x2F;java下创建android_serialport_api目录(目录名不要改)<br>将android-serialport-api&#x2F;android-serialport-api&#x2F;project&#x2F;src&#x2F;android_serialport_api&#x2F;目录下的SerialPort.java和SerialPortFinder.java复制到android_serialport_api目录下<br>SerialPortFinder.java 用于查找串口设备<br>SerialPort.java 用于jni方法调用</p><p>2.创建JNI目录，复制c文件<br>在main目录右键New—Folder—JNI Floder—Finish<br>将SerialPort.c和SerialPort.h复制到生成的cpp目录下<br>使用CMake只需要修改cpp文件和CMakeLists.txt。<br>CMake生成的cpp文件位于app&#x2F;src&#x2F;main&#x2F;cpp目录，并且cpp文件不需要再引入java类的h文件。<br>CMakeLists.txt位于app目录下<br>特别注意SerialPort.h文件的生成格式</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class android_serialport_api_SerialPort */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Included_android_serialport_api_SerialPort</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Included_android_serialport_api_SerialPort</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     android_serialport_api_SerialPort</span></span><br><span class="line"><span class="comment"> * Method:    open</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;II)Ljava/io/FileDescriptor;</span></span><br><span class="line"><span class="comment"> */</span>                       <span class="comment">// 命名格式: Java_包名_类目录_类名_接口</span></span><br><span class="line"> <span class="comment">// 通过执行 `javah -jni android_serialport_api_SerialPort`生成的.h文件</span></span><br><span class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_android_1serialport_1api_SerialPort_open</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jclass, jstring, jint, jint)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     android_serialport_api_SerialPort</span></span><br><span class="line"><span class="comment"> * Method:    close</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_android_1serialport_1api_SerialPort_close</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>3.修改modue的build.gradle，设置JNI<br>在defaultConfig段落添加cmake设置</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">android</span> &#123;</span><br><span class="line">    compileSdkVersion <span class="number">28</span></span><br><span class="line">    <span class="keyword">defaultConfig</span> &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.ex.serialport&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">28</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">        <span class="comment">// 添加CMake设置 start //</span></span><br><span class="line">        <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">            <span class="keyword">cmake</span> &#123;</span><br><span class="line">                cppFlags <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加CMake设置 end//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">buildTypes</span> &#123;</span><br><span class="line">        <span class="keyword">release</span> &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="symbol">&#x27;proguard</span><span class="operator">-</span>android.txt&#x27;), <span class="symbol">&#x27;proguard</span><span class="operator">-</span>rules.pro&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加CMake设置 start //</span></span><br><span class="line">    <span class="keyword">externalNativeBuild</span> &#123;</span><br><span class="line">        <span class="keyword">cmake</span> &#123;</span><br><span class="line">            path <span class="string">&quot;CMakeLists.txt&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加CMake设置 end //</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.由于API 19之后的 termios.h 里面的函数有调整，因此调试过程中，出现</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.UnsatisfiedLinkError</span>: dlopen failed: cannot locate <span class="selector-tag">symbol</span> <span class="string">&quot;tcgetattr&quot;</span> referenced by <span class="string">&quot;libserialport.so&quot;</span>...</span><br></pre></td></tr></table></figure><p>解决方法：</p><p>将API 19 的 termios.h 拷贝到 jni 目录下<br>termios.h</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2008 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> * All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment"> * modification, are permitted provided that the following conditions</span></span><br><span class="line"><span class="comment"> * are met:</span></span><br><span class="line"><span class="comment"> *  * Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment"> *  * Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer in</span></span><br><span class="line"><span class="comment"> *    the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment"> *    distribution.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span></span><br><span class="line"><span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span></span><br><span class="line"><span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span></span><br><span class="line"><span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span></span><br><span class="line"><span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span></span><br><span class="line"><span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></span><br><span class="line"><span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span></span><br><span class="line"><span class="comment"> * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span></span><br><span class="line"><span class="comment"> * SUCH DAMAGE.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _TERMIOS_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TERMIOS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/cdefs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/termios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__BEGIN_DECLS</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Redefine these to match their ioctl number */</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  TCSANOW</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TCSANOW    TCSETS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  TCSADRAIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TCSADRAIN  TCSETSW</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  TCSAFLUSH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TCSAFLUSH  TCSETSF</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">tcgetattr</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> termios *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, TCGETS, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">tcsetattr</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> __opt, <span class="type">const</span> <span class="keyword">struct</span> termios *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, __opt, (<span class="type">void</span> *)s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">tcflow</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, TCXONC, (<span class="type">void</span> *)(<span class="type">intptr_t</span>)action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">tcflush</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> __queue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, TCFLSH, (<span class="type">void</span> *)(<span class="type">intptr_t</span>)__queue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">pid_t</span> <span class="title">tcgetsid</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pid_t</span> _pid;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, TIOCGSID, &amp;_pid) ? (<span class="type">pid_t</span>)<span class="number">-1</span> : _pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">tcsendbreak</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> __duration)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ioctl</span>(fd, TCSBRKP, (<span class="type">void</span> *)(<span class="type">uintptr_t</span>)__duration);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">speed_t</span> <span class="title">cfgetospeed</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> termios *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">speed_t</span>)(s-&gt;c_cflag &amp; CBAUD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">cfsetospeed</span><span class="params">(<span class="keyword">struct</span> termios *s, <span class="type">speed_t</span>  speed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s-&gt;c_cflag = (s-&gt;c_cflag &amp; ~CBAUD) | (speed &amp; CBAUD);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">speed_t</span> <span class="title">cfgetispeed</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> termios *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">speed_t</span>)(s-&gt;c_cflag &amp; CBAUD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">int</span> <span class="title">cfsetispeed</span><span class="params">(<span class="keyword">struct</span> termios *s, <span class="type">speed_t</span>  speed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s-&gt;c_cflag = (s-&gt;c_cflag &amp; ~CBAUD) | (speed &amp; CBAUD);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __inline__ <span class="type">void</span> <span class="title">cfmakeraw</span><span class="params">(<span class="keyword">struct</span> termios *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s-&gt;c_iflag &amp;= ~(IGNBRK|BRKINT|PARMRK|ISTRIP|INLCR|IGNCR|ICRNL|IXON);</span><br><span class="line">    s-&gt;c_oflag &amp;= ~OPOST;</span><br><span class="line">    s-&gt;c_lflag &amp;= ~(ECHO|ECHONL|ICANON|ISIG|IEXTEN);</span><br><span class="line">    s-&gt;c_cflag &amp;= ~(CSIZE|PARENB);</span><br><span class="line">    s-&gt;c_cflag |= CS8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__END_DECLS</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _TERMIOS_H_ */</span></span></span><br></pre></td></tr></table></figure><p>5.编辑 CMake 脚本CMakeLists.txt<br>每次创建一个新的库，需要添加另一个 add_library() 脚本，每个add_library 脚本语句只能导入一个库</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_library(serial_port</span><br><span class="line">            SHARED</span><br><span class="line">            <span class="attribute">src</span>/<span class="selector-tag">main</span>/cpp/SerialPort<span class="selector-class">.c</span>)</span><br></pre></td></tr></table></figure><p>如果同步报 Log 日志异常则需要给 .c 文件导入 Log 库</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该语句可以给一个 .c 库文件导入多个依赖库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>( <span class="comment"># Specifies the target library.</span></span><br><span class="line">                       <span class="comment"># add_library 生成的</span></span><br><span class="line">                       serialport</span><br><span class="line"></span><br><span class="line">                       <span class="comment"># Links the target library to the log library</span></span><br><span class="line">                       <span class="comment"># included in the NDK.</span></span><br><span class="line">                       <span class="comment"># find_library 找到的系统库</span></span><br><span class="line">                       <span class="variable">$&#123;log-lib&#125;</span> )</span><br></pre></td></tr></table></figure><p>默认是已经有导入 log-lib 库的，如果没有的话则需要在上面代码之前导入 log-lib 库</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find_library 定义当前代码库需要依赖的系统或者第三方库文件</span></span><br><span class="line"><span class="keyword">find_library</span>( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">              <span class="comment"># 指定要查找的系统库, 给一个名字</span></span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              <span class="comment"># Specifies the name of the NDK library that</span></span><br><span class="line">              <span class="comment"># you want CMake to locate.</span></span><br><span class="line">              <span class="comment"># 真正要查找的liblog.so或者liblog.a</span></span><br><span class="line">              log )</span><br></pre></td></tr></table></figure><p>6.编译运行，生成.so文件<br>.so文件在 \项目\app\build\intermediates\cmake\下release或者debug的obj目录下arm64-v8a、armeabi-v7a、x86、x86_64</p><h2 id="串口的参数"><a href="#串口的参数" class="headerlink" title="串口的参数"></a>串口的参数</h2><p>串口中有五个重要的参数：串口设备名、波特率、奇偶校验位、数据位、停止位。</p><p>设备名称：串口的名称。<br>波特率：传输速率的参数，波特率和传输距离成反比。<br>校验位：在串口通信中一种简单的检错方式，有四种检错方式：偶、奇、高和低，允许无校验位。<br>数据位：通信中实际数据位的参数<br>停止位：用于表示单个包的最后一位。</p><p>其中检验位一般默认位NONE，数据位一般默认为8，停止位默认为1，校验位是为了减少误差的会根据奇、偶进行补位操作</p><h2 id="Android-串口通信"><a href="#Android-串口通信" class="headerlink" title="Android 串口通信"></a>Android 串口通信</h2><p>Android 主板在与其它硬件进行串口通信时，串口作为底层实现，Android 系统把设备作为一个文件，与其他设备进行串口通信就相当于读写此文件。<br>所以，串口通信其实就是对系统根目录下 &#x2F;proc&#x2F;tty&#x2F;drivers 文件进行流的读写，因此，串口读写需要 Android 系统 Root 权限。<br>用 串口线 连接开发板 和 PC，然后在串口调试工具中，打开对应位置的端口。如果提示失败，就要检查串口线的端口号是否正确。</p><p>用数据线连接开发板至 PC，用 adb 命令打开 Android 系统对应的串口文件。<br>以 root 权限进入系统，</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span></span><br><span class="line"><span class="keyword">su</span></span><br></pre></td></tr></table></figure><p>然后，更改串口文件ttyS3的读写权限，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 777 /dev/ttyS3</span><br></pre></td></tr></table></figure><p>最后，写入信息 1111  到串口文件ttyS3里</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1111 &gt; /dev/ttyS3</span><br></pre></td></tr></table></figure><p>观察 PC 上的串口调试工具，如果 PC 上能收到信息，说明调通了，那么就可以进行应用开发<br><a href="https://github.com/xmaihh/SerialportDemo">源码地址</a><br>PC端调试工具<a href="https://github.com/xmaihh/SerialportDemo/blob/master/serial_port_utility_latest.exe">友善串口调试工具</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Jni </tag>
            
            <tag> Serialport </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java全栈开发技术图谱</title>
      <link href="/blog/2018/08/15/java-quan-zhan-kai-fa-ji-zhu-tu-pu/"/>
      <url>/blog/2018/08/15/java-quan-zhan-kai-fa-ji-zhu-tu-pu/</url>
      
        <content type="html"><![CDATA[<h1 id="常用模式与工具"><a href="#常用模式与工具" class="headerlink" title="常用模式与工具"></a>常用模式与工具</h1><p>学习Java技术体系,设计模式,流行的框架与组件</p><ul><li>常见的设计模式,编码必备</li><li>Spring5,做应用必不可少的最新框架</li><li>MyBatis,玩数据库必不可少的组件</li></ul><h2 id="常用设计模式"><a href="#常用设计模式" class="headerlink" title="常用设计模式"></a>常用设计模式</h2><ul><li>Proxy代理模式</li><li>Factory工厂模式</li><li>Singleton单例模式</li><li>Delegate委派模式</li><li>Strategy策略模式</li><li>Prototype原型模式</li><li>Template模板模式</li></ul><h2 id="Spring5"><a href="#Spring5" class="headerlink" title="Spring5"></a>Spring5</h2><ul><li>IOC容器设计原理及高级特性</li><li>AOP设计原理</li><li>FactoryBean与BeanFactory</li><li>Spring事务处理机制</li><li>基于SpringJDBC手写ORM框架</li><li>SpringMVC九大组件</li><li>手写实现SpringMVC框架</li><li>SpringMVC与Struts2对比分析</li><li>Spring5新特性</li></ul><h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><ul><li>代码自动生成器</li><li>MyBatis关联查询、嵌套查询</li><li>缓存使用场景及选择策略</li><li>Spring集成下的SqlSession与Mapper</li><li>MyBatis的事务</li><li>分析MyBatis的动态代理的真正实现</li><li>手写实现Mini版的MyBatis</li></ul><h1 id="工程化与工具"><a href="#工程化与工具" class="headerlink" title="工程化与工具"></a>工程化与工具</h1><p>工欲善其事必先利其器，不管是小白，还是资深开发，玩Java技术体系，选择好的工具，提升开发效率和团队协作效率，是必不可少的</p><ul><li>Maven,项目管理</li><li>Jenkins,持续集成</li><li>Sonar,代码质量管理</li><li>Git,版本管理</li></ul><h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><ul><li>生成可执行jar,理解Scope生成最精确的jar</li><li>类冲突、包依赖NoClassDefFoundError问题定位及解决</li><li>全面理解Maven的Lifecycle、Phase、Goal</li><li>架构师必备之Maven生成Archetype</li><li>Maven流行插件实战、手写自己的插件</li><li>Nexus的使用、上传、配置</li><li>对比Gradle</li></ul><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><ul><li>搭建Jenkins自动部署环境</li><li>Jenkins集成maven、git实现自动部署</li><li>test\pre\production多环境发布</li><li>Jenkins多环境配置、权限管理及插件使用</li></ul><h2 id="Sonar"><a href="#Sonar" class="headerlink" title="Sonar"></a>Sonar</h2><ul><li>使用Sonar进行代码质量管理</li><li>关于代码检查工具FindBugs&#x2F;PMD的运用</li><li>SonarQube代码质量管理平台安装及使用</li><li>使用Jenkins与Sonar集成对代码进行持续检测</li><li>Idea与Sonar集合的使用</li></ul><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><ul><li>什么是Git以及Git的工作原理</li><li>Git常用命令Best Practise(避坑教学)</li><li>Git冲突怎么引起的,如何解决</li><li>架构师职责:Git Flow规范团队Git使用教程</li><li>团队案例分享</li></ul><h1 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h1><p>高并发，高可用，海量数据，没有分布式的架构知识肯定是玩不转的</p><ul><li>分布式架构原理</li><li>分布式架构策略</li><li>分布式中间件</li><li>分布式架构实战</li></ul><h2 id="分布式架构原理"><a href="#分布式架构原理" class="headerlink" title="分布式架构原理"></a>分布式架构原理</h2><ul><li>分布式架构演进过程</li><li>如何把应用从单机扩展到分布式</li><li>CDN加速静态文件访问</li><li>系统监控、容灾、存储动态扩容</li><li>架构设计及业务驱动划分</li><li>CAP、Base理论以及其应用</li></ul><h2 id="分布式架构策略"><a href="#分布式架构策略" class="headerlink" title="分布式架构策略"></a>分布式架构策略</h2><ul><li>分布式架构网络通信原理剖析</li><li>通信协议中的序列化和反序列化</li><li>基于框架的RPC技术 Webservice&#x2F;RMI&#x2F; Hessian</li><li>深入分析 Zookeeper在 disconf配置中心的应用</li><li>基于 Zookeeper实现分布式服务器动态上下线感知</li><li>深入分析 Zookeeper Zab协议及选举机制源码解读</li><li>Dubbo管理中心及监控平台安装部署</li><li>基于 Dubbo的分布式系统架构实战</li><li>Dubbo容错机制及高扩展性分析</li></ul><h2 id="分布式架构中间件"><a href="#分布式架构中间件" class="headerlink" title="分布式架构中间件"></a>分布式架构中间件</h2><ul><li>分布式消息通信 ActiveMQ&#x2F; Kafka&#x2F; RabbitMQ</li><li>Redis主从复制原理及无磁盘复制分析</li><li>图解 Redis中AOF和RDB持久化策略的原理</li><li>MongoDB企业级集群解决方案</li><li>MongoDB数据分片、转存及恢复策略</li><li>基于 OpenRest部署应用层Nginx以及Nginx+lua实践</li><li>Nginx反向代理服务器及负载均衡服务配置实战</li><li>基于Netty实现高性能IM聊天</li><li>基于Netty实现Dubbo多协议通信支持</li><li>Netty无锁化串行设计及高并发处理机制</li></ul><h2 id="分布式架构实战"><a href="#分布式架构实战" class="headerlink" title="分布式架构实战"></a>分布式架构实战</h2><ul><li>分布式全局ID生成方案</li><li>Session跨域共享及企业级单点登录解决方案实战</li><li>分布式事务解决方案实战</li><li>高并发下的服务降级、限流实战</li><li>基于分布式架构下分布式锁的解决方案实战</li><li>分布式架构下实现分布式定时调度</li></ul><h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><p>业务越来越复杂，服务分层，微服务架构是架构升级的必由之路，Java技术体系，和微服务相关的技术有哪些呢？</p><ul><li>微服务框架</li><li>Spring Cloud</li><li>Docker与虚拟化</li><li>微服务架构</li></ul><h2 id="微服务框架"><a href="#微服务框架" class="headerlink" title="微服务框架"></a>微服务框架</h2><ul><li>与微服务之间的关系</li><li>热部署实战</li><li>核心组件Starter、Actuator、AutoConfiguration、Cli</li><li>集成Mybatis实现多数据源路由实战</li><li>集成Dubbo实战</li><li>集成Redis缓存实战</li><li>集成Swagger2构建API管理及测试体系</li><li>实现多环境配置动态解析</li></ul><h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><ul><li>Eurrka注册中心</li><li>Ribbon集成REST实现负载均衡</li><li>OpenFeign声明式服务调用</li><li>Hystrix服务熔断降级方式</li><li>Zuul实现微服务网关</li><li>Config分布式统一配置中心</li><li>Sleuth调用链路跟踪</li><li>BUS消息总线</li><li>基于Hystrix实现接口降级实战</li><li>集成Spring Cloud实现统一整合方案</li></ul><h2 id="Docker虚拟化"><a href="#Docker虚拟化" class="headerlink" title="Docker虚拟化"></a>Docker虚拟化</h2><ul><li>Docker的镜像、仓库、容器</li><li>Docker File构建LNMP环保局部署个人博客Wordpress</li><li>Docker Compose构建LNMP环境部署个人博客Wordpress</li><li>Docker网络组成、路由互联、Openvswitch</li><li>基于Swarn构建Docker集群实战</li><li>Kubernetes简介</li></ul><h2 id="漫谈微服务架构"><a href="#漫谈微服务架构" class="headerlink" title="漫谈微服务架构"></a>漫谈微服务架构</h2><ul><li>SOA架构和微服务架构之间的区别和联系</li><li>如何设计微服务及其设计原则</li><li>解惑Spring Boot流行因素及能够解决什么问题</li><li>什么是Spring Cloud,为何要选择Spring Cloud</li><li>基于全局分析Spring Cloud各个组件所解决的问题</li></ul><h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>任何脱离细节的ppt架构师都是耍流氓，向上能运筹帷幄，向下能解决一线性能问题，Java技术体系，需要了解：</p><ul><li>性能指标体系</li><li>JVM调优</li><li>Web调优</li><li>DB调优</li></ul><h2 id="理解性能优化"><a href="#理解性能优化" class="headerlink" title="理解性能优化"></a>理解性能优化</h2><ul><li>性能基准</li><li>性能优化到底是什么？</li><li>衡量维度</li></ul><h2 id="JVM调优"><a href="#JVM调优" class="headerlink" title="JVM调优"></a>JVM调优</h2><ul><li>详解什么是JVM运行时数据区</li><li>详解什么是JVM内存模型JMM</li><li>详解GC可达</li><li>详解各垃圾回收器使用场景(THroughput\CMS)</li><li>详解GC日志,从日志找问题</li><li>实战MAT分析dump文件(推理、验证)</li></ul><h2 id="Tomcat调优"><a href="#Tomcat调优" class="headerlink" title="Tomcat调优"></a>Tomcat调优</h2><ul><li>How it works?探查Tomcat的运行机制及框架</li><li>分析Tomcat线程模型</li><li>Tomcat系统参数认识及调优</li><li>基准测试</li></ul><h2 id="MySQL调优"><a href="#MySQL调优" class="headerlink" title="MySQL调优"></a>MySQL调优</h2><ul><li>理解MySQL底层B+Tree机制</li><li>SQL执行计划详解</li><li>索引优化详解</li><li>SQL语句优化</li></ul>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android开发知识点总结</title>
      <link href="/blog/2018/08/13/android-kai-fa-zhi-shi-dian-zong-jie/"/>
      <url>/blog/2018/08/13/android-kai-fa-zhi-shi-dian-zong-jie/</url>
      
        <content type="html"><![CDATA[<p>（一）Java<br>一、HashMap和Hashtable区别？</p><p>这个一定要去看源码！看源码！看源码！实在看不下去的可以上网看别人的分析。简单总结有几点：</p><p>1.HashMap支持null Key和null Value；Hashtable不允许。这是因为HashMap对null进行了特殊处理，将null的hashCode值定为了0，从而将其存放在哈希表的第0个bucket。</p><p>2.HashMap是非线程安全，HashMap实现线程安全方法为Map map &#x3D; Collections.synchronziedMap(new HashMap())；Hashtable是线程安全</p><p>3.HashMap默认长度是16，扩容是原先的2倍；Hashtable默认长度是11，扩容是原先的2n+1</p><p>4.HashMap继承AbstractMap；Hashtable继承了Dictionary </p><p>扩展，HashMap 对比 ConcurrentHashMap ，HashMap 对比 SparseArray，LinkedArray对比ArrayList，ArrayList对比Vector</p><p>二、Java垃圾回收机制</p><p>需要理解JVM，内存划分——方法区、内存堆、虚拟机栈（线程私有）、本地方法栈（线程私有）、程序计数器（线程私有）, 理解回收算法——标记清除算法、可达性分析算法、标记-整理算法、复制算法、分代算法，优缺点都理解下。</p><p>详细的可以看看其他同学写的 点击打开链接</p><p>三、类加载机制</p><p>这个可以结合 热修复 深入理解下。点击打开链接</p><p>四、线程和线程池，并发，锁等一系列问题</p><p>这个可以扩展下 如何自己实现一个线程池？</p><p>五、HandlerThread、IntentService理解</p><p>六、弱引用、软引用区别</p><p>七、int、Integer有什么区别</p><p>主要考值传递和引用传递问题</p><p>八、手写生产者&#x2F;消费者 模式</p><p>（二）Android<br>一、android启动模式</p><p>需要了解下Activity栈和taskAffinity</p><p>1.Standard：系统默认，启动一个就多一个Activity实例</p><p>2.SingleTop：栈顶复用，如果处于栈顶，则生命周期不走onCreate()和onStart()，会调用onNewIntent()，适合推送消息详情页，比如新闻推送详情Activity;</p><p>3.SingleTask：栈内复用，如果存在栈内，则在其上所有Activity全部出栈，使得其位于栈顶，生命周期和SingleTop一样，app首页基本是用这个</p><p>4.SingleInstance：这个是SingleTask加强本，系统会为要启动的Activity单独开一个栈，这个栈里只有它，适用新开Activity和app能独立开的，如系统闹钟，微信的视频聊天界面不知道是不是，知道的同学告诉我下，在此谢过！</p><p>另外，SingleTask和SingleInstance好像会影响到onActivityResult的回调，具体问题大家搜下，我就不详说。</p><p>Intent也需要进一步了解，Action、Data、Category各自的用法和作用，还有常用的</p><p>Intent.FLAG_ACTIVITY_SINGLE_TOP</p><p>Intent.FLAG_ACTIVITY_NEW_TASK</p><p>Intent.FLAG_ACTIVITY_CLEAR_TOP</p><p>等等，具体看下源码吧。</p><p>二、View的绘制流程</p><p>ViewRoot<br>-&gt; performTraversal()<br>-&gt; performMeasure()<br>-&gt; performLayout()<br>-&gt; perfromDraw()<br>-&gt; View&#x2F;ViewGroup measure()<br>-&gt; View&#x2F;ViewGroup onMeasure()<br>-&gt; View&#x2F;ViewGroup layout()<br>-&gt; View&#x2F;ViewGroup onLayout()<br>-&gt; View&#x2F;ViewGroup draw()<br>-&gt; View&#x2F;ViewGroup onDraw()<br>看下invalidate方法，有带4个参数的，和不带参数有什么区别；requestLayout触发measure和layout，如何实现局部重新测量，避免全局重新测量问题。</p><p>三、事件分发机制</p><p>-&gt; dispatchTouchEvent()<br>-&gt; onInterceptTouchEvent()<br>-&gt; onTouchEvent()<br>requestDisallowInterceptTouchEvent(boolean)<br>还有onTouchEvent()、onTouchListener、onClickListener的先后顺序</p><p>四、消息分发机制</p><p>这个考得非常常见。一定要看源码，代码不多。带着几个问题去看：</p><p>1.为什么一个线程只有一个Looper、只有一个MessageQueue？</p><p>2.如何获取当前线程的Looper？是怎么实现的？（理解ThreadLocal）</p><p>3.是不是任何线程都可以实例化Handler？有没有什么约束条件？</p><p>4.Looper.loop是一个死循环，拿不到需要处理的Message就会阻塞，那在UI线程中为什么不会导致ANR？</p><p>5.Handler.sendMessageDelayed()怎么实现延迟的？结合Looper.loop()循环中，Message&#x3D;messageQueue.next()和MessageQueue.enqueueMessage()分析。</p><p>五、AsyncTask源码分析</p><p>优劣性分析，这个网上一大堆，不重述。</p><p>六、如何保证Service不被杀死？如何保证进程不被杀死？</p><p>这两个问题我面试过程有3家公司问到。</p><p>七、Binder机制，进程通信</p><p>Android用到的进程通信底层基本都是Binder，AIDL、Messager、广播、ContentProvider。不是很深入理解的，至少ADIL怎么用，Messager怎么用，可以写写看，另外序列化（Parcelable和Serilizable）需要做对比，这方面可以看看任玉刚大神的android艺术开发探索一书。</p><p>八、动态权限适配问题、换肤实现原理</p><p>这方面看下鸿洋大神的博文吧</p><p>九、SharedPreference原理，能否跨进程？如何实现？</p><p>（三）性能优化问题<br>一、UI优化</p><p>a.合理选择RelativeLayout、LinearLayout、FrameLayout,RelativeLayout会让子View调用2次onMeasure，而且布局相对复杂时，onMeasure相对比较复杂，效率比较低，LinearLayout在weight&gt;0时也会让子View调用2次onMeasure。LinearLayout weight测量分配原则。</p><p>b.使用标签<include><merge><ViewStub></p><p>c.减少布局层级，可以通过手机开发者选项&gt;GPU过渡绘制查看，一般层级控制在4层以内，超过5层时需要考虑是否重新排版布局。</p><p>d.自定义View时，重写onDraw()方法，不要在该方法中新建对象，否则容易触发GC，导致性能下降</p><p>e.使用ListView时需要复用contentView，并使用Holder减少findViewById加载View。</p><p>f.去除不必要背景，getWindow().setBackgroundDrawable(null)</p><p>g.使用TextView的leftDrawabel&#x2F;rightDrawable代替ImageView+TextView布局</p><p>二、内存优化</p><p>主要为了避免OOM和频繁触发到GC导致性能下降</p><p>a.Bitmap.recycle(),Cursor.close,inputStream.close()</p><p>b.大量加载Bitmap时，根据View大小加载Bitmap，合理选择inSampleSize，RGB_565编码方式；使用LruCache缓存</p><p>c.使用 静态内部类+WeakReference 代替内部类，如Handler、线程、AsyncTask</p><p>d.使用线程池管理线程，避免线程的新建</p><p>e.使用单例持有Context，需要记得释放，或者使用全局上下文</p><p>f.静态集合对象注意释放</p><p>g.属性动画造成内存泄露</p><p>h.使用webView，在Activity.onDestory需要移除和销毁，webView.removeAllViews()和webView.destory() </p><p>备：使用LeakCanary检测内存泄露</p><p>三、响应速度优化</p><p>Activity如果5秒之内无法响应屏幕触碰事件和键盘输入事件，就会出现ANR，而BroadcastReceiver如果10秒之内还未执行操作也会出现ANR，Serve20秒会出现ANR 为了避免ANR，可以开启子线程执行耗时操作，但是子线程不能更新UI，因此需要Handler消息机制、AsyncTask、IntentService进行线程通信。</p><p>备：出现ANR时，adb pull data&#x2F;anr&#x2F;tarces.txt 结合log分析</p><p>四、其他性能优化</p><p>a.常量使用static final修饰</p><p>b.使用SparseArray代替HashMap</p><p>c.使用线程池管理线程</p><p>d.ArrayList遍历使用常规for循环，LinkedList使用foreach</p><p>e.不要过度使用枚举，枚举占用内存空间比整型大</p><p>f.字符串的拼接优先考虑StringBuilder和StringBuffer</p><p>g.数据库存储是采用批量插入+事务</p><p>（四）设计模式<br>1.单例模式：好几种写法，要求会手写，分析优劣。一般双重校验锁中用到volatile，需要分析volatile的原理</p><p>2.观察者模式：要求会手写，有些面试官会问你在项目中用到了吗？实在没有到的可以讲一讲EventBus，它用到的就是观察者模式</p><p>3.适配器模式：要求会手写，有些公司会问和装饰器模式、代理模式有什么区别？</p><p>4.建造者模式+工厂模式：要求会手写</p><p>5.策略模式：这个问得比较少，不过有些做电商的会问。</p><p>6.MVC、MVP、MVVM：比较异同，选择一种你拿手的着重讲就行</p><p>（五）数据结构<br>1.HashMap、LinkedHashMap、ConcurrentHashMap，在用法和原理上有什么差异，很多公司会考HashMap原理，通过它做一些扩展，比如中国13亿人口年龄的排序问题，年龄对应桶的个数，年龄相同和hash相同问题类似。</p><p>2.ArrayList和LinkedList对比，这个相对简单一点。</p><p>3.平衡二叉树、二叉查找树、红黑树，这几个我也被考到。</p><p>4.Set原理，这个和HashMap考得有点类似，考hash算法相关，被问到过常用hash算法。HashSet内部用到了HashMap</p><p>（六）算法<br>算法主要考刷题吧，去LeetCode和牛客网刷下。</p><p>（七）源码理解<br>项目中多多少少会用到开源框架，很多公司都喜欢问原理和是否看过源码，比如网络框架Okhttp，这是最常用的，现在Retrofit+RxJava也很流行。</p><p>一、网络框架库 Okhttp</p><p>okhttp源码一定要去看下，里面几个关键的类要记住，还有连接池，拦截器都需要理解。被问到如何给某些特定域名的url增加header，如果是自己封装的代码，可以在封装Request中可以解决，也可以增加拦截器，通过拦截器去做。</p><p>推荐一篇讲解Okhttp不错的文章</p><p>二、消息通知 EventBus</p><p>1.EventBus原理：建议看下源码，不多。内部实现：观察者模式+注解+反射</p><p>2.EventBus可否跨进程问题？代替EventBus的方法（RxBus）</p><p>三、图片加载库（Fresco、Glide、Picasso）</p><p>1.项目中选择了哪个图片加载库？为什么选择它？其他库不好吗？这几个库的区别</p><p>2.项目中选择图片库它的原理，如Glide（LruCache结合弱引用），那么面试官会问LruCache原理，进而问LinkedHashMap原理，这样一层一层地问，所以建议看到不懂的追进去看。如Fresco是用来MVC设计模式，5.0以下是用了共享内存，那共享内存怎么用？Fresco怎么实现圆角？Fresco怎么配置缓存？</p><p>四、消息推送Push</p><p>1.项目中消息推送是自己做的还是用了第三方？如极光。还有没有用过其他的？这几家有什么优势区别，基于什么原因选择它的？</p><p>2.消息推送原理是什么？如何实现心跳连接？</p><p>五、TCP&#x2F;IP、Http&#x2F;Https</p><p>网络这一块如果简历中写道熟悉TCP&#x2F;IP协议，Http&#x2F;Https协议，那么肯定会被问道，我就验证了。一般我会回答网络层关系、TCP和UDP的区别，TCP三次握手（一定要讲清楚，SYN、ACK等标记位怎样的还有报文结构都需要熟悉下），四次挥手。为什么要三次握手？DDoS攻击。为什么握手三次，挥手要四次？Http报文结构，一次网络请求的过程是怎样的？Http和Https有什么不同？SSL&#x2F;TLS是怎么进行加密握手的？证书怎么校验？对称性加密算法和非对称加密算法有哪些？挑一个熟悉的加密算法简单介绍下？DNS解析是怎样的？</p><p>六、热更新、热修复、插件化(这一块要求高点，一般高级工程师是需要理解的)</p><p>了解classLoader</p><p>七、新技术</p><p>RxJava、RxBus、RxAndroid，这个在面试想去的公司时，可以反编译下他们的包，看下是不是用到，如果用到了，面试过程难免会问道，如果没有，也可以忽略，但学习心强的同学可以看下，比较是比较火的框架。</p><p>Retrofit，熟练okhttp的同学建议看下，听说结合RxJava很爽。</p><p>Kotlin</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ADB录屏命令</title>
      <link href="/blog/2018/07/30/adb-lu-ping-ming-ling/"/>
      <url>/blog/2018/07/30/adb-lu-ping-ming-ling/</url>
      
        <content type="html"><![CDATA[<h3 id="开始录制命令"><a href="#开始录制命令" class="headerlink" title="开始录制命令"></a>开始录制命令</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span><span class="language-bash"> screenrecord /sdcard/demo.mp4</span></span><br></pre></td></tr></table></figure><h3 id="限制录制时间"><a href="#限制录制时间" class="headerlink" title="限制录制时间"></a>限制录制时间</h3><p>参数: –time-limit</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screenrecord  --<span class="built_in">time</span>-<span class="built_in">limit</span> <span class="number">10</span> /sdcard/<span class="built_in">demo</span>.mp4</span><br></pre></td></tr></table></figure><p>说明:限制视频录制时间为10s,如果不限制,默认180s</p><h3 id="指定视频分辨率大小"><a href="#指定视频分辨率大小" class="headerlink" title="指定视频分辨率大小"></a>指定视频分辨率大小</h3><p>参数: –size</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">adb</span> shell screenrecord --size <span class="number">1280</span>*<span class="number">720</span> /sdcard/demo.mp4</span><br></pre></td></tr></table></figure><p>说明:录制视频，分辨率为<code>1280*720</code>，如果不指定默认使用手机的分辨率,为获得最佳效果，请使用设备上的高级视频编码(AVC)支持的大小</p><h3 id="指定视频的比特率"><a href="#指定视频的比特率" class="headerlink" title="指定视频的比特率"></a>指定视频的比特率</h3><p>参数: –bit-rate</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span><span class="language-bash"> screenrecord --bit-rate 6000000 /sdcard/demo.mp4</span></span><br></pre></td></tr></table></figure><p>说明:指定视频的比特率为6Mbps,如果不指定,默认为4Mbps. 你可以增加比特率以提高视频质量或为了让文件更小而降低比特率</p><h3 id="在命令行显示log"><a href="#在命令行显示log" class="headerlink" title="在命令行显示log"></a>在命令行显示log</h3><p>参数: –verbose</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ adb shell screenrecord --<span class="built_in">time</span>-limit <span class="number">10</span> --verbose /sdcard/demo.mp4</span><br><span class="line">Main display is <span class="number">1080</span>x1920 @<span class="number">60.00</span>fps (orientation=<span class="number">0</span>)</span><br><span class="line">Configuring recorder <span class="keyword">for</span> <span class="number">1080</span>x1920 video at <span class="number">4.00</span>Mbps</span><br><span class="line">Content <span class="built_in">area</span> is <span class="number">1080</span>x1920 at <span class="built_in">offset</span> x=<span class="number">0</span> y=<span class="number">0</span></span><br><span class="line"><span class="built_in">Time</span> limit reached</span><br><span class="line">Encoder stopping; recorded <span class="number">96</span> frames <span class="keyword">in</span> <span class="number">10</span> seconds</span><br><span class="line">Stopping encoder and muxer</span><br><span class="line">Executing: <span class="regexp">/system/</span>bin/am broadcast -a android.intent.action.MEDIA_SCANNER_SCAN_FILE -d file:<span class="comment">///sdcard/demo.mp4</span></span><br><span class="line"> </span><br><span class="line">Broadcasting: Intent &#123; act=android.intent.action.MEDIA_SCANNER_SCAN_FILE dat=file:<span class="comment">///sdcard/demo.mp4 &#125;</span></span><br><span class="line">Broadcast completed: result=<span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="旋转90度"><a href="#旋转90度" class="headerlink" title="旋转90度"></a>旋转90度</h3><p>参数: –rotate</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span><span class="language-bash"> screenrecord --rotate /sdcard/demo.mp4</span></span><br></pre></td></tr></table></figure><h3 id="查看帮助命令"><a href="#查看帮助命令" class="headerlink" title="查看帮助命令"></a>查看帮助命令</h3><p>参数: –help</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ adb shell screenrecord <span class="comment">--help</span></span><br><span class="line"><span class="keyword">Usage</span>: screenrecord [<span class="keyword">options</span>] &lt;filename&gt;</span><br><span class="line"> </span><br><span class="line">Records the devic<span class="string">e&#x27;s display to a .mp4 file.</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">Options:</span></span><br><span class="line"><span class="string">--size WIDTHxHEIGHT</span></span><br><span class="line"><span class="string">    Set the video size, e.g. &quot;1280x720&quot;.  Default is the device&#x27;</span>s main</span><br><span class="line">    display resolution (<span class="keyword">if</span> supported), <span class="number">1280</span>x720 <span class="keyword">if</span> <span class="keyword">not</span>.  <span class="keyword">For</span> best results,</span><br><span class="line">    use a size supported <span class="keyword">by</span> the AVC encoder.</span><br><span class="line"><span class="comment">--bit-rate RATE</span></span><br><span class="line">    <span class="keyword">Set</span> the video <span class="type">bit</span> rate, <span class="keyword">in</span> megabits per second.  <span class="keyword">Default</span> <span class="number">4</span>Mbps.</span><br><span class="line"><span class="comment">--time-limit TIME</span></span><br><span class="line">    <span class="keyword">Set</span> the maximum recording <span class="type">time</span>, <span class="keyword">in</span> seconds.  <span class="keyword">Default</span> / maximum <span class="keyword">is</span> <span class="number">180.</span></span><br><span class="line"><span class="comment">--rotate</span></span><br><span class="line">    Rotate the output <span class="number">90</span> degrees.</span><br><span class="line"><span class="comment">--verbose</span></span><br><span class="line">    Display interesting information <span class="keyword">on</span> stdout.</span><br><span class="line"><span class="comment">--help</span></span><br><span class="line">    <span class="keyword">Show</span> this message.</span><br><span class="line"> </span><br><span class="line">Recording continues <span class="keyword">until</span> Ctrl-C <span class="keyword">is</span> hit <span class="keyword">or</span> the <span class="type">time</span> <span class="keyword">limit</span> <span class="keyword">is</span> reached.</span><br></pre></td></tr></table></figure><h3 id="导出视频"><a href="#导出视频" class="headerlink" title="导出视频"></a>导出视频</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull <span class="string">/sdcard/demo.mp4</span> <span class="string">./</span></span><br></pre></td></tr></table></figure><p>说明:导出视频到当前目录</p><blockquote><p>Android版本要支持Android4.4(API level 19)以上<br>支持视频格式: mp4<br>录制视频的时候声音不会被录下来<br>不支持录制过程中屏幕旋转</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Launcher中Camera图标的显示与隐藏</title>
      <link href="/blog/2018/07/29/launcher-zhong-camera-tu-biao-de-xian-shi-yu-yin-cang/"/>
      <url>/blog/2018/07/29/launcher-zhong-camera-tu-biao-de-xian-shi-yu-yin-cang/</url>
      
        <content type="html"><![CDATA[<p>在camera模块的源码中我们发现DisableCameraReceiver的这样一个类，是继承自BroadcastReceiver一个广播接收器，在AndroidManifest.xml中发现这个reciver的intent-filter为<code>&lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot; /&gt;</code>，当系统启动之后，该模块就会收到这条系统广播，然后进行相应的处理<br>代码路径:packages&#x2F;apps&#x2F;Camera2&#x2F;src&#x2F;com&#x2F;android&#x2F;camera&#x2F;DisableCameraReceiver.java</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Disable camera-related activities if there is no camera.</span></span><br><span class="line">    <span class="keyword">boolean</span> needCameraActivity = CHECK_BACK_CAMERA_ONLY</span><br><span class="line">        ? hasBackCamera()</span><br><span class="line">        : hasCamera();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!needCameraActivity) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;disable all camera activities&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ACTIVITIES.length; i++) &#123;</span><br><span class="line">            disableComponent(context, ACTIVITIES[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable this receiver so it won&#x27;t run again.</span></span><br><span class="line">    disableComponent(context, <span class="string">&quot;com.android.camera.DisableCameraReceiver&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过needCameraActivity的值来判断是否需要隐藏camera应用,如果其值为true，则显示camera应用，否则，就隐藏掉</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private <span class="type">boolean</span> hasCamera() &#123;</span><br><span class="line">    <span class="type">int</span> n = android.hardware.Camera.getNumberOfCameras();</span><br><span class="line">    <span class="keyword">Log</span>.i(TAG, &quot;number of camera: &quot; + n);</span><br><span class="line">    <span class="keyword">return</span> (n &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="type">boolean</span> hasBackCamera() &#123;</span><br><span class="line">    <span class="type">int</span> n = android.hardware.Camera.getNumberOfCameras();</span><br><span class="line">    CameraInfo <span class="keyword">info</span> = <span class="built_in">new</span> CameraInfo();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        android.hardware.Camera.getCameraInfo(i, <span class="keyword">info</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">info</span>.facing == CameraInfo.CAMERA_FACING_BACK) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.i(TAG, &quot;back camera found: &quot; + i);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Log</span>.i(TAG, &quot;no back camera&quot;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过<code>frameworks/base/core/java/android/hardware/Camera.java</code>中的getNumberOfCameras()方法来获取camera的个数,这是一个本地方法，是通过JNI调用来获取的</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the number of physical cameras available on this device.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> total number of accessible camera devices, or 0 if there are no</span></span><br><span class="line"><span class="comment">   *   cameras or an error was encountered enumerating them.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">getNumberOfCameras</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>最后在<code>frameworks/av/camera/CameraBase.cpp</code>对getNumberOfCameras()函数实现</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TCam, <span class="keyword">typename</span> TCamTraits&gt;</span><br><span class="line"><span class="type">int</span> CameraBase&lt;TCam, TCamTraits&gt;::<span class="built_in">getNumberOfCameras</span>() &#123;</span><br><span class="line">    <span class="type">const</span> sp&lt;ICameraService&gt; cs = <span class="built_in">getCameraService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cs.<span class="built_in">get</span>()) &#123;</span><br><span class="line">        <span class="comment">// as required by the public Java APIs</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cs-&gt;<span class="built_in">getNumberOfCameras</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cs是CameraService的一个弱引用，找到<code>frameworks/av/services/camera/libcameraservice/CameraService.cpp</code>中的getNumberOfCameras()函数</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">CameraService::getNumberOfCameras</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mNumberOfCameras;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mNumberOfCameras是一个全局变量,在CameraService.cpp中赋值</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">void CameraService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    LOG1(<span class="string">&quot;CameraService::onFirstRef&quot;</span>);</span><br><span class="line"></span><br><span class="line">    BnCameraService::onFirstRef();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hw_get_module(CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">                (const hw_module_t **)&amp;mModule) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Could not load camera HAL module&quot;</span>);</span><br><span class="line">        mNumberOfCameras = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;Loaded \&quot;</span>%<span class="function"><span class="title">s</span>\&quot; camera module&quot;, mModule-&gt;</span>common.<span class="keyword">name</span>);</span><br><span class="line">        <span class="function"><span class="title">mNumberOfCameras</span> = mModule-&gt;</span>get_number_of_cameras();</span><br><span class="line">        <span class="keyword">if</span> (mNumberOfCameras &gt; MAX_CAMERAS) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;Number of cameras(%d) &gt; MAX_CAMERAS(%d).&quot;</span>,</span><br><span class="line">                    mNumberOfCameras, MAX_CAMERAS);</span><br><span class="line">            mNumberOfCameras = MAX_CAMERAS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; mNumberOfCameras; i++) &#123;</span><br><span class="line">            setCameraFree(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (mModule-&gt;</span>common.module_api_version &gt;=</span><br><span class="line">                CAMERA_MODULE_API_VERSION_2_1) &#123;</span><br><span class="line">            <span class="function"><span class="title">mModule</span>-&gt;</span>set_callbacks(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        VendorTagDescriptor::clearGlobalVendorTagDescriptor();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (mModule-&gt;</span>common.module_api_version &gt;= CAMERA_MODULE_API_VERSION_2_2) &#123;</span><br><span class="line">            setUpVendorTags();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CameraDeviceFactory::registerService(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android6.0授予预置APK的权限</title>
      <link href="/blog/2018/07/28/android6-0-shou-yu-yu-zhi-apk-de-quan-xian/"/>
      <url>/blog/2018/07/28/android6-0-shou-yu-yu-zhi-apk-de-quan-xian/</url>
      
        <content type="html"><![CDATA[<p>对我们系统中存在的应用进行默认权限设置,达到默认开启应用权限无需申请权限弹框的目的<br>方法1<br>修改<code>\frameworks\base\services\core\java\com\android\server\pm\PackageManagerService.java</code>，但CTS会有问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grantPermissionsLPw</span><span class="params">(PackageParser.Package pkg, <span class="type">boolean</span> replace,</span></span><br><span class="line"><span class="params">           String packageOfInterest)</span> &#123;</span><br><span class="line">       <span class="comment">// IMPORTANT: There are two types of permissions: install and runtime.</span></span><br><span class="line">       <span class="comment">// Install time permissions are granted when the app is installed to</span></span><br><span class="line">       <span class="comment">// all device users and users added in the future. Runtime permissions</span></span><br><span class="line">       <span class="comment">// are granted at runtime explicitly to specific users. Normal and signature</span></span><br><span class="line">       <span class="comment">// protected permissions are install time permissions. Dangerous permissions</span></span><br><span class="line">       <span class="comment">// are install permissions if the app&#x27;s target SDK is Lollipop MR1 or older,</span></span><br><span class="line">       <span class="comment">// otherwise they are runtime permissions. This function does not manage</span></span><br><span class="line">       <span class="comment">// runtime permissions except for the case an app targeting Lollipop MR1</span></span><br><span class="line">       <span class="comment">// being upgraded to target a newer SDK, in which case dangerous permissions</span></span><br><span class="line">       <span class="comment">// are transformed from install time to runtime ones.</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> (PackageSetting) pkg.mExtras;</span><br><span class="line">       <span class="keyword">if</span> (ps == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">PermissionsState</span> <span class="variable">permissionsState</span> <span class="operator">=</span> ps.getPermissionsState();</span><br><span class="line">       <span class="type">PermissionsState</span> <span class="variable">origPermissions</span> <span class="operator">=</span> permissionsState;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span>[] currentUserIds = UserManagerService.getInstance().getUserIds();</span><br><span class="line"></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">runtimePermissionsRevoked</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="type">int</span>[] changedRuntimePermissionUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">changedInstallPermission</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">           ps.installPermissionsFixed = <span class="literal">false</span>;</span><br><span class="line">           <span class="keyword">if</span> (!ps.isSharedUser()) &#123;</span><br><span class="line">               origPermissions = <span class="keyword">new</span> <span class="title class_">PermissionsState</span>(permissionsState);</span><br><span class="line">               permissionsState.reset();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// We need to know only about runtime permission changes since the</span></span><br><span class="line">               <span class="comment">// calling code always writes the install permissions state but</span></span><br><span class="line">               <span class="comment">// the runtime ones are written only if changed. The only cases of</span></span><br><span class="line">               <span class="comment">// changed runtime permissions here are promotion of an install to</span></span><br><span class="line">               <span class="comment">// runtime and revocation of a runtime from a shared user.</span></span><br><span class="line">               changedRuntimePermissionUserIds = revokeUnusedSharedUserPermissionsLPw(</span><br><span class="line">                       ps.sharedUser, UserManagerService.getInstance().getUserIds());</span><br><span class="line">               <span class="keyword">if</span> (!ArrayUtils.isEmpty(changedRuntimePermissionUserIds)) &#123;</span><br><span class="line">                   runtimePermissionsRevoked = <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       permissionsState.setGlobalGids(mGlobalGids);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> pkg.requestedPermissions.size();</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pkg.requestedPermissions.get(i);</span><br><span class="line">           <span class="keyword">final</span> <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> mSettings.mPermissions.get(name);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">               Log.i(TAG, <span class="string">&quot;Package &quot;</span> + pkg.packageName + <span class="string">&quot; checking &quot;</span> + name + <span class="string">&quot;: &quot;</span> + bp);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (bp == <span class="literal">null</span> || bp.packageSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (packageOfInterest == <span class="literal">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                   Slog.w(TAG, <span class="string">&quot;Unknown permission &quot;</span> + name</span><br><span class="line">                           + <span class="string">&quot; in package &quot;</span> + pkg.packageName);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> <span class="type">String</span> <span class="variable">perm</span> <span class="operator">=</span> bp.name;</span><br><span class="line">           <span class="type">boolean</span> <span class="variable">allowedSig</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">           <span class="type">int</span> <span class="variable">grant</span> <span class="operator">=</span> GRANT_DENIED;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Keep track of app op permissions.</span></span><br><span class="line">           <span class="keyword">if</span> ((bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">               ArraySet&lt;String&gt; pkgs = mAppOpPermissionPackages.get(bp.name);</span><br><span class="line">               <span class="keyword">if</span> (pkgs == <span class="literal">null</span>) &#123;</span><br><span class="line">                   pkgs = <span class="keyword">new</span> <span class="title class_">ArraySet</span>&lt;&gt;();</span><br><span class="line">                   mAppOpPermissionPackages.put(bp.name, pkgs);</span><br><span class="line">               &#125;</span><br><span class="line">               pkgs.add(pkg.packageName);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> bp.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">           <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">               <span class="keyword">case</span> PermissionInfo.PROTECTION_NORMAL: &#123;</span><br><span class="line">                   <span class="comment">// For all apps normal permissions are install time ones.</span></span><br><span class="line">                   grant = GRANT_INSTALL;</span><br><span class="line">               &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1)&#123;</span><br><span class="line">                       <span class="comment">// For legacy apps dangerous permissions are install time ones.</span></span><br><span class="line">                       grant = GRANT_INSTALL_LEGACY;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPermissions.hasInstallPermission(bp.name)) &#123;</span><br><span class="line">                       <span class="comment">// For legacy apps that became modern, install becomes runtime.</span></span><br><span class="line">                       grant = GRANT_UPGRADE;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                           &amp;&amp; isSystemApp(ps)</span><br><span class="line">                           &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">                       <span class="comment">// For legacy system apps, install becomes runtime.</span></span><br><span class="line">                       <span class="comment">// We cannot check hasInstallPermission() for system apps since those</span></span><br><span class="line">                       <span class="comment">// permissions were granted implicitly and not persisted pre-M.</span></span><br><span class="line">                       grant = GRANT_UPGRADE;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// For modern apps keep runtime permissions unchanged.</span></span><br><span class="line">                       grant = GRANT_RUNTIME;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> PermissionInfo.PROTECTION_SIGNATURE: &#123;</span><br><span class="line">                   <span class="comment">// For all apps signature permissions are install time ones.</span></span><br><span class="line">                   allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);</span><br><span class="line">                   <span class="keyword">if</span> (allowedSig) &#123;</span><br><span class="line">                       grant = GRANT_INSTALL;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">               Log.i(TAG, <span class="string">&quot;Package &quot;</span> + pkg.packageName + <span class="string">&quot; granting &quot;</span> + perm);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (grant != GRANT_DENIED) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!isSystemApp(ps) &amp;&amp; ps.installPermissionsFixed) &#123;</span><br><span class="line">                   <span class="comment">// If this is an existing, non-system package, then</span></span><br><span class="line">                   <span class="comment">// we can&#x27;t add any new permissions to it.</span></span><br><span class="line">                   <span class="keyword">if</span> (!allowedSig &amp;&amp; !origPermissions.hasInstallPermission(perm)) &#123;</span><br><span class="line">                       <span class="comment">// Except...  if this is a permission that was added</span></span><br><span class="line">                       <span class="comment">// to the platform (note: need to only do this when</span></span><br><span class="line">                       <span class="comment">// updating the platform).</span></span><br><span class="line">                       <span class="keyword">if</span> (!isNewPlatformPermissionForPackage(perm, pkg)) &#123;</span><br><span class="line">                           grant = GRANT_DENIED;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">switch</span> (grant) &#123;</span><br><span class="line">                   <span class="keyword">case</span> GRANT_INSTALL: &#123;</span><br><span class="line">                       <span class="comment">// Revoke this as runtime permission to handle the case of</span></span><br><span class="line">                       <span class="comment">// a runtime permission being downgraded to an install one.</span></span><br><span class="line">                       <span class="keyword">for</span> (<span class="type">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (origPermissions.getRuntimePermissionState(</span><br><span class="line">                                   bp.name, userId) != <span class="literal">null</span>) &#123;</span><br><span class="line">                               <span class="comment">// Revoke the runtime permission and clear the flags.</span></span><br><span class="line">                               origPermissions.revokeRuntimePermission(bp, userId);</span><br><span class="line">                               origPermissions.updatePermissionFlags(bp, userId,</span><br><span class="line">                                     PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                               <span class="comment">// If we revoked a permission permission, we have to write.</span></span><br><span class="line">                               changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                       changedRuntimePermissionUserIds, userId);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">// Grant an install permission.</span></span><br><span class="line">                       <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                               PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                           changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">case</span> GRANT_INSTALL_LEGACY: &#123;</span><br><span class="line">                       <span class="comment">// Grant an install permission.</span></span><br><span class="line">                       <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                               PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                           changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">case</span> GRANT_RUNTIME: &#123;</span><br><span class="line">                       <span class="comment">// Grant previously granted runtime permissions.</span></span><br><span class="line">                       <span class="keyword">for</span> (<span class="type">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                           <span class="type">PermissionState</span> <span class="variable">permissionState</span> <span class="operator">=</span> origPermissions</span><br><span class="line">                                   .getRuntimePermissionState(bp.name, userId);</span><br><span class="line">                           <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> permissionState != <span class="literal">null</span></span><br><span class="line">                                   ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">                           <span class="keyword">if</span> (origPermissions.hasRuntimePermission(bp.name, userId)) &#123;</span><br><span class="line">                               <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) ==</span><br><span class="line">                                       PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                   <span class="comment">// If we cannot put the permission as it was, we have to write.</span></span><br><span class="line">                                   changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                           changedRuntimePermissionUserIds, userId);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                           <span class="comment">// Propagate the permission flags.</span></span><br><span class="line">                           permissionsState.updatePermissionFlags(bp, userId, flags, flags);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">case</span> GRANT_UPGRADE: &#123;</span><br><span class="line">                       <span class="comment">// Grant runtime permissions for a previously held install permission.</span></span><br><span class="line">                       <span class="type">PermissionState</span> <span class="variable">permissionState</span> <span class="operator">=</span> origPermissions</span><br><span class="line">                               .getInstallPermissionState(bp.name);</span><br><span class="line">                       <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> permissionState != <span class="literal">null</span> ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (origPermissions.revokeInstallPermission(bp)</span><br><span class="line">                               != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                           <span class="comment">// We will be transferring the permission flags, so clear them.</span></span><br><span class="line">                           origPermissions.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                                   PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                           changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="comment">// If the permission is not to be promoted to runtime we ignore it and</span></span><br><span class="line">                       <span class="comment">// also its other flags as they are not applicable to install permissions.</span></span><br><span class="line">                       <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="keyword">for</span> (<span class="type">int</span> userId : currentUserIds) &#123;</span><br><span class="line">                               <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) !=</span><br><span class="line">                                       PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                   <span class="comment">// Transfer the permission flags.</span></span><br><span class="line">                                   permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                           flags, flags);</span><br><span class="line">                                   <span class="comment">// If we granted the permission, we have to write.</span></span><br><span class="line">                                   changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                           changedRuntimePermissionUserIds, userId);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">default</span>: &#123;</span><br><span class="line">                       <span class="keyword">if</span> (packageOfInterest == <span class="literal">null</span></span><br><span class="line">                               || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                           Slog.w(TAG, <span class="string">&quot;Not granting permission &quot;</span> + perm</span><br><span class="line">                                   + <span class="string">&quot; to package &quot;</span> + pkg.packageName</span><br><span class="line">                                   + <span class="string">&quot; because it was previously installed without&quot;</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                       PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                   <span class="comment">// Also drop the permission flags.</span></span><br><span class="line">                   permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                           PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                   changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">                   Slog.i(TAG, <span class="string">&quot;Un-granting permission &quot;</span> + perm</span><br><span class="line">                           + <span class="string">&quot; from package &quot;</span> + pkg.packageName</span><br><span class="line">                           + <span class="string">&quot; (protectionLevel=&quot;</span> + bp.protectionLevel</span><br><span class="line">                           + <span class="string">&quot; flags=0x&quot;</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                           + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// Don&#x27;t print warning for app op permissions, since it is fine for them</span></span><br><span class="line">                   <span class="comment">// not to be granted, there is a UI for the user to decide.</span></span><br><span class="line">                   <span class="keyword">if</span> (packageOfInterest == <span class="literal">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                       Slog.w(TAG, <span class="string">&quot;Not granting permission &quot;</span> + perm</span><br><span class="line">                               + <span class="string">&quot; to package &quot;</span> + pkg.packageName</span><br><span class="line">                               + <span class="string">&quot; (protectionLevel=&quot;</span> + bp.protectionLevel</span><br><span class="line">                               + <span class="string">&quot; flags=0x&quot;</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                               + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="comment">//预置apk列表</span></span><br><span class="line">        String[] appList = &#123; <span class="string">&quot;com.dk.startbootfirst&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(Arrays.asList(appList).contains(pkg.packageName)) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">&quot;-------preset App&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">permsSize</span> <span class="operator">=</span> pkg.requestedPermissions.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;permsSize; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pkg.requestedPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> mSettings.mPermissions.get(name);</span><br><span class="line">                <span class="comment">//可以增加过滤权限列表，判断如果在权限列表里就授予</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != bp &amp;&amp; permissionsState.grantInstallPermission(bp) != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">&quot;---perm&amp;package grant permission &quot;</span> + name</span><br><span class="line">                            + <span class="string">&quot; to package &quot;</span> + pkg.packageName);</span><br><span class="line">                    changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((changedInstallPermission || replace) &amp;&amp; !ps.installPermissionsFixed &amp;&amp;</span><br><span class="line">                !isSystemApp(ps) || isUpdatedSystemApp(ps))&#123;</span><br><span class="line">            <span class="comment">// This is the first that we have heard about this package, so the</span></span><br><span class="line">            <span class="comment">// permissions we have now selected are fixed until explicitly</span></span><br><span class="line">            <span class="comment">// changed.</span></span><br><span class="line">            ps.installPermissionsFixed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Persist the runtime permissions state for users with changes. If permissions</span></span><br><span class="line">        <span class="comment">// were revoked because no app in the shared user declares them we have to</span></span><br><span class="line">        <span class="comment">// write synchronously to avoid losing runtime permissions state.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> userId : changedRuntimePermissionUserIds) &#123;</span><br><span class="line">            mSettings.writeRuntimePermissionsForUserLPr(userId, runtimePermissionsRevoked);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure><p>方法2<br>修改<code>frameworks/base/services/core/java/com/android/server/pm/DefaultPermissionGrantPolicy.java</code><br>举例，修改系统中应用存储空间权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grantDefaultSystemHandlerPermissions</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        grantStoragePermissionsToCustomApp(userId)；<span class="comment">// add </span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grantStoragePermissionsToCustomApp</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String []itemString = mService.mContext.getResources()</span><br><span class="line">        .getStringArray(com.android.internal.R.array.storage_permission_custom_packagename);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; itemString.length; i++) &#123;</span><br><span class="line">        PackageParser.<span class="type">Package</span> <span class="variable">customPackage</span> <span class="operator">=</span> getPackageLPr(itemString[i]);</span><br><span class="line">        <span class="keyword">if</span> ((customPackage != <span class="literal">null</span>) &amp;&amp; doesPackageSupportRuntimePermissions(customPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(customPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过一个xml文件讲我们需要默认打开的应用列表</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span> <span class="attr">xmlns:xliff</span>=<span class="string">&quot;urn:oasis:names:tc:xliff:document:1.2&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">&quot;storage_permission_custom_packagename&quot;</span> <span class="attr">translatable</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.datatransfer<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.defcontainer<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.calendar<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.camera<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.chrome<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.deskclock<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.contacts<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.development<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.email<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.fmradio<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.facebook.katana<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.filemanager<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.gallery3d<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.gm<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.googlequicksearchbox<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.music<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.apps.maps<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.mms<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.cmcm.cmx.pagetwo<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.dialer<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.soundrecorder<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.youtube<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.htmlviewer<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.launcher3<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.lbs.em2.ui<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.wifitest<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.calendarimporter<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.adups.fota<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.sharedstoragebackup<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.wallpapercropper<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.dreams.phototable<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.inputmethod.latin<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.exchange<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.providers.calendar<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.dataprotection<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.mediatek.flp.em<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.google.android.gms<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.whatsapp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.browser<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C/C++预处理指令#define,#ifdef,#ifndef,#endif...</title>
      <link href="/blog/2018/07/27/c-c-yu-chu-li-zhi-ling-define-ifdef-ifndef-endif/"/>
      <url>/blog/2018/07/27/c-c-yu-chu-li-zhi-ling-define-ifdef-ifndef-endif/</url>
      
        <content type="html"><![CDATA[<h3 id="常见的预处理指令如下："><a href="#常见的预处理指令如下：" class="headerlink" title="常见的预处理指令如下："></a>常见的预处理指令如下：</h3><ul><li><code>#</code>空指令，无任何效果</li><li><code>#include</code>包含一个源代码文件</li><li><code>#define</code>定义宏</li><li><code>#undef</code>取消已定义的宏</li><li><code>#if</code>如果给定条件为真，则编译下面代码</li><li><code>#ifdef</code>如果宏已经定义，则编译下面代码</li><li><code>#ifndef</code>如果宏没有定义，则编译下面代码</li><li><code>#elif</code>如果前面的#if给定条件不为真，当前条件为真，则编译下面代码</li><li><code>#endif</code>结束一个#if……#else条件编译块</li><li><code>#error</code>停止编译并显示错误信息</li></ul><h3 id="什么是预处理指令"><a href="#什么是预处理指令" class="headerlink" title="什么是预处理指令?"></a>什么是预处理指令?</h3><p>预处理指令是以#号开头的代码行。#号必须是该行除了任何空白字符外的第一个字符。#后是指令关键字，在关键字和#号之间允许存在任意个数的空白字符。整行语句构成了一条预处理指令，该指令将在编译器进行编译之前对源代码做某些转换。</p><p>预处理指令是在编译器进行编译之前进行的操作.预处理过程扫描源代码，对其进行初步的转换，产生新的源代码提供给编译器。可见预处理过程先于编译器对源代码进行处理。在很多编程语言中，并没有任何内在的机制来完成如下一些功能：在编译时包含其他源文件、定义宏、根据条件决定编译时是否包含某些代码(防止重复包含某些文件)。要完成这些工作，就需要使用预处理程序。尽管在目前绝大多数编译器都包含了预处理程序，但通常认为它们是独立于编译器的。预处理过程读入源代码，检查包含预处理指令的语句和宏定义，并对源代码进行响应的转换。预处理过程还会删除程序中的注释和多余的空白字符。</p><h4 id="include包含一个源代码文件"><a href="#include包含一个源代码文件" class="headerlink" title="#include包含一个源代码文件"></a><code>#include</code>包含一个源代码文件</h4><p>这个预处理指令，我想是见得最多的一个，简单说一下，第一种方法是用尖括号把头文件括起来。这种格式告诉预处理程序在编译器自带的或外部库的头文件中搜索被包含的头文件。第二种方法是用双引号把头文件括起来。这种格式告诉预处理程序在当前被编译的应用程序的源代码文件中搜索被包含的头文件，如果找不到，再搜索编译器自带的头文件。采用两种不同包含格式的理由在于，编译器是安装在公共子目录下的，而被编译的应用程序是在它们自己的私有子目录下的。一个应用程序既包含编译器提供的公共头文件，也包含自定义的私有头文件。采用两种不同的包含格式使得编译器能够在很多头文件中区别出一组公共的头文件。</p><h4 id="define定义宏"><a href="#define定义宏" class="headerlink" title="#define定义宏"></a><code>#define</code>定义宏</h4><p>有关#define这个宏定义，在C语言中使用的很多，因为#define存在一些不足，C++强调使用const来定义常量。宏定义了一个代表特定内容的标识符。预处理过程会把源代码中出现的宏标识符替换成宏定义时的值。记住仅仅是进行标识符的替换。下面列举一些#define的使用：</p><ol><li>用#define实现求最大值和最小值的宏<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x,y) (((x)&gt;(y))?(x):(y))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN(x,y) (((x)&lt;(y))?(x):(y))</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MAX    <span class="comment">//判断这个宏是否被定义</span></span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3 and 5 the max is:%d\n&quot;</span>,<span class="built_in">MAX</span>(<span class="number">3</span>,<span class="number">5</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MIN</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3 and 5 the min is:%d\n&quot;</span>,<span class="built_in">MIN</span>(<span class="number">3</span>,<span class="number">5</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (1)三元运算符要比if,else效率高</span></span><br><span class="line"><span class="comment"> * （2）宏的使用一定要细心，需要把参数小心的用括号括起来，</span></span><br><span class="line"><span class="comment"> * 因为宏只是简单的文本替换，不注意，容易引起歧义错误。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li><li>宏定义的错误使用<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQR(x) (x*x)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> b=<span class="number">3</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SQR<span class="comment">//只需要宏名就可以了，不需要参数，有参数的话会警告</span></span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>,<span class="built_in">SQR</span>(b<span class="number">+2</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *首先说明，这个宏的定义是错误的。并没有实现程序中的B+2的平方</span></span><br><span class="line"><span class="comment"> * 预处理的时候，替换成如下的结果：b+2*b+2</span></span><br><span class="line"><span class="comment"> * 正确的宏定义应该是：#define SQR(x) ((x)*(x))</span></span><br><span class="line"><span class="comment"> * 所以，尽量使用小括号，将参数括起来。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li><li>宏参数的连接<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR(s) #s</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONS(a,b) (int)(a##e##b)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> STR</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="built_in">STR</span>(VCK));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONS</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n%d\n&quot;</span>,<span class="built_in">CONS</span>(<span class="number">2</span>,<span class="number">3</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* （绝大多数是使用不到这些的，使用到的话，查看手册就可以了）</span></span><br><span class="line"><span class="comment"> * 第一个宏，用#把参数转化为一个字符串</span></span><br><span class="line"><span class="comment"> * 第二个宏，用##把2个宏参数粘合在一起，及aeb,2e3也就是2000</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li><li>用宏得到一个字的高位或低位的字节<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WORD_LO(xxx) ((byte)((word)(xxx) &amp; 255))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WORD_HI(xxx) ((byte)((word)(xxx) &gt;&gt; 8))</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 一个字2个字节，获得低字节（低8位），与255（0000,0000,1111,1111）按位相与</span></span><br><span class="line"><span class="comment"> * 获得高字节（高8位），右移8位即可。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li><li>用宏定义得到一个数组所含元素的个数<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARR_SIZE(a) (sizeof((a))/sizeof((a[0])))</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> array[<span class="number">100</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ARR_SIZE</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;array has %d items.\n&quot;</span>,<span class="built_in">ARR_SIZE</span>(array));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *总的大小除以每个类型的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>关于#define宏的使用，应该特别小心，尤其是含有参数计算的时候如小2示例，最保险的做法将参数用括号括起来</li></ol><h4 id="ifdef-ifndef-endif-的使用"><a href="#ifdef-ifndef-endif-的使用" class="headerlink" title="#ifdef,#ifndef,#endif...的使用"></a><code>#ifdef,#ifndef,#endif...</code>的使用</h4><p>以上这些预编译指令，都是条件编译指令，也就是说，将决定那些代码被编译，而哪些不被编译。</p><ol><li>完整示例<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        c = <span class="built_in">getchar</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;\n&#x27;</span> != c)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">getchar</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;q&#x27;</span> == c || <span class="string">&#x27;Q&#x27;</span> == c)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG<span class="comment">//判断DEBUG是否被定义了</span></span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;We get:%c,about to exit.\n&quot;</span>,c);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;i = %d&quot;</span>,i);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;,we get:%c&quot;</span>,c);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*#endif用于终止#if预处理指令。*/</span></span><br></pre></td></tr></table></figure></li><li><code>#ifdef</code>和<code>#ifndef</code><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG</span></span><br><span class="line"><span class="built_in">main</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;yes &quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUG</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;no &quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//#ifdefined等价于#ifdef;</span></span><br><span class="line"><span class="comment">//#if!defined等价于#ifndef</span></span><br></pre></td></tr></table></figure></li><li><code>#else</code>指令<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;           ||  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// #define DEBUG            ||  #define DEBUG</span></span><br><span class="line"><span class="built_in">main</span>()                      ||  <span class="built_in">main</span>()</span><br><span class="line">&#123;                           ||  &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG                ||  #<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶D̶e̶b̶u̶g̶g̶i̶n̶g̶&quot;</span>̶)̶:̶    ||      <span class="built_in">printf</span>(<span class="string">&quot;Debugging&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span>                       ||  #<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Not debugging&quot;</span>);||    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶N̶o̶t̶ ̶d̶e̶b̶u̶g̶g̶i̶n̶g̶&quot;</span>̶)̶;̶ ̶</span><br><span class="line">̶<span class="meta">#<span class="keyword">endif</span>                      ||  #<span class="keyword">endif</span></span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Running&quot;</span>);      ||    <span class="built_in">printf</span>(<span class="string">&quot;Running&quot;</span>);</span><br><span class="line">&#125;                           ||  &#125;</span><br></pre></td></tr></table></figure>当没有定义DEBUG的时候，相当于if(DEBUG &#x3D;&#x3D; false),所以不会执行到画横线处<code>p̶r̶i̶n̶t̶f̶(̶&quot;̶D̶e̶b̶u̶g̶g̶i̶n̶g̶&quot;̶)̶:̶ </code><br>当定义宏以后,相当于if(DEBUG &#x3D;&#x3D; true),所以不会执行到画横线处<code>p̶r̶i̶n̶t̶f̶(̶&quot;̶N̶o̶t̶ ̶d̶e̶b̶u̶g̶g̶i̶n̶g̶&quot;̶)̶;̶ ̶</code></li><li><code>#elif</code>指令<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      ||  #<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE 1           ||  #<span class="keyword">define</span> ONE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TWO 2           ||  <span class="comment">// #define TWO 2</span></span></span><br><span class="line"><span class="built_in">main</span>()                  ||  <span class="built_in">main</span>()</span><br><span class="line">&#123;                       ||  &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ONE              ||  #<span class="keyword">ifdef</span> ONE</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);        ||      <span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> TWO               ||  #<span class="keyword">elif</span> TWO</span></span><br><span class="line">    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶2̶&quot;</span>̶)̶;̶ ̶       ||      p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶2̶&quot;</span>̶)̶;̶ ̶ </span><br><span class="line">̶#̶e̶l̶s̶e̶                   ||  ̶#̶e̶l̶s̶e̶</span><br><span class="line">    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶3̶&quot;</span>̶)̶;̶ ̶       ||      p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶3̶&quot;</span>̶)̶;̶ ̶ </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>                  ||  #<span class="keyword">endif</span></span></span><br><span class="line">&#125;                       ||  &#125;</span><br></pre></td></tr></table></figure>这种宏的条件判断相当于if…else  if…else 只能有一个被执行<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      ||  #<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// #define ONE 1        ||  // #define ONE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TWO 2           ||  <span class="comment">// #define TWO 2</span></span></span><br><span class="line"><span class="built_in">main</span>()                  ||  <span class="built_in">main</span>()</span><br><span class="line">&#123;                       ||  &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ONE              ||  #<span class="keyword">ifdef</span> ONE</span></span><br><span class="line">    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶1̶&quot;</span>̶)̶;̶ ̶       ||      ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶1̶&quot;</span>̶)̶;̶</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> TWO               ||  ̶#̶e̶l̶i̶f̶ ̶T̶W̶O̶</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);        ||      ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶2̶&quot;</span>̶)̶;̶</span><br><span class="line"><span class="meta">#<span class="keyword">else</span>                   ||  #<span class="keyword">else</span></span></span><br><span class="line">    ̶p̶r̶i̶n̶t̶f̶(̶<span class="string">&quot;̶3̶&quot;</span>̶)̶;̶        ||      <span class="built_in">printf</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>                  ||  #<span class="keyword">endif</span></span></span><br><span class="line">&#125;                       ||  &#125;</span><br></pre></td></tr></table></figure></li><li>其他指令<br><code>#error</code>指令将使编译器显示一条错误信息，然后停止编译。<br><code>#line</code>指令可以改变编译器用来指出警告和错误信息的文件号和行号。<br><code>#pragma</code>指令没有正式的定义。编译器可以自定义其用途。典型的用法是禁止或允许某些烦人的警告信息<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OS_Win</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OS_Mac</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mac.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OS_Linux</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/** 不仅使用在头文件的包含. 而且,对于不同的系统平台. 你也可以使用不同的代码结构. */</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"><span class="comment">/** 如果JOE宏没有定义,那么编译就此结束, 编译器就会显示红色的错误 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> JOE</span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span> <span class="string">&quot;JOE is not exits&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jni </tag>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开启高精度定位</title>
      <link href="/blog/2018/07/26/kai-qi-gao-jing-du-ding-wei/"/>
      <url>/blog/2018/07/26/kai-qi-gao-jing-du-ding-wei/</url>
      
        <content type="html"><![CDATA[<p>三种定位模式</p><ol><li><p>Hight Accuracy</p></li><li><p>Battery Saving</p></li><li><p>GPS Only </p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LOCATION_MODE_OFF = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LOCATION_MODE_SENSORS_ONLY = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LOCATION_MODE_BATTERY_SAVING = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LOCATION_MODE_HIGH_ACCURACY = <span class="number">3</span></span><br></pre></td></tr></table></figure><p>设置界面的定位设置相关代码路径：</p></li><li><p><code>/packages/apps/Settings/src/com/android/settings/location/LocationSettings.java</code></p></li><li><p><code>/packages/apps/Settings/src/com/android/settings/location/LocationSettingsBase.java</code></p></li></ol><p>设置：</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Settings.Secure.<span class="keyword">get</span><span class="built_in">Int</span>(activityUnderTest.getContentResolver(), Settings.Secure.LOCATION_MODE);</span><br></pre></td></tr></table></figure><p>初始化值：<br><code>frameworks\base\packages\SettingsProvider\src\com\android\providers\settings\DatabaseHelper.java</code>里面有loadSecureSetting()方法在这里添加</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>定制vibrator震动强度</title>
      <link href="/blog/2018/07/25/ding-zhi-vibrator-zhen-dong-qiang-du/"/>
      <url>/blog/2018/07/25/ding-zhi-vibrator-zhen-dong-qiang-du/</url>
      
        <content type="html"><![CDATA[<p>HapticFeedback震动反馈提到过<code>/frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java</code><br><strong>performHapticFeedbackLw()<strong>函数默认的震动值由 如</strong>mVirtualKeyVibePattern &#x3D; getLongIntArray(mContext.getResources(),<br>com.android.internal.R.array.config_virtualKeyVibePattern)</strong><br>振动时间的配置文件在<br><code>frameworks/base/core/res/res/values/config.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 长按振动 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Vibrator pattern for feedback about a long screen/key press --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_longPressVibePattern&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span>    //暂停时间  单位为 ms</span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>1<span class="tag">&lt;/<span class="name">item</span>&gt;</span>    //震动时间  单位为 ms</span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span>    //暂停时间  单位为 ms</span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>21<span class="tag">&lt;/<span class="name">item</span>&gt;</span>    //震动时间  单位为 ms</span><br><span class="line">  <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- 虚拟按键振动 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Vibrator pattern for feedback about touching a virtual key --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_virtualKeyVibePattern&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>10<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>30<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- 软键盘按键振动 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Vibrator pattern for a very short but reliable vibration for soft keyboard tap --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_keyboardTapVibePattern&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>40<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- 非安全模式启动振动 --&gt;</span>  //正常开机震动</span><br><span class="line">  <span class="comment">&lt;!-- Vibrator pattern for feedback about booting with safe mode disabled --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_safeModeDisabledVibePattern&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>1<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>21<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- 安全模式启动振动 --&gt;</span>  //安全模式开机振动</span><br><span class="line">  <span class="comment">&lt;!-- Vibrator pattern for feedback about booting with safe mode disabled --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_safeModeEnabledVibePattern&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>1<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>21<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>500<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">item</span>&gt;</span>600<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中上面提到的500与600两个值无需修改，本身就是0的也无需修改。<br>微震对应的数值是16-17（这个非常舒适，强烈推荐）<br>不震对应的数值就是0。<br>就拿按键震动举个例子吧：将上面一段修改为以下微震</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_virtualKeyVibePattern&quot;</span>&gt;</span>  //按键的震动（就是那三个小点的震动）</span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>1<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>16<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>17<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br></pre></td></tr></table></figure><p>要修改的改好后，回编译就ok了</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android OTA升级流程分析</title>
      <link href="/blog/2018/07/24/android-ota-sheng-ji-liu-cheng-fen-xi/"/>
      <url>/blog/2018/07/24/android-ota-sheng-ji-liu-cheng-fen-xi/</url>
      
        <content type="html"><![CDATA[<p>Android系统Recovery使用update.zip升级过程分析,update.zip包来源有两种，一个是OTA在线下载（一般下载到&#x2F;CACHE分区），一个是手动拷贝到T卡<br>这里分析从update.zip拷贝到T卡后，弹出升级对话框分析：</p><h2 id="重启至recovery"><a href="#重启至recovery" class="headerlink" title="重启至recovery"></a>重启至recovery</h2><p>mNowButton按钮的监听事件里，会调用mService.rebootAndUpdate（new File(mFile)）。这个mService就是SystemUpdateService的实例<br>这个mFile就是update.zip的路径。</p><h3 id="1-调用RecoverySystem类提供的verifyPackage方法进行签名验证"><a href="#1-调用RecoverySystem类提供的verifyPackage方法进行签名验证" class="headerlink" title="1.调用RecoverySystem类提供的verifyPackage方法进行签名验证"></a>1.调用RecoverySystem类提供的verifyPackage方法进行签名验证</h3><p>签名验证函数，实现过程就不贴出来了，<br>参数，</p><ul><li>packageFile–升级文件</li><li>listener–进度监督器</li><li>deviceCertsZipFile–签名文件，如果为空，则使用系统默认的签名<br>只有当签名验证正确才返回，否则将抛出异常。<br>在Recovery模式下进行升级时候也是会进行签名验证的，如果这里先不进行验证也不会有什么问题。但是我们建议在重启前，先验证，以便及早发现问题。<br>如果签名验证没有问题，就执行installPackage开始升级。<br>在 recovery 模式升级的时候。我们recovery模式会再一次验证update.zip签名。具体代码在install.cpp 中函数 really_install_package<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> verifyPackage(<span class="keyword">File</span> packageFile,</span><br><span class="line">                                 ProgressListener listener,</span><br><span class="line">                                 <span class="keyword">File</span> deviceCertsZipFile)</span><br><span class="line">    <span class="keyword">throws</span> IOException, GeneralSecurityException</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-签名验证没有问题，就进行重启升级"><a href="#2-签名验证没有问题，就进行重启升级" class="headerlink" title="2.签名验证没有问题，就进行重启升级"></a>2.签名验证没有问题，就进行重启升级</h3><p>installPackage(Context context,FilepackageFile)函数根据我们传过来的包文件，获取这个包文件的绝对路径filename。然后将其拼成arg&#x3D;“–update_package&#x3D;”+filename。它最终会被写入到BCB中。这个就是重启进入Recovery模式后，Recovery服务要进行的操作。它被传递到函数bootCommand(context,arg)</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">installPackage</span><span class="params">(Context context, <span class="built_in">File</span> packageFile)</span></span></span><br><span class="line"><span class="function">    throws IOException </span>&#123;</span><br><span class="line">    <span class="type">String</span> filename = packageFile.<span class="built_in">getCanonicalPath</span>();</span><br><span class="line">    Log.<span class="built_in">w</span>(TAG, <span class="string">&quot;!!! REBOOTING TO INSTALL &quot;</span> + filename + <span class="string">&quot; !!!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> filenameArg = <span class="string">&quot;--update_package=&quot;</span> + filename;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> localeArg = <span class="string">&quot;--locale=&quot;</span> + Locale.<span class="built_in">getDefault</span>().<span class="built_in">toString</span>();</span><br><span class="line">    <span class="built_in">bootCommand</span>(context, filenameArg, localeArg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bootCommand()函数创建&#x2F;cache&#x2F;recovery&#x2F;目录，删除这个目录下的command和log（如果存在）文件在sqlite数据库中的备份。然后将上一步中的arg命令写入到&#x2F;cache&#x2F;recovery&#x2F;command文件中。下一步就是真正重启了。接下来看一下在重启函数reboot中所做的事情</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> bootCommand(Context context, String... args) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    RECOVERY_DIR.mkdirs();  <span class="comment">// In case we need it</span></span><br><span class="line">    COMMAND_FILE.<span class="keyword">delete</span>();  <span class="comment">// In case it&#x27;s not writable</span></span><br><span class="line">    LOG_FILE.<span class="keyword">delete</span>();</span><br><span class="line"> </span><br><span class="line">    FileWriter command = <span class="keyword">new</span> FileWriter(COMMAND_FILE);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String arg : args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(arg)) &#123;</span><br><span class="line">                command.<span class="keyword">write</span>(arg);</span><br><span class="line">                command.<span class="keyword">write</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        command.close();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Having written the command file, go ahead and reboot</span></span><br><span class="line">    PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    pm.reboot(PowerManager.REBOOT_RECOVERY);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Reboot failed (no permissions?)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-系统重启进入Recovery模式"><a href="#4-系统重启进入Recovery模式" class="headerlink" title="4.系统重启进入Recovery模式"></a>4.系统重启进入Recovery模式</h3><p>pm.reboot()重启之前先获得了PowerManager（电源管理）并进一步获得其系统服务。然后调用了pm.reboot(“recovery”)函数。他就是.&#x2F;bionic&#x2F;libc&#x2F;unistd&#x2F;reboot.c中的reboot函数。这个函数实际上是一个系统调用，即__reboot(LINUX_REBOOT_MAGIC1,LINUX_REBOOT_MAGIC2,mode,NULL);mode就是我们传过来的“recovery”<br>进入Recovery模式</p><ul><li>将”boot-recovery”写入BCB的command域</li><li>将”–update_package&#x3D;&#x2F;cache&#x2F;update.zip”或则”–update_package&#x3D;&#x2F;sdcard&#x2F;update.zip”写入&#x2F;cache&#x2F;recovery&#x2F;command文件中<br>系统重启时会判断&#x2F;cache&#x2F;recovery目录下是否有command文件，如果存在就进入recovery模式，否则就正常启动<br>进入到Recovery模式下，将执行recovery.cpp的main函数<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">option</span> OPTIONS[] = &#123;</span><br><span class="line">  &#123; <span class="string">&quot;send_intent&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;s&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;update_package&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;u&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;wipe_data&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;w&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;wipe_cache&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;c&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;show_text&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;t&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;just_exit&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;x&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;locale&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;l&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;stages&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;g&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;shutdown_after&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;reason&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;r&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>在这个While循环，用来读取recovery的command参数，OPTIONS的不同选项定义<br>写入的命令文件内容，将为update_package 赋值<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (update_package) &#123;</span><br><span class="line">    <span class="comment">// For backwards compatibility on the cache partition only, if</span></span><br><span class="line">    <span class="comment">// we&#x27;re given an old &#x27;root&#x27; path &quot;CACHE:foo&quot;, change it to</span></span><br><span class="line">    <span class="comment">// &quot;/cache/foo&quot;.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(update_package, <span class="string">&quot;CACHE:&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">strlen</span>(update_package) + <span class="number">10</span>;</span><br><span class="line">        <span class="type">char</span>* modified_path = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">        <span class="built_in">strlcpy</span>(modified_path, <span class="string">&quot;/cache/&quot;</span>, len);</span><br><span class="line">        <span class="built_in">strlcat</span>(modified_path, update_package<span class="number">+6</span>, len);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;(replacing path \&quot;%s\&quot; with \&quot;%s\&quot;)\n&quot;</span>,</span><br><span class="line">               update_package, modified_path);</span><br><span class="line">        update_package = modified_path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-install-cpp进行升级操作"><a href="#5-install-cpp进行升级操作" class="headerlink" title="5.install.cpp进行升级操作"></a>5.install.cpp进行升级操作</h3><p>具体的升级过程都是在install.cpp中执行的，先看install_package方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">install_package</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">int</span>* wipe_cache, <span class="type">const</span> <span class="type">char</span>* install_file,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">bool</span> needs_mount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* install_log = <span class="built_in">fopen_path</span>(install_file, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (install_log) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(path, install_log);</span><br><span class="line">        <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, install_log);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to open last_install: %s\n&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setup_install_mounts</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to set up expected mounts for install; aborting\n&quot;</span>);</span><br><span class="line">        result = INSTALL_ERROR;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="built_in">really_install_package</span>(path, wipe_cache, needs_mount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (install_log) &#123;</span><br><span class="line">        <span class="built_in">fputc</span>(result == INSTALL_SUCCESS ? <span class="string">&#x27;1&#x27;</span> : <span class="string">&#x27;0&#x27;</span>, install_log);</span><br><span class="line">        <span class="built_in">fputc</span>(<span class="string">&#x27;\n&#x27;</span>, install_log);</span><br><span class="line">        <span class="built_in">fclose</span>(install_log);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">really_install_package</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">int</span>* wipe_cache, <span class="type">bool</span> needs_mount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">SetBackground</span>(RecoveryUI::INSTALLING_UPDATE);</span><br><span class="line">    ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;Finding update package...\n&quot;</span>);</span><br><span class="line">    <span class="comment">// Give verification half the progress bar...</span></span><br><span class="line">    ui-&gt;<span class="built_in">SetProgressType</span>(RecoveryUI::DETERMINATE);</span><br><span class="line">    ui-&gt;<span class="built_in">ShowProgress</span>(VERIFICATION_PROGRESS_FRACTION, VERIFICATION_PROGRESS_TIME);</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;Update location: %s\n&quot;</span>, path);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Map the update package into memory.</span></span><br><span class="line">    ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;Opening update package...\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (path &amp;&amp; needs_mount) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">ensure_path_mounted</span>(path<span class="number">+1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">ensure_path_mounted</span>(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    MemMapping map;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sysMapFile</span>(path, &amp;map) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to map file\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_CORRUPT;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 装入签名文件</span></span><br><span class="line">    <span class="type">int</span> numKeys;</span><br><span class="line">    Certificate* loadedKeys = <span class="built_in">load_keys</span>(PUBLIC_KEYS_FILE, &amp;numKeys);</span><br><span class="line">    <span class="keyword">if</span> (loadedKeys == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Failed to load keys\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_CORRUPT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;%d key(s) loaded from %s\n&quot;</span>, numKeys, PUBLIC_KEYS_FILE);</span><br><span class="line"> </span><br><span class="line">    ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;Verifying update package...\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 验证签名</span></span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    err = <span class="built_in">verify_file</span>(map.addr, map.length, loadedKeys, numKeys);</span><br><span class="line">    <span class="built_in">free</span>(loadedKeys);</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;verify_file returned %d\n&quot;</span>, err);</span><br><span class="line">    <span class="comment">// 签名失败的处理</span></span><br><span class="line">    <span class="keyword">if</span> (err != VERIFY_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;signature verification failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">sysReleaseMap</span>(&amp;map);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_CORRUPT;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Try to open the package.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 打开升级包</span></span><br><span class="line">    ZipArchive zip;</span><br><span class="line">    err = <span class="built_in">mzOpenZipArchive</span>(map.addr, map.length, &amp;zip);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Can&#x27;t open %s\n(%s)\n&quot;</span>, path, err != <span class="number">-1</span> ? <span class="built_in">strerror</span>(err) : <span class="string">&quot;bad&quot;</span>);</span><br><span class="line">        <span class="built_in">sysReleaseMap</span>(&amp;map);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_CORRUPT;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Verify and install the contents of the package.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;Installing update...\n&quot;</span>);</span><br><span class="line">    ui-&gt;<span class="built_in">SetEnableReboot</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 执行升级脚本文件，开始升级</span></span><br><span class="line">    <span class="type">int</span> result = <span class="built_in">try_update_binary</span>(path, &amp;zip, wipe_cache);</span><br><span class="line">    ui-&gt;<span class="built_in">SetEnableReboot</span>(<span class="literal">true</span>);</span><br><span class="line">    ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">sysReleaseMap</span>(&amp;map);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这里创建了log文件，升级过程包括出错的信息都会写到这个文件中，便于后续的分析工作,<br>接下来是really_install_package里依次<br>(1)验证签名，装载签名文件，如果为空 ，终止升级； 调用verify_file进行签名验证，这个方法定义在verifier.cpp文件中，此处不展开，如果验证失败立即终止升级。<br>(2)读取升级包信息,执行mzOpenZipArchive方法，打开升级包并扫描，将包的内容拷贝到变量zip中，该变量将作为参数用来执行升级脚本<br>(3)执行升级脚本文件，开始升级, try_update_binary方法用来处理升级包，执行制作升级包中的脚本文件update_binary，进行系统更新</p><h3 id="6-try-update-binary执行升级脚本"><a href="#6-try-update-binary执行升级脚本" class="headerlink" title="6.try_update_binary执行升级脚本"></a>6.try_update_binary执行升级脚本</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the package contains an update binary, extract it and run it.</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">try_update_binary</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, ZipArchive *zip, <span class="type">int</span>* wipe_cache)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 检查update-binary是否存在</span></span><br><span class="line">    <span class="type">const</span> ZipEntry* binary_entry =</span><br><span class="line">            <span class="built_in">mzFindZipEntry</span>(zip, ASSUMED_UPDATE_BINARY_NAME);</span><br><span class="line">    <span class="keyword">if</span> (binary_entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">mzCloseZipArchive</span>(zip);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_CORRUPT;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* binary = <span class="string">&quot;/tmp/update_binary&quot;</span>;</span><br><span class="line">    <span class="built_in">unlink</span>(binary);</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">creat</span>(binary, <span class="number">0755</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">mzCloseZipArchive</span>(zip);</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Can&#x27;t make %s\n&quot;</span>, binary);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// update-binary拷贝到&quot;/tmp/update_binary&quot;</span></span><br><span class="line">    <span class="type">bool</span> ok = <span class="built_in">mzExtractZipEntryToFile</span>(zip, binary_entry, fd);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">mzCloseZipArchive</span>(zip);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Can&#x27;t copy %s\n&quot;</span>, ASSUMED_UPDATE_BINARY_NAME);</span><br><span class="line">        <span class="keyword">return</span> INSTALL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 创建管道，用于下面的子进程和父进程之间的通信</span></span><br><span class="line">    <span class="type">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">pipe</span>(pipefd);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// When executing the update binary contained in the package, the</span></span><br><span class="line">    <span class="comment">// arguments passed are:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   - the version number for this interface</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   - an fd to which the program can write in order to update the</span></span><br><span class="line">    <span class="comment">//     progress bar.  The program can write single-line commands:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        progress &lt;frac&gt; &lt;secs&gt;</span></span><br><span class="line">    <span class="comment">//            fill up the next &lt;frac&gt; part of of the progress bar</span></span><br><span class="line">    <span class="comment">//            over &lt;secs&gt; seconds.  If &lt;secs&gt; is zero, use</span></span><br><span class="line">    <span class="comment">//            set_progress commands to manually control the</span></span><br><span class="line">    <span class="comment">//            progress of this segment of the bar</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        set_progress &lt;frac&gt;</span></span><br><span class="line">    <span class="comment">//            &lt;frac&gt; should be between 0.0 and 1.0; sets the</span></span><br><span class="line">    <span class="comment">//            progress bar within the segment defined by the most</span></span><br><span class="line">    <span class="comment">//            recent progress command.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        firmware &lt;&quot;hboot&quot;|&quot;radio&quot;&gt; &lt;filename&gt;</span></span><br><span class="line">    <span class="comment">//            arrange to install the contents of &lt;filename&gt; in the</span></span><br><span class="line">    <span class="comment">//            given partition on reboot.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//            (API v2: &lt;filename&gt; may start with &quot;PACKAGE:&quot; to</span></span><br><span class="line">    <span class="comment">//            indicate taking a file from the OTA package.)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//            (API v3: this command no longer exists.)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        ui_print &lt;string&gt;</span></span><br><span class="line">    <span class="comment">//            display &lt;string&gt; on the screen.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   - the name of the package zip file.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>** args = (<span class="type">const</span> <span class="type">char</span>**)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>*) * <span class="number">5</span>);</span><br><span class="line">    args[<span class="number">0</span>] = binary;</span><br><span class="line">    args[<span class="number">1</span>] = <span class="built_in">EXPAND</span>(RECOVERY_API_VERSION);   <span class="comment">// defined in Android.mk</span></span><br><span class="line">    <span class="type">char</span>* temp = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(temp, <span class="string">&quot;%d&quot;</span>, pipefd[<span class="number">1</span>]);</span><br><span class="line">    args[<span class="number">2</span>] = temp;</span><br><span class="line">    args[<span class="number">3</span>] = (<span class="type">char</span>*)path;</span><br><span class="line">    args[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 创建子进程。负责执行binary脚本</span></span><br><span class="line">    <span class="type">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">umask</span>(<span class="number">022</span>);</span><br><span class="line">        <span class="built_in">close</span>(pipefd[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">execv</span>(binary, (<span class="type">char</span>* <span class="type">const</span>*)args);<span class="comment">// 执行binary脚本</span></span><br><span class="line">        <span class="built_in">fprintf</span>(stdout, <span class="string">&quot;E:Can&#x27;t run %s (%s)\n&quot;</span>, binary, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        _exit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(pipefd[<span class="number">1</span>]);</span><br><span class="line"> </span><br><span class="line">    *wipe_cache = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 父进程负责接受子进程发送的命令去更新ui显示</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    FILE* from_child = <span class="built_in">fdopen</span>(pipefd[<span class="number">0</span>], <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(buffer, <span class="built_in">sizeof</span>(buffer), from_child) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span>* command = <span class="built_in">strtok</span>(buffer, <span class="string">&quot; \n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;progress&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>* fraction_s = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; \n&quot;</span>);</span><br><span class="line">            <span class="type">char</span>* seconds_s = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; \n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="type">float</span> fraction = <span class="built_in">strtof</span>(fraction_s, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="type">int</span> seconds = <span class="built_in">strtol</span>(seconds_s, <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line"> </span><br><span class="line">            ui-&gt;<span class="built_in">ShowProgress</span>(fraction * (<span class="number">1</span>-VERIFICATION_PROGRESS_FRACTION), seconds);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;set_progress&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>* fraction_s = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; \n&quot;</span>);</span><br><span class="line">            <span class="type">float</span> fraction = <span class="built_in">strtof</span>(fraction_s, <span class="literal">NULL</span>);</span><br><span class="line">            ui-&gt;<span class="built_in">SetProgress</span>(fraction);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;ui_print&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>* str = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (str) &#123;</span><br><span class="line">                ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ui-&gt;<span class="built_in">Print</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fflush</span>(stdout);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;wipe_cache&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            *wipe_cache = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;clear_display&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            ui-&gt;<span class="built_in">SetBackground</span>(RecoveryUI::NONE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;enable_reboot&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// packages can explicitly request that they want the user</span></span><br><span class="line">            <span class="comment">// to be able to reboot during installation (useful for</span></span><br><span class="line">            <span class="comment">// debugging packages that don&#x27;t exit).</span></span><br><span class="line">            ui-&gt;<span class="built_in">SetEnableReboot</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;unknown command [%s]\n&quot;</span>, command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(from_child);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="built_in">waitpid</span>(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WIFEXITED</span>(status) || <span class="built_in">WEXITSTATUS</span>(status) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Error in %s\n(Status %d)\n&quot;</span>, path, <span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">        <span class="keyword">return</span> INSTALL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> INSTALL_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>try_update_binary函数，是真正实现读取升级包中的脚本文件并执行相应的函数的地方。在此函数中，通过调用fork函数创建出一个子进程，在子进程中开始读取并执行升级脚本文件。在此需要注意的是函数fork的用法，fork被调用一次，将做两次返回，在父进程中返回的是子进程的进程ID，为正数；而在子进程中，则返回0。子进程创建成功后，开始执行升级代码，并通过管道与父进程交互，父进程则通过读取子进程传递过来的信息更新UI。</p><h3 id="7-finish-recovery，重启"><a href="#7-finish-recovery，重启" class="headerlink" title="7.finish_recovery，重启"></a>7.finish_recovery，重启</h3><p>上一步完成之后，回到main函数，保存升级过程中的log，清除临时文件，包括command文件（不清除的话，下次重启还会进入recovery模式），最后重启。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save logs and clean up before rebooting or shutting down.</span></span><br><span class="line"> <span class="built_in">finish_recovery</span>(send_intent);</span><br></pre></td></tr></table></figure><h2 id="附1-cache文件"><a href="#附1-cache文件" class="headerlink" title="附1:cache文件"></a>附1:cache文件</h2><table><thead><tr><th>文件</th><th>输入\输出</th><th>功能</th></tr></thead><tbody><tr><td><code>/cache/recovery/command</code></td><td>INPUT</td><td>MainSystem传递给Recovery的命令行</td></tr><tr><td><code>/cache/recovery/log</code></td><td>OUTPUT</td><td>Recovery过程的log</td></tr><tr><td><code>/cache/recovery/intent</code></td><td>OUTPUT</td><td>Recovery给MainSystem反馈的信息，比如告诉MainSystem是否升级成功</td></tr><tr><td><code>/cache/recovery/last_install</code></td><td>OUTPUT</td><td>上一次的安装包，和TEMPORARY_INSTALL_FILE相关</td></tr><tr><td><code>/cache/recovery/last_log</code></td><td>OUTPUT</td><td>保存了recovery的log，一般分析recovery问题时会用到</td></tr><tr><td><code>/cache/recovery/last_locale</code></td><td>OUTPUT</td><td>保存了locale信息到cache分区，如果下一次启动recovery的时候没有带-locale参数(例如从bootloader中启动)则会使用这个值</td></tr></tbody></table><h2 id="附2-command命令"><a href="#附2-command命令" class="headerlink" title="附2:command命令"></a>附2:command命令</h2><table><thead><tr><th>命令</th><th>取值</th><th>含义</th></tr></thead><tbody><tr><td>send_intent</td><td>字符串</td><td>Recovery之后将字符串写到这里，然后写入<code>/cache/recovery/intent</code>,也就是升级结果</td></tr><tr><td>update_package</td><td>path路径</td><td>安装OTA升级包的路径</td></tr><tr><td>wipe_data</td><td></td><td>擦除user data以及cache,然后重启</td></tr><tr><td>wipe_cache</td><td></td><td>擦除cache，不擦除user data,然后重启</td></tr><tr><td>set_encrypted_filesystem</td><td><code>on\of</code></td><td>是否加密文件系统</td></tr><tr><td>just_exit</td><td></td><td>退出和重启</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> OTA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android OTA升级包制作</title>
      <link href="/blog/2018/07/23/android-ota-sheng-ji-bao-zhi-zuo/"/>
      <url>/blog/2018/07/23/android-ota-sheng-ji-bao-zhi-zuo/</url>
      
        <content type="html"><![CDATA[<p>OTA（Over-the-AirTechnology）是指手机终端通过无线网络下载远程服务器上的升级包，对系统或应用进行升级的技术。<br>OTA升级包（实质上是Recovery升级的ZIP包，OTA升级是基于Recovery的机制再加上下载ZIP包和ZIP包版本管理等功能实现）</p><h3 id="OTA升级包"><a href="#OTA升级包" class="headerlink" title="OTA升级包"></a>OTA升级包</h3><h4 id="OTA完整包生成方法"><a href="#OTA完整包生成方法" class="headerlink" title="OTA完整包生成方法"></a>OTA完整包生成方法</h4><p>OTA完整包可用于T卡本地升级和OTA在线升级。OTA完整包包含完整的system、recovery、<br>和 boot.img。编译 OTA 完整包必须在 android 系统编译(<code>make –j4</code>和<code>./mkimage.sh ota</code>)完成后<br>进行。编译 OTA 完整包命令如下：<br><code>make otapackage</code><br>在 out&#x2F;target&#x2F;product&#x2F;rk29sdk&#x2F;目录下生成 ota 完整包 rk29sdk‐ota‐eng.root.zip，改名成<br>update.zip 即可拷贝到 T 卡或内置 flash 中进行固件升级。</p><h5 id="OTA完整包结构"><a href="#OTA完整包结构" class="headerlink" title="OTA完整包结构"></a>OTA完整包结构</h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">├── <span class="keyword">boot</span>.img  <span class="comment">//更新boot分区所需要的文件。这个boot.img主要包括kernel+ramdisk，包括应用会用到的一些库等等</span></span><br><span class="line">├── file_contexts</span><br><span class="line">├── <span class="keyword">META</span>-<span class="keyword">INF</span></span><br><span class="line">│   ├── CERT.RSA  <span class="comment">//与签名文件相关联的签名程序块文件，它存储了用于签名JAR文件的公共签名</span></span><br><span class="line">│   ├── CERT.SF  <span class="comment">//这是JAR文件的签名文件，其中前缀CERT代表签名者</span></span><br><span class="line">│   ├── com</span><br><span class="line">│   │   ├── android</span><br><span class="line">│   │   │   ├── metadata  <span class="comment">//描述设备信息及环境变量的元数据。主要包括一些编译选项，签名公钥，时间戳以及设备型号等</span></span><br><span class="line">│   │   │   └── otacert</span><br><span class="line">│   │   └── google</span><br><span class="line">│   │       └── android</span><br><span class="line">│   │           ├── <span class="keyword">update</span>-binary  <span class="comment">//升级程序，解析执行升级脚本 一个二进制文件,能够识别updater-script中描述的操作。</span></span><br><span class="line">│   │           └── updater-script  <span class="comment">//升级脚本,具体描述了更新过程</span></span><br><span class="line">│   └── MANIFEST.MF  <span class="comment">//这个manifest文件定义了与包的组成结构相关的数据。类似Android应用的mainfest.xml文件</span></span><br><span class="line">├── recovery  <span class="comment">//升级相关的文件</span></span><br><span class="line">│   ├── bin</span><br><span class="line">│   │   └── install-recovery.<span class="keyword">sh</span>  <span class="comment">//执行更新的脚本</span></span><br><span class="line">│   └── recovery-from-<span class="keyword">boot</span>.p  <span class="comment">//recovery-from-boot.p是boot.img和recovery.img的补丁(patch),主要用来更新recovery分区</span></span><br><span class="line">└── system  <span class="comment">//更新system分区所需要的文件。这个system主要用来更新系统的一些应用或则应用会用到的一些库等等</span></span><br><span class="line">    ├── <span class="keyword">app</span></span><br><span class="line">    ├── bin</span><br><span class="line">    ├── build.<span class="keyword">prop</span></span><br><span class="line">    ├── etc</span><br><span class="line">    ├── fonts</span><br><span class="line">    ├── framework</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── manifest.xml</span><br><span class="line">    ├── media</span><br><span class="line">    ├── priv-<span class="keyword">app</span></span><br><span class="line">    ├── recovery-from-<span class="keyword">boot</span>.p</span><br><span class="line">    ├── tts</span><br><span class="line">    ├── usr</span><br><span class="line">    ├── vendor</span><br><span class="line">    └── xbin</span><br></pre></td></tr></table></figure><h4 id="OTA差异包生成方法"><a href="#OTA差异包生成方法" class="headerlink" title="OTA差异包生成方法"></a>OTA差异包生成方法</h4><p>OTA 差异包只有差异内容，包大小比较小，主要用于 OTA 在线升级，也可 T 卡本地升级。<br>OTA 差异包制作需要特殊的编译进行手动制作，以 rk29sdk 删除 VideoPlayer.apk 为例，具体<br>说明 ota 差异包的制作。<br>1.删除 VideoPlayer.apk 之前的版本先生成用于差异包的 target file:</p><pre><code>make otapackage<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>.将生成的<span class="keyword">target</span> <span class="keyword">file</span> 改名成 old,用于后面生成差异包使用</span><br></pre></td></tr></table></figure>mvout/target/product/rk29sdk/obj/PACKAGING/target_files_intermediates/rk29sdk‐target_files‐eng.root.zipout/target/product/rk29sdk/obj/PACKAGING/target_files_intermediates/rk29sdk‐target_files‐eng‐old.root.zip <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>.删除device<span class="regexp">/rockchip/</span>rk29sdk<span class="regexp">/apk/</span>VideoPlayer.apk</span><br><span class="line">和 out<span class="regexp">/target/</span>product<span class="regexp">/rk29sdk/</span>system<span class="regexp">/app/</span>VideoPlayer.apk 后重新生成新的 target <span class="keyword">file</span>:</span><br></pre></td></tr></table></figure>rm device/rockchip/rk29sdk/apk/VideoPlayer.apkrm out/target/product/rk29sdk/system/app/VideoPlayer.apkmake otapackage<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">4.生成差异包:</span></span><br></pre></td></tr></table></figure>./build/tools/releasetools/ota_from_target_files‐v –iout/target/product/rk29sdk/obj/PACKAGING/target_files_intermediates/rk29sdk‐target_files‐eng‐old.root.zip‐p out/host/linux‐x86‐k build/target/product/security/testkeyout/target/product/rk29sdk/obj/PACKAGING/target_files_intermediates/rk29sdk‐target_files‐eng.root.zipout/target/product/rk29sdk/rk29sdk‐ota‐eng.root.zip<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">##### OTA差异包结构</span><br></pre></td></tr></table></figure>├── METE-INF├── patch│   ├── app│   │   └── build.prop.p│   ├── boot.img.p│   ├── etc│   ├── lib│   └── system├── recovery└── system```说明: 生成差异包命令格式:- ota_from_target_files   - –v –i 用于比较的前一个 target file   - –p host 主机编译环境- ‐k 打包密钥用于比较的后一个 target file最后生成的 ota 差异包   如果要增加修改后的 apk 或库可类似以上操作即可&gt;OTA 差异包是将本次编译生成的 target 包和上一个版本的 target 进行对比产生差异。如果要使用差异包，每次编译生成固件时都要 make otapackage 生成 target 包并对应版本保存，以便下次能够相对于某一版本生成差异包。### OTA升级包本地升级验证#### 验证Recovery升级将上述ZIP包复制到内部存储的任一可写目录下，假设我们的ZIP包复制到/cache目录下，文件名为ota.zip，那么接下来我们只需要再执行`echo &quot;--update_package=/cache/ota.zip&quot; &gt; /cache/recovery/command`命令，然后再执行`reboot recovery`命令即可重启进入Recovery模式进行升级验证。#### T卡本地升级1.OTA 包改名成 update.zip将 rk29sdk‐ota‐eng.root.zip 重命名为update.zip。2.拷贝 OTA 包到设备将改名后的 update.zip 拷贝到 rk29 设备的 T 卡或内置 flash 中。3.自动检测本地 OTA 包，提示升级拔插 usb 或拔插 T 卡，此时会弹出自动检测到本地 OTA 包的对话框</code></pre>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> OTA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>On Lollipop USBDevice object does not return the correct number of USBInterface</title>
      <link href="/blog/2018/07/22/on-lollipop-usbdevice-object-does-not-return-the-correct-number-of-usbinterface/"/>
      <url>/blog/2018/07/22/on-lollipop-usbdevice-object-does-not-return-the-correct-number-of-usbinterface/</url>
      
        <content type="html"><![CDATA[<p><a href="https://issuetracker.google.com/issues/37032033">https://issuetracker.google.com/issues/37032033</a></p><p>此处修改</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">diff --git a<span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>hardware<span class="regexp">/usb/U</span>sbDevice.java b<span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>hardware<span class="regexp">/usb/U</span>sbDevice.java</span><br><span class="line"></span><br><span class="line">header <span class="number">1</span> | header <span class="number">2</span></span><br><span class="line">---|---</span><br><span class="line">row <span class="number">1</span> col <span class="number">1</span> | row <span class="number">1</span> col <span class="number">2</span></span><br><span class="line">row <span class="number">2</span> col <span class="number">1</span> | row <span class="number">2</span> col <span class="number">2</span></span><br><span class="line"></span><br><span class="line">index d90e06e..c693af1 <span class="number">100644</span></span><br><span class="line">--- a<span class="regexp">/core/</span>java<span class="regexp">/android/</span>hardware<span class="regexp">/usb/U</span>sbDevice.java</span><br><span class="line">+++ b<span class="regexp">/core/</span>java<span class="regexp">/android/</span>hardware<span class="regexp">/usb/U</span>sbDevice.java</span><br><span class="line">@@ -<span class="number">283</span>,<span class="number">7</span> +<span class="number">283</span>,<span class="number">7</span> @@ <span class="keyword">public</span> <span class="keyword">class</span> UsbDevice <span class="keyword">implements</span> Parcelable &#123;</span><br><span class="line">             String manufacturerName = in.readString();</span><br><span class="line">             String productName = in.readString();</span><br><span class="line">             String serialNumber = in.readString();</span><br><span class="line">-            Parcelable[] <span class="keyword">configurations</span> = in.readParcelableArray(UsbInterface.<span class="keyword">class</span>.getClassLoader());</span><br><span class="line">+            Parcelable[] <span class="keyword">configurations</span> = in.readParcelableArray(UsbConfiguration.<span class="keyword">class</span>.getClassLoader());</span><br><span class="line">             UsbDevice device = <span class="keyword">new</span> UsbDevice(name, vendorId, productId, clasz, subClass, protocol,</span><br><span class="line">                                  manufacturerName, productName, serialNumber);</span><br><span class="line">             device.setConfigurations(<span class="keyword">configurations</span>);</span><br></pre></td></tr></table></figure><p>此处修改</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Interestingly, I downloaded the USBHostManager.java <span class="keyword">file</span> <span class="keyword">from</span> Android <span class="number">6.0</span> and it is identical the <span class="number">5.1</span>.<span class="number">1</span> version I was working with except the changes shown below.</span><br><span class="line"></span><br><span class="line">In Summary (add the two lines below that have <span class="string">&quot;+&quot;</span>) to endUsbDeviceAdded():</span><br><span class="line"><span class="regexp">/frameworks/</span>base<span class="regexp">/services/u</span>sb<span class="regexp">/java/</span>com<span class="regexp">/android/</span>server<span class="regexp">/usb/U</span>sbHostManager.java</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Called from JNI in monitorUsbHostBus() to finish adding a new device */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> endUsbDeviceAdded() &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">&quot;usb:UsbHostManager.endUsbDeviceAdded()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mNewInterface != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mNewInterface.setEndpoints(</span><br><span class="line">                    mNewEndpoints.toArray(<span class="keyword">new</span> UsbEndpoint[mNewEndpoints.<span class="keyword">size</span>()]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mNewConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mNewConfiguration.setInterfaces(</span><br><span class="line">                    mNewInterfaces.toArray(<span class="keyword">new</span> UsbInterface[mNewInterfaces.<span class="keyword">size</span>()]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNewDevice != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mNewDevice.setConfigurations(</span><br><span class="line">                        mNewConfigurations.toArray(<span class="keyword">new</span> UsbConfiguration[mNewConfigurations.<span class="keyword">size</span>()]));</span><br><span class="line">                mDevices.put(mNewDevice.getDeviceName(), mNewDevice);</span><br><span class="line">                Slog.d(TAG, <span class="string">&quot;Added device &quot;</span> + mNewDevice);</span><br><span class="line">                getCurrentSettings().deviceAttached(mNewDevice);</span><br><span class="line">                mUsbAudioManager.deviceAdded(mNewDevice);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;mNewDevice is null in endUsbDeviceAdded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mNewDevice = <span class="keyword">null</span>;</span><br><span class="line">            mNewConfigurations = <span class="keyword">null</span>;</span><br><span class="line">            mNewInterfaces = <span class="keyword">null</span>;</span><br><span class="line">            mNewEndpoints = <span class="keyword">null</span>;</span><br><span class="line">+           mNewConfiguration = <span class="keyword">null</span>;</span><br><span class="line">+           mNewInterface = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><html><!--issue-->https://issuetracker.google.com/issues/37032363</html>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>默认系统输入法为搜狗输入法</title>
      <link href="/blog/2018/07/21/mo-ren-xi-tong-shu-ru-fa-wei-sou-gou-shu-ru-fa/"/>
      <url>/blog/2018/07/21/mo-ren-xi-tong-shu-ru-fa-wei-sou-gou-shu-ru-fa/</url>
      
        <content type="html"><![CDATA[<h3 id="默认搜狗输入法"><a href="#默认搜狗输入法" class="headerlink" title="默认搜狗输入法"></a>默认搜狗输入法</h3><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><ol><li>frameworks\base\packages\SettingsProvider\res\values\defaults.xml <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">&lt;!--create by chensy 默认搜狗输入法--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;string name=&quot;def_input_method&quot; translatable=&quot;false&quot;&gt;com.android.inputmethod.pinyin/.PinyinIME&lt;/string&gt;  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;def_input_method&quot;</span> <span class="attr">translatable</span>=<span class="string">&quot;false&quot;</span>&gt;</span>com.sohu.inputmethod.sogou/.SogouIME<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--create by chensy 默认搜狗输入法--&gt;</span></span><br></pre></td></tr></table></figure></li><li>frameworks\base\packages\SettingsProvider\src\com\android\providers\settings\DatabaseHelper.java<figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadStringSetting(<span class="type">stmt</span>, <span class="type">Settings</span>.<span class="type">Secure</span>.<span class="type">DEFAULT_INPUT_METHOD</span>,R.<span class="type">string</span>.def_input_method);</span><br></pre></td></tr></table></figure></li><li>系统要安装搜狗输入法，或预置到系统中</li></ol><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><ol><li>在 frameworks\base\core\res\res\values\config.xml　添加一个属性: <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">string</span> name=<span class="string">&quot;config_default_input_method&quot;</span> translatable=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line"> <span class="keyword">com</span>.sohu.inputmethod.sogou/.SogouIME&lt;/<span class="built_in">string</span>&gt; </span><br></pre></td></tr></table></figure> frameworks\base\services\java\com\android\server\InputMethodManagerService.java  的方法 buildInputMethodListLocked() 里添加:      <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">defaultIme</span> <span class="operator">=</span> Settings.Secure.getString(mContext </span><br><span class="line">            .getContentResolver(), Settings.Secure.DEFAULT_INPUT_METHOD); </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( defaultIme == <span class="literal">null</span> ) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">final</span> <span class="type">Resources</span> <span class="variable">res</span> <span class="operator">=</span> mContext.getResources(); </span><br><span class="line">        <span class="keyword">try</span> </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">//frameworks\base\core\res\res\values\config.xml </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">myIME</span> <span class="operator">=</span> res.getString( com.android.internal.R.string.config_default_input_method ); </span><br><span class="line">            <span class="keyword">if</span> ( myIME != <span class="literal">null</span> &amp;&amp; myIME.length() &gt; <span class="number">0</span> ) </span><br><span class="line">            &#123; </span><br><span class="line">                Settings.Secure.putString( mContext.getContentResolver(), </span><br><span class="line">                        Settings.Secure.DEFAULT_INPUT_METHOD, </span><br><span class="line">                        myIME ); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) </span><br><span class="line">        &#123; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>系统要安装搜狗输入法，或预置到系统中</li></ol><h3 id="将系统中所有输入法设置为可用"><a href="#将系统中所有输入法设置为可用" class="headerlink" title="将系统中所有输入法设置为可用"></a>将系统中所有输入法设置为可用</h3><p>将系统中所有的输入法设置为可用，可修改</p><p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;Android&#x2F;internal&#x2F;inputmethod&#x2F;InputMethodUtils.java</p><blockquote><p>附上常见的输入法包名和类名</p></blockquote><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">百度：com<span class="selector-class">.baidu</span>.input/<span class="selector-class">.ImeService</span></span><br><span class="line">讯飞：com<span class="selector-class">.iflytek</span>.inputmethod/<span class="selector-class">.FlyIME</span></span><br><span class="line">腾讯：com<span class="selector-class">.tencent</span>.qqpinyin/<span class="selector-class">.QQPYInputMethodService</span></span><br><span class="line">谷歌：com<span class="selector-class">.google</span><span class="selector-class">.android</span><span class="selector-class">.inputmethod</span>.pinyin/<span class="selector-class">.PinyinIME</span></span><br><span class="line">搜狗：com<span class="selector-class">.sohu</span><span class="selector-class">.inputmethod</span>.sogou/<span class="selector-class">.SogouIME</span></span><br><span class="line">触宝：com<span class="selector-class">.cootek</span>.smartinput5/.TouchPalIME</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RK3288 make otapackage出错问题</title>
      <link href="/blog/2018/07/20/rk3288-make-otapackage-chu-cuo-wen-ti/"/>
      <url>/blog/2018/07/20/rk3288-make-otapackage-chu-cuo-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>OTA完整包可用于T卡本地升级和OTA在线升级。OTA完整包包含完整的system、recovery.<br>和 boot.img。编译 OTA 完整包必须在 android 系统编译(<code>make –j4</code> 和 <code>./mkimage.sh ota</code>)完成后<br>进行。编译 OTA 完整包命令如下：<br><code>make otapackage</code></p><p>编译日志</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">Installed <span class="keyword">file</span> list: out/target/product/rk3288/installed-<span class="keyword">files</span>.txt</span><br><span class="line">Target <span class="keyword">system</span> fs image: out/target/product/rk3288/obj/PACKAGING/systemimage_intermediates/<span class="keyword">system</span>.img</span><br><span class="line">Running:  mkuserimg.sh -s out/target/product/rk3288/<span class="keyword">system</span> out/target/product/rk3288/obj/PACKAGING/systemimage_intermediates/<span class="keyword">system</span>.img ext4 <span class="keyword">system</span> <span class="number">1073741824</span> out/target/product/rk3288/root/file_contexts</span><br><span class="line">make_ext4fs -s -T <span class="number">-1</span> -S out/target/product/rk3288/root/file_contexts -l <span class="number">1073741824</span> -a <span class="keyword">system</span> out/target/product/rk3288/obj/PACKAGING/systemimage_intermediates/<span class="keyword">system</span>.img out/target/product/rk3288/<span class="keyword">system</span></span><br><span class="line">Creating filesystem with <span class="keyword">parameters</span>:</span><br><span class="line">    Size: 1073741824</span><br><span class="line">    Block <span class="comment">size: 4096</span></span><br><span class="line">    Blocks <span class="comment">per group: 32768</span></span><br><span class="line">    Inodes <span class="comment">per group: 8192</span></span><br><span class="line">    Inode <span class="comment">size: 256</span></span><br><span class="line">    Journal <span class="comment">blocks: 4096</span></span><br><span class="line">    Label: </span><br><span class="line">    Blocks: 262144</span><br><span class="line">    Block <span class="comment">groups: 8</span></span><br><span class="line">    Reserved <span class="comment">block group size: 63</span></span><br><span class="line">Created <span class="comment">filesystem with 1875</span>/<span class="number">65536</span> inodes <span class="keyword">and</span> <span class="number">110947</span>/<span class="comment">262144 blocks</span></span><br><span class="line">Construct <span class="comment">recovery from boot</span></span><br><span class="line">mkdir <span class="comment">-p out</span>/target/<span class="comment">product</span>/rk3288/<span class="comment">obj</span>/PACKAGING/<span class="comment">recovery_patch_intermediates</span>/</span><br><span class="line">PATH=out/<span class="comment">host</span>/linux-x86/<span class="comment">bin:$PATH out</span>/host/<span class="comment">linux-x86</span>/bin/<span class="comment">imgdiff out</span>/target/<span class="comment">product</span>/rk3288/<span class="comment">boot.img out</span>/target/<span class="comment">product</span>/rk3288/<span class="comment">recovery.img out</span>/target/<span class="comment">product</span>/rk3288/<span class="comment">obj</span>/PACKAGING/<span class="comment">recovery_patch_intermediates</span>/recovery_from_boot.p</span><br><span class="line">chunk <span class="number">0</span>: type <span class="number">0</span> start <span class="number">0</span> len <span class="number">7012362</span></span><br><span class="line">chunk <span class="number">1</span>: type <span class="number">2</span> start <span class="number">7012362</span> len <span class="number">2239232</span></span><br><span class="line">chunk <span class="number">2</span>: type <span class="number">0</span> start <span class="number">8354422</span> len <span class="number">296330</span></span><br><span class="line">Construct patches <span class="keyword">for</span> <span class="number">3</span> chunks...</span><br><span class="line">patch   <span class="number">0</span> is <span class="number">248</span> bytes (of <span class="number">7012362</span>)</span><br><span class="line">patch   <span class="number">1</span> is <span class="number">1378159</span> bytes (of <span class="number">1342060</span>)</span><br><span class="line">patch   <span class="number">2</span> is <span class="number">202</span> bytes (of <span class="number">296330</span>)</span><br><span class="line">chunk   <span class="number">0</span>: <span class="built_in">normal</span>   (         <span class="number">0</span>,    <span class="number">7012362</span>)         <span class="number">248</span></span><br><span class="line">chunk   <span class="number">1</span>: deflate  (   <span class="number">7012362</span>,    <span class="number">2917660</span>)     <span class="number">1378159</span>  (null)</span><br><span class="line">chunk   <span class="number">2</span>: <span class="built_in">normal</span>   (   <span class="number">9930022</span>,     <span class="number">309978</span>)         <span class="number">202</span></span><br><span class="line">Install <span class="keyword">system</span> fs image: out/<span class="comment">target</span>/product/<span class="comment">rk3288</span>/<span class="keyword">system</span>.img</span><br><span class="line">out/<span class="comment">target</span>/product/<span class="comment">rk3288</span>/<span class="keyword">system</span>.img+out/<span class="comment">target</span>/product/<span class="comment">rk3288</span>/obj/<span class="comment">PACKAGING</span>/recovery_patch_intermediates/<span class="comment">recovery_from_boot.p maxsize=1096212480 blocksize=135168 total=440127133 reserve=11083776</span></span><br><span class="line">No <span class="comment">RK Loader for TARGET_DEVICE rk3288 to otapackage</span></span><br><span class="line">package <span class="comment">add resource.img to BOOT and RECOVERY</span></span><br><span class="line">No <span class="comment">uboot for uboot</span>/uboot.img to otapackage</span><br><span class="line"><span class="keyword">No</span> trust <span class="keyword">for</span> uboot/<span class="comment">trust.img to otapackage</span></span><br><span class="line">No <span class="comment">charge for uboot</span>/charge.img to otapackage</span><br><span class="line"><span class="keyword">No</span> parameter <span class="keyword">for</span> TARGET_DEVICE rk3288 to otapackage</span><br><span class="line">Package target <span class="keyword">files</span>: out/<span class="comment">target</span>/product/<span class="comment">rk3288</span>/obj/<span class="comment">PACKAGING</span>/target_files_intermediates/<span class="comment">rk3288-target_files-eng.root.zip</span></span><br><span class="line">building <span class="comment">image from target_files RECOVERY...</span></span><br><span class="line">Traceback <span class="comment">(most recent call last):</span></span><br><span class="line">  File <span class="comment">&quot;./build/tools/releasetools/make_recovery_patch&quot;</span><span class="comment">, line 68, in &lt;module&gt;</span></span><br><span class="line">    main(sys.argv[1:])</span><br><span class="line">  File <span class="comment">&quot;./build/tools/releasetools/make_recovery_patch&quot;</span><span class="comment">, line 39, in main</span></span><br><span class="line">    input_dir, <span class="string">&quot;RECOVERY&quot;</span>)</span><br><span class="line">  File <span class="comment">&quot;/media/liw/173d54d9-5bc8-4998-a41d-77fa4e377b61/rk3288_box_sdk_5.1/build/tools/releasetools/common.py&quot;</span><span class="comment">, line 419, in GetBootableImage</span></span><br><span class="line">    info_dict)</span><br><span class="line">  File <span class="comment">&quot;/media/liw/173d54d9-5bc8-4998-a41d-77fa4e377b61/rk3288_box_sdk_5.1/build/tools/releasetools/common.py&quot;</span><span class="comment">, line 376, in BuildBootableImage</span></span><br><span class="line">    p4 <span class="comment">= Run(sign_cmd)</span></span><br><span class="line">  File <span class="comment">&quot;/media/liw/173d54d9-5bc8-4998-a41d-77fa4e377b61/rk3288_box_sdk_5.1/build/tools/releasetools/common.py&quot;</span><span class="comment">, line 86, in Run</span></span><br><span class="line">    return <span class="comment">subprocess.Popen(args, **kwargs)</span></span><br><span class="line">  File <span class="comment">&quot;/usr/lib/python2.7/subprocess.py&quot;</span><span class="comment">, line 710, in __init__</span></span><br><span class="line">    errread, errwrite)</span><br><span class="line">  File <span class="comment">&quot;/usr/lib/python2.7/subprocess.py&quot;</span><span class="comment">, line 1327, in _execute_child</span></span><br><span class="line">    raise <span class="comment">child_exception</span></span><br><span class="line">OSError: [Errno <span class="comment">2] No such file or directory</span></span><br><span class="line">make: *** [out/target/product/rk3288/obj/PACKAGING/target_files_intermediates/rk3288-target_files-eng.root.zip] 错误 <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### make failed to build some targets (<span class="number">03</span>:<span class="number">16</span> (mm:ss)) ####</span><br></pre></td></tr></table></figure><p>解决方案<br>build&#x2F;tools&#x2F;releasetools&#x2F;common.py修改一下<br>贴上patch</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@@ -348,6 +348,17 @@</span></span><br><span class="line">   if os.access(fn, os.F_OK):</span><br><span class="line">     cmd.append(&quot;--pagesize&quot;)</span><br><span class="line">     cmd.append(open(fn).read().rstrip(&quot;\n&quot;))</span><br><span class="line"><span class="addition">+  </span></span><br><span class="line"><span class="addition">+  fn = os.path.join(sourcedir, &quot;second&quot;)</span></span><br><span class="line"><span class="addition">+  if os.access(fn, os.F_OK):</span></span><br><span class="line"><span class="addition">+    cmd.append(&quot;--second&quot;)</span></span><br><span class="line"><span class="addition">+    cmd.append(fn)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  fn = os.path.join(sourcedir, &quot;third&quot;)</span></span><br><span class="line"><span class="addition">+  if os.access(fn, os.F_OK):</span></span><br><span class="line"><span class="addition">+    cmd.append(&quot;--third&quot;)</span></span><br><span class="line"><span class="addition">+    cmd.append(fn)</span></span><br><span class="line"> </span><br><span class="line">   args = info_dict.get(&quot;mkbootimg_args&quot;, None)</span><br><span class="line">   if args and args.strip():</span><br><span class="line"><span class="meta">@@ -362,10 +373,10 @@</span></span><br><span class="line">       os.path.basename(sourcedir),)</span><br><span class="line"> </span><br><span class="line">   sign_cmd = [&quot;drmsigntool&quot;, img.name, &quot;build/target/product/security/privateKey.bin&quot;]</span><br><span class="line"><span class="deletion">-  p4 = Run(sign_cmd)</span></span><br><span class="line"><span class="deletion">-  p4.communicate()</span></span><br><span class="line"><span class="deletion">-  assert p4.returncode == 0, &quot;mkbootimg of %s image failed&quot; % (</span></span><br><span class="line"><span class="deletion">-          os.path.basename(sourcedir),)</span></span><br><span class="line"><span class="addition">+ # p4 = Run(sign_cmd)</span></span><br><span class="line"><span class="addition">+ # p4.communicate()</span></span><br><span class="line"><span class="addition">+#  assert p4.returncode == 0, &quot;mkbootimg of %s image failed&quot; % (</span></span><br><span class="line"><span class="addition">+#          os.path.basename(sourcedir),)</span></span><br><span class="line"> </span><br><span class="line">   #if info_dict.get(&quot;verity_key&quot;, None):</span><br><span class="line">   #  path = &quot;/&quot; + os.path.basename(sourcedir).lower()</span><br><span class="line"><span class="meta">@@ -877,8 +888,8 @@</span></span><br><span class="line">             f = b</span><br><span class="line">           info = imp.find_module(f, [d])</span><br><span class="line">         print &quot;loaded device-specific extensions from&quot;, path</span><br><span class="line"><span class="deletion">-        self.module = imp.load_module(&quot;device_specific&quot;, *info)</span></span><br><span class="line"><span class="deletion">-        D(&quot;module = %s&quot;, self.module);</span></span><br><span class="line"><span class="addition">+       # self.module = imp.load_module(&quot;device_specific&quot;, *info)</span></span><br><span class="line"><span class="addition">+       # D(&quot;module = %s&quot;, self.module);</span></span><br><span class="line">       except ImportError:</span><br><span class="line">         print &quot;unable to load device-specific module; assuming none&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql ERROR 1067:Invalid default value for &#39;id&#39;</title>
      <link href="/blog/2018/07/19/mysql-error-1067-invalid-default-value-for-id/"/>
      <url>/blog/2018/07/19/mysql-error-1067-invalid-default-value-for-id/</url>
      
        <content type="html"><![CDATA[<p>数据里面有张表的一个日期字段默认值为0000-00-00，导致现在的错误。根本原因是  SQL_MODE  设置值的问题<br>首先用下面的命令看下sql_mode</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show <span class="keyword">variables</span> like <span class="comment">&#x27;sql_mode&#x27;</span>;</span><br></pre></td></tr></table></figure><p>结果中含有NO_ZERO_IN_DATE, NO_ZERO_DATE,去掉 sql_mode 中的 values: NO_ZERO_IN_DATE,NO_ZERO_DATE 即可<br>执行下面的命令</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> session <span class="attribute">sql_mode</span>=<span class="string">&#x27;ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>SQL_MODE</th><th>解释说明</th></tr></thead><tbody><tr><td>ONLY_FULL_GROUP_BY</td><td>对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将认为这个SQL是不合法的，因为列不在GROUP BY从句中</td></tr><tr><td>STRICT_TRANS_TABLES</td><td>在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做任何限制</td></tr><tr><td>NO_ZERO_IN_DATE</td><td>在严格模式，不接受月或日部分为0的日期。如果使用IGNORE选项，我们为类似的日期插入’0000-00-00’。在非严格模式，可以接受该日期，但会生成警告</td></tr><tr><td>NO_ZERO_DATE</td><td>在严格模式，不要将 ‘0000-00-00’做为合法日期。你仍然可以用IGNORE选项插入零日期。在非严格模式，可以接受该日期，但会生成警告</td></tr><tr><td>ERROR_FOR_DIVISION_BY_ZERO</td><td>在严格模式，在INSERT或UPDATE过程中，如果被零除(或MOD(X，0))，则产生错误(否则为警告)。如果未给出该模式，被零除时MySQL返回NULL。如果用到INSERT IGNORE或UPDATE IGNORE中，MySQL生成被零除警告，但操作结果为NULL</td></tr><tr><td>NO_AUTO_CREATE_USER</td><td>防止GRANT自动创建新用户，除非还指定了密码</td></tr><tr><td>NO_ENGINE_SUBSTITUTION</td><td>如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java开发接口</title>
      <link href="/blog/2018/07/18/java-kai-fa-jie-kou/"/>
      <url>/blog/2018/07/18/java-kai-fa-jie-kou/</url>
      
        <content type="html"><![CDATA[<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><ul><li>JDK： v 10</li><li>Tomcat ：v 9.0.6</li><li>IntelliJ IDEA ：v 2017.3</li><li>MySQL：v 5.7.19</li></ul><h3 id="学习计划"><a href="#学习计划" class="headerlink" title="学习计划"></a>学习计划</h3><p>１. 环境搭建<br>２. HelloWorld<br>３. 创建数据库<br>４. Servlet写接口<br>５. Spring MVC写接口<br>６. Spring+SpringMVC+MyBatis<br>７. 云服务器部署</p><h4 id="１-环境搭建"><a href="#１-环境搭建" class="headerlink" title="１.环境搭建"></a>１.环境搭建</h4><p>要求:<br>１. 运行Tomcat成功后那只猫<br>２.IntelliJ IDEA 运行起来后的欢迎页<br>３．连接MySql后的截图，连接MySql命令行: <code>mysql -u root -p</code><br>退出MySQL命令行:<code>exit</code>　</p><h4 id="２-HelloWorld"><a href="#２-HelloWorld" class="headerlink" title="２.HelloWorld"></a>２.HelloWorld</h4><p>要求:<br>使用InterlliJ IDEA创建Maven项目，运行起来是<code>Hello World</code><br>注意事项:<br>注意下，比如选择Enable Auto import(是为了在pom.xml文件中添加依赖之后自动引入jar)</p><h4 id="3-创建数据库"><a href="#3-创建数据库" class="headerlink" title="3.创建数据库"></a>3.创建数据库</h4><p>《Java 开发接口》是单表操作，按照这个教程创建数据库、表、填充数据，应该没什么问题</p><p>要求:1、拍照上传《Java 开发接口》教程里的 developer 表，并插入 5 条数据； 2、拓展作业 2.1、分页 查询 developer 表，需要查出第 2 - 4 条内容。 2.2、外键 查询 comment 表，要求查出第一条数据且查出 user 表里的昵称</p><h4 id="4-Servlet-写接口"><a href="#4-Servlet-写接口" class="headerlink" title="4.Servlet 写接口"></a>4.Servlet 写接口</h4><p>前面都是准备工作，接下来进入编码阶段，<br>《Java 开发接口》关于 Servlet，有两节，分别是「创建 Servlet」、「Servlet 写接口」，<br>我实践下来，并不是很难，可能代码量有些多，我也提供了相应的 sample，建议自己跟着手敲一遍，加深印象。 </p><p>注意事项: 之前代码并没有做异常处理，最好 try catch 一下，这里偷懒了一下</p><p>要求:用 Postman 测试，分别拍照 获取数据、添加数据、修改数据</p><h4 id="5-Spring-MVC-写接口"><a href="#5-Spring-MVC-写接口" class="headerlink" title="5.Spring MVC 写接口"></a>5.Spring MVC 写接口</h4><p>Spring MVC 写接口分别对应《Java 开发接口》教程里「创建 Spring MVC」、「Spring MVC 写接口」，<br>难点在于配置，完成了「创建 Spring MVC」，后面会很快搞定。 </p><p>注意事项: 同样教程里代码并没有做异常处理，最好 try catch 一下。</p><p>要求: 用 Postman 测试，分别拍照 数据的增删改查</p><h4 id="6-SSM"><a href="#6-SSM" class="headerlink" title="6.SSM"></a>6.SSM</h4><p>SSM 是《Java 开发接口》的重头戏，很多公司项目都是用的 SSM 的框架，可见它的重要性，<br>SSM 配置相当复杂，我一开始也是一头雾水，仔细对照教程，一步步走下去，摸索摸索，会成功的。 </p><p>注意事项: 同样教程里代码并没有做异常处理，最好 try catch 一下。</p><p>要求: 用 Postman 测试，也是分别拍照 数据的增删改查</p><h4 id="7-云服务器部署"><a href="#7-云服务器部署" class="headerlink" title="7.云服务器部署"></a>7.云服务器部署</h4><p><a href="/asset/Java%E5%BC%80%E5%8F%91%E6%8E%A5%E5%8F%A3.pdf">Java开发接口</a> 下载链接: <a href="https://pan.baidu.com/s/18RJ6N0UQdwAK0P1o87f81g">https://pan.baidu.com/s/18RJ6N0UQdwAK0P1o87f81g</a> 密码: <a href="https://pan.baidu.com/s/18RJ6N0UQdwAK0P1o87f81g">ahyc</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设置-显示-字体大小的修改</title>
      <link href="/blog/2018/07/17/she-zhi-xian-shi-zi-ti-da-xiao-de-xiu-gai/"/>
      <url>/blog/2018/07/17/she-zhi-xian-shi-zi-ti-da-xiao-de-xiu-gai/</url>
      
        <content type="html"><![CDATA[<p>Android系统中在Settings-&gt;Display-&gt;Font Size设置系统字体大小，默认的系统字体大小为Normal</p><h3 id="修改默认值"><a href="#修改默认值" class="headerlink" title="修改默认值"></a>修改默认值</h3><p>代码路径:&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;content&#x2F;res&#x2F;Configuration.java<br>在public void setToDefaults()方法中进行修改，<br>如果默认要改成特大字体，请改为1.30； </p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void setToDefaults() &#123;   </span><br><span class="line">       fontScale <span class="operator">=</span> <span class="number">1.30</span><span class="comment">; //normal value is 1.0   </span></span><br><span class="line">       mcc <span class="operator">=</span> mnc <span class="operator">=</span> <span class="number">0</span><span class="comment">;   </span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>然后重新build framework.jar这个模块即可<br>注意：Settings中系统的字体大小，在&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;res&#x2F;values&#x2F;arrays.xml文件中的”entryvalues_font_size”这个tag中分别有定义对应的数值</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Small</span>:<span class="number">0</span>.<span class="number">85</span>   </span><br><span class="line"><span class="attribute">Normal</span>:<span class="number">1</span>.<span class="number">0</span>   </span><br><span class="line"><span class="attribute">Large</span>:<span class="number">1</span>.<span class="number">15</span>  </span><br><span class="line"><span class="attribute">Huge</span>:<span class="number">1</span>.<span class="number">30</span></span><br></pre></td></tr></table></figure><h3 id="添加一个选项值"><a href="#添加一个选项值" class="headerlink" title="添加一个选项值"></a>添加一个选项值</h3><p>代码路径:&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;res&#x2F;values&#x2F;arrays.xml</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">string</span>-array name=<span class="string">&quot;entries_font_size&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">item</span> <span class="attr">msgid</span>=<span class="string">&quot;6490061470416867723&quot;</span>&gt;</span>Small<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">item</span> <span class="attr">msgid</span>=<span class="string">&quot;3579015730662088893&quot;</span>&gt;</span>Normal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">item</span> <span class="attr">msgid</span>=<span class="string">&quot;1678068858001018666&quot;</span>&gt;</span>Large<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">item</span> <span class="attr">msgid</span>=<span class="string">&quot;490158884605093126&quot;</span>&gt;</span>Huge<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">item</span> <span class="attr">msgid</span>=<span class="string">&quot;945212277880982567&quot;</span>&gt;</span>Very Huge<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span>   <span class="comment">//添加一个选项值</span></span><br><span class="line">&lt;/<span class="built_in">string</span>-array&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">&quot;entryvalues_font_size&quot;</span> <span class="attr">translatable</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>0.85<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>1.15<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>1.30<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">item</span>&gt;</span>    //添加一个选项值</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>更改默认壁纸</title>
      <link href="/blog/2018/07/16/geng-gai-mo-ren-bi-zhi/"/>
      <url>/blog/2018/07/16/geng-gai-mo-ren-bi-zhi/</url>
      
        <content type="html"><![CDATA[<p>Android 5.0中homescreen的默认壁纸位置：</p><p>frameworks&#x2F;base&#x2F;core&#x2F;res&#x2F;res&#x2F;drawable-nodpi&#x2F;default_wallpaper.jpg；可以在frameworks&#x2F;base&#x2F;core&#x2F;res目录下搜索default_wallpaper.jpg文件，替换掉就可以了。</p><p>在Android 5.0中不能设置lockscreen的背景图片,这是因为在Lockscreen的背景已经设置为透明，并且不能更换。</p><p>Lockscreen 背景的位置：<br>SystemUI(frameworks&#x2F;base&#x2F;package&#x2F;SystemUI)下的super_status_bar.xml和super_status_bar.xml中的</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.statusbar</span><span class="selector-class">.phone</span><span class="selector-class">.PanlHolder</span></span><br><span class="line"></span><br><span class="line">  android:id=<span class="string">&quot;@+id/panel_holder&quot;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  &gt;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">&lt;/com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.statusbar</span><span class="selector-class">.phone</span>.PanlHolder&gt;</span><br></pre></td></tr></table></figure><p>修改panel_holder的背景就可以了</p><blockquote><p>特别强调:<br>        在Android 5.0中lockscreen的背景颜色是透明，跟homescreen一致。因为锁屏界面的icon都是白色的，在更换背景图片时候不要使用白色图片，避免修改之后锁屏界面icon不可见。在解锁后状态栏是黑色，这是因为lockscreen的背景色是透明，这样显示的是黑色，如果更换成其他图片或者颜色，解锁后通知栏会被遮蔽，看不到任何icon.</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Watchdog机制</title>
      <link href="/blog/2018/07/15/watchdog-ji-zhi/"/>
      <url>/blog/2018/07/15/watchdog-ji-zhi/</url>
      
        <content type="html"><![CDATA[<p>Watchdog的中文的“看门狗”，有保护的意思。最早引入Watchdog是在单片机系统中，由于单片机的工作环境容易受到外界磁场的干扰，导致程序“跑飞”，造成整个系统无法正常工作，因此，引入了一个“看门狗”，对单片机的运行状态进行实时监测，针对运行故障做一些保护处理，譬如让系统重启。这种Watchdog属于硬件层面，必须有硬件电路的支持<br>Linux也引入了Watchdog，在Linux内核下，当Watchdog启动后，便设定了一个定时器，如果在超时时间内没有对&#x2F;dev&#x2F;Watchdog进行写操作，则会导致系统重启。通过定时器实现的Watchdog属于软件层面。<br>Android设计了一个软件层面Watchdog，用于保护一些重要的系统服务，当出现故障时，通常会让Android系统重启。由于这种机制的存在，就经常会出现一些system_server进程被Watchdog杀掉而发生手机重启的问题。</p><h3 id="Watchdog初始化"><a href="#Watchdog初始化" class="headerlink" title="Watchdog初始化"></a>Watchdog初始化</h3><p>分析Watchdog的实现逻辑。为了描述方便，ActivityManagerService， PackageManagerService， WindowManagerService会分别简称为AMS, PKMS, WMS<br>代码路径frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;Watchdog.java，<br>Android的Watchdog是一个单例线程，在System Server时就会初始化Watchdog。Watchdog在初始化时，会构建很多HandlerChecker，大致可以分为两类：</p><ul><li>Monitor Checker，用于检查是Monitor对象可能发生的死锁, AMS, PKMS, WMS等核心的系统服务都是Monitor对象。</li><li>Looper Checker，用于检查线程的消息队列是否长时间处于工作状态。Watchdog自身的消息队列，Ui, Io, Display这些全局的消息队列都是被检查的对象。此外，一些重要的线程的消息队列，也会加入到Looper Checker中，譬如AMS, PKMS，这些是在对应的对象初始化时加入的。<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Watchdog</span>()</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">    mMonitorChecker = <span class="keyword">new</span> HandlerChecker(FgThread.getHandler(),</span><br><span class="line">                <span class="string">&quot;foreground thread&quot;</span>, DEFAULT_TIMEOUT);</span><br><span class="line">    mHandlerCheckers.<span class="keyword">add</span>(mMonitorChecker);</span><br><span class="line">    mHandlerCheckers.<span class="keyword">add</span>(<span class="keyword">new</span> HandlerChecker(<span class="keyword">new</span> Handler(Looper.getMainLooper()),</span><br><span class="line">                <span class="string">&quot;main thread&quot;</span>, DEFAULT_TIMEOUT));</span><br><span class="line">    mHandlerCheckers.<span class="keyword">add</span>(<span class="keyword">new</span> HandlerChecker(UiThread.getHandler(),</span><br><span class="line">                <span class="string">&quot;ui thread&quot;</span>, DEFAULT_TIMEOUT));</span><br><span class="line">    mHandlerCheckers.<span class="keyword">add</span>(<span class="keyword">new</span> HandlerChecker(IoThread.getHandler(),</span><br><span class="line">                <span class="string">&quot;i/o thread&quot;</span>, DEFAULT_TIMEOUT));</span><br><span class="line">    mHandlerCheckers.<span class="keyword">add</span>(<span class="keyword">new</span> HandlerChecker(DisplayThread.getHandler(),</span><br><span class="line">                <span class="string">&quot;display thread&quot;</span>, DEFAULT_TIMEOUT));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>两类HandlerChecker的侧重点不同，Monitor Checker预警我们不能长时间持有核心系统服务的对象锁，否则会阻塞很多函数的运行; Looper Checker预警我们不能长时间的霸占消息队列，否则其他消息将得不到处理。这两类都会导致系统卡住(System Not Responding)</li></ul><h3 id="添加WatchDog监测对象"><a href="#添加WatchDog监测对象" class="headerlink" title="添加WatchDog监测对象"></a>添加WatchDog监测对象</h3><p>Watchdog初始化以后，就可以作为system_server进程中的一个单独的线程运行了。但这个时候，还不能触发Watchdog的运行，因为AMS, PKMS等系统服务还没有加入到Watchdog的监测集。 所谓监测集，就是需要Watchdog关注的对象，Android中有成千上万的消息队列在同时运行，然而，Watchdog毕竟是系统层面的东西，它只会关注一些核心的系统服务。<br>Watchdog提供两个方法，分别用于添加Monitor Checker对象和Looper Checker对象:</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">addMonitor</span><span class="params">(Monitor monitor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将monitor对象添加到Monitor Checker中，</span></span><br><span class="line">    <span class="comment">// 在Watchdog初始化时，可以看到Monitor Checker本身也是一个HandlerChecker对象</span></span><br><span class="line">    mMonitors.<span class="built_in">add</span>(monitor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">addThread</span><span class="params">(Handler thread, <span class="type">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isAlive</span>()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&quot;Threads can&#x27;t be added once the Watchdog is running&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> name = thread.<span class="built_in">getLooper</span>().<span class="built_in">getThread</span>().<span class="built_in">getName</span>();</span><br><span class="line">        <span class="comment">// 为Handler构建一个HandlerChecker对象，其实就是**Looper Checker**</span></span><br><span class="line">        mHandlerCheckers.<span class="built_in">add</span>(<span class="keyword">new</span> <span class="built_in">HandlerChecker</span>(thread, name, timeoutMillis));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>被Watchdog监测的对象，都需要将自己添加到Watchdog的监测集中。以下是AMS的类定义和构造器的代码片段：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">ActivityManagerNative</span></span></span><br><span class="line">        implements <span class="type">Watchdog</span>.<span class="type">Monitor</span>, <span class="type">BatteryStatsImpl</span>.<span class="type">BatteryCallback</span> &#123;</span><br><span class="line"></span><br><span class="line">    public <span class="type">ActivityManagerService</span>(<span class="type">Context</span> systemContext) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">Watchdog</span>.getInstance().addMonitor(<span class="keyword">this</span>);</span><br><span class="line">        <span class="type">Watchdog</span>.getInstance().addThread(mHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void monitor() &#123;</span><br><span class="line">        synchronized (<span class="keyword">this</span>) &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AMS实现了Watchdog.Monitor接口，这个接口只有一个方法，就是monitor()，它的作用后文会再解释。这里可以看到在AMS的构造器中，将自己添加到Monitor Checker对象中，然后将自己的handler添加到Looper Checker对象中。 其他重要的系统服务添加到Watchdog的代码逻辑都与AMS差不多。</p><h3 id="Watchdog的监测机制"><a href="#Watchdog的监测机制" class="headerlink" title="Watchdog的监测机制"></a>Watchdog的监测机制</h3><p>Watchdog本身是一个线程，它的run()方法实现如下：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> waitedHalf = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 1. 调度所有的HandlerChecker</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mHandlerCheckers.size(); i++) &#123;</span><br><span class="line">                HandlerChecker hc = mHandlerCheckers.get(i);</span><br><span class="line">                hc.scheduleCheckLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 2. 开始定期检查</span></span><br><span class="line">            <span class="keyword">long</span> start = SystemClock.uptimeMillis();</span><br><span class="line">            <span class="keyword">while</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wait(timeout);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Log.wtf(TAG, e);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                timeout = CHECK_INTERVAL - (SystemClock.uptimeMillis() - start);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 检查HandlerChecker的完成状态</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> waitState = evaluateCheckerCompletionLocked();</span><br><span class="line">            <span class="keyword">if</span> (waitState == COMPLETED) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(waitState == WAITING)</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(waitState == WAITED_HALF)</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 存在超时的HandlerChecker</span></span><br><span class="line">            blockedCheckers = getBlockedCheckersLocked();</span><br><span class="line">            subject = describeCheckersLocked(blockedCheckers);</span><br><span class="line">            allowRestart = mAllowRestart;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 5. 保存日志，判断是否需要杀掉系统进程</span></span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;*** GOODBYE!&quot;</span>);</span><br><span class="line">        Process.killProcess(Process.myPid());</span><br><span class="line">        System.exit(<span class="number">10</span>);</span><br><span class="line">    &#125; <span class="comment">// end of while (true)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Watchdog运行后，便开始无限循环，依次调用每一个HandlerChecker的scheduleCheckLocked()方法<br>调度完HandlerChecker之后，便开始定期检查是否超时，每一次检查的间隔时间由CHECK_INTERVAL常量设定，为30秒<br>每一次检查都会调用evaluateCheckerCompletionLocked()方法来评估一下HandlerChecker的完成状态：</p><ul><li>COMPLETED表示已经完成</li><li>WAITING和WAITED_HALF表示还在等待，但未超时</li><li>OVERDUE表示已经超时。默认情况下，timeout是1分钟，但监测对象可以通过传参自行设定，譬如PKMS的Handler Checker的超时是10分钟<br>如果超时时间到了，还有HandlerChecker处于未完成的状态(OVERDUE)，则通过getBlockedCheckersLocked()方法，获取阻塞的HandlerChecker，生成一些描述信息<br>保存日志，包括一些运行时的堆栈信息，这些日志是我们解决Watchdog问题的重要依据。如果判断需要杀掉system_server进程，则给当前进程(system_server)发送signal 9<br>只要Watchdog没有发现超时的任务，HandlerChecker就会被不停的调度<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerChecker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">scheduleCheckLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Looper Checker中是不包含monitor对象的，判断消息队列是否处于空闲</span></span><br><span class="line">        <span class="keyword">if</span> (mMonitors.size() == <span class="number">0</span> &amp;&amp; mHandler.getLooper().isIdling()) &#123;</span><br><span class="line">            mCompleted = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 将Monitor Checker的对象置于消息队列之前，优先运行</span></span><br><span class="line">        mHandler.postAtFrontOfQueue(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 依次调用Monitor对象的monitor()方法</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; size ; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Watchdog.<span class="keyword">this</span>) &#123;</span><br><span class="line">                mCurrentMonitor = mMonitors.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentMonitor.monitor();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>对于Looper Checker而言，会判断线程的消息队列是否处于空闲状态。 如果被监测的消息队列一直闲不下来，则说明可能已经阻塞等待了很长时间<br>对于Monitor Checker而言，会调用实现类的monitor方法，譬如上文中提到的AMS.monitor()方法， 方法实现一般很简单，就是获取当前类的对象锁，如果当前对象锁已经被持有，则monitor()会一直处于wait状态，直到超时，这种情况下，很可能是线程发生了死锁</li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Watchdog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ANR程序问题分析之dropbox</title>
      <link href="/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/"/>
      <url>/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/</url>
      
        <content type="html"><![CDATA[<p>从2.2开始增加了DropBox功能，增强Android的异常信息收集管理能力DropBox（简称DB）是系统进程中的一个服务，在system_server进程启动时创建，并且它没有运行在单独的线程中，而是运行在system_server的ServerThread线程中。我们可以将ServerThread称作system_server的主线程，ServerThread线程除了启动并维护各个服务外，还负责检测一些重要的服务是否死锁<br>DropBoxManagerService（简称DBMS）就是DB服务的本尊，它的主要功能接口包括以下几个函数：<br>public voidadd(DropBoxManager.Entryentry)</p><p>DBMS将所有要添加的日志都用DropBoxManager.Entry类型的对象表示，通过add函数添加，并且直到目前为止一个Entry对象对应着一个日志文件。</p><p>publicboolean isTagEnabled(String tag)</p><p>通过给每一个Entry设置一个tag可以标识不同类型的日志，并且可以灵活的启用&#x2F;禁用某种类型的日志，isTagEnabled用来判断指定类型的日志是否被启用&#x2F;禁用了，一旦禁用就不会再记录这种类型的日志。默认是不禁用任何类型的日志的。稍后说明如何启用&#x2F;禁用日志。</p><p>publicsynchronized DropBoxManager.Entry getNextEntry(String tag, long millis)</p><p>我们可以通过getNextEntry函数获取指定类型和指定时间点之后的第一条日志，要使用这个功能应用程序需要有“android.permission.READ_LOGS”的权限，并且在使用完毕返回的Entry对象后要调用其close函数确保关闭日志文件的文件描述符（如果不关闭的话可能造成进程打开的文件描述符超过1024而崩溃，Android中限制每个进程的文件描述符上限为1024）。</p><p>DBMS提供了很多的配置项用来限制对磁盘的使用，通过SettingsProvider应用程序维护，数据存放在其settings.db数据库中。这些配置项也都有默认值，罗列如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_AGE_SECONDS</span> = <span class="string">&quot;dropbox_age_seconds&quot;</span></span><br><span class="line"><span class="comment">//日志文件保存的最长时间，默认3天</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_MAX_FILES</span> = <span class="string">&quot;dropbox_max_files&quot;</span></span><br><span class="line"><span class="comment">//日志文件的最大数量，默认值是1000</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_QUOTA_KB</span> = <span class="string">&quot;dropbox_quota_kb&quot;</span></span><br><span class="line"><span class="comment">//磁盘空间最大使用量</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_QUOTA_PERCENT</span> = <span class="string">&quot;dropbox_quota_percent&quot;</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_RESERVE_PERCENT</span> = <span class="string">&quot;dropbox_reserve_percent&quot;</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_TAG_PREFIX</span> = <span class="string">&quot;dropbox:&quot;</span></span><br><span class="line"><span class="comment">//应用程序可以利用DropBox来做事情，收集日志等</span></span><br></pre></td></tr></table></figure><h3 id="DropBox启动"><a href="#DropBox启动" class="headerlink" title="DropBox启动"></a>DropBox启动</h3><p>在SystemServer.java的ServerThread.run()里</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Slog.i(TAG, <span class="string">&quot;DropBox Service&quot;</span>);</span><br><span class="line">ServiceManager.addService(<span class="keyword">Context</span>.DROPBOX_SERVICE, //服务名称为“dropbox”</span><br><span class="line"><span class="keyword">new</span> DropBoxManagerService(<span class="keyword">context</span>, <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;/data/system/dropbox&quot;</span>)));</span><br></pre></td></tr></table></figure><p>DROPBOX_SERVICE &#x3D; “dropbox”, “&#x2F;data&#x2F;system&#x2F;dropbox”是DB指定的文件存放位置，这个过程向ServiceManager 登记名为“dropbox”的服务。那么可通过<code>dumpsys dropbox</code>来查看该dropbox服务信息。</p><h3 id="DropBox初始化"><a href="#DropBox初始化" class="headerlink" title="DropBox初始化"></a>DropBox初始化</h3><p>在DropBoxManagerService.java的构造方法里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DropBoxManagerService</span> <span class="keyword">extends</span> <span class="title class_">IDropBoxManagerService</span>.Stub &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DropBoxManagerService</span><span class="params">(<span class="keyword">final</span> Context context, File path)</span> &#123;</span><br><span class="line">        mDropBoxDir = path;  <span class="comment">// 目录/data/system/dropbox</span></span><br><span class="line">        mContext = context;</span><br><span class="line">        mContentResolver = context.getContentResolver();</span><br><span class="line"></span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        <span class="comment">// 监听存储设备可用空间低的广播</span></span><br><span class="line">        filter.addAction(Intent.ACTION_DEVICE_STORAGE_LOW);</span><br><span class="line">        <span class="comment">// 监听开机完毕的广播</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BOOT_COMPLETED);</span><br><span class="line">        context.registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Settings数据库变化时则回调广播接收者的onReceive方法,此处CONTENT_URI=content://settings/global&quot;</span></span><br><span class="line">        mContentResolver.registerContentObserver(</span><br><span class="line">            Settings.Global.CONTENT_URI, <span class="literal">true</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ContentObserver</span>(<span class="keyword">new</span> <span class="title class_">Handler</span>()) &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> selfChange)</span> &#123;</span><br><span class="line">                    mReceiver.onReceive(context, (Intent) <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// 发送广播</span></span><br><span class="line">                <span class="keyword">if</span> (msg.what == MSG_SEND_BROADCAST) &#123;</span><br><span class="line">                    mContext.sendBroadcastAsUser((Intent)msg.obj, UserHandle.OWNER,</span><br><span class="line">                            android.Manifest.permission.READ_LOGS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法主要功能是给dropbox目录所对应的存储空间进行瘦身:</p><ul><li>存储设备可用空间低；</li><li>开机完毕；</li><li>Settings数据库变化；<br>以上情况都会触发触发执行mReceiver的onReceive方法<br>在DropBoxManagerService.java的mReceiver<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> final BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span>(<span class="params">Context context, Intent intent</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="literal">null</span> &amp;&amp; Intent.ACTION_BOOT_COMPLETED.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            mBooted = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//收到ACTION_DEVICE_STORAGE_LOW，则强制重新check存储空间</span></span><br><span class="line">        mCachedQuotaUptimeMillis = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建工作线程来执行init和trim操作</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">init</span>(); <span class="comment">//初始化</span></span><br><span class="line">                    trimToFit(); <span class="comment">//清除一些空间</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h4 id="init-方法"><a href="#init-方法" class="headerlink" title="init()方法"></a>init()方法</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> init() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatFs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDropBoxDir.isDirectory() &amp;&amp; !mDropBoxDir.mkdirs()) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        mStatFs = <span class="keyword">new</span> StatFs(mDropBoxDir.getPath());</span><br><span class="line">        mBlockSize = mStatFs.getBlockSize(); <span class="comment">//mBlockSize=4096</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAllFiles == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">File</span>[] files = mDropBoxDir.listFiles();</span><br><span class="line">        <span class="comment">// 列举所有的dropbox文件</span></span><br><span class="line">        mAllFiles = <span class="keyword">new</span> FileList();</span><br><span class="line">        mFilesByTag = <span class="keyword">new</span> HashMap&lt;String, FileList&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">File</span> <span class="keyword">file</span> : files) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">file</span>.getName().endsWith(<span class="string">&quot;.tmp&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除后缀为.tmp文件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建dropbox的实体文件对象, 根据文件名来获取相应的时间戳</span></span><br><span class="line">            EntryFile entry = <span class="keyword">new</span> EntryFile(<span class="keyword">file</span>, mBlockSize);</span><br><span class="line">            <span class="keyword">if</span> (entry.tag == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">//忽略tag为空的文件</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.timestampMillis == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除时间戳为0的文件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将entry加入到mAllFiles对象</span></span><br><span class="line">            enrollEntry(entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法主要功能：</p><ul><li>创建目录&#x2F;data&#x2F;system&#x2F;dropbox;</li><li>将每一个dropbox文件都对应于一个EntryFile对象,根据文件名来获取相应的时间戳</li><li>删除后缀为.tmp的文件;</li><li>删除时间戳为0的文件</li></ul><h4 id="trimToFit-方法"><a href="#trimToFit-方法" class="headerlink" title="trimToFit()方法"></a>trimToFit()方法</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> trimToFit() &#123;</span><br><span class="line">    <span class="keyword">int</span> ageSeconds = Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_AGE_SECONDS, DEFAULT_AGE_SECONDS);</span><br><span class="line">    <span class="keyword">int</span> maxFiles = Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_MAX_FILES, DEFAULT_MAX_FILES);</span><br><span class="line">    <span class="keyword">long</span> cutoffMillis = System.currentTimeMillis() - ageSeconds * <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!mAllFiles.contents.isEmpty()) &#123;</span><br><span class="line">        EntryFile entry = mAllFiles.contents.first();</span><br><span class="line">        <span class="comment">//当最老的文件时间戳在3天之内，且文件个数低于1000，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (entry.timestampMillis &gt; cutoffMillis </span><br><span class="line">            &amp;&amp; mAllFiles.contents.<span class="keyword">size</span>() &lt; maxFiles) <span class="keyword">break</span>;</span><br><span class="line">        FileList tag = mFilesByTag.get(entry.tag);</span><br><span class="line">        <span class="keyword">if</span> (tag != <span class="keyword">null</span> &amp;&amp; tag.contents.remove(entry)) tag.blocks -= entry.blocks;</span><br><span class="line">        <span class="keyword">if</span> (mAllFiles.contents.remove(entry)) mAllFiles.blocks -= entry.blocks;</span><br><span class="line">        <span class="keyword">if</span> (entry.<span class="keyword">file</span> != <span class="keyword">null</span>) entry.<span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> uptimeMillis = SystemClock.uptimeMillis();</span><br><span class="line">    <span class="comment">//除非接收设备存储低的广播，否则间隔5s才能再次执行restat</span></span><br><span class="line">    <span class="keyword">if</span> (uptimeMillis &gt; mCachedQuotaUptimeMillis + QUOTA_RESCAN_MILLIS) &#123;</span><br><span class="line">        <span class="keyword">int</span> quotaPercent = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_PERCENT, DEFAULT_QUOTA_PERCENT);</span><br><span class="line">        <span class="keyword">int</span> reservePercent = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_RESERVE_PERCENT, DEFAULT_RESERVE_PERCENT);</span><br><span class="line">        <span class="keyword">int</span> quotaKb = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_KB, DEFAULT_QUOTA_KB);</span><br><span class="line">        <span class="comment">//重新统计文件</span></span><br><span class="line">        mStatFs.restat(mDropBoxDir.getPath());</span><br><span class="line">        <span class="keyword">int</span> available = mStatFs.getAvailableBlocks();</span><br><span class="line">        <span class="keyword">int</span> nonreserved = available - mStatFs.getBlockCount() * reservePercent / <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">int</span> maximum = quotaKb * <span class="number">1024</span> / mBlockSize;</span><br><span class="line">        <span class="comment">//可用的块数量</span></span><br><span class="line">        mCachedQuotaBlocks = Math.min(maximum, Math.max(<span class="number">0</span>, nonreserved * quotaPercent / <span class="number">100</span>));</span><br><span class="line">        mCachedQuotaUptimeMillis = uptimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAllFiles.blocks &gt; mCachedQuotaBlocks) &#123;</span><br><span class="line">        <span class="comment">//公平地限制所有tag的空间</span></span><br><span class="line">        <span class="keyword">int</span> unsqueezed = mAllFiles.blocks, squeezed = <span class="number">0</span>;</span><br><span class="line">        TreeSet&lt;FileList&gt; tags = <span class="keyword">new</span> TreeSet&lt;FileList&gt;(mFilesByTag.values());</span><br><span class="line">        <span class="keyword">for</span> (FileList tag : tags) &#123;</span><br><span class="line">            <span class="keyword">if</span> (squeezed &gt; <span class="number">0</span> &amp;&amp; tag.blocks &lt;= (mCachedQuotaBlocks - unsqueezed) / squeezed) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            unsqueezed -= tag.blocks;</span><br><span class="line">            squeezed++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tagQuota = (mCachedQuotaBlocks - unsqueezed) / squeezed;</span><br><span class="line">        <span class="comment">//移除每个tags中的旧items</span></span><br><span class="line">        <span class="keyword">for</span> (FileList tag : tags) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAllFiles.blocks &lt; mCachedQuotaBlocks) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">while</span> (tag.blocks &gt; tagQuota &amp;&amp; !tag.contents.isEmpty()) &#123;</span><br><span class="line">                EntryFile entry = tag.contents.first();</span><br><span class="line">                <span class="keyword">if</span> (tag.contents.remove(entry)) tag.blocks -= entry.blocks;</span><br><span class="line">                <span class="keyword">if</span> (mAllFiles.contents.remove(entry)) mAllFiles.blocks -= entry.blocks;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entry.<span class="keyword">file</span> != <span class="keyword">null</span>) entry.<span class="keyword">file</span>.<span class="keyword">delete</span>();</span><br><span class="line">                    enrollEntry(<span class="keyword">new</span> EntryFile(mDropBoxDir, entry.tag, entry.timestampMillis));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Can&#x27;t write tombstone file&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mCachedQuotaBlocks * mBlockSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>trimToFit过程中触发条件是：当文件有效时长超过3天，或者最大文件数超过1000，再或者剩余可用存储设备过低；<br>DBMS有很多常量参数：</p><ul><li>DEFAULT_AGE_SECONDS &#x3D; 3 * 86400：文件最长可存活时长为3天</li><li>DEFAULT_MAX_FILES &#x3D; 1000：最大dropbox文件个数为1000</li><li>DEFAULT_QUOTA_KB &#x3D; 5 * 1024：分配dropbox空间的最大值5M</li><li>DEFAULT_QUOTA_PERCENT &#x3D; 10：是指dropbox目录最多可占用空间比例10%</li><li>DEFAULT_RESERVE_PERCENT &#x3D; 10：是指dropbox不可使用的存储空间比例10%</li><li>QUOTA_RESCAN_MILLIS &#x3D; 5000：重新扫描retrim时长为5s<br>当然上面这些都是默认值，完全可以通过设置content:&#x2F;&#x2F;settings&#x2F;global数据库中相应项来设定值。</li></ul><h3 id="DropBox工作"><a href="#DropBox工作" class="headerlink" title="DropBox工作"></a>DropBox工作</h3><p>以下任一场景，都会调用AMS.addErrorToDropBox()来触发DBMS工作。</p><ul><li>crash: AMS.handleApplicationCrashInner()</li><li>anr: AMS.appNotResponding()</li><li>watchdog: Watchdog.run()</li><li>native_crash: NativeCrashReporter.run()</li><li>wtf: 当调用Log.wtf()或者Log.wtfQuiet()</li><li>lowmem: 当内存较低时，触发AMS.reportMemUsage()</li></ul><p>在ActivityManagerService.java的addErrorToDropBox()方法</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> addErrorToDropBox(String eventType, ProcessRecord process, String processName, ActivityRecord activity, ActivityRecord parent, String subject, <span class="keyword">final</span> String report, <span class="keyword">final</span> <span class="keyword">File</span> logFile, <span class="keyword">final</span> ApplicationErrorReport.CrashInfo crashInfo) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建dropbox标签名</span></span><br><span class="line">    <span class="keyword">final</span> String dropboxTag = processClass(process) + <span class="string">&quot;_&quot;</span> + eventType;</span><br><span class="line">    <span class="comment">//获取dropbox服务的代理端</span></span><br><span class="line">    <span class="keyword">final</span> DropBoxManager dbox = (DropBoxManager)</span><br><span class="line">            mContext.getSystemService(Context.DROPBOX_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当不需要输出dropbox报告则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (dbox == <span class="keyword">null</span> || !dbox.isTagEnabled(dropboxTag)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//输出Process,flags,以及进程中所有package</span></span><br><span class="line">    appendDropBoxProcessHeaders(process, processName, sb);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (subject != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sb.<span class="keyword">append</span>(<span class="string">&quot;Subject: &quot;</span>).<span class="keyword">append</span>(subject).<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.<span class="keyword">append</span>(<span class="string">&quot;Build: &quot;</span>).<span class="keyword">append</span>(Build.FINGERPRINT).<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    sb.<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建新线程，避免将调用者阻塞在I/O</span></span><br><span class="line">    Thread worker = <span class="keyword">new</span> Thread(<span class="string">&quot;Error dump: &quot;</span> + dropboxTag) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">            <span class="keyword">if</span> (report != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</span></span><br><span class="line">                sb.<span class="keyword">append</span>(report); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB</span></span><br><span class="line">                sb.<span class="keyword">append</span>(FileUtils.readTextFile(logFile, DROPBOX_MAX_SIZE,</span><br><span class="line">                            <span class="string">&quot;\n\n[[TRUNCATED]]&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (crashInfo != <span class="keyword">null</span> &amp;&amp; crashInfo.stackTrace != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 比如crash时输出的调用栈</span></span><br><span class="line">                sb.<span class="keyword">append</span>(crashInfo.stackTrace);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String setting = Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag;</span><br><span class="line">            <span class="keyword">int</span> lines = Settings.Global.getInt(mContext.getContentResolver(), setting, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//当dropboxTag所对应的settings项不等于0，则输出logcat</span></span><br><span class="line">            <span class="keyword">if</span> (lines &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">//输出evets/system/main/crash这些log信息</span></span><br><span class="line">              java.lang.Process logcat = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;/system/bin/logcat&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-v&quot;</span>, <span class="string">&quot;time&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;events&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;system&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;crash&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-t&quot;</span>, String.valueOf(lines)).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line"></span><br><span class="line">              input = <span class="keyword">new</span> InputStreamReader(logcat.getInputStream());</span><br><span class="line"></span><br><span class="line">              <span class="keyword">int</span> num;</span><br><span class="line">              <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">8192</span>];</span><br><span class="line">              <span class="comment">//不断读取input中的log内容，并添加到sb</span></span><br><span class="line">              <span class="keyword">while</span> ((num = input.<span class="keyword">read</span>(buf)) &gt; <span class="number">0</span>) sb.<span class="keyword">append</span>(buf, <span class="number">0</span>, num);</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将log信息输出到DropBox</span></span><br><span class="line">            dbox.addText(dropboxTag, sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//当进程为空，意味着system_server进程崩溃，系统可能很快就要挂了,</span></span><br><span class="line">        <span class="comment">//那么不再创建新线程，而是直接在system_server进程中同步运行</span></span><br><span class="line">        worker.run();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//启动新线程</span></span><br><span class="line">        worker.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法主要功能是输出以下内容项：</p><ul><li>Process,flags, package等头信息；</li><li>当report不为空，则比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</li><li>当logFile不为空，则比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB；</li><li>当stack不为空，则比如crash时输出的调用栈；</li><li>输出logcat的events&#x2F;system&#x2F;main&#x2F;crash信息。</li></ul><p>AMS.processClass()方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">static</span> <span class="type">String</span> <span class="title">processClass</span><span class="params">(ProcessRecord process)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//MY_PID代表的是当前进程pid，正是system_server进程</span></span><br><span class="line">    <span class="keyword">if</span> (process == null || process.pid == MY_PID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;system_server&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((process.info.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;system_app&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;data_app&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dropbox文件名格式为<a href="mailto:&#x64;&#x72;&#x6f;&#x70;&#98;&#x6f;&#x78;&#x54;&#x61;&#x67;&#x40;&#x78;&#120;&#x78;&#x2e;&#116;&#x78;&#x74;">&#x64;&#x72;&#x6f;&#x70;&#98;&#x6f;&#x78;&#x54;&#x61;&#x67;&#x40;&#x78;&#120;&#x78;&#x2e;&#116;&#x78;&#x74;</a> xxx代表时间戳,例如<a href="mailto:&#115;&#x79;&#115;&#x74;&#101;&#x6d;&#95;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x5f;&#99;&#114;&#97;&#115;&#x68;&#64;&#49;&#x34;&#x36;&#x35;&#54;&#53;&#x30;&#x38;&#x34;&#53;&#51;&#53;&#x35;&#x2e;&#116;&#120;&#116;">&#115;&#x79;&#115;&#x74;&#101;&#x6d;&#95;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x5f;&#99;&#114;&#97;&#115;&#x68;&#64;&#49;&#x34;&#x36;&#x35;&#54;&#53;&#x30;&#x38;&#x34;&#53;&#51;&#53;&#x35;&#x2e;&#116;&#120;&#116;</a>,则记录该文件时间戳为1465650845355. 文件后缀除了.txt，还有压缩格式.txt.gz. 对于dropboxTag是由processClass + eventType组合而成.</p><p>processClass分为system_server, system_app, data_app;<br>eventType：分为crash,anr,wtf,native_cras,lowmem, watchdog</p><p>列举部分常见tags以及含义:</p><table><thead><tr><th>dropboxTag</th><th>含义</th></tr></thead><tbody><tr><td>system_server_anr</td><td>system进程无响应</td></tr><tr><td>system_server_watchdog</td><td>system进程发生watchdog</td></tr><tr><td>system_server_crash</td><td>system进程崩溃</td></tr><tr><td>system_server_native_crash</td><td>system进程native出现崩溃</td></tr><tr><td>system_server_wtf</td><td>system进程发生严重错误</td></tr><tr><td>system_server_lowmem</td><td>system进程内存不足</td></tr><tr><td>当然除了system_server进程, 还有system_app, data_app类型的进程, 以上所有类型都适用,列举部分:</td><td></td></tr></tbody></table><table><thead><tr><th>dropboxTag</th><th>含义</th></tr></thead><tbody><tr><td>system_app_crash</td><td>系统app崩溃</td></tr><tr><td>system_app_anr</td><td>系统app无响应</td></tr><tr><td>data_app_crash</td><td>普通app崩溃</td></tr><tr><td>data_app_anr</td><td>普通app无响应</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ANR </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ANR程序问题分析之traces</title>
      <link href="/blog/2018/07/13/anr-cheng-xu-wen-ti-fen-xi-zhi-traces/"/>
      <url>/blog/2018/07/13/anr-cheng-xu-wen-ti-fen-xi-zhi-traces/</url>
      
        <content type="html"><![CDATA[<p>每次发生ANR，这个文件都会被清空，写入新的内容。如果想查看以前发生ANR的信息，可以去查看DB文件，<br>也就是DropBox的中的日志<br>跟踪功能，保存历史上发生的所有ANR的日志<br>“&#x2F; data &#x2F; system &#x2F; dropbox”是DB指定的文件存放位置。<br>日志保存的最长时间，默认是3天</p><h3 id="ANR的异常信息"><a href="#ANR的异常信息" class="headerlink" title="ANR的异常信息"></a>ANR的异常信息</h3><p>使用logcat命令查看会得到类似如下的log</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WindowManager所在的进程是system_server，进程号是127</span></span><br><span class="line">I/<span class="built_in">WindowManager</span>( <span class="number">127</span>): Input event dispatching timed out sending to com<span class="selector-class">.example</span>.anrdemo/com<span class="selector-class">.example</span><span class="selector-class">.anrdemo</span><span class="selector-class">.ANRActivity</span></span><br><span class="line"><span class="comment">//system_server进程中的ActivityManagerService请求kernel向5033进程发送SIGNAL_QUIT请求</span></span><br><span class="line"><span class="comment">//你可以在shell中使用命令达到相同的目的：adb shell kill -3 5033</span></span><br><span class="line"><span class="comment">//和其他的Java虚拟机一样，SIGNAL_QUIT也是Dalvik内部支持的功能之一</span></span><br><span class="line">I/Process ( <span class="number">127</span>): Sending signal. PID: <span class="number">5033</span> SIG: <span class="number">3</span></span><br><span class="line"><span class="comment">//5033进程的虚拟机实例接收到SIGNAL_QUIT信号后会将进程中各个线程的函数堆栈信息输出到traces.txt文件中</span></span><br><span class="line"><span class="comment">//发生ANR的进程正常情况下会第一个输出</span></span><br><span class="line">I/<span class="built_in">dalvikvm</span>( <span class="number">5033</span>): threadid=<span class="number">4</span>: reacting to signal <span class="number">3</span></span><br><span class="line">I/<span class="built_in">dalvikvm</span>( <span class="number">5033</span>): Wrote stack traces to <span class="string">&#x27;/data/anr/traces.txt&#x27;</span></span><br><span class="line">... ...<span class="comment">//另外还有其他一些进程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//随后会输出CPU使用情况</span></span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): ANR <span class="keyword">in</span> com<span class="selector-class">.example</span><span class="selector-class">.anrdemo</span> (com<span class="selector-class">.example</span>.anrdemo/.ANRActivity)</span><br><span class="line"><span class="comment">//Reason表示导致ANR问题的直接原因</span></span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): Reason: keyDispatchingTimedOut</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): Load: <span class="number">3.85</span> / <span class="number">3.41</span> / <span class="number">3.16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//请注意ago，表示ANR发生之前的一段时间内的CPU使用率，并不是某一时刻的值</span></span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): CPU usage from <span class="number">26835ms</span> to <span class="number">3662ms</span> ago with <span class="number">99%</span> awake:</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">9.4%</span> <span class="number">98</span>/mediaserver: <span class="number">9.4%</span> user + <span class="number">0%</span> kernel</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">8.9%</span> <span class="number">127</span>/system_server: <span class="number">6.9%</span> user + <span class="number">2%</span> kernel / faults: <span class="number">1823</span> minor</span><br><span class="line">... ...</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): +<span class="number">0%</span> <span class="number">5033</span>/com<span class="selector-class">.example</span><span class="selector-class">.anrdemo</span>: <span class="number">0%</span> user + <span class="number">0%</span> kernel</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">39%</span> TOTAL: <span class="number">32%</span> user + <span class="number">6.1%</span> kernel</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里是later，表示ANR发生之后</span></span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): CPU usage from <span class="number">601ms</span> to <span class="number">1132ms</span> later with <span class="number">99%</span> awake:</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">10%</span> <span class="number">127</span>/system_server: <span class="number">1.7%</span> user + <span class="number">8.9%</span> kernel / faults: <span class="number">5</span> minor</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">10%</span> <span class="number">163</span>/InputDispatcher: <span class="number">1.7%</span> user + <span class="number">8.9%</span> kernel</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">1.7%</span> <span class="number">127</span>/system_server: <span class="number">1.7%</span> user + <span class="number">0%</span> kernel</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">1.7%</span> <span class="number">135</span>/SurfaceFlinger: <span class="number">0%</span> user + <span class="number">1.7%</span> kernel</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">1.7%</span> <span class="number">2814</span>/Binder Thread #: <span class="number">1.7%</span> user + <span class="number">0%</span> kernel</span><br><span class="line">... ...</span><br><span class="line">E/<span class="built_in">ActivityManager</span>( <span class="number">127</span>): <span class="number">37%</span> TOTAL: <span class="number">27%</span> user + <span class="number">9.2%</span> kernel</span><br></pre></td></tr></table></figure><p>发生ANR时Android为我们提供了两种“利器”：traces文件和CPU使用率</p><h3 id="ANR信息是如何输出的"><a href="#ANR信息是如何输出的" class="headerlink" title="ANR信息是如何输出的"></a>ANR信息是如何输出的</h3><p>ActivityManagerService类中，找到它的appNotResponding函数</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">    final <span class="literal">void</span> appNotResponding(ProcessRecord app, ActivityRecord activity,</span><br><span class="line">                                ActivityRecord <span class="keyword">parent</span>, final <span class="built_in">String</span> annotation) &#123;</span><br><span class="line"><span class="comment">//firstPids和lastPids两个集合存放那些将会在traces中输出信息的进程的进程号</span></span><br><span class="line">        ArrayList&lt;<span class="built_in">Integer</span>&gt; firstPids = <span class="literal">new</span> ArrayList&lt;<span class="built_in">Integer</span>&gt;(<span class="number">5</span>);</span><br><span class="line">        SparseArray&lt;<span class="built_in">Boolean</span>&gt; lastPids = <span class="literal">new</span> SparseArray&lt;<span class="built_in">Boolean</span>&gt;(<span class="number">20</span>);</span><br><span class="line"><span class="comment">//mController是IActivityController接口的实例，是为Monkey测试程序预留的，默认为null</span></span><br><span class="line">        <span class="keyword">if</span> (mController != <span class="built_in">null</span>) &#123;</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">        long anrTime = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">            updateCpuStatsNow(); <span class="comment">//更新CPU使用率</span></span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (this) &#123; <span class="comment">//一些特定条件下会忽略ANR</span></span><br><span class="line">            <span class="keyword">if</span> (mShuttingDown) &#123;</span><br><span class="line">                Slog.i(<span class="built_in">TAG</span>, <span class="string">&quot;During shutdown skipping ANR: &quot;</span> + app + <span class="string">&quot; &quot;</span> + annotation);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.notResponding) &#123;</span><br><span class="line">                Slog.i(<span class="built_in">TAG</span>, <span class="string">&quot;Skipping duplicate ANR: &quot;</span> + app + <span class="string">&quot; &quot;</span> + annotation);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.crashing) &#123;</span><br><span class="line">                Slog.i(<span class="built_in">TAG</span>, <span class="string">&quot;Crashing app skipping ANR: &quot;</span> + app + <span class="string">&quot; &quot;</span> + annotation);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//使用一个标志变量避免同一个应用在没有处理完时重复输出log</span></span><br><span class="line">            app.notResponding = <span class="literal">true</span>;</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">         <span class="comment">//①当前发生ANR的应用进程被第一个添加进firstPids集合中</span></span><br><span class="line">            firstPids.add(app.pid);</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">        <span class="comment">//②dumpStackTraces是输出traces文件的函数</span></span><br><span class="line">        File tracesFile = dumpStackTraces(<span class="literal">true</span>, firstPids, processStats, lastPids, <span class="built_in">null</span>);</span><br><span class="line">        <span class="built_in">String</span> cpuInfo = <span class="built_in">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123; <span class="comment">//MONITOR_CPU_USAGE默认为true</span></span><br><span class="line">            updateCpuStatsNow(); <span class="comment">//再次更新CPU信息</span></span><br><span class="line">            synchronized (mProcessStatsThread) &#123;</span><br><span class="line">                <span class="comment">//输出ANR发生前一段时间内的CPU使用率</span></span><br><span class="line">                cpuInfo = mProcessStats.printCurrentState(anrTime);</span><br><span class="line">            &#125;</span><br><span class="line">            info.append(processStats.printCurrentLoad());</span><br><span class="line">            info.append(cpuInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//输出ANR发生后一段时间内的CPU使用率</span></span><br><span class="line">        info.append(processStats.printCurrentState(anrTime));</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">        <span class="comment">//③将ANR信息同时输出到DropBox中</span></span><br><span class="line">        addErrorToDropBox(<span class="string">&quot;anr&quot;</span>, app, app.processName, activity, <span class="keyword">parent</span>, annotation,</span><br><span class="line">                cpuInfo, tracesFile, <span class="built_in">null</span>);</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">        <span class="comment">//在Android4.0中可以设置是否不显示ANR提示对话框，如果设置的话就不会显示对话框，并且会杀掉ANR进程</span></span><br><span class="line">        <span class="built_in">boolean</span> showBackground = Settings.Secure.getInt(mContext.getContentResolver(),</span><br><span class="line">                Settings.Secure.ANR_SHOW_BACKGROUND, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!showBackground &amp;&amp; !app.isInterestingToUserLocked() &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">                Process.killProcessQuiet(app.pid);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line">            <span class="comment">// 显示ANR提示对话框</span></span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            HashMap <span class="built_in">map</span> = <span class="literal">new</span> HashMap();</span><br><span class="line">            msg.what = SHOW_NOT_RESPONDING_MSG;</span><br><span class="line">            msg.obj = <span class="built_in">map</span>;</span><br><span class="line">            <span class="built_in">map</span>.put(<span class="string">&quot;app&quot;</span>, app);</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="built_in">null</span>) &#123;</span><br><span class="line">                <span class="built_in">map</span>.put(<span class="string">&quot;activity&quot;</span>, activity);</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>当前发生ANR的应用进程被第一个添加进firstPids集合中，所以会第一个向traces文件中写入信息。反过来说，traces文件中出现的第一个进程正常情况下就是发生ANR的那个进程。不过有时候会很不凑巧，发生ANR的进程还没有来得及输出trace信息，就由于某种原因退出了，所以偶尔会遇到traces文件中找不到发生ANR的进程信息的情况。<br>dumpStackTraces是输出traces文件的函数，接下来分析这个函数<br>addErrorToDropBox函数将ANR信息同时输出到DropBox中，它也是个非常有用的日志存放工具，后面也会分析它的作用。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">File</span> dumpStackTraces(<span class="keyword">boolean</span> clearTraces, ArrayList&lt;Integer&gt; firstPids,</span><br><span class="line">                                       ProcessStats processStats, SparseArray&lt;<span class="keyword">Boolean</span>&gt; lastPids, String[] nativeProcs) &#123;</span><br><span class="line"><span class="comment">//系统属性“dalvik.vm.stack-trace-file”用来配置trace信息输出文件</span></span><br><span class="line">        String tracesPath = SystemProperties.get(<span class="string">&quot;dalvik.vm.stack-trace-file&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (tracesPath == <span class="keyword">null</span> || tracesPath.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">File</span> tracesFile = <span class="keyword">new</span> <span class="keyword">File</span>(tracesPath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">File</span> tracesDir = tracesFile.getParentFile();</span><br><span class="line">            <span class="keyword">if</span> (!tracesDir.exists()) tracesFile.mkdirs();</span><br><span class="line"><span class="comment">//FileUtils.setPermissions是个很有用的函数，设置文件属性时经常会用到</span></span><br><span class="line">            FileUtils.setPermissions(tracesDir.getPath(), <span class="number">0775</span>, -<span class="number">1</span>, -<span class="number">1</span>); <span class="comment">// drwxrwxr-x</span></span><br><span class="line"><span class="comment">//clearTraces为true，会删除旧文件，创建新文件</span></span><br><span class="line">            <span class="keyword">if</span> (clearTraces &amp;&amp; tracesFile.exists()) tracesFile.<span class="keyword">delete</span>();</span><br><span class="line">            tracesFile.createNewFile();</span><br><span class="line">            FileUtils.setPermissions(tracesFile.getPath(), <span class="number">0666</span>, -<span class="number">1</span>, -<span class="number">1</span>); <span class="comment">// -rw-rw-rw-</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Unable to prepare ANR traces file: &quot;</span> + tracesPath, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//一个重载函数</span></span><br><span class="line">        dumpStackTraces(tracesPath, firstPids, processStats, lastPids, nativeProcs);</span><br><span class="line">        <span class="keyword">return</span> tracesFile;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>之所以trace信息会输出到“&#x2F;data&#x2F;anr&#x2F;traces.txt”文件中，就是系统属性“dalvik.vm.stack-trace-file”设置的。你可以通过在设备的shell中使用setprop和getprop对系统属性进行设置和读取：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getpropdalvik.vm.<span class="keyword">stack</span>-trace-<span class="keyword">file</span></span><br><span class="line">setprop dalvik.vm.<span class="keyword">stack</span>-trace-<span class="keyword">file</span> /tmp/<span class="keyword">stack</span>-traces.txt</span><br></pre></td></tr></table></figure><p>每次发生ANR时都会删除旧的traces文件，重新创建新文件。也就是说Android只保留最后一次发生ANR时的traces信息，那么以前的traces信息就丢失了么？稍后回答。<br>接着来看重载的dumpStackTraces函数。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="type">static</span> <span class="type">void</span> <span class="title">dumpStackTraces</span><span class="params">(<span class="type">String</span> tracesPath, ArrayList&lt;Integer&gt; firstPids,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        ProcessStats processStats, SparseArray&lt;Boolean&gt; lastPids, <span class="type">String</span>[] nativeProcs)</span> </span>&#123;</span><br><span class="line"><span class="comment">//使用FileObserver监听应用进程是否已经完成写入traces文件的操作</span></span><br><span class="line"><span class="comment">//Android在判断桌面壁纸文件是否设置完成时也是用的FileObserver，很有用的类</span></span><br><span class="line">        FileObserver observer = <span class="keyword">new</span> <span class="built_in">FileObserver</span>(tracesPath, FileObserver.CLOSE_WRITE) &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">void</span> <span class="built_in">onEvent</span>(<span class="type">int</span> event, <span class="type">String</span> path) &#123;</span><br><span class="line">                <span class="built_in">notify</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">... ...</span><br><span class="line"><span class="comment">//首先输出firstPids集合中指定的进程，这些也是对ANR问题来说最重要的进程</span></span><br><span class="line">        <span class="keyword">if</span> (firstPids != null) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> num = firstPids.<span class="built_in">size</span>();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                    <span class="built_in">synchronized</span> (observer) &#123;</span><br><span class="line"><span class="comment">//前面提到的SIGNAL_QUIT</span></span><br><span class="line">                        <span class="built_in">Process</span>.<span class="built_in">sendSignal</span>(firstPids.<span class="built_in">get</span>(i), <span class="built_in">Process</span>.SIGNAL_QUIT);</span><br><span class="line">                        observer.<span class="built_in">wait</span>(<span class="number">200</span>);</span><br><span class="line">... ...</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><h3 id="分析ANR的trace信息"><a href="#分析ANR的trace信息" class="headerlink" title="分析ANR的trace信息"></a>分析ANR的trace信息</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件中输出的第一个进程的trace信息，正是发生ANR的演示程序</span></span><br><span class="line"><span class="comment">//开头显示进程号、ANR发生的时间点和进程名称</span></span><br><span class="line">----- pid <span class="number">9183</span> at <span class="number">2012</span><span class="number">-09</span><span class="number">-28</span> <span class="number">22</span>:<span class="number">20</span>:<span class="number">42</span> -----</span><br><span class="line">Cmd line: com.example.anrdemo</span><br><span class="line"> </span><br><span class="line">DALVIK THREADS: <span class="comment">//以下是各个线程的函数堆栈信息</span></span><br><span class="line"><span class="comment">//mutexes表示虚拟机实例中各种线程相关对象锁的value值</span></span><br><span class="line">(mutexes: tll=<span class="number">0</span> tsl=<span class="number">0</span> tscl=<span class="number">0</span> ghl=<span class="number">0</span> hwl=<span class="number">0</span> hwll=<span class="number">0</span>)</span><br><span class="line"><span class="comment">//依次是：线程名、线程优先级、线程创建时的序号、①线程当前状态</span></span><br><span class="line"><span class="string">&quot;main&quot;</span> prio=<span class="number">5</span> tid=<span class="number">1</span> TIMED_WAIT</span><br><span class="line"><span class="comment">//依次是：线程组名称、suspendCount、debugSuspendCount、线程的Java对象地址、线程的Native对象地址</span></span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;main&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4025b1b8</span> <span class="built_in">self</span>=<span class="number">0xce68</span></span><br><span class="line"><span class="comment">//sysTid是线程号，主线程的线程号和进程号相同</span></span><br><span class="line">| sysTid=<span class="number">9183</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">-1345002368</span></span><br><span class="line">| schedstat=( <span class="number">140838632</span> <span class="number">210998525</span> <span class="number">213</span> )</span><br><span class="line">at java.lang.VMThread.sleep(Native Method)</span><br><span class="line">at java.lang.<span class="keyword">Thread</span>.sleep(<span class="keyword">Thread</span>.java:<span class="number">1213</span>)</span><br><span class="line">at java.lang.<span class="keyword">Thread</span>.sleep(<span class="keyword">Thread</span>.java:<span class="number">1195</span>)</span><br><span class="line">at com.example.anrdemo.ANRActivity.makeANR(ANRActivity.java:<span class="number">44</span>)</span><br><span class="line">at com.example.anrdemo.ANRActivity.onClick(ANRActivity.java:<span class="number">38</span>)</span><br><span class="line">at android.view.View.performClick(View.java:<span class="number">2486</span>)</span><br><span class="line">at android.view.View$PerformClick.run(View.java:<span class="number">9130</span>)</span><br><span class="line">at android.os.Handler.handleCallback(Handler.java:<span class="number">587</span>)</span><br><span class="line">at android.os.Handler.dispatchMessage(Handler.java:<span class="number">92</span>)</span><br><span class="line">at android.os.Looper.<span class="keyword">loop</span>(Looper.java:<span class="number">130</span>)</span><br><span class="line">at android.app.ActivityThread.main(ActivityThread.java:<span class="number">3703</span>)</span><br><span class="line">at java.lang.reflect.Method.invokeNative(Native Method)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:<span class="number">507</span>)</span><br><span class="line">at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">841</span>)</span><br><span class="line">at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">599</span>)</span><br><span class="line">at dalvik.system.NativeStart.main(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//②Binder线程是进程的线程池中用来处理binder请求的线程</span></span><br><span class="line"><span class="string">&quot;Binder Thread #2&quot;</span> prio=<span class="number">5</span> tid=<span class="number">8</span> NATIVE</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;main&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x40750b90</span> <span class="built_in">self</span>=<span class="number">0x1440b8</span></span><br><span class="line">| sysTid=<span class="number">9190</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1476256</span></span><br><span class="line">| schedstat=( <span class="number">915528</span> <span class="number">18463135</span> <span class="number">4</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;Binder Thread #1&quot;</span> prio=<span class="number">5</span> tid=<span class="number">7</span> NATIVE</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;main&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074f848</span> <span class="built_in">self</span>=<span class="number">0x78d40</span></span><br><span class="line">| sysTid=<span class="number">9189</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1308088</span></span><br><span class="line">| schedstat=( <span class="number">3509523</span> <span class="number">25543212</span> <span class="number">10</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//线程名称后面标识有daemon，说明这是个守护线程</span></span><br><span class="line"><span class="string">&quot;Compiler&quot;</span> daemon prio=<span class="number">5</span> tid=<span class="number">6</span> VMWAIT</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;system&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074b928</span> <span class="built_in">self</span>=<span class="number">0x141e78</span></span><br><span class="line">| sysTid=<span class="number">9188</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1506000</span></span><br><span class="line">| schedstat=( <span class="number">21606438</span> <span class="number">21636964</span> <span class="number">101</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//JDWP线程是支持虚拟机调试的线程，不需要关心</span></span><br><span class="line"><span class="string">&quot;JDWP&quot;</span> daemon prio=<span class="number">5</span> tid=<span class="number">5</span> VMWAIT</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;system&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074b878</span> <span class="built_in">self</span>=<span class="number">0x16c958</span></span><br><span class="line">| sysTid=<span class="number">9187</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1510224</span></span><br><span class="line">| schedstat=( <span class="number">366211</span> <span class="number">2807617</span> <span class="number">7</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"><span class="comment">//“Signal Catcher”负责接收和处理kernel发送的各种信号，例如SIGNAL_QUIT、SIGNAL_USR1等就是被该线程</span></span><br><span class="line"><span class="comment">//接收到，这个文件的内容就是由该线程负责输出的，可以看到它的状态是RUNNABLE，不过此线程也不需要关心</span></span><br><span class="line"><span class="string">&quot;Signal Catcher&quot;</span> daemon prio=<span class="number">5</span> tid=<span class="number">4</span> RUNNABLE</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;system&quot;</span> sCount=<span class="number">0</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074b7b8</span> <span class="built_in">self</span>=<span class="number">0x150008</span></span><br><span class="line">| sysTid=<span class="number">9186</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1501664</span></span><br><span class="line">| schedstat=( <span class="number">1708985</span> <span class="number">6286621</span> <span class="number">9</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;GC&quot;</span> daemon prio=<span class="number">5</span> tid=<span class="number">3</span> VMWAIT</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;system&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074b710</span> <span class="built_in">self</span>=<span class="number">0x168010</span></span><br><span class="line">| sysTid=<span class="number">9185</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">1503184</span></span><br><span class="line">| schedstat=( <span class="number">305176</span> <span class="number">4821778</span> <span class="number">2</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;HeapWorker&quot;</span> daemon prio=<span class="number">5</span> tid=<span class="number">2</span> VMWAIT</span><br><span class="line">| <span class="keyword">group</span>=<span class="string">&quot;system&quot;</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> obj=<span class="number">0x4074b658</span> <span class="built_in">self</span>=<span class="number">0x16a080</span></span><br><span class="line">| sysTid=<span class="number">9184</span> nice=<span class="number">0</span> sched=<span class="number">0</span>/<span class="number">0</span> cgrp=default <span class="keyword">handle</span>=<span class="number">550856</span></span><br><span class="line">| schedstat=( <span class="number">33691407</span> <span class="number">26336669</span> <span class="number">15</span> )</span><br><span class="line">at dalvik.system.NativeStart.run(Native Method)</span><br><span class="line"> </span><br><span class="line">----- end <span class="number">9183</span> -----</span><br><span class="line"> </span><br><span class="line">----- pid <span class="number">127</span> at <span class="number">2012</span><span class="number">-09</span><span class="number">-28</span> <span class="number">22</span>:<span class="number">20</span>:<span class="number">42</span> -----</span><br><span class="line">Cmd line: system_server</span><br><span class="line"><span class="params">...</span> <span class="params">...</span></span><br><span class="line"><span class="comment">//省略其他进程的信息</span></span><br></pre></td></tr></table></figure><h3 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h3><table><thead><tr><th>Thread.java中定义的状态</th><th>Thread.cpp中定义的状态</th><th>说明</th></tr></thead><tbody><tr><td>TERMINATED</td><td>ZOMBIE</td><td>线程死亡，终止运行</td></tr><tr><td>RUNNABLE</td><td>RUNNING&#x2F;RUNNABLE</td><td>线程可运行或正在运行</td></tr><tr><td>TIMED_WAITING</td><td>TIMED_WAIT</td><td>执行了带有超时参数的wait、sleep或join函数</td></tr><tr><td>BLOCKED</td><td>MONITOR</td><td>线程阻塞，等待获取对象锁</td></tr><tr><td>WAITING</td><td>WAIT</td><td>执行了无超时参数的wait函数</td></tr><tr><td>NEW</td><td>INITIALIZING</td><td>新建，正在初始化，为其分配资源</td></tr><tr><td>NEW</td><td>STARTING</td><td>新建，正在启动</td></tr><tr><td>RUNNABLE</td><td>NATIVE</td><td>正在执行JNI本地函数</td></tr><tr><td>WAITING</td><td>VMWAIT</td><td>正在等待VM资源</td></tr><tr><td>RUNNABLE</td><td>SUSPENDED</td><td>线程暂停，通常是由于GC或debug被暂停</td></tr><tr><td></td><td>UNKNOWN</td><td>未知状态</td></tr><tr><td>Thread.java中的状态和Thread.cpp中的状态是有对应关系的。可以看到前者更加概括，也比较容易理解，面向Java的使用者；而后者更详细，面向虚拟机内部的环境。traces.txt中显示的线程状态都是Thread.cpp中定义的。另外，所有的线程都是遵循POSIX标准的本地线程。关于线程更多的说明可以查阅源码&#x2F;dalvik&#x2F;vm&#x2F;Thread.cpp中的说明。<!-- 线程的ThreadGroup最好也写进去 --></td><td></td><td></td></tr><tr><td>traces.txt文件中的这些信息是由每个Dalvik进程的SignalCatcher线程输出的，相关代码可以查看&#x2F;dalvik&#x2F;vm&#x2F;目录下的SignalCatcher.cpp::logThreadStacks函数和Thread.cpp:: dvmDumpAllThreadsEx函数。另外请注意，输出堆栈信息时SignalCatcher会暂停所有线程。</td><td></td><td></td></tr><tr><td>通过该文件很容易就能知道问题进程的主线程发生ANR时正在执行怎样的操作。例如上述示例， ANRActivity在makeANR函数中执行线程sleep时发生ANR，可以推测sleep时间过长，超过了超时上限导致。</td><td></td><td></td></tr></tbody></table><h3 id="CPU使用率"><a href="#CPU使用率" class="headerlink" title="CPU使用率"></a>CPU使用率</h3><p>内容读取自&#x2F;proc&#x2F;stat</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="string">ANR</span> <span class="string">in</span> <span class="string">com.example.anrdemo</span> <span class="string">(com.example.anrdemo/.ANRActivity)</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127): Reason:</span> <span class="string">keyDispatchingTimedOut</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127): Load:</span> <span class="number">3.85</span> <span class="string">/</span> <span class="number">3.41</span> <span class="string">/</span> <span class="number">3.16</span> <span class="string">//➀</span> <span class="string">CPU平均负载</span></span><br><span class="line"> </span><br><span class="line"><span class="string">//②ANR发生之前的一段时间内的CPU使用率</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="string">CPU</span> <span class="string">usage</span> <span class="string">from</span> <span class="string">26835ms</span> <span class="string">to</span> <span class="string">3662ms</span> <span class="string">ago</span> <span class="string">with</span> <span class="number">99</span><span class="string">%</span> <span class="string">awake://③</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">9.4</span><span class="string">%</span> <span class="attr">98/mediaserver:</span> <span class="number">9.4</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">0</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">8.9</span><span class="string">%</span> <span class="attr">127/system_server:</span> <span class="number">6.9</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">2</span><span class="string">%</span> <span class="attr">kernel / faults:</span> <span class="number">1823 </span><span class="string">minor</span> <span class="string">//⑤</span> <span class="string">minor或者major的页错误次数</span></span><br><span class="line"><span class="string">...</span> <span class="string">...</span></span><br><span class="line"><span class="string">E/ActivityManager(</span> <span class="number">127</span><span class="string">)://⑥+0%</span> <span class="attr">5033/com.example.anrdemo:</span> <span class="number">0</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">0</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">39</span><span class="string">%</span> <span class="attr">TOTAL:</span> <span class="number">32</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">6.1</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"> </span><br><span class="line"><span class="string">//⑦ANR发生之后的一段时间内的CPU使用率</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="string">CPU</span> <span class="string">usage</span> <span class="string">from</span> <span class="string">601ms</span> <span class="string">to</span> <span class="string">1132ms</span> <span class="string">later</span> <span class="string">with</span> <span class="number">99</span><span class="string">%</span> <span class="attr">awake:</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">10</span><span class="string">%</span> <span class="attr">127/system_server:</span> <span class="number">1.7</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">8.9</span><span class="string">%</span> <span class="attr">kernel / faults:</span> <span class="number">5</span> <span class="string">minor</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">10</span><span class="string">%</span> <span class="attr">163/InputDispatcher:</span> <span class="number">1.7</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">8.9</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">1.7</span><span class="string">%</span> <span class="attr">127/system_server:</span> <span class="number">1.7</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">0</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">1.7</span><span class="string">%</span> <span class="attr">135/SurfaceFlinger:</span> <span class="number">0</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">1.7</span><span class="string">%</span> <span class="string">kernel</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">1.7</span><span class="string">%</span> <span class="number">2814</span><span class="string">/Binder</span> <span class="string">Thread</span> <span class="comment">#: 1.7% user + 0% kernel</span></span><br><span class="line"><span class="string">...</span> <span class="string">...</span></span><br><span class="line"><span class="attr">E/ActivityManager( 127):</span> <span class="number">37</span><span class="string">%</span> <span class="attr">TOTAL:</span> <span class="number">27</span><span class="string">%</span> <span class="string">user</span> <span class="string">+</span> <span class="number">9.2</span><span class="string">%</span> <span class="string">kernel</span></span><br></pre></td></tr></table></figure><h4 id="CPU负载-平均负载"><a href="#CPU负载-平均负载" class="headerlink" title="CPU负载&#x2F;平均负载"></a>CPU负载&#x2F;平均负载</h4><p>CPU负载是指某一时刻系统中运行队列长度之和加上当前正在CPU上运行的进程数，而CPU平均负载可以理解为一段时间内正在使用和等待使用CPU的活动进程的平均数量。在Linux中“活动进程”是指当前状态为运行或不可中断阻塞的进程。通常所说的负载其实就是指平均负载。<br>用一个从网上看到的很生动的例子来说明（不考虑CPU时间片的限制），把设备中的一个单核CPU比作一个电话亭，把进程比作正在使用和等待使用电话的人，假如有一个人正在打电话，有三个人在排队等待，此刻电话亭的负载就是4。使用中会不断的有人打完电话离开，也会不断的有其他人排队等待，为了得到一个有参考价值的负载值，可以规定每隔5秒记录一下电话亭的负载，并将某一时刻之前的一分钟、五分钟、十五分钟的的负载情况分别求平均值，最终就得到了三个时段的平均负载。<br>实际上我们通常关心的就是在某一时刻的前一分钟、五分钟、十五分钟的CPU平均负载，例如以上日志中这三个值分别是3.85、3.41、3.16，说明前一分钟内正在使用和等待使用CPU的活动进程平均有3.85个，依此类推。在大型服务器端应用中主要关注的是第五分钟和第十五分钟的两个值，但是Android主要应用在便携手持设备中，有特殊的软硬件环境和应用场景，短时间内的系统的较高负载就有可能造成ANR，所以笔者认为一分钟内的平均负载相对来说更具有参考价值。<br>CPU的负载和使用率没有必然关系，有可能只有一个进程在使用CPU，但执行的是复杂的操作；也有可能等待和正在使用CPU的进程很多，但每个进程执行的都是简单操作。<br>实际处理问题时偶尔会遇到由于平均负载高引起的ANR，典型的特征就是系统中应用进程数量多，CPU总使用率较高，但是每个进程的CPU使用率不高，当前应用进程主线程没有异常阻塞，一分钟内的CPU平均负载较高。</p><blockquote><p>提示：Linux内核不断进行着CPU负载的记录，我们可以在任意时刻通过在shell中执行“cat &#x2F;proc&#x2F;loadavg”查看。</p></blockquote><h4 id="ANR发生之前和之后一段时间的CPU使用率"><a href="#ANR发生之前和之后一段时间的CPU使用率" class="headerlink" title="ANR发生之前和之后一段时间的CPU使用率"></a>ANR发生之前和之后一段时间的CPU使用率</h4><p>CPU使用率可以理解为一段时间（记作T）内除CPU空闲时间（记作I）之外的时间与这段时间T的比值，用公式表示可以写为：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU使用率= (<span class="built_in">T</span> – I) / <span class="built_in">T</span></span><br></pre></td></tr></table></figure><p>而时间段T是两个采样时间点的时间差值。<br>之所以可以这样计算，是因为Linux内核会把从系统启动开始到当前时刻CPU活动的所有时间信息都记录下来，我们可以通过查看“&#x2F;proc&#x2F;stat”文件获取这些信息。主要包括以下几种时间，这些时间都是从系统启动开始计算的，单位都是0.01秒：</p><ul><li>user： CPU在用户态的运行时间，不包括nice值为负数的进程运行的时间</li><li>nice： CPU在用户态并且nice值为负数的进程运行的时间</li><li>system：CPU在内核态运行的时间</li><li>idle： CPU空闲时间，不包括iowait时间</li><li>iowait： CPU等待I&#x2F;O操作的时间</li><li>irq： CPU硬中断的时间</li><li>softirq：CPU软中断的时间</li></ul><blockquote><p>注意：随着Linux内核版本的不同，包含的时间类型有可能不同,Android源码只需要关心以上七种类型即可</p></blockquote><p>CPU使用率的计算是在ProcessStats类中实现的。如果在某两个时刻T1和T2（T1 &lt; T2）进行采样记录，CPU使用率的整个算法可以归纳为以下几个公式：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userTime</span> = (user2 + nice2) – (user1 + nice1)</span><br><span class="line"><span class="attr">systemTime</span> = system2 - system1</span><br><span class="line"><span class="attr">idleTime</span> = idle2 - idle1</span><br><span class="line"><span class="attr">iowaitTime</span> = iowait2 - iowait1</span><br><span class="line"><span class="attr">irqTime</span> = irq2 - irq1</span><br><span class="line"><span class="attr">softirqTime</span> = softirq2 - softirq1</span><br><span class="line"><span class="attr">TotalTime</span> = userTime + systemTime + idleTime + iowaitTime + irqTime + softirqTime</span><br></pre></td></tr></table></figure><p>有了以上数据就可以计算具体的使用率了，例如用户态CPU使用率为：<br><code>userCpuUsage = userTime / TotalTime</code><br>依此类推可以计算其他类型的使用率。而整个时间段内CPU使用率为：<br><code>CpuUsage = (TotalTime – idleTime) / TotalTime</code><br>以上计算的是整个系统的CPU使用率，对于指定进程的使用率是通过读取该进程的“&#x2F;proc&#x2F;进程号&#x2F;stat”文件计算的，而对于指定进程的指定线程的使用率是通过读取该线程的“&#x2F;proc&#x2F;进程号&#x2F;task&#x2F;线程号&#x2F;stat”文件计算的。进程和线程的CPU使用率只包含该进程或线程的总使用率、用户态使用率和内核态使用率。<br>AMS在执行appNotResponding函数过程中，共输出了两个时间段的CPU使用率，通常情况下在ANR发生时间点之前和之后各有一段。两段使用率都是两次调用ProcessStats对象的update函数，每次调用update函数时会保留上一时间点的采样数据，并记录当前时间点的采样数据。然后再调用ProcessStats对象的printCurrentState函数<br>代码位置ActivityManagerService.java → appNotResponding</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">//第一次使用成员变量mProcessStats采样</span></span><br><span class="line"><span class="keyword">if</span>(MONITOR_CPU_USAGE)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        updateCpuStatsNow();</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">//声明了一个局部变量，参数true表示包括线程信息</span></span><br><span class="line">    <span class="keyword">final</span> ProcessStats processStats = <span class="keyword">new</span> ProcessStats(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//将processStats作为实参传入，在dumpStackTraces中相隔500毫秒两次调用其update函数进行采样</span></span><br><span class="line">    <span class="keyword">File</span> tracesFile = dumpStackTraces(<span class="keyword">true</span>, firstPids, processStats, lastPids);</span><br><span class="line">    String cpuInfo = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(MONITOR_CPU_USAGE)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">//因为在第一次调用后，可能由于输出trace信息等操作，中间执行了较长的时间，所以有第二次使用成员变量</span></span><br><span class="line"><span class="comment">//mProcessStats采样，尽量使得采样时间点靠后。</span></span><br><span class="line"><span class="comment">//此函数中要求连续两次采样时间间隔不少于5秒，所以一般不会执行第二次采样。一旦执行，就会出现两个采样</span></span><br><span class="line"><span class="comment">//时间点一个在ANR发生之前，另一个在其之后，或者两个时间点都在ANR发生之后的情况。</span></span><br><span class="line">        updateCpuStatsNow();</span><br><span class="line">        <span class="keyword">synchronized</span> (mProcessStatsThread) &#123;</span><br><span class="line"><span class="comment">//mProcessStats是成员变量，创建对象时传入的参数是false，所以不包括线程信息</span></span><br><span class="line"><span class="comment">//此处先输出ANR发生之前一段时间内的CPU使用率</span></span><br><span class="line">            cpuInfo = mProcessStats.printCurrentState(anrTime);</span><br><span class="line">        &#125;</span><br><span class="line">        info.<span class="keyword">append</span>(processStats.printCurrentLoad());</span><br><span class="line">        info.<span class="keyword">append</span>(cpuInfo);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//processStats对象是在ANR发生后创建并采样的，所以输出的是ANR发生之后一段时间内的CPU使用率</span></span><br><span class="line">info.<span class="keyword">append</span>(processStats.printCurrentState(anrTime));</span><br></pre></td></tr></table></figure><h4 id="非睡眠时间百分比"><a href="#非睡眠时间百分比" class="headerlink" title="非睡眠时间百分比"></a>非睡眠时间百分比</h4><p>在记录CPU使用率的每个采样时间点时使用了两种记录方法：SystemClock.uptimeMillis()和SystemClock.elapsedRealtime()，两者的区别就是uptimeMillis不包含睡眠时间，所以两个采样时间点之间的uptimeMillis和elapsedRealtime之比就是非睡眠时间百分比。</p><h4 id="页错误次数"><a href="#页错误次数" class="headerlink" title="页错误次数"></a>页错误次数</h4><p>进程的CPU使用率最后输出的“faults: xxx minor&#x2F;major”部分表示的是页错误次数，当次数为0时不显示。major是指Major Page Fault（主要页错误，简称MPF），内核在读取数据时会先后查找CPU的高速缓存和物理内存，如果找不到会发出一个MPF信息，请求将数据加载到内存。Minor是指Minor Page Fault（次要页错误，简称MnPF），磁盘数据被加载到内存后，内核再次读取时，会发出一个MnPF信息。一个文件第一次被读写时会有很多的MPF，被缓存到内存后再次访问MPF就会很少，MnPF反而变多，这是内核为减少效率低下的磁盘I&#x2F;O操作采用的缓存技术的结果。</p><p>如果ANR发生时发现CPU使用率中iowait占比很高，可以通过查看进程的major次数来推断是哪个进程在进行磁盘I&#x2F;O操作。<!-- 求证一下 --></p><h4 id="新增和移除的进程或线程"><a href="#新增和移除的进程或线程" class="headerlink" title="新增和移除的进程或线程"></a>新增和移除的进程或线程</h4><p>如果一个进程或线程的CPU使用率前有“+”，说明该进程或线程是在最后两次CPU使用率采样时间段内新建的；反之如果是“-”，说明该进程或线程在采样时间段内终止了；如果是空，说明该进程或线程是在倒数第二次采样时间点之前已经存在。</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ANR </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ANR程序无响应简介</title>
      <link href="/blog/2018/07/12/anr-cheng-xu-wu-xiang-ying-jian-jie/"/>
      <url>/blog/2018/07/12/anr-cheng-xu-wu-xiang-ying-jian-jie/</url>
      
        <content type="html"><![CDATA[<p>ANR，英文全称为 Application Not Responding，即应用无响应。<br>具体表现，弹出一个应用无响应的窗口，也可能不弹出直接闪退。</p><h3 id="ANR的类型"><a href="#ANR的类型" class="headerlink" title="ANR的类型"></a>ANR的类型</h3><p>ANR一般有三种类型：</p><ol><li>KeyDispatchTimeout(5 seconds) –主要类型 按键或触摸事件在特定时间内无响应<br>定义参考：ActivityManagerService.java<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// How long we wait until we timeout on key dispatching.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> KEY_DISPATCHING_TIMEOUT = <span class="number">5</span>*<span class="number">1000</span>;</span><br></pre></td></tr></table></figure></li><li>BroadcastTimeout(前台 10 seconds，后台 60 seconds) BroadcastReceiver在特定时间内无法处理完成<br>定义参考：ActivityManagerService.java<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// How long we allow a receiver to run before giving up on it.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> BROADCAST_FG_TIMEOUT = <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> BROADCAST_BG_TIMEOUT = <span class="number">60</span>*<span class="number">1000</span>;</span><br></pre></td></tr></table></figure></li><li>ServiceTimeout(前台 20 seconds，后台 200 seconds) –小概率类型 Service在特定的时间内无法处理完成<br>定义参考：ActiveServices.java<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// How long we wait for a service to finish executing.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> SERVICE_TIMEOUT = <span class="number">20</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="comment">// How long we wait for a service to finish executing.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> SERVICE_BACKGROUND_TIMEOUT = SERVICE_TIMEOUT * <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ANR产生的原因"><a href="#ANR产生的原因" class="headerlink" title="ANR产生的原因"></a>ANR产生的原因</h3><ol><li>应用自身引起，例如：<br>主线程阻塞、IOWait等；</li><li>其他进程间接引起，例如：<br>当前应用进程进行进程间通信请求其他进程，其他进程的操作长时间没有反馈；<br>其他进程的CPU占用率高，使得当前应用进程无法抢占到CPU时间片</li></ol><h3 id="ANR的分析解决"><a href="#ANR的分析解决" class="headerlink" title="ANR的分析解决"></a>ANR的分析解决</h3><ol><li>分析ANR Trace文件<br>ANR Trace文件的路径：&#x2F;data&#x2F;anr&#x2F;traces.txt<br>导出traces.txt文件<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull <span class="regexp">/data/</span>anr<span class="regexp">/traces.txt      ./</span></span><br></pre></td></tr></table></figure><blockquote><p>注意:每次发生ANR时都会删除旧的traces文件，重新创建新文件。也就是说Android只保留最后一次发生ANR时的traces信息</p></blockquote></li><li>分析Android的异常信息收集DropBox的日志<br>DropBox文件路径: &#x2F;data&#x2F;system&#x2F;dropbox<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull <span class="regexp">/data/</span>system<span class="regexp">/dropbox/</span>      ./</span><br></pre></td></tr></table></figure></li><li>通过<a href="https://github.com/markzhai/AndroidPerformanceMonitor">BlockCanary</a>检测耗时操作，应用内集成进行检测,将IO操作&#x2F;耗时操作全部封装成异步任务，放进子线程.</li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ANR </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>控制屏幕底部导航栏的显示与隐藏</title>
      <link href="/blog/2018/07/11/kong-zhi-ping-mu-di-bu-dao-hang-lan-de-xian-shi-yu-yin-cang/"/>
      <url>/blog/2018/07/11/kong-zhi-ping-mu-di-bu-dao-hang-lan-de-xian-shi-yu-yin-cang/</url>
      
        <content type="html"><![CDATA[<p>导航栏（也就是屏幕底部的三个按钮,home,back,recentapp）是系统应用SystemUi.apk的一部分.我们可以在SystemUi.apk的源码中留下接口便于我们控制导航栏的显示和隐藏，我们可以通过广播的接收与发送的方式来实现这个接口。</p><pre><code>app-------&gt;发送广播（hide/show）SystemUi.apk--------&gt;监听广播 (hide-隐藏导航栏，show-显示导航栏)</code></pre><p>SystemUi.apk是系统应用，它在Android文件系统中的路径是：&#x2F;system&#x2F;app&#x2F;；它在Android源码中的路径是：frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;；</p><p>我们只需修改frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;PhoneStatusBar.java</p><p>&lt;1&gt;显示方法使用addNavigationBar()（原有）：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void <span class="built_in">addNavigationBar</span>() &#123;  </span><br><span class="line">    if (DEBUG) Slog<span class="selector-class">.v</span>(TAG, &quot;addNavigationBar: about to add &quot; + mNavigationBarView);  </span><br><span class="line">    if (mNavigationBarView == null) return;  </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">prepareNavigationBarView</span>();  </span><br><span class="line">  </span><br><span class="line">    mWindowManager<span class="selector-class">.addView</span>(mNavigationBarView, getNavigationBarLayoutParams());  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>&lt;2&gt;隐藏方法定义如下（新加）：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void <span class="built_in">removeNavigationBar</span>()&#123;</span><br><span class="line">    <span class="built_in">if</span>(DEBUG) Log<span class="selector-class">.v</span>(TAG,&quot;removeNavigationBar: about to remove &quot;+ mNavigationBarView);</span><br><span class="line">    <span class="built_in">if</span>(mNavigationBarView == null) return;</span><br><span class="line">    mWindowManager<span class="selector-class">.removeView</span>(mNavigationBarView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&lt;3&gt;广播的注册</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter <span class="keyword">filter</span><span class="number">1</span> <span class="operator">=</span> new IntentFilter()<span class="comment">;  </span></span><br><span class="line"><span class="keyword">filter</span><span class="number">1</span>.addAction(<span class="string">&quot;MyRecv_action&quot;</span>)<span class="comment">;  </span></span><br><span class="line">context.registerReceiver(mBroadcastReceiver<span class="number">1</span><span class="punctuation">,</span> <span class="keyword">filter</span><span class="number">1</span>)<span class="comment">;  </span></span><br></pre></td></tr></table></figure><p>&lt;4&gt;广播监听及处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> isDisplayNavBar;</span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mBroadcastReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (isOrderedBroadcast())&#123;</span><br><span class="line">            <span class="keyword">if</span>(action.equals(<span class="string">&quot;MyRecv_action&quot;</span>))&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="comment">//布尔标志isDisplayNavBar保存当前导航栏的状态</span></span><br><span class="line">                <span class="keyword">if</span>(cmd.equals(<span class="string">&quot;hide&quot;</span>)&amp;&amp;isDisplayNavBar)&#123;</span><br><span class="line">                    isDisplayNavBar=<span class="literal">false</span>;</span><br><span class="line">                    removeNavigationBar();</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmd.equals(<span class="string">&quot;show&quot;</span>)&amp;&amp;!isDisplayNavBar)&#123;</span><br><span class="line">                    addNavigationBar();</span><br><span class="line">                    isDisplayNavBar=<span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.abortBroadcast();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>至此修改完毕，编译完毕之后产生新的SystemUi.apk ，替换原文件系统的SystemUi.apk 后重启即可。</p><p>隐藏导航栏：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent=<span class="keyword">new</span> Intent();  </span><br><span class="line">intent.setAction(<span class="string">&quot;MyRecv_action&quot;</span>);  </span><br><span class="line">intent.putExtra(<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;hide&quot;</span>);  </span><br><span class="line"><span class="keyword">this</span>.sendOrderedBroadcast(intent,<span class="literal">null</span>);  </span><br></pre></td></tr></table></figure><p>显示导航栏：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent=<span class="keyword">new</span> Intent();  </span><br><span class="line">intent.setAction(<span class="string">&quot;MyRecv_action&quot;</span>);  </span><br><span class="line">intent.putExtra(<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;show&quot;</span>);  </span><br><span class="line"><span class="keyword">this</span>.sendOrderedBroadcast(intent,<span class="literal">null</span>);  </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[ArchLinux]pacman -S sudo不成功</title>
      <link href="/blog/2018/07/10/archlinux-pacman-s-sudo-bu-cheng-gong/"/>
      <url>/blog/2018/07/10/archlinux-pacman-s-sudo-bu-cheng-gong/</url>
      
        <content type="html"><![CDATA[<p>I want to install sudo. So I type in pacman -S sudo. But then I get the following errors:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$: pacman -S sudo</span><br><span class="line"><span class="built_in">warning</span>: <span class="keyword">database</span> file <span class="keyword">for</span> <span class="string">&#x27;extra&#x27;</span> does <span class="keyword">not</span> exist</span><br><span class="line"><span class="built_in">warning</span>: <span class="keyword">database</span> file <span class="keyword">for</span> <span class="string">&#x27;community&#x27;</span> does <span class="keyword">not</span> exist</span><br><span class="line">error: failed <span class="keyword">to</span> <span class="keyword">prepare</span> <span class="keyword">transaction</span> (could <span class="keyword">not</span> find <span class="keyword">database</span>)</span><br></pre></td></tr></table></figure><p>Firstly, try running pacman -Syy, then try to install sudo again.</p><p>Check that the repositories are uncommented in &#x2F;etc&#x2F;pacman.conf.</p><p>Or your mirrorlist might be outdated: Generate a current list of mirrors and copy it to &#x2F;etc&#x2F;pacman.d&#x2F;mirrorlist</p><p>Quoting from this relevant forum thread:</p><p>You can:</p><p>pick another mirror<br>try using an http mirror, not an ftp one (pick http mirror from the mirrorlist).<br>Alternatively you can manually download the databases with:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget ftp:<span class="regexp">//mi</span>rror.csclub.uwaterloo.ca<span class="regexp">/archlinux/</span>community<span class="regexp">/os/</span>x86_64/community.db</span><br><span class="line">wget ftp:<span class="regexp">//mi</span>rror.csclub.uwaterloo.ca<span class="regexp">/archlinux/</span>extra<span class="regexp">/os/</span>x86_64/extra.db</span><br></pre></td></tr></table></figure><p>move them to  &#x2F;var&#x2F;lib&#x2F;pacman&#x2F;sync&#x2F;  and run ‘pacman -Syu’ again. If you find any *.part files in <code>/var/lib/pacman/sync/</code> e.g. <code>/var/lib/pacman/sync/core.db.part</code> - remove them.</p><p>To prevent having problems like these it is critical to understand pacman. To learn more about using pacman, see the ArchWiki pacman article, and consult man pacman.</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Archlinux </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>隐藏电池图标</title>
      <link href="/blog/2018/07/09/yin-cang-dian-chi-tu-biao/"/>
      <url>/blog/2018/07/09/yin-cang-dian-chi-tu-biao/</url>
      
        <content type="html"><![CDATA[<p>删除小电池图标及百分比</p><ol><li>右上角百分比<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;policy&#x2F;BatteryController.java<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mBatteryPercentageView.setVisibility(View.GONE)<span class="comment">; </span></span><br></pre></td></tr></table></figure></li><li>下拉图标<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;phone&#x2F;StatusBarHeaderView.java<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\\注释((BatteryMeterView) findViewById(R.id.battery)).setBatteryController(batteryController)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">mBatteryLevel.setVisibility <span class="operator">=</span> (View.GONE)<span class="comment">; —锁屏百分比 </span></span><br></pre></td></tr></table></figure></li><li>下拉百分比<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;KeyguardStatusBarView.java<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mBatteryLevel<span class="selector-class">.setVisibility</span>(View.GONE);</span><br><span class="line"></span><br><span class="line">\\注释((BatteryMeterView) <span class="built_in">findViewById</span>(R.id.battery))<span class="selector-class">.setBatteryController</span>(batteryController); —锁屏界面图标 </span><br></pre></td></tr></table></figure></li><li>右上角图标<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;PhoneStatusBar.java<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释((BatteryMeterView) mStatusBarView.findViewById(R.id.battery)) —右上角图标</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//注释dispatchDemoCommandToView(command, args, R.id.battery); </span></span><br></pre></td></tr></table></figure></li><li>注释battery<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;res&#x2F;layout&#x2F;system_icon.xml<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注释<span class="keyword">battery </span></span><br></pre></td></tr></table></figure></li><li>解除电池图标相关属性设置<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;PhoneStatusBarTransitions.java —解除电池图标相关属性设置<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注释mBattery相关的内容</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SystemUI之快捷设置区域QSPanel</title>
      <link href="/blog/2018/07/08/systemui-zhi-kuai-jie-she-zhi-qu-yu-qspanel/"/>
      <url>/blog/2018/07/08/systemui-zhi-kuai-jie-she-zhi-qu-yu-qspanel/</url>
      
        <content type="html"><![CDATA[<p>SystemUI下拉之后的那些快捷设置菜单选项也是属于SystemUI的一种;它的加载也是随着PhoneStatusBar的加载而加载;<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;PhoneStatusBar.java<br>首先从布局方面入手：<br>快捷设置区域的布局是由PhoneStatusBar.Java的makeStatusBarView()统一加载;</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mStatusBarWindow=(StatusBarWindowView)<span class="keyword">View</span>.inflate(<span class="keyword">context</span>,</span><br><span class="line">R.layout.super_status_bar,<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p>加载frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;res&#x2F;layout&#x2F;super_status_bar.xml布局</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">..</span><br><span class="line">...</span><br><span class="line">    &lt;com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.statusbar</span><span class="selector-class">.phone</span><span class="selector-class">.PanelHolder</span></span><br><span class="line">        android:id=<span class="string">&quot;@+id/panel_holder&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">background</span>=<span class="string">&quot;@color/transparent&quot;</span> &gt;</span><br><span class="line">        &lt;include layout=<span class="string">&quot;@layout/status_bar_expanded&quot;</span></span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:<span class="attribute">visibility</span>=<span class="string">&quot;gone&quot;</span> /&gt;</span><br><span class="line">    &lt;/com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.statusbar</span><span class="selector-class">.phone</span>.PanelHolder&gt;</span><br><span class="line">...</span><br><span class="line">..</span><br></pre></td></tr></table></figure><p>而这个布局回去include另外一个布局status_bar_expanded.xml布局，frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;res&#x2F;layout&#x2F;status_bar_expanded.xml;</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">..</span></span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">&lt;LinearLayout</span><br><span class="line">    android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:<span class="attribute">orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span><br><span class="line">    &lt;include</span><br><span class="line">        <span class="attribute">layout</span>=<span class="string">&quot;@layout/qs_panel&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_marginTop</span>=<span class="string">&quot;@dimen/status_bar_header_height_expanded&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">layout_marginLeft</span>=<span class="string">&quot;@dimen/notification_side_padding&quot;</span></span><br><span class="line">      android:<span class="attribute">layout_marginRight</span>=<span class="string">&quot;@dimen/notification_side_padding&quot;</span>/&gt;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span></span><br></pre></td></tr></table></figure><p>同样的在这个布局文件中又会去include一个qs_panel.xml布局，frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;res&#x2F;layout&#x2F;qs_panel.xml;</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.qs</span><span class="selector-class">.QSContainer</span></span><br><span class="line">        xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">        android:id=<span class="string">&quot;@+id/quick_settings_container&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:<span class="attribute">background</span>=<span class="string">&quot;@drawable/qs_background_primary&quot;</span></span><br><span class="line">        android:paddingTop=<span class="string">&quot;8dp&quot;</span></span><br><span class="line">        android:paddingBottom=<span class="string">&quot;8dp&quot;</span></span><br><span class="line">        android:elevation=<span class="string">&quot;2dp&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.qs</span><span class="selector-class">.QSPanel</span></span><br><span class="line">            android:id=<span class="string">&quot;@+id/quick_settings_panel&quot;</span></span><br><span class="line">            android:<span class="attribute">background</span>=<span class="string">&quot;#0000&quot;</span></span><br><span class="line">            android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span><br><span class="line">&lt;/com<span class="selector-class">.android</span><span class="selector-class">.systemui</span><span class="selector-class">.qs</span>.QSContainer&gt;</span><br></pre></td></tr></table></figure><p>见名知意，这个id为quick_settings_panel即为我们所找的那个SystemUI上的快捷设置区域控件的ID;<br>代码控制方面：<br>同样的也是由PhoneStatusBar.java的makeStatusBarView()方法开始的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up the quick settings tile panel</span></span><br><span class="line">mQSPanel = (QSPanel) mStatusBarWindow.findViewById(R.id.quick_settings_panel);</span><br><span class="line"><span class="keyword">if</span> (mQSPanel != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">QSTileHost</span> <span class="variable">qsh</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QSTileHost</span>(mContext, <span class="built_in">this</span>,</span><br><span class="line">            mBluetoothController, mLocationController, mRotationLockController,</span><br><span class="line">            mNetworkController, mZenModeController, mHotspotController,</span><br><span class="line">            mCastController, mFlashlightController,</span><br><span class="line">            mUserSwitcherController, mKeyguardMonitor,</span><br><span class="line">            mSecurityController);</span><br><span class="line">    mQSPanel.setHost(qsh);</span><br><span class="line">    mQSPanel.setTiles(qsh.getTiles());</span><br><span class="line">    mBrightnessMirrorController = <span class="keyword">new</span> <span class="title class_">BrightnessMirrorController</span>(mStatusBarWindow);</span><br><span class="line">    mQSPanel.setBrightnessMirror(mBrightnessMirrorController);</span><br><span class="line">    mHeader.setQSPanel(mQSPanel);</span><br><span class="line">    qsh.setCallback(<span class="keyword">new</span> <span class="title class_">QSTileHost</span>.Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTilesChanged</span><span class="params">()</span> &#123;</span><br><span class="line">            mQSPanel.setTiles(qsh.getTiles());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一步步分析，首先先实例化一个QSPanel对象，然后再去创建QSTileHost对象，其传入的参数即为各种快捷设置控制器，如蓝牙、屏幕旋转、定位、闪光灯等等;<br>分析QSTileHost.java的构造方法：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> QSTileHost(Context context, PhoneStatusBar statusBar,</span><br><span class="line">        BluetoothController bluetooth, LocationController <span class="keyword">location</span>,</span><br><span class="line">        RotationLockController rotation, NetworkController network,</span><br><span class="line">        ZenModeController zen, HotspotController hotspot,</span><br><span class="line">        CastController <span class="keyword">cast</span>, FlashlightController flashlight,</span><br><span class="line">        UserSwitcherController userSwitcher, KeyguardMonitor keyguard,</span><br><span class="line">        SecurityController <span class="keyword">security</span>) &#123;</span><br><span class="line">   </span><br><span class="line">    mContext = context;</span><br><span class="line">    mStatusBar = statusBar;</span><br><span class="line">    mBluetooth = bluetooth;</span><br><span class="line">    mLocation = <span class="keyword">location</span>;</span><br><span class="line">    mRotation = rotation;</span><br><span class="line">    mNetwork = network;</span><br><span class="line">    mZen = zen;</span><br><span class="line">    mHotspot = hotspot;</span><br><span class="line">    mCast = <span class="keyword">cast</span>;</span><br><span class="line">    mFlashlight = flashlight;</span><br><span class="line">    mUserSwitcherController = userSwitcher;</span><br><span class="line">    mKeyguard = keyguard;</span><br><span class="line">    mSecurity = <span class="keyword">security</span>;</span><br><span class="line">   </span><br><span class="line">    final HandlerThread ht = <span class="built_in">new</span> HandlerThread(QSTileHost.<span class="keyword">class</span>.getSimpleName(),</span><br><span class="line">            Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    ht.<span class="keyword">start</span>();</span><br><span class="line">    mLooper = ht.getLooper();</span><br><span class="line">    mUserTracker = <span class="built_in">new</span> CurrentUserTracker(mContext) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="built_in">public</span> <span class="type">void</span> onUserSwitched(<span class="type">int</span> newUserId) &#123;</span><br><span class="line">            recreateTiles();</span><br><span class="line">            <span class="keyword">for</span> (QSTile&lt;?&gt; tile : mTiles.<span class="keyword">values</span>()) &#123;</span><br><span class="line">                tile.userSwitch(newUserId);</span><br><span class="line">            &#125;</span><br><span class="line">            mSecurity.onUserSwitched(newUserId);</span><br><span class="line">            mNetwork.onUserSwitched(newUserId);</span><br><span class="line">            mObserver.register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    recreateTiles();</span><br><span class="line"></span><br><span class="line">    mUserTracker.startTracking();</span><br><span class="line">    mObserver.register();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例化各个控制器，创建一个子线程handler获取Looper对象"><a href="#实例化各个控制器，创建一个子线程handler获取Looper对象" class="headerlink" title="实例化各个控制器，创建一个子线程handler获取Looper对象"></a>实例化各个控制器，创建一个子线程handler获取Looper对象</h3><h3 id="使用TunerService去Settings中查询key为TILES-SETTING的值，即查询快捷设置菜单项，查询到的结果通过onTuningChanged-方法回调返回"><a href="#使用TunerService去Settings中查询key为TILES-SETTING的值，即查询快捷设置菜单项，查询到的结果通过onTuningChanged-方法回调返回" class="headerlink" title="使用TunerService去Settings中查询key为TILES_SETTING的值，即查询快捷设置菜单项，查询到的结果通过onTuningChanged()方法回调返回;"></a>使用TunerService去Settings中查询key为TILES_SETTING的值，即查询快捷设置菜单项，查询到的结果通过onTuningChanged()方法回调返回;</h3><p>frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;tuner&#x2F;TunerService.java</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addTunable</span>(Tunable tunable, <span class="built_in">String</span> <span class="built_in">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mTunableLookup.<span class="property">containsKey</span>(<span class="built_in">key</span>)) &#123;</span><br><span class="line">            mTunableLookup.<span class="property">put</span>(<span class="built_in">key</span>, <span class="keyword">new </span><span class="class title_">ArraySet</span>&lt;Tunable&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        mTunableLookup.<span class="property">get</span>(<span class="built_in">key</span>).<span class="property">add</span>(tunable);</span><br><span class="line">        Uri uri = Settings.<span class="property">Secure</span>.<span class="property">getUriFor</span>(<span class="built_in">key</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mListeningUris.<span class="property">containsKey</span>(uri)) &#123;</span><br><span class="line">            mListeningUris.<span class="property">put</span>(uri, <span class="built_in">key</span>);</span><br><span class="line">            mContentResolver.<span class="property">registerContentObserver</span>(uri, <span class="literal">false</span>, mObserver, mCurrentUser);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Send the first state.</span></span><br><span class="line">        <span class="built_in">String</span> value = Settings.<span class="property">Secure</span>.<span class="property">getStringForUser</span>(mContentResolver, <span class="built_in">key</span>, mCurrentUser);</span><br><span class="line">        tunable.<span class="property">onTuningChanged</span>(<span class="built_in">key</span>, value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;statusbar&#x2F;phone&#x2F;QSTileHost.java的onTuningChanged()方法</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    public <span class="keyword">void</span> onTuningChanged(<span class="built_in">String</span> key, <span class="built_in">String</span> newValue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!TILES_SETTING.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Recreating tiles&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; tileSpecs = loadTileSpecs(newValue);</span><br><span class="line">        <span class="keyword">if</span> (tileSpecs.equals(mTileSpecs)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">Map</span>.Entry&lt;<span class="built_in">String</span>, QSTile&lt;?&gt;&gt; tile : mTiles.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!tileSpecs.contains(tile.getKey())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Destroying tile: &quot;</span> + tile.getKey());</span><br><span class="line">                tile.getValue().destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> LinkedHashMap&lt;<span class="built_in">String</span>, QSTile&lt;?&gt;&gt; newTiles = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">String</span> tileSpec : tileSpecs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mTiles.containsKey(tileSpec)) &#123;</span><br><span class="line">                newTiles.put(tileSpec, mTiles.<span class="keyword">get</span>(tileSpec));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Creating tile: &quot;</span> + tileSpec);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    newTiles.put(tileSpec, createTile(tileSpec));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">&quot;Error creating tile for spec: &quot;</span> + tileSpec, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mTileSpecs.clear();</span><br><span class="line">        mTileSpecs.addAll(tileSpecs);</span><br><span class="line">        mTiles.clear();</span><br><span class="line">        mTiles.putAll(newTiles);</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCallback.onTilesChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="在通过调用loadTileSpecs-方法对查询的结果进行判断处理"><a href="#在通过调用loadTileSpecs-方法对查询的结果进行判断处理" class="headerlink" title="在通过调用loadTileSpecs()方法对查询的结果进行判断处理;"></a>在通过调用loadTileSpecs()方法对查询的结果进行判断处理;</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; loadTileSpecs(Context context, <span class="built_in">String</span> tileList) &#123;</span><br><span class="line">        final Resources res = context.getResources();</span><br><span class="line">        final <span class="built_in">String</span> defaultTileList = res.getString(R.<span class="built_in">string</span>.quick_settings_tiles_default);</span><br><span class="line">        <span class="keyword">if</span> (tileList == <span class="built_in">null</span>) &#123;</span><br><span class="line">            tileList = res.getString(R.<span class="built_in">string</span>.quick_settings_tiles);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">&quot;Loaded tile specs from config: &quot;</span> + tileList);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">&quot;Loaded tile specs from setting: &quot;</span> + tileList);</span><br><span class="line">        &#125;</span><br><span class="line">        final ArrayList&lt;<span class="built_in">String</span>&gt; tiles = <span class="literal">new</span> ArrayList&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line">        <span class="built_in">boolean</span> addedDefault = <span class="literal">false</span>;</span><br><span class="line">        for (<span class="built_in">String</span> tile : tileList.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">            tile = tile.trim();</span><br><span class="line">            <span class="keyword">if</span> (tile.isEmpty()) continue;</span><br><span class="line">            <span class="keyword">if</span> (tile.<span class="keyword">equals</span>(<span class="string">&quot;default&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!addedDefault) &#123;</span><br><span class="line">                    tiles.addAll(Arrays.asList(defaultTileList.split(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">                    addedDefault = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tiles.add(tile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tiles;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果返回的结果tileList不为null，使用”,”来拆分结果，对得到的每个tile进行判断，如果不为”default”,即保存此tile;<br>如果返回的结果tileList为null，则tileList赋值为”default”，并读取config.xml中的quick_settings_tiles_default字串，拆分保存;<br>返回所符合要求显示的快捷设置tile集合;</p><h3 id="在QSTileHost-java的onTuningChanged-方法中调用createTile-方法来创建每一个快捷设置的tile对象；"><a href="#在QSTileHost-java的onTuningChanged-方法中调用createTile-方法来创建每一个快捷设置的tile对象；" class="headerlink" title="在QSTileHost.java的onTuningChanged()方法中调用createTile()方法来创建每一个快捷设置的tile对象；"></a>在QSTileHost.java的onTuningChanged()方法中调用createTile()方法来创建每一个快捷设置的tile对象；</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> QSTile&lt;?&gt; createTile(String tileSpec) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;wifi&quot;</span>)) <span class="keyword">return</span> new WifiTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;bt&quot;</span>)) <span class="keyword">return</span> new BluetoothTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;cell&quot;</span>)) <span class="keyword">return</span> new CellularTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;dnd&quot;</span>)) <span class="keyword">return</span> new DndTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;inversion&quot;</span>)) <span class="keyword">return</span> new ColorInversionTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;airplane&quot;</span>)) <span class="keyword">return</span> new AirplaneModeTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;work&quot;</span>)) <span class="keyword">return</span> new WorkModeTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;rotation&quot;</span>)) <span class="keyword">return</span> new RotationLockTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;flashlight&quot;</span>)) <span class="keyword">return</span> new FlashlightTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;location&quot;</span>)) <span class="keyword">return</span> new LocationTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;cast&quot;</span>)) <span class="keyword">return</span> new CastTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;hotspot&quot;</span>)) <span class="keyword">return</span> new HotspotTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;user&quot;</span>)) <span class="keyword">return</span> new UserTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;battery&quot;</span>)) <span class="keyword">return</span> new BatteryTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;saver&quot;</span>)) <span class="keyword">return</span> new DataSaverTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.equals(<span class="string">&quot;night&quot;</span>)) <span class="keyword">return</span> new NightDisplayTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// Intent tiles.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.startsWith(IntentTile.PREFIX)) <span class="keyword">return</span> IntentTile.create(<span class="keyword">this</span>,tileSpec);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.startsWith(CustomTile.PREFIX)) <span class="keyword">return</span> CustomTile.create(<span class="keyword">this</span>,tileSpec);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Bad tile spec: &quot;</span> + tileSpec);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>并将其保存在成员变量的mTiles集合中，最后回调onTilesChanged()方法，通知PhoneStatusBar.java对快捷设置选项显示更新;</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (mCallback != null) &#123;</span><br><span class="line">            mCallback<span class="selector-class">.onTilesChanged</span>();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>至此QSTileHost.java的构造方法分析完成，然后再回到调用处PhoneStatusBar.java的makeStatusBarView()方法继续分析：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mQSPanel.setHost(qsh)<span class="comment">;</span></span><br><span class="line">mQSPanel.setTiles(qsh.getTiles())<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>设置QSPanel.setHost()、设置QSPanel.setTiles();而其中的其中setTiles()方法会先remove掉所有的TileRecord记录并移除所有的tileView;</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void <span class="built_in">setTiles</span>(Collection&lt;QSTile&lt;?&gt;&gt; tiles) &#123;</span><br><span class="line">        for (TileRecord record : mRecords) &#123;</span><br><span class="line">            <span class="built_in">removeView</span>(record.tileView);</span><br><span class="line">        &#125;</span><br><span class="line">        mRecords<span class="selector-class">.clear</span>();</span><br><span class="line">        for (QSTile&lt;?&gt; tile : tiles) &#123;</span><br><span class="line">            <span class="built_in">addTile</span>(tile);</span><br><span class="line">        &#125;</span><br><span class="line">        if (isShowingDetail()) &#123;</span><br><span class="line">            mDetail<span class="selector-class">.bringToFront</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后在重新调用addTile()创建TileRecord对象并赋值绑定相应的回调和点击事件(点击、双击、长按)接口，再将其保存到ArrayList<TileRecord> mRecords集合中，然后再去addView();</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addTile</span><span class="params">(<span class="keyword">final</span> QSTile&lt;?&gt; tile)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TileRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TileRecord</span>();</span><br><span class="line">        r.tile = tile;</span><br><span class="line">        r.tileView = tile.createTileView(mContext);</span><br><span class="line">        r.tileView.setVisibility(View.GONE);</span><br><span class="line">        <span class="keyword">final</span> QSTile.<span class="type">Callback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QSTile</span>.Callback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(QSTile.State state)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">visibility</span> <span class="operator">=</span> state.visible ? VISIBLE : GONE;</span><br><span class="line">                <span class="keyword">if</span> (state.visible &amp;&amp; !mGridContentVisible) &#123;</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// We don&#x27;t want to show it if the content is hidden,</span></span><br><span class="line">                    <span class="comment">// then we just set it to invisible, to ensure that it gets visible again</span></span><br><span class="line">                    visibility = INVISIBLE;</span><br><span class="line">                &#125;</span><br><span class="line">                setTileVisibility(r.tileView, visibility);</span><br><span class="line">                r.tileView.onStateChanged(state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onShowDetail</span><span class="params">(<span class="type">boolean</span> show)</span> &#123;</span><br><span class="line">                QSPanel.<span class="built_in">this</span>.showDetail(show, r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onToggleStateChanged</span><span class="params">(<span class="type">boolean</span> state)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mDetailRecord == r) &#123;</span><br><span class="line">                    fireToggleStateChanged(state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScanStateChanged</span><span class="params">(<span class="type">boolean</span> state)</span> &#123;</span><br><span class="line">                r.scanState = state;</span><br><span class="line">                <span class="keyword">if</span> (mDetailRecord == r) &#123;</span><br><span class="line">                    fireScanStateChanged(r.scanState);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnnouncementRequested</span><span class="params">(CharSequence announcement)</span> &#123;</span><br><span class="line">                announceForAccessibility(announcement);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        r.tile.setCallback(callback);</span><br><span class="line">        <span class="keyword">final</span> View.<span class="type">OnClickListener</span> <span class="variable">click</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                r.tile.click();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">final</span> View.<span class="type">OnClickListener</span> <span class="variable">clickSecondary</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                r.tile.secondaryClick();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">final</span> View.<span class="type">OnLongClickListener</span> <span class="variable">longClick</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnLongClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLongClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                r.tile.longClick();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        r.tileView.init(click, clickSecondary, longClick);</span><br><span class="line">        r.tile.setListening(mListening);</span><br><span class="line">        callback.onStateChanged(r.tile.getState());</span><br><span class="line">        r.tile.refreshState();</span><br><span class="line">        mRecords.add(r);</span><br><span class="line"> </span><br><span class="line">        addView(r.tileView);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>再回到调用处PhoneStatusBar.java的makeStatusBarView()方法继续分析：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qsh.<span class="title function_">setCallback</span>(<span class="keyword">new</span> <span class="title class_">QSTileHost</span>.<span class="title class_">Callback</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onTilesChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    mQSPanel.<span class="title function_">setTiles</span>(qsh.<span class="title function_">getTiles</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure><p>为QSTileHost的对象设置onTilesChanged()回调监听；</p><p>至此完成快捷区域加载显示的大致流程分析。</p><h3 id="隐藏下拉状态栏快捷方式方法："><a href="#隐藏下拉状态栏快捷方式方法：" class="headerlink" title="隐藏下拉状态栏快捷方式方法："></a>隐藏下拉状态栏快捷方式方法：</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> QSTile&lt;?&gt; createTile(String tileSpec) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;wifi&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> WifiTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">/**delete by chensy 隐藏下拉状态栏 蓝牙、飞行模式、自动旋转、GPS、投屏 start*/</span></span><br><span class="line"><span class="comment">//        else if (tileSpec.equals(&quot;bt&quot;)) return new BluetoothTile(this);</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;inversion&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> ColorInversionTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;cell&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> CellularTileForSlot(<span class="keyword">this</span>, PhoneConstants.SIM_ID_1);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;cell2&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> CellularTileForSlot(<span class="keyword">this</span>, PhoneConstants.SIM_ID_2);</span><br><span class="line"><span class="comment">//        else if (tileSpec.equals(&quot;airplane&quot;)) return new AirplaneModeTile(this);</span></span><br><span class="line"><span class="comment">//        else if (tileSpec.equals(&quot;rotation&quot;)) return new RotationLockTile(this);</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;flashlight&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> FlashlightTile(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//        else if (tileSpec.equals(&quot;location&quot;)) return new LocationTile(this);</span></span><br><span class="line"><span class="comment">//        else if (tileSpec.equals(&quot;cast&quot;)) return new CastTile(this);</span></span><br><span class="line">        <span class="comment">/**delete by chensy 隐藏下拉状态栏 蓝牙、飞行模式、自动旋转、GPS、投屏 end*/</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.<span class="keyword">equals</span>(<span class="string">&quot;hotspot&quot;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> HotspotTile(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tileSpec.startsWith(IntentTile.PREFIX)) <span class="keyword">return</span> IntentTile.create(<span class="keyword">this</span>,tileSpec);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Bad tile spec: &quot;</span> + tileSpec);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>无线网络-&gt;更多-&gt;删除飞行模式、网络热点共享入口</title>
      <link href="/blog/2018/07/07/wu-xian-wang-luo-geng-duo-shan-chu-fei-xing-mo-shi-wang-luo-re-dian-gong-xiang-ru-kou/"/>
      <url>/blog/2018/07/07/wu-xian-wang-luo-geng-duo-shan-chu-fei-xing-mo-shi-wang-luo-re-dian-gong-xiang-ru-kou/</url>
      
        <content type="html"><![CDATA[<h3 id="删除飞行模式开关"><a href="#删除飞行模式开关" class="headerlink" title="删除飞行模式开关"></a>删除飞行模式开关</h3><p>&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;src&#x2F;com&#x2F;android&#x2F;settings&#x2F;WirelessSettings.java</p><p>onCreate（）方法里面</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/**add || <span class="literal">true</span> <span class="keyword">by</span> chensy 隐藏飞行模式 */</span><br><span class="line"><span class="keyword">if</span> (mPm.hasSystemFeature(PackageManager.FEATURE_TELEVISION)||<span class="literal">true</span>) &#123;</span><br><span class="line">    removePreference(KEY_TOGGLE_AIRPLANE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;res&#x2F;xml&#x2F;wireless_settings.xml<br>还有一处，把引用android:dependency&#x3D;”toggle_airplane”去掉</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">   <span class="tag">&lt;<span class="name">PreferenceScreen</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:key</span>=<span class="string">&quot;mobile_network_settings&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:title</span>=<span class="string">&quot;@string/network_settings_title&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">settings:keywords</span>=<span class="string">&quot;@string/keywords_more_mobile_networks&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- android:dependency=&quot;toggle_airplane&quot;--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">intent</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:action</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:targetPackage</span>=<span class="string">&quot;com.android.phone&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:targetClass</span>=<span class="string">&quot;com.android.phone.MobileNetworkSettings&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">PreferenceScreen</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="删除网络热点共享入口"><a href="#删除网络热点共享入口" class="headerlink" title="删除网络热点共享入口"></a>删除网络热点共享入口</h3><p>&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;src&#x2F;com&#x2F;android&#x2F;settings&#x2F;WirelessSettings.java</p><p>onCreate（）方法里面</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/** add |<span class="type">| true</span> <span class="built_in">by</span> chensy 隐藏WiFi热点 */</span><br><span class="line"><span class="keyword">if</span> (isSecondaryUser |<span class="type">| !cm</span>.isTetheringSupported() |<span class="type">| true</span></span><br><span class="line">        |<span class="type">| mUm</span>.hasUserRestriction(UserManager.DISALLOW_CONFIG_TETHERING)) &#123;</span><br><span class="line">    getPreferenceScreen().removePreference(findPreference(KEY_TETHER_SETTINGS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设备-&gt;显示-&gt;删除休眠、设备旋转、投射屏幕入口</title>
      <link href="/blog/2018/07/06/she-bei-xian-shi-shan-chu-xiu-mian-she-bei-xuan-zhuan-tou-she-ping-mu-ru-kou/"/>
      <url>/blog/2018/07/06/she-bei-xian-shi-shan-chu-xiu-mian-she-bei-xuan-zhuan-tou-she-ping-mu-ru-kou/</url>
      
        <content type="html"><![CDATA[<h3 id="删除休眠"><a href="#删除休眠" class="headerlink" title="删除休眠"></a>删除休眠</h3><p>&#x2F;packages&#x2F;apps&#x2F;Settings&#x2F;src&#x2F;com&#x2F;android&#x2F;settings&#x2F;DisplaySettings.java</p><p>在onCreate()方法里面</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** delete by chensy 删除休眠功能</span></span><br><span class="line"><span class="comment">        mScreenTimeoutPreference = (ListPreference) findPreference(KEY_SCREEN_TIMEOUT);</span></span><br><span class="line"><span class="comment">        final long currentTimeout = Settings.System.getLong(resolver, SCREEN_OFF_TIMEOUT,</span></span><br><span class="line"><span class="comment">                FALLBACK_SCREEN_TIMEOUT_VALUE);</span></span><br><span class="line"><span class="comment">        mScreenTimeoutPreference.setValue(String.valueOf(currentTimeout));</span></span><br><span class="line"><span class="comment">        mScreenTimeoutPreference.setOnPreferenceChangeListener(this);</span></span><br><span class="line"><span class="comment">        disableUnusableTimeouts(mScreenTimeoutPreference);</span></span><br><span class="line"><span class="comment">        updateTimeoutPreferenceDescription(currentTimeout);  */</span>   <span class="comment">//把这一大段注释掉，然后添加下面这句</span></span><br><span class="line"><span class="built_in">removePreference</span>(KEY_SCREEN_TIMEOUT);</span><br></pre></td></tr></table></figure><h3 id="删除设备旋转"><a href="#删除设备旋转" class="headerlink" title="删除设备旋转"></a>删除设备旋转</h3><p>在onCreate()方法里面</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">removePreference(KEY_AUTO_ROTATE);</span></span><br></pre></td></tr></table></figure><h3 id="删除投射屏幕"><a href="#删除投射屏幕" class="headerlink" title="删除投射屏幕"></a>删除投射屏幕</h3><p>在onCreate()方法里面</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">removePreference(&quot;wifi_display&quot;);</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>恢复出厂设置添加密码输入</title>
      <link href="/blog/2018/07/05/hui-fu-chu-han-she-zhi-tian-jia-mi-ma-shu-ru/"/>
      <url>/blog/2018/07/05/hui-fu-chu-han-she-zhi-tian-jia-mi-ma-shu-ru/</url>
      
        <content type="html"><![CDATA[<p>恢复出厂设置需要添加密码输入才能点击恢复出厂设置</p><h3 id="自定义输入密码框"><a href="#自定义输入密码框" class="headerlink" title="自定义输入密码框"></a>自定义输入密码框</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.settings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.RectF;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.DisplayMetrics;</span><br><span class="line"><span class="keyword">import</span> android.util.TypedValue;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> android.graphics.Paint.ANTI_ALIAS_FLAG;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordInputView</span> <span class="keyword">extends</span> <span class="title class_">EditText</span> &#123;</span><br><span class="line">        <span class="comment">//外边框颜色</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">borderColor</span> <span class="operator">=</span> <span class="number">0xFFCCCCCC</span>;</span><br><span class="line">        <span class="comment">//外边框线的粗细</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">float</span> <span class="variable">borderWidth</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//外边框圆角半径</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">float</span> <span class="variable">borderRadius</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="comment">//中间分割线粗细</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">float</span> <span class="variable">dividerWidth</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="comment">//密码长度，默认6个字符</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">passwordLength</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">        <span class="comment">//密码文字颜色</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">passwordColor</span> <span class="operator">=</span> <span class="number">0xFFCCCCCC</span>;</span><br><span class="line">        <span class="comment">//密码圆点的半径</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">float</span> <span class="variable">passwordRadius</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="comment">//画笔</span></span><br><span class="line">        <span class="keyword">private</span> Paint paint;</span><br><span class="line">        <span class="comment">//整个view的宽，高</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> width, height;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PasswordInputView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line"></span><br><span class="line">        <span class="type">DisplayMetrics</span> <span class="variable">dm</span> <span class="operator">=</span> getResources().getDisplayMetrics();</span><br><span class="line">        borderWidth = (<span class="type">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, borderWidth, dm);</span><br><span class="line">        borderRadius = (<span class="type">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, borderRadius, dm);</span><br><span class="line">        passwordLength = (<span class="type">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, passwordLength, dm);</span><br><span class="line">        passwordRadius = (<span class="type">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, passwordRadius, dm);</span><br><span class="line">        <span class="comment">//获得自定义属性的值</span></span><br><span class="line">        <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.getTheme().obtainStyledAttributes(attrs, R.styleable.PasswordInputView, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        borderColor = a.getColor(R.styleable.PasswordInputView_pivBorderColor, borderColor);</span><br><span class="line">        borderWidth = a.getDimension(R.styleable.PasswordInputView_pivBorderWidth, borderWidth);</span><br><span class="line">        borderRadius = a.getDimension(R.styleable.PasswordInputView_pivBorderRadius, borderRadius);</span><br><span class="line">        passwordLength = a.getInt(R.styleable.PasswordInputView_pivPasswordLength, passwordLength);</span><br><span class="line">        passwordColor = a.getColor(R.styleable.PasswordInputView_pivPasswordColor, passwordColor);</span><br><span class="line">        passwordRadius = a.getDimension(R.styleable.PasswordInputView_pivPasswordRadius, passwordRadius);</span><br><span class="line">        dividerWidth = a.getDimension(R.styleable.PasswordInputView_dividerWidth, dividerWidth);</span><br><span class="line">        a.recycle();</span><br><span class="line"></span><br><span class="line">        paint = <span class="keyword">new</span> <span class="title class_">Paint</span>(ANTI_ALIAS_FLAG);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        width = getWidth();</span><br><span class="line">        height = getHeight();</span><br><span class="line">        drawBorder(canvas);</span><br><span class="line">        drawDivider(canvas);</span><br><span class="line">        drawCircle(canvas);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绘制外边框</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">drawBorder</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        paint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        paint.setColor(borderColor);</span><br><span class="line">        paint.setStrokeWidth(borderWidth);</span><br><span class="line">        <span class="type">RectF</span> <span class="variable">rectF</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RectF</span>(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        canvas.drawRoundRect(rectF, borderRadius, borderRadius, paint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绘制分割线</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">drawDivider</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        paint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        paint.setColor(borderColor);</span><br><span class="line">        paint.setStrokeWidth(dividerWidth);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; passwordLength; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> i * (width / passwordLength);</span><br><span class="line">            canvas.drawLine(x, <span class="number">0</span>, x, height, paint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绘制圆点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">drawCircle</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        paint.setStyle(Paint.Style.FILL);</span><br><span class="line">        paint.setColor(passwordColor);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> getText().toString().trim();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; content.length(); i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cx</span> <span class="operator">=</span> width / passwordLength / <span class="number">2</span> + i * width / passwordLength;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cy</span> <span class="operator">=</span> height / <span class="number">2</span>;</span><br><span class="line">            canvas.drawCircle(cx, cy, width / passwordLength / <span class="number">8</span>, paint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onTextChanged</span><span class="params">(CharSequence text, <span class="type">int</span> start, <span class="type">int</span> lengthBefore, <span class="type">int</span> lengthAfter)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onTextChanged(text, start, lengthBefore, lengthAfter);</span><br><span class="line">        invalidate();</span><br><span class="line">        <span class="comment">//密码输入完成后做的操作，例如密码验证，页面跳转等</span></span><br><span class="line">        <span class="keyword">if</span> (text.length() == passwordLength) &#123;</span><br><span class="line">            <span class="keyword">if</span> (onCompleteListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                onCompleteListener.onComplete(text);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> OnCompleteListener onCompleteListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnCompleteListener</span><span class="params">(OnCompleteListener onCompleteListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onCompleteListener = onCompleteListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnCompleteListener</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">(CharSequence text)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义数字属性"><a href="#自定义数字属性" class="headerlink" title="自定义数字属性"></a>自定义数字属性</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">declare</span>-styleable <span class="type">name</span>=&quot;PasswordInputView&quot;&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivBorderColor&quot; <span class="keyword">format</span>=&quot;color&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivBorderWidth&quot; <span class="keyword">format</span>=&quot;dimension&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivBorderRadius&quot; <span class="keyword">format</span>=&quot;dimension&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivPasswordColor&quot; <span class="keyword">format</span>=&quot;color&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivPasswordWidth&quot; <span class="keyword">format</span>=&quot;dimension&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivPasswordRadius&quot; <span class="keyword">format</span>=&quot;dimension&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;pivPasswordLength&quot; <span class="keyword">format</span>=&quot;integer&quot;/&gt;</span><br><span class="line">      &lt;attr <span class="type">name</span>=&quot;dividerWidth&quot; <span class="keyword">format</span>=&quot;dimension&quot;/&gt;</span><br><span class="line">  &lt;/<span class="keyword">declare</span>-styleable&gt;</span><br></pre></td></tr></table></figure><h3 id="布局文件"><a href="#布局文件" class="headerlink" title="布局文件"></a>布局文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--add by chensy 添加恢复出厂设置 添加密码 start--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">com.android.settings.PasswordInputView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/passwordInputView&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;56dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_margin</span>=<span class="string">&quot;10dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:cursorVisible</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:inputType</span>=<span class="string">&quot;number&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pivBorderColor</span>=<span class="string">&quot;#808080&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pivBorderRadius</span>=<span class="string">&quot;5dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pivBorderWidth</span>=<span class="string">&quot;1dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pivPasswordColor</span>=<span class="string">&quot;#808080&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:dividerWidth</span>=<span class="string">&quot;0.5dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:maxLength</span>=<span class="string">&quot;8&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pivPasswordLength</span>=<span class="string">&quot;8&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@null&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:focusable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--add by chensy 添加恢复出厂设置 密码 end--&gt;</span></span><br></pre></td></tr></table></figure><h3 id="添加恢复出厂设置输入密码"><a href="#添加恢复出厂设置输入密码" class="headerlink" title="添加恢复出厂设置输入密码"></a>添加恢复出厂设置输入密码</h3><p>packages&#x2F;apps&#x2F;Settings&#x2F;src&#x2F;com&#x2F;android&#x2F;settings&#x2F;MasterClearConfirm.java</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  @Override</span><br><span class="line">  <span class="built_in">public</span> <span class="keyword">View</span> onCreateView(LayoutInflater inflater, ViewGroup container,</span><br><span class="line">          Bundle savedInstanceState) &#123;</span><br><span class="line">      <span class="keyword">if</span> (UserManager.<span class="keyword">get</span>(getActivity()).hasUserRestriction(</span><br><span class="line">              UserManager.DISALLOW_FACTORY_RESET)) &#123;</span><br><span class="line">          <span class="keyword">return</span> inflater.inflate(R.layout.master_clear_disallowed_screen, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">mContentView = inflater.inflate(R.layout.master_clear_confirm, <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">/**add by chensy 添加恢复出厂设置密码*/</span></span><br><span class="line">      inputView = (PasswordInputView)mContentView.findViewById(R.id.passwordInputView);</span><br><span class="line">      inputView.setFocusable(<span class="keyword">true</span>);</span><br><span class="line">      inputView.requestFocus();</span><br><span class="line">      inputView.setOnCompleteListener(<span class="built_in">new</span> PasswordInputView.OnCompleteListener() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          <span class="built_in">public</span> <span class="type">void</span> onComplete(CharSequence <span class="type">text</span>) &#123;</span><br><span class="line">              <span class="keyword">Log</span>.d(&quot;chensy&quot;, &quot;onComplete: &quot;+<span class="type">text</span>);</span><br><span class="line">              passwd = <span class="type">text</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">/** add by chensy 添加恢复出厂设置密码 */</span></span><br><span class="line">      establishFinalConfirmationState();</span><br><span class="line">      <span class="keyword">return</span> mContentView;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决被第三方应用强制竖屏</title>
      <link href="/blog/2018/07/04/jie-jue-bei-di-san-fang-ying-yong-qiang-zhi-shu-ping/"/>
      <url>/blog/2018/07/04/jie-jue-bei-di-san-fang-ying-yong-qiang-zhi-shu-ping/</url>
      
        <content type="html"><![CDATA[<p>代码路径 frameworks\base\core\java\android\view\windowmanager.java</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        * Specific orientation value for a window.</span></span><br><span class="line"><span class="comment">        * May be any of the same values allowed</span></span><br><span class="line"><span class="comment">        * for &#123;<span class="doctag">@link</span> android.content.pm.ActivityInfo#screenOrientation&#125;. </span></span><br><span class="line"><span class="comment">        * If not set, a default value of </span></span><br><span class="line"><span class="comment">        * &#123;<span class="doctag">@link</span> android.content.pm.ActivityInfo#SCREEN_ORIENTATION_UNSPECIFIED&#125; </span></span><br><span class="line"><span class="comment">        * will be used.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">int</span> screenOrientation = ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED;</span><br></pre></td></tr></table></figure><p>把UNSPECIFIED修改为LANDSCAPE或PORTRAIT!!!</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>屏蔽ANR弹框</title>
      <link href="/blog/2018/07/03/ping-bi-anr-dan-kuang/"/>
      <url>/blog/2018/07/03/ping-bi-anr-dan-kuang/</url>
      
        <content type="html"><![CDATA[<p>代码位置:</p><p>frameworks\base\services\core\java\com\android\server\am中的ActivityManagerService</p><p>修改位置</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// private boolean mShowDialogs = true;</span></span><br><span class="line">  <span class="keyword">private</span> boolean mShowDialogs = <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If our config change, should we auto dismiss any </span></span><br><span class="line">  <span class="comment">// showing dialogs?</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//del 20180703 start</span></span><br><span class="line">  <span class="comment">// mShowDialogs = shouldShowDialogs(newConfig);</span></span><br><span class="line">  <span class="comment">//del 20180703   end</span></span><br><span class="line">  </span><br><span class="line">  AttributeCache ac = AttributeCache.instance();</span><br><span class="line">  <span class="keyword">if</span> (ac != <span class="literal">null</span>) &#123;</span><br><span class="line">        ac.updateConfiguration(configCopy);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> void handleMessage(Message msg) &#123;</span><br><span class="line">    switch (msg.what) &#123;</span><br><span class="line">    case SHOW_ERROR_MSG: &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; <span class="keyword">data</span> = (HashMap&lt;String, Object&gt;) msg.obj;</span><br><span class="line">        boolean showBackground = Settings.Secure.getInt(mContext.getContentResolver(),</span><br><span class="line">                Settings.Secure.ANR_SHOW_BACKGROUND, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">        synchronized (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            ProcessRecord proc = (ProcessRecord)<span class="keyword">data</span>.<span class="keyword">get</span>(<span class="string">&quot;app&quot;</span>);</span><br><span class="line">            AppErrorResult res = (AppErrorResult) <span class="keyword">data</span>.<span class="keyword">get</span>(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (proc != <span class="literal">null</span> &amp;&amp; proc.crashDialog != <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;App already has crash dialog: &quot;</span> + proc);</span><br><span class="line">                <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                    res.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!showBackground &amp;&amp; UserHandle.getAppId(proc.uid)</span><br><span class="line">                    &gt;= Process.FIRST_APPLICATION_UID &amp;&amp; proc.userId != mCurrentUserId</span><br><span class="line">                    &amp;&amp; proc.pid != MY_PID) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Skipping crash dialog of &quot;</span> + proc + <span class="string">&quot;: background&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                    res.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// if (mShowDialogs &amp;&amp; !mSleeping &amp;&amp; !mShuttingDown)  // 兼容性开关的一个控制SystemProperties.getBoolean(&quot;mstar.app.compatibility.enable&quot;, false)</span></span><br><span class="line">            <span class="keyword">if</span> (mShowDialogs &amp;&amp; !mSleeping &amp;&amp; !mShuttingDown&amp;&amp;SystemProperties.getBoolean(<span class="string">&quot;mstar.app.compatibility.enable&quot;</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">                Dialog d = new AppErrorDialog(mContext,</span><br><span class="line">                        ActivityManagerService.<span class="keyword">this</span>, res, proc);</span><br><span class="line">                d.show();</span><br><span class="line">                proc.crashDialog = d;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The device is asleep, so just pretend that the user</span></span><br><span class="line">                <span class="comment">// saw a crash dialog and hit &quot;force quit&quot;.</span></span><br><span class="line">                <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                    res.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ensureBootCompleted();</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ANR </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>桌面隐藏指定应用图标</title>
      <link href="/blog/2018/07/02/zhuo-mian-yin-cang-zhi-ding-ying-yong-tu-biao/"/>
      <url>/blog/2018/07/02/zhuo-mian-yin-cang-zhi-ding-ying-yong-tu-biao/</url>
      
        <content type="html"><![CDATA[<h3 id="修改AndroidManifest-xml配置文件"><a href="#修改AndroidManifest-xml配置文件" class="headerlink" title="修改AndroidManifest.xml配置文件"></a>修改AndroidManifest.xml配置文件</h3><p>Launcher是根据应用清单文件里来显示图标</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;category android:<span class="attribute">name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>所以如果我们有应用的源码，可以直接将清单文件里的这句话去掉，应用便不会在桌面上显示了。</p><h3 id="修改AndroidManifest-xml配置文件-1"><a href="#修改AndroidManifest-xml配置文件-1" class="headerlink" title="修改AndroidManifest.xml配置文件"></a>修改AndroidManifest.xml配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.app.activity.MainActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只要添加下面这句话，可以隐藏应用图标   +++ --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;data --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- android:host=&quot;AuthActivity&quot; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- android:scheme=&quot;com.android.example&quot; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- tools:ignore=&quot;AppLinkUrlError&quot; /&gt; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只要添加上面这句话，可以隐藏应用图标   +++ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="根据包名过滤"><a href="#根据包名过滤" class="headerlink" title="根据包名过滤"></a>根据包名过滤</h3><p>packages&#x2F;apps&#x2F;Launcher3&#x2F;src&#x2F;com&#x2F;android&#x2F;launcher3&#x2F;LauncherModel.java<br>里面有个loadAllApps()方法,在里面修改，我们要做的，就是跳过我们要隐藏的应用</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> // Create the ApplicationInfos</span><br><span class="line"> for (<span class="name">int</span> i = <span class="number">0</span><span class="comment">; i &lt; apps.size(); i++) &#123;</span></span><br><span class="line">    LauncherActivityInfoCompat app = apps.get(<span class="name">i</span>)<span class="comment">;</span></span><br><span class="line">                        /** add by chensy 隐藏桌面指定应用显示在桌面上 start*/</span><br><span class="line">if(<span class="string">&quot;com.google.android.email&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">        || <span class="string">&quot;com.android.soundrecorder&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">        || <span class="string">&quot;com.android.quicksearchbox&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">             || <span class="string">&quot;com.android.contacts&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">           || <span class="string">&quot;com.android.documentsui&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">             || <span class="string">&quot;com.android.camera2&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">              || <span class="string">&quot;com.android.apkinstaller&quot;</span>.equals(<span class="name">apps</span>.get(<span class="name">i</span>).getApplicationInfo().packageName)</span><br><span class="line">             )&#123;</span><br><span class="line">     continue<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">       /** add by chensy 隐藏桌面指定应用显示在桌面上 end */</span><br><span class="line">            // This builds the icon bitmaps.</span><br><span class="line">       mBgAllAppsList.add(new AppInfo(mContext, app, user, mIconCache, mLabelCache));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设置默认语言时区</title>
      <link href="/blog/2018/07/01/she-zhi-mo-ren-yu-yan-shi-qu/"/>
      <url>/blog/2018/07/01/she-zhi-mo-ren-yu-yan-shi-qu/</url>
      
        <content type="html"><![CDATA[<p>修改device\rockchip{product_name}\system.prop文件</p><ul><li><p>默认语言</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ro.product.locale.language</span>=zh</span><br><span class="line"><span class="attr">ro.product.locale.region</span>=CN</span><br></pre></td></tr></table></figure></li><li><p>默认时区</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">persist.sys.timezone</span>=Asia/Shanghai</span><br></pre></td></tr></table></figure></li><li><p>最终效果</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">persist.sys.language</span>=zh</span><br><span class="line"><span class="attr">persist.sys.country</span>=CN</span><br><span class="line"><span class="attr">persist.sys.localevar</span>=</span><br><span class="line"><span class="attr">persist.sys.timezone</span>=Asia/Shanghai</span><br><span class="line"><span class="attr">ro.product.locale.language</span>=zh</span><br><span class="line"><span class="attr">ro.product.locale.region</span>=CN</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开发者选项中动画设置开关</title>
      <link href="/blog/2018/06/30/kai-fa-zhe-xuan-xiang-zhong-dong-hua-she-zhi-kai-guan/"/>
      <url>/blog/2018/06/30/kai-fa-zhe-xuan-xiang-zhong-dong-hua-she-zhi-kai-guan/</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>开发者选项中动画设置：</p><ul><li>窗口动画缩放(Windos animation scale)</li><li>过渡动画缩放(Transition animation scale)</li><li>动画程序时长缩放(Animation duration scale)<br>分别对应Window动画(非Activity窗口。比如，Dialog、toast、自定义浮窗、输入法等窗口)、Activity动画(Activity窗口。Activity窗口)、View动画(比如View属性动画、水波纹背景动画)</li></ul><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="Setting设置动画"><a href="#Setting设置动画" class="headerlink" title="Setting设置动画"></a>Setting设置动画</h4><p>代码路径</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">packages<span class="regexp">/apps/</span>Settings<span class="regexp">/src/</span>com<span class="regexp">/android/</span>settings/DevelopmentSettings.java</span><br></pre></td></tr></table></figure><p>WindowManagerService提供了setAnimationScale() API供Setting使用</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.<span class="property">os</span>.<span class="property">RemoteException</span>;</span><br><span class="line"><span class="keyword">import</span> android.<span class="property">os</span>.<span class="property">ServiceManager</span>;</span><br><span class="line"><span class="keyword">import</span> android.<span class="property">view</span>.<span class="property">IWindowManager</span>;</span><br><span class="line"></span><br><span class="line">        IWindowManager mWindowManager = IWindowManager.<span class="property">Stub</span>.<span class="property">asInterface</span>(ServiceManager.<span class="property">getService</span>(<span class="string">&quot;window&quot;</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">float</span> <span class="built_in">scale</span> = <span class="number">0</span>;  <span class="comment">//动画时长 [0,0.5,1,1.5,2,5,10]对应设置的[关闭,0.5x,1x.1.5x,2x,5x,10x]</span></span><br><span class="line">            mWindowManager.<span class="property">setAnimationScale</span>(<span class="number">0</span>, <span class="built_in">scale</span>); <span class="comment">//设置窗口动画缩放</span></span><br><span class="line">            mWindowManager.<span class="property">setAnimationScale</span>(<span class="number">1</span>, <span class="built_in">scale</span>); <span class="comment">//设置过渡动画缩放</span></span><br><span class="line">            mWindowManager.<span class="property">setAnimationScale</span>(<span class="number">2</span>, <span class="built_in">scale</span>); <span class="comment">//动画程序时长缩放</span></span><br><span class="line">        &#125; <span class="title function_">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明权限</span></span><br><span class="line">        &lt;uses-permission android:name=<span class="string">&quot;android.permission.SET_ANIMATION_SCALE&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><h4 id="setAnimationScale-函数"><a href="#setAnimationScale-函数" class="headerlink" title="setAnimationScale()函数"></a>setAnimationScale()函数</h4><p>setAnimationScale()函数在frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;wm&#x2F;WindowManagerService.java中</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Override</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAnimationScale</span>(<span class="type">int</span> which, <span class="type">float</span> <span class="built_in">scale</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="title function_">checkCallingPermission</span>(android.<span class="property">Manifest</span>.<span class="property">permission</span>.<span class="property">SET_ANIMATION_SCALE</span>,</span><br><span class="line">               <span class="string">&quot;setAnimationScale()&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new </span><span class="class title_">SecurityException</span>(<span class="string">&quot;Requires SET_ANIMATION_SCALE permission&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">scale</span> = <span class="title function_">fixScale</span>(<span class="built_in">scale</span>);</span><br><span class="line">       <span class="title function_">switch</span> (which) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">0</span>: mWindowAnimationScaleSetting = <span class="built_in">scale</span>; <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>: mTransitionAnimationScaleSetting = <span class="built_in">scale</span>; <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>: mAnimatorDurationScaleSetting = <span class="built_in">scale</span>; <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Persist setting</span></span><br><span class="line">       mH.<span class="property">sendEmptyMessage</span>(H.<span class="property">PERSIST_ANIMATION_SCALE</span>);</span><br></pre></td></tr></table></figure><h4 id="打印dump信息"><a href="#打印dump信息" class="headerlink" title="打印dump信息"></a>打印dump信息</h4><p>执行命令</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="built_in">shell</span> dumpsys <span class="built_in">window</span> w -a</span><br></pre></td></tr></table></figure><h4 id="Window动画时长设置"><a href="#Window动画时长设置" class="headerlink" title="Window动画时长设置"></a>Window动画时长设置</h4><p>Window动画的设置是通过frameworks\base\services\core\java\com\android\server\wm\WindowStateAnimator.java文件的setAnimation()函数来完成的</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="literal">void</span> setAnimation(Animation anim, long startTime) &#123;</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line">    mAnimation.scaleCurrentDuration(mService.getWindowAnimationScaleLocked());</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用Animation.scaleCurrentDuration()函数来重置动画时长为duration*scale</p><h4 id="Activity动画时长设置"><a href="#Activity动画时长设置" class="headerlink" title="Activity动画时长设置"></a>Activity动画时长设置</h4><p>Activity切换动画的设置是通过frameworks\base\services\core\java\com\android\server\wm\AppWindowAnimator.java文件的setAnimation()函数来完成的</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">setAnimation</span><span class="params">(Animation anim, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">boolean</span> skipFirstFrame)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    anim.<span class="built_in">scaleCurrentDuration</span>(mService.<span class="built_in">getTransitionAnimationScaleLocked</span>());</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用Animation.scaleCurrentDuration()函数来重置动画时长为duration*scale</p><h4 id="View动画时长设置"><a href="#View动画时长设置" class="headerlink" title="View动画时长设置"></a>View动画时长设置</h4><p>View动画时长是通过ValueAnimator.sDurationScale静态变量来控制的</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowManager <span class="title">getWindowManagerService</span>()</span> &#123;</span><br><span class="line">    synchronized (WindowManagerGlobal.<span class="keyword">class</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowManagerService == <span class="literal">null</span>) &#123;</span><br><span class="line">            sWindowManagerService = IWindowManager.Stub.asInterface(</span><br><span class="line">                    ServiceManager.getService(<span class="string">&quot;window&quot;</span>));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sWindowManagerService = getWindowManagerService();</span><br><span class="line">                ValueAnimator.setDurationScale(sWindowManagerService.getCurrentAnimatorScale());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Failed to get WindowManagerService, cannot set animator scale&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowManagerService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在进程启动后第一次调用getWindowManagerService()时便会从WMS中获取缩放值，然后保存到ValueAnimator.sDurationScale中<br> 如果Setting中更新了View动画缩放因子，那么WMS中调用dispatchNewAnimatorScaleLocked()函数后会回调上层应用的onAnimatorScaleChanged()接口，通知应用View的动画时长Scale更新<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title function_">getWindowSession</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputMethodManager</span> <span class="variable">imm</span> <span class="operator">=</span> InputMethodManager.getInstance();</span><br><span class="line">                <span class="type">IWindowManager</span> <span class="variable">windowManager</span> <span class="operator">=</span> getWindowManagerService();</span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">IWindowSessionCallback</span>.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimatorScaleChanged</span><span class="params">(<span class="type">float</span> scale)</span> &#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Failed to open window session&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>对于View动画，如果动画时长使用了ValueAnimator.sDurationScale，那么必然受”Animator duration scale”控制</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>View添加触摸震动反馈</title>
      <link href="/blog/2018/06/29/view-tian-jia-hong-mo-zhen-dong-fan-kui/"/>
      <url>/blog/2018/06/29/view-tian-jia-hong-mo-zhen-dong-fan-kui/</url>
      
        <content type="html"><![CDATA[<p>所有的View设置可点击震动</p><p>代码路径</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/frameworks/</span>base<span class="regexp">/core/</span>java<span class="regexp">/android/</span>view/View.java</span><br></pre></td></tr></table></figure><ol><li><p>导包</p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.<span class="built_in">os</span>.Vibrator;</span><br><span class="line"><span class="keyword">import</span> android.provider.Settings;</span><br></pre></td></tr></table></figure></li><li><p>声明变量</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private Vibrator mVibrator<span class="comment">;</span></span><br></pre></td></tr></table></figure></li><li><p>获取服务<br>在View的构造方法里获取</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Simple constructor to use when creating a view from code.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param context The Context the view is running in, through which it can</span></span><br><span class="line"><span class="comment">   *        access the current theme, resources, etc.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public View(Context <span class="keyword">context</span>) &#123;</span><br><span class="line">      mContext = <span class="keyword">context</span>;</span><br><span class="line">      mResources = <span class="keyword">context</span> != <span class="literal">null</span> ? <span class="keyword">context</span><span class="variable">.getResources</span>() : <span class="literal">null</span>;</span><br><span class="line">      mViewFlags = SOUND_EFFECTS_ENABLED | HAPTIC_FEEDBACK_ENABLED;</span><br><span class="line">      <span class="comment">// Set some flags defaults</span></span><br><span class="line">      mPrivateFlags2 =</span><br><span class="line">              (LAYOUT_DIRECTION_DEFAULT &lt;&lt; PFLAG2_LAYOUT_DIRECTION_MASK_SHIFT) |</span><br><span class="line">              (TEXT_DIRECTION_DEFAULT &lt;&lt; PFLAG2_TEXT_DIRECTION_MASK_SHIFT) |</span><br><span class="line">              (PFLAG2_TEXT_DIRECTION_RESOLVED_DEFAULT) |</span><br><span class="line">              (TEXT_ALIGNMENT_DEFAULT &lt;&lt; PFLAG2_TEXT_ALIGNMENT_MASK_SHIFT) |</span><br><span class="line">              (PFLAG2_TEXT_ALIGNMENT_RESOLVED_DEFAULT) |</span><br><span class="line">              (IMPORTANT_FOR_ACCESSIBILITY_DEFAULT &lt;&lt; PFLAG2_IMPORTANT_FOR_ACCESSIBILITY_SHIFT);</span><br><span class="line">      mTouchSlop = ViewConfiguration<span class="variable">.get</span>(<span class="keyword">context</span>)<span class="variable">.getScaledTouchSlop</span>();</span><br><span class="line">      setOverScrollMode(OVER_SCROLL_IF_CONTENT_SCROLLS);</span><br><span class="line">      mUserPaddingStart = UNDEFINED_PADDING;</span><br><span class="line">      mUserPaddingEnd = UNDEFINED_PADDING;</span><br><span class="line">      mRenderNode = RenderNode<span class="variable">.create</span>(getClass()<span class="variable">.getName</span>(), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!sCompatibilityDone &amp;&amp; <span class="keyword">context</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> targetSdkVersion = <span class="keyword">context</span><span class="variable">.getApplicationInfo</span>()<span class="variable">.targetSdkVersion</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Older apps may need this compatibility hack for measurement.</span></span><br><span class="line">          sUseBrokenMakeMeasureSpec = targetSdkVersion &lt;= JELLY_BEAN_MR1;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Older apps expect onMeasure() to always be called on a layout pass, regardless</span></span><br><span class="line">          <span class="comment">// of whether a layout was requested on that View.</span></span><br><span class="line">          sIgnoreMeasureCache = targetSdkVersion &lt; KITKAT;</span><br><span class="line"></span><br><span class="line">          sCompatibilityDone = true;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** add for view 触摸时震动 start **/</span></span><br><span class="line"> mVibrator = (Vibrator) mContext<span class="variable">.getSystemService</span>(Context<span class="variable">.VIBRATOR_SERVICE</span>);</span><br><span class="line"><span class="comment">// end add</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>触发震动<br>在playSoundEffect() 函数触发</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Play a sound effect for this view.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The framework will play sound effects for some built in actions, such as</span></span><br><span class="line"><span class="comment">   * clicking, but you may wish to play these effects in your widget,</span></span><br><span class="line"><span class="comment">   * for instance, for internal navigation.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The sound effect will only be played if sound effects are enabled by the user, and</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> #isSoundEffectsEnabled()&#125; is true.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> soundConstant One of the constants defined in &#123;<span class="doctag">@link</span> SoundEffectConstants&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_ invoke__">playSoundEffect</span>(<span class="keyword">int</span> soundConstant) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mAttachInfo == <span class="literal">null</span> || mAttachInfo.mRootCallbacks == <span class="literal">null</span> || !<span class="title function_ invoke__">isSoundEffectsEnabled</span>()) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">/** add for view 触摸时震动 start **/</span></span><br><span class="line">     <span class="keyword">boolean</span> vibratorEnabled = Settings.System.<span class="title function_ invoke__">getInt</span>(mContext.<span class="title function_ invoke__">getContentResolver</span>(),Settings.System.HAPTIC_FEEDBACK_ENABLED,<span class="number">1</span>)==<span class="number">1</span>;</span><br><span class="line">     <span class="keyword">if</span>(mVibrator !=<span class="literal">null</span> &amp;&amp; vibratorEnabled )&#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 mVibrator.<span class="title function_ invoke__">vibrate</span>(<span class="number">50</span>);</span><br><span class="line">             &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> e) &#123;</span><br><span class="line">                 android.util.Log.<span class="title function_ invoke__">v</span>(<span class="string">&quot;View&quot;</span>,<span class="string">&quot;Exception&quot;</span>+e.<span class="title function_ invoke__">toString</span>());</span><br><span class="line">             &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// end add</span></span><br><span class="line"></span><br><span class="line">      mAttachInfo.mRootCallbacks.<span class="title function_ invoke__">playSoundEffect</span>(soundConstant);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>去除无线网络感叹号</title>
      <link href="/blog/2018/06/28/qu-chu-wu-xian-wang-luo-gan-tan-hao/"/>
      <url>/blog/2018/06/28/qu-chu-wu-xian-wang-luo-gan-tan-hao/</url>
      
        <content type="html"><![CDATA[<p>执行adb命令</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="built_in">shell</span> settings <span class="built_in">put</span> <span class="built_in">global</span> captive_portal_detection_enabled <span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>预置系统应用程序</title>
      <link href="/blog/2018/06/27/yu-zhi-xi-tong-ying-yong-cheng-xu/"/>
      <url>/blog/2018/06/27/yu-zhi-xi-tong-ying-yong-cheng-xu/</url>
      
        <content type="html"><![CDATA[<p>我们需要在系统安装好之后首次启动系统就存在我们的应用程序，而不需要开机之后再次安装，这样就需要考虑进行预置APP（应用），预置还有一个作用，就是有的程序被卸载之后，在系统执行双清操作（清空数据，恢复出厂）之后是可以恢复的。<br>对预置应用我们可以简单做个分类：<br>按照是否可以卸载可以分为不可卸载的和可卸载的；可卸载的又可以分为恢复出厂设置时能恢复的和不能恢复的；按照有没有APK源码又可以分为源码预置还是只是预置APK。</p><p>对于预置应用，我们一般做的是没有源码的APP（单个APK文件，相对简单，更符合需求），因此重点在预置无源码的应用程序上。</p><p>下图是几个常用的apk安装目录（参考-<source>&#x2F;out&#x2F;target&#x2F;product&#x2F;xxx&#x2F;system&#x2F;app）：</p><table><thead><tr><th>目录</th><th>描述</th></tr></thead><tbody><tr><td>&#x2F;system&#x2F;framework</td><td>用于存放资源型应用（系统框架）</td></tr><tr><td>&#x2F;system&#x2F;app</td><td>用于存放系统应用，不能卸载</td></tr><tr><td>&#x2F;system&#x2F;priv-app</td><td>Android4.4+新增，系统【核心】应用存放路径（最高权限）</td></tr><tr><td>&#x2F;vendor&#x2F;app</td><td>用于存放厂商应用，可以卸载，恢复出厂时恢复</td></tr><tr><td>&#x2F;data&#x2F;app</td><td>用于存放用户应用，可以卸载，恢复出厂不能恢复</td></tr><tr><td>&#x2F;data&#x2F;app-private</td><td>Android4.4+新增，受DRM保护的应用存放路径</td></tr></tbody></table><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>声明：以预置一个名为 Test 的APK为例</p><h5 id="一、如何将带源码的APK预置进系统，应用不能卸载？（了解）"><a href="#一、如何将带源码的APK预置进系统，应用不能卸载？（了解）" class="headerlink" title="一、如何将带源码的APK预置进系统，应用不能卸载？（了解）"></a>一、如何将带源码的APK预置进系统，应用不能卸载？（了解）</h5><ol><li>在 packages&#x2F;apps 下面以需要预置的 APK的 名字创建一个新文件夹。 </li><li>将 Test APK的Source code 拷贝到 Test 文件夹下，删除 &#x2F;bin 和 &#x2F;gen 目录。 </li><li>在 Test 目录下创建一个名为 Android.mk的文件，内容如下：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(<span class="built_in">call</span> all-subdir-Java-files)</span></span><br><span class="line">LOCAL_PACKAGE_NAME := Test</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PACKAGE)</span></span><br></pre></td></tr></table></figure></li><li>打开文件 device&#x2F;xxx&#x2F;common&#x2F;device.mk，将 Test 添加到 PRODUCT_PACKAGES 里面。<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += <span class="keyword">Test</span></span><br></pre></td></tr></table></figure><blockquote><p>说明：其中 xxx 代表代表厂商或者平台方名字。 </p></blockquote></li><li>重新 build 整个工程<br>编译成功后，Test.apk 会預置到&#x2F;system&#x2F;app底下</li></ol><h5 id="二、如何将无源码的-APK-预置进系统，应用不能卸载？（重要）"><a href="#二、如何将无源码的-APK-预置进系统，应用不能卸载？（重要）" class="headerlink" title="二、如何将无源码的 APK 预置进系统，应用不能卸载？（重要）"></a>二、如何将无源码的 APK 预置进系统，应用不能卸载？（重要）</h5><ol><li>在 packages&#x2F;apps 下面以需要预置的 APK 名字创建文件夹。 </li><li>将 Test.apk 放到 packages&#x2F;apps&#x2F;Test 下面。 </li><li>在 packages&#x2F;apps&#x2F;Test 下面创建文件 Android.mk，文件内容如下：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment"># Module name should match apk name to be installed</span></span><br><span class="line">LOCAL_MODULE := Test</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(LOCAL_MODULE)</span>.apk</span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line">LOCAL_MODULE_SUFFIX := <span class="variable">$(COMMON_ANDROID_PACKAGE_SUFFIX)</span></span><br><span class="line">LOCAL_PREBUILT_JNI_LIBS:= \</span><br><span class="line">@lib/armeabi/libtest.so  \</span><br><span class="line">@lib/armeabi/libtest2.so </span><br><span class="line">LOCAL_CERTIFICATE := PRESIGNED</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PREBUILT)</span></span><br></pre></td></tr></table></figure><blockquote><p>注意1：<br>若无so，删除LOCAL_PREBUILT_JNI_LIBS<br>若有so，使用LOCAL_PREBUILT_JNI_LIBS列出所有so的路径，不要忘记使用@。@标识符会将apk中的so抽离出来build进apk同级目录下的lib文件夹中。<br>若apk支持不同 CPU 类型的so，针对so的部分的处理（即将和TARGET_ARCH对应的so抽离出来）</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ife<span class="string">q (<span class="variable">$(</span>TARGET_ARCH)</span>,arm)</span><br><span class="line">LOCAL_PREBUILT_JNI_LIBS := \</span><br><span class="line"><span class="variable">@lib</span>/armeabi-v7a/xxx.so/</span><br><span class="line">@ lib/armeabi-v7a/xxxx.so</span><br><span class="line"><span class="keyword">else</span> ife<span class="string">q (<span class="variable">$(</span>TARGET_ARCH)</span>,x86)</span><br><span class="line">LOCAL_PREBUILT_JNI_LIBS := \</span><br><span class="line"><span class="variable">@lib</span>/x86/xxx.so</span><br><span class="line"><span class="keyword">else</span> ife<span class="string">q (<span class="variable">$(</span>TARGET_ARCH)</span>,arm64)</span><br><span class="line">LOCAL_PREBUILT_JNI_LIBS := \</span><br><span class="line"><span class="variable">@lib</span>/armeabi-v8a/xxx.so</span><br><span class="line">…</span><br></pre></td></tr></table></figure><blockquote><p>注意2：<br>如果App使用System Level的permission，需要預置到&#x2F;system&#x2F;priv-app底下 (原在&#x2F;system&#x2F;app)。<br>此时修改Android.mk，增加LOCAL_PRIVILEGED_MODULE :&#x3D; true，以声明app需要放在&#x2F;system&#x2F;priv-app下。</p></blockquote></li></ol><blockquote><p>注意3：<br>若需要apk作为32bit的apk运行，则需要在Android.mk中定义 LOCAL_MULTILIB :&#x3D;32。<br>4. 打开文件 device&#x2F;xxx&#x2F;common&#x2F;device.mk 将 Test 添加到 PRODUCT_PACKAGES 里面。</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += <span class="keyword">Test</span></span><br></pre></td></tr></table></figure><p>说明：其中 xxx 代表代表厂商或者平台方名字。<br>5. 重新 build 整个工程<br>编译成功后，Test.apk 会預置到&#x2F;system&#x2F;app底下。</p><h5 id="三、如何预置APK使得用户可以卸载，恢复出厂设置时不能恢复？"><a href="#三、如何预置APK使得用户可以卸载，恢复出厂设置时不能恢复？" class="headerlink" title="三、如何预置APK使得用户可以卸载，恢复出厂设置时不能恢复？"></a>三、如何预置APK使得用户可以卸载，恢复出厂设置时不能恢复？</h5><ol><li>在 packages&#x2F;apps 下面以需要预置的 APK 名字创建文件夹。 </li><li>将 Test.apk 放到 packages&#x2F;apps&#x2F;Test 下面。 </li><li>在 packages&#x2F;apps&#x2F;Test 下面创建文件 Android.mk，文件内容如下：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment"># Module name should match apk name to be installed</span></span><br><span class="line">LOCAL_MODULE := Test</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(LOCAL_MODULE)</span>.apk</span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line">LOCAL_MODULE_SUFFIX := <span class="variable">$(COMMON_ANDROID_PACKAGE_SUFFIX)</span></span><br><span class="line"><span class="comment"># LOCAL_PRIVILEGED_MODULE := true</span></span><br><span class="line">LOCAL_MODULE_PATH := <span class="variable">$(TARGET_OUT_DATA_APPS)</span></span><br><span class="line">LOCAL_CERTIFICATE := PRESIGNED</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PREBUILT)</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>这个比不能卸载的多了一句 LOCAL_MODULE_PATH :&#x3D; $(TARGET_OUT_DATA_APPS)</p></blockquote></li><li>打开文件 device&#x2F;mediatek&#x2F;common&#x2F;device.mk，将 Test 添加到 PRODUCT_PACKAGES 里面。<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += <span class="keyword">Test</span></span><br></pre></td></tr></table></figure></li><li>重新 build 整个工程</li></ol><h5 id="四、如何预置APK使得用户可以卸载，并且恢复出厂设置时能够恢复？"><a href="#四、如何预置APK使得用户可以卸载，并且恢复出厂设置时能够恢复？" class="headerlink" title="四、如何预置APK使得用户可以卸载，并且恢复出厂设置时能够恢复？"></a>四、如何预置APK使得用户可以卸载，并且恢复出厂设置时能够恢复？</h5><ol><li>在 vendor&#x2F;xxx&#x2F;proprietary&#x2F;binary&#x2F;3rd-party&#x2F;free 下面以需要预置的 APK 名字创建文件夹。 </li><li>将 Test.apk 放入vendor&#x2F;xxx&#x2F;proprietary&#x2F;binary&#x2F;3rd-party&#x2F;free&#x2F;Test 下面。 </li><li>在 vendor&#x2F;xxx&#x2F;proprietary&#x2F;binary&#x2F;3rd-party&#x2F;free&#x2F;Test 下面创建文件 Android.mk，文件内容如下<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment"># Module name should match apk name to be installed</span></span><br><span class="line">LOCAL_MODULE := Test</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(LOCAL_MODULE)</span>.apk</span><br><span class="line">LOCAL_MODULE_CLASS := APPS</span><br><span class="line">LOCAL_MODULE_SUFFIX := <span class="variable">$(COMMON_ANDROID_PACKAGE_SUFFIX)</span></span><br><span class="line">LOCAL_MODULE_PATH := <span class="variable">$(TARGET_OUT)</span>/vendor/operator/app</span><br><span class="line">LOCAL_CERTIFICATE := PRESIGNED</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PREBUILT)</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>这个比不能卸载的多了一句 LOCAL_MODULE_PATH :&#x3D; $(TARGET_OUT)&#x2F;vendor&#x2F;operator&#x2F;app</p></blockquote></li><li>打开文件device&#x2F;xxx&#x2F;common&#x2F;device.mk 将 Test 添加到 PRODUCT_PACKAGES 里面。<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += <span class="keyword">Test</span></span><br></pre></td></tr></table></figure></li><li>然后重新build整个工程。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>去除USB权限弹窗</title>
      <link href="/blog/2018/06/26/qu-chu-usb-quan-xian-dan-chuang/"/>
      <url>/blog/2018/06/26/qu-chu-usb-quan-xian-dan-chuang/</url>
      
        <content type="html"><![CDATA[<p>在访问一个插入到Android系统的USB设备的时候往往是需要权限的，此时系统会弹出询问权限的对话框，而我们此时希望让它默认允许访问USB设备并且不希望用户看到这个对话框。<br>我们在获取UsbManager和UsbDevice&#x2F;UsbAcessory之后，首先需要检查是否对这个USB设备&#x2F;附件有操作的权限，如果没有权限，则需要向系统申请（系统会弹出询问权限的对话框），此时需要注册一个广播接收器用来接收用户的选择。</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查是否有操作权限</span></span><br><span class="line"><span class="built_in">boolean</span> hasPermission = mUsbManager.hasPermission(mUsbDevice);</span><br><span class="line"><span class="keyword">if</span> (!hasPermission) &#123;</span><br><span class="line">    <span class="comment">// 注册广播，接收用户权限选择</span></span><br><span class="line">    PendingIntent <span class="literal">pi</span> = PendingIntent.getBroadcast(mContext, <span class="number">0</span>, <span class="keyword">new</span> Intent(TAG_UsbPermission), <span class="number">0</span>);</span><br><span class="line">    mContext.registerReceiver(<span class="keyword">new</span> MyPermissionReceiver(), <span class="keyword">new</span> IntentFilter(TAG_UsbPermission));</span><br><span class="line">    <span class="comment">// 弹出对话框，申请权限</span></span><br><span class="line">    mUsbManager.requestPermission(mUsbDevice, <span class="literal">pi</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是我们定义的广播接收器：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义的广播接收器</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPermissionReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void onReceive(<span class="type">Context</span> context, <span class="type">Intent</span> intent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getAction().equals(<span class="type">TAG_UsbPermission</span>)) &#123;</span><br><span class="line">            boolean granted = intent.getBooleanExtra(<span class="type">UsbManager</span>.<span class="type">EXTRA_PERMISSION_GRANTED</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (!granted) &#123;</span><br><span class="line">                <span class="comment">// Todo：已经获取权限，可以执行其他操作</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Todo：未获取权限。</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="去除USB权限弹窗方法"><a href="#去除USB权限弹窗方法" class="headerlink" title="去除USB权限弹窗方法"></a>去除USB权限弹窗方法</h4><p>在这个过程中，系统会弹出询问权限的对话框，而我们现在不希望用户看到这个界面。<br>进入系统源码，找到文件<br>&#x2F;frameworks&#x2F;base&#x2F;packages&#x2F;SystemUI&#x2F;src&#x2F;com&#x2F;android&#x2F;systemui&#x2F;usb&#x2F;UsbPermissionActivity.java<br>找到其中的 onCreate() 方法，替换</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setupAlert</span>();</span><br></pre></td></tr></table></figure><p>为</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mPermissionGranted</span> <span class="operator">=</span> true<span class="comment">; </span></span><br><span class="line">finish()<span class="comment">; </span></span><br></pre></td></tr></table></figure><p>这样就不会弹窗了，并且会允许给设备操作权限。<br>当然我们也可以指定只有我们自己的APP不需要弹窗，只需要加一层过滤条件即可：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add permission for our packages! </span></span><br><span class="line"><span class="function"><span class="title">if</span>(<span class="variable">mPackageName.startsWith</span>(<span class="string">&quot;com.xxx.xxx&quot;</span>)) &#123; </span></span><br><span class="line"><span class="function">    <span class="variable">mPermissionGranted</span> = <span class="variable"><span class="literal">true</span></span>; </span></span><br><span class="line"><span class="function">    <span class="title">finish</span>(); </span></span><br><span class="line"><span class="function">&#125; <span class="variable"><span class="keyword">else</span></span> &#123; </span></span><br><span class="line"><span class="function">    <span class="title">setupAlert</span>();   </span></span><br><span class="line"><span class="function">&#125; </span></span><br></pre></td></tr></table></figure><p>当然也可以根据设备的VID、PID、设备名称等信息进行过滤（省略）。</p><p>&#x2F;&#x2F; 更直接的方法<br>frameworks&#x2F;base&#x2F;core&#x2F;res&#x2F;res&#x2F;values&#x2F;config.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- If true, then we do not ask user for permission for apps to connect to USB devices.</span></span><br><span class="line"><span class="comment">     Do not set this to true for production devices. Doing so will cause you to fail CTS. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bool</span> <span class="attr">name</span>=<span class="string">&quot;config_disableUsbPermissionDialogs&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bool</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>去除锁屏和休眠</title>
      <link href="/blog/2018/06/25/qu-chu-suo-ping-he-xiu-mian/"/>
      <url>/blog/2018/06/25/qu-chu-suo-ping-he-xiu-mian/</url>
      
        <content type="html"><![CDATA[<h3 id="去除休眠"><a href="#去除休眠" class="headerlink" title="去除休眠"></a>去除休眠</h3><ol><li>frameworks&#x2F;base&#x2F;packages&#x2F;SettingsProvider&#x2F;res&#x2F;values&#x2F;defaults.xml<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="type">integer</span> <span class="type">name</span>=&quot;def_screen_off_timeout&quot;&gt;<span class="number">60000</span>&lt;/<span class="type">integer</span>&gt; </span><br></pre></td></tr></table></figure>60000ms，修改为-1。-1代表0xffffffff，永远不要休眠<br>  或者修改为2147483647  Java中Integer.MAX_VALUE</li><li>frameworks\base\packages\SettingsProvider\src\com\android\providers\settings\DatabaseHelper.java<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loadIntegerSetting(stmt,Settings.<span class="keyword">System</span>.SCREEN_OFF_TIMEOUT,</span><br><span class="line">                    R.<span class="keyword">integer</span>.def_screen_off_timeout);</span><br></pre></td></tr></table></figure></li></ol><h3 id="去除锁屏"><a href="#去除锁屏" class="headerlink" title="去除锁屏"></a>去除锁屏</h3><ol><li>frameworks&#x2F;base&#x2F;core&#x2F;res&#x2F;res&#x2F;values&#x2F;config.xml<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="type">bool</span> <span class="type">name</span>=&quot;config_dreamsSupported&quot;&gt;<span class="keyword">false</span>&lt;/<span class="type">bool</span>&gt;</span><br><span class="line">&lt;<span class="type">bool</span> <span class="type">name</span>=&quot;config_dreamsEnabledByDefault&quot;&gt;<span class="keyword">false</span>&lt;/<span class="type">bool</span>&gt;</span><br></pre></td></tr></table></figure></li><li>frameworks&#x2F;base&#x2F;packages&#x2F;SettingsProvider&#x2F;res&#x2F;values&#x2F;defaults.xml<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="type">bool</span> <span class="type">name</span>=&quot;def_lockscreen_disabled&quot;&gt;<span class="keyword">true</span>&lt;/<span class="type">bool</span>&gt;</span><br></pre></td></tr></table></figure></li><li>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;power&#x2F;PowerManagerService.java<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">goToSleep</span><span class="params">(<span class="type">long</span> eventTime, <span class="type">int</span> reason, <span class="type">int</span> flags)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>)&#123; <span class="keyword">return</span>; &#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HapticFeedback震动反馈</title>
      <link href="/blog/2018/06/24/hapticfeedback-zhen-dong-fan-kui/"/>
      <url>/blog/2018/06/24/hapticfeedback-zhen-dong-fan-kui/</url>
      
        <content type="html"><![CDATA[<h2 id="adb测试震动"><a href="#adb测试震动" class="headerlink" title="adb测试震动"></a>adb测试震动</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@a # busybox <span class="keyword">find</span> -name <span class="string">&quot;vibrator&quot;</span></span><br><span class="line">root@a # busybox <span class="keyword">find</span> -name <span class="string">&quot;vibrator&quot;</span></span><br><span class="line">.<span class="regexp">/sys/</span>devices<span class="regexp">/virtual/</span>timed_output/vibrator</span><br><span class="line">.<span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/timed_output/</span>vibrator</span><br></pre></td></tr></table></figure><p>向enable文件写入成功，就立即震动，震动的持续时间即是写入的值，单位为ms</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">root@</span>a # echo <span class="string">&#x27;10000&#x27;</span>&gt; /sys/<span class="keyword">class</span>/<span class="symbol">timed_output</span>/<span class="symbol">vibrator</span>/<span class="symbol">enable</span>  </span><br><span class="line"><span class="symbol">root</span>@<span class="symbol">a</span> # <span class="symbol">cat</span> /<span class="symbol">sys</span>/<span class="symbol">class</span>/<span class="symbol">timed_output</span>/<span class="symbol">vibrator</span>/<span class="symbol">enable</span>  </span><br><span class="line"><span class="symbol">3290</span>  </span><br></pre></td></tr></table></figure><p>读enable文件来获得震动剩余的时间</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">root@</span>a # echo ‘<span class="number">0</span>’&gt; /sys/<span class="keyword">class</span>/<span class="symbol">timed_output</span>/<span class="symbol">vibrator</span>/<span class="symbol">enable</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="按键触摸反馈"><a href="#按键触摸反馈" class="headerlink" title="按键触摸反馈"></a>按键触摸反馈</h2><h3 id="代码路径"><a href="#代码路径" class="headerlink" title="代码路径"></a>代码路径</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/frameworks/</span>base<span class="regexp">/policy/</span>src<span class="regexp">/com/</span>android<span class="regexp">/internal/</span>policy<span class="regexp">/impl/</span>PhoneWindowManager.java</span><br></pre></td></tr></table></figure><p>interceptKeyBeforeQueueing函数中添加如下代码：</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(down&amp;&amp;(<span class="built_in">keyCode</span> == KeyEvent.<span class="property">KEYCODE_HOME</span>)</span><br><span class="line">||(<span class="built_in">keyCode</span> == KeyEvent.<span class="property">KEYCODE_MENU</span>)||(<span class="built_in">keyCode</span> == KeyEvent.<span class="property">KEYCODE_BACK</span>))&#123;</span><br><span class="line">    <span class="title function_">performHapticFeedbackLw</span>(<span class="literal">null</span>, HapticFeedbackConstants.<span class="property">VIRTUAL_KEY</span>, <span class="literal">false</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="performHapticFeedbackLw-函数"><a href="#performHapticFeedbackLw-函数" class="headerlink" title="performHapticFeedbackLw()函数"></a>performHapticFeedbackLw()函数</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">performHapticFeedbackLw</span><span class="params">(WindowState win, <span class="keyword">int</span> effectId, <span class="keyword">boolean</span> always)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mVibrator.hasVibrator()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hapticsDisabled = Settings.System.getIntForUser(mContext.getContentResolver(),</span><br><span class="line">            Settings.Settings.System.HAPTIC_FEEDBACK_ENABLED.HAPTIC_FEEDBACK_ENABLED, <span class="number">0</span>, UserHandle.USER_CURRENT) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (hapticsDisabled &amp;&amp; !always) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; Settings.System.HAPTIC_FEEDBACK_ENABLED</span><br><span class="line">    <span class="keyword">long</span>[] pattern = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">switch</span> (effectId) &#123;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.LONG_PRESS:</span><br><span class="line">            pattern = mLongPressVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.VIRTUAL_KEY:</span><br><span class="line">            pattern = mVirtualKeyVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.KEYBOARD_TAP:</span><br><span class="line">            pattern = mKeyboardTapVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.CLOCK_TICK:</span><br><span class="line">            pattern = mClockTickVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.CALENDAR_DATE:</span><br><span class="line">            pattern = mCalendarDateVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.SAFE_MODE_DISABLED:</span><br><span class="line">            pattern = mSafeModeDisabledVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HapticFeedbackConstants.SAFE_MODE_ENABLED:</span><br><span class="line">            pattern = mSafeModeEnabledVibePattern;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> owningUid;</span><br><span class="line">    String owningPackage;</span><br><span class="line">    <span class="keyword">if</span> (win != <span class="keyword">null</span>) &#123;</span><br><span class="line">        owningUid = win.getOwningUid();</span><br><span class="line">        owningPackage = win.getOwningPackage();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owningUid = android.os.Process.myUid();</span><br><span class="line">        owningPackage = mContext.getOpPackageName();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pattern.length == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// One-shot vibration</span></span><br><span class="line">        mVibrator.vibrate(owningUid, owningPackage, pattern[<span class="number">0</span>], VIBRATION_ATTRIBUTES);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Pattern vibration</span></span><br><span class="line">        mVibrator.vibrate(owningUid, owningPackage, pattern, <span class="number">-1</span>, VIBRATION_ATTRIBUTES);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如震动值由 mVirtualKeyVibePattern &#x3D; getLongIntArray(mContext.getResources(),<br>                com.android.internal.R.array.config_virtualKeyVibePattern);获得。<br>配置文件在</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/res/res/values/config.xml</span><br><span class="line">    <span class="comment">&lt;!-- Vibrator pattern for feedback about touching a virtual key --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;config_virtualKeyVibePattern&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>0<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>10<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>30<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">..</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="View长按触发震动"><a href="#View长按触发震动" class="headerlink" title="View长按触发震动"></a>View长按触发震动</h2><h3 id="1-对一个button注册长按监听"><a href="#1-对一个button注册长按监听" class="headerlink" title="1.对一个button注册长按监听"></a>1.对一个button注册长按监听</h3><p>长按button震动</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Button click= (Button) <span class="built_in">findViewById</span>(R.id.click);</span><br><span class="line">click.<span class="built_in">setOnLongClickListener</span>(<span class="keyword">new</span> View.<span class="built_in">OnLongClickListener</span>() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="built_in">onLongClick</span>(View v) &#123;</span><br><span class="line"></span><br><span class="line">        Toast.<span class="built_in">makeText</span>(MainActivity.<span class="keyword">this</span>,<span class="string">&quot;长按点击&quot;</span>,Toast.LENGTH_SHORT).<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发震动反馈</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//return false;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-View-setOnLongClickListener源码"><a href="#2-View-setOnLongClickListener源码" class="headerlink" title="2.View.setOnLongClickListener源码"></a>2.View.setOnLongClickListener源码</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register a callback to be invoked when this view is clicked and held. If this view is not</span></span><br><span class="line"><span class="comment">     * long clickable, it becomes long clickable.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> l The callback that will run</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #setLongClickable(boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setOnLongClickListener</span>(<span class="params"><span class="meta">@Nullable</span> <span class="title class_">OnLongClickListener</span> l</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isLongClickable</span>()) &#123;</span><br><span class="line">            <span class="title function_">setLongClickable</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">getListenerInfo</span>().<span class="property">mOnLongClickListener</span> = l;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="3-View-performLongClick源码"><a href="#3-View-performLongClick源码" class="headerlink" title="3.View.performLongClick源码"></a>3.View.performLongClick源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Call this view&#x27;s OnLongClickListener, if it is defined. Invokes the context menu if the</span></span><br><span class="line"><span class="comment">     * OnLongClickListener did not consume the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> True if one of the above receivers consumed the event, false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">performLongClick</span><span class="params">()</span> &#123;</span><br><span class="line">        sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_LONG_CLICKED);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">handled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">ListenerInfo</span> <span class="variable">li</span> <span class="operator">=</span> mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="literal">null</span> &amp;&amp; li.mOnLongClickListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            handled = li.mOnLongClickListener.onLongClick(View.<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!handled) &#123;</span><br><span class="line">            handled = showContextMenu();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (handled) &#123;</span><br><span class="line"><span class="comment">//  触发震动反馈</span></span><br><span class="line">            performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="4-View-performHapticFeedback-int-feedbackConstant-int-flags-源码"><a href="#4-View-performHapticFeedback-int-feedbackConstant-int-flags-源码" class="headerlink" title="4.View.performHapticFeedback(int feedbackConstant, int flags)源码"></a>4.View.performHapticFeedback(int feedbackConstant, int flags)源码</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BZZZTT!!1!</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Like &#123;<span class="doctag">@link</span> #performHapticFeedback(int)&#125;, with additional options.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> feedbackConstant One of the constants defined in</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> HapticFeedbackConstants&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flags Additional flags as per &#123;<span class="doctag">@link</span> HapticFeedbackConstants&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">performHapticFeedback</span><span class="params">(<span class="keyword">int</span> feedbackConstant, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; HapticFeedbackConstants.FLAG_IGNORE_VIEW_SETTING) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; !isHapticFeedbackEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mAttachInfo.mRootCallbacks.performHapticFeedback(feedbackConstant,</span><br><span class="line">                (flags &amp; HapticFeedbackConstants.FLAG_IGNORE_GLOBAL_SETTING) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="5-HapticFeedbackConstants的3个常量"><a href="#5-HapticFeedbackConstants的3个常量" class="headerlink" title="5.HapticFeedbackConstants的3个常量"></a>5.HapticFeedbackConstants的3个常量</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HapticFeedbackConstants<span class="selector-class">.LONG_PRESS</span></span><br><span class="line">HapticFeedbackConstants<span class="selector-class">.FLAG_IGNORE_VIEW_SETTING</span>  <span class="comment">//可以无视android:hapticFeedbackEnabled=”false”，会触发震动</span></span><br><span class="line">HapticFeedbackConstants<span class="selector-class">.FLAG_IGNORE_GLOBAL_SETTING</span> <span class="comment">//可以无视 Settings.System.HAPTIC_FEEDBACK_ENABLED=0，会触发震动</span></span><br></pre></td></tr></table></figure><h3 id="6-HapticFeedbackConstants使用方法"><a href="#6-HapticFeedbackConstants使用方法" class="headerlink" title="6.HapticFeedbackConstants使用方法"></a>6.HapticFeedbackConstants使用方法</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Button</span></span><br><span class="line">        <span class="attr">android</span>:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        <span class="attr">android</span>:id=<span class="string">&quot;@+id/click&quot;</span></span><br><span class="line">        <span class="attr">android</span>:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        <span class="attr">android</span>:hapticFeedbackEnabled=<span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="attr">android</span>:text=<span class="string">&quot;make&quot;</span> /&gt;</span><br><span class="line">...</span><br><span class="line">click.<span class="title function_">setOnClickListener</span>(<span class="keyword">new</span> <span class="title class_">View</span>.<span class="title class_">OnClickListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onClick</span>(<span class="params"><span class="title class_">View</span> v</span>) &#123;</span><br><span class="line">                <span class="comment">// v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span></span><br><span class="line"><span class="comment">// v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS,HapticFeedbackConstants.FLAG_IGNORE_VIEW_SETTING);</span></span><br><span class="line">                v.<span class="title function_">performHapticFeedback</span>(<span class="title class_">HapticFeedbackConstants</span>.<span class="property">LONG_PRESS</span>,<span class="title class_">HapticFeedbackConstants</span>.<span class="property">FLAG_IGNORE_GLOBAL_SETTING</span></span><br><span class="line">                        );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><h2 id="代码介绍"><a href="#代码介绍" class="headerlink" title="代码介绍"></a>代码介绍</h2><h3 id="APP层"><a href="#APP层" class="headerlink" title="APP层"></a>APP层</h3><p>获取服务后，调用vibrate()方法，实现震动</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mVibrator</span><span class="operator">=</span> (Vibrator) getSystemService(VIBRATOR_SERVICE)<span class="comment">;</span></span><br><span class="line">mVibrator.vibrate(<span class="number">50</span>)<span class="comment">;   //填入震动时长 :ms</span></span><br></pre></td></tr></table></figure><h3 id="Framework层"><a href="#Framework层" class="headerlink" title="Framework层"></a>Framework层</h3><p>framework层代码</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks<span class="regexp">/base/</span>services<span class="regexp">/java/</span>com<span class="regexp">/android/</span>server/VibratorService.java</span><br><span class="line">frameworks<span class="regexp">/base/</span>core<span class="regexp">/java/</span>android<span class="regexp">/os/</span>IVibratorService.aidl</span><br><span class="line">frameworks<span class="regexp">/base/</span>core<span class="regexp">/java/</span>android<span class="regexp">/os/</span>Vibrator.java</span><br><span class="line">frameworks<span class="regexp">/base/</span>core<span class="regexp">/java/</span>android<span class="regexp">/os/</span>SystemVibrator.java</span><br></pre></td></tr></table></figure><p>VibratorService.java<br>    有SystemService拉起的服务。实现IVibratorService.aidl的接口，从而实现VibratorService;它的函数接口，是通过调用JNI层对应的马达控制函数来实现的。</p><p>Vibrator.java<br>    是VibratorService开放给应用层的调用类。Vibrator是抽象类。它便于我们支持不同类型的马达。</p><p>SystemVibrator.java<br>    它是Vibrator.java的子类，实现了vibration的服务接口。<br>    在构造函数中，通过 IVibratorService.Stub.asInterface(ServiceManager.getService(“vibrator”)) 获取马达服务，实际上获取的是VibratorService对象。<br>    SystemVibrator的接口都是调用VibratorService接口实现的</p><h3 id="JNI及HAL层"><a href="#JNI及HAL层" class="headerlink" title="JNI及HAL层"></a>JNI及HAL层</h3><p>代码路径</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks<span class="regexp">/base/</span>services<span class="regexp">/jni/</span>com_android_server_VibratorService.cpp</span><br><span class="line">    hardware<span class="regexp">/libhardware_legacy/</span>vibrator/vibrator.c</span><br></pre></td></tr></table></figure><p>通过vibrator中sendit函数将对vibrator的控制写进“&#x2F;sys&#x2F;class&#x2F;timed_output&#x2F;vibrator&#x2F;enable”节点中。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> ADB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>定制Android开机动画</title>
      <link href="/blog/2018/06/23/ding-zhi-android-kai-ji-dong-hua/"/>
      <url>/blog/2018/06/23/ding-zhi-android-kai-ji-dong-hua/</url>
      
        <content type="html"><![CDATA[<h3 id="开机动画"><a href="#开机动画" class="headerlink" title="开机动画"></a>开机动画</h3><p>替换 Android 设备 system&#x2F;media&#x2F;bootanimation.zip 文件<br>adb push bootanimation.zip &#x2F;sdcard&#x2F;bootanimation.zip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">adb shell</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">su</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mount -o remount,rw /system</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /sdcard/bootanimation.zip /system/media/bootanimation.zip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /system/media/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chmod</span> 0644 bootanimation.zip</span></span><br></pre></td></tr></table></figure><h3 id="制作开机动画包"><a href="#制作开机动画包" class="headerlink" title="制作开机动画包"></a>制作开机动画包</h3><p>解压 bootanimation.zip 文件你会发现，里面会有一个 desc.txt 文件和若干个 part0、part1 这样的目录。</p><p>现在我们查看 desc.txt 文件</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">720</span> <span class="number">1280</span> <span class="number">20</span></span><br><span class="line"><span class="selector-tag">p</span> <span class="number">1</span> <span class="number">0</span> <span class="selector-tag">part0</span></span><br><span class="line"><span class="selector-tag">P</span> <span class="number">0</span> <span class="number">0</span> <span class="selector-tag">part1</span></span><br><span class="line"><span class="comment">// 720 动画的宽度</span></span><br><span class="line"><span class="comment">// 1280 动画的高度</span></span><br><span class="line"><span class="comment">// 20 每秒播放20帧图片 （最好不要超过30）</span></span><br><span class="line"><span class="comment">// p 第二行和第三行的p表示2个part（出第一行外，通常是以p开头的）</span></span><br><span class="line"><span class="comment">// 1 对part中静态图片循环播放的次数。例如：part0的静态图片会播放2次，part1的静态图片只有正常的一次。</span></span><br><span class="line"><span class="comment">// 0 播放完当前part中的动画后，暂停的帧数。 （如该是40的话，40/20=2秒，即暂停2秒）</span></span><br><span class="line"><span class="comment">// part0 part1 存储静态图片的目录名称</span></span><br></pre></td></tr></table></figure><p>注意：</p><ol><li><p>desc.txt 文件要在 Linux 环境下生成，因为有些空格不一样</p></li><li><p>part 目录中的图片的命名要是连续的，比如pic_001, pic_002, _pic_003 …</p></li><li><p>打包成bootanimation.zip文件的时候，要要用zip格式的存储方式打包。</p></li></ol><h3 id="系统编译"><a href="#系统编译" class="headerlink" title="系统编译"></a>系统编译</h3><ol><li>把bootanimation.zip放到alps&#x2F;frameworks&#x2F;base&#x2F;data&#x2F;sounds&#x2F;目录下</li><li>修改&#x2F;device&#x2F;{vendor}&#x2F;{project}&#x2F;device.mk，增加：<br>PRODUCT_COPY_FILES +&#x3D; frameworks&#x2F;base&#x2F;data&#x2F;sounds&#x2F;bootanimation.zip:system&#x2F;media&#x2F;bootanimation.zip</li><li>重新build系统，烧录机器即可；</li></ol>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>发布Hexo Blog到Github Pages</title>
      <link href="/blog/2018/06/22/fa-bu-hexo-blog-dao-github-pages/"/>
      <url>/blog/2018/06/22/fa-bu-hexo-blog-dao-github-pages/</url>
      
        <content type="html"><![CDATA[<h2 id="准备环境："><a href="#准备环境：" class="headerlink" title="准备环境："></a>准备环境：</h2><ul><li><p>安装<a href="https://git-scm.com/">Git</a></p></li><li><p>安装<a href="https://nodejs.org/">Node.js</a></p></li><li><p>安装<a href="https://hexo.io/zh-cn/docs/index.html">hexo</a><br>利用npm命令安装</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure><p>问题</p></li><li><p>npm ERR! registry error parsing json 错误<br>可能需要设置npm代理，执行命令</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="keyword">set</span> <span class="keyword">registry</span> <span class="keyword">http</span>://<span class="keyword">registry</span>.npmjs.org/</span><br></pre></td></tr></table></figure></li><li><p>hexo:command not found<br>删除刚刚安装的npm目录，重新执行命令</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> -h hexo</span><br></pre></td></tr></table></figure></li></ul><h2 id="创建hexo文件夹"><a href="#创建hexo文件夹" class="headerlink" title="创建hexo文件夹"></a>创建hexo文件夹</h2><p>执行命令，hexo会自动在目标文件夹建立博客网站所需的所有文件</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">init</span></span><br></pre></td></tr></table></figure><h2 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span></span><br></pre></td></tr></table></figure><h2 id="本地查看"><a href="#本地查看" class="headerlink" title="本地查看"></a>本地查看</h2><p>在hexo文件夹执行以下命令，然后到浏览器输入<code>http://localhost:4000</code>查看</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><p>问题</p><ul><li>WARN No layout: index.html?…<br>查看主题目录是否为空，如果为空下载主题<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/hexojs/hexo-theme-landscape.git themes/landscape</span><br></pre></td></tr></table></figure></li><li>npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@^1.0.0 (node_modules\chokidar\node_modules\fsevents):<br>npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for <a href="mailto:fsevents@1.0.15">fsevents@1.0.15</a>: wanted {“os”:”darwin”,”arch”:”any”} (current: {“os”:”win32”,”arch”:”x64”})<br>官网给出的方案solution:you are both experiencing a warning that is perfectly normal and will not cause any issues for development. When using OS X there’s a nice filesystem feature provided by the OS by which file changes emit events, making “watching” files for changes the reverse, where they’re passively “listened” for (Change Detection vs an Event Emitter if you need an analogy).<br>This is made possible by fsevents, a package that is only available for OS X and macOS installations due to dependence on the OS’s functionality. Windows and *nix will all see this warning. I haven’t tested it, but the only non-proprietary OS that might have support would be the Darwin open source project.<br>所以这个警告信息可以忽略</li></ul><h2 id="创建页面仓库"><a href="#创建页面仓库" class="headerlink" title="创建页面仓库"></a>创建页面仓库</h2><h2 id="地址：https-github-com-这个仓库的名字需要和你的账号对应，格式-yourname-github-io问题-生成SSH密钥-hexo部署使用编辑-config-yml文件-配置文件的冒号“-”后面有一个空格repo-刚刚-GitHub-创库地址-git-部署步骤问题-ERROR-Deployer-not-found-git"><a href="#地址：https-github-com-这个仓库的名字需要和你的账号对应，格式-yourname-github-io问题-生成SSH密钥-hexo部署使用编辑-config-yml文件-配置文件的冒号“-”后面有一个空格repo-刚刚-GitHub-创库地址-git-部署步骤问题-ERROR-Deployer-not-found-git" class="headerlink" title="地址：https://github.com/这个仓库的名字需要和你的账号对应，格式: yourname.github.io问题- 生成SSH密钥## hexo部署使用编辑_config.yml文件- 配置文件的冒号“:”后面有一个空格repo: 刚刚 GitHub 创库地址.git- 部署步骤问题- ERROR Deployer not found: git"></a>地址：<a href="https://github.com/">https://github.com/</a><br>这个仓库的名字需要和你的账号对应，格式: yourname.github.io<br>问题<br>- 生成SSH密钥<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -<span class="built_in">t</span> rsa -C <span class="string">&quot;你的邮箱地址&quot;</span></span><br></pre></td></tr></table></figure><br>## hexo部署使用<br>编辑_config.yml文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">     type:</span> git</span><br><span class="line"><span class="symbol">     repo:</span> git@github.com:yourname/yourname.github.io.git</span><br><span class="line"><span class="symbol">     branch:</span> master</span><br></pre></td></tr></table></figure><br>- 配置文件的冒号“:”后面有一个空格<br>repo: 刚刚 GitHub 创库地址.git<br>- 部署步骤<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure><br>问题<br>- ERROR Deployer not found: git<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git <span class="comment">--save</span></span><br></pre></td></tr></table></figure></h2><h2 id="hexo常用命令使用"><a href="#hexo常用命令使用" class="headerlink" title="hexo常用命令使用"></a>hexo常用命令使用</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hexo help <span class="meta">#查看帮助</span></span><br><span class="line">hexo init <span class="meta">#初始化一个目录</span></span><br><span class="line">hexo <span class="keyword">new</span> <span class="string">&quot;postName&quot;</span> <span class="meta">#新建文章</span></span><br><span class="line">hexo <span class="keyword">new</span> page <span class="string">&quot;pageName&quot;</span> <span class="meta">#新建页面</span></span><br><span class="line">hexo generate <span class="meta">#生成网页，可以在 public 目录查看整个网站的文件</span></span><br><span class="line">hexo <span class="keyword">server</span> <span class="meta">#本地预览，&#x27;Ctrl+C&#x27;关闭</span></span><br><span class="line">hexo deploy <span class="meta">#部署.deploy目录</span></span><br><span class="line">hexo clean <span class="meta">#清除缓存，**强烈建议每次执行命令前先清理缓存，每次部署前先删除 .deploy 文件夹**</span></span><br></pre></td></tr></table></figure><p>简写</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo n <span class="operator">=</span><span class="operator">=</span> hexo new</span><br><span class="line">hexo g <span class="operator">=</span><span class="operator">=</span> hexo generate</span><br><span class="line">hexo s <span class="operator">=</span><span class="operator">=</span> hexo server</span><br><span class="line">hexo d <span class="operator">=</span><span class="operator">=</span> hexo deploy</span><br></pre></td></tr></table></figure><h2 id="编辑文章"><a href="#编辑文章" class="headerlink" title="编辑文章"></a>编辑文章</h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">&quot;标题&quot;</span></span><br></pre></td></tr></table></figure><p>在 _posts 目录下会生成文件标题.md：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">Hello</span> <span class="string">World</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2015-07-30 07:56:29</span> <span class="comment">#发表日期，一般不改动</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">hexo</span> <span class="comment">#文章文类</span></span><br><span class="line"><span class="attr">tags:</span> [<span class="string">hexo</span>,<span class="string">github</span>] <span class="comment">#文章标签，多于一项时用这种格式</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">正文，使用</span> <span class="string">Markdown</span> <span class="string">语法书写</span></span><br></pre></td></tr></table></figure><p>编辑完后保存，hexo server 预览</p><h2 id="hexo-部署"><a href="#hexo-部署" class="headerlink" title="hexo 部署"></a>hexo 部署</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure><h2 id="hexo目录结构"><a href="#hexo目录结构" class="headerlink" title="hexo目录结构"></a>hexo目录结构</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── .deploy       <span class="meta">#需要部署的文件</span></span><br><span class="line">├── node_modules  <span class="meta">#Hexo插件</span></span><br><span class="line">├── <span class="keyword">public</span>        <span class="meta">#生成的静态网页文件</span></span><br><span class="line">├── scaffolds     <span class="meta">#模板</span></span><br><span class="line">├── source        <span class="meta">#博客正文和其他源文件，404、favicon、CNAME 都应该放在这里</span></span><br><span class="line">|   ├── _drafts   <span class="meta">#草稿</span></span><br><span class="line">|   └── _posts    <span class="meta">#文章</span></span><br><span class="line">├── themes        <span class="meta">#主题</span></span><br><span class="line">├── _config.yml   <span class="meta">#全局配置文件</span></span><br><span class="line">└── <span class="keyword">package</span>.json</span><br></pre></td></tr></table></figure><p>参考连接： <a href="http://wuxiaolong.me/2015/07/31/build-blog-by-hexo/" title="手把手教你建github技术博客by hexo">http://wuxiaolong.me/2015/07/31/build-blog-by-hexo/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/blog/2018/06/21/hello-world/"/>
      <url>/blog/2018/06/21/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
