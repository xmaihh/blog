<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>ANR程序问题分析之dropbox | 小麦</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/blog/atom.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-R3NLYDC8PK" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-R3NLYDC8PK');
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "n85h4t74i7");
</script><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ANR程序问题分析之dropbox</h1><a id="logo" href="/blog/.">小麦</a><p class="description">人生的大起大落来得太突然，搞得我直想尿尿...</p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/history/"><i class="fa fa-book"> 历史</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ANR程序问题分析之dropbox</h1><div class="post-meta">2018-07-14<span> | </span><span class="category"><a href="/blog/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 12</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/#vcomment"><span class="valine-comment-count" data-xid="/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%90%AF%E5%8A%A8"><span class="toc-number">1.</span> <span class="toc-text">DropBox启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">DropBox初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init-%E6%96%B9%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">init()方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trimToFit-%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">trimToFit()方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DropBox%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">DropBox工作</span></a></li></ol></div></div><div class="post-content"><p>从2.2开始增加了DropBox功能，增强Android的异常信息收集管理能力DropBox（简称DB）是系统进程中的一个服务，在system_server进程启动时创建，并且它没有运行在单独的线程中，而是运行在system_server的ServerThread线程中。我们可以将ServerThread称作system_server的主线程，ServerThread线程除了启动并维护各个服务外，还负责检测一些重要的服务是否死锁<br>DropBoxManagerService（简称DBMS）就是DB服务的本尊，它的主要功能接口包括以下几个函数：<br>public voidadd(DropBoxManager.Entryentry)</p>
<p>DBMS将所有要添加的日志都用DropBoxManager.Entry类型的对象表示，通过add函数添加，并且直到目前为止一个Entry对象对应着一个日志文件。</p>
<p>publicboolean isTagEnabled(String tag)</p>
<p>通过给每一个Entry设置一个tag可以标识不同类型的日志，并且可以灵活的启用&#x2F;禁用某种类型的日志，isTagEnabled用来判断指定类型的日志是否被启用&#x2F;禁用了，一旦禁用就不会再记录这种类型的日志。默认是不禁用任何类型的日志的。稍后说明如何启用&#x2F;禁用日志。</p>
<p>publicsynchronized DropBoxManager.Entry getNextEntry(String tag, long millis)</p>
<p>我们可以通过getNextEntry函数获取指定类型和指定时间点之后的第一条日志，要使用这个功能应用程序需要有“android.permission.READ_LOGS”的权限，并且在使用完毕返回的Entry对象后要调用其close函数确保关闭日志文件的文件描述符（如果不关闭的话可能造成进程打开的文件描述符超过1024而崩溃，Android中限制每个进程的文件描述符上限为1024）。</p>
<p>DBMS提供了很多的配置项用来限制对磁盘的使用，通过SettingsProvider应用程序维护，数据存放在其settings.db数据库中。这些配置项也都有默认值，罗列如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_AGE_SECONDS</span> = <span class="string">&quot;dropbox_age_seconds&quot;</span></span><br><span class="line"><span class="comment">//日志文件保存的最长时间，默认3天</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_MAX_FILES</span> = <span class="string">&quot;dropbox_max_files&quot;</span></span><br><span class="line"><span class="comment">//日志文件的最大数量，默认值是1000</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_QUOTA_KB</span> = <span class="string">&quot;dropbox_quota_kb&quot;</span></span><br><span class="line"><span class="comment">//磁盘空间最大使用量</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_QUOTA_PERCENT</span> = <span class="string">&quot;dropbox_quota_percent&quot;</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_RESERVE_PERCENT</span> = <span class="string">&quot;dropbox_reserve_percent&quot;</span></span><br><span class="line">Settings<span class="selector-class">.Secure</span><span class="selector-class">.DROPBOX_TAG_PREFIX</span> = <span class="string">&quot;dropbox:&quot;</span></span><br><span class="line"><span class="comment">//应用程序可以利用DropBox来做事情，收集日志等</span></span><br></pre></td></tr></table></figure>
<h3 id="DropBox启动"><a href="#DropBox启动" class="headerlink" title="DropBox启动"></a>DropBox启动</h3><p>在SystemServer.java的ServerThread.run()里</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Slog.i(TAG, <span class="string">&quot;DropBox Service&quot;</span>);</span><br><span class="line">ServiceManager.addService(<span class="keyword">Context</span>.DROPBOX_SERVICE, //服务名称为“dropbox”</span><br><span class="line"><span class="keyword">new</span> DropBoxManagerService(<span class="keyword">context</span>, <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;/data/system/dropbox&quot;</span>)));</span><br></pre></td></tr></table></figure>
<p>DROPBOX_SERVICE &#x3D; “dropbox”, “&#x2F;data&#x2F;system&#x2F;dropbox”是DB指定的文件存放位置，这个过程向ServiceManager 登记名为“dropbox”的服务。那么可通过<code>dumpsys dropbox</code>来查看该dropbox服务信息。</p>
<h3 id="DropBox初始化"><a href="#DropBox初始化" class="headerlink" title="DropBox初始化"></a>DropBox初始化</h3><p>在DropBoxManagerService.java的构造方法里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DropBoxManagerService</span> <span class="keyword">extends</span> <span class="title class_">IDropBoxManagerService</span>.Stub &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DropBoxManagerService</span><span class="params">(<span class="keyword">final</span> Context context, File path)</span> &#123;</span><br><span class="line">        mDropBoxDir = path;  <span class="comment">// 目录/data/system/dropbox</span></span><br><span class="line">        mContext = context;</span><br><span class="line">        mContentResolver = context.getContentResolver();</span><br><span class="line"></span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">        <span class="comment">// 监听存储设备可用空间低的广播</span></span><br><span class="line">        filter.addAction(Intent.ACTION_DEVICE_STORAGE_LOW);</span><br><span class="line">        <span class="comment">// 监听开机完毕的广播</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BOOT_COMPLETED);</span><br><span class="line">        context.registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Settings数据库变化时则回调广播接收者的onReceive方法,此处CONTENT_URI=content://settings/global&quot;</span></span><br><span class="line">        mContentResolver.registerContentObserver(</span><br><span class="line">            Settings.Global.CONTENT_URI, <span class="literal">true</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ContentObserver</span>(<span class="keyword">new</span> <span class="title class_">Handler</span>()) &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> selfChange)</span> &#123;</span><br><span class="line">                    mReceiver.onReceive(context, (Intent) <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// 发送广播</span></span><br><span class="line">                <span class="keyword">if</span> (msg.what == MSG_SEND_BROADCAST) &#123;</span><br><span class="line">                    mContext.sendBroadcastAsUser((Intent)msg.obj, UserHandle.OWNER,</span><br><span class="line">                            android.Manifest.permission.READ_LOGS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能是给dropbox目录所对应的存储空间进行瘦身:</p>
<ul>
<li>存储设备可用空间低；</li>
<li>开机完毕；</li>
<li>Settings数据库变化；<br>以上情况都会触发触发执行mReceiver的onReceive方法<br>在DropBoxManagerService.java的mReceiver<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> final BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span>(<span class="params">Context context, Intent intent</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="literal">null</span> &amp;&amp; Intent.ACTION_BOOT_COMPLETED.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            mBooted = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//收到ACTION_DEVICE_STORAGE_LOW，则强制重新check存储空间</span></span><br><span class="line">        mCachedQuotaUptimeMillis = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建工作线程来执行init和trim操作</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">init</span>(); <span class="comment">//初始化</span></span><br><span class="line">                    trimToFit(); <span class="comment">//清除一些空间</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="init-方法"><a href="#init-方法" class="headerlink" title="init()方法"></a>init()方法</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> init() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatFs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDropBoxDir.isDirectory() &amp;&amp; !mDropBoxDir.mkdirs()) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        mStatFs = <span class="keyword">new</span> StatFs(mDropBoxDir.getPath());</span><br><span class="line">        mBlockSize = mStatFs.getBlockSize(); <span class="comment">//mBlockSize=4096</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAllFiles == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">File</span>[] files = mDropBoxDir.listFiles();</span><br><span class="line">        <span class="comment">// 列举所有的dropbox文件</span></span><br><span class="line">        mAllFiles = <span class="keyword">new</span> FileList();</span><br><span class="line">        mFilesByTag = <span class="keyword">new</span> HashMap&lt;String, FileList&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">File</span> <span class="keyword">file</span> : files) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">file</span>.getName().endsWith(<span class="string">&quot;.tmp&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除后缀为.tmp文件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建dropbox的实体文件对象, 根据文件名来获取相应的时间戳</span></span><br><span class="line">            EntryFile entry = <span class="keyword">new</span> EntryFile(<span class="keyword">file</span>, mBlockSize);</span><br><span class="line">            <span class="keyword">if</span> (entry.tag == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">//忽略tag为空的文件</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.timestampMillis == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除时间戳为0的文件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将entry加入到mAllFiles对象</span></span><br><span class="line">            enrollEntry(entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能：</p>
<ul>
<li>创建目录&#x2F;data&#x2F;system&#x2F;dropbox;</li>
<li>将每一个dropbox文件都对应于一个EntryFile对象,根据文件名来获取相应的时间戳</li>
<li>删除后缀为.tmp的文件;</li>
<li>删除时间戳为0的文件</li>
</ul>
<h4 id="trimToFit-方法"><a href="#trimToFit-方法" class="headerlink" title="trimToFit()方法"></a>trimToFit()方法</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> trimToFit() &#123;</span><br><span class="line">    <span class="keyword">int</span> ageSeconds = Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_AGE_SECONDS, DEFAULT_AGE_SECONDS);</span><br><span class="line">    <span class="keyword">int</span> maxFiles = Settings.Global.getInt(mContentResolver,</span><br><span class="line">            Settings.Global.DROPBOX_MAX_FILES, DEFAULT_MAX_FILES);</span><br><span class="line">    <span class="keyword">long</span> cutoffMillis = System.currentTimeMillis() - ageSeconds * <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!mAllFiles.contents.isEmpty()) &#123;</span><br><span class="line">        EntryFile entry = mAllFiles.contents.first();</span><br><span class="line">        <span class="comment">//当最老的文件时间戳在3天之内，且文件个数低于1000，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (entry.timestampMillis &gt; cutoffMillis </span><br><span class="line">            &amp;&amp; mAllFiles.contents.<span class="keyword">size</span>() &lt; maxFiles) <span class="keyword">break</span>;</span><br><span class="line">        FileList tag = mFilesByTag.get(entry.tag);</span><br><span class="line">        <span class="keyword">if</span> (tag != <span class="keyword">null</span> &amp;&amp; tag.contents.remove(entry)) tag.blocks -= entry.blocks;</span><br><span class="line">        <span class="keyword">if</span> (mAllFiles.contents.remove(entry)) mAllFiles.blocks -= entry.blocks;</span><br><span class="line">        <span class="keyword">if</span> (entry.<span class="keyword">file</span> != <span class="keyword">null</span>) entry.<span class="keyword">file</span>.<span class="keyword">delete</span>(); <span class="comment">//删除文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> uptimeMillis = SystemClock.uptimeMillis();</span><br><span class="line">    <span class="comment">//除非接收设备存储低的广播，否则间隔5s才能再次执行restat</span></span><br><span class="line">    <span class="keyword">if</span> (uptimeMillis &gt; mCachedQuotaUptimeMillis + QUOTA_RESCAN_MILLIS) &#123;</span><br><span class="line">        <span class="keyword">int</span> quotaPercent = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_PERCENT, DEFAULT_QUOTA_PERCENT);</span><br><span class="line">        <span class="keyword">int</span> reservePercent = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_RESERVE_PERCENT, DEFAULT_RESERVE_PERCENT);</span><br><span class="line">        <span class="keyword">int</span> quotaKb = Settings.Global.getInt(mContentResolver,</span><br><span class="line">                Settings.Global.DROPBOX_QUOTA_KB, DEFAULT_QUOTA_KB);</span><br><span class="line">        <span class="comment">//重新统计文件</span></span><br><span class="line">        mStatFs.restat(mDropBoxDir.getPath());</span><br><span class="line">        <span class="keyword">int</span> available = mStatFs.getAvailableBlocks();</span><br><span class="line">        <span class="keyword">int</span> nonreserved = available - mStatFs.getBlockCount() * reservePercent / <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">int</span> maximum = quotaKb * <span class="number">1024</span> / mBlockSize;</span><br><span class="line">        <span class="comment">//可用的块数量</span></span><br><span class="line">        mCachedQuotaBlocks = Math.min(maximum, Math.max(<span class="number">0</span>, nonreserved * quotaPercent / <span class="number">100</span>));</span><br><span class="line">        mCachedQuotaUptimeMillis = uptimeMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAllFiles.blocks &gt; mCachedQuotaBlocks) &#123;</span><br><span class="line">        <span class="comment">//公平地限制所有tag的空间</span></span><br><span class="line">        <span class="keyword">int</span> unsqueezed = mAllFiles.blocks, squeezed = <span class="number">0</span>;</span><br><span class="line">        TreeSet&lt;FileList&gt; tags = <span class="keyword">new</span> TreeSet&lt;FileList&gt;(mFilesByTag.values());</span><br><span class="line">        <span class="keyword">for</span> (FileList tag : tags) &#123;</span><br><span class="line">            <span class="keyword">if</span> (squeezed &gt; <span class="number">0</span> &amp;&amp; tag.blocks &lt;= (mCachedQuotaBlocks - unsqueezed) / squeezed) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            unsqueezed -= tag.blocks;</span><br><span class="line">            squeezed++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tagQuota = (mCachedQuotaBlocks - unsqueezed) / squeezed;</span><br><span class="line">        <span class="comment">//移除每个tags中的旧items</span></span><br><span class="line">        <span class="keyword">for</span> (FileList tag : tags) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAllFiles.blocks &lt; mCachedQuotaBlocks) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">while</span> (tag.blocks &gt; tagQuota &amp;&amp; !tag.contents.isEmpty()) &#123;</span><br><span class="line">                EntryFile entry = tag.contents.first();</span><br><span class="line">                <span class="keyword">if</span> (tag.contents.remove(entry)) tag.blocks -= entry.blocks;</span><br><span class="line">                <span class="keyword">if</span> (mAllFiles.contents.remove(entry)) mAllFiles.blocks -= entry.blocks;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entry.<span class="keyword">file</span> != <span class="keyword">null</span>) entry.<span class="keyword">file</span>.<span class="keyword">delete</span>();</span><br><span class="line">                    enrollEntry(<span class="keyword">new</span> EntryFile(mDropBoxDir, entry.tag, entry.timestampMillis));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Can&#x27;t write tombstone file&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mCachedQuotaBlocks * mBlockSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>trimToFit过程中触发条件是：当文件有效时长超过3天，或者最大文件数超过1000，再或者剩余可用存储设备过低；<br>DBMS有很多常量参数：</p>
<ul>
<li>DEFAULT_AGE_SECONDS &#x3D; 3 * 86400：文件最长可存活时长为3天</li>
<li>DEFAULT_MAX_FILES &#x3D; 1000：最大dropbox文件个数为1000</li>
<li>DEFAULT_QUOTA_KB &#x3D; 5 * 1024：分配dropbox空间的最大值5M</li>
<li>DEFAULT_QUOTA_PERCENT &#x3D; 10：是指dropbox目录最多可占用空间比例10%</li>
<li>DEFAULT_RESERVE_PERCENT &#x3D; 10：是指dropbox不可使用的存储空间比例10%</li>
<li>QUOTA_RESCAN_MILLIS &#x3D; 5000：重新扫描retrim时长为5s<br>当然上面这些都是默认值，完全可以通过设置content:&#x2F;&#x2F;settings&#x2F;global数据库中相应项来设定值。</li>
</ul>
<h3 id="DropBox工作"><a href="#DropBox工作" class="headerlink" title="DropBox工作"></a>DropBox工作</h3><p>以下任一场景，都会调用AMS.addErrorToDropBox()来触发DBMS工作。</p>
<ul>
<li>crash: AMS.handleApplicationCrashInner()</li>
<li>anr: AMS.appNotResponding()</li>
<li>watchdog: Watchdog.run()</li>
<li>native_crash: NativeCrashReporter.run()</li>
<li>wtf: 当调用Log.wtf()或者Log.wtfQuiet()</li>
<li>lowmem: 当内存较低时，触发AMS.reportMemUsage()</li>
</ul>
<p>在ActivityManagerService.java的addErrorToDropBox()方法</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> addErrorToDropBox(String eventType, ProcessRecord process, String processName, ActivityRecord activity, ActivityRecord parent, String subject, <span class="keyword">final</span> String report, <span class="keyword">final</span> <span class="keyword">File</span> logFile, <span class="keyword">final</span> ApplicationErrorReport.CrashInfo crashInfo) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建dropbox标签名</span></span><br><span class="line">    <span class="keyword">final</span> String dropboxTag = processClass(process) + <span class="string">&quot;_&quot;</span> + eventType;</span><br><span class="line">    <span class="comment">//获取dropbox服务的代理端</span></span><br><span class="line">    <span class="keyword">final</span> DropBoxManager dbox = (DropBoxManager)</span><br><span class="line">            mContext.getSystemService(Context.DROPBOX_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当不需要输出dropbox报告则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (dbox == <span class="keyword">null</span> || !dbox.isTagEnabled(dropboxTag)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//输出Process,flags,以及进程中所有package</span></span><br><span class="line">    appendDropBoxProcessHeaders(process, processName, sb);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (subject != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sb.<span class="keyword">append</span>(<span class="string">&quot;Subject: &quot;</span>).<span class="keyword">append</span>(subject).<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.<span class="keyword">append</span>(<span class="string">&quot;Build: &quot;</span>).<span class="keyword">append</span>(Build.FINGERPRINT).<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    sb.<span class="keyword">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建新线程，避免将调用者阻塞在I/O</span></span><br><span class="line">    Thread worker = <span class="keyword">new</span> Thread(<span class="string">&quot;Error dump: &quot;</span> + dropboxTag) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">            <span class="keyword">if</span> (report != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</span></span><br><span class="line">                sb.<span class="keyword">append</span>(report); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB</span></span><br><span class="line">                sb.<span class="keyword">append</span>(FileUtils.readTextFile(logFile, DROPBOX_MAX_SIZE,</span><br><span class="line">                            <span class="string">&quot;\n\n[[TRUNCATED]]&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (crashInfo != <span class="keyword">null</span> &amp;&amp; crashInfo.stackTrace != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 比如crash时输出的调用栈</span></span><br><span class="line">                sb.<span class="keyword">append</span>(crashInfo.stackTrace);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String setting = Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag;</span><br><span class="line">            <span class="keyword">int</span> lines = Settings.Global.getInt(mContext.getContentResolver(), setting, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//当dropboxTag所对应的settings项不等于0，则输出logcat</span></span><br><span class="line">            <span class="keyword">if</span> (lines &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">//输出evets/system/main/crash这些log信息</span></span><br><span class="line">              java.lang.Process logcat = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;/system/bin/logcat&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-v&quot;</span>, <span class="string">&quot;time&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;events&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;system&quot;</span>, <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-b&quot;</span>, <span class="string">&quot;crash&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;-t&quot;</span>, String.valueOf(lines)).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line"></span><br><span class="line">              input = <span class="keyword">new</span> InputStreamReader(logcat.getInputStream());</span><br><span class="line"></span><br><span class="line">              <span class="keyword">int</span> num;</span><br><span class="line">              <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">8192</span>];</span><br><span class="line">              <span class="comment">//不断读取input中的log内容，并添加到sb</span></span><br><span class="line">              <span class="keyword">while</span> ((num = input.<span class="keyword">read</span>(buf)) &gt; <span class="number">0</span>) sb.<span class="keyword">append</span>(buf, <span class="number">0</span>, num);</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将log信息输出到DropBox</span></span><br><span class="line">            dbox.addText(dropboxTag, sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//当进程为空，意味着system_server进程崩溃，系统可能很快就要挂了,</span></span><br><span class="line">        <span class="comment">//那么不再创建新线程，而是直接在system_server进程中同步运行</span></span><br><span class="line">        worker.run();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//启动新线程</span></span><br><span class="line">        worker.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要功能是输出以下内容项：</p>
<ul>
<li>Process,flags, package等头信息；</li>
<li>当report不为空，则比如ANR时输出Cpuinfo，或者lowmem时输出的内存信息</li>
<li>当logFile不为空，则比如anr或者Watchdog时输出的traces文件(kill -3)，最大上限为256KB；</li>
<li>当stack不为空，则比如crash时输出的调用栈；</li>
<li>输出logcat的events&#x2F;system&#x2F;main&#x2F;crash信息。</li>
</ul>
<p>AMS.processClass()方法</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">static</span> <span class="type">String</span> <span class="title">processClass</span><span class="params">(ProcessRecord process)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//MY_PID代表的是当前进程pid，正是system_server进程</span></span><br><span class="line">    <span class="keyword">if</span> (process == null || process.pid == MY_PID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;system_server&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((process.info.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;system_app&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;data_app&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dropbox文件名格式为<a href="mailto:&#x64;&#x72;&#x6f;&#x70;&#98;&#x6f;&#x78;&#x54;&#x61;&#x67;&#x40;&#x78;&#120;&#x78;&#x2e;&#116;&#x78;&#x74;">&#x64;&#x72;&#x6f;&#x70;&#98;&#x6f;&#x78;&#x54;&#x61;&#x67;&#x40;&#x78;&#120;&#x78;&#x2e;&#116;&#x78;&#x74;</a> xxx代表时间戳,例如<a href="mailto:&#115;&#x79;&#115;&#x74;&#101;&#x6d;&#95;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x5f;&#99;&#114;&#97;&#115;&#x68;&#64;&#49;&#x34;&#x36;&#x35;&#54;&#53;&#x30;&#x38;&#x34;&#53;&#51;&#53;&#x35;&#x2e;&#116;&#120;&#116;">&#115;&#x79;&#115;&#x74;&#101;&#x6d;&#95;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x5f;&#99;&#114;&#97;&#115;&#x68;&#64;&#49;&#x34;&#x36;&#x35;&#54;&#53;&#x30;&#x38;&#x34;&#53;&#51;&#53;&#x35;&#x2e;&#116;&#120;&#116;</a>,则记录该文件时间戳为1465650845355. 文件后缀除了.txt，还有压缩格式.txt.gz. 对于dropboxTag是由processClass + eventType组合而成.</p>
<p>processClass分为system_server, system_app, data_app;<br>eventType：分为crash,anr,wtf,native_cras,lowmem, watchdog</p>
<p>列举部分常见tags以及含义:</p>
<table>
<thead>
<tr>
<th>dropboxTag</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>system_server_anr</td>
<td>system进程无响应</td>
</tr>
<tr>
<td>system_server_watchdog</td>
<td>system进程发生watchdog</td>
</tr>
<tr>
<td>system_server_crash</td>
<td>system进程崩溃</td>
</tr>
<tr>
<td>system_server_native_crash</td>
<td>system进程native出现崩溃</td>
</tr>
<tr>
<td>system_server_wtf</td>
<td>system进程发生严重错误</td>
</tr>
<tr>
<td>system_server_lowmem</td>
<td>system进程内存不足</td>
</tr>
<tr>
<td>当然除了system_server进程, 还有system_app, data_app类型的进程, 以上所有类型都适用,列举部分:</td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>dropboxTag</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>system_app_crash</td>
<td>系统app崩溃</td>
</tr>
<tr>
<td>system_app_anr</td>
<td>系统app无响应</td>
</tr>
<tr>
<td>data_app_crash</td>
<td>普通app崩溃</td>
</tr>
<tr>
<td>data_app_anr</td>
<td>普通app无响应</td>
</tr>
</tbody></table>
</div><div class="post-copyright"><script type="text/javascript" src="/blog/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/blog/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>ANR程序问题分析之dropbox</p><p><span>文章作者：</span>xmaihh</p><p><span>发布时间：</span>2018-07-14</p><p><span>最后更新：</span>2018-07-14</p><p><span>原始链接：</span><a href="/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/">https://xmaihh.github.io/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://xmaihh.github.io/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/"></i></span></p><p><span>版权声明：</span>采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">[CC BY-NC-SA 4.0许可协议]</a>进行许可</p></div><br><script type="text/javascript" src="/blog/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://xmaihh.github.io/blog/2018/07/14/anr-cheng-xu-wen-ti-fen-xi-zhi-dropbox/" data-id="cm2e1ez2r0007f1q1e14o4y6k" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACt0lEQVR42u3cwW7rMAwEwPz/T+ddC/RZWJJi4cP4FCSurVEAi1kR/Xzi4/vr+Pn++fzkmr/fP7++fODh4eGNh/7EePr0aSjJdarTkY8ZDw8Pb5uXXK734E4Yveucz8HDw8N7J+/8To8xL+Xx8PDw3sabM5LS/EzCw8PDewMvCSOSh3j59kXwYtaCh4eHF/PyXaT3vF7Z38PDw8Mb76rn2115aHt+fPc24R7/Cg8PD2+B14tTqwXxmdqLcQvjxMPDw1vg9X7w34owem1beYiMh4eHd5dXLZfzweULQ1J2V5tfP+UvFw8PD6/Dy7esqkXzpNSuti/857cCHh4e3hqvSuq9U11+LjQE4OHh4S3wJi1QvQ2zPLyYbInh4eHh7fGqQ+y1is7j4GppjoeHh/c3vL0QoRraThoXHhcGPDw8vDGv12Y6Z0zK7l7Ui4eHh7fBy1ua5o2q1Tav5I4XvkM8PDy8gJc/cPNzqgV0Pk3lbTY8PDy8BV6OrDZFJVMQbWLFjQVRDIGHh4e3wEt+/M8L4rzpat4yi4eHh3eX18stJjFuLxTuXR8PDw/vL3mTACJfPKqtA+Wufjw8PLxl3rxpIB9cvhgkvKinDA8PD+8SL9/mry4kvQUmv2NzIcHDw8O7xJsvDMng5p/mxTceHh7e3/B6DQR5e2sv5K0GIoU5xsPDw7vKyxeAazFB6/yo0MfDw8Nb4/UeytVgotd01Qs78PDw8DZ43+KxETT0WlHP43lsusLDw8Mb86oP3DzkrUYeZ1K1WaG5nuDh4eF9a/8fKY9Z55OyMZVRjIuHh4d3lVcNDm4tBpMWrmiRwMPDw3sZr7olltwlj0KiicbDw8N7AS8vwfNm02SRqAbNeHh4eNu83nB701ENIM5leqGnDA8PD+8Sr9zMNC6s88d6ObSd5xl4eHh4p+MfaeY1ythSLJQAAAAASUVORK5CYII=">分享</a><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ANR/" rel="tag">ANR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Android/" rel="tag">Android</a></li></ul></div><div class="post-nav"><a class="pre" href="/blog/2018/07/15/watchdog-ji-zhi/">Watchdog机制</a><a class="next" href="/blog/2018/07/13/anr-cheng-xu-wen-ti-fen-xi-zhi-traces/">ANR程序问题分析之traces</a></div><div class="nofancybox" id="vcomment"></div><script src="https://unpkg.com/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'WyoZPeMWzhLWRYAeA5ueZwiI-MdYXbMMI',
  appKey:'2n4nqRtMlbjNwRNodC3rPRQI',
  serverURLs:'https://wyozpemw.api.lncldglobal.com',
  placeholder:'Just so so',
  avatar:'robohash',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/blog/img/avatar.svg"/></a><p>亲自部署 亲自指挥</p><a class="info-icon" href="https://github.com/xmaihh" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/blog/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/Android/" style="font-size: 15px;">Android</a> <a href="/blog/tags/ADB/" style="font-size: 15px;">ADB</a> <a href="/blog/tags/ANR/" style="font-size: 15px;">ANR</a> <a href="/blog/tags/BLE/" style="font-size: 15px;">BLE</a> <a href="/blog/tags/Lottie/" style="font-size: 15px;">Lottie</a> <a href="/blog/tags/OTA/" style="font-size: 15px;">OTA</a> <a href="/blog/tags/SDK/" style="font-size: 15px;">SDK</a> <a href="/blog/tags/Logcat/" style="font-size: 15px;">Logcat</a> <a href="/blog/tags/AndroidStudio/" style="font-size: 15px;">AndroidStudio</a> <a href="/blog/tags/Jni/" style="font-size: 15px;">Jni</a> <a href="/blog/tags/Serialport/" style="font-size: 15px;">Serialport</a> <a href="/blog/tags/Java/" style="font-size: 15px;">Java</a> <a href="/blog/tags/BT/" style="font-size: 15px;">BT</a> <a href="/blog/tags/RS232/" style="font-size: 15px;">RS232</a> <a href="/blog/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/blog/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/blog/tags/ArkUI/" style="font-size: 15px;">ArkUI</a> <a href="/blog/tags/Harmony/" style="font-size: 15px;">Harmony</a> <a href="/blog/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/blog/tags/Cloudflare/" style="font-size: 15px;">Cloudflare</a> <a href="/blog/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/blog/tags/docker-compose/" style="font-size: 15px;">docker-compose</a> <a href="/blog/tags/Debian/" style="font-size: 15px;">Debian</a> <a href="/blog/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/blog/tags/Flutter/" style="font-size: 15px;">Flutter</a> <a href="/blog/tags/Frp/" style="font-size: 15px;">Frp</a> <a href="/blog/tags/Github-Actions/" style="font-size: 15px;">Github Actions</a> <a href="/blog/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/blog/tags/CI-CD/" style="font-size: 15px;">CI/CD</a> <a href="/blog/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/blog/tags/Portainer/" style="font-size: 15px;">Portainer</a> <a href="/blog/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/blog/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/blog/tags/ArchLinux/" style="font-size: 15px;">ArchLinux</a> <a href="/blog/tags/Pixel8/" style="font-size: 15px;">Pixel8</a> <a href="/blog/tags/Magisk/" style="font-size: 15px;">Magisk</a> <a href="/blog/tags/Python/" style="font-size: 15px;">Python</a> <a href="/blog/tags/RecyclerView/" style="font-size: 15px;">RecyclerView</a> <a href="/blog/tags/Gdrive/" style="font-size: 15px;">Gdrive</a> <a href="/blog/tags/ZeroTier/" style="font-size: 15px;">ZeroTier</a> <a href="/blog/tags/Watchdog/" style="font-size: 15px;">Watchdog</a> <a href="/blog/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/blog/tags/Git/" style="font-size: 15px;">Git</a> <a href="/blog/tags/Github/" style="font-size: 15px;">Github</a> <a href="/blog/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/blog/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/blog/tags/Sqlite/" style="font-size: 15px;">Sqlite</a> <a href="/blog/tags/Kotlin/" style="font-size: 15px;">Kotlin</a> <a href="/blog/tags/Tailscale/" style="font-size: 15px;">Tailscale</a> <a href="/blog/tags/weixin/" style="font-size: 15px;">weixin</a> <a href="/blog/tags/Openwrt/" style="font-size: 15px;">Openwrt</a> <a href="/blog/tags/npm/" style="font-size: 15px;">npm</a> <a href="/blog/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/blog/tags/DoH/" style="font-size: 15px;">DoH</a> <a href="/blog/tags/Design-pattern/" style="font-size: 15px;">Design pattern</a> <a href="/blog/tags/Raspberry-Pi/" style="font-size: 15px;">Raspberry Pi</a> <a href="/blog/tags/VLC/" style="font-size: 15px;">VLC</a> <a href="/blog/tags/CRC/" style="font-size: 15px;">CRC</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2024/10/17/hexo-bo-ke-qi-yong-websub/">Hexo博客启用 WebSub</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/10/16/rang-follow-ren-zheng-wo-de-hexo-bo-ke-ding-yue-yuan/">让Follow认证我的Hexo博客订阅源</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/09/10/portainer-chong-zhi-admin-deng-lu-mi-ma/">Portainer重置admin登录密码</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/08/02/hua-shuo-lu-you-qi-xiu-gai-hosts/">华硕路由器修改Hosts</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/30/flutter-shi-yong-intl-generator-zai-windows-xia-bao-cuo-cannot-open-file-path-l10n-arb-intl-arb-os-error-wen-jian-ming-mu-lu-ming-huo-juan-biao-yu-fa-bu-zheng-que/">Flutter使用intl_generator在Windows下报错Cannot open file, path = 'l10n-arb/intl_*.arb' (OS Error: 文件名、目录名或卷标语法不正确</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/26/zai-hexo-zhong-shi-yong-plantuml/">在Hexo中使用PlantUML</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/26/yong-yu-gou-jian-he-fa-bu-flutter-ying-yong-cheng-xu-de-github-actions-gong-zuo-liu-cheng/">用于构建和发布 Flutter 应用程序的GitHub Actions 工作流程</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/25/flutter-ge-ge-ping-tai-de-gou-jian-chan-wu/">Flutter各个平台的构建产物</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/24/flutter-she-zhi-app-ban-ben/">Flutter设置App版本</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2024/07/15/windows-xia-jin-wei-github-she-zhi-ssh-dai-li/">Windows下仅为 GitHub 设置SSH代理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://quincyjiang.github.io/" title="瘟疫青年" target="_blank">瘟疫青年</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/blog/." rel="nofollow">小麦.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/blog/css/search.css?v=1.0.0"><script type="text/javascript" src="/blog/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/blog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zIndex="-1" count="150" src="https://unpkg.com/canvas-nest.js/dist/canvas-nest.js"></script><script type="text/javascript" src="/blog/js/love.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/blog/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script></div></body></html>